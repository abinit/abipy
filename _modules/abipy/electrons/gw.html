

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>abipy.electrons.gw &mdash; abipy 0.9.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/jupyter-sphinx.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/thebelab.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/plot_directive.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/my_style.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-dataframe.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-rendered-html.css" type="text/css" />

  
  

  
  

  

  
    <script type="text/javascript" src="https://cdn.plot.ly/plotly-latest.min.js"></script> 
    
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/thebelab-helper.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> abipy
          

          
          </a>

          
            
            
              <div class="version">
                0.9.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../features.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Getting AbiPy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../zzbiblio.html">Bibliography</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../scripts/index.html">Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../graphical_interface.html">Graphical interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gallery/index.html">AbiPy Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../postprocessing_howto.html">Post-processing How-To</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../workflows/taskmanager.html">TaskManager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../workflows/manager_examples.html">Manager Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../flow_gallery/index.html">Flow Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../flows_howto.html">Flows How-To</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../coding_guide.html">Coding guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html">Documenting AbiPy</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">abipy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>abipy.electrons.gw</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for abipy.electrons.gw</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: utf-8</span>
<span class="sd">&quot;&quot;&quot;Classes for the analysis of GW calculations.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span><span class="p">,</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>
<span class="kn">from</span> <span class="nn">monty.string</span> <span class="kn">import</span> <span class="n">list_strings</span><span class="p">,</span> <span class="n">is_string</span><span class="p">,</span> <span class="n">marquee</span>
<span class="kn">from</span> <span class="nn">monty.collections</span> <span class="kn">import</span> <span class="n">dict2namedtuple</span>
<span class="kn">from</span> <span class="nn">monty.functools</span> <span class="kn">import</span> <span class="n">lazy_property</span>
<span class="kn">from</span> <span class="nn">monty.termcolor</span> <span class="kn">import</span> <span class="n">cprint</span>
<span class="kn">from</span> <span class="nn">monty.bisect</span> <span class="kn">import</span> <span class="n">find_le</span><span class="p">,</span> <span class="n">find_ge</span>
<span class="kn">from</span> <span class="nn">abipy.core.func1d</span> <span class="kn">import</span> <span class="n">Function1D</span>
<span class="kn">from</span> <span class="nn">abipy.core.kpoints</span> <span class="kn">import</span> <span class="n">Kpoint</span><span class="p">,</span> <span class="n">KpointList</span><span class="p">,</span> <span class="n">Kpath</span><span class="p">,</span> <span class="n">IrredZone</span><span class="p">,</span> <span class="n">has_timrev_from_kptopt</span>
<span class="kn">from</span> <span class="nn">abipy.core.mixins</span> <span class="kn">import</span> <span class="n">AbinitNcFile</span><span class="p">,</span> <span class="n">Has_Structure</span><span class="p">,</span> <span class="n">Has_ElectronBands</span><span class="p">,</span> <span class="n">NotebookWriter</span>
<span class="kn">from</span> <span class="nn">abipy.iotools</span> <span class="kn">import</span> <span class="n">ETSF_Reader</span>
<span class="kn">from</span> <span class="nn">abipy.tools.plotting</span> <span class="kn">import</span> <span class="p">(</span><span class="n">ArrayPlotter</span><span class="p">,</span> <span class="n">add_fig_kwargs</span><span class="p">,</span> <span class="n">get_ax_fig_plt</span><span class="p">,</span> <span class="n">get_axarray_fig_plt</span><span class="p">,</span> <span class="n">Marker</span><span class="p">,</span>
    <span class="n">set_axlims</span><span class="p">,</span> <span class="n">set_visible</span><span class="p">,</span> <span class="n">rotate_ticklabels</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">abipy.tools</span> <span class="kn">import</span> <span class="n">duck</span>
<span class="kn">from</span> <span class="nn">abipy.abio.robots</span> <span class="kn">import</span> <span class="n">Robot</span>
<span class="kn">from</span> <span class="nn">abipy.electrons.ebands</span> <span class="kn">import</span> <span class="n">ElectronBands</span><span class="p">,</span> <span class="n">RobotWithEbands</span>
<span class="kn">from</span> <span class="nn">abipy.electrons.scissors</span> <span class="kn">import</span> <span class="n">Scissors</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;QPState&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SigresFile&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SigresRobot&quot;</span><span class="p">,</span>
<span class="p">]</span>


<div class="viewcode-block" id="QPState"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.QPState">[docs]</a><span class="k">class</span> <span class="nc">QPState</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;QPState&quot;</span><span class="p">,</span> <span class="s2">&quot;spin kpoint band e0 qpe qpe_diago vxcme sigxme sigcmee0 vUme ze0&quot;</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Quasi-particle result for given (spin, kpoint, band).</span>

<span class="sd">    .. Attributes:</span>

<span class="sd">        spin: spin index (C convention, i.e &gt;= 0)</span>
<span class="sd">        kpoint: |Kpoint| object.</span>
<span class="sd">        band: band index. (C convention, i.e &gt;= 0).</span>
<span class="sd">        e0: Initial KS energy.</span>
<span class="sd">        qpe: Quasiparticle energy (complex) computed with the perturbative approach.</span>
<span class="sd">        qpe_diago: Quasiparticle energy (real) computed by diagonalizing the self-energy.</span>
<span class="sd">        vxcme: Matrix element of vxc[n_val] with nval the valence charge density.</span>
<span class="sd">        sigxme: Matrix element of Sigma_x.</span>
<span class="sd">        sigcmee0: Matrix element of Sigma_c(e0) with e0 being the KS energy.</span>
<span class="sd">        vUme: Matrix element of the vU term of the LDA+U Hamiltonian.</span>
<span class="sd">        ze0: Renormalization factor computed at e=e0.</span>

<span class="sd">    .. note::</span>

<span class="sd">        Energies are in eV.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">qpeme0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;E_QP - E_0&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpe</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">e0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">re_qpe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Real part of the QP energy.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpe</span><span class="o">.</span><span class="n">real</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">imag_qpe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Imaginay part of the QP energy.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpe</span><span class="o">.</span><span class="n">imag</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">skb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tuple with (spin, kpoint, band)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">band</span>

    <span class="c1">#def __str__(self):</span>
    <span class="c1">#    return self.to_string()</span>

    <span class="c1">#def to_string(self, verbose=0, title=None):</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    String representation with verbosity level ``verbose`` and optional ``title``.</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    s = str(self.get_dataframe())</span>
    <span class="c1">#    return &quot;\n&quot;.join([marquee(title, mark=&quot;=&quot;), s]) if title is not None else s</span>

<div class="viewcode-block" id="QPState.copy"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.QPState.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return Shallow copy.&quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">**</span><span class="n">d</span><span class="p">)</span></div>

<div class="viewcode-block" id="QPState.get_fields"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.QPState.get_fields">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_fields</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">()):</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;qpeme0&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span></div>

<div class="viewcode-block" id="QPState.as_dict"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.QPState.as_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert self into a dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">od</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
        <span class="n">od</span><span class="p">[</span><span class="s2">&quot;qpeme0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpeme0</span>
        <span class="k">return</span> <span class="n">od</span></div>

<div class="viewcode-block" id="QPState.to_strdict"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.QPState.to_strdict">[docs]</a>    <span class="k">def</span> <span class="nf">to_strdict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ordered dictionary mapping fields --&gt; strings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">duck</span><span class="o">.</span><span class="n">is_intlike</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Kpoint</span><span class="p">):</span>
                <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">iscomplexobj</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.e-3</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">v</span><span class="o">.</span><span class="n">real</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.2f%+.2f</span><span class="s2">j&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">v</span>
                <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="c1">#print(&quot;k&quot;, k, str(exc))</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tips</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Bound method of self that returns a dictionary with the description of the fields.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">TIPS</span><span class="p">()</span>

<div class="viewcode-block" id="QPState.TIPS"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.QPState.TIPS">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">TIPS</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class method that returns a dictionary with the description of the fields.</span>
<span class="sd">        The string are extracted from the class doc string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_TIPS</span>

        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># Parse the doc string.</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_TIPS</span> <span class="o">=</span> <span class="n">_TIPS</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.. Attributes&quot;</span><span class="p">):</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="k">break</span>

            <span class="k">def</span> <span class="nf">num_leadblanks</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Returns the number of the leading whitespaces.&quot;&quot;&quot;</span>
                <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())</span>

            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>

                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">field</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span><span class="p">):</span>
                        <span class="n">nblanks</span> <span class="o">=</span> <span class="n">num_leadblanks</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        <span class="n">desc</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
                            <span class="k">if</span> <span class="n">nblanks</span> <span class="o">==</span> <span class="n">num_leadblanks</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                                <span class="k">break</span>
                            <span class="n">desc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())</span>

                        <span class="n">_TIPS</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span>

            <span class="n">diffset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">_TIPS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">diffset</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The following fields are not documented: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">diffset</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">_TIPS</span></div>

<div class="viewcode-block" id="QPState.get_fields_for_plot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.QPState.get_fields_for_plot">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_fields_for_plot</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">with_fields</span><span class="p">,</span> <span class="n">exclude_fields</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return list of QPState fields to plot from input arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_fields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;spin&quot;</span><span class="p">,</span> <span class="s2">&quot;kpoint&quot;</span><span class="p">]))[:]</span>

        <span class="c1"># Initialize fields.</span>
        <span class="k">if</span> <span class="n">is_string</span><span class="p">(</span><span class="n">with_fields</span><span class="p">)</span> <span class="ow">and</span> <span class="n">with_fields</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">all_fields</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">list_strings</span><span class="p">(</span><span class="n">with_fields</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_fields</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Field </span><span class="si">%s</span><span class="s2"> not in allowed values </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">all_fields</span><span class="p">))</span>

        <span class="c1"># Remove entries</span>
        <span class="k">if</span> <span class="n">exclude_fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_string</span><span class="p">(</span><span class="n">exclude_fields</span><span class="p">):</span>
                <span class="n">exclude_fields</span> <span class="o">=</span> <span class="n">exclude_fields</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">exclude_fields</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fields</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="k">return</span> <span class="n">fields</span></div></div>


<span class="k">class</span> <span class="nc">QPList</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A list of quasiparticle corrections for a given spin.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_e0sorted</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_e0sorted&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">%s</span><span class="s2"> at </span><span class="si">%s</span><span class="s2">, len=</span><span class="si">%d</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">to_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a table (list of list of strings).&quot;&quot;&quot;</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">QPState</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;spin&quot;</span><span class="p">,</span> <span class="s2">&quot;kpoint&quot;</span><span class="p">])</span>
        <span class="n">table</span> <span class="o">=</span> <span class="p">[</span><span class="n">header</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">qp</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">qp</span><span class="o">.</span><span class="n">to_strdict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">header</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">tabulate</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">&quot;plain&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_table</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy of self.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">([</span><span class="n">qp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">qp</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">],</span> <span class="n">is_e0sorted</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_e0sorted</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">sort_by_e0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a new object with the E0 energies sorted in ascending order.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">qp</span><span class="p">:</span> <span class="n">qp</span><span class="o">.</span><span class="n">e0</span><span class="p">),</span> <span class="n">is_e0sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_e0mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the E0 energies.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_e0sorted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;QPState corrections are not sorted. Use sort_by_e0&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">qp</span><span class="o">.</span><span class="n">e0</span> <span class="k">for</span> <span class="n">qp</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">get_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;|numpy-array| containing the values of field.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">qp</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">get_skb_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the value of field for the given spin kp band tuple, None if not found&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">qp</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">qp</span><span class="o">.</span><span class="n">skb</span> <span class="o">==</span> <span class="n">skb</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">get_qpenes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an array with the :class:`QPState` energies.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="s2">&quot;qpe&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_qpeme0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an arrays with the :class:`QPState` corrections.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="s2">&quot;qpeme0&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merge self with other. Return new :class:`QPList` object</span>

<span class="sd">        Raise:</span>
<span class="sd">            `ValueError` if merge cannot be done.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">skb0_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">qp</span><span class="o">.</span><span class="n">skb</span> <span class="k">for</span> <span class="n">qp</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">qp</span> <span class="ow">in</span> <span class="n">other</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">qp</span><span class="o">.</span><span class="n">skb</span> <span class="ow">in</span> <span class="n">skb0_list</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Found duplicated (s,b,k) indexes: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">qp</span><span class="o">.</span><span class="n">skb</span><span class="p">))</span>

        <span class="n">qps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">copy</span> <span class="k">else</span> <span class="bp">self</span> <span class="o">+</span> <span class="n">other</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">qps</span><span class="p">)</span>

    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_qps_vs_e0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_fields</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">exclude_fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fermie</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">ax_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the QP results as function of the initial KS energy.</span>

<span class="sd">        Args:</span>
<span class="sd">            with_fields: The names of the qp attributes to plot as function of e0.</span>
<span class="sd">                Accepts: List of strings or string with tokens separated by blanks.</span>
<span class="sd">                See :class:`QPState` for the list of available fields.</span>
<span class="sd">            exclude_fields: Similar to ``with_field`` but excludes fields.</span>
<span class="sd">            fermie: Value of the Fermi level used in plot. None for absolute e0s.</span>
<span class="sd">            ax_list: List of |matplotlib-Axes| for plot. If None, new figure is produced.</span>
<span class="sd">            sharey: True if y-axis should be shared.</span>
<span class="sd">            kwargs: linestyle, color, label, marker</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: This is to maintain the old API.</span>
        <span class="n">fermi</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;fermi&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fermi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fermie</span> <span class="o">=</span> <span class="n">fermi</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;fermi keyword argument have been renamed fermie. Old arg will be removed in version 0.4&quot;</span><span class="p">)</span>

        <span class="n">fields</span> <span class="o">=</span> <span class="n">QPState</span><span class="o">.</span><span class="n">get_fields_for_plot</span><span class="p">(</span><span class="n">with_fields</span><span class="p">,</span> <span class="n">exclude_fields</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fields</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>

        <span class="n">num_plots</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">nrows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">num_plots</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_plots</span> <span class="o">//</span> <span class="n">ncols</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_plots</span> <span class="o">%</span> <span class="n">ncols</span><span class="p">)</span>

        <span class="c1"># Build grid of plots.</span>
        <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="n">ax_list</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                                <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">sharey</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax_list</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="c1"># Get qplist and sort it.</span>
        <span class="n">qps</span> <span class="o">=</span> <span class="bp">self</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_e0sorted</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_by_e0</span><span class="p">()</span>
        <span class="n">e0mesh</span> <span class="o">=</span> <span class="n">qps</span><span class="o">.</span><span class="n">get_e0mesh</span><span class="p">()</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$\epsilon_</span><span class="si">{KS}</span><span class="s2">\;(eV)$&quot;</span>
        <span class="c1">#print(&quot;fermie&quot;, fermie)</span>
        <span class="k">if</span> <span class="n">fermie</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$\epsilon_</span><span class="si">{KS}</span><span class="s2">-\epsilon_F\;(eV)$&quot;</span>
            <span class="n">e0mesh</span> <span class="o">-=</span> <span class="n">fermie</span>

        <span class="n">kw_linestyle</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;linestyle&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
        <span class="n">kw_color</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kw_label</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">ax_list</span><span class="p">)):</span>
            <span class="n">irow</span><span class="p">,</span> <span class="n">icol</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">ncols</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">irow</span> <span class="o">==</span> <span class="n">nrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="n">yy</span> <span class="o">=</span> <span class="n">qps</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

            <span class="c1"># TODO real and imag?</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">e0mesh</span><span class="p">,</span> <span class="n">yy</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">kw_linestyle</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">kw_color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">kw_label</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kw_label</span><span class="p">:</span>
            <span class="n">ax_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Get around a bug in matplotlib</span>
        <span class="k">if</span> <span class="n">num_plots</span> <span class="o">%</span> <span class="n">ncols</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ax_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span> <span class="nf">build_scissors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domains</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a scissors operator by interpolating the QPState corrections</span>
<span class="sd">        as function of the initial energies E0.</span>

<span class="sd">        Args:</span>
<span class="sd">            domains: list in the form [ [start1, stop1], [start2, stop2]</span>
<span class="sd">                Domains should not overlap, cover e0mesh, and given in increasing order.</span>
<span class="sd">                Holes are permitted but the interpolation will raise an exception if</span>
<span class="sd">                the point is not in domains.</span>
<span class="sd">            bounds: Specify how to handle out-of-boundary conditions, i.e. how to treat</span>
<span class="sd">                energies that do not fall inside one of the domains (not used at present)</span>
<span class="sd">            plot: If true, use matplolib plot to compare input data  and fit.</span>

<span class="sd">        Return:</span>
<span class="sd">            instance of :class:`Scissors`operator</span>

<span class="sd">        Usage example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            # Build the scissors operator.</span>
<span class="sd">            scissors = qplist_spin[0].build_scissors(domains)</span>

<span class="sd">            # Compute list of interpolated QP energies.</span>
<span class="sd">            qp_enes = [scissors.apply(e0) for e0 in ks_energies]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Sort QP corrections according to the initial KS energy.</span>
        <span class="n">qps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_by_e0</span><span class="p">()</span>
        <span class="n">e0mesh</span><span class="p">,</span> <span class="n">qpcorrs</span> <span class="o">=</span> <span class="n">qps</span><span class="o">.</span><span class="n">get_e0mesh</span><span class="p">(),</span> <span class="n">qps</span><span class="o">.</span><span class="n">get_qpeme0</span><span class="p">()</span>

        <span class="c1"># Check domains.</span>
        <span class="n">domains</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">domains</span><span class="p">)</span>
        <span class="n">dsize</span><span class="p">,</span> <span class="n">dflat</span> <span class="o">=</span> <span class="n">domains</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">domains</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dflat</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">e0mesh</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;min(e0mesh) </span><span class="si">%s</span><span class="s2"> is not included in domains&quot;</span> <span class="o">%</span> <span class="n">e0mesh</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">dsize</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="n">e0mesh</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;max(e0mesh) </span><span class="si">%s</span><span class="s2"> is not included in domains&quot;</span> <span class="o">%</span> <span class="n">e0mesh</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">!=</span> <span class="n">dsize</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">dflat</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dflat</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;domain boundaries should be given in increasing order.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">dsize</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">dflat</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">dflat</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;domain boundaries should be given in increasing order.&quot;</span><span class="p">)</span>

        <span class="c1"># Create the sub_domains and the spline functions in each subdomain.</span>
        <span class="n">func_list</span><span class="p">,</span> <span class="n">residues</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">domains</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1">#print(&#39;forcing extremal point on the scissor&#39;)</span>
            <span class="n">ndom</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ndom</span> <span class="o">=</span> <span class="mi">99</span>

        <span class="k">for</span> <span class="n">dom</span> <span class="ow">in</span> <span class="n">domains</span><span class="p">[:]:</span>
            <span class="n">ndom</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">dom</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">find_ge</span><span class="p">(</span><span class="n">e0mesh</span><span class="p">,</span> <span class="n">low</span><span class="p">),</span> <span class="n">find_le</span><span class="p">(</span><span class="n">e0mesh</span><span class="p">,</span> <span class="n">high</span><span class="p">)</span>

            <span class="n">dom_e0</span> <span class="o">=</span> <span class="n">e0mesh</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dom_corr</span> <span class="o">=</span> <span class="n">qpcorrs</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># todo check if the number of non degenerate data points &gt; k</span>
            <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">UnivariateSpline</span>
            <span class="n">w</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dom_e0</span><span class="p">)</span><span class="o">*</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ndom</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">w</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span>
            <span class="k">elif</span> <span class="n">ndom</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">UnivariateSpline</span><span class="p">(</span><span class="n">dom_e0</span><span class="p">,</span> <span class="n">dom_corr</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">func_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">residues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">get_residual</span><span class="p">())</span>

        <span class="c1"># Build the scissors operator.</span>
        <span class="n">sciss</span> <span class="o">=</span> <span class="n">Scissors</span><span class="p">(</span><span class="n">func_list</span><span class="p">,</span> <span class="n">domains</span><span class="p">,</span> <span class="n">residues</span><span class="p">,</span> <span class="n">bounds</span><span class="p">)</span>

        <span class="c1"># Compare fit with input data.</span>
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">e0mesh</span><span class="p">,</span> <span class="n">qpcorrs</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;input data&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">title</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dom</span> <span class="ow">in</span> <span class="n">domains</span><span class="p">[:]:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">[</span><span class="n">dom</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">qpcorrs</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">qpcorrs</span><span class="p">)])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">[</span><span class="n">dom</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">qpcorrs</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">qpcorrs</span><span class="p">)])</span>
            <span class="n">intp_qpc</span> <span class="o">=</span> <span class="p">[</span><span class="n">sciss</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span> <span class="k">for</span> <span class="n">e0</span> <span class="ow">in</span> <span class="n">e0mesh</span><span class="p">]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">e0mesh</span><span class="p">,</span> <span class="n">intp_qpc</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;scissor&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># Return the object.</span>
        <span class="k">return</span> <span class="n">sciss</span>


<span class="k">class</span> <span class="nc">SelfEnergy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object stores the values of the electron-electron self-energy</span>
<span class="sd">    and the associated spectral function as function of frequency</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Symbols used in matplotlib plots.</span>
    <span class="n">latex_symbol</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">re</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\Re{\Sigma(\omega)}$&quot;</span><span class="p">,</span>
        <span class="n">im</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\Im{\Sigma(\omega)}$&quot;</span><span class="p">,</span>
        <span class="n">spfunc</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$A(\omega)}$&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">wmesh</span><span class="p">,</span> <span class="n">sigmaxc_values</span><span class="p">,</span> <span class="n">spfunc_values</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">band</span> <span class="o">=</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wmesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">wmesh</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xc</span> <span class="o">=</span> <span class="n">Function1D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wmesh</span><span class="p">,</span> <span class="n">sigmaxc_values</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spfunc</span> <span class="o">=</span> <span class="n">Function1D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wmesh</span><span class="p">,</span> <span class="n">spfunc_values</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sigmaxc_values</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">spfunc_values</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;K-point: </span><span class="si">%s</span><span class="s2">, band: </span><span class="si">%d</span><span class="s2">, spin: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoint</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Number of frequencies: </span><span class="si">%d</span><span class="s2">, from </span><span class="si">%.1f</span><span class="s2"> to </span><span class="si">%.1f</span><span class="s2"> (eV)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wmesh</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">wmesh</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">wmesh</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_ax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to plot data on the axis ax with fontsize</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: |matplotlib-Axes| or None if a new figure should be created.</span>
<span class="sd">            what:</span>
<span class="sd">            fontsize: legend and title fontsize.</span>

<span class="sd">        Return: List of lines.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#if not kwargs: kwargs = {&quot;color&quot;: &quot;black&quot;, &quot;linewidth&quot;: 2.0}</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">extend</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">extend</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xc</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\Sigma(\omega)$&quot;</span><span class="p">)</span>
            <span class="n">extend</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">cplx_mode</span><span class="o">=</span><span class="s2">&quot;re&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Re &quot;</span> <span class="o">+</span> <span class="n">label</span><span class="p">))</span>
            <span class="n">extend</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">cplx_mode</span><span class="o">=</span><span class="s2">&quot;im&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Im &quot;</span> <span class="o">+</span> <span class="n">label</span><span class="p">))</span>
            <span class="c1">#ax.set_ylabel(&#39;Energy (eV)&#39;)</span>

        <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spfunc</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$A(\omega)$&quot;</span><span class="p">)</span>
            <span class="n">extend</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know how to handle what option </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">what</span><span class="p">))</span>

        <span class="c1">#ax.set_xlabel(r&quot;$\omega - \espilon_{KS} (eV)&quot;)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lines</span>

    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">what_list</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;re&quot;</span><span class="p">,</span> <span class="s2">&quot;im&quot;</span><span class="p">,</span> <span class="s2">&quot;spfunc&quot;</span><span class="p">),</span> <span class="n">fermie</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the real/imaginary part of self-energy as well as the spectral function</span>

<span class="sd">        Args:</span>
<span class="sd">            ax_list: List of |matplotlib-Axes| for plot. If None, new figure is produced.</span>
<span class="sd">            what_list: List of strings selecting the quantity to plot.</span>
<span class="sd">            fermie: Value of the Fermi level used in plot. None for absolute e0s.</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                or scalar e.g. ``left``. If left (right) is None, default values are used.</span>
<span class="sd">            fontsize: legend and label fontsize.</span>
<span class="sd">            kwargs: Keyword arguments passed to ax.plot</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">what_list</span> <span class="o">=</span> <span class="n">list_strings</span><span class="p">(</span><span class="n">what_list</span><span class="p">)</span>
        <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="n">ax_list</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">what_list</span><span class="p">),</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax_list</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$\omega\;(eV)$&quot;</span>
        <span class="n">wmesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wmesh</span>
        <span class="k">if</span> <span class="n">fermie</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$\omega - \epsilon_F}\;(eV)$&quot;</span>
            <span class="n">wmesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wmesh</span> <span class="o">-</span> <span class="n">fermie</span>

        <span class="n">kw_color</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kw_label</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">what_list</span><span class="p">,</span> <span class="n">ax_list</span><span class="p">)):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latex_symbol</span><span class="p">[</span><span class="n">what</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wmesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ys</span><span class="p">(</span><span class="n">what</span><span class="p">),</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">kw_color</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">kw_label</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">kw_label</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;title&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;K-point: </span><span class="si">%s</span><span class="s2">, band: </span><span class="si">%d</span><span class="s2">, spin: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoint</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span> <span class="nf">_get_ys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return array to plot from what string.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">re</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xc</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">real</span><span class="p">,</span>
            <span class="n">im</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xc</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span>
            <span class="n">spfunc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spfunc</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="p">)[</span><span class="n">what</span><span class="p">]</span>


<div class="viewcode-block" id="SigresFile"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresFile">[docs]</a><span class="k">class</span> <span class="nc">SigresFile</span><span class="p">(</span><span class="n">AbinitNcFile</span><span class="p">,</span> <span class="n">Has_Structure</span><span class="p">,</span> <span class="n">Has_ElectronBands</span><span class="p">,</span> <span class="n">NotebookWriter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Container storing the GW results reported in the SIGRES.nc file.</span>

<span class="sd">    Usage example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        sigres = SigresFile(&quot;foo_SIGRES.nc&quot;)</span>
<span class="sd">        sigres.plot_qps_vs_e0()</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: SigresFile</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Markers used for up/down bands.</span>
    <span class="n">marker_spin</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;v&quot;</span><span class="p">}</span>
    <span class="n">color_spin</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;r&quot;</span><span class="p">}</span>

<div class="viewcode-block" id="SigresFile.from_file"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresFile.from_file">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize an instance from file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read data from the netcdf file path.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

        <span class="c1"># Keep a reference to the SigresReader.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="n">reader</span> <span class="o">=</span> <span class="n">SigresReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read_structure</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gwcalctyp</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">gwcalctyp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ibz</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">ibz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gwkpoints</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">gwkpoints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nkcalc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gwkpoints</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gwbstart_sk</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">gwbstart_sk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gwbstop_sk</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">gwbstop_sk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_gwbstart</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">min_gwbstart</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_gwbstart</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">max_gwbstart</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_gwbstop</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">min_gwbstop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_gwbstop</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">max_gwbstop</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ebands</span> <span class="o">=</span> <span class="n">ebands</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">ks_bands</span>

        <span class="n">qplist_spin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qplist_spin</span>

        <span class="c1"># TODO handle the case in which nkptgw &lt; nkibz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qpgaps</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read_qpgaps</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qpenes</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read_qpenes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ksgaps</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read_ksgaps</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sigma_kpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The K-points where QP corrections have been calculated.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwkpoints</span>

<div class="viewcode-block" id="SigresFile.get_marker"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresFile.get_marker">[docs]</a>    <span class="k">def</span> <span class="nf">get_marker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qpattr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return :class:`Marker` object associated to the QP attribute qpattr.</span>
<span class="sd">        Used to prepare plots of KS bands with markers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Each marker is a list of tuple(x, y, value)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">qp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">qplist_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">]:</span>
                <span class="n">ik</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">qp</span><span class="o">.</span><span class="n">kpoint</span><span class="p">)</span>
                <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span>
                <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qp</span><span class="o">.</span><span class="n">e0</span><span class="p">)</span>
                <span class="n">size</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">qpattr</span><span class="p">)</span>
                <span class="c1"># Handle complex quantities</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">iscomplex</span><span class="p">(</span><span class="n">size</span><span class="p">):</span> <span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="o">.</span><span class="n">real</span>
                <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Marker</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span></div>

<div class="viewcode-block" id="SigresFile.params"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresFile.params">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;:class:`OrderedDict` with parameters that might be subject to convergence studies e.g ecuteps&quot;&quot;&quot;</span>
        <span class="n">od</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ebands_params</span><span class="p">()</span>
        <span class="n">od</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_params</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">od</span></div>

<div class="viewcode-block" id="SigresFile.close"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresFile.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close the netcdf file.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

<div class="viewcode-block" id="SigresFile.to_string"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresFile.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation with verbosity level ``verbose``.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>

        <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="s2">&quot;File Info&quot;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filestat</span><span class="p">(</span><span class="n">as_string</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Structure&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Kohn-Sham bands&quot;</span><span class="p">,</span> <span class="n">with_structure</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># TODO: Finalize the implementation: add GW metadata.</span>
        <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="s2">&quot;QP direct gaps&quot;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">kgw</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwkpoints</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                <span class="n">qp_dirgap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_qpgap</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kgw</span><span class="p">)</span>
                <span class="n">app</span><span class="p">(</span><span class="s2">&quot;QP_dirgap: </span><span class="si">%.3f</span><span class="s2"> (eV) for K-point: </span><span class="si">%s</span><span class="s2">, spin: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qp_dirgap</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">kgw</span><span class="p">),</span> <span class="n">spin</span><span class="p">))</span>
                <span class="c1">#ks_dirgap =</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Show QP results</span>
        <span class="n">strio</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_qps</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ignore_imag</span><span class="o">=</span><span class="n">verbose</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">strio</span><span class="p">)</span>
        <span class="n">strio</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="s2">&quot;QP results for each k-point and spin (all in eV)&quot;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">strio</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># TODO: Fix header.</span>
        <span class="c1">#if verbose &gt; 1:</span>
        <span class="c1">#    app(&quot;&quot;)</span>
        <span class="c1">#    app(marquee(&quot;Abinit Header&quot;, mark=&quot;=&quot;))</span>
        <span class="c1">#    app(self.hdr.to_string(verbose=verbose))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;|Structure| object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ebands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;|ElectronBands| with the KS energies.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ebands</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_spectral_function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if file contains spectral function data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">has_spfunc</span>

<div class="viewcode-block" id="SigresFile.qplist_spin"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresFile.qplist_spin">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">qplist_spin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tuple of :class:`QPList` objects indexed by spin.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_allqps</span><span class="p">()</span></div>

<div class="viewcode-block" id="SigresFile.get_qplist"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresFile.get_qplist">[docs]</a>    <span class="k">def</span> <span class="nf">get_qplist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">ignore_imag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return :class`QPList` for the given (spin, kpoint)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_qplist_sk</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">ignore_imag</span><span class="o">=</span><span class="n">ignore_imag</span><span class="p">)</span></div>

<div class="viewcode-block" id="SigresFile.get_qpcorr"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresFile.get_qpcorr">[docs]</a>    <span class="k">def</span> <span class="nf">get_qpcorr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">ignore_imag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the :class:`QPState` object for the given (s, k, b)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_qp</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">ignore_imag</span><span class="o">=</span><span class="n">ignore_imag</span><span class="p">)</span></div>

<div class="viewcode-block" id="SigresFile.qpgaps"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresFile.qpgaps">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">qpgaps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;|numpy-array| of shape [nsppol, nkibz] with the QP direct gaps in eV.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_qpgaps</span><span class="p">()</span></div>

<div class="viewcode-block" id="SigresFile.get_qpgap"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresFile.get_qpgap">[docs]</a>    <span class="k">def</span> <span class="nf">get_qpgap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">with_ksgap</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the QP gap in eV at the given (spin, kpoint)&quot;&quot;&quot;</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">kpt2fileindex</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">with_ksgap</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpgaps</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpgaps</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ksgaps</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span></div>

<div class="viewcode-block" id="SigresFile.read_sigee_skb"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresFile.read_sigee_skb">[docs]</a>    <span class="k">def</span> <span class="nf">read_sigee_skb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">        Read self-energy(w) for (spin, kpoint, band)</span>
<span class="sd">        Return: :class:`SelfEnergy` object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ik</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">kpt2fileindex</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span>
        <span class="n">kpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibz</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span>
        <span class="n">wmesh</span><span class="p">,</span> <span class="n">sigxc_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_sigmaw</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">band</span><span class="p">)</span>
        <span class="n">wmesh</span><span class="p">,</span> <span class="n">spf_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_spfunc</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">band</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">SelfEnergy</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">wmesh</span><span class="p">,</span> <span class="n">sigxc_values</span><span class="p">,</span> <span class="n">spf_values</span><span class="p">)</span></div>

<div class="viewcode-block" id="SigresFile.print_qps"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresFile.print_qps">[docs]</a>    <span class="k">def</span> <span class="nf">print_qps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ignore_imag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print QP results to stream ``file``.</span>

<span class="sd">        Args:</span>
<span class="sd">            precision: Number of significant digits.</span>
<span class="sd">            ignore_imag: True if imaginary part should be ignored.</span>
<span class="sd">            file: Output stream.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">abipy.tools.printing</span> <span class="kn">import</span> <span class="n">print_dataframe</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="s2">&quot;band e0 qpe qpe_diago vxcme sigxme sigcmee0 vUme ze0&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">gwkpoint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwkpoints</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                <span class="n">df_sk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dataframe_sk</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">gwkpoint</span><span class="p">,</span> <span class="n">ignore_imag</span><span class="o">=</span><span class="n">ignore_imag</span><span class="p">)[</span><span class="n">keys</span><span class="p">]</span>
                <span class="n">print_dataframe</span><span class="p">(</span><span class="n">df_sk</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;K-point: </span><span class="si">%s</span><span class="s2">, spin: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">gwkpoint</span><span class="p">),</span> <span class="n">spin</span><span class="p">),</span>
                                <span class="n">precision</span><span class="o">=</span><span class="n">precision</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span></div>

<div class="viewcode-block" id="SigresFile.get_points_from_ebands"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresFile.get_points_from_ebands">[docs]</a>    <span class="k">def</span> <span class="nf">get_points_from_ebands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ebands_kpath</span><span class="p">,</span> <span class="n">dist_tol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate object storing the QP energies lying on the k-path used by ebands_kpath.</span>
<span class="sd">        Mainly used to plot the QP energies in ebands.plot when the QP energies are interpolated with the SKW method.</span>

<span class="sd">        Args:</span>
<span class="sd">            ebands_kpath: |ElectronBands| object with the QP energies along an arbitrary k-path.</span>
<span class="sd">            dist_tol: A point is considered to be on the path if its distance from the line</span>
<span class="sd">                is less than dist_tol.</span>
<span class="sd">            size: The marker size in points**2</span>
<span class="sd">            verbose: Verbosity level</span>

<span class="sd">        Return:</span>

<span class="sd">        Example::</span>

<span class="sd">            r = sigres.interpolate(lpratio=5,</span>
<span class="sd">                                   ks_ebands_kpath=ks_ebands_kpath,</span>
<span class="sd">                                   ks_ebands_kmesh=ks_ebands_kmesh</span>
<span class="sd">                                   )</span>
<span class="sd">            points = sigres.get_points_from_ebands(r.qp_ebands_kpath, size=24)</span>
<span class="sd">            r.qp_ebands_kpath.plot(points=points)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kpath</span> <span class="o">=</span> <span class="n">ebands_kpath</span><span class="o">.</span><span class="n">kpoints</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ebands_kpath</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">is_path</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expecting band structure with a Kpath, got </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">kpath</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Input kpath</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ebands_kpath</span><span class="o">.</span><span class="n">kpoints</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;gwkpoints included in GW calculation</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwkpoints</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;lines</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">kpath</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;kpath.frac_bounds:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">kpath</span><span class="o">.</span><span class="n">frac_bounds</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;kpath.cart_bounds:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">kpath</span><span class="o">.</span><span class="n">frac_bounds</span><span class="p">)</span>

        <span class="c1"># Construct the stars of the k-points for all k-points included in the GW calculation.</span>
        <span class="c1"># In principle, the input k-path is arbitrary and not necessarily in the IBZ used for GW</span>
        <span class="c1"># so we have to build the k-stars and find the k-points lying along the path and keep</span>
        <span class="c1"># track of the mapping kpt --&gt; star --&gt; kgw</span>
        <span class="n">gw_stars</span> <span class="o">=</span> <span class="p">[</span><span class="n">kpoint</span><span class="o">.</span><span class="n">compute_star</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">abi_spacegroup</span><span class="o">.</span><span class="n">fm_symmops</span><span class="p">)</span> <span class="k">for</span> <span class="n">kpoint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwkpoints</span><span class="p">]</span>
        <span class="n">cart_coords</span><span class="p">,</span> <span class="n">back2istar</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">istar</span><span class="p">,</span> <span class="n">gw_star</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gw_stars</span><span class="p">):</span>
            <span class="n">cart_coords</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">k</span><span class="o">.</span><span class="n">cart_coords</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">gw_star</span><span class="p">])</span>
            <span class="n">back2istar</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">istar</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">gw_star</span><span class="p">))</span>
        <span class="n">cart_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">cart_coords</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

        <span class="c1"># Find (star) k-points on the path.</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">kpath</span><span class="o">.</span><span class="n">find_points_along_path</span><span class="p">(</span><span class="n">cart_coords</span><span class="p">,</span> <span class="n">dist_tol</span><span class="o">=</span><span class="n">dist_tol</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">ikfound</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Warning: Found zero points lying on the input k-path. Try to increase dist_tol.&quot;</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Marker</span><span class="p">()</span>

        <span class="c1"># Read complex GW energies from file.</span>
        <span class="n">qp_arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;egw&quot;</span><span class="p">,</span> <span class="n">cmode</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>

        <span class="c1"># Each marker is a list of tuple(x, y, value)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">kpath_lenght</span> <span class="o">=</span> <span class="n">kpath</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">ik</span><span class="p">,</span> <span class="n">dalong_path</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">ikfound</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">dist_list</span><span class="p">):</span>
            <span class="n">istar</span> <span class="o">=</span> <span class="n">back2istar</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span>
            <span class="c1"># The k-point used in the GW calculation.</span>
            <span class="n">gwk</span> <span class="o">=</span> <span class="n">gw_stars</span><span class="p">[</span><span class="n">istar</span><span class="p">]</span><span class="o">.</span><span class="n">base_point</span>
            <span class="c1"># Indices needed to access SIGRES arrays (we have to live with this format)</span>
            <span class="n">ik_ibz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">kpt2fileindex</span><span class="p">(</span><span class="n">gwk</span><span class="p">)</span>
            <span class="n">ik_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">gwkpt2seqindex</span><span class="p">(</span><span class="n">gwk</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                <span class="c1"># Need to select bands included in the GW calculation.</span>
                <span class="k">for</span> <span class="n">qpe</span> <span class="ow">in</span> <span class="n">qp_arr</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik_ibz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwbstart_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik_b</span><span class="p">]:</span><span class="bp">self</span><span class="o">.</span><span class="n">gwbstop_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik_b</span><span class="p">]]:</span>
                    <span class="c1"># Assume the path is properly normalized.</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">dalong_path</span> <span class="o">/</span> <span class="n">kpath_lenght</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kpath</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qpe</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Marker</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span></div>

<div class="viewcode-block" id="SigresFile.plot_qpgaps"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresFile.plot_qpgaps">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_qpgaps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_qpmks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the KS and the QP direct gaps for all the k-points and spins available on file.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: |matplotlib-Axes| or None if a new figure should be created.</span>
<span class="sd">            plot_qpmks: If False, plot QP_gap, KS_gap else (QP_gap - KS_gap)</span>
<span class="sd">            fontsize: legend and title fontsize.</span>
<span class="sd">            kwargs: Passed to ax.plot method except for marker.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nkcalc</span><span class="p">)</span>

        <span class="c1"># Add xticklabels from k-points.</span>
        <span class="n">tick_labels</span> <span class="o">=</span> <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwkpoints</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">tick_labels</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;x-small&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
            <span class="n">qp_gaps</span><span class="p">,</span> <span class="n">ks_gaps</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_qpgap</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kgw</span><span class="p">,</span> <span class="n">with_ksgap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">kgw</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwkpoints</span><span class="p">]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">plot_qpmks</span><span class="p">:</span>
                <span class="c1"># Plot QP gaps</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">qp_gaps</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">marker_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">],</span>
                        <span class="n">label</span><span class="o">=</span><span class="n">label</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="c1"># Add KS gaps</span>
                <span class="c1">#ax.scatter(xx, ks_gaps) #, label=&quot;KS gap %s&quot; % label)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Plot QP_gap - KS_gap</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">qp_gaps</span> <span class="o">-</span> <span class="n">ks_gaps</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">marker_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">],</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">label</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;K-point&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">plot_qpmks</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;QP-KS gap (eV)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;QP direct gap (eV)&quot;</span><span class="p">)</span>
            <span class="c1">#ax.set_title(&quot;k:%s&quot; % (repr(kgw)), fontsize=fontsize)</span>
            <span class="k">if</span> <span class="n">label</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="SigresFile.plot_qps_vs_e0"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresFile.plot_qps_vs_e0">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_qps_vs_e0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_fields</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">exclude_fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span>
                       <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot QP result in SIGRES file as function of the KS energy.</span>

<span class="sd">        Args:</span>
<span class="sd">            with_fields: The names of the qp attributes to plot as function of eKS.</span>
<span class="sd">                Accepts: List of strings or string with tokens separated by blanks.</span>
<span class="sd">                See :class:`QPState` for the list of available fields.</span>
<span class="sd">            exclude_fields: Similar to ``with_fields`` but excludes fields</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - `fermie`: shift all eigenvalues to have zero energy at the Fermi energy (`self.fermie`).</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">            ax_list: List of |matplotlib-Axes| for plot. If None, new figure is produced.</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                   or scalar e.g. ``left``. If left (right) is None, default values are used.</span>
<span class="sd">            sharey: True if y-axis should be shared.</span>
<span class="sd">            fontsize: Legend and title fontsize.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">with_fields</span> <span class="o">=</span> <span class="n">QPState</span><span class="o">.</span><span class="n">get_fields_for_plot</span><span class="p">(</span><span class="n">with_fields</span><span class="p">,</span> <span class="n">exclude_fields</span><span class="p">)</span>

        <span class="c1"># Because qplist does not have the fermi level.</span>
        <span class="n">fermie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span> <span class="k">if</span> <span class="n">e0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qplist_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span><span class="o">.</span><span class="n">plot_qps_vs_e0</span><span class="p">(</span>
                <span class="n">with_fields</span><span class="o">=</span><span class="n">with_fields</span><span class="p">,</span> <span class="n">exclude_fields</span><span class="o">=</span><span class="n">exclude_fields</span><span class="p">,</span> <span class="n">fermie</span><span class="o">=</span><span class="n">fermie</span><span class="p">,</span>
                <span class="n">xlims</span><span class="o">=</span><span class="n">xlims</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">sharey</span><span class="p">,</span> <span class="n">ax_list</span><span class="o">=</span><span class="n">ax_list</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">marker_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">],</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">ax_list</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="SigresFile.plot_spectral_functions"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresFile.plot_spectral_functions">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_spectral_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_bands</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the spectral function for all k-points, bands and spins available in the SIGRES file.</span>

<span class="sd">        Args:</span>
<span class="sd">            include_bands: List of bands to include. Nonee means all.</span>
<span class="sd">            fontsize: Legend and title fontsize.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">include_bands</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">include_bands</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">include_bands</span><span class="p">)</span>

        <span class="c1"># Build grid of plots.</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">),</span> <span class="mi">1</span>
        <span class="n">ax_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="n">ax_list</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                                <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax_list</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">ik_gw</span><span class="p">,</span> <span class="p">(</span><span class="n">kgw</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">,</span> <span class="n">ax_list</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gwbstart_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik_gw</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwbstop_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik_gw</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">include_bands</span> <span class="ow">and</span> <span class="n">band</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">include_bands</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="n">sigw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_sigee_skb</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kgw</span><span class="p">,</span> <span class="n">band</span><span class="p">)</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$A(\omega)$: band: </span><span class="si">%d</span><span class="s2">, spin: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="p">)</span>
                    <span class="n">sigw</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;K-point: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">sigw</span><span class="o">.</span><span class="n">kpoint</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="c1">#if ik_gw == len(self.sigma_kpoints) - 1:</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="SigresFile.plot_eigvec_qp"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresFile.plot_eigvec_qp">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_eigvec_qp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">kpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            spin: Spin index</span>
<span class="sd">            kpoint: K-point in self-energy. Accepts |Kpoint|, vector or index.</span>
<span class="sd">                If None, all k-points for the given ``spin`` are shown.</span>
<span class="sd">            band: band index. If None all bands are displayed else</span>
<span class="sd">                only &lt;KS_b|QP_{b&#39;}&gt; for the given b.</span>
<span class="sd">            kwargs: Passed to plot method of :class:`ArrayPlotter`.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plotter</span> <span class="o">=</span> <span class="n">ArrayPlotter</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">kpoint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">kpoint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibz</span><span class="p">:</span>
                <span class="n">ksqp_arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_eigvec_qp</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">)</span>
                <span class="n">plotter</span><span class="o">.</span><span class="n">add_array</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">kpoint</span><span class="p">),</span> <span class="n">ksqp_arr</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">plotter</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">ksqp_arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_eigvec_qp</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">)</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">add_array</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">kpoint</span><span class="p">),</span> <span class="n">ksqp_arr</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">plotter</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="SigresFile.plot_qpbands_ibz"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresFile.plot_qpbands_ibz">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_qpbands_ibz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the KS band structure in the IBZ with the QP energies.</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot.</span>
<span class="sd">            colormap: matplotlib color map.</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                   or scalar e.g. ``left``. If left (right) is None, default values are used.</span>
<span class="sd">            fontsize: Legend and title fontsize.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Map sigma_kpoints to ebands.kpoints</span>
        <span class="n">kcalc2ibz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nkcalc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">sigkpt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">):</span>
            <span class="n">kcalc2ibz</span><span class="p">[</span><span class="n">ikc</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">sigkpt</span><span class="p">)</span>

        <span class="c1"># TODO: It seems there&#39;s a minor issue with fermie if SCF band structure.</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
        <span class="c1">#print(&quot;e0&quot;,e0, self.ebands.fermie)</span>

        <span class="c1"># Build grid with (1, nsppol) plots.</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span>
        <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                                <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax_list</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>

        <span class="c1"># Read QP energies: Fortran egw(nbnds,nkibz,nsppol)</span>
        <span class="n">qpes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;egw&quot;</span><span class="p">,</span> <span class="n">cmode</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">)</span> <span class="c1"># * units.Ha_to_eV</span>
        <span class="n">band_range</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">max_gwbstart</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">min_gwbstop</span><span class="p">)</span>

        <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">min_gwbstop</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">min_gwbstart</span>
        <span class="k">for</span> <span class="n">spin</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">),</span> <span class="n">ax_list</span><span class="p">):</span>
            <span class="c1"># Plot KS bands in the band range included in self-energy calculation.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="n">e0</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span> <span class="n">band_range</span><span class="o">=</span><span class="n">band_range</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># Extract QP in IBZ</span>
            <span class="n">yvals</span> <span class="o">=</span> <span class="n">qpes</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">kcalc2ibz</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">real</span> <span class="o">-</span> <span class="n">e0</span>
            <span class="c1"># Add (scattered) QP energies for the calculated k-points.</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">max_gwbstart</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">min_gwbstop</span><span class="p">):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">kcalc2ibz</span><span class="p">,</span> <span class="n">yvals</span><span class="p">[:,</span> <span class="n">band</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">band</span> <span class="o">/</span> <span class="n">nb</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="SigresFile.plot_ksbands_with_qpmarkers"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresFile.plot_ksbands_with_qpmarkers">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_ksbands_with_qpmarkers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qpattr</span><span class="o">=</span><span class="s2">&quot;qpeme0&quot;</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the KS energies as function of k-points and add markers whose size</span>
<span class="sd">        is proportional to the QPState attribute ``qpattr``</span>

<span class="sd">        Args:</span>
<span class="sd">            qpattr: Name of the QP attribute to plot. See :class:`QPState`.</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - ``fermie``: shift all eigenvalues to have zero energy at the Fermi energy (``self.fermie``).</span>
<span class="sd">                -  Number e.g ``e0 = 0.5``: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to ``e0 = 0``</span>
<span class="sd">            fact: Markers are multiplied by this factor.</span>
<span class="sd">            ax: |matplotlib-Axes| or None if a new figure should be created.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="n">gwband_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_gwbstart</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_gwbstop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">band_range</span><span class="o">=</span><span class="n">gwband_range</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="n">e0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_marker</span><span class="p">(</span><span class="n">qpattr</span><span class="p">)</span>
        <span class="n">pos</span><span class="p">,</span> <span class="n">neg</span> <span class="o">=</span> <span class="n">marker</span><span class="o">.</span><span class="n">posneg_marker</span><span class="p">()</span>

        <span class="c1"># Use different symbols depending on the value of s. Cannot use negative s.</span>
        <span class="k">if</span> <span class="n">pos</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">pos</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">e0</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">s</span><span class="p">)</span> <span class="o">*</span> <span class="n">fact</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">qpattr</span> <span class="o">+</span> <span class="s2">&quot; &gt;0&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neg</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">neg</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">neg</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">e0</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">neg</span><span class="o">.</span><span class="n">s</span><span class="p">)</span> <span class="o">*</span> <span class="n">fact</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">qpattr</span> <span class="o">+</span> <span class="s2">&quot; &lt;0&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="SigresFile.get_dataframe"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresFile.get_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">get_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore_imag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns |pandas-DataFrame| with QP results for all k-points included in the GW calculation</span>

<span class="sd">        Args:</span>
<span class="sd">            ignore_imag: Only real part is returned if ``ignore_imag``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">gwkpoint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwkpoints</span><span class="p">:</span>
                <span class="n">df_sk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dataframe_sk</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">gwkpoint</span><span class="p">,</span> <span class="n">ignore_imag</span><span class="o">=</span><span class="n">ignore_imag</span><span class="p">)</span>
                <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_sk</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_list</span><span class="p">)</span></div>

    <span class="c1"># FIXME: To maintain previous interface.</span>
    <span class="n">to_dataframe</span> <span class="o">=</span> <span class="n">get_dataframe</span>

<div class="viewcode-block" id="SigresFile.get_dataframe_sk"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresFile.get_dataframe_sk">[docs]</a>    <span class="k">def</span> <span class="nf">get_dataframe_sk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignore_imag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">with_params</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns |pandas-DataFrame| with QP results for the given (spin, k-point).</span>

<span class="sd">        Args:</span>
<span class="sd">            ignore_imag: Only real part is returned if ``ignore_imag``.</span>
<span class="sd">            with_params: True to include convergence paramenters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rows</span><span class="p">,</span> <span class="n">bands</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="c1"># bstart and bstop depends on kpoint.</span>
        <span class="n">ik_gw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">gwkpt2seqindex</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gwbstart_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik_gw</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwbstop_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik_gw</span><span class="p">]):</span>
            <span class="n">bands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>
            <span class="c1"># Build dictionary with the QP results.</span>
            <span class="n">qpstate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_qp</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">ignore_imag</span><span class="o">=</span><span class="n">ignore_imag</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">qpstate</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
            <span class="c1"># Add other entries that may be useful when comparing different calculations.</span>
            <span class="k">if</span> <span class="n">with_params</span><span class="p">:</span>
                <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span> <span class="o">*</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">bands</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span></div>

    <span class="c1">#def plot_matrix_elements(self, mel_name, spin, kpoint, *args, **kwargs):</span>
    <span class="c1">#   matrix = self.reader.read_mel(mel_name, spin, kpoint):</span>
    <span class="c1">#   return plot_matrix(matrix, *args, **kwargs)</span>

    <span class="c1">#def plot_mlda_to_qps(self, spin, kpoint, *args, **kwargs):</span>
    <span class="c1">#    matrix = self.reader.read_mlda_to_qps(spin, kpoint)</span>
    <span class="c1">#    return plot_matrix(matrix, *args, **kwargs)</span>

<div class="viewcode-block" id="SigresFile.interpolate"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresFile.interpolate">[docs]</a>    <span class="k">def</span> <span class="nf">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lpratio</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ks_ebands_kpath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ks_ebands_kmesh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ks_degatol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
                    <span class="n">vertices_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">line_density</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">filter_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">only_corrections</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Interpolate the GW corrections in k-space on a k-path and, optionally, on a k-mesh.</span>

<span class="sd">        Args:</span>
<span class="sd">            lpratio: Ratio between the number of star functions and the number of ab-initio k-points.</span>
<span class="sd">                The default should be OK in many systems, larger values may be required for accurate derivatives.</span>
<span class="sd">            ks_ebands_kpath: KS |ElectronBands| on a k-path. If present,</span>
<span class="sd">                the routine interpolates the QP corrections and apply them on top of the KS band structure</span>
<span class="sd">                This is the recommended option because QP corrections are usually smoother than the</span>
<span class="sd">                QP energies and therefore easier to interpolate. If None, the QP energies are interpolated</span>
<span class="sd">                along the path defined by ``vertices_names`` and ``line_density``.</span>
<span class="sd">            ks_ebands_kmesh: KS |ElectronBands| on a homogeneous k-mesh. If present, the routine</span>
<span class="sd">                interpolates the corrections on the k-mesh (used to compute QP the DOS)</span>
<span class="sd">            ks_degatol: Energy tolerance in eV. Used when either ``ks_ebands_kpath`` or ``ks_ebands_kmesh`` are given.</span>
<span class="sd">                KS energies are assumed to be degenerate if they differ by less than this value.</span>
<span class="sd">                The interpolator may break band degeneracies (the error is usually smaller if QP corrections</span>
<span class="sd">                are interpolated instead of QP energies). This problem can be partly solved by averaging</span>
<span class="sd">                the interpolated values over the set of KS degenerate states.</span>
<span class="sd">                A negative value disables this ad-hoc symmetrization.</span>
<span class="sd">            vertices_names: Used to specify the k-path for the interpolated QP band structure</span>
<span class="sd">                when ``ks_ebands_kpath`` is None.</span>
<span class="sd">                It&#39;s a list of tuple, each tuple is of the form (kfrac_coords, kname) where</span>
<span class="sd">                kfrac_coords are the reduced coordinates of the k-point and kname is a string with the name of</span>
<span class="sd">                the k-point. Each point represents a vertex of the k-path. ``line_density`` defines</span>
<span class="sd">                the density of the sampling. If None, the k-path is automatically generated according</span>
<span class="sd">                to the point group of the system.</span>
<span class="sd">            line_density: Number of points in the smallest segment of the k-path. Used with ``vertices_names``.</span>
<span class="sd">            filter_params: TO BE DESCRIBED</span>
<span class="sd">            only_corrections: If True, the output contains the interpolated QP corrections instead of the QP energies.</span>
<span class="sd">                Available only if ks_ebands_kpath and/or ks_ebands_kmesh are used.</span>
<span class="sd">            verbose: Verbosity level</span>

<span class="sd">        Returns:</span>

<span class="sd">            :class:`namedtuple` with the following attributes::</span>

<span class="sd">                * qp_ebands_kpath: |ElectronBands| with the QP energies interpolated along the k-path.</span>
<span class="sd">                * qp_ebands_kmesh: |ElectronBands| with the QP energies interpolated on the k-mesh.</span>
<span class="sd">                    None if ``ks_ebands_kmesh`` is not passed.</span>
<span class="sd">                * ks_ebands_kpath: |ElectronBands| with the KS energies interpolated along the k-path.</span>
<span class="sd">                * ks_ebands_kmesh: |ElectronBands| with the KS energies on the k-mesh..</span>
<span class="sd">                    None if ``ks_ebands_kmesh`` is not passed.</span>
<span class="sd">                * interpolator: |SkwInterpolator| object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Consistency check.</span>
        <span class="n">errlines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">eapp</span> <span class="o">=</span> <span class="n">errlines</span><span class="o">.</span><span class="n">append</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gwkpoints</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ibz</span><span class="p">):</span>
            <span class="n">eapp</span><span class="p">(</span><span class="s2">&quot;QP energies should be computed for all k-points in the IBZ but nkibz != nkptgw&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gwkpoints</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">eapp</span><span class="p">(</span><span class="s2">&quot;QP Interpolation requires nkptgw &gt; 1.&quot;</span><span class="p">)</span>
        <span class="c1">#if (np.any(self.gwbstop_sk[0, 0] != self.gwbstop_sk):</span>
        <span class="c1">#    cprint(&quot;Highest bdgw band is not constant over k-points. QP Bands will be interpolated up to...&quot;)</span>
        <span class="c1">#if (np.any(self.gwbstart_sk[0, 0] != self.gwbstart_sk):</span>
        <span class="c1">#if (np.any(self.gwbstart_sk[0, 0] != 0):</span>
        <span class="k">if</span> <span class="n">errlines</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errlines</span><span class="p">))</span>

        <span class="c1"># Get symmetries from abinit spacegroup (read from file).</span>
        <span class="n">abispg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">abi_spacegroup</span>
        <span class="n">fm_symrel</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">afm</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">abispg</span><span class="o">.</span><span class="n">symrel</span><span class="p">,</span> <span class="n">abispg</span><span class="o">.</span><span class="n">symafm</span><span class="p">)</span> <span class="k">if</span> <span class="n">afm</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">ks_ebands_kpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Generate k-points for interpolation. Will interpolate all bands available in the sigres file.</span>
            <span class="n">bstart</span><span class="p">,</span> <span class="n">bstop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">vertices_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">vertices_names</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">,</span> <span class="n">k</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">hsym_kpoints</span><span class="p">]</span>
            <span class="n">kpath</span> <span class="o">=</span> <span class="n">Kpath</span><span class="o">.</span><span class="n">from_vertices_and_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">vertices_names</span><span class="p">,</span> <span class="n">line_density</span><span class="o">=</span><span class="n">line_density</span><span class="p">)</span>
            <span class="n">kfrac_coords</span><span class="p">,</span> <span class="n">knames</span> <span class="o">=</span> <span class="n">kpath</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">,</span> <span class="n">kpath</span><span class="o">.</span><span class="n">names</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use list of k-points from ks_ebands_kpath.</span>
            <span class="n">ks_ebands_kpath</span> <span class="o">=</span> <span class="n">ElectronBands</span><span class="o">.</span><span class="n">as_ebands</span><span class="p">(</span><span class="n">ks_ebands_kpath</span><span class="p">)</span>
            <span class="n">kfrac_coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">frac_coords</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ks_ebands_kpath</span><span class="o">.</span><span class="n">kpoints</span><span class="p">]</span>
            <span class="n">knames</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ks_ebands_kpath</span><span class="o">.</span><span class="n">kpoints</span><span class="p">]</span>

            <span class="c1"># Find the band range for the interpolation.</span>
            <span class="n">bstart</span><span class="p">,</span> <span class="n">bstop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ks_ebands_kpath</span><span class="o">.</span><span class="n">nband</span>
            <span class="n">bstop</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bstop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_gwbstop</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ks_ebands_kpath</span><span class="o">.</span><span class="n">nband</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_gwbstop</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Number of bands in KS band structure smaller than the number of bands in GW corrections&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Highest GW bands will be ignored&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">ks_ebands_kpath</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">is_path</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Energies in ks_ebands_kpath should be along a k-path!&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>

        <span class="c1"># Interpolate QP energies if ks_ebands_kpath is None else interpolate QP corrections</span>
        <span class="c1"># and re-apply them on top of the KS band structure.</span>
        <span class="n">gw_kcoords</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">frac_coords</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwkpoints</span><span class="p">]</span>

        <span class="c1"># Read GW energies from file (real part) and compute corrections if ks_ebands_kpath.</span>
        <span class="n">egw_rarr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;egw&quot;</span><span class="p">,</span> <span class="n">cmode</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
        <span class="k">if</span> <span class="n">ks_ebands_kpath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ks_ebands_kpath</span><span class="o">.</span><span class="n">structure</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;sigres.structure and ks_ebands_kpath.structures differ. Check your files!&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
            <span class="n">egw_rarr</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;e0&quot;</span><span class="p">)</span>

        <span class="c1"># Note there&#39;s no guarantee that the gwkpoints and the corrections have the same k-point index.</span>
        <span class="c1"># Be careful because the order of the k-points and the band range stored in the SIGRES file may differ ...</span>
        <span class="n">qpdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">egw_rarr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">gwk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwkpoints</span><span class="p">:</span>
            <span class="n">ik_ibz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">kpt2fileindex</span><span class="p">(</span><span class="n">gwk</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                <span class="n">qpdata</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik_ibz</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">egw_rarr</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik_ibz</span><span class="p">,</span> <span class="p">:]</span>

        <span class="c1"># Build interpolator for QP corrections.</span>
        <span class="kn">from</span> <span class="nn">abipy.core.skw</span> <span class="kn">import</span> <span class="n">SkwInterpolator</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">atomic_numbers</span><span class="p">)</span>
        <span class="n">qpdata</span> <span class="o">=</span> <span class="n">qpdata</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">bstart</span><span class="p">:</span><span class="n">bstop</span><span class="p">]</span>
        <span class="c1"># Old sigres files do not have kptopt.</span>
        <span class="n">has_timrev</span> <span class="o">=</span> <span class="n">has_timrev_from_kptopt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;kptopt&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">skw</span> <span class="o">=</span> <span class="n">SkwInterpolator</span><span class="p">(</span><span class="n">lpratio</span><span class="p">,</span> <span class="n">gw_kcoords</span><span class="p">,</span> <span class="n">qpdata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">fermie</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">nelect</span><span class="p">,</span>
                              <span class="n">cell</span><span class="p">,</span> <span class="n">fm_symrel</span><span class="p">,</span> <span class="n">has_timrev</span><span class="p">,</span>
                              <span class="n">filter_params</span><span class="o">=</span><span class="n">filter_params</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ks_ebands_kpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Interpolate QP energies.</span>
            <span class="n">eigens_kpath</span> <span class="o">=</span> <span class="n">skw</span><span class="o">.</span><span class="n">interp_kpts</span><span class="p">(</span><span class="n">kfrac_coords</span><span class="p">)</span><span class="o">.</span><span class="n">eigens</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Interpolate QP energies corrections and add them to KS.</span>
            <span class="n">ref_eigens</span> <span class="o">=</span> <span class="n">ks_ebands_kpath</span><span class="o">.</span><span class="n">eigens</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">bstart</span><span class="p">:</span><span class="n">bstop</span><span class="p">]</span>
            <span class="n">qp_corrs</span> <span class="o">=</span> <span class="n">skw</span><span class="o">.</span><span class="n">interp_kpts_and_enforce_degs</span><span class="p">(</span><span class="n">kfrac_coords</span><span class="p">,</span> <span class="n">ref_eigens</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">ks_degatol</span><span class="p">)</span><span class="o">.</span><span class="n">eigens</span>
            <span class="n">eigens_kpath</span> <span class="o">=</span> <span class="n">qp_corrs</span> <span class="k">if</span> <span class="n">only_corrections</span> <span class="k">else</span> <span class="n">ref_eigens</span> <span class="o">+</span> <span class="n">qp_corrs</span>

        <span class="c1"># Build new ebands object with k-path.</span>
        <span class="n">kpts_kpath</span> <span class="o">=</span> <span class="n">Kpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">,</span> <span class="n">kfrac_coords</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">knames</span><span class="p">)</span>
        <span class="n">occfacts_kpath</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eigens_kpath</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Finding the new Fermi level of the interpolated bands is not trivial, in particular if metallic.</span>
        <span class="c1"># because one should first interpolate the QP bands on a mesh. Here I align the QP bands</span>
        <span class="c1"># at the HOMO of the KS bands.</span>
        <span class="n">homos</span> <span class="o">=</span> <span class="n">ks_ebands_kpath</span><span class="o">.</span><span class="n">homos</span> <span class="k">if</span> <span class="n">ks_ebands_kpath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">homos</span>
        <span class="n">qp_fermie</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">eigens_kpath</span><span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">spin</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">kidx</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">band</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">homos</span><span class="p">])</span>
        <span class="c1">#qp_fermie = self.ebands.fermie</span>
        <span class="c1">#qp_fermie = 0.0</span>

        <span class="n">qp_ebands_kpath</span> <span class="o">=</span> <span class="n">ElectronBands</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">kpts_kpath</span><span class="p">,</span> <span class="n">eigens_kpath</span><span class="p">,</span> <span class="n">qp_fermie</span><span class="p">,</span> <span class="n">occfacts_kpath</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">nelect</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">nspinor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">nspden</span><span class="p">,</span>
                                        <span class="n">smearing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">smearing</span><span class="p">)</span>

        <span class="n">qp_ebands_kmesh</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">ks_ebands_kmesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Interpolate QP corrections on the same k-mesh as the one used in the KS run.</span>
            <span class="n">ks_ebands_kmesh</span> <span class="o">=</span> <span class="n">ElectronBands</span><span class="o">.</span><span class="n">as_ebands</span><span class="p">(</span><span class="n">ks_ebands_kmesh</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bstop</span> <span class="o">&gt;</span> <span class="n">ks_ebands_kmesh</span><span class="o">.</span><span class="n">nband</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not enough bands in ks_ebands_kmesh, found </span><span class="si">%s</span><span class="s2">, minimum expected </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">ks_ebands_kmesh</span><span class="o">.</span><span class="n">nband</span><span class="p">,</span> <span class="n">bstop</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">ks_ebands_kpath</span><span class="o">.</span><span class="n">structure</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;sigres.structure and ks_ebands_kpath.structures differ. Check your files!&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
                <span class="c1">#raise ValueError(&quot;sigres.structure and ks_ebands_kmesh.structures differ. Check your files!&quot;)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ks_ebands_kmesh</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">is_ibz</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Energies in ks_ebands_kmesh should be given in the IBZ&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>

            <span class="c1"># K-points and weight for DOS are taken from ks_ebands_kmesh</span>
            <span class="n">dos_kcoords</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">frac_coords</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ks_ebands_kmesh</span><span class="o">.</span><span class="n">kpoints</span><span class="p">]</span>
            <span class="n">dos_weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">weight</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ks_ebands_kmesh</span><span class="o">.</span><span class="n">kpoints</span><span class="p">]</span>

            <span class="c1"># Interpolate QP corrections from bstart to bstop</span>
            <span class="n">ref_eigens</span> <span class="o">=</span> <span class="n">ks_ebands_kmesh</span><span class="o">.</span><span class="n">eigens</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">bstart</span><span class="p">:</span><span class="n">bstop</span><span class="p">]</span>
            <span class="n">qp_corrs</span> <span class="o">=</span> <span class="n">skw</span><span class="o">.</span><span class="n">interp_kpts_and_enforce_degs</span><span class="p">(</span><span class="n">dos_kcoords</span><span class="p">,</span> <span class="n">ref_eigens</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">ks_degatol</span><span class="p">)</span><span class="o">.</span><span class="n">eigens</span>
            <span class="n">eigens_kmesh</span> <span class="o">=</span> <span class="n">qp_corrs</span> <span class="k">if</span> <span class="n">only_corrections</span> <span class="k">else</span> <span class="n">ref_eigens</span> <span class="o">+</span> <span class="n">qp_corrs</span>

            <span class="c1"># Build new ebands object with k-mesh</span>
            <span class="n">kpts_kmesh</span> <span class="o">=</span> <span class="n">IrredZone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">,</span> <span class="n">dos_kcoords</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">dos_weights</span><span class="p">,</span>
                                   <span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ksampling</span><span class="o">=</span><span class="n">ks_ebands_kmesh</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">ksampling</span><span class="p">)</span>
            <span class="n">occfacts_kmesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eigens_kmesh</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">qp_ebands_kmesh</span> <span class="o">=</span> <span class="n">ElectronBands</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">kpts_kmesh</span><span class="p">,</span> <span class="n">eigens_kmesh</span><span class="p">,</span> <span class="n">qp_fermie</span><span class="p">,</span> <span class="n">occfacts_kmesh</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">nelect</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">nspinor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">nspden</span><span class="p">,</span>
                                            <span class="n">smearing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">smearing</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dict2namedtuple</span><span class="p">(</span><span class="n">qp_ebands_kpath</span><span class="o">=</span><span class="n">qp_ebands_kpath</span><span class="p">,</span>
                               <span class="n">qp_ebands_kmesh</span><span class="o">=</span><span class="n">qp_ebands_kmesh</span><span class="p">,</span>
                               <span class="n">ks_ebands_kpath</span><span class="o">=</span><span class="n">ks_ebands_kpath</span><span class="p">,</span>
                               <span class="n">ks_ebands_kmesh</span><span class="o">=</span><span class="n">ks_ebands_kmesh</span><span class="p">,</span>
                               <span class="n">interpolator</span><span class="o">=</span><span class="n">skw</span><span class="p">,</span>
                               <span class="p">)</span></div>

<div class="viewcode-block" id="SigresFile.yield_figs"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresFile.yield_figs">[docs]</a>    <span class="k">def</span> <span class="nf">yield_figs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function *generates* a predefined list of matplotlib figures with minimal input from the user.</span>
<span class="sd">        Used in abiview.py to get a quick look at the results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_qpgaps</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_qps_vs_e0</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_qpbands_ibz</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_ksbands_with_qpmarkers</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_spectral_function</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_spectral_functions</span><span class="p">(</span><span class="n">include_bands</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="SigresFile.write_notebook"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresFile.write_notebook">[docs]</a>    <span class="k">def</span> <span class="nf">write_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a jupyter_ notebook to ``nbpath``. If nbpath is None, a temporay file in the current</span>
<span class="sd">        working directory is created. Return path to the notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbformat</span><span class="p">,</span> <span class="n">nbv</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nbformat_nbv_nb</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;sigres = abilab.abiopen(&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;print(sigres)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;sigres.plot_qps_vs_e0();&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;sigres.plot_spectral_functions(spin=0, kpoint=[0, 0, 0], bands=0);&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;#sigres.plot_ksbands_with_qpmarkers(qpattr=&#39;qpeme0&#39;, fact=100);&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;r = sigres.interpolate(ks_ebands_kpath=None, ks_ebands_kmesh=None); print(r.interpolator)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;r.qp_ebands_kpath.plot();&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">if r.ks_ebands_kpath is not None:</span>
<span class="s2">    plotter = abilab.ElectronBandsPlotter()</span>
<span class="s2">    plotter.add_ebands(&quot;KS&quot;, r.ks_ebands_kpath) # dos=r.ks_ebands_kmesh.get_edos())</span>
<span class="s2">    plotter.add_ebands(&quot;GW (interpolated)&quot;, r.qp_ebands_kpath) # dos=r.qp_ebands_kmesh.get_edos()))</span>
<span class="s2">    plotter.ipw_select_plot()&quot;&quot;&quot;</span><span class="p">),</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_nb_nbpath</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nbpath</span><span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">SigresReader</span><span class="p">(</span><span class="n">ETSF_Reader</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object provides method to read data from the SIGRES file produced ABINIT.</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: SigresReader</span>

<span class="sd">    # See 70gw/m_sigma_results.F90</span>

<span class="sd">    # Name of the diagonal matrix elements stored in the file.</span>
<span class="sd">    # b1gw:b2gw,nkibz,nsppol*nsig_ab))</span>
<span class="sd">    #_DIAGO_MELS = [</span>
<span class="sd">    #    &quot;sigxme&quot;,</span>
<span class="sd">    #    &quot;vxcme&quot;,</span>
<span class="sd">    #    &quot;vUme&quot;,</span>
<span class="sd">    #    &quot;dsigmee0&quot;,</span>
<span class="sd">    #    &quot;sigcmee0&quot;,</span>
<span class="sd">    #    &quot;sigxcme&quot;,</span>
<span class="sd">    #    &quot;ze0&quot;,</span>
<span class="sd">    #]</span>

<span class="sd">    integer :: b1gw,b2gw      ! min and Max gw band indeces over spin and k-points (used to dimension)</span>
<span class="sd">    integer :: gwcalctyp      ! Flag defining the calculation type.</span>
<span class="sd">    integer :: nkptgw         ! No. of points calculated</span>
<span class="sd">    integer :: nkibz          ! No. of irreducible k-points.</span>
<span class="sd">    integer :: nbnds          ! Total number of bands</span>
<span class="sd">    integer :: nomega_r       ! No. of real frequencies for the spectral function.</span>
<span class="sd">    integer :: nomega_i       ! No. of frequencies along the imaginary axis.</span>
<span class="sd">    integer :: nomega4sd      ! No. of real frequencies to evaluate the derivative of $\Sigma(E)$.</span>
<span class="sd">    integer :: nsig_ab        ! 1 if nspinor=1,4 for noncollinear case.</span>
<span class="sd">    integer :: nsppol         ! No. of spin polarizations.</span>
<span class="sd">    integer :: usepawu        ! 1 if we are using LDA+U as starting point (only for PAW)</span>

<span class="sd">    real(dp) :: deltae       ! Frequency step for the calculation of d\Sigma/dE</span>
<span class="sd">    real(dp) :: maxomega4sd  ! Max frequency around E_ks for d\Sigma/dE.</span>
<span class="sd">    real(dp) :: maxomega_r   ! Max frequency for spectral function.</span>
<span class="sd">    real(dp) :: scissor_ene  ! Scissor energy value. zero for None.</span>

<span class="sd">    integer,pointer :: maxbnd(:,:)</span>
<span class="sd">    ! maxbnd(nkptgw,nsppol)</span>
<span class="sd">    ! Max band index considered in GW for this k-point.</span>

<span class="sd">    integer,pointer :: minbnd(:,:)</span>
<span class="sd">    ! minbnd(nkptgw,nsppol)</span>
<span class="sd">    ! Min band index considered in GW for this k-point.</span>

<span class="sd">    real(dp),pointer :: degwgap(:,:)</span>
<span class="sd">    ! degwgap(nkibz,nsppol)</span>
<span class="sd">    ! Difference btw the QPState and the KS optical gap.</span>

<span class="sd">    real(dp),pointer :: egwgap(:,:)</span>
<span class="sd">    ! egwgap(nkibz,nsppol))</span>
<span class="sd">    ! QPState optical gap at each k-point and spin.</span>

<span class="sd">    real(dp),pointer :: en_qp_diago(:,:,:)</span>
<span class="sd">    ! en_qp_diago(nbnds,nkibz,nsppol))</span>
<span class="sd">    ! QPState energies obtained from the diagonalization of the Hermitian approximation to Sigma (QPSCGW)</span>

<span class="sd">    real(dp),pointer :: e0(:,:,:)</span>
<span class="sd">    ! e0(nbnds,nkibz,nsppol)</span>
<span class="sd">    ! KS eigenvalues for each band, k-point and spin. In case of self-consistent?</span>

<span class="sd">    real(dp),pointer :: e0gap(:,:)</span>
<span class="sd">    ! e0gap(nkibz,nsppol),</span>
<span class="sd">    ! KS gap at each k-point, for each spin.</span>

<span class="sd">    real(dp),pointer :: omega_r(:)</span>
<span class="sd">    ! omega_r(nomega_r)</span>
<span class="sd">    ! real frequencies used for the self energy.</span>

<span class="sd">    real(dp),pointer :: kptgw(:,:)</span>
<span class="sd">    ! kptgw(3,nkptgw)</span>
<span class="sd">    ! ! TODO there is a similar array in sigma_parameters</span>
<span class="sd">    ! List of calculated k-points.</span>

<span class="sd">    real(dp),pointer :: sigxme(:,:,:)</span>
<span class="sd">    ! sigxme(b1gw:b2gw,nkibz,nsppol*nsig_ab))</span>
<span class="sd">    ! Diagonal matrix elements of $\Sigma_x$ i.e $\&lt;nks|\Sigma_x|nks\&gt;$</span>

<span class="sd">    real(dp),pointer :: vxcme(:,:,:)</span>
<span class="sd">    ! vxcme(b1gw:b2gw,nkibz,nsppol*nsig_ab))</span>
<span class="sd">    ! $\&lt;nks|v_{xc}[n_val]|nks\&gt;$ matrix elements of vxc (valence-only contribution).</span>

<span class="sd">    real(dp),pointer :: vUme(:,:,:)</span>
<span class="sd">    ! vUme(b1gw:b2gw,nkibz,nsppol*nsig_ab))</span>
<span class="sd">    ! $\&lt;nks|v_{U}|nks\&gt;$ for LDA+U.</span>

<span class="sd">    complex(dpc),pointer :: degw(:,:,:)</span>
<span class="sd">    ! degw(b1gw:b2gw,nkibz,nsppol))</span>
<span class="sd">    ! Difference between the QPState and the KS energies.</span>

<span class="sd">    complex(dpc),pointer :: dsigmee0(:,:,:)</span>
<span class="sd">    ! dsigmee0(b1gw:b2gw,nkibz,nsppol*nsig_ab))</span>
<span class="sd">    ! Derivative of $\Sigma_c(E)$ calculated at the KS eigenvalue.</span>

<span class="sd">    complex(dpc),pointer :: egw(:,:,:)</span>
<span class="sd">    ! egw(nbnds,nkibz,nsppol))</span>
<span class="sd">    ! QPState energies, $\epsilon_{nks}^{QPState}$.</span>

<span class="sd">    complex(dpc),pointer :: eigvec_qp(:,:,:,:)</span>
<span class="sd">    ! eigvec_qp(nbnds,nbnds,nkibz,nsppol))</span>
<span class="sd">    ! Expansion of the QPState amplitude in the KS basis set.</span>

<span class="sd">    complex(dpc),pointer :: hhartree(:,:,:,:)</span>
<span class="sd">    ! hhartree(b1gw:b2gw,b1gw:b2gw,nkibz,nsppol*nsig_ab)</span>
<span class="sd">    ! $\&lt;nks|T+v_H+v_{loc}+v_{nl}|mks\&gt;$</span>

<span class="sd">    complex(dpc),pointer :: sigcme(:,:,:,:)</span>
<span class="sd">    ! sigcme(b1gw:b2gw,nkibz,nomega_r,nsppol*nsig_ab))</span>
<span class="sd">    ! $\&lt;nks|\Sigma_{c}(E)|nks\&gt;$ at each nomega_r frequency</span>

<span class="sd">    complex(dpc),pointer :: sigmee(:,:,:)</span>
<span class="sd">    ! sigmee(b1gw:b2gw,nkibz,nsppol*nsig_ab))</span>
<span class="sd">    ! $\Sigma_{xc}E_{KS} + (E_{QPState}- E_{KS})*dSigma/dE_KS</span>

<span class="sd">    complex(dpc),pointer :: sigcmee0(:,:,:)</span>
<span class="sd">    ! sigcmee0(b1gw:b2gw,nkibz,nsppol*nsig_ab))</span>
<span class="sd">    ! Diagonal mat. elements of $\Sigma_c(E)$ calculated at the KS energy $E_{KS}$</span>

<span class="sd">    complex(dpc),pointer :: sigcmesi(:,:,:,:)</span>
<span class="sd">    ! sigcmesi(b1gw:b2gw,nkibz,nomega_i,nsppol*nsig_ab))</span>
<span class="sd">    ! Matrix elements of $\Sigma_c$ along the imaginary axis.</span>
<span class="sd">    ! Only used in case of analytical continuation.</span>

<span class="sd">    complex(dpc),pointer :: sigcme4sd(:,:,:,:)</span>
<span class="sd">    ! sigcme4sd(b1gw:b2gw,nkibz,nomega4sd,nsppol*nsig_ab))</span>
<span class="sd">    ! Diagonal matrix elements of \Sigma_c around the zeroth order eigenvalue (usually KS).</span>

<span class="sd">    complex(dpc),pointer :: sigxcme(:,:,:,:)</span>
<span class="sd">    ! sigxme(b1gw:b2gw,nkibz,nomega_r,nsppol*nsig_ab))</span>
<span class="sd">    ! $\&lt;nks|\Sigma_{xc}(E)|nks\&gt;$ at each real frequency frequency.</span>

<span class="sd">    complex(dpc),pointer :: sigxcmesi(:,:,:,:)</span>
<span class="sd">    ! sigxcmesi(b1gw:b2gw,nkibz,nomega_i,nsppol*nsig_ab))</span>
<span class="sd">    ! Matrix elements of $\Sigma_{xc}$ along the imaginary axis.</span>
<span class="sd">    ! Only used in case of analytical continuation.</span>

<span class="sd">    complex(dpc),pointer :: sigxcme4sd(:,:,:,:)</span>
<span class="sd">    ! sigxcme4sd(b1gw:b2gw,nkibz,nomega4sd,nsppol*nsig_ab))</span>
<span class="sd">    ! Diagonal matrix elements of \Sigma_xc for frequencies around the zeroth order eigenvalues.</span>

<span class="sd">    complex(dpc),pointer :: ze0(:,:,:)</span>
<span class="sd">    ! ze0(b1gw:b2gw,nkibz,nsppol))</span>
<span class="sd">    ! renormalization factor. $(1-\dfrac{\partial\Sigma_c} {\partial E_{KS}})^{-1}$</span>

<span class="sd">    complex(dpc),pointer :: omega_i(:)</span>
<span class="sd">    ! omegasi(nomega_i)</span>
<span class="sd">    ! Frequencies along the imaginary axis used for the analytical continuation.</span>

<span class="sd">    complex(dpc),pointer :: omega4sd(:,:,:,:)</span>
<span class="sd">    ! omega4sd(b1gw:b2gw,nkibz,nomega4sd,nsppol).</span>
<span class="sd">    ! Frequencies used to evaluate the Derivative of Sigma.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ks_bands</span> <span class="o">=</span> <span class="n">ElectronBands</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ks_bands</span><span class="o">.</span><span class="n">nsppol</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nomega_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_dimvalue</span><span class="p">(</span><span class="s2">&quot;nomega_r&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nomega_r</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">#self.nomega_i = self.read_dim(&quot;nomega_i&quot;)</span>

        <span class="c1"># Save important quantities needed to simplify the API.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_structure</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gwcalctyp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;gwcalctyp&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">usepawu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;usepawu&quot;</span><span class="p">)</span>

        <span class="c1"># 1) The K-points of the homogeneous mesh.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ibz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ks_bands</span><span class="o">.</span><span class="n">kpoints</span>

        <span class="c1"># 2) The K-points where QPState corrections have been calculated.</span>
        <span class="n">gwred_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_redc_gwkpoints</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gwkpoints</span> <span class="o">=</span> <span class="n">KpointList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">,</span> <span class="n">gwred_coords</span><span class="p">)</span>
        <span class="c1"># Find k-point name</span>
        <span class="k">for</span> <span class="n">kpoint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwkpoints</span><span class="p">:</span>
            <span class="n">kpoint</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">findname_in_hsym_stars</span><span class="p">(</span><span class="n">kpoint</span><span class="p">))</span>

        <span class="c1"># minbnd[nkptgw,nsppol] gives the minimum band index computed</span>
        <span class="c1"># Note conversion between Fortran and python convention.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gwbstart_sk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;minbnd&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gwbstop_sk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;maxbnd&quot;</span><span class="p">)</span>
        <span class="c1"># min and Max band index for GW corrections.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_gwbstart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gwbstart_sk</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_gwbstart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gwbstart_sk</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">min_gwbstop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gwbstop_sk</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_gwbstop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gwbstop_sk</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_egw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;egw&quot;</span><span class="p">,</span> <span class="n">cmode</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>

        <span class="c1"># Read and save important matrix elements.</span>
        <span class="c1"># All these arrays are dimensioned</span>
        <span class="c1"># vxcme(b1gw:b2gw,nkibz,nsppol*nsig_ab))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vxcme</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;vxcme&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sigxme</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;sigxme&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hhartree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;hhartree&quot;</span><span class="p">,</span> <span class="n">cmode</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vUme</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;vUme&quot;</span><span class="p">)</span>
        <span class="c1">#if self.usepawu == 0: self._vUme.fill(0.0)</span>

        <span class="c1"># Complex arrays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sigcmee0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;sigcmee0&quot;</span><span class="p">,</span> <span class="n">cmode</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ze0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;ze0&quot;</span><span class="p">,</span> <span class="n">cmode</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>

        <span class="c1"># Frequencies for the spectral function.</span>
        <span class="c1"># Note that omega_r does not depend on (s, k, b).</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_spfunc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_omega_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;omega_r&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sigcme</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;sigcme&quot;</span><span class="p">,</span> <span class="n">cmode</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sigxcme</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;sigxcme&quot;</span><span class="p">,</span> <span class="n">cmode</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>

        <span class="c1"># Self-consistent case</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_en_qp_diago</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;en_qp_diago&quot;</span><span class="p">)</span>
        <span class="c1"># &lt;KS|QPState&gt;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eigvec_qp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;eigvec_qp&quot;</span><span class="p">,</span> <span class="n">cmode</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>

        <span class="c1">#self._mlda_to_qp</span>

    <span class="c1">#def is_selfconsistent(self, mode):</span>
    <span class="c1">#    return self.gwcalctyp</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_spfunc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if self contains the spectral function.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nomega_r</span>

    <span class="k">def</span> <span class="nf">kpt2fileindex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function that returns the index of kpoint in the netcdf file.</span>
<span class="sd">        Accepts |Kpoint| instance or integer</span>

<span class="sd">        Raise:</span>
<span class="sd">            `KpointsError` if kpoint cannot be found.</span>

<span class="sd">        .. note::</span>

<span class="sd">            This function is needed since arrays in the netcdf file are dimensioned</span>
<span class="sd">            with the total number of k-points in the IBZ.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">duck</span><span class="o">.</span><span class="n">is_intlike</span><span class="p">(</span><span class="n">kpoint</span><span class="p">):</span> <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibz</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">gwkpt2seqindex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gwkpoint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function returns the index of the GW k-point in (0:nkptgw)</span>
<span class="sd">        Used to access data in the arrays that are dimensioned [0:nkptgw] e.g. minbnd.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">duck</span><span class="o">.</span><span class="n">is_intlike</span><span class="p">(</span><span class="n">gwkpoint</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">gwkpoint</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwkpoints</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">gwkpoint</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_redc_gwkpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;kptgw&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_allqps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore_imag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return list with ``nsppol`` items. Each item is a :class:`QPList` with the QP results</span>

<span class="sd">        Args:</span>
<span class="sd">            ignore_imag: Only real part is returned if ``ignore_imag``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qps_spin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">*</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
            <span class="n">qps</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">gwkpoint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwkpoints</span><span class="p">:</span>
                <span class="n">ik</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwkpt2seqindex</span><span class="p">(</span><span class="n">gwkpoint</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gwbstart_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwbstop_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik</span><span class="p">]):</span>
                    <span class="n">qps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_qp</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">gwkpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">ignore_imag</span><span class="o">=</span><span class="n">ignore_imag</span><span class="p">))</span>

            <span class="n">qps_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span> <span class="o">=</span> <span class="n">QPList</span><span class="p">(</span><span class="n">qps</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">qps_spin</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_qplist_sk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">ignore_imag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read and return :class:`QPList` object for the given spin, kpoint.</span>

<span class="sd">        Args:</span>
<span class="sd">            ignore_imag: Only real part is returned if ``ignore_imag``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ik</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwkpt2seqindex</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span>
        <span class="n">bstart</span><span class="p">,</span> <span class="n">bstop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwbstart_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwbstop_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">QPList</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">read_qp</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">ignore_imag</span><span class="o">=</span><span class="n">ignore_imag</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bstart</span><span class="p">,</span> <span class="n">bstop</span><span class="p">)])</span>

    <span class="c1">#def read_qpene(self, spin, kpoint, band)</span>

    <span class="k">def</span> <span class="nf">read_qpenes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_egw</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span>

    <span class="k">def</span> <span class="nf">read_qp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">ignore_imag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return :class`QPState` for the given (spin, kpoint, band).</span>
<span class="sd">        Only real part is returned if ``ignore_imag``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ik_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpt2fileindex</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span>
        <span class="c1"># Must shift band index (see fortran code that allocates with mdbgw)</span>
        <span class="n">ib_gw</span> <span class="o">=</span> <span class="n">band</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_gwbstart</span>

        <span class="k">def</span> <span class="nf">ri</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">if</span> <span class="n">ignore_imag</span> <span class="k">else</span> <span class="n">a</span>

        <span class="k">return</span> <span class="n">QPState</span><span class="p">(</span>
            <span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span>
            <span class="n">kpoint</span><span class="o">=</span><span class="n">kpoint</span><span class="p">,</span>
            <span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">,</span>
            <span class="n">e0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_e0</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik_file</span><span class="p">,</span> <span class="n">band</span><span class="p">),</span>
            <span class="n">qpe</span><span class="o">=</span><span class="n">ri</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_egw</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik_file</span><span class="p">,</span> <span class="n">band</span><span class="p">]),</span>
            <span class="n">qpe_diago</span><span class="o">=</span><span class="n">ri</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_en_qp_diago</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik_file</span><span class="p">,</span> <span class="n">band</span><span class="p">]),</span>
            <span class="c1"># Note ib_gw index.</span>
            <span class="n">vxcme</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_vxcme</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik_file</span><span class="p">,</span> <span class="n">ib_gw</span><span class="p">],</span>
            <span class="n">sigxme</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_sigxme</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik_file</span><span class="p">,</span> <span class="n">ib_gw</span><span class="p">],</span>
            <span class="n">sigcmee0</span><span class="o">=</span><span class="n">ri</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sigcmee0</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik_file</span><span class="p">,</span> <span class="n">ib_gw</span><span class="p">]),</span>
            <span class="n">vUme</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_vUme</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik_file</span><span class="p">,</span> <span class="n">ib_gw</span><span class="p">],</span>
            <span class="n">ze0</span><span class="o">=</span><span class="n">ri</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ze0</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik_file</span><span class="p">,</span> <span class="n">ib_gw</span><span class="p">]),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_qpgaps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read the QP gaps. Returns [nsppol, nkibz] array with QP gaps in eV.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;egwgap&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_ksgaps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read the KS gaps. Returns [nsppol, nkibz] array with KS gaps in eV.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;e0gap&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_e0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kfile</span><span class="p">,</span> <span class="n">band</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ks_bands</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">kfile</span><span class="p">,</span> <span class="n">band</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">read_sigmaw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the real and the imaginary part of the self energy.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_spfunc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> does not contain spectral function data.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="n">ik</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpt2fileindex</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span>
        <span class="c1"># Must shift band index (see fortran code that allocates with mdbgw)</span>
        <span class="n">ib_gw</span> <span class="o">=</span> <span class="n">band</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_gwbstart</span>
        <span class="c1">#ib_gw = band - self.gwbstart_sk[spin, self.gwkpt2seqindex(kpoint)]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_omega_r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigxcme</span><span class="p">[</span><span class="n">spin</span><span class="p">,:,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">ib_gw</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">read_spfunc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the spectral function.</span>

<span class="sd">         one/pi * ABS(AIMAG(Sr%sigcme(ib,ikibz,io,is))) /</span>
<span class="sd">         ( (REAL(Sr%omega_r(io)-Sr%hhartree(ib,ib,ikibz,is)-Sr%sigxcme(ib,ikibz,io,is)))**2 &amp;</span>
<span class="sd">        +(AIMAG(Sr%sigcme(ib,ikibz,io,is)))**2) / Ha_eV,&amp;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_spfunc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> does not contain spectral function data&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="n">ik</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpt2fileindex</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span>
        <span class="c1"># Must shift band index (see fortran code that allocates with mdbgw)</span>
        <span class="n">ib_gw</span> <span class="o">=</span> <span class="n">band</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_gwbstart</span>
        <span class="c1">#ib_gw = band - self.gwbstart_sk[spin, self.gwkpt2seqindex(kpoint)]</span>

        <span class="n">aim_sigc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sigcme</span><span class="p">[</span><span class="n">spin</span><span class="p">,:,</span><span class="n">ik</span><span class="p">,</span><span class="n">ib_gw</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span>
        <span class="n">den</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nomega_r</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">io</span><span class="p">,</span> <span class="n">omega</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_omega_r</span><span class="p">):</span>
            <span class="n">den</span><span class="p">[</span><span class="n">io</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">omega</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hhartree</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">ik</span><span class="p">,</span><span class="n">ib_gw</span><span class="p">,</span><span class="n">ib_gw</span><span class="p">]</span><span class="o">.</span><span class="n">real</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigxcme</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">io</span><span class="p">,</span><span class="n">ik</span><span class="p">,</span><span class="n">ib_gw</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_sigcme</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">io</span><span class="p">,</span><span class="n">ik</span><span class="p">,</span><span class="n">ib_gw</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_omega_r</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">aim_sigc</span><span class="o">/</span><span class="n">den</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_eigvec_qp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns &lt;KS|QPState&gt; for the given spin, kpoint and band.</span>
<span class="sd">        If band is None, &lt;KS_b|QP_{b&#39;}&gt; is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ik</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpt2fileindex</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eigvec_qp</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="p">:,</span> <span class="n">band</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eigvec_qp</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

    <span class="k">def</span> <span class="nf">read_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the parameters of the calculation.</span>
<span class="sd">        Returns: OrderedDict with the value of the parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">param_names</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;ecutwfn&quot;</span><span class="p">,</span> <span class="s2">&quot;ecuteps&quot;</span><span class="p">,</span> <span class="s2">&quot;ecutsigx&quot;</span><span class="p">,</span> <span class="s2">&quot;scr_nband&quot;</span><span class="p">,</span> <span class="s2">&quot;sigma_nband&quot;</span><span class="p">,</span>
            <span class="s2">&quot;gwcalctyp&quot;</span><span class="p">,</span> <span class="s2">&quot;scissor_ene&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="c1"># Read data and convert to scalar to avoid problems with pandas dataframes.</span>
        <span class="c1"># Old sigres files may not have all the metadata.</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">pname</span> <span class="ow">in</span> <span class="n">param_names</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="n">pname</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

        <span class="c1"># Other quantities that might be subject to convergence studies.</span>
        <span class="c1">#params[&quot;nkibz&quot;] = len(self.ibz)</span>

        <span class="k">return</span> <span class="n">params</span>

    <span class="c1">#def read_mlda_to_qp(self, spin, kpoint, band=None):</span>
    <span class="c1">#    &quot;&quot;&quot;Returns the unitary transformation KS --&gt; QPS&quot;&quot;&quot;</span>
    <span class="c1">#    ik = self.kpt2fileindex(kpoint)</span>
    <span class="c1">#    if band is not None:</span>
    <span class="c1">#        return self._mlda_to_qp[spin,ik,:,band]</span>
    <span class="c1">#    else:</span>
    <span class="c1">#        return self._mlda_to_qp[spin,ik,:,:]</span>

    <span class="c1">#def read_qprhor(self):</span>
    <span class="c1">#    &quot;&quot;&quot;Returns the QPState density in real space.&quot;&quot;&quot;</span>


<div class="viewcode-block" id="SigresRobot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresRobot">[docs]</a><span class="k">class</span> <span class="nc">SigresRobot</span><span class="p">(</span><span class="n">Robot</span><span class="p">,</span> <span class="n">RobotWithEbands</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This robot analyzes the results contained in multiple SIGRES.nc files.</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: SigresRobot</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Try to have API similar to SigEPhRobot</span>
    <span class="n">EXT</span> <span class="o">=</span> <span class="s2">&quot;SIGRES&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="k">return</span>

        <span class="c1"># TODO</span>
        <span class="c1"># Check dimensions and self-energy states and issue warning.</span>
        <span class="n">warns</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">wapp</span> <span class="o">=</span> <span class="n">warns</span><span class="o">.</span><span class="n">append</span>
        <span class="n">nc0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">same_nsppol</span><span class="p">,</span> <span class="n">same_nkcalc</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">nc</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">!=</span> <span class="n">nc0</span><span class="o">.</span><span class="n">nsppol</span> <span class="k">for</span> <span class="n">nc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">):</span>
            <span class="n">same_nsppol</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">wapp</span><span class="p">(</span><span class="s2">&quot;Comparing ncfiles with different values of nsppol.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">nc</span><span class="o">.</span><span class="n">nkcalc</span> <span class="o">!=</span> <span class="n">nc0</span><span class="o">.</span><span class="n">nkcalc</span> <span class="k">for</span> <span class="n">nc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">):</span>
            <span class="n">same_nkcalc</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">wapp</span><span class="p">(</span><span class="s2">&quot;Comparing ncfiles with different number of k-points in self-energy. Doh!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">same_nsppol</span> <span class="ow">and</span> <span class="n">same_nkcalc</span><span class="p">:</span>
            <span class="c1"># FIXME</span>
            <span class="c1"># Different values of bstart_ks are difficult to handle</span>
            <span class="c1"># Because the high-level API assumes an absolute global index</span>
            <span class="c1"># Should decide how to treat this case: either raise or interpret band as an absolute band index.</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">nc</span><span class="o">.</span><span class="n">gwbstart_sk</span> <span class="o">!=</span> <span class="n">nc0</span><span class="o">.</span><span class="n">gwbstart_sk</span><span class="p">)</span> <span class="k">for</span> <span class="n">nc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">):</span>
                <span class="n">wapp</span><span class="p">(</span><span class="s2">&quot;Comparing ncfiles with different values of gwbstart_sk&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">nc</span><span class="o">.</span><span class="n">gwbstop_sk</span> <span class="o">!=</span> <span class="n">nc0</span><span class="o">.</span><span class="n">gwbstop_sk</span><span class="p">)</span> <span class="k">for</span> <span class="n">nc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">):</span>
                <span class="n">wapp</span><span class="p">(</span><span class="s2">&quot;Comparing ncfiles with different values of gwbstop_sk&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">warns</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">warns</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;yellow&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_dims_and_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test that nsppol, sigma_kpoints, tlist are consistent.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="n">nc0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">eapp</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">append</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">nc</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">!=</span> <span class="n">nc0</span><span class="o">.</span><span class="n">nsppol</span> <span class="k">for</span> <span class="n">nc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="n">eapp</span><span class="p">(</span><span class="s2">&quot;Files with different values of `nsppol`&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">nc</span><span class="o">.</span><span class="n">nkcalc</span> <span class="o">!=</span> <span class="n">nc0</span><span class="o">.</span><span class="n">nkcalc</span> <span class="k">for</span> <span class="n">nc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="n">eapp</span><span class="p">(</span><span class="s2">&quot;Files with different values of `nkcalc`&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">nc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="k">for</span> <span class="n">k0</span><span class="p">,</span> <span class="n">k1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">nc0</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">,</span> <span class="n">nc</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">k0</span> <span class="o">!=</span> <span class="n">k1</span><span class="p">:</span>
                        <span class="n">eapp</span><span class="p">(</span><span class="s2">&quot;Files with different values of `sigma_kpoints`&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot compare multiple SIGRES.nc files. Reason:</span><span class="se">\n</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">))</span>

<div class="viewcode-block" id="SigresRobot.merge_dataframes_sk"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresRobot.merge_dataframes_sk">[docs]</a>    <span class="k">def</span> <span class="nf">merge_dataframes_sk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">sigr</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">sigr</span><span class="o">.</span><span class="n">get_dataframe_sk</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">table</span> <span class="o">=</span> <span class="n">frame</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">table</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">table</span></div>

<div class="viewcode-block" id="SigresRobot.get_qpgaps_dataframe"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresRobot.get_qpgaps_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">get_qpgaps_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_geo</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">abspath</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">funcs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a |pandas-DataFrame| with the QP gaps for all files in the robot.</span>

<span class="sd">        Args:</span>
<span class="sd">            spin: Spin index.</span>
<span class="sd">            kpoint</span>
<span class="sd">            with_geo: True if structure info should be added to the dataframe</span>
<span class="sd">            abspath: True if paths in index should be absolute. Default: Relative to getcwd().</span>
<span class="sd">            funcs: Function or list of functions to execute to add more data to the DataFrame.</span>
<span class="sd">                Each function receives a |SigresFile| object and returns a tuple (key, value)</span>
<span class="sd">                where key is a string with the name of column and value is the value to be inserted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Ideally one should select the k-point for which we have the fundamental gap for the given spin</span>
        <span class="c1"># TODO: In principle the SIGRES might have different k-points</span>
        <span class="k">if</span> <span class="n">spin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">spin</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">kpoint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">kpoint</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;nsppol&quot;</span><span class="p">,</span>
            <span class="c1">#&quot;nspinor&quot;, &quot;nspden&quot;, #&quot;ecut&quot;, &quot;pawecutdg&quot;,</span>
            <span class="c1">#&quot;tsmear&quot;, &quot;nkibz&quot;,</span>
        <span class="p">]</span> <span class="o">+</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;attrs&quot;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="n">rows</span><span class="p">,</span> <span class="n">row_names</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">sigres</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">row_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">aname</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">aname</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sigres</span><span class="p">,</span> <span class="n">aname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="n">qpgap</span> <span class="o">=</span> <span class="n">sigres</span><span class="o">.</span><span class="n">get_qpgap</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">)</span>
            <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;qpgap&quot;</span><span class="p">:</span> <span class="n">qpgap</span><span class="p">})</span>

            <span class="c1"># Add convergence parameters</span>
            <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sigres</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

            <span class="c1"># Add info on structure.</span>
            <span class="k">if</span> <span class="n">with_geo</span><span class="p">:</span>
                <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sigres</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">get_dict4pandas</span><span class="p">(</span><span class="n">with_spglib</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

            <span class="c1"># Execute functions.</span>
            <span class="k">if</span> <span class="n">funcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exec_funcs</span><span class="p">(</span><span class="n">funcs</span><span class="p">,</span> <span class="n">sigres</span><span class="p">))</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="n">row_names</span> <span class="o">=</span> <span class="n">row_names</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">abspath</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_relpaths</span><span class="p">(</span><span class="n">row_names</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">row_names</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span></div>

    <span class="c1"># An alias to have a common API for robots.</span>
    <span class="n">get_dataframe</span> <span class="o">=</span> <span class="n">get_qpgaps_dataframe</span>

<div class="viewcode-block" id="SigresRobot.plot_qpgaps_convergence"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresRobot.plot_qpgaps_convergence">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_qpgaps_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_qpmks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the convergence of the direct QP gaps for all the k-points available in the robot.</span>

<span class="sd">        Args:</span>
<span class="sd">            plot_qpmks: If False, plot QP_gap, KS_gap else (QP_gap - KS_gap)</span>
<span class="sd">            sortby: Define the convergence parameter, sort files and produce plot labels.</span>
<span class="sd">                Can be None, string or function. If None, no sorting is performed.</span>
<span class="sd">                If string and not empty it&#39;s assumed that the abifile has an attribute</span>
<span class="sd">                with the same name and `getattr` is invoked.</span>
<span class="sd">                If callable, the output of sortby(abifile) is used.</span>
<span class="sd">            hue: Variable that define subsets of the data, which will be drawn on separate lines.</span>
<span class="sd">                Accepts callable or string</span>
<span class="sd">                If string, it&#39;s assumed that the abifile has an attribute with the same name and getattr is invoked.</span>
<span class="sd">                If callable, the output of hue(abifile) is used.</span>
<span class="sd">            sharey: True if y-axis should be shared.</span>
<span class="sd">            fontsize: legend and label fontsize.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make sure that nsppol, sigma_kpoints are consistent.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_dims_and_params</span><span class="p">()</span>

        <span class="n">nc0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nsppol</span><span class="p">,</span> <span class="n">sigma_kpoints</span> <span class="o">=</span> <span class="n">nc0</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="n">nc0</span><span class="o">.</span><span class="n">sigma_kpoints</span>
        <span class="c1"># Build grid with (nkpt, 1) plots.</span>
        <span class="n">ncols</span><span class="p">,</span> <span class="n">nrows</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sigma_kpoints</span><span class="p">)</span>
        <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                                <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">sharey</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax_list</span> <span class="o">=</span> <span class="n">ax_list</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">labels</span><span class="p">,</span> <span class="n">ncfiles</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="n">sortby</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_and_sortby</span><span class="p">(</span><span class="n">hue</span><span class="p">,</span> <span class="n">sortby</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ik</span><span class="p">,</span> <span class="p">(</span><span class="n">kgw</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sigma_kpoints</span><span class="p">,</span> <span class="n">ax_list</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsppol</span><span class="p">):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;QP dirgap k:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">kgw</span><span class="p">)),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

                <span class="c1"># Extract QP dirgap for [spin, kgw, itemp]</span>
                <span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">qp_gaps</span><span class="p">,</span> <span class="n">ks_gaps</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">ncfile</span><span class="o">.</span><span class="n">get_qpgap</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kgw</span><span class="p">,</span> <span class="n">with_ksgap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">ncfile</span> <span class="ow">in</span> <span class="n">ncfiles</span><span class="p">]))</span>
                    <span class="n">yvals</span> <span class="o">=</span> <span class="n">qp_gaps</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">plot_qpmks</span> <span class="k">else</span> <span class="n">qp_gaps</span> <span class="o">-</span> <span class="n">ks_gaps</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_string</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">yvals</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">nc0</span><span class="o">.</span><span class="n">marker_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Must handle list of strings in a different way.</span>
                        <span class="n">xn</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xn</span><span class="p">,</span> <span class="n">yvals</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">nc0</span><span class="o">.</span><span class="n">marker_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">])</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xn</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                        <span class="n">qp_gaps</span><span class="p">,</span> <span class="n">ks_gaps</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">ncfile</span><span class="o">.</span><span class="n">get_qpgap</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kgw</span><span class="p">,</span> <span class="n">with_ksgap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">ncfile</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">abifiles</span><span class="p">]))</span>
                        <span class="n">yvals</span> <span class="o">=</span> <span class="n">qp_gaps</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">plot_qpmks</span> <span class="k">else</span> <span class="n">qp_gaps</span> <span class="o">-</span> <span class="n">ks_gaps</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_label</span><span class="p">(</span><span class="n">hue</span><span class="p">),</span> <span class="n">g</span><span class="o">.</span><span class="n">hvalue</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">xvalues</span><span class="p">,</span> <span class="n">qp_gaps</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">nc0</span><span class="o">.</span><span class="n">marker_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ik</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">sigma_kpoints</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_label</span><span class="p">(</span><span class="n">sortby</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">sortby</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">rotate_ticklabels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ik</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">plot_qpmks</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;QP-KS direct gap (eV)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;QP direct gap (eV)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="SigresRobot.plot_qpdata_conv_skb"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresRobot.plot_qpdata_conv_skb">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_qpdata_conv_skb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For each file in the robot, plot the convergence of the QP results for given (spin, kpoint, band)</span>

<span class="sd">        Args:</span>
<span class="sd">            spin: Spin index.</span>
<span class="sd">            kpoint: K-point in self-energy. Accepts |Kpoint|, vector or index.</span>
<span class="sd">            band: Band index.</span>
<span class="sd">            sortby: Define the convergence parameter, sort files and produce plot labels.</span>
<span class="sd">                Can be None, string or function. If None, no sorting is performed.</span>
<span class="sd">                If string and not empty it&#39;s assumed that the abifile has an attribute</span>
<span class="sd">                with the same name and `getattr` is invoked.</span>
<span class="sd">                If callable, the output of sortby(abifile) is used.</span>
<span class="sd">            hue: Variable that define subsets of the data, which will be drawn on separate lines.</span>
<span class="sd">                Accepts callable or string</span>
<span class="sd">                If string, it&#39;s assumed that the abifile has an attribute with the same name and getattr is invoked.</span>
<span class="sd">                If callable, the output of hue(abifile) is used.</span>
<span class="sd">            what_list: List of strings selecting the quantity to plot.</span>
<span class="sd">            fontsize: legend and label fontsize.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make sure that nsppol and sigma_kpoints are consistent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_dims_and_params</span><span class="p">()</span>

        <span class="c1"># TODO: Add more quantities DW, Fan(0)</span>
        <span class="c1"># TODO: Decide how to treat complex quantities, avoid annoying ComplexWarning</span>
        <span class="c1"># TODO: Format for g.hvalue</span>
        <span class="c1"># Treat fundamental gaps</span>
        <span class="c1"># Quantities to plot.</span>
        <span class="n">what_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;re_qpe&quot;</span><span class="p">,</span> <span class="s2">&quot;imag_qpe&quot;</span><span class="p">,</span> <span class="s2">&quot;ze0&quot;</span><span class="p">]</span>

        <span class="c1"># Build grid plot.</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">what_list</span><span class="p">),</span> <span class="mi">1</span>
        <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                                <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax_list</span> <span class="o">=</span> <span class="n">ax_list</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="n">nc0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ik</span> <span class="o">=</span> <span class="n">nc0</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">gwkpt2seqindex</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span>
        <span class="n">kpoint</span> <span class="o">=</span> <span class="n">nc0</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span>

        <span class="c1"># Sort and read QP data.</span>
        <span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">labels</span><span class="p">,</span> <span class="n">ncfiles</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="n">sortby</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">qplist</span> <span class="o">=</span> <span class="p">[</span><span class="n">ncfile</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_qp</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">)</span> <span class="k">for</span> <span class="n">ncfile</span> <span class="ow">in</span> <span class="n">ncfiles</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_and_sortby</span><span class="p">(</span><span class="n">hue</span><span class="p">,</span> <span class="n">sortby</span><span class="p">)</span>
            <span class="n">qplist_group</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">ncfile</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_qp</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">)</span> <span class="k">for</span> <span class="n">ncfile</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">abifiles</span><span class="p">]</span>
                <span class="n">qplist_group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ax_list</span><span class="p">,</span> <span class="n">what_list</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Extract QP data.</span>
                <span class="n">yvals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span> <span class="k">for</span> <span class="n">qp</span> <span class="ow">in</span> <span class="n">qplist</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_string</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">yvals</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">nc0</span><span class="o">.</span><span class="n">marker_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Must handle list of strings in a different way.</span>
                    <span class="n">xn</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xn</span><span class="p">,</span> <span class="n">yvals</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">nc0</span><span class="o">.</span><span class="n">marker_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">])</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xn</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">qplist</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="n">qplist_group</span><span class="p">):</span>
                    <span class="c1"># Extract QP data.</span>
                    <span class="n">yvals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span> <span class="k">for</span> <span class="n">qp</span> <span class="ow">in</span> <span class="n">qplist</span><span class="p">]</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_label</span><span class="p">(</span><span class="n">hue</span><span class="p">),</span> <span class="n">g</span><span class="o">.</span><span class="n">hvalue</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">xvalues</span><span class="p">,</span> <span class="n">yvals</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">nc0</span><span class="o">.</span><span class="n">marker_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">what</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">what_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_label</span><span class="p">(</span><span class="n">sortby</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">sortby</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">rotate_ticklabels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">hue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;title&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;QP results spin: </span><span class="si">%s</span><span class="s2">, k:</span><span class="si">%s</span><span class="s2">, band: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">kpoint</span><span class="p">),</span> <span class="n">band</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="SigresRobot.plot_qpfield_vs_e0"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresRobot.plot_qpfield_vs_e0">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_qpfield_vs_e0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                           <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For each file in the robot, plot one of the attributes of :class:`QpState`</span>
<span class="sd">        as a function of the KS energy.</span>

<span class="sd">        Args:</span>
<span class="sd">            field (str): String defining the attribute to plot.</span>
<span class="sd">            sharey: True if y-axis should be shared.</span>

<span class="sd">        .. note::</span>

<span class="sd">            For the meaning of the other arguments, see other robot methods.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax_list</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">lnp_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="n">sortby</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lnp_list</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">sortby</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_label</span><span class="p">(</span><span class="n">sortby</span><span class="p">),</span> <span class="n">param</span><span class="p">)</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">plot_qps_vs_e0</span><span class="p">(</span><span class="n">with_fields</span><span class="o">=</span><span class="n">list_strings</span><span class="p">(</span><span class="n">field</span><span class="p">),</span>
                    <span class="n">e0</span><span class="o">=</span><span class="n">e0</span><span class="p">,</span> <span class="n">ax_list</span><span class="o">=</span><span class="n">ax_list</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">lnp_list</span><span class="p">)),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span>
                    <span class="n">sharey</span><span class="o">=</span><span class="n">sharey</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">ax_list</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># group_and_sortby and build (ngroups,) subplots</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_and_sortby</span><span class="p">(</span><span class="n">hue</span><span class="p">,</span> <span class="n">sortby</span><span class="p">)</span>
            <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
            <span class="n">ax_mat</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                                   <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">sharey</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ig</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">groups</span><span class="p">):</span>
                <span class="n">subtitle</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_label</span><span class="p">(</span><span class="n">hue</span><span class="p">),</span> <span class="n">g</span><span class="o">.</span><span class="n">hvalue</span><span class="p">)</span>
                <span class="n">ax_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ig</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">subtitle</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">nclabel</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
                    <span class="n">fig</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">plot_qps_vs_e0</span><span class="p">(</span><span class="n">with_fields</span><span class="o">=</span><span class="n">list_strings</span><span class="p">(</span><span class="n">field</span><span class="p">),</span>
                        <span class="n">e0</span><span class="o">=</span><span class="n">e0</span><span class="p">,</span> <span class="n">ax_list</span><span class="o">=</span><span class="n">ax_mat</span><span class="p">[:,</span> <span class="n">ig</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="p">)),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span>
                        <span class="n">sharey</span><span class="o">=</span><span class="n">sharey</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_label</span><span class="p">(</span><span class="n">sortby</span><span class="p">),</span> <span class="n">param</span><span class="p">),</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">ig</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">ax_mat</span><span class="p">[:,</span> <span class="n">ig</span><span class="p">]:</span>
                        <span class="n">set_visible</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;ylabel&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="SigresRobot.plot_selfenergy_conv"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresRobot.plot_selfenergy_conv">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_selfenergy_conv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the convergence of the e-e self-energy wrt to the ``sortby`` parameter.</span>
<span class="sd">        Values can be optionally grouped by `hue`.</span>

<span class="sd">        Args:</span>
<span class="sd">            spin: Spin index.</span>
<span class="sd">            kpoint: K-point in self-energy (can be |Kpoint|, list/tuple or int)</span>
<span class="sd">            band: Band index.</span>
<span class="sd">            sortby: Define the convergence parameter, sort files and produce plot labels.</span>
<span class="sd">                Can be None, string or function. If None, no sorting is performed.</span>
<span class="sd">                If string and not empty it&#39;s assumed that the abifile has an attribute</span>
<span class="sd">                with the same name and `getattr` is invoked.</span>
<span class="sd">                If callable, the output of sortby(abifile) is used.</span>
<span class="sd">            hue: Variable that define subsets of the data, which will be drawn on separate lines.</span>
<span class="sd">                Accepts callable or string</span>
<span class="sd">                If string, it&#39;s assumed that the abifile has an attribute with the same name and getattr is invoked.</span>
<span class="sd">                If callable, the output of hue(abifile) is used.</span>
<span class="sd">            colormap: matplotlib color map.</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                   or scalar e.g. ``left``. If left (right) is None, default values are used.</span>
<span class="sd">            fontsize: Legend and title fontsize.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make sure that nsppol and sigma_kpoints are consistent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_dims_and_params</span><span class="p">()</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax_list</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">lnp_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="n">sortby</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lnp_list</span><span class="p">):</span>
                <span class="n">sigma</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">read_sigee_skb</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">)</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">sigma</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax_list</span><span class="o">=</span><span class="n">ax_list</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">lnp_list</span><span class="p">)),</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">ax_list</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># group_and_sortby and build (3, ngroups) subplots</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_and_sortby</span><span class="p">(</span><span class="n">hue</span><span class="p">,</span> <span class="n">sortby</span><span class="p">)</span>
            <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
            <span class="n">ax_mat</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                                   <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ig</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">groups</span><span class="p">):</span>
                <span class="n">subtitle</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_label</span><span class="p">(</span><span class="n">hue</span><span class="p">),</span> <span class="n">g</span><span class="o">.</span><span class="n">hvalue</span><span class="p">)</span>
                <span class="n">ax_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ig</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">subtitle</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">nclabel</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
                    <span class="n">sigma</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">read_sigee_skb</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">)</span>
                    <span class="n">fig</span> <span class="o">=</span> <span class="n">sigma</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax_list</span><span class="o">=</span><span class="n">ax_mat</span><span class="p">[:,</span> <span class="n">ig</span><span class="p">],</span>
                        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_label</span><span class="p">(</span><span class="n">sortby</span><span class="p">),</span> <span class="n">param</span><span class="p">),</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="p">)),</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ig</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">ax_mat</span><span class="p">[:,</span> <span class="n">ig</span><span class="p">]:</span>
                    <span class="n">set_visible</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;ylabel&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">ax_mat</span><span class="o">.</span><span class="n">ravel</span><span class="p">():</span>
                <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="SigresRobot.yield_figs"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresRobot.yield_figs">[docs]</a>    <span class="k">def</span> <span class="nf">yield_figs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function *generates* a predefined list of matplotlib figures with minimal input from the user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_qpgaps_convergence</span><span class="p">(</span><span class="n">plot_qpmks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>
        <span class="c1">#yield self.plot_qpdata_conv_skb(spin, kpoint, band, show=False)</span>
        <span class="c1">#yield self.plot_qpfield_vs_e0(field, show=False)</span>
        <span class="c1">#yield self.plot_selfenergy_conv(spin, kpoint, band, sortby=None, hue=None, show=False)</span>

<div class="viewcode-block" id="SigresRobot.write_notebook"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.gw.SigresRobot.write_notebook">[docs]</a>    <span class="k">def</span> <span class="nf">write_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a jupyter_ notebook to ``nbpath``. If nbpath is None, a temporay file in the current</span>
<span class="sd">        working directory is created. Return path to the notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbformat</span><span class="p">,</span> <span class="n">nbv</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nbformat_nbv_nb</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">[(</span><span class="n">l</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="c1">#nbv.new_markdown_cell(&quot;# This is a markdown cell&quot;),</span>
            <span class="c1">#nbv.new_code_cell(&quot;plotter = robot.get_ebands_plotter()&quot;),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;robot = abilab.SigresRobot(*</span><span class="si">%s</span><span class="s2">)</span><span class="se">\n</span><span class="s2">robot.trim_paths()</span><span class="se">\n</span><span class="s2">robot&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">)),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;robot.get_qpgaps_dataframe(spin=None, kpoint=None, with_geo=False)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;robot.plot_qpgaps_convergence(plot_qpmks=True, sortby=None, hue=None);&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;#robot.plot_qpdata_conv_skb(spin=0, kpoint=0, band=0, sortby=None, hue=None);&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;robot.plot_qpfield_vs_e0(field=&#39;qpeme0&#39;, sortby=None, hue=None);&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;#robot.plot_selfenergy_conv(spin=0, kpoint=0, band=0, sortby=None, hue=None);&quot;</span><span class="p">),</span>
        <span class="p">])</span>

        <span class="c1"># Mixins</span>
        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_baserobot_code_cells</span><span class="p">())</span>
        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_ebands_code_cells</span><span class="p">())</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_nb_nbpath</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nbpath</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, M. Giantomassi and the AbiPy group.
      <span class="lastupdated">
        Last updated on May 07, 2021.
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>