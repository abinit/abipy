

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>abipy.electrons.lobster &mdash; abipy 0.9.1 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/jupyter-sphinx.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/thebelab.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/plot_directive.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/my_style.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-dataframe.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-rendered-html.css" type="text/css" />

  
  

  
  

  

  
    <script type="text/javascript" src="https://cdn.plot.ly/plotly-latest.min.js"></script> 
    
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/thebelab-helper.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> abipy
          

          
          </a>

          
            
            
              <div class="version">
                0.9.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../features.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Getting AbiPy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../zzbiblio.html">Bibliography</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../scripts/index.html">Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../graphical_interface.html">Graphical interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gallery/index.html">AbiPy Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../postprocessing_howto.html">Post-processing How-To</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../workflows/taskmanager.html">TaskManager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../workflows/manager_examples.html">Manager Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../flow_gallery/index.html">Flow Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../flows_howto.html">Flows How-To</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../coding_guide.html">Coding guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html">Documenting AbiPy</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">abipy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>abipy.electrons.lobster</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for abipy.electrons.lobster</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: utf-8</span>
<span class="sd">&quot;&quot;&quot;Tools to analyze the output files produced by Lobster.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">monty.string</span> <span class="kn">import</span> <span class="n">marquee</span>
<span class="kn">from</span> <span class="nn">monty.collections</span> <span class="kn">import</span> <span class="n">tree</span>
<span class="kn">from</span> <span class="nn">monty.io</span> <span class="kn">import</span> <span class="n">zopen</span>
<span class="kn">from</span> <span class="nn">monty.termcolor</span> <span class="kn">import</span> <span class="n">cprint</span>
<span class="kn">from</span> <span class="nn">monty.functools</span> <span class="kn">import</span> <span class="n">lazy_property</span>
<span class="kn">from</span> <span class="nn">pymatgen.core.periodic_table</span> <span class="kn">import</span> <span class="n">Element</span>
<span class="kn">from</span> <span class="nn">pymatgen.electronic_structure.core</span> <span class="kn">import</span> <span class="n">OrbitalType</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.vasp.outputs</span> <span class="kn">import</span> <span class="n">Vasprun</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.vasp.inputs</span> <span class="kn">import</span> <span class="n">Potcar</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.abinit.pseudos</span> <span class="kn">import</span> <span class="n">Pseudo</span>
<span class="kn">from</span> <span class="nn">abipy.core.func1d</span> <span class="kn">import</span> <span class="n">Function1D</span>
<span class="kn">from</span> <span class="nn">abipy.core.mixins</span> <span class="kn">import</span> <span class="n">BaseFile</span><span class="p">,</span> <span class="n">NotebookWriter</span>
<span class="kn">from</span> <span class="nn">abipy.electrons.gsr</span> <span class="kn">import</span> <span class="n">GsrFile</span>
<span class="kn">from</span> <span class="nn">abipy.tools.plotting</span> <span class="kn">import</span> <span class="n">add_fig_kwargs</span><span class="p">,</span> <span class="n">get_ax_fig_plt</span><span class="p">,</span> <span class="n">get_axarray_fig_plt</span><span class="p">,</span> <span class="n">set_visible</span><span class="p">,</span> <span class="n">set_ax_xylabels</span>
<span class="kn">from</span> <span class="nn">abipy.tools</span> <span class="kn">import</span> <span class="n">duck</span>


<span class="k">class</span> <span class="nc">_LobsterFile</span><span class="p">(</span><span class="n">BaseFile</span><span class="p">,</span> <span class="n">NotebookWriter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for output files produced by lobster.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># These class attributes can be redefined in order to customize the plots.</span>

    <span class="c1"># Mapping L --&gt; color used in plots.</span>
    <span class="n">color_l</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">:</span> <span class="s2">&quot;orange&quot;</span><span class="p">}</span>

    <span class="c1"># \U starts an eight-character Unicode escape. raw strings do not work in python2.7</span>
    <span class="c1"># and we need a latex symbol to avoid errors in matplotlib --&gt; replace myuparrow --&gt; uparrow</span>

    <span class="c1"># Mapping spin --&gt; title used in subplots that depend on (collinear) spin.</span>
    <span class="n">spin2tex</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;myuparrow&quot;</span><span class="p">,</span> <span class="s2">&quot;uparrow&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span>
            <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$\sigma=\myuparrow$&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$\sigma=\downarrow$&quot;</span><span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="c1"># TODOL ls</span>
    <span class="n">params_orbs</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s2">&quot;s&quot;</span><span class="p">:</span>  <span class="p">{</span><span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;latex&quot;</span><span class="p">:</span> <span class="s2">&quot;s&quot;</span><span class="p">},</span>
      <span class="c1">#</span>
      <span class="s2">&quot;p_x&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;latex&quot;</span><span class="p">:</span> <span class="s2">&quot;p_x&quot;</span><span class="p">},</span>
      <span class="s2">&quot;p_y&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;latex&quot;</span><span class="p">:</span> <span class="s2">&quot;p_y&quot;</span><span class="p">},</span>
      <span class="s2">&quot;p_z&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;latex&quot;</span><span class="p">:</span> <span class="s2">&quot;p_z&quot;</span><span class="p">},</span>
      <span class="c1">#</span>
      <span class="s2">&quot;d_xy&quot;</span><span class="p">:</span>  <span class="p">{</span><span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;latex&quot;</span><span class="p">:</span> <span class="s2">&quot;d_</span><span class="si">{xy}</span><span class="s2">&quot;</span><span class="p">},</span>
      <span class="s2">&quot;d_yz&quot;</span><span class="p">:</span>  <span class="p">{</span><span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;latex&quot;</span><span class="p">:</span> <span class="s2">&quot;d_</span><span class="si">{yz}</span><span class="s2">&quot;</span><span class="p">},</span>
      <span class="s2">&quot;d_z^2&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;latex&quot;</span><span class="p">:</span> <span class="s2">&quot;d_{z^2}&quot;</span><span class="p">},</span>
      <span class="s2">&quot;d_xz&quot;</span><span class="p">:</span>  <span class="p">{</span><span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;latex&quot;</span><span class="p">:</span> <span class="s2">&quot;d_</span><span class="si">{xz}</span><span class="s2">&quot;</span><span class="p">},</span>
      <span class="s2">&quot;d_x^2-y^2&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;latex&quot;</span><span class="p">:</span> <span class="s2">&quot;d_{x^2-y^2}&quot;</span><span class="p">},</span>
      <span class="c1">#</span>
      <span class="s2">&quot;4f_y(3x^2-y^2)&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;latex&quot;</span><span class="p">:</span> <span class="s2">&quot;4f_{y(3x^2-y^2)}&quot;</span><span class="p">},</span>
      <span class="s2">&quot;4f_xyz&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;latex&quot;</span><span class="p">:</span> <span class="s2">&quot;4f_</span><span class="si">{xyz}</span><span class="s2">&quot;</span><span class="p">},</span>
      <span class="s2">&quot;4f_yz^2&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;latex&quot;</span><span class="p">:</span> <span class="s2">&quot;4f_{yz^2}&quot;</span><span class="p">},</span>
      <span class="s2">&quot;4f_z^3&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;latex&quot;</span><span class="p">:</span> <span class="s2">&quot;4f_{z^3}&quot;</span><span class="p">},</span>
      <span class="s2">&quot;4f_xz^2&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;latex&quot;</span><span class="p">:</span> <span class="s2">&quot;4f_{xz^2}&quot;</span><span class="p">},</span>
      <span class="s2">&quot;4f_z(x^2-y^2)&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;latex&quot;</span><span class="p">:</span> <span class="s2">&quot;4f_{z(x^2-y^2)}&quot;</span><span class="p">},</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Needed by ABC.&quot;&quot;&quot;</span>

    <span class="c1">#@add_fig_kwargs</span>
    <span class="c1">#def plot_with_ebands(self, ebands, fontsize=12, **kwargs):</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    Plot bands + (COHP|COOP|DOSCAR) depending on the content of the file.</span>

    <span class="c1">#    Args:</span>
    <span class="c1">#        ebands: Path to ncfile with ebands or |ElectronBands| object.</span>
    <span class="c1">#        fontsize: fontsize for legends and titles</span>

    <span class="c1">#    Returns: |matplotlib-Figure|</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    ebands = ElectronBands.as_ebands(ebands)</span>

    <span class="c1">#    import matplotlib.pyplot as plt</span>
    <span class="c1">#    from matplotlib.gridspec import GridSpec</span>
    <span class="c1">#    fig = plt.figure()</span>

    <span class="c1">#    # Build grid.</span>
    <span class="c1">#    nrows, ncols = 1, 2</span>
    <span class="c1">#    gspec = GridSpec(nrows=nrows, ncols=ncols, width_ratios=(2, 1), wspace=0.05)</span>

    <span class="c1">#    # Bands and DOS will share the y-axis</span>
    <span class="c1">#    axmat = np.array((nrows, ncols), dtype=object)</span>
    <span class="c1">#    for icol in range(ncols):</span>
    <span class="c1">#        for irow in range(nrows):</span>
    <span class="c1">#            axmat[irow, icol] = plt.subplot(gspec[irow, icol], sharey=None if irow == 0 else axmat[irow, icol-1])</span>

    <span class="c1">#    #axmat, fig, plt = get_axarray_fig_plt(None, nrows=self.nsppol, ncols=len(entries) + 1,</span>
    <span class="c1">#    #                                        sharex=False, sharey=True, squeeze=False)</span>

    <span class="c1">#    for ix, ax in enumerate(axmat.ravel()):</span>
    <span class="c1">#        if ix == 0:</span>
    <span class="c1">#            ebands.plot(e0=&quot;fermie&quot;, ax=ax, show=False)</span>
    <span class="c1">#        else:</span>
    <span class="c1">#            self.plot(ax=ax, exchange_xy=True, show=False)</span>

    <span class="c1">#        #if ix != 0:</span>
    <span class="c1">#        #    set_visible(ax, False, &quot;ylabel&quot;)</span>
    <span class="c1">#        #if self.nsppol == 2 and spin == 0:</span>
    <span class="c1">#        #    set_visible(ax, False, &quot;xlabel&quot;)</span>

    <span class="c1">#    return fig</span>


<div class="viewcode-block" id="CoxpFile"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.CoxpFile">[docs]</a><span class="k">class</span> <span class="nc">CoxpFile</span><span class="p">(</span><span class="n">_LobsterFile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper class for the crystal orbital projections produced by Lobster.</span>
<span class="sd">    Wraps both a COOP and a COHP.</span>
<span class="sd">    Can contain both the total and orbitalwise projections.</span>

<span class="sd">    .. attribute:: cop_type</span>

<span class="sd">        String. Either &quot;coop&quot; or &quot;cohp&quot;.</span>

<span class="sd">    .. attribute:: type_of_index</span>

<span class="sd">        Dictionary mappping site index to element string.</span>

<span class="sd">    .. attribute:: energies</span>

<span class="sd">        List of energies. Shifted such that the Fermi level lies at 0 eV.</span>

<span class="sd">    .. attribute:: total</span>

<span class="sd">        A dictionary with the values of the total overlap, not projected over orbitals.</span>
<span class="sd">        The dictionary should have the following nested keys: a tuple with the index of the sites</span>
<span class="sd">        considered as a pair (0-based, e.g. (0, 1)), the spin (i.e. 0 or 1), a &quot;single&quot;</span>
<span class="sd">        or &quot;integrated&quot; string indicating the value corresponding to the value of</span>
<span class="sd">        the energy or to the integrated value up to that energy.</span>

<span class="sd">    .. attribute:: partial</span>

<span class="sd">        A dictionary with the values of the partial crystal orbital projections.</span>
<span class="sd">        The dictionary should have the following nested keys: a tuple with the index of the sites</span>
<span class="sd">        considered as a pair (0-based, e.g. (0, 1)), a tuple with the string representing the</span>
<span class="sd">        projected orbitals for that pair (e.g. (&quot;4s&quot;, &quot;4p_x&quot;)), the spin (i.e. 0 or 1),</span>
<span class="sd">        a &quot;single&quot; or &quot;integrated&quot; string indicating the value corresponding to the value of</span>
<span class="sd">        the energy or to the integrated value up to that energy. Each dictionary should contain a</span>
<span class="sd">        numpy array with a list of COP values with the same size as energies.</span>

<span class="sd">    .. attribute:: averaged</span>

<span class="sd">        A dictionary with the values of the partial crystal orbital projections</span>
<span class="sd">        averaged over all atom pairs specified. The main key should indicate the spin (0 or 1)</span>
<span class="sd">        and the nested dictionary should have &quot;single&quot; and &quot;integrated&quot; as keys.</span>

<span class="sd">    .. attribute:: fermie</span>

<span class="sd">        value of the fermi energy in eV.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">site_pairs_total</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List of site pairs available for the total COP</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">site_pairs_partial</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List of site pairs available for the partial COP</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">partial</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<div class="viewcode-block" id="CoxpFile.from_file"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.CoxpFile.from_file">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates an instance of CoxpFile from the files produce by Lobster.</span>
<span class="sd">        Accepts gzipped files.</span>

<span class="sd">        Args:</span>
<span class="sd">            filepath: path to the COHPCAR.lobster or COOPCAR.lobster.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A CoxpFile.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># From lobster documentation</span>
        <span class="c1"># COHPCAR.lobster:</span>
        <span class="c1"># File that contains the pCOHPs as requested in the lobsterin file.</span>
        <span class="c1"># It resembles the format of TB-LMTO-ASA&#39;s COPL file, which is organized as follows:</span>
        <span class="c1"># - Starting in line 3, the labels for the interactions are presented, followed by the</span>
        <span class="c1"># actual data.</span>
        <span class="c1"># - Column 1: energy axis, shifted such that the Fermi level lies at zero eV.</span>
        <span class="c1"># - Column 2: pCOHP averaged over all atom pairs specified</span>
        <span class="c1"># - Column 3: integrated pCOHP (IpCOHP) averaged over all atom pairs</span>
        <span class="c1"># - Column 4: pCOHP of the first interaction</span>
        <span class="c1"># - Column 5: IpCOHP of the first interaction</span>
        <span class="c1"># - and so on...</span>
        <span class="c1"># Note that in a spin-polarized calculation, the first set of the columns (2, 3, ..., 2N+3)</span>
        <span class="c1"># belongs to the first (up) spin and the other set (2N+4, 2N+5, ..., 4N+5) belongs to the</span>
        <span class="c1"># second (down) spin. Here N is the number of interactions.</span>

        <span class="n">float_patt</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;-?(?:0|[1-9]\d*)(?:\.\d*)?(?:[eE][+\-]?\d+)?&#39;</span>
        <span class="n">header_patt</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s+(\d+)\s+(\d+)\s+(\d+)\s+(&#39;</span> <span class="o">+</span> <span class="n">float_patt</span> <span class="o">+</span>
                                 <span class="sa">r</span><span class="s1">&#39;)\s+(&#39;</span> <span class="o">+</span> <span class="n">float_patt</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;)\s+(&#39;</span> <span class="o">+</span> <span class="n">float_patt</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
        <span class="n">pair_patt</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;No\.\d+:([a-zA-Z]+)(\d+)(?:\[([a-z0-9_\-^]+)\])?-&gt;([a-zA-Z]+)(\d+)(?:\[([a-z0-9_\-^]+)\])?&#39;</span><span class="p">)</span>

        <span class="n">new</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">zopen</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="c1"># Find the header</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">header_patt</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="n">n_column_groups</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">n_spin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                    <span class="n">n_en_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
                    <span class="n">min_en</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                    <span class="n">max_en</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
                    <span class="n">new</span><span class="o">.</span><span class="n">fermie</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t find the header in file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span>

            <span class="n">n_pairs</span> <span class="o">=</span> <span class="n">n_column_groups</span><span class="o">-</span><span class="mi">1</span>

            <span class="n">count_pairs</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">pairs_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">new</span><span class="o">.</span><span class="n">type_of_index</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># Parse the pairs considered</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">pair_patt</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="c1"># Adds a tuple: [type1, index1, orbital1, type2, index2, orbital2]</span>
                    <span class="c1"># with orbital1, orbital2 = None if the pair is not orbitalwise</span>
                    <span class="n">type1</span><span class="p">,</span> <span class="n">index1</span><span class="p">,</span> <span class="n">orbital1</span><span class="p">,</span> <span class="n">type2</span><span class="p">,</span> <span class="n">index2</span><span class="p">,</span> <span class="n">orbital2</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                    <span class="c1"># 0-based indexing</span>
                    <span class="n">index1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">index1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">index2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">index2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">pairs_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">type1</span><span class="p">,</span> <span class="n">index1</span><span class="p">,</span> <span class="n">orbital1</span><span class="p">,</span> <span class="n">type2</span><span class="p">,</span> <span class="n">index2</span><span class="p">,</span> <span class="n">orbital2</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">index1</span> <span class="ow">in</span> <span class="n">new</span><span class="o">.</span><span class="n">type_of_index</span><span class="p">:</span> <span class="k">assert</span> <span class="n">new</span><span class="o">.</span><span class="n">type_of_index</span><span class="p">[</span><span class="n">index1</span><span class="p">]</span> <span class="o">==</span> <span class="n">type1</span>
                    <span class="n">new</span><span class="o">.</span><span class="n">type_of_index</span><span class="p">[</span><span class="n">index1</span><span class="p">]</span> <span class="o">=</span> <span class="n">type1</span>
                    <span class="k">if</span> <span class="n">index2</span> <span class="ow">in</span> <span class="n">new</span><span class="o">.</span><span class="n">type_of_index</span><span class="p">:</span> <span class="k">assert</span> <span class="n">new</span><span class="o">.</span><span class="n">type_of_index</span><span class="p">[</span><span class="n">index2</span><span class="p">]</span> <span class="o">==</span> <span class="n">type2</span>
                    <span class="n">new</span><span class="o">.</span><span class="n">type_of_index</span><span class="p">[</span><span class="n">index2</span><span class="p">]</span> <span class="o">=</span> <span class="n">type2</span>
                    <span class="n">count_pairs</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">count_pairs</span> <span class="o">==</span> <span class="n">n_pairs</span><span class="p">:</span>
                        <span class="k">break</span>

            <span class="n">spins</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">][:</span><span class="n">n_spin</span><span class="p">]</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">n_en_steps</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="n">n_spin</span><span class="o">*</span><span class="n">n_column_groups</span><span class="o">*</span><span class="mi">2</span><span class="p">])</span>

            <span class="c1"># Initialize and fill results</span>
            <span class="n">new</span><span class="o">.</span><span class="n">energies</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">new</span><span class="o">.</span><span class="n">averaged</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
            <span class="n">new</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="n">tree</span><span class="p">()</span>
            <span class="n">new</span><span class="o">.</span><span class="n">partial</span> <span class="o">=</span> <span class="n">tree</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spins</span><span class="p">):</span>
                <span class="n">base_index</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">n_column_groups</span><span class="o">*</span><span class="mi">2</span>
                <span class="n">new</span><span class="o">.</span><span class="n">averaged</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;single&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">base_index</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">new</span><span class="o">.</span><span class="n">averaged</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;integrated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">base_index</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="c1"># NB (i, j) --&gt; (j, i) symmetry is enforced to make API easier.</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pairs_data</span><span class="p">):</span>
                    <span class="n">index1</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">index2</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># Partial</span>
                        <span class="n">single</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">base_index</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">integrated</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">base_index</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">new</span><span class="o">.</span><span class="n">partial</span><span class="p">[(</span><span class="n">index1</span><span class="p">,</span> <span class="n">index2</span><span class="p">)][(</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">])][</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;single&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">single</span>
                        <span class="n">new</span><span class="o">.</span><span class="n">partial</span><span class="p">[(</span><span class="n">index2</span><span class="p">,</span> <span class="n">index1</span><span class="p">)][(</span><span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">])][</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;single&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">single</span>
                        <span class="n">new</span><span class="o">.</span><span class="n">partial</span><span class="p">[(</span><span class="n">index1</span><span class="p">,</span> <span class="n">index2</span><span class="p">)][(</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">])][</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;integrated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">integrated</span>
                        <span class="n">new</span><span class="o">.</span><span class="n">partial</span><span class="p">[(</span><span class="n">index2</span><span class="p">,</span> <span class="n">index1</span><span class="p">)][(</span><span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">])][</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;integrated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">integrated</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Total</span>
                        <span class="n">single</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">base_index</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">integrated</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">base_index</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">new</span><span class="o">.</span><span class="n">total</span><span class="p">[(</span><span class="n">index1</span><span class="p">,</span> <span class="n">index2</span><span class="p">)][</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;single&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">single</span>
                        <span class="n">new</span><span class="o">.</span><span class="n">total</span><span class="p">[(</span><span class="n">index2</span><span class="p">,</span> <span class="n">index1</span><span class="p">)][</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;single&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">single</span>
                        <span class="n">new</span><span class="o">.</span><span class="n">total</span><span class="p">[(</span><span class="n">index1</span><span class="p">,</span> <span class="n">index2</span><span class="p">)][</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;integrated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">integrated</span>
                        <span class="n">new</span><span class="o">.</span><span class="n">total</span><span class="p">[(</span><span class="n">index2</span><span class="p">,</span> <span class="n">index1</span><span class="p">)][</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;integrated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">integrated</span>

        <span class="n">new</span><span class="o">.</span><span class="n">cop_type</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;COOPCAR.lobster&quot;</span> <span class="ow">in</span> <span class="n">filepath</span><span class="p">:</span> <span class="n">new</span><span class="o">.</span><span class="n">cop_type</span> <span class="o">=</span> <span class="s2">&quot;coop&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;COHPCAR.lobster&quot;</span> <span class="ow">in</span> <span class="n">filepath</span><span class="p">:</span> <span class="n">new</span><span class="o">.</span><span class="n">cop_type</span> <span class="o">=</span> <span class="s2">&quot;cohp&quot;</span>
        <span class="n">new</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new</span><span class="o">.</span><span class="n">averaged</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">new</span></div>

<div class="viewcode-block" id="CoxpFile.functions_pair_lorbitals"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.CoxpFile.functions_pair_lorbitals">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">functions_pair_lorbitals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts a dictionary with keys pair, orbital, spin and containing a |Function1D| object resolved</span>
<span class="sd">        for l orbitals.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Partial orbitals not calculated.&quot;</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="n">tree</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">pair_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Check if the symmetric has already been calculated</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">orbs</span><span class="p">,</span> <span class="n">orbs_data</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[(</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">pair</span><span class="p">][(</span><span class="n">orbs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">orbs</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="n">orbs_data</span>
                <span class="k">continue</span>

            <span class="c1"># For each look at all orbital possibilities</span>
            <span class="k">for</span> <span class="n">orbs</span><span class="p">,</span> <span class="n">orbs_data</span> <span class="ow">in</span> <span class="n">pair_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">orbs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">orbs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="n">pair</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="n">orbs_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">results</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="n">spin</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="n">spin</span><span class="p">]</span> <span class="o">+</span> <span class="n">Function1D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">,</span><span class="n">orbs_data</span><span class="p">[</span><span class="n">spin</span><span class="p">][</span><span class="s1">&#39;single&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="n">orbs_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">results</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="n">spin</span><span class="p">]</span> <span class="o">=</span> <span class="n">Function1D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">,</span> <span class="n">orbs_data</span><span class="p">[</span><span class="n">spin</span><span class="p">][</span><span class="s1">&#39;single&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="CoxpFile.functions_pair_morbitals"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.CoxpFile.functions_pair_morbitals">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">functions_pair_morbitals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts a dictionary with keys pair, orbital, spin and containing a |Function1D| object resolved</span>
<span class="sd">        for l and m orbitals.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Partial orbitals not calculated.&quot;</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="n">tree</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">pair_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">orbs</span><span class="p">,</span> <span class="n">orbs_data</span> <span class="ow">in</span> <span class="n">pair_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="n">orbs_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="n">orbs</span><span class="p">][</span><span class="n">spin</span><span class="p">]</span> <span class="o">=</span> <span class="n">Function1D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">,</span> <span class="n">orbs_data</span><span class="p">[</span><span class="n">spin</span><span class="p">][</span><span class="s1">&#39;single&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="CoxpFile.functions_pair"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.CoxpFile.functions_pair">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">functions_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts a dictionary with keys pair, spin and containing a |Function1D| object for the total COP.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">tree</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">pair_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">total</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="n">pair_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">results</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="n">spin</span><span class="p">]</span> <span class="o">=</span> <span class="n">Function1D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">,</span> <span class="n">pair_data</span><span class="p">[</span><span class="n">spin</span><span class="p">][</span><span class="s1">&#39;single&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="CoxpFile.to_string"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.CoxpFile.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation with verbosity level `verbose`.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="c1">#app(marquee(&quot;File Info&quot;, mark=&quot;=&quot;))</span>
            <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filestat</span><span class="p">(</span><span class="n">as_string</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Number of energies: </span><span class="si">%d</span><span class="s2">, from </span><span class="si">%.3f</span><span class="s2"> to </span><span class="si">%.3f</span><span class="s2"> (eV) with E_fermi set 0 (was </span><span class="si">%.3f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cop_type</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;has_partial_projections: </span><span class="si">%s</span><span class="s2">, nsppol: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">partial</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Number of pairs: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pair</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total</span><span class="p">):</span>
            <span class="n">type0</span><span class="p">,</span> <span class="n">type1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_of_index</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_of_index</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">%d</span><span class="s2">] </span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2"> --&gt; </span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">type0</span><span class="p">,</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">type1</span><span class="p">,</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="CoxpFile.yield_figs"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.CoxpFile.yield_figs">[docs]</a>    <span class="k">def</span> <span class="nf">yield_figs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function *generates* a predefined list of matplotlib figures with minimal input from the user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">what</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">what</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="CoxpFile.plot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.CoxpFile.plot">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot COXP averaged values (DOS or IDOS depending on what).</span>

<span class="sd">        Args:</span>
<span class="sd">            what: string selecting what will be plotted. &quot;d&quot; for DOS, &quot;i&quot; for IDOS</span>
<span class="sd">            spin: Select spin index if not None.</span>
<span class="sd">            ax: |matplotlib-Axes| or None if a new figure should be created.</span>
<span class="sd">            exchange_xy: True to exchange x-y axis.</span>
<span class="sd">            fontsize: fontsize for legends and titles</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">averaged</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">xlabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$E - E_f\;(eV)$&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cop_type</span> <span class="o">==</span> <span class="s2">&quot;coop&quot;</span><span class="p">:</span>
            <span class="n">ysign</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="s2">&quot;COOP&quot;</span><span class="p">,</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span> <span class="s2">&quot;ICOOP&quot;</span><span class="p">}[</span><span class="n">what</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cop_type</span> <span class="o">==</span> <span class="s2">&quot;cohp&quot;</span><span class="p">:</span>
            <span class="n">ysign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="s2">&quot;-COHP&quot;</span><span class="p">,</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span> <span class="s2">&quot;-ICOHP&quot;</span><span class="p">}[</span><span class="n">what</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wrong cop_type: `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cop_type</span><span class="p">))</span>

        <span class="n">spins</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">)</span> <span class="k">if</span> <span class="n">spin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">spin</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="n">spins</span><span class="p">:</span>
            <span class="n">opts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span> <span class="s2">&quot;ls&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">}</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> \
                   <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span> <span class="s2">&quot;ls&quot;</span><span class="p">:</span> <span class="s2">&quot;--&quot;</span><span class="p">}</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="s2">&quot;single&quot;</span><span class="p">,</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span> <span class="s2">&quot;integrated&quot;</span><span class="p">}[</span><span class="n">what</span><span class="p">]</span>
            <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">,</span> <span class="n">ysign</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">averaged</span><span class="p">[</span><span class="n">spin</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">ys</span><span class="p">,</span> <span class="n">xs</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spin2tex</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">opts</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span>
            <span class="c1"># Add vertical line to signal the zero.</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">set_ax_xylabels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="CoxpFile.plot_average_pairs"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.CoxpFile.plot_average_pairs">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_average_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_site_index</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;single&quot;</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot COXP total overlap for all sites containg `with_site_index` and average sum</span>
<span class="sd">        (multiplied by the number of pairs)</span>

<span class="sd">        Args:</span>
<span class="sd">            with_site_index: int of list of integers selecting the site index to be included.</span>
<span class="sd">            what: &quot;single&quot; for COXP DOS, &quot;integrated&quot; for IDOS.</span>
<span class="sd">            exchange_xy: True to exchange x-y axis.</span>
<span class="sd">            fontsize: fontsize for legends and titles</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">duck</span><span class="o">.</span><span class="n">is_listlike</span><span class="p">(</span><span class="n">with_site_index</span><span class="p">):</span> <span class="n">with_site_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">with_site_index</span><span class="p">]</span>

        <span class="c1"># Create list of pairs.</span>
        <span class="n">all_pairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">with_site_index</span><span class="p">:</span>
            <span class="n">pairs</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">total</span> <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">p</span><span class="p">]</span>
            <span class="n">all_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pairs</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Cannot find pairs containing  site index </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="s2">&quot;yellow&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pairs containing site index:&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
                    <span class="n">type0</span><span class="p">,</span> <span class="n">type1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_of_index</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_of_index</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2"> --&gt; </span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">type0</span><span class="p">,</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">type1</span><span class="p">,</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="c1"># Build (1, nsppol) grid</span>
        <span class="c1">#ax, fig, plt = get_ax_fig_plt(ax=ax)</span>
        <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span>
                                                <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">ysign</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$E - E_f\;(eV)$&quot;</span><span class="p">,</span> <span class="s2">&quot;COOP&quot;</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cop_type</span> <span class="o">==</span> <span class="s2">&quot;cohp&quot;</span><span class="p">:</span>
            <span class="n">ylabel</span><span class="p">,</span> <span class="n">ysign</span> <span class="o">=</span> <span class="s2">&quot;-COHP&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># self.total[pair][spin][what]</span>
        <span class="k">for</span> <span class="n">spin</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ax_list</span><span class="o">.</span><span class="n">ravel</span><span class="p">()):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">sum_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">pairs</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">with_site_index</span><span class="p">,</span> <span class="n">all_pairs</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pairs</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
                    <span class="n">ys</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="n">spin</span><span class="p">][</span><span class="n">what</span><span class="p">]</span>
                <span class="c1">#ys /= len(pairs)</span>
                <span class="n">ys</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total</span><span class="p">)</span>
                <span class="n">sum_all</span> <span class="o">+=</span> <span class="n">ys</span>

                <span class="c1">#label, style = self.get_labelstyle_from_spin_pair(spin, pair)</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Average over pairs with </span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type_of_index</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">index</span><span class="p">)</span>
                <span class="n">style</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">,</span> <span class="n">ysign</span> <span class="o">*</span> <span class="n">ys</span>
                <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">ys</span><span class="p">,</span> <span class="n">xs</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>

            <span class="c1"># Plot average * num_pairs for this spin.</span>
            <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">,</span> <span class="n">ysign</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">averaged</span><span class="p">[</span><span class="n">spin</span><span class="p">][</span><span class="n">what</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">ys</span><span class="p">,</span> <span class="n">xs</span>
            <span class="n">style</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Average&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>

            <span class="c1"># Compare with sum</span>
            <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">,</span> <span class="n">ysign</span> <span class="o">*</span> <span class="n">sum_all</span>
            <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">ys</span><span class="p">,</span> <span class="n">xs</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Sumall&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span>
                <span class="c1"># Add vertical line to signal the zero.</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spin2tex</span><span class="p">[</span><span class="n">spin</span><span class="p">])</span>
            <span class="n">set_ax_xylabels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="CoxpFile.plot_site_pairs_total"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.CoxpFile.plot_site_pairs_total">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_site_pairs_total</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_site_index</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;single&quot;</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot COXP total overlap (DOS or IDOS) for all sites listed in `from_site_index`</span>

<span class="sd">        Args:</span>
<span class="sd">            from_site_index: int of list of integers selecting the first site of the pairs to be included.</span>
<span class="sd">            what: &quot;single&quot; for COXP DOS, &quot;integrated&quot; for IDOS.</span>
<span class="sd">            exchange_xy: True to exchange x-y axis.</span>
<span class="sd">            ax: |matplotlib-Axes| or None if a new figure should be created.</span>
<span class="sd">            fontsize: fontsize for legends and titles</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Handle list of sites.</span>
        <span class="k">if</span> <span class="n">duck</span><span class="o">.</span><span class="n">is_listlike</span><span class="p">(</span><span class="n">from_site_index</span><span class="p">):</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">from_site_index</span><span class="p">)</span>
            <span class="n">sharex</span><span class="p">,</span> <span class="n">sharey</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">sharex</span><span class="p">,</span> <span class="n">sharey</span> <span class="o">=</span> <span class="n">sharey</span><span class="p">,</span> <span class="n">sharex</span>
            <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                    <span class="n">sharex</span><span class="o">=</span><span class="n">sharex</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">sharey</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># Recursive call.</span>
            <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ax_list</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">from_site_index</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_site_pairs_total</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="n">what</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="n">exchange_xy</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                    <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">fig</span>

        <span class="c1"># Single site</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">total</span> <span class="k">if</span> <span class="n">from_site_index</span> <span class="o">==</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pairs</span><span class="p">:</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Cannot find pairs starting from site index </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_site_index</span><span class="p">),</span> <span class="s2">&quot;yellow&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">ysign</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$E - E_f\;(eV)$&quot;</span><span class="p">,</span> <span class="s2">&quot;COOP&quot;</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cop_type</span> <span class="o">==</span> <span class="s2">&quot;cohp&quot;</span><span class="p">:</span>
            <span class="n">ylabel</span><span class="p">,</span> <span class="n">ysign</span> <span class="o">=</span> <span class="s2">&quot;-COHP&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># self.total[pair][spin][what]</span>
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">,</span> <span class="n">ysign</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">total</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="n">spin</span><span class="p">][</span><span class="n">what</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">ys</span><span class="p">,</span> <span class="n">xs</span>
                <span class="n">label</span><span class="p">,</span> <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_labelstyle_from_spin_pair</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">pair</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span>
            <span class="c1"># Add vertical line to signal the zero.</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">set_ax_xylabels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="CoxpFile.get_labelstyle_from_spin_pair"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.CoxpFile.get_labelstyle_from_spin_pair">[docs]</a>    <span class="k">def</span> <span class="nf">get_labelstyle_from_spin_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">pair</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return label and linestyle for spin and pair indices&quot;&quot;&quot;</span>
        <span class="n">type0</span><span class="p">,</span> <span class="n">type1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_of_index</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_of_index</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;${</span><span class="si">%s</span><span class="s2">}@{</span><span class="si">%s</span><span class="s2">} \rightarrow {</span><span class="si">%s</span><span class="s2">}@{</span><span class="si">%s</span><span class="s2">}$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">type0</span><span class="p">,</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">type1</span><span class="p">,</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">style</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> \
                <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span>
        <span class="c1"># TODO: Improve style</span>
        <span class="n">style</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;--&quot;</span><span class="p">)</span> <span class="c1">#, color=color)</span>
        <span class="k">return</span> <span class="n">label</span><span class="p">,</span> <span class="n">style</span></div>

<div class="viewcode-block" id="CoxpFile.plot_site_pairs_partial"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.CoxpFile.plot_site_pairs_partial">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_site_pairs_partial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_site_index</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;single&quot;</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot partial crystal orbital projections (DOS or IDOS) for all sites listed in `from_site_index`</span>

<span class="sd">        Args:</span>
<span class="sd">            from_site_index: int of list of integers selecting the first site of the pairs to be included.</span>
<span class="sd">            what: &quot;single&quot; for COXP DOS, &quot;integrated&quot; for IDOS.</span>
<span class="sd">            exchange_xy: True to exchange x-y axis.</span>
<span class="sd">            ax: |matplotlib-Axes| or None if a new figure should be created.</span>
<span class="sd">            fontsize: fontsize for legends and titles</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial</span><span class="p">:</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;File does not contain partial projections&quot;</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Handle list of sites.</span>
        <span class="k">if</span> <span class="n">duck</span><span class="o">.</span><span class="n">is_listlike</span><span class="p">(</span><span class="n">from_site_index</span><span class="p">):</span>
            <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">from_site_index</span><span class="p">)</span>
            <span class="n">sharex</span><span class="p">,</span> <span class="n">sharey</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">sharex</span><span class="p">,</span> <span class="n">sharey</span> <span class="o">=</span> <span class="n">sharey</span><span class="p">,</span> <span class="n">sharex</span>
            <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                                    <span class="n">sharex</span><span class="o">=</span><span class="n">sharex</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">sharey</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># Recursive call.</span>
            <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ax_list</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">from_site_index</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_site_pairs_partial</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="n">what</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="n">exchange_xy</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                    <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">fig</span>

        <span class="c1"># Single site.</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial</span> <span class="k">if</span> <span class="n">from_site_index</span> <span class="o">==</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pairs</span><span class="p">:</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Cannot find pairs starting from site index </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_site_index</span><span class="p">),</span> <span class="s2">&quot;yellow&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">ysign</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$E - E_f\;(eV)$&quot;</span><span class="p">,</span> <span class="s2">&quot;pCOOP&quot;</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cop_type</span> <span class="o">==</span> <span class="s2">&quot;cohp&quot;</span><span class="p">:</span>
            <span class="n">ylabel</span><span class="p">,</span> <span class="n">ysign</span> <span class="o">=</span> <span class="s2">&quot;-COHP&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># [(0, 1)][&quot;4s&quot;, &quot;4p_x&quot;][spin][&quot;single&quot;]</span>
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">orbs</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                    <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">,</span> <span class="n">ysign</span> <span class="o">*</span> <span class="n">d</span><span class="p">[</span><span class="n">spin</span><span class="p">][</span><span class="n">what</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">ys</span><span class="p">,</span> <span class="n">xs</span>
                    <span class="n">label</span><span class="p">,</span> <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_labelstyle_from_spin_pair_orbs</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">pair</span><span class="p">,</span> <span class="n">orbs</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span>
            <span class="c1"># Add vertical line to signal the zero.</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">set_ax_xylabels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="CoxpFile.get_labelstyle_from_spin_pair_orbs"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.CoxpFile.get_labelstyle_from_spin_pair_orbs">[docs]</a>    <span class="k">def</span> <span class="nf">get_labelstyle_from_spin_pair_orbs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">pair</span><span class="p">,</span> <span class="n">orbs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return label and linestyle for spin, pair indices and orbs tuple.&quot;&quot;&quot;</span>
        <span class="n">type0</span><span class="p">,</span> <span class="n">type1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_of_index</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_of_index</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$</span><span class="si">%s</span><span class="s2">_{</span><span class="si">%s</span><span class="s2">}@</span><span class="si">%s</span><span class="s2"> \rightarrow </span><span class="si">%s</span><span class="s2">_{</span><span class="si">%s</span><span class="s2">}@</span><span class="si">%s</span><span class="s2">$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">type0</span><span class="p">,</span> <span class="n">orbs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">type1</span><span class="p">,</span> <span class="n">orbs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># TODO: Improve style</span>
        <span class="c1">#style = self.params_orbs[orbs[0]][&quot;style&quot;]</span>
        <span class="n">style</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;--&quot;</span><span class="p">)</span> <span class="c1">#, color=color)</span>
        <span class="k">return</span> <span class="n">label</span><span class="p">,</span> <span class="n">style</span></div>

<div class="viewcode-block" id="CoxpFile.write_notebook"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.CoxpFile.write_notebook">[docs]</a>    <span class="k">def</span> <span class="nf">write_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a jupyter_ notebook to ``nbpath``. If nbpath is None, a temporay file in the current</span>
<span class="sd">        working directory is created. Return path to the notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbformat</span><span class="p">,</span> <span class="n">nbv</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nbformat_nbv_nb</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;coxpfile = abilab.abiopen(&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;print(coxpfile)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;coxpfile.plot(what=&#39;d&#39;);&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;coxpfile.plot(what=&#39;i&#39;);&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;coxpfile.plot_site_pairs_total(from_site_index=[0,]);&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;coxpfile.plot_site_pairs_partial(from_site_index=[0,]);&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;#coxpfile.plot_with_ebands(ebands=&#39;filepath&#39;);&quot;</span><span class="p">),</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_nb_nbpath</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nbpath</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ICoxpFile"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.ICoxpFile">[docs]</a><span class="k">class</span> <span class="nc">ICoxpFile</span><span class="p">(</span><span class="n">_LobsterFile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper class for the integrated crystal orbital projections up to the Fermi energy</span>
<span class="sd">    produced from Lobster.</span>
<span class="sd">    May contain the output stored in ICOHPLIST.lobster and ICOOPLIST.lobster</span>

<span class="sd">    .. attribute::  cop_type</span>

<span class="sd">        String. Either &quot;coop&quot; or &quot;cohp&quot;.</span>

<span class="sd">    .. attribute:: values</span>

<span class="sd">        A dictionary with the following keys: a tuple with the index of the sites</span>
<span class="sd">        considered as a pair (0-based, e.g. (0,1)), the spin (i.e. 0 or 1)</span>

<span class="sd">    .. attribute:: type_of_index</span>

<span class="sd">        Dictionary mappping site index to element string.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ICoxpFile.from_file"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.ICoxpFile.from_file">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates an instance of ICoxpFile from the files produce by Lobster.</span>
<span class="sd">        Accepts gzipped files.</span>

<span class="sd">        Args:</span>
<span class="sd">            filepath: path to the ICOHPLIST.lobster or ICOOPLIST.lobster.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A ICoxpFile.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">float_patt</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;-?(?:0|[1-9]\d*)(?:\.\d*)?(?:[eE][+\-]?\d+)?&#39;</span>
        <span class="n">header_patt</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.*?(over+\s#\s+bonds)?\s+for\s+spin\s+(\d).*&#39;</span><span class="p">)</span>
        <span class="n">data_patt</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s+\d+\s+([a-zA-Z]+)(\d+)\s+([a-zA-Z]+)(\d+)\s+(&#39;</span> <span class="o">+</span>
                               <span class="n">float_patt</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;)\s+(&#39;</span> <span class="o">+</span> <span class="n">float_patt</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;)(\d+)?&#39;</span><span class="p">)</span>

        <span class="n">new</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">tree</span><span class="p">()</span>

        <span class="n">spin</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">avg_num_bonds</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">new</span><span class="o">.</span><span class="n">type_of_index</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="n">zopen</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">header_patt</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="n">spin</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">avg_num_bonds</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">data_patt</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="n">type1</span><span class="p">,</span> <span class="n">index1</span><span class="p">,</span> <span class="n">type2</span><span class="p">,</span> <span class="n">index2</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">avg</span><span class="p">,</span> <span class="n">n_bonds</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                    <span class="c1"># 0-based indexing</span>
                    <span class="n">index1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">index1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">index2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">index2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">new</span><span class="o">.</span><span class="n">type_of_index</span><span class="p">[</span><span class="n">index1</span><span class="p">]</span> <span class="o">=</span> <span class="n">type1</span>
                    <span class="n">new</span><span class="o">.</span><span class="n">type_of_index</span><span class="p">[</span><span class="n">index2</span><span class="p">]</span> <span class="o">=</span> <span class="n">type2</span>
                    <span class="n">avg_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;average&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">avg</span><span class="p">),</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="n">dist</span><span class="p">,</span> <span class="s1">&#39;n_bonds&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_bonds</span><span class="p">)</span> <span class="k">if</span> <span class="n">n_bonds</span> <span class="k">else</span> <span class="kc">None</span><span class="p">}</span>
                    <span class="n">new</span><span class="o">.</span><span class="n">values</span><span class="p">[(</span><span class="n">index1</span><span class="p">,</span> <span class="n">index2</span><span class="p">)][</span><span class="n">spin</span><span class="p">]</span> <span class="o">=</span> <span class="n">avg_data</span>
                    <span class="n">new</span><span class="o">.</span><span class="n">values</span><span class="p">[(</span><span class="n">index2</span><span class="p">,</span> <span class="n">index1</span><span class="p">)][</span><span class="n">spin</span><span class="p">]</span> <span class="o">=</span> <span class="n">avg_data</span>

        <span class="n">new</span><span class="o">.</span><span class="n">cop_type</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;ICOOPLIST.lobster&quot;</span> <span class="ow">in</span> <span class="n">filepath</span><span class="p">:</span> <span class="n">new</span><span class="o">.</span><span class="n">cop_type</span> <span class="o">=</span> <span class="s2">&quot;coop&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;ICOHPLIST.lobster&quot;</span> <span class="ow">in</span> <span class="n">filepath</span><span class="p">:</span> <span class="n">new</span><span class="o">.</span><span class="n">cop_type</span> <span class="o">=</span> <span class="s2">&quot;cohp&quot;</span>

        <span class="k">return</span> <span class="n">new</span></div>

<div class="viewcode-block" id="ICoxpFile.to_string"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.ICoxpFile.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation with verbosity level `verbose`.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Number of pairs: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="ICoxpFile.dataframe"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.ICoxpFile.dataframe">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;|pandas-DataFrame| with results.&quot;&quot;&quot;</span>
        <span class="c1"># self.values[pair][spin]</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">([</span>
                    <span class="p">(</span><span class="s2">&quot;index0&quot;</span><span class="p">,</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="p">(</span><span class="s2">&quot;index1&quot;</span><span class="p">,</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="p">(</span><span class="s2">&quot;type0&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_of_index</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span>
                    <span class="p">(</span><span class="s2">&quot;type1&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_of_index</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]]),</span>
                    <span class="p">(</span><span class="s2">&quot;spin&quot;</span><span class="p">,</span> <span class="n">spin</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;average&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="n">spin</span><span class="p">][</span><span class="s2">&quot;average&quot;</span><span class="p">]),</span>
                    <span class="p">(</span><span class="s2">&quot;distance&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="n">spin</span><span class="p">][</span><span class="s2">&quot;distance&quot;</span><span class="p">]),</span>
                    <span class="p">(</span><span class="s2">&quot;n_bonds&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="n">spin</span><span class="p">][</span><span class="s2">&quot;n_bonds&quot;</span><span class="p">]),</span>
                    <span class="p">(</span><span class="s2">&quot;pair&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span>
                <span class="p">]))</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span></div>

<div class="viewcode-block" id="ICoxpFile.plot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.ICoxpFile.plot">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Barplot with average values.&quot;&quot;&quot;</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;average&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;pair&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;spin&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="ICoxpFile.yield_figs"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.ICoxpFile.yield_figs">[docs]</a>    <span class="k">def</span> <span class="nf">yield_figs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function *generates* a predefined list of matplotlib figures with minimal input from the user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="ICoxpFile.write_notebook"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.ICoxpFile.write_notebook">[docs]</a>    <span class="k">def</span> <span class="nf">write_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a jupyter_ notebook to ``nbpath``. If nbpath is None, a temporay file in the current</span>
<span class="sd">        working directory is created. Return path to the notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbformat</span><span class="p">,</span> <span class="n">nbv</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nbformat_nbv_nb</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;icoxp_file = abilab.abiopen(&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;print(icoxp_file)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;icoxp_file.plot();&quot;</span><span class="p">),</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_nb_nbpath</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nbpath</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="LobsterDoscarFile"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.LobsterDoscarFile">[docs]</a><span class="k">class</span> <span class="nc">LobsterDoscarFile</span><span class="p">(</span><span class="n">_LobsterFile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Total and partial dos extracted from lobster DOSCAR.</span>
<span class="sd">    The fermi energy is always at the zero value.</span>

<span class="sd">    .. attribute:: energies</span>

<span class="sd">        List of energies. Shifted such that the Fermi level lies at 0 eV.</span>

<span class="sd">    .. attribute:: total_dos</span>

<span class="sd">        A dictionary with spin as a key (i.e. 0 or 1) and containing the values of the total DOS.</span>
<span class="sd">        Should have the same size as energies.</span>

<span class="sd">    .. attribute:: pdos</span>

<span class="sd">        A dictionary with the values of the projected DOS.</span>
<span class="sd">        The dictionary should have the following nested keys: the index of the site (0-based),</span>
<span class="sd">        the string representing the projected orbital (e.g. &quot;4p_x&quot;), the spin (i.e. 0 or 1).</span>
<span class="sd">        Each dictionary should contain a numpy array with a list of DOS values with the</span>
<span class="sd">        same size as energies.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="LobsterDoscarFile.from_file"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.LobsterDoscarFile.from_file">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates an instance from the DOSCAR.lobster file.</span>
<span class="sd">        Accepts gzipped files.</span>

<span class="sd">        Args:</span>
<span class="sd">            filepath: path to the DOSCAR.lobster.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A LobsterDoscarFile.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">zopen</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">dos_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

        <span class="n">new</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

        <span class="n">new</span><span class="o">.</span><span class="n">nsites</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dos_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">n_energies</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dos_data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">new</span><span class="o">.</span><span class="n">fermie</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dos_data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">])</span>

        <span class="n">n_spin</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dos_data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">else</span> <span class="mi">2</span>
        <span class="n">spins</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">][:</span><span class="n">n_spin</span><span class="p">]</span>

        <span class="c1"># extract np array for total dos</span>
        <span class="n">tdos_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">((</span><span class="n">d</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">dos_data</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">6</span><span class="o">+</span><span class="n">n_energies</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">()),</span>
                                <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n_energies</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">n_spin</span><span class="p">))</span>

        <span class="n">new</span><span class="o">.</span><span class="n">energies</span> <span class="o">=</span> <span class="n">tdos_data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">new</span><span class="o">.</span><span class="n">total_dos</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i_spin</span><span class="p">,</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spins</span><span class="p">):</span>
            <span class="n">new</span><span class="o">.</span><span class="n">total_dos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span> <span class="o">=</span> <span class="n">tdos_data</span><span class="p">[:,</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">i_spin</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">new</span><span class="o">.</span><span class="n">pdos</span> <span class="o">=</span> <span class="n">tree</span><span class="p">()</span>
        <span class="n">new</span><span class="o">.</span><span class="n">type_of_index</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># read partial doses</span>
        <span class="k">for</span> <span class="n">i_site</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">new</span><span class="o">.</span><span class="n">nsites</span><span class="p">):</span>
            <span class="n">i_first_line</span> <span class="o">=</span> <span class="mi">5</span><span class="o">+</span><span class="p">(</span><span class="n">n_energies</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">i_site</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># read orbitals</span>
            <span class="c1"># 6.01503759     -14.03508772   401       2.29842595       1.00000000; Z= 31; 4s 4p_y 4p_z 4p_x</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="n">dos_data</span><span class="p">[</span><span class="n">i_first_line</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
            <span class="n">orbitals</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">el</span> <span class="o">=</span> <span class="n">Element</span><span class="o">.</span><span class="n">from_Z</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
            <span class="n">new</span><span class="o">.</span><span class="n">type_of_index</span><span class="p">[</span><span class="n">i_site</span><span class="p">]</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">symbol</span>

            <span class="c1"># extract np array for partial dos</span>
            <span class="n">pdos_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">((</span><span class="n">d</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">dos_data</span><span class="p">[</span><span class="n">i_first_line</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i_first_line</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">n_energies</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">()),</span>
                <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n_energies</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="n">n_spin</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">orbitals</span><span class="p">)))</span>

            <span class="k">for</span> <span class="n">i_orb</span><span class="p">,</span> <span class="n">orb</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">orbitals</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i_spin</span><span class="p">,</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spins</span><span class="p">):</span>
                    <span class="n">new</span><span class="o">.</span><span class="n">pdos</span><span class="p">[</span><span class="n">i_site</span><span class="p">][</span><span class="n">orb</span><span class="p">][</span><span class="n">spin</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdos_data</span><span class="p">[:,</span> <span class="n">i_spin</span><span class="o">+</span><span class="n">n_spin</span><span class="o">*</span><span class="n">i_orb</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">new</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new</span><span class="o">.</span><span class="n">total_dos</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new</span></div>

<div class="viewcode-block" id="LobsterDoscarFile.to_string"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.LobsterDoscarFile.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation with Verbosity level `verbose`.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Number of energies: </span><span class="si">%d</span><span class="s2">, from </span><span class="si">%.3f</span><span class="s2"> to </span><span class="si">%.3f</span><span class="s2"> (eV) with E_fermi set to 0 (was </span><span class="si">%.3f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;nsppol: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Number of sites in projected DOS: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdos</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i_site</span><span class="p">,</span> <span class="n">dsite</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdos</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> --&gt; {</span><span class="si">%s</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i_site</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dsite</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="LobsterDoscarFile.yield_figs"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.LobsterDoscarFile.yield_figs">[docs]</a>    <span class="k">def</span> <span class="nf">yield_figs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function *generates* a predefined list of matplotlib figures with minimal input from the user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">site_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsites</span><span class="p">):</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_pdos_site</span><span class="p">(</span><span class="n">site_index</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="LobsterDoscarFile.plot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.LobsterDoscarFile.plot">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot DOS.</span>

<span class="sd">        Args:</span>
<span class="sd">            spin:</span>
<span class="sd">            exchange_xy: True to exchange x-y axis.</span>
<span class="sd">            ax: |matplotlib-Axes| or None if a new figure should be created.</span>
<span class="sd">            fontsize: fontsize for legends and titles</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">spins</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">)</span> <span class="k">if</span> <span class="n">spin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">spin</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="n">spins</span><span class="p">:</span>
            <span class="n">opts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span> <span class="s2">&quot;ls&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">}</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> \
                   <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span> <span class="s2">&quot;ls&quot;</span><span class="p">:</span> <span class="s2">&quot;--&quot;</span><span class="p">}</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">spin_sign</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">,</span> <span class="n">spin_sign</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_dos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">ys</span><span class="p">,</span> <span class="n">xs</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spin2tex</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">opts</span><span class="p">)</span>

        <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$E - E_f\;(eV)$&quot;</span><span class="p">,</span> <span class="s2">&quot;DOS&quot;</span>
        <span class="n">set_ax_xylabels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="LobsterDoscarFile.plot_pdos_site"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.LobsterDoscarFile.plot_pdos_site">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_pdos_site</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">site_index</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot projected DOS</span>

<span class="sd">        Args:</span>
<span class="sd">            site_index</span>
<span class="sd">            exchange_xy: True to exchange x-y axis.</span>
<span class="sd">            ax: |matplotlib-Axes| or None if a new figure should be created.</span>
<span class="sd">            fontsize: fontsize for legends and titles</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Handle list of sites.</span>
        <span class="k">if</span> <span class="n">duck</span><span class="o">.</span><span class="n">is_listlike</span><span class="p">(</span><span class="n">site_index</span><span class="p">):</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">site_index</span><span class="p">)</span>
            <span class="n">sharex</span><span class="p">,</span> <span class="n">sharey</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">sharex</span><span class="p">,</span> <span class="n">sharey</span> <span class="o">=</span> <span class="n">sharey</span><span class="p">,</span> <span class="n">sharex</span>
            <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                    <span class="n">sharex</span><span class="o">=</span><span class="n">sharex</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">sharey</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># Recursive call.</span>
            <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ax_list</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">site_index</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_pdos_site</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="n">exchange_xy</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">fig</span>

        <span class="c1"># Single site.</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># self.pdos[site_index][&quot;4p_x&quot;][spin]</span>
        <span class="k">for</span> <span class="n">orb</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdos</span><span class="p">[</span><span class="n">site_index</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                <span class="n">spin_sign</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">,</span> <span class="n">spin_sign</span> <span class="o">*</span> <span class="n">d</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">ys</span><span class="p">,</span> <span class="n">xs</span>
                <span class="n">n</span><span class="p">,</span> <span class="n">lm</span> <span class="o">=</span> <span class="n">orb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">orb</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_orbs</span><span class="p">[</span><span class="n">lm</span><span class="p">]</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;$</span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2">_{</span><span class="si">%s</span><span class="s2">}$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type_of_index</span><span class="p">[</span><span class="n">site_index</span><span class="p">],</span> <span class="n">site_index</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;latex&quot;</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;style&quot;</span><span class="p">])</span>

        <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$E - E_f\;(eV)$&quot;</span><span class="p">,</span> <span class="s2">&quot;PDOS&quot;</span>
        <span class="n">set_ax_xylabels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="LobsterDoscarFile.write_notebook"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.LobsterDoscarFile.write_notebook">[docs]</a>    <span class="k">def</span> <span class="nf">write_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a jupyter_ notebook to ``nbpath``. If nbpath is None, a temporay file in the current</span>
<span class="sd">        working directory is created. Return path to the notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbformat</span><span class="p">,</span> <span class="n">nbv</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nbformat_nbv_nb</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;lobdos = abilab.abiopen(&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;print(lobdos)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;lobdos.plot();&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;pdos.plot_pdos_site(site_index=[0,]);&quot;</span><span class="p">),</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_nb_nbpath</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nbpath</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="LobsterInput"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.LobsterInput">[docs]</a><span class="k">class</span> <span class="nc">LobsterInput</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object stores the basic variables for a Lobster input and generates the lobsterin file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">accepted_basis_sets</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;bunge&quot;</span><span class="p">,</span> <span class="s2">&quot;koga&quot;</span><span class="p">,</span> <span class="s2">&quot;pbevaspfit2015&quot;</span><span class="p">}</span>

    <span class="n">available_advanced_options</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;basisRotation&quot;</span><span class="p">,</span> <span class="s2">&quot;writeBasisFunctions&quot;</span><span class="p">,</span> <span class="s2">&quot;onlyReadVasprun.xml&quot;</span><span class="p">,</span> <span class="s2">&quot;noMemoryMappedFiles&quot;</span><span class="p">,</span>
                                  <span class="s2">&quot;skipPAWOrthonormalityTest&quot;</span><span class="p">,</span> <span class="s2">&quot;doNotIgnoreExcessiveBands&quot;</span><span class="p">,</span> <span class="s2">&quot;doNotUseAbsoluteSpilling&quot;</span><span class="p">,</span>
                                  <span class="s2">&quot;skipReOrthonormalization&quot;</span><span class="p">,</span> <span class="s2">&quot;doNotOrthogonalizeBasis&quot;</span><span class="p">,</span> <span class="s2">&quot;forceV1HMatrix&quot;</span><span class="p">,</span>
                                  <span class="s2">&quot;noSymmetryCorrection&quot;</span><span class="p">,</span> <span class="s2">&quot;symmetryDetectionPrecision&quot;</span><span class="p">,</span> <span class="s2">&quot;useOriginalTetrahedronMethod&quot;</span><span class="p">,</span>
                                  <span class="s2">&quot;useDecimalPlaces&quot;</span><span class="p">,</span> <span class="s2">&quot;forceEnergyRange&quot;</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">basis_set</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">basis_functions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_orbitals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">atom_pairs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dist_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">orbitalwise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">start_en</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_en</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">en_steps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gaussian_smearing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">bwdf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">advanced_options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args</span>
<span class="sd">            basis_set: String containing one of the possible basis sets available: bunge, koga, pbevaspfit2015</span>
<span class="sd">            basis_functions: list of strings giving the symbol of each atom and the basis functions: &quot;Ga 4s 4p&quot;</span>
<span class="sd">            include_orbitals: string containing which types of valence orbitals to use. E.g. &quot;s p d&quot;</span>
<span class="sd">            atom_pairs: list of tuples containing the couple of elements for which the COHP analysis will be</span>
<span class="sd">             performed. Index is 1-based.</span>
<span class="sd">            dist_range: list of tuples, each containing the minimum and maximum distance (in Angstrom) used to</span>
<span class="sd">             automatically generate atom pairs. Each tuple can also contain two atomic symbol to restric the match to</span>
<span class="sd">             the specified elements. examples: (0.5, 1.5) or (0.5, 1.5, &#39;Zn&#39;, &#39;O&#39;)</span>
<span class="sd">            start_en: starting energy with respect to the Fermi level (in eV)</span>
<span class="sd">            end_en: ending energy with respect to the Fermi level (in eV)</span>
<span class="sd">            en_steps: number of energy increments</span>
<span class="sd">            gaussian_smearing: smearing in eV when using gaussian broadening</span>
<span class="sd">            bwdf: enables the bond-weighted distribution function (BWDF). Value is the binning interval</span>
<span class="sd">            advanced_options: dict with additional advanced options. See lobster user guide for further details</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">basis_set</span> <span class="ow">and</span> <span class="n">basis_set</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">accepted_basis_sets</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wrong basis set </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">basis_set</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basis_set</span> <span class="o">=</span> <span class="n">basis_set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basis_functions</span> <span class="o">=</span> <span class="n">basis_functions</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">include_orbitals</span> <span class="o">=</span> <span class="n">include_orbitals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atom_pairs</span> <span class="o">=</span> <span class="n">atom_pairs</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dist_range</span> <span class="o">=</span> <span class="n">dist_range</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orbitalwise</span> <span class="o">=</span> <span class="n">orbitalwise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_en</span> <span class="o">=</span> <span class="n">start_en</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_en</span> <span class="o">=</span> <span class="n">end_en</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">en_steps</span> <span class="o">=</span> <span class="n">en_steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gaussian_smearing</span> <span class="o">=</span> <span class="n">gaussian_smearing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bwdf</span> <span class="o">=</span> <span class="n">bwdf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">advanced_options</span> <span class="o">=</span> <span class="n">advanced_options</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">opt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_advanced_options</span> <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">advanced_options</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown adavanced options&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_basis_functions_from_abinit_pseudos</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts the basis function used from the PAW abinit pseudopotentials</span>

<span class="sd">        Args:</span>
<span class="sd">            pseudos: a list of Pseudos objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">basis_functions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pseudos</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;valence_states&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Only PAW pseudos in PAWXML format are supported by Lobster interface.&quot;</span><span class="p">)</span>
            <span class="n">el</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">symbol</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">vs</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">OrbitalType</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">vs</span><span class="p">[</span><span class="s1">&#39;l&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                                     <span class="k">for</span> <span class="n">vs</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">valence_states</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;n&#39;</span> <span class="ow">in</span> <span class="n">vs</span><span class="p">)</span>
            <span class="n">basis_functions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">basis_functions</span>

<div class="viewcode-block" id="LobsterInput.set_basis_functions_from_abinit_pseudos"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.LobsterInput.set_basis_functions_from_abinit_pseudos">[docs]</a>    <span class="k">def</span> <span class="nf">set_basis_functions_from_abinit_pseudos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the basis function used from the PAW abinit pseudopotentials</span>

<span class="sd">        Args:</span>
<span class="sd">            pseudos: a list of Pseudos objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">basis_functions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_basis_functions_from_abinit_pseudos</span><span class="p">(</span><span class="n">pseudos</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">basis_functions</span> <span class="o">=</span> <span class="n">basis_functions</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_basis_functions_from_potcar</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">potcar</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts the basis function used from a POTCAR.</span>

<span class="sd">        Args:</span>
<span class="sd">            potcar: a pymatgen.io.vasp.inputs.Potcar object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">basis_functions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">potcar</span><span class="p">:</span>
            <span class="n">basis_functions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">element</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">vs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">vs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">vs</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">electron_configuration</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">basis_functions</span>

<div class="viewcode-block" id="LobsterInput.set_basis_functions_from_potcar"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.LobsterInput.set_basis_functions_from_potcar">[docs]</a>    <span class="k">def</span> <span class="nf">set_basis_functions_from_potcar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">potcar</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the basis function used from a POTCAR.</span>

<span class="sd">        Args:</span>
<span class="sd">            potcar: a pymatgen.io.vasp.inputs.Potcar object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">basis_functions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_basis_functions_from_potcar</span><span class="p">(</span><span class="n">potcar</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">basis_functions</span> <span class="o">=</span> <span class="n">basis_functions</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

<div class="viewcode-block" id="LobsterInput.to_string"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.LobsterInput.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_set</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;basisSet </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_set</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">bf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_functions</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;basisFunctions </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bf</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">ap</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_pairs</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;cohpBetween atom </span><span class="si">{}</span><span class="s2"> atom </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">ap</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbitalwise</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot; orbitalwise&quot;</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">dr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_range</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;cohpGenerator from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot; type </span><span class="si">{}</span><span class="s2"> type </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dr</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbitalwise</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot; orbitalwise&quot;</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_en</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;COHPStartEnergy </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_en</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_en</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;COHPEndEnergy </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_en</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">en_steps</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;COHPSteps </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">en_steps</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaussian_smearing</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;gaussianSmearingWidth </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gaussian_smearing</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bwdf</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;BWDF </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bwdf</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">advanced_options</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="LobsterInput.from_dir"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.LobsterInput.from_dir">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dir</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dE</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates an instance of the class based on the output folder of a DFT calculation.</span>
<span class="sd">        Reads the information from the pseudopotentials in order to determine the</span>
<span class="sd">        basis functions.</span>

<span class="sd">        Args:</span>
<span class="sd">            dirpath: the path to the calculation directory. For abinit it should contain the</span>
<span class="sd">                &quot;files&quot; file and GSR file, for vasp it should contain the vasprun.xml and the POTCAR.</span>
<span class="sd">            dE: The spacing of the energy sampling in eV.</span>
<span class="sd">            kwargs: the inputs for the init method, except for basis_functions, start_en,</span>
<span class="sd">                end_en and en_steps.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A LobsterInput.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Try to determine the code used for the calculation</span>
        <span class="n">dft_code</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="s1">&#39;vasprun.xml&#39;</span><span class="p">)):</span>
            <span class="n">dft_code</span> <span class="o">=</span> <span class="s2">&quot;vasp&quot;</span>
            <span class="n">vr</span> <span class="o">=</span> <span class="n">Vasprun</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="s1">&#39;vasprun.xml&#39;</span><span class="p">))</span>

            <span class="n">en_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">bands_spin</span> <span class="k">for</span> <span class="n">bands_spin</span> <span class="ow">in</span> <span class="n">vr</span><span class="o">.</span><span class="n">eigenvalues</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
            <span class="n">en_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">bands_spin</span> <span class="k">for</span> <span class="n">bands_spin</span> <span class="ow">in</span> <span class="n">vr</span><span class="o">.</span><span class="n">eigenvalues</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
            <span class="n">fermie</span> <span class="o">=</span> <span class="n">vr</span><span class="o">.</span><span class="n">efermi</span>

            <span class="n">potcar</span> <span class="o">=</span> <span class="n">Potcar</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="s1">&#39;POTCAR&#39;</span><span class="p">))</span>
            <span class="n">basis_functions</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_basis_functions_from_potcar</span><span class="p">(</span><span class="n">potcar</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="s1">&#39;*.files&#39;</span><span class="p">)):</span>
            <span class="n">dft_code</span> <span class="o">=</span> <span class="s2">&quot;abinit&quot;</span>
            <span class="n">ff</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="s1">&#39;*.files&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">files_file</span><span class="p">:</span>
                <span class="n">ff_lines</span> <span class="o">=</span> <span class="n">files_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">out_path</span> <span class="o">=</span> <span class="n">ff_lines</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">out_path</span><span class="p">):</span>
                <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">out_path</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">GsrFile</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">out_path</span> <span class="o">+</span> <span class="s1">&#39;_GSR.nc&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">gsr</span><span class="p">:</span>
                <span class="n">en_min</span> <span class="o">=</span> <span class="n">gsr</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">eigens</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="n">en_max</span> <span class="o">=</span> <span class="n">gsr</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">eigens</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">fermie</span> <span class="o">=</span> <span class="n">gsr</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">fermie</span>

            <span class="n">pseudo_paths</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">ff_lines</span><span class="p">[</span><span class="mi">5</span><span class="p">:]:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">l</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
                        <span class="n">l</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
                    <span class="n">pseudo_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>

            <span class="n">pseudos</span> <span class="o">=</span> <span class="p">[</span><span class="n">Pseudo</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pseudo_paths</span><span class="p">]</span>

            <span class="n">basis_functions</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_basis_functions_from_abinit_pseudos</span><span class="p">(</span><span class="n">pseudos</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unable to determine the code used in dir </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dirpath</span><span class="p">))</span>

        <span class="n">start_en</span> <span class="o">=</span> <span class="n">en_min</span> <span class="o">+</span> <span class="n">fermie</span>
        <span class="n">end_en</span> <span class="o">=</span> <span class="n">en_max</span> <span class="o">-</span> <span class="n">fermie</span>

        <span class="c1"># shift the energies so that are divisible by dE and the value for the fermi level (0 eV) is included</span>
        <span class="n">start_en</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">start_en</span> <span class="o">/</span> <span class="n">dE</span><span class="p">)</span> <span class="o">*</span> <span class="n">dE</span>
        <span class="n">end_en</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">end_en</span> <span class="o">/</span> <span class="n">dE</span><span class="p">)</span> <span class="o">*</span> <span class="n">dE</span>

        <span class="n">en_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">end_en</span> <span class="o">-</span> <span class="n">start_en</span><span class="p">)</span> <span class="o">/</span> <span class="n">dE</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">basis_functions</span><span class="o">=</span><span class="n">basis_functions</span><span class="p">,</span> <span class="n">start_en</span><span class="o">=</span><span class="n">start_en</span><span class="p">,</span> <span class="n">end_en</span><span class="o">=</span><span class="n">end_en</span><span class="p">,</span> <span class="n">en_steps</span><span class="o">=</span><span class="n">en_steps</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="LobsterInput.write"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.LobsterInput.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirpath</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the input file &#39;lobsterin&#39; in dirpath.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dirpath</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span>

        <span class="c1"># Write the input file.</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="s1">&#39;lobsterin&#39;</span><span class="p">),</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="LobsterAnalyzer"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.LobsterAnalyzer">[docs]</a><span class="k">class</span> <span class="nc">LobsterAnalyzer</span><span class="p">(</span><span class="n">NotebookWriter</span><span class="p">):</span>

<div class="viewcode-block" id="LobsterAnalyzer.from_dir"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.LobsterAnalyzer.from_dir">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dir</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates an instance of the class based on the output folder of a DFT calculation.</span>

<span class="sd">        Args:</span>
<span class="sd">            dirpath: the path to the calculation directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dirpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span>
        <span class="n">k2ext</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;coop_path&quot;</span><span class="p">:</span> <span class="s2">&quot;COOPCAR.lobster&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cohp_path&quot;</span><span class="p">:</span> <span class="s2">&quot;COHPCAR.lobster&quot;</span><span class="p">,</span>
            <span class="s2">&quot;icohp_path&quot;</span><span class="p">:</span> <span class="s2">&quot;ICOHPLIST.lobster&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lobdos_path&quot;</span><span class="p">:</span> <span class="s2">&quot;DOSCAR.lobster&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">k2ext</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">k2ext</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Handle [prefix]COHPCAR.lobster</span>
            <span class="n">p</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">*</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
            <span class="c1"># Treat [prefix]COHPCAR.lobster.gz</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">paths</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">*</span><span class="si">%s</span><span class="s2">.gz&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>
                <span class="n">paths</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">paths</span><span class="p">:</span>
                <span class="c1">#print(k, &quot;--&gt;&quot;, paths)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Found multiple files matching glob pattern: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">paths</span><span class="p">))</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">coop_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cohp_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">icohp_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lobdos_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coop</span> <span class="o">=</span> <span class="n">CoxpFile</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">coop_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">coop_path</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cohp</span> <span class="o">=</span> <span class="n">CoxpFile</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">cohp_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">cohp_path</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">icohp</span> <span class="o">=</span> <span class="n">ICoxpFile</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">icohp_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">icohp_path</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doscar</span> <span class="o">=</span> <span class="n">LobsterDoscarFile</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">lobdos_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">lobdos_path</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dirpath</span> <span class="o">=</span> <span class="n">dirpath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span>

        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;coop&quot;</span><span class="p">,</span> <span class="s2">&quot;cohp&quot;</span><span class="p">,</span> <span class="s2">&quot;icohp&quot;</span><span class="p">,</span> <span class="s2">&quot;doscar&quot;</span><span class="p">):</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">nsppol</span>
                <span class="k">break</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

<div class="viewcode-block" id="LobsterAnalyzer.to_string"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.LobsterAnalyzer.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation with verbosity level `verbose`.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
        <span class="k">for</span> <span class="n">aname</span><span class="p">,</span> <span class="n">header</span> <span class="ow">in</span> <span class="p">[(</span><span class="s2">&quot;coop&quot;</span><span class="p">,</span> <span class="s2">&quot;COOP File&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;cohp&quot;</span><span class="p">,</span> <span class="s2">&quot;COHP File&quot;</span><span class="p">),</span>
                              <span class="p">(</span><span class="s2">&quot;icohp&quot;</span><span class="p">,</span> <span class="s2">&quot;ICHOHPLIST File&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;doscar&quot;</span><span class="p">,</span> <span class="s2">&quot;Lobster DOSCAR&quot;</span><span class="p">),]:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
            <span class="n">app</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">))</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="LobsterAnalyzer.yield_figs"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.LobsterAnalyzer.yield_figs">[docs]</a>    <span class="k">def</span> <span class="nf">yield_figs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function *generates* a predefined list of matplotlib figures with minimal input from the user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="LobsterAnalyzer.plot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.LobsterAnalyzer.plot">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;coop&quot;</span><span class="p">,</span> <span class="s2">&quot;cohp&quot;</span><span class="p">,</span> <span class="s2">&quot;doscar&quot;</span><span class="p">),</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot COOP + COHP + DOSCAR.</span>

<span class="sd">        Args:</span>
<span class="sd">            entries: &quot;cohp&quot; to plot COHP, &quot;coop&quot; for COOP</span>
<span class="sd">            spin:</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">entries</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>

        <span class="n">axmat</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">),</span>
                                              <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">spins</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">)</span> <span class="k">if</span> <span class="n">spin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">spin</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="n">spins</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">axmat</span><span class="p">[</span><span class="n">spin</span><span class="p">])):</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ix</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">set_visible</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;ylabel&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">set_visible</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;xlabel&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="LobsterAnalyzer.plot_coxp_with_dos"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.LobsterAnalyzer.plot_coxp_with_dos">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_coxp_with_dos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_site_index</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;cohp&quot;</span><span class="p">,</span> <span class="n">with_orbitals</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot COHP (COOP) for all sites in from_site_index and Lobster DOS on len(from_site_index) + 1 subfigures.</span>

<span class="sd">        Args:</span>
<span class="sd">            from_site_index: List of site indices for COHP (COOP)</span>
<span class="sd">            what: &quot;cohp&quot; to plot COHP, &quot;coop&quot; for COOP</span>
<span class="sd">            with_orbitals: True if orbital projections are wanted.</span>
<span class="sd">            exchange_xy: True to exchange x-y axis. By default, use x-axis for DOS-like quantities.</span>
<span class="sd">            fontsize: fontsize for legends and titles</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">from_site_index</span> <span class="o">=</span> <span class="n">from_site_index</span> <span class="k">if</span> <span class="n">duck</span><span class="o">.</span><span class="n">is_listlike</span><span class="p">(</span><span class="n">from_site_index</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">from_site_index</span><span class="p">]</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">from_site_index</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">sharex</span><span class="p">,</span> <span class="n">sharey</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">sharex</span><span class="p">,</span> <span class="n">sharey</span> <span class="o">=</span> <span class="n">sharey</span><span class="p">,</span> <span class="n">sharex</span>
        <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                                <span class="n">sharex</span><span class="o">=</span><span class="n">sharex</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">sharey</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax_list</span> <span class="o">=</span> <span class="n">ax_list</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="c1"># Plot (COHP|COOP) (total|projections) on the first ncols - 1 axes.</span>
        <span class="n">coxp_file</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ax_list</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">from_site_index</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">with_orbitals</span><span class="p">:</span>
                <span class="n">coxp_file</span><span class="o">.</span><span class="n">plot_site_pairs_partial</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="n">exchange_xy</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">coxp_file</span><span class="o">.</span><span class="n">plot_site_pairs_total</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="n">exchange_xy</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ix</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">set_visible</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;ylabel&quot;</span><span class="p">)</span>
                <span class="c1">#set_visible(ax, False, &quot;xlabel&quot;)</span>

        <span class="c1"># Plot DOS on the last ax.</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">ax_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doscar</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="n">exchange_xy</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">set_visible</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;ylabel&quot;</span> <span class="k">if</span> <span class="n">exchange_xy</span> <span class="k">else</span> <span class="s2">&quot;xlabel&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="c1">#@add_fig_kwargs</span>
    <span class="c1">#def plot_with_ebands(self, ebands, entries=(&quot;coop&quot;, &quot;cohp&quot;, &quot;doscar&quot;), **kwargs):</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    Plot bands + COHP, COOP, DOSCAR.</span>

    <span class="c1">#    Args:</span>
    <span class="c1">#        ebands:</span>
    <span class="c1">#        entries: &quot;cohp&quot; to plot COHP, &quot;coop&quot; for COOP</span>
    <span class="c1">#        fontsize: fontsize for legends and titles</span>

    <span class="c1">#    Returns: |matplotlib-Figure|</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    ebands = ElectronBands.as_ebands(ebands)</span>

    <span class="c1">#    entries = [e for e in entries if getattr(self, e, None)]</span>
    <span class="c1">#    if not entries: return None</span>

    <span class="c1">#    import matplotlib.pyplot as plt</span>
    <span class="c1">#    from matplotlib.gridspec import GridSpec</span>
    <span class="c1">#    fig = plt.figure()</span>

    <span class="c1">#    # Build grid.</span>
    <span class="c1">#    nrows, ncols = self.nsppol, len(entries) + 1</span>
    <span class="c1">#    width_ratios = [2] + [1] * len(entries)</span>
    <span class="c1">#    gspec = GridSpec(nrows=nrows, ncols=ncols, width_ratios=width_ratios, wspace=0.05)</span>

    <span class="c1">#    # Bands and DOS will share the y-axis</span>
    <span class="c1">#    axmat = np.array((nrows, ncols), dtype=object)</span>
    <span class="c1">#    for icol in range(ncols):</span>
    <span class="c1">#        for irow in range(nrows):</span>
    <span class="c1">#            axmat[irow, icol] = plt.subplot(gspec[irow, icol], sharey=None if irow == 0 else axmat[irow, icol-1])</span>

    <span class="c1">#    #axmat, fig, plt = get_axarray_fig_plt(None, nrows=self.nsppol, ncols=len(entries) + 1,</span>
    <span class="c1">#    #                                        sharex=False, sharey=True, squeeze=False)</span>

    <span class="c1">#    for spin in range(self.nsppol):</span>
    <span class="c1">#        for ix, (label, ax) in enumerate(zip(entries, axmat[spin, :])):</span>
    <span class="c1">#            if ix == 0:</span>
    <span class="c1">#                ebands.plot(spin=spin, e0=&quot;fermie&quot;, ax=ax, show=False)</span>
    <span class="c1">#            else:</span>
    <span class="c1">#                obj = getattr(self, label)</span>
    <span class="c1">#                obj.plot(ax=ax, spin=spin, exchange_xy=True, show=False)</span>

    <span class="c1">#            if ix != 0:</span>
    <span class="c1">#                set_visible(ax, False, &quot;ylabel&quot;)</span>
    <span class="c1">#            if self.nsppol == 2 and spin == 0:</span>
    <span class="c1">#                set_visible(ax, False, &quot;xlabel&quot;)</span>

    <span class="c1">#    return fig</span>

<div class="viewcode-block" id="LobsterAnalyzer.write_notebook"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.lobster.LobsterAnalyzer.write_notebook">[docs]</a>    <span class="k">def</span> <span class="nf">write_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a jupyter_ notebook to ``nbpath``. If nbpath is None, a temporay file in the current</span>
<span class="sd">        working directory is created. Return path to the notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbformat</span><span class="p">,</span> <span class="n">nbv</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nbformat_nbv_nb</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;lobana = abilab.LobsterAnalyzer.from_dir(dirpath=&#39;</span><span class="si">%s</span><span class="s2">&#39;, prefix=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dirpath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;print(lobana)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;lobana.plot();&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;lobana.plot_coxp_with_dos(from_site_index=[0,], what=&#39;cohp&#39;, with_orbitals=False);&quot;</span><span class="p">),</span>
            <span class="c1">#nbv.new_code_cell(&quot;lobana.plot_with_ebands(ebands=&#39;path_to_file_with_ebands&#39;);&quot;),</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_nb_nbpath</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nbpath</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, M. Giantomassi and the AbiPy group.
      <span class="lastupdated">
        Last updated on Jun 16, 2021.
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>