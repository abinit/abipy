

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>abipy.electrons.bse &mdash; abipy 0.9.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/jupyter-sphinx.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/thebelab.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/my_style.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-dataframe.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-rendered-html.css" type="text/css" />

  
  

  
  

  

  
    <script type="text/javascript" src="https://cdn.plot.ly/plotly-latest.min.js"></script> 
    
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/thebelab-helper.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> abipy
          

          
          </a>

          
            
            
              <div class="version">
                0.9.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../features.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Getting AbiPy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../zzbiblio.html">Bibliography</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../scripts/index.html">Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../graphical_interface.html">Graphical interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gallery/index.html">AbiPy Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../postprocessing_howto.html">Post-processing How-To</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../workflows/taskmanager.html">TaskManager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../workflows/manager_examples.html">Manager Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../flow_gallery/index.html">Flow Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../flows_howto.html">Flows How-To</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../coding_guide.html">Coding guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html">Documenting AbiPy</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">abipy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>abipy.electrons.bse</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for abipy.electrons.bse</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: utf-8</span>
<span class="sd">&quot;&quot;&quot;Classes for the analysis of BSE calculations&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">monty.functools</span> <span class="kn">import</span> <span class="n">lazy_property</span>
<span class="kn">from</span> <span class="nn">monty.string</span> <span class="kn">import</span> <span class="n">marquee</span><span class="p">,</span> <span class="n">is_string</span>
<span class="kn">from</span> <span class="nn">abipy.tools.plotting</span> <span class="kn">import</span> <span class="n">add_fig_kwargs</span><span class="p">,</span> <span class="n">get_ax_fig_plt</span><span class="p">,</span> <span class="n">get_axarray_fig_plt</span>
<span class="kn">from</span> <span class="nn">abipy.core.func1d</span> <span class="kn">import</span> <span class="n">Function1D</span>
<span class="kn">from</span> <span class="nn">abipy.core.kpoints</span> <span class="kn">import</span> <span class="n">Kpoint</span><span class="p">,</span> <span class="n">KpointList</span>
<span class="kn">from</span> <span class="nn">abipy.core.mixins</span> <span class="kn">import</span> <span class="n">AbinitNcFile</span><span class="p">,</span> <span class="n">Has_Structure</span><span class="p">,</span> <span class="n">NotebookWriter</span>
<span class="kn">from</span> <span class="nn">abipy.iotools</span> <span class="kn">import</span> <span class="n">ETSF_Reader</span>
<span class="kn">from</span> <span class="nn">abipy.tools.plotting</span> <span class="kn">import</span> <span class="n">set_axlims</span>
<span class="kn">from</span> <span class="nn">abipy.tools</span> <span class="kn">import</span> <span class="n">duck</span>
<span class="kn">from</span> <span class="nn">abipy.abio.robots</span> <span class="kn">import</span> <span class="n">Robot</span>
<span class="kn">from</span> <span class="nn">abipy.electrons.ebands</span> <span class="kn">import</span> <span class="n">RobotWithEbands</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;DielectricFunction&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MdfFile&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MdfReader&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MdfPlotter&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MultipleMdfPlotter&quot;</span><span class="p">,</span>
<span class="p">]</span>


<span class="c1"># Deprecated: should be rewritten from scratch.</span>
<span class="k">class</span> <span class="nc">_DielectricTensor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object stores the frequency-dependent macroscopic dielectric tensor</span>
<span class="sd">    obtained from the dielectric functions for different q-directions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mdf</span><span class="p">,</span> <span class="n">structure</span><span class="p">):</span>
        <span class="n">nfreq</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mdf</span><span class="o">.</span><span class="n">wmesh</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_wmesh</span> <span class="o">=</span> <span class="n">mdf</span><span class="o">.</span><span class="n">wmesh</span>

        <span class="c1"># Transform mdf emacros_q to numpy array</span>
        <span class="n">all_emacros</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">emacro</span> <span class="ow">in</span> <span class="n">mdf</span><span class="o">.</span><span class="n">emacros_q</span><span class="p">:</span>
            <span class="n">all_emacros</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">emacro</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="n">all_emacros</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_emacros</span><span class="p">)</span>

        <span class="c1"># One tensor for each frequency</span>
        <span class="n">all_tensors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ifrq</span><span class="p">,</span> <span class="n">freq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mdf</span><span class="o">.</span><span class="n">wmesh</span><span class="p">):</span>
            <span class="n">tensor</span> <span class="o">=</span> <span class="n">_SymmetricTensor</span><span class="o">.</span><span class="n">from_directions</span><span class="p">(</span><span class="n">mdf</span><span class="o">.</span><span class="n">qfrac_coords</span><span class="p">,</span> <span class="n">all_emacros</span><span class="p">[:,</span><span class="n">ifrq</span><span class="p">],</span>
                                                     <span class="n">structure</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">,</span> <span class="n">space</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
            <span class="n">all_tensors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_all_tensors</span> <span class="o">=</span> <span class="n">all_tensors</span>

    <span class="k">def</span> <span class="nf">to_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">red_coords</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return |numpy-array| with a copy of the data.</span>

<span class="sd">        Args:</span>
<span class="sd">            red_coords: True for tensors in reduced coordinates else Cartesian.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tensor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_tensors</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">red_coords</span><span class="p">:</span>
                <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tensor</span><span class="o">.</span><span class="n">reduced_tensor</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tensor</span><span class="o">.</span><span class="n">cartesian_tensor</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">symmetrize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Symmetrize the tensor using the symmetry operations in structure.</span>
<span class="sd">        Change the object in place.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">tensor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_tensors</span><span class="p">:</span>
            <span class="n">tensor</span><span class="o">.</span><span class="n">symmetrize</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_func1d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">red_coords</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of Function.&quot;&quot;&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_array</span><span class="p">(</span><span class="n">red_coords</span><span class="p">)</span>
        <span class="n">all_funcs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">all_funcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Function1D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wmesh</span><span class="p">,</span> <span class="n">table</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">all_funcs</span>

    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot all the components of the tensor.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: |matplotlib-Axes| or None if a new figure should be created.</span>

<span class="sd">        ==============  ==============================================================</span>
<span class="sd">        kwargs          Meaning</span>
<span class="sd">        ==============  ==============================================================</span>
<span class="sd">        red_coords      True to plot the reduced coordinate tensor (Default: True)</span>
<span class="sd">        ==============  ==============================================================</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">red_coords</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;red_coords&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (eV)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Dielectric tensor&#39;</span><span class="p">)</span>

        <span class="c1">#if not kwargs:</span>
        <span class="c1">#    kwargs = {&quot;color&quot;: &quot;black&quot;, &quot;linewidth&quot;: 2.0}</span>

        <span class="c1"># Plot the 6 independent components</span>
        <span class="k">for</span> <span class="n">icomponent</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">icomponent</span><span class="p">,</span> <span class="n">red_coords</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span> <span class="nf">plot_ax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">red_coords</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to plot data on the axis ax.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: |matplotlib-Axes|</span>
<span class="sd">            what: Sequential index of the tensor matrix element.</span>
<span class="sd">            args: Positional arguments passed to ``ax.plot``</span>
<span class="sd">            kwargs: Keyword arguments passed to matplotlib. Accepts also:</span>

<span class="sd">        ==============  ==============================================================</span>
<span class="sd">        kwargs          Meaning</span>
<span class="sd">        ==============  ==============================================================</span>
<span class="sd">        cplx_mode:      string defining the data to print (case-insensitive).</span>
<span class="sd">                        Possible choices are:</span>

<span class="sd">                            - &quot;re&quot;  for real part</span>
<span class="sd">                            - &quot;im&quot; for imaginary part only.</span>
<span class="sd">                            - &quot;abs&#39; for the absolute value</span>

<span class="sd">                        Options can be concated with &quot;-&quot;.</span>
<span class="sd">        ==============  ==============================================================</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extract the function to plot according to qpoint.</span>
        <span class="k">if</span> <span class="n">duck</span><span class="o">.</span><span class="n">is_intlike</span><span class="p">(</span><span class="n">what</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_func1d</span><span class="p">(</span><span class="n">red_coords</span><span class="p">)[</span><span class="nb">int</span><span class="p">(</span><span class="n">what</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know how to handle </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">what</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<div class="viewcode-block" id="DielectricFunction"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.DielectricFunction">[docs]</a><span class="k">class</span> <span class="nc">DielectricFunction</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object stores the frequency-dependent macroscopic dielectric function</span>
<span class="sd">    computed for different q-directions in reciprocal space.</span>

<span class="sd">    .. note:</span>

<span class="sd">        Frequencies are in eV</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">qpoints</span><span class="p">,</span> <span class="n">wmesh</span><span class="p">,</span> <span class="n">emacros_q</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            structure: |Structure| object.</span>
<span class="sd">            qpoints: |KpointList| with the q-points in reduced coordinates.</span>
<span class="sd">            wmesh: Array-like object with the frequency mesh (eV).</span>
<span class="sd">            emacros_q: Iterable with the macroscopic dielectric function for the different q-points.</span>
<span class="sd">            info: Dictionary containing info on the calculation that produced</span>
<span class="sd">                  the results (read from file). It must contain the following keywords:</span>

<span class="sd">                    - &quot;lfe&quot;: True if local field effects are included.</span>
<span class="sd">                    - &quot;calc_type&quot;: string defining the calculation type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wmesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">wmesh</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span> <span class="o">=</span> <span class="n">qpoints</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">emacros_q</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">emacros_q</span><span class="p">,</span> <span class="n">em_avg</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wmesh</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">emq</span> <span class="ow">in</span> <span class="n">emacros_q</span><span class="p">:</span>
            <span class="n">em_avg</span> <span class="o">+=</span> <span class="n">emq</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emacros_q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Function1D</span><span class="p">(</span><span class="n">wmesh</span><span class="p">,</span> <span class="n">emq</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emacros_q</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">emacros_q</span><span class="p">)</span>

        <span class="c1"># Compute the average value.</span>
        <span class="c1"># TODO: One should take into account the star of q, but I need the symops</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emacro_avg</span> <span class="o">=</span> <span class="n">Function1D</span><span class="p">(</span><span class="n">wmesh</span><span class="p">,</span> <span class="n">em_avg</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_qpoints</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

<div class="viewcode-block" id="DielectricFunction.to_string"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.DielectricFunction.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">with_info</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="c1">#app(&quot;calc_type: %s, has_lfe: %s, num_qpoints: %d&quot; % (self.calc_type, self.has_lfe, self.num_qpoints))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;num_qpoints: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_qpoints</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">with_info</span> <span class="ow">or</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterate over (q, em_q).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">itertools</span><span class="o">.</span><span class="n">izip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">emacros_q</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_qpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of q-points.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">qfrac_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;|numpy-array| with the fractional coordinates of the q-points.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="o">.</span><span class="n">frac_coords</span>

    <span class="c1">#@property</span>
    <span class="c1">#def has_lfe(self):</span>
    <span class="c1">#    &quot;&quot;&quot;True if MDF includes local field effects.&quot;&quot;&quot;</span>
    <span class="c1">#    return bool(self.info[&quot;lfe&quot;])</span>

    <span class="c1">#@property</span>
    <span class="c1">#def calc_type(self):</span>
    <span class="c1">#    &quot;&quot;&quot;String with the type of calculation.&quot;&quot;&quot;</span>
    <span class="c1">#    return self.info[&quot;calc_type&quot;]</span>

<div class="viewcode-block" id="DielectricFunction.plot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.DielectricFunction.plot">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the MDF.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: |matplotlib-Axes| or None if a new figure should be created.</span>

<span class="sd">        ==============  ==============================================================</span>
<span class="sd">        kwargs          Meaning</span>
<span class="sd">        ==============  ==============================================================</span>
<span class="sd">        only_mean       True if only the averaged spectrum is wanted (default True)</span>
<span class="sd">        ==============  ==============================================================</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">only_mean</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;only_mean&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (eV)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Macroscopic DF&#39;</span><span class="p">)</span>

        <span class="c1">#if not kwargs:</span>
        <span class="c1">#    kwargs = {&quot;color&quot;: &quot;black&quot;, &quot;linewidth&quot;: 2.0}</span>

        <span class="c1"># Plot the average value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">qpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">only_mean</span><span class="p">:</span>
            <span class="c1"># Plot the q-points</span>
            <span class="k">for</span> <span class="n">iq</span><span class="p">,</span> <span class="n">qpoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">iq</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="DielectricFunction.plot_ax"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.DielectricFunction.plot_ax">[docs]</a>    <span class="k">def</span> <span class="nf">plot_ax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">qpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to plot data on the axis ax.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: |matplotlib-Axes|</span>
<span class="sd">            qpoint: index of the q-point or |Kpoint| object or None to plot emacro_avg.</span>
<span class="sd">            kwargs: Keyword arguments passed to matplotlib. Accepts also:</span>

<span class="sd">                cplx_mode:</span>
<span class="sd">                    string defining the data to print (case-insensitive).</span>
<span class="sd">                    Possible choices are</span>

<span class="sd">                        - &quot;re&quot;  for real part</span>
<span class="sd">                        - &quot;im&quot; for imaginary part only.</span>
<span class="sd">                        - &quot;abs&#39; for the absolute value</span>

<span class="sd">                    Options can be concated with &quot;-&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extract the function to plot according to qpoint.</span>
        <span class="k">if</span> <span class="n">duck</span><span class="o">.</span><span class="n">is_intlike</span><span class="p">(</span><span class="n">qpoint</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">emacros_q</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">qpoint</span><span class="p">)]</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">qpoint</span><span class="p">,</span> <span class="n">Kpoint</span><span class="p">):</span>
            <span class="n">iq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">qpoint</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">emacros_q</span><span class="p">[</span><span class="n">iq</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">qpoint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">emacro_avg</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know how to handle </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">qpoint</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>


<span class="c1"># TODO: Should have ElectronBands</span>
<div class="viewcode-block" id="MdfFile"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfFile">[docs]</a><span class="k">class</span> <span class="nc">MdfFile</span><span class="p">(</span><span class="n">AbinitNcFile</span><span class="p">,</span> <span class="n">Has_Structure</span><span class="p">,</span> <span class="n">NotebookWriter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Usage example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        with MdfFile(&quot;foo_MDF.nc&quot;) as mdf:</span>
<span class="sd">            mdf.plot_mdfs()</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: MdfFile</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="MdfFile.from_file"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfFile.from_file">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the object from a Netcdf file&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="n">MdfReader</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

        <span class="c1"># TODO Add electron Bands.</span>
        <span class="c1">#self._ebands = r.read_ebands()</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

<div class="viewcode-block" id="MdfFile.to_string"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfFile.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>

        <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="s2">&quot;File Info&quot;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filestat</span><span class="p">(</span><span class="n">as_string</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Structure&quot;</span><span class="p">))</span>

        <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="s2">&quot;Q-points&quot;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="MdfFile.close"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfFile.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close the file.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="MdfFile.structure"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfFile.structure">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;|Structure| object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_structure</span><span class="p">()</span></div>

<div class="viewcode-block" id="MdfFile.exc_mdf"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfFile.exc_mdf">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">exc_mdf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Excitonic macroscopic dieletric function.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_exc_mdf</span><span class="p">()</span></div>

<div class="viewcode-block" id="MdfFile.rpanlf_mdf"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfFile.rpanlf_mdf">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">rpanlf_mdf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;RPA dielectric function without local-field effects.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_rpanlf_mdf</span><span class="p">()</span></div>

<div class="viewcode-block" id="MdfFile.gwnlf_mdf"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfFile.gwnlf_mdf">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">gwnlf_mdf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;RPA-GW dielectric function without local-field effects.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_gwnlf_mdf</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">qpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of q-points.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">qpoints</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">qfrac_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;|numpy-array| with the fractional coordinates of the q-points.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="o">.</span><span class="n">frac_coords</span>

<div class="viewcode-block" id="MdfFile.params"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfFile.params">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dictionary with the parameters that are usually tested for convergence.</span>
<span class="sd">        Used to build Pandas dataframes in Robots.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_params</span><span class="p">()</span></div>

<div class="viewcode-block" id="MdfFile.get_mdf"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfFile.get_mdf">[docs]</a>    <span class="k">def</span> <span class="nf">get_mdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mdf_type</span><span class="o">=</span><span class="s2">&quot;exc&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">        Returns the macroscopic dielectric function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;exc&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">exc_mdf</span><span class="p">,</span>
                <span class="s2">&quot;rpa&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rpanlf_mdf</span><span class="p">,</span>
                <span class="s2">&quot;gwrpa&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwnlf_mdf</span><span class="p">}[</span><span class="n">mdf_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span></div>

<div class="viewcode-block" id="MdfFile.plot_mdfs"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfFile.plot_mdfs">[docs]</a>    <span class="k">def</span> <span class="nf">plot_mdfs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cplx_mode</span><span class="o">=</span><span class="s2">&quot;Im&quot;</span><span class="p">,</span> <span class="n">mdf_type</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">qpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the macroscopic dielectric function.</span>

<span class="sd">        Args:</span>
<span class="sd">            cplx_mode:</span>
<span class="sd">                string defining the data to print (case-insensitive).</span>
<span class="sd">                Possible choices are</span>

<span class="sd">                    - &quot;re&quot;  for real part</span>
<span class="sd">                    - &quot;im&quot; for imaginary part only.</span>
<span class="sd">                    - &quot;abs&#39; for the absolute value</span>

<span class="sd">                Options can be concated with &quot;-&quot;.</span>

<span class="sd">            mdf_type:</span>
<span class="sd">                Select the type of macroscopic dielectric function.</span>
<span class="sd">                Possible choices are</span>

<span class="sd">                    - &quot;exc&quot; for the MDF with excitonic effects.</span>
<span class="sd">                    - &quot;rpa&quot; for RPA with KS energies.</span>
<span class="sd">                    - &quot;gwrpa&quot; for RPA with GW (or KS-corrected) results</span>
<span class="sd">                    - &quot;all&quot; if all types are wanted.</span>

<span class="sd">                Options can be concated with &quot;-&quot;.</span>

<span class="sd">            qpoint:</span>
<span class="sd">                index of the q-point or Kpoint object or None to plot emacro_avg.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mdf_type</span><span class="p">,</span> <span class="n">cplx_mode</span> <span class="o">=</span> <span class="n">mdf_type</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">cplx_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="n">plot_all</span> <span class="o">=</span> <span class="n">mdf_type</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span>
        <span class="n">mdf_type</span> <span class="o">=</span> <span class="n">mdf_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>

        <span class="c1"># Build the plotter.</span>
        <span class="n">plotter</span> <span class="o">=</span> <span class="n">MdfPlotter</span><span class="p">()</span>

        <span class="c1"># Excitonic MDF.</span>
        <span class="k">if</span> <span class="s2">&quot;exc&quot;</span> <span class="ow">in</span> <span class="n">mdf_type</span> <span class="ow">or</span> <span class="n">plot_all</span><span class="p">:</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">add_mdf</span><span class="p">(</span><span class="s2">&quot;EXC&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exc_mdf</span><span class="p">)</span>

        <span class="c1"># KS-RPA MDF</span>
        <span class="k">if</span> <span class="s2">&quot;rpa&quot;</span> <span class="ow">in</span> <span class="n">mdf_type</span> <span class="ow">or</span> <span class="n">plot_all</span><span class="p">:</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">add_mdf</span><span class="p">(</span><span class="s2">&quot;KS-RPA&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rpanlf_mdf</span><span class="p">)</span>

        <span class="c1"># GW-RPA MDF (obtained with the scissors operator).</span>
        <span class="k">if</span> <span class="s2">&quot;gwrpa&quot;</span> <span class="ow">in</span> <span class="n">mdf_type</span> <span class="ow">or</span> <span class="n">plot_all</span><span class="p">:</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">add_mdf</span><span class="p">(</span><span class="s2">&quot;GW-RPA&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gwnlf_mdf</span><span class="p">)</span>

        <span class="c1"># Plot spectra</span>
        <span class="k">return</span> <span class="n">plotter</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cplx_mode</span><span class="o">=</span><span class="n">cplx_mode</span><span class="p">,</span> <span class="n">qpoint</span><span class="o">=</span><span class="n">qpoint</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="MdfFile.get_tensor"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfFile.get_tensor">[docs]</a>    <span class="k">def</span> <span class="nf">get_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mdf_type</span><span class="o">=</span><span class="s2">&quot;exc&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the macroscopic dielectric tensor from the MDF.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_DielectricTensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_mdf</span><span class="p">(</span><span class="n">mdf_type</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span></div>

<div class="viewcode-block" id="MdfFile.yield_figs"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfFile.yield_figs">[docs]</a>    <span class="k">def</span> <span class="nf">yield_figs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function *generates* a predefined list of matplotlib figures with minimal input from the user.</span>
<span class="sd">        Used in abiview.py to get a quick look at the results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#yield self.ebands.plot(show=False)</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_mdfs</span><span class="p">(</span><span class="n">cplx_mode</span><span class="o">=</span><span class="s2">&quot;Re&quot;</span><span class="p">,</span> <span class="n">mdf_type</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">qpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_mdfs</span><span class="p">(</span><span class="n">cplx_mode</span><span class="o">=</span><span class="s2">&quot;Im&quot;</span><span class="p">,</span> <span class="n">mdf_type</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">qpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="MdfFile.write_notebook"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfFile.write_notebook">[docs]</a>    <span class="k">def</span> <span class="nf">write_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a jupyter_ notebook to nbpath. If nbpath is None, a temporay file in the current</span>
<span class="sd">        working directory is created. Return path to the notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbformat</span><span class="p">,</span> <span class="n">nbv</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nbformat_nbv_nb</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;mdf_file = abilab.abiopen(&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;print(mdf_file)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;mdf_file.plot_mdfs(cplx_mode=&#39;Re&#39;);&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;mdf_file.plot_mdfs(cplx_mode=&#39;Im&#39;);&quot;</span><span class="p">),</span>
            <span class="c1"># TODO:</span>
            <span class="c1">#nbv.new_code_cell(&quot;tensor_exc = mdf_file.get_tensor(&quot;exc&quot;)&quot;)</span>
            <span class="c1">#tensor_exc.symmetrize(mdf_file.structure)</span>
            <span class="c1">#tensor_exc.plot(title=title)</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_nb_nbpath</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nbpath</span><span class="p">)</span></div></div>


<span class="c1"># TODO Add band energies to MDF file.</span>
<span class="c1">#from abipy.electrons import ElectronsReader</span>
<div class="viewcode-block" id="MdfReader"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfReader">[docs]</a><span class="k">class</span> <span class="nc">MdfReader</span><span class="p">(</span><span class="n">ETSF_Reader</span><span class="p">):</span> <span class="c1">#ElectronsReader</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object reads data from the MDF.nc file produced by ABINIT.</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: MdfReader</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the object from a filename.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="c1"># Read the structure here to facilitate the creation of the other objects.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_structure</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;|Structure| object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span>

<div class="viewcode-block" id="MdfReader.qpoints"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfReader.qpoints">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">qpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of q-points (ndarray).&quot;&quot;&quot;</span>
        <span class="c1"># Read the fractional coordinates and convert them to KpointList.</span>
        <span class="k">return</span> <span class="n">KpointList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">,</span> <span class="n">frac_coords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;qpoints&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="MdfReader.wmesh"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfReader.wmesh">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">wmesh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The frequency mesh in eV.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;wmesh&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MdfReader.read_params"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfReader.read_params">[docs]</a>    <span class="k">def</span> <span class="nf">read_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dictionary with the parameters of the run.&quot;&quot;&quot;</span>
        <span class="c1"># TODO: Add more info.</span>
        <span class="c1"># soenergy replaced by mbpt_sciss</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;nsppol&quot;</span><span class="p">,</span> <span class="s2">&quot;ecutwfn&quot;</span><span class="p">,</span> <span class="s2">&quot;ecuteps&quot;</span><span class="p">,</span>
            <span class="s2">&quot;eps_inf&quot;</span><span class="p">,</span> <span class="s2">&quot;mbpt_sciss&quot;</span><span class="p">,</span> <span class="s2">&quot;broad&quot;</span><span class="p">,</span> <span class="s2">&quot;nkibz&quot;</span><span class="p">,</span> <span class="s2">&quot;nkbz&quot;</span><span class="p">,</span> <span class="s2">&quot;nkibz_interp&quot;</span><span class="p">,</span> <span class="s2">&quot;nkbz_interp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;wtype&quot;</span><span class="p">,</span> <span class="s2">&quot;interp_mode&quot;</span><span class="p">,</span> <span class="s2">&quot;nreh&quot;</span><span class="p">,</span> <span class="s2">&quot;lomo_spin&quot;</span><span class="p">,</span> <span class="s2">&quot;humo_spin&quot;</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_keys</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_read_mdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mdf_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read the MDF from file, returns numpy complex array.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="n">mdf_type</span><span class="p">,</span> <span class="n">cmode</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="MdfReader.read_exc_mdf"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfReader.read_exc_mdf">[docs]</a>    <span class="k">def</span> <span class="nf">read_exc_mdf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the excitonic MDF.&quot;&quot;&quot;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_params</span><span class="p">()</span>
        <span class="n">emacros_q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_mdf</span><span class="p">(</span><span class="s2">&quot;exc_mdf&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">DielectricFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wmesh</span><span class="p">,</span> <span class="n">emacros_q</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span></div>

<div class="viewcode-block" id="MdfReader.read_rpanlf_mdf"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfReader.read_rpanlf_mdf">[docs]</a>    <span class="k">def</span> <span class="nf">read_rpanlf_mdf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the KS-RPA MDF without LF effects.&quot;&quot;&quot;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_params</span><span class="p">()</span>
        <span class="n">emacros_q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_mdf</span><span class="p">(</span><span class="s2">&quot;rpanlf_mdf&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">DielectricFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wmesh</span><span class="p">,</span> <span class="n">emacros_q</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span></div>

<div class="viewcode-block" id="MdfReader.read_gwnlf_mdf"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfReader.read_gwnlf_mdf">[docs]</a>    <span class="k">def</span> <span class="nf">read_gwnlf_mdf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the GW-RPA MDF without LF effects.&quot;&quot;&quot;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_params</span><span class="p">()</span>
        <span class="n">emacros_q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_mdf</span><span class="p">(</span><span class="s2">&quot;gwnlf_mdf&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">DielectricFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wmesh</span><span class="p">,</span> <span class="n">emacros_q</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MdfPlotter"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfPlotter">[docs]</a><span class="k">class</span> <span class="nc">MdfPlotter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for plotting Macroscopic dielectric functions.</span>

<span class="sd">    Usage example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        plotter = MdfPlotter()</span>
<span class="sd">        plotter.add_mdf(&quot;EXC&quot;, exc_mdf)</span>
<span class="sd">        plotter.add_mdf(&quot;KS-RPA&quot;, rpanlf_mdf)</span>
<span class="sd">        plotter.plot()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mdfs</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

<div class="viewcode-block" id="MdfPlotter.add_mdf"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfPlotter.add_mdf">[docs]</a>    <span class="k">def</span> <span class="nf">add_mdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">mdf</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a :class:`DielectricFunction` for plotting.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: name for the MDF. Must be unique.</span>
<span class="sd">            mdf: :class:`DielectricFunction` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mdfs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;label: </span><span class="si">%s</span><span class="s2"> is already in: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mdfs</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mdfs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdf</span></div>

<div class="viewcode-block" id="MdfPlotter.plot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MdfPlotter.plot">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cplx_mode</span><span class="o">=</span><span class="s2">&quot;Im&quot;</span><span class="p">,</span> <span class="n">qpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a matplotlib plot showing the MDFs.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: |matplotlib-Axes| or None if a new figure should be created.</span>
<span class="sd">            cplx_mode: string defining the data to print (case-insensitive).</span>
<span class="sd">                Possible choices are ``re`` for the real part, ``im`` for imaginary part only. ``abs`` for the absolute value.</span>
<span class="sd">                Options can be concated with &quot;-&quot;.</span>
<span class="sd">            qpoint: index of the q-point or :class:`Kpoint` object or None to plot emacro_avg.</span>
<span class="sd">            xlims: Set the data limits for the y-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                or scalar e.g. ``left``. If left (right) is None, default values are used</span>
<span class="sd">            ylims: Same meaning as ``ylims`` but for the y-axis</span>
<span class="sd">            fontsize: Legend and label fontsize.</span>

<span class="sd">        Return: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (eV)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Macroscopic DF&#39;</span><span class="p">)</span>

        <span class="n">cmodes</span> <span class="o">=</span> <span class="n">cplx_mode</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
        <span class="n">qtag</span> <span class="o">=</span> <span class="s2">&quot;avg&quot;</span> <span class="k">if</span> <span class="n">qpoint</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">repr</span><span class="p">(</span><span class="n">qpoint</span><span class="p">)</span>

        <span class="n">lines</span><span class="p">,</span> <span class="n">legends</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">mdf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mdfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">cmode</span> <span class="ow">in</span> <span class="n">cmodes</span><span class="p">:</span>
                <span class="c1"># Plot the average value</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">mdf</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">qpoint</span><span class="p">,</span> <span class="n">cplx_mode</span><span class="o">=</span><span class="n">cmode</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                <span class="n">legends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2"> $\varepsilon$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmode</span><span class="p">,</span> <span class="n">qtag</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>

        <span class="c1"># Set legends.</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">legends</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div></div>

    <span class="c1">#def ipw_plot(self) # pragma: no cover</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    Return an ipython widget with controllers to select the plot.</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    def plot_callback(plot_type, qpoint):</span>
    <span class="c1">#        if qpoint == &quot;None&quot;: qpoint = None</span>
    <span class="c1">#        return self.plot(cplx_type=cplx_type, qpoint=qpoint)</span>

    <span class="c1">#    import ipywidgets as ipw</span>
    <span class="c1">#    return ipw.interact_manual(</span>
    <span class="c1">#            plot_callback,</span>
    <span class="c1">#            cplx_type=[&quot;re&quot;, &quot;im&quot;, &quot;abs&quot;],</span>
    <span class="c1">#            qpoint=[&quot;None&quot;] + list(range(self.,</span>
    <span class="c1">#        )</span>


<div class="viewcode-block" id="MultipleMdfPlotter"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MultipleMdfPlotter">[docs]</a><span class="k">class</span> <span class="nc">MultipleMdfPlotter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for plotting multipe macroscopic dielectric functions</span>
<span class="sd">    extracted from several MDF.nc files</span>

<span class="sd">    Usage example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        plotter = MultipleMdfPlotter()</span>
<span class="sd">        plotter.add_mdf_file(&quot;file1&quot;, mdf_file1)</span>
<span class="sd">        plotter.add_mdf_file(&quot;file2&quot;, mdf_file2)</span>
<span class="sd">        plotter.plot()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># By default the plotter will extracts these MDF types.</span>
    <span class="n">MDF_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;exc&quot;</span><span class="p">,</span> <span class="s2">&quot;rpa&quot;</span><span class="p">,</span> <span class="s2">&quot;gwrpa&quot;</span><span class="p">)</span>

    <span class="c1"># Mapping mdf_type --&gt; color used in plots.</span>
    <span class="c1">#MDF_TYPE2COLOR = {&quot;exc&quot;: &quot;red&quot;, &quot;rpa&quot;: &quot;blue&quot;, &quot;gwrpa&quot;: &quot;yellow&quot;}</span>

    <span class="c1">#MDF_TYPE2LINESTYLE = {&quot;exc&quot;: &quot;red&quot;, &quot;rpa&quot;: &quot;blue&quot;, &quot;gwrpa&quot;: &quot;yellow&quot;}</span>

    <span class="c1"># Mapping [mdf_type][cplx_mode] --&gt; ylable used in plots.</span>
    <span class="n">MDF_TYPECPLX2TEX</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;exc&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">re</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\Re(\varepsilon_</span><span class="si">{exc}</span><span class="s2">)$&quot;</span><span class="p">,</span> <span class="n">im</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\Im(\varepsilon_</span><span class="si">{exc}</span><span class="s2">$)&quot;</span><span class="p">,</span> <span class="nb">abs</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$|\varepsilon_</span><span class="si">{exc}</span><span class="s2">|$&quot;</span><span class="p">),</span>
        <span class="s2">&quot;rpa&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">re</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\Re(\varepsilon_</span><span class="si">{rpa}</span><span class="s2">)$&quot;</span><span class="p">,</span> <span class="n">im</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\Im(\varepsilon_</span><span class="si">{rpa}</span><span class="s2">)$&quot;</span><span class="p">,</span> <span class="nb">abs</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$|\varepsilon_</span><span class="si">{rpa}</span><span class="s2">|$&quot;</span><span class="p">),</span>
        <span class="s2">&quot;gwrpa&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">re</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\Re(\varepsilon_{gw-rpa})$&quot;</span><span class="p">,</span> <span class="n">im</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\Im(\varepsilon_{gw-rpa})$&quot;</span><span class="p">,</span> <span class="nb">abs</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$|\varepsilon_{gw-rpa}|$&quot;</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="c1">#alpha = 0.6</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># [label][mdf_type] --&gt; DielectricFunction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mdfs</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

<div class="viewcode-block" id="MultipleMdfPlotter.to_string"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MultipleMdfPlotter.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>

        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">mdf_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mdfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">mdf_type</span><span class="p">,</span> <span class="n">mdf</span> <span class="ow">in</span> <span class="n">mdf_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">app</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mdf_type</span><span class="p">,</span> <span class="n">mdf</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="MultipleMdfPlotter.add_mdf_file"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MultipleMdfPlotter.add_mdf_file">[docs]</a>    <span class="k">def</span> <span class="nf">add_mdf_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract dielectric functions from object ``obj``, store data for plotting.</span>

<span class="sd">        Args:</span>
<span class="sd">            label: label associated to the MDF file. Must be unique.</span>
<span class="sd">            mdf: filepath or :class:`MdfFile` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mdfs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;label: </span><span class="si">%s</span><span class="s2"> already in: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mdfs</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mdfs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">is_string</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="c1"># Open the file.</span>
            <span class="k">with</span> <span class="n">MdfFile</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="k">as</span> <span class="n">mdf_file</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">mdf_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">MDF_TYPES</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_mdfs</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">mdf_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdf_file</span><span class="o">.</span><span class="n">get_mdf</span><span class="p">(</span><span class="n">mdf_type</span><span class="o">=</span><span class="n">mdf_type</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Extract data from `MdfFile` object</span>
            <span class="k">for</span> <span class="n">mdf_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">MDF_TYPES</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mdfs</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">mdf_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_mdf</span><span class="p">(</span><span class="n">mdf_type</span><span class="o">=</span><span class="n">mdf_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="MultipleMdfPlotter.plot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MultipleMdfPlotter.plot">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mdf_type</span><span class="o">=</span><span class="s2">&quot;exc&quot;</span><span class="p">,</span> <span class="n">qview</span><span class="o">=</span><span class="s2">&quot;avg&quot;</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot all macroscopic dielectric functions (MDF) stored in the plotter</span>

<span class="sd">        Args:</span>
<span class="sd">            mdf_type: Selects the type of dielectric function.</span>
<span class="sd">                &quot;exc&quot; for the MDF with excitonic effects.</span>
<span class="sd">                &quot;rpa&quot; for RPA with KS energies.</span>
<span class="sd">                &quot;gwrpa&quot; for RPA with GW (or KS-corrected) results.</span>
<span class="sd">            qview: &quot;avg&quot; to plot the results averaged over q-points. &quot;all&quot; to plot q-point dependence.</span>
<span class="sd">            xlims: Set the data limits for the y-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                  or scalar e.g. `left`. If left (right) is None, default values are used</span>
<span class="sd">            ylims: Same meaning as `ylims` but for the y-axis</span>
<span class="sd">            fontsize: fontsize for titles and legend.</span>

<span class="sd">        Return: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Build plot grid.</span>
        <span class="k">if</span> <span class="n">qview</span> <span class="o">==</span> <span class="s2">&quot;avg&quot;</span><span class="p">:</span>
            <span class="n">ncols</span><span class="p">,</span> <span class="n">nrows</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">qview</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">qpoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_qpoints</span><span class="p">()</span>
            <span class="n">ncols</span><span class="p">,</span> <span class="n">nrows</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">qpoints</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid value of qview: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">qview</span><span class="p">))</span>

        <span class="n">ax_mat</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                               <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">qview</span> <span class="o">==</span> <span class="s2">&quot;avg&quot;</span><span class="p">:</span>
            <span class="c1"># Plot averaged values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_mdftype_cplx</span><span class="p">(</span><span class="n">mdf_type</span><span class="p">,</span> <span class="s2">&quot;Re&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">xlims</span><span class="o">=</span><span class="n">xlims</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="n">ylims</span><span class="p">,</span>
                                   <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">with_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_mdftype_cplx</span><span class="p">(</span><span class="n">mdf_type</span><span class="p">,</span> <span class="s2">&quot;Im&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">xlims</span><span class="o">=</span><span class="n">xlims</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="n">ylims</span><span class="p">,</span>
                                   <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">with_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">qview</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="c1"># Plot MDF(q)</span>
            <span class="n">nqpt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qpoints</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">iq</span><span class="p">,</span> <span class="n">qpt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">qpoints</span><span class="p">):</span>
                <span class="n">islast</span> <span class="o">=</span> <span class="p">(</span><span class="n">iq</span> <span class="o">==</span> <span class="n">nqpt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_mdftype_cplx</span><span class="p">(</span><span class="n">mdf_type</span><span class="p">,</span> <span class="s2">&quot;Re&quot;</span><span class="p">,</span> <span class="n">qpoint</span><span class="o">=</span><span class="n">qpt</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_mat</span><span class="p">[</span><span class="n">iq</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">xlims</span><span class="o">=</span><span class="n">xlims</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="n">ylims</span><span class="p">,</span>
                    <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">with_legend</span><span class="o">=</span><span class="p">(</span><span class="n">iq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="n">with_xlabel</span><span class="o">=</span><span class="n">islast</span><span class="p">,</span> <span class="n">with_ylabel</span><span class="o">=</span><span class="n">islast</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_mdftype_cplx</span><span class="p">(</span><span class="n">mdf_type</span><span class="p">,</span> <span class="s2">&quot;Im&quot;</span><span class="p">,</span> <span class="n">qpoint</span><span class="o">=</span><span class="n">qpt</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_mat</span><span class="p">[</span><span class="n">iq</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">xlims</span><span class="o">=</span><span class="n">xlims</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="n">ylims</span><span class="p">,</span>
                    <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">with_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">with_xlabel</span><span class="o">=</span><span class="n">islast</span><span class="p">,</span> <span class="n">with_ylabel</span><span class="o">=</span><span class="n">islast</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid value of qview: `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">qview</span><span class="p">))</span>

        <span class="c1">#ax_mat[0, 0].legend(loc=&quot;best&quot;, fontsize=fontsize, shadow=True)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="c1">#@add_fig_kwargs</span>
    <span class="c1">#def plot_mdftypes(self, qview=&quot;avg&quot;, xlims=None, ylims=None, **kwargs):</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    Args:</span>
    <span class="c1">#        qview:</span>
    <span class="c1">#        xlims</span>
    <span class="c1">#        ylims</span>
    <span class="c1">#    Return: matplotlib figure</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    # Build plot grid.</span>
    <span class="c1">#    if qview == &quot;avg&quot;:</span>
    <span class="c1">#        ncols, nrows = 2, 1</span>
    <span class="c1">#    elif qview == &quot;all&quot;:</span>
    <span class="c1">#        qpoints = self._get_qpoints()</span>
    <span class="c1">#        ncols, nrows = 2, len(qpoints)</span>
    <span class="c1">#    else:</span>
    <span class="c1">#        raise ValueError(&quot;Invalid value of qview: %s&quot; % str(qview))</span>
    <span class="c1">#    import matplotlib.pyplot as plt</span>
    <span class="c1">#    fig, ax_mat = plt.subplots(nrows=nrows, ncols=ncols, sharex=True, sharey=True, squeeze=False)</span>
    <span class="c1">#    if qview == &quot;avg&quot;:</span>
    <span class="c1">#        # Plot averaged values</span>
    <span class="c1">#        for mdf_type in self.MDF_TYPES:</span>
    <span class="c1">#            self.plot_mdftype_cplx(mdf_type, &quot;Re&quot;, ax=ax_mat[0, 0], xlims=xlims, ylims=ylims,</span>
    <span class="c1">#                                   with_legend=True, show=False)</span>
    <span class="c1">#            self.plot_mdftype_cplx(mdf_type, &quot;Im&quot;, ax=ax_mat[0, 1], xlims=xlims, ylims=ylims,</span>
    <span class="c1">#                                   with_legend=False, show=False)</span>
    <span class="c1">#    elif qview == &quot;all&quot;:</span>
    <span class="c1">#        # Plot MDF(q)</span>
    <span class="c1">#        nqpt = len(qpoints)</span>
    <span class="c1">#        for iq, qpt in enumerate(qpoints):</span>
    <span class="c1">#            islast = (iq == nqpt - 1)</span>
    <span class="c1">#            for mdf_type in self.MDF_TYPES:</span>
    <span class="c1">#                self.plot_mdftype_cplx(mdf_type, &quot;Re&quot;, qpoint=qpt, ax=ax_mat[iq, 0], xlims=xlims, ylims=ylims,</span>
    <span class="c1">#                                       with_legend=(iq == 0), with_xlabel=islast, with_ylabel=islast, show=False)</span>
    <span class="c1">#                self.plot_mdftype_cplx(mdf_type, &quot;Im&quot;, qpoint=qpt, ax=ax_mat[iq, 1], xlims=xlims, ylims=ylims,</span>
    <span class="c1">#                                       with_legend=False, with_xlabel=islast, with_ylabel=islast, show=False)</span>
    <span class="c1">#    else:</span>
    <span class="c1">#        raise ValueError(&quot;Invalid value of qview: %s&quot; % str(qview))</span>
    <span class="c1">#    #ax_mat[0, 0].legend(loc=&quot;best&quot;, fontsize=fontsize, shadow=True)</span>
    <span class="c1">#    #fig.tight_layout()</span>
    <span class="c1">#    return fig</span>

<div class="viewcode-block" id="MultipleMdfPlotter.plot_mdftype_cplx"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MultipleMdfPlotter.plot_mdftype_cplx">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_mdftype_cplx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mdf_type</span><span class="p">,</span> <span class="n">cplx_mode</span><span class="p">,</span> <span class="n">qpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">with_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_xlabel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_ylabel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to plot data corresponds to ``mdf_type``, ``cplx_mode``, ``qpoint``.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: |matplotlib-Axes| or None if a new figure should be created.</span>
<span class="sd">            mdf_type:</span>
<span class="sd">            cplx_mode: string defining the data to print (case-insensitive).</span>
<span class="sd">                Possible choices are `re` for the real part, `im` for imaginary part only. `abs` for the absolute value.</span>
<span class="sd">            qpoint: index of the q-point or :class:`Kpoint` object or None to plot emacro_avg.</span>
<span class="sd">            xlims: Set the data limits for the y-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                  or scalar e.g. `left`. If left (right) is None, default values are used</span>
<span class="sd">            ylims: Same meaning as `ylims` but for the y-axis</span>
<span class="sd">            with_legend: True if legend should be added</span>
<span class="sd">            with_xlabel:</span>
<span class="sd">            with_ylabel:</span>
<span class="sd">            fontsize: Legend and label fontsize.</span>

<span class="sd">        Return: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">with_xlabel</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Frequency (eV)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">with_ylabel</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MDF_TYPECPLX2TEX</span><span class="p">[</span><span class="n">mdf_type</span><span class="p">][</span><span class="n">cplx_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()])</span>

        <span class="n">can_use_basename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_can_use_basenames_as_labels</span><span class="p">()</span>
        <span class="n">qtag</span> <span class="o">=</span> <span class="s2">&quot;avg&quot;</span> <span class="k">if</span> <span class="n">qpoint</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">repr</span><span class="p">(</span><span class="n">qpoint</span><span class="p">)</span>

        <span class="n">lines</span><span class="p">,</span> <span class="n">legends</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">mdf_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mdfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">mdf</span> <span class="o">=</span> <span class="n">mdf_dict</span><span class="p">[</span><span class="n">mdf_type</span><span class="p">]</span>
            <span class="c1"># Plot the average value</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">mdf</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">qpoint</span><span class="p">,</span> <span class="n">cplx_mode</span><span class="o">=</span><span class="n">cplx_mode</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">can_use_basename</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Use relative paths if label is a file.</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">label</span><span class="p">):</span> <span class="n">label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

            <span class="n">legends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2"> $\varepsilon$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cplx_mode</span><span class="p">,</span> <span class="n">qtag</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>

        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="c1"># Set legends.</span>
        <span class="k">if</span> <span class="n">with_legend</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">legends</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="k">def</span> <span class="nf">_get_qpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function is called when we have to plot quantities as function of q-points.</span>
<span class="sd">        It checks that all dielectric functions stored in the plotter have the same list of</span>
<span class="sd">        q-points and returns the q-points of the first dielectric function.</span>

<span class="sd">        Raises: `ValueError` if the q-points cannot be compared.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qpoints</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">eapp</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">append</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mdfs</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">mdf</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">MDF_TYPES</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">qpoints</span> <span class="o">=</span> <span class="n">mdf</span><span class="o">.</span><span class="n">qpoints</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">qpoints</span> <span class="o">!=</span> <span class="n">mdf</span><span class="o">.</span><span class="n">qpoints</span><span class="p">:</span>
                    <span class="n">eapp</span><span class="p">(</span><span class="s2">&quot;List of q-points for MDF index </span><span class="si">%i</span><span class="s2"> does not agree with first set:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">qpoints</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                             <span class="s2">&quot;Your MDF files have been computed with a different set of q-points</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                             <span class="s2">&quot;Cannot compare dielectric functions as as function of q, use average value&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">qpoints</span>

<div class="viewcode-block" id="MultipleMdfPlotter.ipw_select_plot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.bse.MultipleMdfPlotter.ipw_select_plot">[docs]</a>    <span class="k">def</span> <span class="nf">ipw_select_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an ipython widget with controllers to select the plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">plot_callback</span><span class="p">(</span><span class="n">mdf_type</span><span class="p">,</span> <span class="n">qview</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mdf_type</span><span class="o">=</span><span class="n">mdf_type</span><span class="p">,</span> <span class="n">qview</span><span class="o">=</span><span class="n">qview</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">ipw</span>
        <span class="k">return</span> <span class="n">ipw</span><span class="o">.</span><span class="n">interact_manual</span><span class="p">(</span>
                <span class="n">plot_callback</span><span class="p">,</span>
                <span class="n">mdf_type</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;exc&quot;</span><span class="p">,</span> <span class="s2">&quot;rpa&quot;</span><span class="p">,</span> <span class="s2">&quot;gwrpa&quot;</span><span class="p">],</span>
                <span class="n">qview</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;avg&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">],</span>
            <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_can_use_basenames_as_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return True if all labels represent valid files and the basenames are unique</span>
<span class="sd">        In this case one can use the file basename instead of the full path in the plots.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mdfs</span><span class="p">):</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mdfs</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">MdfRobot</span><span class="p">(</span><span class="n">Robot</span><span class="p">,</span> <span class="n">RobotWithEbands</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This robot analyzes the results contained in multiple MDF.nc files.</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: MdfRobot</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">EXT</span> <span class="o">=</span> <span class="s2">&quot;MDF&quot;</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wraps plot method of :class:`MultipleMdfPlotter`. kwargs are passed to plot.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_multimdf_plotter</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">yield_figs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function *generates* a predefined list of matplotlib figures with minimal input from the user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plotter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_multimdf_plotter</span><span class="p">()</span>
        <span class="k">yield</span> <span class="n">plotter</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mdf_type</span><span class="o">=</span><span class="s2">&quot;exc&quot;</span><span class="p">,</span> <span class="n">qview</span><span class="o">=</span><span class="s2">&quot;avg&quot;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_multimdf_plotter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an instance of :class:`MultipleMdfPlotter` to compare multiple dielectric functions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plotter</span> <span class="o">=</span> <span class="n">MultipleMdfPlotter</span><span class="p">()</span> <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">mdf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">add_mdf_file</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">mdf</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">plotter</span>

    <span class="k">def</span> <span class="nf">get_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_geo</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">abspath</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">funcs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build and return |pandas-DataFrame| with the most import BSE results and the filenames as index.</span>

<span class="sd">        Args:</span>
<span class="sd">            with_geo: True if structure parameters should be added to the DataFrame</span>
<span class="sd">            abspath: True if paths in index should be absolute. Default: Relative to getcwd().</span>
<span class="sd">            funcs: Function or list of functions to execute to add more data to the DataFrame.</span>
<span class="sd">                Each function receives a :class:`MdfFile` object and returns a tuple (key, value)</span>
<span class="sd">                where key is a string with the name of column and value is the value to be inserted.</span>

<span class="sd">        Return: |pandas-DataFrame|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rows</span><span class="p">,</span> <span class="n">row_names</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">mdf</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">row_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([</span>
                <span class="p">(</span><span class="s2">&quot;exc_mdf&quot;</span><span class="p">,</span> <span class="n">mdf</span><span class="o">.</span><span class="n">exc_mdf</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;rpa_mdf&quot;</span><span class="p">,</span> <span class="n">mdf</span><span class="o">.</span><span class="n">rpanlf_mdf</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;gwrpa_mdf&quot;</span><span class="p">,</span> <span class="n">mdf</span><span class="o">.</span><span class="n">gwnlf_mdf</span><span class="p">),</span>
            <span class="p">])</span>
            <span class="c1">#d = {aname: getattr(mdf, aname) for aname in attrs}</span>
            <span class="c1">#d.update({&quot;qpgap&quot;: mdf.get_qpgap(spin, kpoint)})</span>

            <span class="c1"># Add convergence parameters</span>
            <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">mdf</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

            <span class="c1"># Add info on structure.</span>
            <span class="k">if</span> <span class="n">with_geo</span><span class="p">:</span>
                <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">mdf</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">get_dict4pandas</span><span class="p">(</span><span class="n">with_spglib</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

            <span class="c1"># Execute functions.</span>
            <span class="k">if</span> <span class="n">funcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exec_funcs</span><span class="p">(</span><span class="n">funcs</span><span class="p">,</span> <span class="n">mdf</span><span class="p">))</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="n">row_names</span> <span class="o">=</span> <span class="n">row_names</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">abspath</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_relpaths</span><span class="p">(</span><span class="n">row_names</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">row_names</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

    <span class="c1">#@add_fig_kwargs</span>
    <span class="c1">#def plot_conv_mdf(self, hue, mdf_type=&quot;exc_mdf&quot;, **kwargs):</span>
    <span class="c1">#    import matplotlib.pyplot as plt</span>
    <span class="c1">#    frame = self.get_dataframe()</span>
    <span class="c1">#    grouped = frame.groupby(hue)</span>

    <span class="c1">#    fig, ax_list = plt.subplots(nrows=len(grouped), ncols=1, sharex=True, sharey=True, squeeze=True)</span>

    <span class="c1">#    for i, (hue_val, group) in enumerate(grouped):</span>
    <span class="c1">#        #print(group)</span>
    <span class="c1">#        mdfs = group[mdf_type]</span>
    <span class="c1">#        ax = ax_list[i]</span>
    <span class="c1">#        ax.set_title(&quot;%s = %s&quot; % (hue, hue_val))</span>
    <span class="c1">#        for mdf in mdfs:</span>
    <span class="c1">#            mdf.plot_ax(ax)</span>

    <span class="c1">#    return fig</span>

    <span class="k">def</span> <span class="nf">write_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a jupyter_ notebook to nbpath. If nbpath is None, a temporay file in the current</span>
<span class="sd">        working directory is created. Return path to the notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbformat</span><span class="p">,</span> <span class="n">nbv</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nbformat_nbv_nb</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">[(</span><span class="n">l</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="c1">#nbv.new_markdown_cell(&quot;# This is a markdown cell&quot;),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;robot = abilab.MdfRobot(*</span><span class="si">%s</span><span class="s2">)</span><span class="se">\n</span><span class="s2">robot.trim_paths()</span><span class="se">\n</span><span class="s2">robot&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">)),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;#df = robot.get_dataframe(with_geo=False&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;plotter = robot.get_multimdf_plotter()&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s1">&#39;plotter.plot(mdf_type=&quot;exc&quot;, qview=&quot;avg&quot;, xlim=None, ylim=None);&#39;</span><span class="p">),</span>
            <span class="c1">#nbv.new_code_cell(plotter.combiboxplot();&quot;),</span>
        <span class="p">])</span>

        <span class="c1"># Mixins</span>
        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_baserobot_code_cells</span><span class="p">())</span>
        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_ebands_code_cells</span><span class="p">())</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_nb_nbpath</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nbpath</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_from_cart_to_red</span><span class="p">(</span><span class="n">cartesian_tensor</span><span class="p">,</span><span class="n">lattice</span><span class="p">):</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">lattice</span><span class="o">.</span><span class="n">inv_matrix</span>
    <span class="n">red_tensor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">mat</span><span class="p">),</span> <span class="n">cartesian_tensor</span><span class="p">),</span> <span class="n">mat</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">red_tensor</span>


<span class="c1"># TODO Remove</span>
<span class="k">class</span> <span class="nc">_Tensor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Representation of a 3x3 tensor&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">red_tensor</span><span class="p">,</span> <span class="n">lattice</span><span class="p">,</span> <span class="n">space</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            red_tensor: array-like object with the 9 cartesian components of the tensor</span>
<span class="sd">            lattice: Lattice object defining the reference system</span>
<span class="sd">            space:</span>
<span class="sd">                &quot;r&quot; if the lattice is a real space lattice</span>
<span class="sd">                &quot;g&quot; if the lattice is a reciprocal space lattice</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reduced_tensor</span> <span class="o">=</span> <span class="n">red_tensor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lattice</span> <span class="o">=</span> <span class="n">lattice</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">space</span> <span class="o">=</span> <span class="n">space</span>

        <span class="k">if</span> <span class="n">space</span> <span class="o">==</span> <span class="s2">&quot;g&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_real_space</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">space</span> <span class="o">==</span> <span class="s2">&quot;r&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_real_space</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;space should be either &#39;g&#39; or &#39;r&#39;&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reduced_tensor</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">reduced_tensor</span><span class="p">)</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lattice</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">lattice</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">space</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">space</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">with_reduced</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>

        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Tensor in </span><span class="si">%s</span><span class="s2"> space.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">space</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Cartesian coordinates:&quot;</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cartesian_tensor</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">with_reduced</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">app</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lattice</span><span class="p">))</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Reduced coordinates:&quot;</span><span class="p">)</span>
            <span class="n">app</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reduced_tensor</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lattice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lattice</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">reduced_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reduced_tensor</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_real_space</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_real_space</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cartesian_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lattice</span><span class="o">.</span><span class="n">matrix</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">mat</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reduced_tensor</span><span class="p">),</span> <span class="n">mat</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_cartesian_tensor</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">cartesian_tensor</span><span class="p">,</span> <span class="n">lattice</span><span class="p">,</span> <span class="n">space</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">):</span>
        <span class="n">red_tensor</span> <span class="o">=</span> <span class="n">_from_cart_to_red</span><span class="p">(</span><span class="n">cartesian_tensor</span><span class="p">,</span> <span class="n">lattice</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">red_tensor</span><span class="p">,</span> <span class="n">lattice</span><span class="p">,</span><span class="n">space</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">symmetrize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">):</span>
        <span class="n">tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reduced_tensor</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_real_space</span><span class="p">:</span>
            <span class="n">real_lattice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lattice</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">real_lattice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lattice</span><span class="o">.</span><span class="n">reciprocal_lattice</span>

        <span class="c1"># I guess this is the reason why tensor.symmetrize (omega) is so slow!</span>
        <span class="kn">from</span> <span class="nn">pymatgen.symmetry.analyzer</span> <span class="kn">import</span> <span class="n">SpacegroupAnalyzer</span>
        <span class="n">real_finder</span> <span class="o">=</span> <span class="n">SpacegroupAnalyzer</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>

        <span class="n">real_symmops</span> <span class="o">=</span> <span class="n">real_finder</span><span class="o">.</span><span class="n">get_point_group_operations</span><span class="p">(</span><span class="n">cartesian</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">cartesian_tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cartesian_tensor</span>

        <span class="n">sym_tensor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

        <span class="n">my_tensor</span> <span class="o">=</span> <span class="n">cartesian_tensor</span>

        <span class="k">for</span> <span class="n">real_sym</span> <span class="ow">in</span> <span class="n">real_symmops</span><span class="p">:</span>
            <span class="n">mat</span> <span class="o">=</span> <span class="n">real_sym</span><span class="o">.</span><span class="n">rotation_matrix</span>
            <span class="n">prod_sym</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">mat</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cartesian_tensor</span><span class="p">,</span><span class="n">mat</span><span class="p">))</span>
            <span class="n">sym_tensor</span> <span class="o">=</span> <span class="n">sym_tensor</span> <span class="o">+</span> <span class="n">prod_sym</span>

        <span class="n">sym_tensor</span> <span class="o">=</span> <span class="n">sym_tensor</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">real_symmops</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_reduced_tensor</span> <span class="o">=</span> <span class="n">_from_cart_to_red</span><span class="p">(</span><span class="n">sym_tensor</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_lattice</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_SymmetricTensor</span><span class="p">(</span><span class="n">_Tensor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Representation of a 3x3 symmetric tensor&quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_directions</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">qpoints</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">lattice</span><span class="p">,</span> <span class="n">space</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a `_SymmetricTensor` from the values computed along 6 directions.</span>

<span class="sd">        Args:</span>
<span class="sd">            qpoints: fractional coordinates of 6 independent q-directions</span>
<span class="sd">            values: values of (q^T E q)/(q^T q) along the 6 qpoints</span>
<span class="sd">            lattice: `Lattice` object defining the reference system</span>
<span class="sd">            space: &quot;r&quot; if the lattice is a real space lattice</span>
<span class="sd">                   &quot;g&quot; if the lattice is a reciprocal space lattice</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">qpoints</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">qpoints</span><span class="p">)</span>

        <span class="n">mat</span> <span class="o">=</span> <span class="n">lattice</span><span class="o">.</span><span class="n">matrix</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">mat</span><span class="p">),</span><span class="n">mat</span><span class="p">)</span>

        <span class="n">coeffs_red</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">iqpt</span><span class="p">,</span><span class="n">qpt</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">qpoints</span><span class="p">):</span>
            <span class="n">metqpt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span><span class="n">qpt</span><span class="p">)</span>

            <span class="n">coeffs_red</span><span class="p">[</span><span class="n">iqpt</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">metqpt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">metqpt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">metqpt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                                  <span class="mi">2</span><span class="o">*</span><span class="n">metqpt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">metqpt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="o">*</span><span class="n">metqpt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">metqpt</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">2</span><span class="o">*</span><span class="n">metqpt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">metqpt</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

            <span class="n">normqpt_red</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">qpt</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span><span class="n">qpt</span><span class="p">))</span>

            <span class="n">coeffs_red</span><span class="p">[</span><span class="n">iqpt</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">coeffs_red</span><span class="p">[</span><span class="n">iqpt</span><span class="p">,:]</span> <span class="o">/</span> <span class="n">normqpt_red</span>

        <span class="n">red_symm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">coeffs_red</span><span class="p">,</span><span class="n">values</span><span class="p">)</span>

        <span class="n">red_tensor</span> <span class="o">=</span> <span class="p">[[</span><span class="n">red_symm</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">red_symm</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">red_symm</span><span class="p">[</span><span class="mi">4</span><span class="p">]],</span>
                      <span class="p">[</span><span class="n">red_symm</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">red_symm</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">red_symm</span><span class="p">[</span><span class="mi">5</span><span class="p">]],</span>
                      <span class="p">[</span><span class="n">red_symm</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">red_symm</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">red_symm</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">red_tensor</span><span class="p">,</span> <span class="n">lattice</span><span class="p">,</span> <span class="n">space</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, M. Giantomassi and the AbiPy group.
      <span class="lastupdated">
        Last updated on May 28, 2021.
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>