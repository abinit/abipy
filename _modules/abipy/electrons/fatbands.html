<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>abipy.electrons.fatbands &#8212; abipy 0.2.0 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/abipy_logo.png" alt="Logo"/>
            </a></p><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for abipy.electrons.fatbands</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: utf-8</span>
<span class="sd">&quot;&quot;&quot;Classes for the analysis of electronic fatbands and projected DOSes.&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">unicode_literals</span><span class="p">,</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="k">import</span> <span class="n">tabulate</span>
<span class="kn">from</span> <span class="nn">monty.termcolor</span> <span class="k">import</span> <span class="n">cprint</span>
<span class="kn">from</span> <span class="nn">monty.functools</span> <span class="k">import</span> <span class="n">lazy_property</span>
<span class="kn">from</span> <span class="nn">monty.string</span> <span class="k">import</span> <span class="n">marquee</span><span class="p">,</span> <span class="n">list_strings</span>
<span class="kn">from</span> <span class="nn">pymatgen.core.periodic_table</span> <span class="k">import</span> <span class="n">Element</span>
<span class="kn">from</span> <span class="nn">abipy.tools.plotting</span> <span class="k">import</span> <span class="n">add_fig_kwargs</span><span class="p">,</span> <span class="n">get_ax_fig_plt</span>
<span class="kn">from</span> <span class="nn">abipy.core.mixins</span> <span class="k">import</span> <span class="n">AbinitNcFile</span><span class="p">,</span> <span class="n">Has_Structure</span><span class="p">,</span> <span class="n">Has_ElectronBands</span><span class="p">,</span> <span class="n">NotebookWriter</span>
<span class="kn">from</span> <span class="nn">abipy.electrons.ebands</span> <span class="k">import</span> <span class="n">ElectronsReader</span>
<span class="kn">from</span> <span class="nn">abipy.tools</span> <span class="k">import</span> <span class="n">gaussian</span>
<span class="kn">from</span> <span class="nn">abipy.tools.plotting</span> <span class="k">import</span> <span class="n">set_axlims</span>


<div class="viewcode-block" id="gaussians_dos"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.fatbands.gaussians_dos">[docs]</a><span class="k">def</span> <span class="nf">gaussians_dos</span><span class="p">(</span><span class="n">dos</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">energies</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">dos</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">vw</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">values</span> <span class="o">*</span> <span class="n">weights</span><span class="p">,</span> <span class="n">energies</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="n">dos</span> <span class="o">+=</span> <span class="n">vw</span> <span class="o">*</span> <span class="n">gaussian</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dos</span></div>


<div class="viewcode-block" id="FatBandsFile"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.fatbands.FatBandsFile">[docs]</a><span class="k">class</span> <span class="nc">FatBandsFile</span><span class="p">(</span><span class="n">AbinitNcFile</span><span class="p">,</span> <span class="n">Has_Structure</span><span class="p">,</span> <span class="n">Has_ElectronBands</span><span class="p">,</span> <span class="n">NotebookWriter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Provides methods to analyze the data stored in the FATBANDS.nc file.</span>

<span class="sd">    Usage example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        with abiopen(&quot;out_FATBANDS.nc&quot;) as fb:</span>
<span class="sd">            print(fb.structure)</span>
<span class="sd">            fb.plot_fatbands_lview()</span>

<span class="sd">    Alternatively, one can use the abiopen.py script to open the file in an ipython notebook with</span>

<span class="sd">    .. code-block:: shell</span>

<span class="sd">        $ abiopen.py out_FATBANDS.nc -nb</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># These class attributes can be redefined in order to customize the plots.</span>

    <span class="c1"># Mapping L --&gt; color used in plots.</span>
    <span class="n">l2color</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s2">&quot;yellow&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="s2">&quot;orange&quot;</span><span class="p">}</span>

    <span class="c1"># Mapping L --&gt; title used in subplots that depend on L.</span>
    <span class="n">l2tex</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;$l=s$&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;$l=p$&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;$l=d$&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s2">&quot;$l=f$&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="s2">&quot;$l=g$&quot;</span><span class="p">}</span>

    <span class="c1"># Markers used for up/down bands (collinear spin)</span>
    <span class="n">marker_spin</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;v&quot;</span><span class="p">}</span>

    <span class="c1"># Mapping spin --&gt; title used in subplots that depend on (collinear) spin.</span>
    <span class="n">spin2tex</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$\sigma=</span><span class="se">\\</span><span class="s2">uparrow$&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$\sigma=</span><span class="se">\\</span><span class="s2">downarrow$&quot;</span><span class="p">}</span>

    <span class="c1"># Mappings used for non-collinear spins.</span>
    <span class="n">spinors2tex</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;up-up&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$</span><span class="se">\\</span><span class="s2">uparrow,</span><span class="se">\\</span><span class="s2">uparrow$&quot;</span><span class="p">,</span> <span class="s2">&quot;up-down&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$</span><span class="se">\\</span><span class="s2">uparrow,</span><span class="se">\\</span><span class="s2">downarrow$&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;down-up&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$</span><span class="se">\\</span><span class="s2">downarrow,</span><span class="se">\\</span><span class="s2">uparrow$&quot;</span><span class="p">,</span> <span class="s2">&quot;down-down&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$</span><span class="se">\\</span><span class="s2">downarrow,</span><span class="se">\\</span><span class="s2">downarrow$&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;sigma_x&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$\sigma_</span><span class="si">{x}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="s2">&quot;sigma_y&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$\sigma_</span><span class="si">{y}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="s2">&quot;sigma_z&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$\sigma_</span><span class="si">{z}</span><span class="s2">$&quot;</span><span class="p">,</span>
                  <span class="p">}</span>
    <span class="n">spinors2color</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;up-up&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;up-down&quot;</span><span class="p">:</span> <span class="s2">&quot;brown&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;down-up&quot;</span><span class="p">:</span> <span class="s2">&quot;violet&quot;</span><span class="p">,</span> <span class="s2">&quot;down-down&quot;</span><span class="p">:</span> <span class="s2">&quot;yellow&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;sigma_x&quot;</span><span class="p">:</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;sigma_y&quot;</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;sigma_z&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
                   <span class="p">}</span>

    <span class="c1"># The alpha blending value, between 0 (transparent) and 1 (opaque)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.6</span>

    <span class="c1"># Options passed to ebands.plot_ax. See also eb_plotax_kwargs</span>
    <span class="c1"># Either you change these values or subclass `FatBandsFile` and redefine eb_plotax_kwargs.</span>
    <span class="n">marker_size</span> <span class="o">=</span> <span class="mf">3.0</span>
    <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">linecolor</span> <span class="o">=</span> <span class="s2">&quot;grey&quot;</span>
    <span class="c1">#klabel_size = None</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="FatBandsFile.from_file"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.fatbands.FatBandsFile.from_file">[docs]</a>    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the object from a Netcdf file&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FatBandsFile</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="n">r</span> <span class="o">=</span> <span class="n">ElectronsReader</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

        <span class="c1"># Initialize the electron bands from file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ebands</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_ebands</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">natom</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>
        <span class="c1"># TODO: Via ElectronBands Mixin? In this case I have to change Ebands __init__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nspden</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_nspinor</span><span class="p">(),</span> <span class="n">r</span><span class="o">.</span><span class="n">read_nspden</span><span class="p">()</span>

        <span class="c1"># Read metadata so that we know how to handle the content of the file.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prtdos</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;prtdos&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prtdosm</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;prtdosm&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pawprtdos</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;pawprtdos&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">usepaw</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;usepaw&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">natsph</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_dimvalue</span><span class="p">(</span><span class="s2">&quot;natsph&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iatsph</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;iatsph&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="c1"># F --&gt; C</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ndosfraction</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_dimvalue</span><span class="p">(</span><span class="s2">&quot;ndosfraction&quot;</span><span class="p">)</span>
        <span class="c1"># mbesslang: 1 + maximum angular momentum for Bessel function expansion.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mbesslang</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_dimvalue</span><span class="p">(</span><span class="s2">&quot;mbesslang&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ratsph_type</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;ratsph&quot;</span><span class="p">)</span>

        <span class="c1"># natsph_extra is present only if we have an extra sphere.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">natsph_extra</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_dimvalue</span><span class="p">(</span><span class="s2">&quot;natsph_extra&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">natsph_extra</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ratsph_extra</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;ratsph_extra&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xredsph_extra</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;xredsph_extra&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">natsph_extra</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;natsph_extra is not implemented, &quot;</span>
              <span class="s2">&quot;but it&#39;s just a matter of using natom + natsph_extra&quot;</span><span class="p">)</span>

        <span class="c1"># This is a tricky part. Note the following:</span>
        <span class="c1"># If usepaw == 0, lmax_type gives the max l included in the non-local part of Vnl</span>
        <span class="c1">#   The wavefunction can have l-components &gt; lmax_type, especially if vloc = vlmax.</span>
        <span class="c1"># If usepaw == 1, lmax_type represents the max l included in the PAW basis set.</span>
        <span class="c1">#   The AE wavefunction cannot have more ls than l-max if pawprtdos == 2 and</span>
        <span class="c1">#   the cancellation between PS-onsite and the smooth part is exact.</span>
        <span class="c1"># TODO: Decide how to change lmax_type at run-time: API or global self.set_lmax?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmax_type</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;lmax_type&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">usepaw</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">usepaw</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pawprtdos</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmax_type</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbesslang</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">typat</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;atom_species&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="c1"># F --&gt; C</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmax_atom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">iat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmax_atom</span><span class="p">[</span><span class="n">iat</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax_type</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">typat</span><span class="p">[</span><span class="n">iat</span><span class="p">]]</span>
        <span class="c1"># lsize is used to dimension arrays that depend on L.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax_type</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># Sort the chemical symbols and use OrderedDict because we are gonna use these dicts for looping.</span>
        <span class="c1"># Note that we don&#39;t have arrays dimensioned with ntypat in the nc file so we can define</span>
        <span class="c1"># our own ordering for symbols.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">symbol_set</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">Element</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol2indices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax_symbol</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(),</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">symbol2indices</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">indices_from_symbol</span><span class="p">(</span><span class="n">symbol</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmax_symbol</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax_atom</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol2indices</span><span class="p">[</span><span class="n">symbol</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntypat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">)</span>

        <span class="c1"># Mapping chemical symbol --&gt; color used in plots.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol2color</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">symb</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">symbol2color</span><span class="p">[</span><span class="n">symb</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2color</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use colormap. Color will now be an RGBA tuple</span>
            <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
            <span class="n">cm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;jet&#39;</span><span class="p">)</span>
            <span class="n">nsymb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">symb</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">symbol2color</span><span class="p">[</span><span class="n">symb</span><span class="p">]</span> <span class="o">=</span> <span class="n">cm</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="n">nsymb</span><span class="p">)</span>

        <span class="c1"># Array dimensioned with natom. Set to true if iatom has been calculated</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prtdos</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">has_atom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">has_atom</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iatsph</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@lazy_property</span>
<div class="viewcode-block" id="FatBandsFile.wal_sbk"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.fatbands.FatBandsFile.wal_sbk">[docs]</a>    <span class="k">def</span> <span class="nf">wal_sbk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Numpy array of shape [natom, mbesslang, nsppol, mband, nkpt]</span>
<span class="sd">        with the L-contributions. Present only if prtdos == 3.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_wal_sbk</span><span class="p">()</span></div>

    <span class="nd">@lazy_property</span>
<div class="viewcode-block" id="FatBandsFile.walm_sbk"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.fatbands.FatBandsFile.walm_sbk">[docs]</a>    <span class="k">def</span> <span class="nf">walm_sbk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Numpy array of shape [natom, mbesslang**2, nsppol, mband, nkpt]</span>
<span class="sd">        with the LM-contribution. Present only if prtdos == 3 and prtdosm != 0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_walm_sbk</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;dos_fractions&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_read_wal_sbk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;dos_fractions&quot;</span><span class="p">):</span>
        <span class="c1"># Read dos_fraction_m from file and build wal_sbk array of shape</span>
        <span class="c1"># [natom, lmax, nsppol, mband, nkpt].</span>
        <span class="c1">#</span>
        <span class="c1"># In abinit the **Fortran** array has shape</span>
        <span class="c1">#   dos_fractions(nkpt,mband,nsppol,ndosfraction)</span>
        <span class="c1">#</span>
        <span class="c1"># Note that Abinit allows the users to select a subset of atoms with iatsph. Moreover the order</span>
        <span class="c1"># of the atoms could differ from the one in the structure even when natom == natsph (unlikely but possible).</span>
        <span class="c1"># To keep it simple, the code always operate on an array dimensioned with the total number of atoms</span>
        <span class="c1"># Entries that are not computed are set to zero and a warning is issued.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prtdos</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The file does not contain L-DOS since prtdos=</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">prtdos</span><span class="p">)</span>

        <span class="n">wshape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbesslang</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mband</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">natsph</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">natom</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iatsph</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">)):</span>
            <span class="c1"># All atoms have been calculated and the order if ok.</span>
            <span class="n">wal_sbk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">wshape</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Need to tranfer data. Note np.zeros.</span>
            <span class="n">wal_sbk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">wshape</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">natsph</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">natom</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iatsph</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">)):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Will rearrange filedata since iatsp != [1, 2, ...])&quot;</span><span class="p">)</span>
                <span class="n">filedata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">wshape</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">iatom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iatsph</span><span class="p">):</span>
                    <span class="n">wal_sbk</span><span class="p">[</span><span class="n">iatom</span><span class="p">]</span> <span class="o">=</span> <span class="n">filedata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;natsph &lt; natom. Will set to zero the PJDOS contributions for the atoms that are not included.&quot;</span><span class="p">)</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">natsph</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">natom</span>
                <span class="n">filedata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="n">key</span><span class="p">),</span>
                                     <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natsph</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbesslang</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mband</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">iatom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iatsph</span><span class="p">):</span>
                    <span class="n">wal_sbk</span><span class="p">[</span><span class="n">iatom</span><span class="p">]</span> <span class="o">=</span> <span class="n">filedata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># In principle, this should never happen (unless there&#39;s a bug in Abinit or a</span>
        <span class="c1"># very bad cancellation between the FFT and the PS-PAW term (pawprtden=0).</span>
        <span class="n">num_neg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">wal_sbk</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_neg</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: There are </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%.1f%%</span><span class="s2">) negative entries in LDOS weights&quot;</span> <span class="o">%</span> <span class="p">(</span>
                  <span class="n">num_neg</span><span class="p">,</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">num_neg</span> <span class="o">/</span> <span class="n">wal_sbk</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">wal_sbk</span>

    <span class="k">def</span> <span class="nf">_read_walm_sbk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;dos_fraction_m&quot;</span><span class="p">):</span>
        <span class="c1"># Read dos_fraction_m from file and build walm_sbk array of shape</span>
        <span class="c1"># [natom, lmax**2, nsppol, mband, nkpt].</span>
        <span class="c1">#</span>
        <span class="c1"># In abinit the **Fortran** array has shape</span>
        <span class="c1">#   dos_fractions_m(nkpt,mband,nsppol,ndosfraction*mbesslang*m_dos_flag)</span>
        <span class="c1">#</span>
        <span class="c1"># Note that Abinit allows the users to select a subset of atoms with iatsph. Moreover the order</span>
        <span class="c1"># of the atoms could differ from the one in the structure even when natom == natsph (unlikely but possible).</span>
        <span class="c1"># To keep it simple, the code always operate on an array dimensioned with the total number of atoms</span>
        <span class="c1"># Entries that are not computed are set to zero and a warning is issued.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prtdos</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The file does not contain L-DOS since prtdos=</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">prtdos</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prtdosm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The file does not contain LM-DOS since prtdosm=</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">prtdosm</span><span class="p">)</span>

        <span class="n">wshape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbesslang</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mband</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">natsph</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">natom</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iatsph</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">)):</span>
            <span class="c1"># All atoms have been calculated and the order if ok.</span>
            <span class="n">walm_sbk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">wshape</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Need to tranfer data. Note np.zeros.</span>
            <span class="n">walm_sbk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">wshape</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">natsph</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">natom</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iatsph</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">)):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Will rearrange filedata since iatsp != [1, 2, ...])&quot;</span><span class="p">)</span>
                <span class="n">filedata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">wshape</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">iatom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iatsph</span><span class="p">):</span>
                    <span class="n">walm_sbk</span><span class="p">[</span><span class="n">iatom</span><span class="p">]</span> <span class="o">=</span> <span class="n">filedata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;natsph &lt; natom. Will set to zero the PJDOS contributions for the atoms that are not included.&quot;</span><span class="p">)</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">natsph</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">natom</span>
                <span class="n">filedata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="n">key</span><span class="p">),</span>
                                     <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natsph</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbesslang</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mband</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">iatom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iatsph</span><span class="p">):</span>
                    <span class="n">walm_sbk</span><span class="p">[</span><span class="n">iatom</span><span class="p">]</span> <span class="o">=</span> <span class="n">filedata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># In principle, this should never happen (unless there&#39;s a bug in Abinit or a</span>
        <span class="c1"># very bad cancellation between the FFT and the PS-PAW term (pawprtden=0).</span>
        <span class="n">num_neg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">walm_sbk</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_neg</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: There are </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%.1f%%</span><span class="s2">) negative entries in LDOS weights&quot;</span> <span class="o">%</span> <span class="p">(</span>
                  <span class="n">num_neg</span><span class="p">,</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">num_neg</span> <span class="o">/</span> <span class="n">walm_sbk</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">walm_sbk</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ebands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;:class:`ElectronBands` object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ebands</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;:class:`Structure` object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">structure</span>

<div class="viewcode-block" id="FatBandsFile.close"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.fatbands.FatBandsFile.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called at the end of the `with` context manager.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>

        <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="s2">&quot;File Info&quot;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filestat</span><span class="p">(</span><span class="n">as_string</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">with_structure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Electronic Bands&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="s2">&quot;Fatbands Info&quot;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;prtdos=</span><span class="si">%d</span><span class="s2">, prtdosm=</span><span class="si">%d</span><span class="s2">, mbesslang=</span><span class="si">%d</span><span class="s2">, pawprtdos=</span><span class="si">%d</span><span class="s2">, usepaw=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prtdos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prtdosm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbesslang</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pawprtdos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">usepaw</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;nsppol=</span><span class="si">%d</span><span class="s2">, nkpt=</span><span class="si">%d</span><span class="s2">, mband=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mband</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prtdos</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># Print table with info on atoms.</span>
            <span class="n">table</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;Idx&quot;</span><span class="p">,</span> <span class="s2">&quot;Symbol&quot;</span><span class="p">,</span> <span class="s2">&quot;Reduced_Coords&quot;</span><span class="p">,</span> <span class="s2">&quot;Lmax&quot;</span><span class="p">,</span> <span class="s2">&quot;Ratsph [Bohr]&quot;</span><span class="p">,</span> <span class="s2">&quot;Has_Atom&quot;</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">iatom</span><span class="p">,</span> <span class="n">site</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">):</span>
                <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                    <span class="n">iatom</span><span class="p">,</span>
                    <span class="n">site</span><span class="o">.</span><span class="n">specie</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
                    <span class="s2">&quot;</span><span class="si">%.5f</span><span class="s2"> </span><span class="si">%.5f</span><span class="s2"> </span><span class="si">%.5f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lmax_atom</span><span class="p">[</span><span class="n">iatom</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ratsph_type</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">typat</span><span class="p">[</span><span class="n">iatom</span><span class="p">]],</span>
                    <span class="s2">&quot;Yes&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_atom</span><span class="p">[</span><span class="n">iatom</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;No&quot;</span><span class="p">,</span>
                <span class="p">])</span>
            <span class="n">app</span><span class="p">(</span><span class="n">tabulate</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">&quot;firstrow&quot;</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

<div class="viewcode-block" id="FatBandsFile.get_wl_atom"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.fatbands.FatBandsFile.get_wl_atom">[docs]</a>    <span class="k">def</span> <span class="nf">get_wl_atom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iatom</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the l-dependent DOS weights for atom index `iatom`. The weights are summed over m.</span>
<span class="sd">        If `spin` and `band` are not specified, the method returns the weights</span>
<span class="sd">        for all spin and bands else the contribution for (spin, band)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">spin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">band</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wal_sbk</span><span class="p">[</span><span class="n">iatom</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">spin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">band</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wal_sbk</span><span class="p">[</span><span class="n">iatom</span><span class="p">,</span> <span class="p">:,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="p">:]</span></div>

<div class="viewcode-block" id="FatBandsFile.get_wl_symbol"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.fatbands.FatBandsFile.get_wl_symbol">[docs]</a>    <span class="k">def</span> <span class="nf">get_wl_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the l-dependent DOS weights for a given type specified in terms of the</span>
<span class="sd">        chemical symbol `symbol`. The weights are summed over m and over all atoms of the same type.</span>
<span class="sd">        If `spin` and `band` are not specified, the method returns the weights</span>
<span class="sd">        for all spins and bands else the contribution for (spin, band).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">spin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">band</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">wl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">lsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mband</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">iat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol2indices</span><span class="p">[</span><span class="n">symbol</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmax_atom</span><span class="p">[</span><span class="n">iat</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">wl</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wal_sbk</span><span class="p">[</span><span class="n">iat</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">spin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">band</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">wl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">lsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">iat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol2indices</span><span class="p">[</span><span class="n">symbol</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmax_atom</span><span class="p">[</span><span class="n">iat</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">wl</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wal_sbk</span><span class="p">[</span><span class="n">iat</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="p">:]</span>

        <span class="k">return</span> <span class="n">wl</span></div>

<div class="viewcode-block" id="FatBandsFile.get_w_symbol"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.fatbands.FatBandsFile.get_w_symbol">[docs]</a>    <span class="k">def</span> <span class="nf">get_w_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the DOS weights for a given type specified in terms of the</span>
<span class="sd">        chemical symbol `symbol`. The weights are summed over m and lmax[symbol] and</span>
<span class="sd">        over all atoms of the same type.</span>
<span class="sd">        If `spin` and `band` are not specified, the method returns the weights</span>
<span class="sd">        for all spins and bands else the contribution for (spin, band).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">spin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">band</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">wl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wl_symbol</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mband</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmax_symbol</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">w</span> <span class="o">+=</span> <span class="n">wl</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">spin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">band</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">wl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wl_symbol</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="n">spin</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmax_symbol</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">w</span> <span class="o">+=</span> <span class="n">wl</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">w</span></div>

<div class="viewcode-block" id="FatBandsFile.get_spilling"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.fatbands.FatBandsFile.get_spilling">[docs]</a>    <span class="k">def</span> <span class="nf">get_spilling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the spilling parameter</span>
<span class="sd">        If `spin` and `band` are not specified, the method returns the spilling for all states</span>
<span class="sd">        as a [nsppol, mband, nkpt] numpy array else the spilling for (spin, band) with shape [nkpt].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">spin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">band</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mband</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">iatom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmax_atom</span><span class="p">[</span><span class="n">iatom</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">sp</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wal_sbk</span><span class="p">[</span><span class="n">iatom</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">spin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">band</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">iatom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmax_atom</span><span class="p">[</span><span class="n">iatom</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">sp</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wal_sbk</span><span class="p">[</span><span class="n">iatom</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="p">:]</span>

        <span class="k">return</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">sp</span></div>

<div class="viewcode-block" id="FatBandsFile.eb_plotax_kwargs"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.fatbands.FatBandsFile.eb_plotax_kwargs">[docs]</a>    <span class="k">def</span> <span class="nf">eb_plotax_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dictionary with the options passed to ebands.plot_ax</span>
<span class="sd">        when plotting a band line with spin index `spin`.</span>
<span class="sd">        Subclasses can redefine the implementation to customize the plots.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linecolor</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linewidth</span><span class="p">,</span>
            <span class="n">markersize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">marker_size</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">marker_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">],</span>
            <span class="c1">#klabel_size=self.klabel_size,</span>
        <span class="p">)</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="FatBandsFile.plot_fatbands_siteview"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.fatbands.FatBandsFile.plot_fatbands_siteview">[docs]</a>    <span class="k">def</span> <span class="nf">plot_fatbands_siteview</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="s2">&quot;inequivalent&quot;</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
                               <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">blist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot fatbands for each atom in the unit cell. By default, only the &quot;inequivalent&quot; atoms are shown.</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - `fermie`: shift all eigenvalues to have zero energy at the Fermi energy.</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">            view: &quot;inequivalent&quot;, &quot;all&quot;</span>
<span class="sd">            fact:  float used to scale the stripe size.</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used</span>
<span class="sd">            blist: List of band indices for the fatband plot. If None, all bands are included</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Define num_plots and ax2atom depending on view.</span>
        <span class="c1"># ax2natom[1:num_plots] --&gt; iatom index in structure.</span>
        <span class="c1"># TODO: ebands.used_magnetic_symmetries?</span>
        <span class="k">if</span> <span class="n">view</span> <span class="o">==</span> <span class="s2">&quot;inequivalent&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nspden</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspden</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The system contains magnetic symmetries but the spglib API used by pymg does not handle them.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Setting view to `all`&quot;</span><span class="p">)</span>
            <span class="n">view</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span>

        <span class="c1"># TODO: spin</span>
        <span class="k">if</span> <span class="n">view</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">natom</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">num_plots</span><span class="p">,</span> <span class="n">ax2iatom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="s2">&quot;inequivalent&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calling spglib to find inequivalent sites.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Note that magnetic symmetries are not taken into account&quot;</span><span class="p">)</span>
            <span class="kn">from</span> <span class="nn">pymatgen.symmetry.analyzer</span> <span class="k">import</span> <span class="n">SpacegroupAnalyzer</span>
            <span class="n">spgan</span> <span class="o">=</span> <span class="n">SpacegroupAnalyzer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>
            <span class="n">spgdata</span> <span class="o">=</span> <span class="n">spgan</span><span class="o">.</span><span class="n">get_symmetry_dataset</span><span class="p">()</span>
            <span class="n">equivalent_atoms</span> <span class="o">=</span> <span class="n">spgdata</span><span class="p">[</span><span class="s2">&quot;equivalent_atoms&quot;</span><span class="p">]</span>
            <span class="n">ax2iatom</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">eqmap</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">eqpos</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">equivalent_atoms</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="n">eqpos</span><span class="p">:</span> <span class="n">ax2iatom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
                <span class="n">eqmap</span><span class="p">[</span><span class="n">eqpos</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">ax2iatom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax2iatom</span><span class="p">)</span>
            <span class="n">num_plots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax2iatom</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> inequivalent position(s).&quot;</span> <span class="o">%</span> <span class="n">num_plots</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">irr_pos</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">eqmap</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Irred_Site: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">[</span><span class="n">irr_pos</span><span class="p">]))</span>
                <span class="k">for</span> <span class="n">eqind</span> <span class="ow">in</span> <span class="n">eqmap</span><span class="p">[</span><span class="n">irr_pos</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">eqind</span> <span class="o">==</span> <span class="n">irr_pos</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">SymEq: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">[</span><span class="n">eqind</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wrong value for view: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">view</span><span class="p">))</span>

        <span class="c1"># Build plot grid.</span>
        <span class="n">ncols</span><span class="p">,</span> <span class="n">nrows</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">num_plots</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="n">num_plots</span> <span class="o">//</span> <span class="n">ncols</span> <span class="o">+</span> <span class="n">num_plots</span> <span class="o">%</span> <span class="n">ncols</span>

        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axmat</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># don&#39;t show the last ax if num_plots is odd.</span>
        <span class="k">if</span> <span class="n">num_plots</span> <span class="o">%</span> <span class="n">ncols</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">axmat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

        <span class="n">ebands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">)</span>
        <span class="n">mybands</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">ebands</span><span class="o">.</span><span class="n">mband</span><span class="p">)</span> <span class="k">if</span> <span class="n">blist</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">blist</span>

        <span class="k">for</span> <span class="n">iax</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axmat</span><span class="o">.</span><span class="n">flat</span><span class="p">):</span>
            <span class="n">iatom</span> <span class="o">=</span> <span class="n">ax2iatom</span><span class="p">[</span><span class="n">iax</span><span class="p">]</span>
            <span class="c1"># Plot the energies.</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                <span class="n">ebands</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">eb_plotax_kwargs</span><span class="p">(</span><span class="n">spin</span><span class="p">))</span>

            <span class="n">site</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">[</span><span class="n">iatom</span><span class="p">]</span>
            <span class="n">ebands</span><span class="o">.</span><span class="n">decorate_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">site</span><span class="p">))</span>

            <span class="c1"># Add width around each band.</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="n">ebands</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">mybands</span><span class="p">:</span>
                    <span class="n">wlk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wl_atom</span><span class="p">(</span><span class="n">iatom</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">fact</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">yup</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="p">:,</span> <span class="n">band</span><span class="p">]</span> <span class="o">-</span> <span class="n">e0</span>
                    <span class="n">ydown</span> <span class="o">=</span> <span class="n">yup</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmax_atom</span><span class="p">[</span><span class="n">iatom</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="n">wlk</span><span class="p">[</span><span class="n">l</span><span class="p">,:]</span>
                        <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">yup</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span> <span class="n">ydown</span> <span class="o">-</span> <span class="n">w</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">yup</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">l2color</span><span class="p">[</span><span class="n">l</span><span class="p">])</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ydown</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">l2color</span><span class="p">[</span><span class="n">l</span><span class="p">],</span>
                                        <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">l2tex</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                                        <span class="c1"># Note: could miss a label in the other plots if lmax is not large enough!</span>
                        <span class="n">yup</span><span class="p">,</span> <span class="n">ydown</span> <span class="o">=</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span>

            <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="n">axmat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="FatBandsFile.plot_fatbands_lview"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.fatbands.FatBandsFile.plot_fatbands_lview">[docs]</a>    <span class="k">def</span> <span class="nf">plot_fatbands_lview</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">axmat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">blist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the electronic fatbands grouped by L.</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - `fermie`: shift all eigenvalues to have zero energy at the Fermi energy.</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">            fact:  float used to scale the stripe size.</span>
<span class="sd">            axmat: Matrix of axes, if None new figure is produce.</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used</span>
<span class="sd">            blist: List of band indices for the fatband plot. If None, all bands are included</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mylsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lsize</span> <span class="k">if</span> <span class="n">lmax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="c1"># Build or get grid with (nsppol, mylsize) axis.</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="k">if</span> <span class="n">axmat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axmat</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">mylsize</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">axmat</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="n">mylsize</span><span class="p">))</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>

        <span class="n">ebands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">)</span>
        <span class="n">mybands</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">ebands</span><span class="o">.</span><span class="n">mband</span><span class="p">)</span> <span class="k">if</span> <span class="n">blist</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">blist</span>

        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mylsize</span><span class="p">):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axmat</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>
                <span class="n">ebands</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">eb_plotax_kwargs</span><span class="p">(</span><span class="n">spin</span><span class="p">))</span>
                <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l2tex</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin2tex</span><span class="p">[</span><span class="n">spin</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2tex</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
                <span class="n">ebands</span><span class="o">.</span><span class="n">decorate_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">l</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="c1"># Only the first column show labels.</span>
                    <span class="c1"># Trick: Don&#39;t change the labels but set their fontsize to 0 otherwise</span>
                    <span class="c1"># also the other axes are affected (likely due to sharey=True).</span>
                    <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_major_ticks</span><span class="p">():</span>
                        <span class="n">tick</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">ib</span><span class="p">,</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mybands</span><span class="p">):</span>
                    <span class="n">yup</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="p">:,</span> <span class="n">band</span><span class="p">]</span> <span class="o">-</span> <span class="n">e0</span>
                    <span class="n">ydown</span> <span class="o">=</span> <span class="n">yup</span>
                    <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
                        <span class="n">wlk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wl_symbol</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">fact</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="n">wlk</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
                        <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">yup</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span> <span class="n">ydown</span> <span class="o">-</span> <span class="n">w</span>
                        <span class="c1"># Add width around each band. Only the [0,0] plot has the legend.</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">yup</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol2color</span><span class="p">[</span><span class="n">symbol</span><span class="p">])</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ydown</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol2color</span><span class="p">[</span><span class="n">symbol</span><span class="p">],</span>
                                        <span class="n">label</span><span class="o">=</span><span class="n">symbol</span> <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">ib</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="n">yup</span><span class="p">,</span> <span class="n">ydown</span> <span class="o">=</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span>

                <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="n">axmat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="FatBandsFile.plot_fatbands_mview"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.fatbands.FatBandsFile.plot_fatbands_mview">[docs]</a>    <span class="k">def</span> <span class="nf">plot_fatbands_mview</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iatom</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="mf">6.0</span><span class="p">,</span> <span class="n">lmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">blist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the electronic fatbands grouped by LM.</span>

<span class="sd">        Args:</span>
<span class="sd">            iatom: Index of the atom in the structure.</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - `fermie`: shift all eigenvalues to have zero energy at the Fermi energy.</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">            fact:  float used to scale the stripe size.</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used</span>
<span class="sd">            blist: List of band indices for the fatband plot. If None, all bands are included</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;To be tested with spin&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prtdos</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prtdosm</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Fatbands plots with LM-character require `prtdos = 3 and prtdosm != 0`&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">mylmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax_atom</span><span class="p">[</span><span class="n">iatom</span><span class="p">]</span> <span class="k">if</span> <span class="n">lmax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">lmax</span>

        <span class="c1"># Build plot grid.</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="k">import</span> <span class="n">GridSpec</span><span class="p">,</span> <span class="n">GridSpecFromSubplotSpec</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">mylmax</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">mylmax</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">gspec</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">)</span>
        <span class="n">gspec</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="n">ax_lim</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrows</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">):</span>
                <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">im</span><span class="p">)</span>
                <span class="n">ax00</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">ax_lim</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="n">im</span><span class="p">,</span> <span class="n">l</span><span class="p">],</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax00</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax00</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">im</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1">#ax.set_title(&quot;l=%d, m=%d&quot; % (l, im - l))</span>
                    <span class="n">ax_lim</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">ax</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

        <span class="n">ebands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">)</span>
        <span class="n">mybands</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">ebands</span><span class="o">.</span><span class="n">mband</span><span class="p">)</span> <span class="k">if</span> <span class="n">blist</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">blist</span>

        <span class="k">for</span> <span class="n">lim</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">ax_lim</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">l</span><span class="p">,</span> <span class="n">im</span> <span class="o">=</span> <span class="n">lim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                <span class="n">ebands</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">eb_plotax_kwargs</span><span class="p">(</span><span class="n">spin</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">im</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">l</span><span class="p">:</span>
               <span class="n">ebands</span><span class="o">.</span><span class="n">decorate_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
            <span class="c1">#if l &gt; 0:</span>
            <span class="c1">#    ax.set_ylabel(&quot;&quot;)</span>

            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">mybands</span><span class="p">:</span>
                    <span class="n">yup</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="p">:,</span> <span class="n">band</span><span class="p">]</span> <span class="o">-</span> <span class="n">e0</span>
                    <span class="n">ydown</span> <span class="o">=</span> <span class="n">yup</span>

                    <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">walm_sbk</span><span class="p">[</span><span class="n">iatom</span><span class="p">,</span>  <span class="n">l</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">im</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">fact</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">yup</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span> <span class="n">ydown</span> <span class="o">-</span> <span class="n">w</span>
                    <span class="c1"># Add width around each band.</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">yup</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">l2color</span><span class="p">[</span><span class="n">l</span><span class="p">])</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ydown</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">l2color</span><span class="p">[</span><span class="n">l</span><span class="p">])</span>
                    <span class="n">yup</span><span class="p">,</span> <span class="n">ydown</span> <span class="o">=</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span>

            <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="FatBandsFile.plot_fatbands_typeview"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.fatbands.FatBandsFile.plot_fatbands_typeview">[docs]</a>    <span class="k">def</span> <span class="nf">plot_fatbands_typeview</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">axmat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">blist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the electronic fatbands grouped by atomic type.</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - `fermie`: shift all eigenvalues to have zero energy at the Fermi energy.</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">            fact:  float used to scale the stripe size.</span>
<span class="sd">            axmat:</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used</span>
<span class="sd">            blist: List of band indices for the fatband plot. If None, all bands are included</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get axmat and fig.</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="k">if</span> <span class="n">axmat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axmat</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ntypat</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">axmat</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntypat</span><span class="p">))</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>

        <span class="n">ebands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">)</span>
        <span class="n">mybands</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">ebands</span><span class="o">.</span><span class="n">mband</span><span class="p">)</span> <span class="k">if</span> <span class="n">blist</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">blist</span>

        <span class="k">for</span> <span class="n">itype</span><span class="p">,</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">):</span>
            <span class="n">wl_sbk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wl_symbol</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">fact</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axmat</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">itype</span><span class="p">]</span>
                <span class="n">ebands</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">eb_plotax_kwargs</span><span class="p">(</span><span class="n">spin</span><span class="p">))</span>

                <span class="n">title</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;type=</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin2tex</span><span class="p">[</span><span class="n">spin</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span>
                         <span class="k">else</span> <span class="s2">&quot;type=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">symbol</span><span class="p">)</span>
                <span class="n">ebands</span><span class="o">.</span><span class="n">decorate_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">itype</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

                <span class="c1"># Plot fatbands for give (symbol, spin) and all angular momenta.</span>
                <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">mybands</span><span class="p">:</span>
                    <span class="n">yup</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="p">:,</span> <span class="n">band</span><span class="p">]</span> <span class="o">-</span> <span class="n">e0</span>
                    <span class="n">ydown</span> <span class="o">=</span> <span class="n">yup</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmax_symbol</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                        <span class="c1"># Add width around each band.</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="n">wl_sbk</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="p">]</span>
                        <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">yup</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span> <span class="n">ydown</span> <span class="o">-</span> <span class="n">w</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">yup</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">l2color</span><span class="p">[</span><span class="n">l</span><span class="p">])</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ydown</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">l2color</span><span class="p">[</span><span class="n">l</span><span class="p">],</span>
                                        <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">l2tex</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">itype</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                                        <span class="c1"># Note: could miss a label in the other plots if lmax is not large enough!</span>
                        <span class="n">yup</span><span class="p">,</span> <span class="n">ydown</span> <span class="o">=</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span>

                <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="n">axmat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="FatBandsFile.plot_spilling"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.fatbands.FatBandsFile.plot_spilling">[docs]</a>    <span class="k">def</span> <span class="nf">plot_spilling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">axlist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">blist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the electronic fatbands</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - `fermie`: shift all eigenvalues to have zero energy at the Fermi energy.</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">            fact:  float used to scale the stripe size.</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used</span>
<span class="sd">            blist: List of band indices for the fatband plot. If None, all bands are included</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="k">if</span> <span class="n">axlist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axlist</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">axlist</span> <span class="o">=</span> <span class="n">axlist</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">axlist</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>

        <span class="n">ebands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">)</span>
        <span class="n">mybands</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">ebands</span><span class="o">.</span><span class="n">mband</span><span class="p">)</span> <span class="k">if</span> <span class="n">blist</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">blist</span>
        <span class="n">spill_sbk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spilling</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="n">fact</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axlist</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span>
            <span class="n">ebands</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">eb_plotax_kwargs</span><span class="p">(</span><span class="n">spin</span><span class="p">))</span>
            <span class="n">ebands</span><span class="o">.</span><span class="n">decorate_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">mybands</span><span class="p">:</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="p">:,</span> <span class="n">band</span><span class="p">]</span> <span class="o">-</span> <span class="n">e0</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">spill_sbk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="p">:]</span>

                <span class="c1"># Handle negative spilling values.</span>
                <span class="n">wispos</span> <span class="o">=</span> <span class="n">w</span> <span class="o">&gt;=</span> <span class="mf">0.0</span>
                <span class="n">wisneg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">wispos</span><span class="p">)</span>
                <span class="n">num_neg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">wisneg</span><span class="p">)</span>

                <span class="c1"># Add width around each band.</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">wispos</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">w</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">wispos</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span>

                <span class="c1"># Show regions with negative spilling in red.</span>
                <span class="k">if</span> <span class="n">num_neg</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;For spin:&quot;</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="s2">&quot;band:&quot;</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span>
                          <span class="s2">&quot;There are </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%.1f%%</span><span class="s2">) k-points with negative spilling. Min: </span><span class="si">%.2E</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                           <span class="n">num_neg</span><span class="p">,</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">num_neg</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">min</span><span class="p">()))</span>

                    <span class="n">absw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">absw</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">wisneg</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">absw</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">wisneg</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>

            <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="FatBandsFile.plot_fatbands_spinor"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.fatbands.FatBandsFile.plot_fatbands_spinor">[docs]</a>    <span class="k">def</span> <span class="nf">plot_fatbands_spinor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">terms</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;sigma_z&quot;</span><span class="p">,),</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                             <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">blist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axlist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot spinor-resolved electronic fatbands. Require prtdos = 5 and nspinor = 2.</span>

<span class="sd">        Args:</span>
<span class="sd">            terms: List of strings defining the quantities to plot. Possible values in:</span>

<span class="sd">                {&quot;up-up&quot;, &quot;up-down&quot;, &quot;down-up&quot;, &quot;down-down&quot;, &quot;sigma_x&quot;, &quot;sigma_y&quot;, &quot;sigma_z&quot;}</span>

<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - `fermie`: shift all eigenvalues to have zero energy at the Fermi energy.</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">            fact:  float used to scale the marker size.</span>
<span class="sd">            axlist: List of matplotlib axes for plot. If None, new figure is produced</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used</span>
<span class="sd">            blist: List of band indices for the fatband plot. If None, all bands are included</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prtdos</span> <span class="o">!=</span> <span class="mi">5</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;This method assumes prtdos=5 and nspinor=2 but file has prtdos=</span><span class="si">%s</span><span class="s2"> and nspinor=</span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prtdos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Build axlist</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="k">if</span> <span class="n">axlist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axlist</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">terms</span><span class="p">),</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">axlist</span> <span class="o">=</span> <span class="n">axlist</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">axlist</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">terms</span><span class="p">)))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>

        <span class="n">ebands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
        <span class="n">xvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">)</span>
        <span class="n">mybands</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">ebands</span><span class="o">.</span><span class="n">mband</span><span class="p">)</span> <span class="k">if</span> <span class="n">blist</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">blist</span>
        <span class="n">spin0</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Dos fractions contains: [ndosfraction, nsppol, mband, nkpt].</span>
        <span class="c1"># where the first dimension stores: (up,up  up,down  down,up  down,down  sigma_x sigma_y sigma_z)</span>
        <span class="n">w_sbk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;dos_fractions&quot;</span><span class="p">)</span>
        <span class="n">term2idx</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;up-up&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;up-down&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;down-up&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;down-down&quot;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;sigma_x&quot;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;sigma_y&quot;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;sigma_z&quot;</span><span class="p">:</span><span class="mi">6</span><span class="p">}</span>

        <span class="c1"># TODO: To be tested.</span>
        <span class="n">terms</span> <span class="o">=</span> <span class="n">list_strings</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">terms</span><span class="p">,</span> <span class="n">axlist</span><span class="p">)):</span>
            <span class="n">ebands</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="n">spin0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linecolor</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linewidth</span><span class="p">)</span>
            <span class="n">ebands</span><span class="o">.</span><span class="n">decorate_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">term</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="c1"># Only the first column show labels.</span>
                <span class="c1"># Trick: Don&#39;t change the labels but set their fontsize to 0 otherwise</span>
                <span class="c1"># also the other axes are affecred (likely due to sharey=True).</span>
                <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_major_ticks</span><span class="p">():</span>
                    <span class="n">tick</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">idx</span> <span class="o">=</span> <span class="n">term2idx</span><span class="p">[</span><span class="n">term</span><span class="p">]</span>
            <span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spinors2color</span><span class="p">[</span><span class="n">term</span><span class="p">]</span>
            <span class="c1"># Rescale weights in [0, 1]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">w_sbk</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">spin0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">-=</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">dmax</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">dmax</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span> <span class="n">data</span> <span class="o">/=</span> <span class="n">dmax</span>
            <span class="c1">#print(data)</span>

            <span class="k">for</span> <span class="n">ib</span><span class="p">,</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mybands</span><span class="p">):</span>
                <span class="n">yvals</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin0</span><span class="p">,</span> <span class="p">:,</span> <span class="n">band</span><span class="p">]</span> <span class="o">-</span> <span class="n">e0</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">yvals</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">band</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
                           <span class="c1">#edgecolor=plt.get_cmap(&#39;jet&#39;)(data[band]),</span>
                           <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spinors2tex</span><span class="p">[</span><span class="n">term</span><span class="p">]</span> <span class="k">if</span> <span class="n">ib</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

                <span class="c1">#ws = w_sbk[idx, spin0, band, :] * fact</span>
                <span class="c1">#pos_inds, neg_inds = np.where(ws &gt;= 0), np.where(ws &lt; 0)</span>
                <span class="c1">#ax.scatter(xvals[pos_inds], yvals[pos_inds], c=color, s=ws[pos_inds],</span>
                <span class="c1">#           marker=&quot;^&quot;, label=term if ib == 0 else None)</span>
                <span class="c1">#ax.scatter(xvals[neg_inds], yvals[neg_inds], c=color, s=np.abs(ws[neg_inds]),</span>
                <span class="c1">#           marker=&quot;v&quot;, label=term if ib == 0 else None)</span>

            <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="n">axlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="FatBandsFile.nelect_in_spheres"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.fatbands.FatBandsFile.nelect_in_spheres">[docs]</a>    <span class="k">def</span> <span class="nf">nelect_in_spheres</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_energy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop_energy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">method</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print the number of electrons inside each atom-centered sphere.</span>
<span class="sd">        Note that this is a very crude estimate of the charge density distribution.</span>

<span class="sd">        Args:</span>
<span class="sd">            start_energy: PJDOS is integrated from this energy [eV]. If None, the lower bound in used.</span>
<span class="sd">            stop_energy: PJDOS is integrated up to this energy [eV]. If None, the Fermi level is used.</span>
<span class="sd">            method: String defining the method for the computation of the DOS.</span>
<span class="sd">            step: Energy step (eV) of the linear mesh.</span>
<span class="sd">            width: Standard deviation (eV) of the gaussian.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">intg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dos_integrator</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">site_edos</span> <span class="o">=</span> <span class="n">intg</span><span class="o">.</span><span class="n">site_edos</span>
        <span class="k">if</span> <span class="n">stop_energy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">stop_energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">fermie</span>

        <span class="c1"># find_mesh_indes returns the first point in the mesh whose value is &gt;= value. -1 if not found</span>
        <span class="n">edos</span> <span class="o">=</span> <span class="n">site_edos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">start_spin</span><span class="p">,</span> <span class="n">stop_spin</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">start_energy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">edos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span><span class="o">.</span><span class="n">find_mesh_index</span><span class="p">(</span><span class="n">start_energy</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;For spin </span><span class="si">%d</span><span class="s2">: cannot find index in mesh such that mesh[i] &gt;= start.&quot;</span> <span class="o">%</span> <span class="n">spin</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">start</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">start_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span> <span class="o">=</span> <span class="n">start</span>

            <span class="n">stop</span> <span class="o">=</span> <span class="n">edos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span><span class="o">.</span><span class="n">find_mesh_index</span><span class="p">(</span><span class="n">stop_energy</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stop</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;For spin </span><span class="si">%d</span><span class="s2">: cannot find index in mesh such that mesh[i] &gt;= energy.&quot;</span> <span class="o">%</span> <span class="n">spin</span><span class="p">)</span>
            <span class="n">stop_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span> <span class="o">=</span> <span class="n">stop</span>

        <span class="k">for</span> <span class="n">iatm</span><span class="p">,</span> <span class="n">site</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">):</span>
            <span class="n">edos</span> <span class="o">=</span> <span class="n">site_edos</span><span class="p">[</span><span class="n">iatm</span><span class="p">]</span>
            <span class="n">nel_spin</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
                <span class="n">nel_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span> <span class="o">=</span> <span class="n">edos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span><span class="o">.</span><span class="n">integral</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">],</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;iatom&quot;</span><span class="p">,</span> <span class="n">iatm</span><span class="p">,</span> <span class="s2">&quot;site&quot;</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">nel_spin</span><span class="p">)</span></div>

<div class="viewcode-block" id="FatBandsFile.get_dos_integrator"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.fatbands.FatBandsFile.get_dos_integrator">[docs]</a>    <span class="k">def</span> <span class="nf">get_dos_integrator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        FatBandsFile can use differerent integrators that are cached in self._cached_dos_integrators</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_cached_dos_integrators&quot;</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_dos_integrators</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
        <span class="n">intg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_dos_integrators</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">intg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">intg</span>
        <span class="c1"># Build integrator, cache it and return it.</span>
        <span class="n">intg</span> <span class="o">=</span> <span class="n">_DosIntegrator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_dos_integrators</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">intg</span>
        <span class="k">return</span> <span class="n">intg</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="FatBandsFile.plot_pjdos_lview"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.fatbands.FatBandsFile.plot_pjdos_lview">[docs]</a>    <span class="k">def</span> <span class="nf">plot_pjdos_lview</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                         <span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">combined_spins</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axmat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">with_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_spin_sign</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the PJ-DOS on a linear mesh.</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - `fermie`: shift all eigenvalues to have zero energy at the Fermi energy.</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">            method: String defining the method for the computation of the DOS.</span>
<span class="sd">            step: Energy step (eV) of the linear mesh.</span>
<span class="sd">            width: Standard deviation (eV) of the gaussian.</span>
<span class="sd">            stacked: True if DOS curves</span>
<span class="sd">            combined_spins: Define how up/down DOS components should be plotted when nsppol==2.</span>
<span class="sd">                If True, up/down DOSes are plotted on the same figure (positive values for up,</span>
<span class="sd">                negative values for down component)</span>
<span class="sd">                If False, up/down components are plotted on different axes.</span>
<span class="sd">            axmat:</span>
<span class="sd">            exchange_xy: True if the dos should be plotted on the x axis instead of y.</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used</span>
<span class="sd">            ylims: Same meaning as `xlims` but for the y-axis</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">intg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dos_integrator</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;Error while trying to compute the DOS.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Verify that the k-points form a homogenous sampling of the BZ.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Returning None</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Get energy mesh from total DOS and define the zero of energy</span>
        <span class="c1"># Note that the mesh is not not spin-dependent.</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">intg</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">mesh</span> <span class="o">-=</span> <span class="n">e0</span>
        <span class="n">edos</span><span class="p">,</span> <span class="n">symbols_lso</span> <span class="o">=</span> <span class="n">intg</span><span class="o">.</span><span class="n">edos</span><span class="p">,</span> <span class="n">intg</span><span class="o">.</span><span class="n">symbols_lso</span>

        <span class="c1"># Get grid of axes.</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">combined_spins</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">axmat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axmat</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lsize</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">axmat</span><span class="p">,</span> <span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lsize</span><span class="p">))</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>

        <span class="c1"># The code below expectes a matrix of axes of shape[nsppol, self.lsize]</span>
        <span class="c1"># If spins are plotted on the same graph (combined_spins), I build a new matrix so that</span>
        <span class="c1"># axmat[spin=0] is axmat[spin=1] and aliased_axis is set to True</span>
        <span class="n">aliased_axis</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">combined_spins</span><span class="p">:</span>
            <span class="n">aliased_axis</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">axmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">axmat</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">axmat</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span>

        <span class="n">spin_sign</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stacked</span><span class="p">:</span>
            <span class="c1"># Plot PJDOS as lines.</span>
            <span class="k">for</span> <span class="n">isymb</span><span class="p">,</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">with_spin_sign</span><span class="p">:</span> <span class="n">spin_sign</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="c1"># Loop over the columns of the grid.</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmax_symbol</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">ax</span> <span class="o">=</span> <span class="n">axmat</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>

                        <span class="c1"># Plot total DOS.</span>
                        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">spin_sign</span> <span class="o">*</span> <span class="n">edos</span><span class="o">.</span><span class="n">spin_dos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                        <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Tot&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">isymb</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span> <span class="k">if</span> <span class="n">with_info</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

                        <span class="c1"># Plot PJ-DOS(l, spin)</span>
                        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">spin_sign</span> <span class="o">*</span> <span class="n">symbols_lso</span><span class="p">[</span><span class="n">symbol</span><span class="p">][</span><span class="n">l</span><span class="p">,</span> <span class="n">spin</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="n">symbol</span> <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">isymb</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol2color</span><span class="p">[</span><span class="n">symbol</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span> <span class="k">if</span> <span class="n">with_info</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

                    <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
                    <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Plot stacked PJDOS</span>
            <span class="c1"># Loop over the columns of the grid.</span>
            <span class="n">ls_stackdos</span> <span class="o">=</span> <span class="n">intg</span><span class="o">.</span><span class="n">ls_stackdos</span>
            <span class="n">spin_sign</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
            <span class="n">zerodos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lsize</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">with_spin_sign</span><span class="p">:</span> <span class="n">spin_sign</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">axmat</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>

                    <span class="c1"># Plot total DOS.</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">spin_sign</span> <span class="o">*</span> <span class="n">edos</span><span class="o">.</span><span class="n">spin_dos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                    <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Tot&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">spin</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span> <span class="k">if</span> <span class="n">with_info</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

                    <span class="c1"># Plot cumulative PJ-DOS(l, spin)</span>
                    <span class="n">stack</span> <span class="o">=</span> <span class="n">ls_stackdos</span><span class="p">[(</span><span class="n">l</span><span class="p">,</span> <span class="n">spin</span><span class="p">)]</span> <span class="o">*</span> <span class="n">spin_sign</span>
                    <span class="k">for</span> <span class="n">isymb</span><span class="p">,</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">):</span>
                        <span class="n">yup</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">isymb</span><span class="p">]</span>
                        <span class="n">ydown</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">isymb</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">isymb</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">zerodos</span>
                        <span class="n">label</span> <span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (stacked)&quot;</span> <span class="o">%</span> <span class="n">symbol</span> <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">spin</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                        <span class="n">fill</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">exchange_xy</span> <span class="k">else</span> <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span>
                        <span class="n">fill</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">yup</span><span class="p">,</span> <span class="n">ydown</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol2color</span><span class="p">[</span><span class="n">symbol</span><span class="p">],</span>
                             <span class="n">label</span><span class="o">=</span><span class="n">label</span> <span class="k">if</span> <span class="n">with_info</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

                    <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
                    <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="c1"># Decorate axis.</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">aliased_axis</span> <span class="ow">and</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="k">break</span> <span class="c1"># Don&#39;t repeat yourself!</span>

            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lsize</span><span class="p">):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axmat</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">with_info</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">combined_spins</span><span class="p">:</span>
                        <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2tex</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l2tex</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin2tex</span><span class="p">[</span><span class="n">spin</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> \
                                 <span class="bp">self</span><span class="o">.</span><span class="n">l2tex</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Display yticklabels on the first plot and last plot only.</span>
                <span class="c1"># and display the legend only on the first plot.</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Energy [eV]&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">with_info</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;DOS [states/eV]&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;DOS [states/eV]&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">l</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">lsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Plots in the middle: don&#39;t show labels.</span>
                    <span class="c1"># Trick: Don&#39;t change the labels but set their fontsize to 0 otherwise</span>
                    <span class="c1"># also the other axes are affecred (likely due to sharey=True).</span>
                    <span class="c1"># ax.set_yticklabels([])</span>
                    <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_major_ticks</span><span class="p">():</span>
                        <span class="n">tick</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="FatBandsFile.plot_pjdos_typeview"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.fatbands.FatBandsFile.plot_pjdos_typeview">[docs]</a>    <span class="k">def</span> <span class="nf">plot_pjdos_typeview</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                            <span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">combined_spins</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axmat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">with_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_spin_sign</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the PJ-DOS on a linear mesh.</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - `fermie`: shift all eigenvalues to have zero energy at the Fermi energy.</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">            method: String defining the method for the computation of the DOS.</span>
<span class="sd">            step: Energy step (eV) of the linear mesh.</span>
<span class="sd">            width: Standard deviation (eV) of the gaussian.</span>
<span class="sd">            stacked: True if DOS curves</span>
<span class="sd">            combined_spins: Define how up/down DOS components should be plotted when nsppol==2.</span>
<span class="sd">                If True, up/down DOSes are plotted on the same figure (positive values for up,</span>
<span class="sd">                negative values for down component)</span>
<span class="sd">                If False, up/down components are plotted on different axes.</span>
<span class="sd">            axmat:</span>
<span class="sd">            exchange_xy: True if the dos should be plotted on the x axis instead of y.</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used</span>
<span class="sd">            ylims: Same meaning as `xlims` but for the y-axis</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">intg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dos_integrator</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;Error while trying to compute the DOS.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Verify that the k-points form a homogenous sampling of the BZ.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Returning None</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Get energy mesh from total DOS and define the zero of energy</span>
        <span class="c1"># Note that the mesh is not not spin-dependent.</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">intg</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">mesh</span> <span class="o">-=</span> <span class="n">e0</span>
        <span class="n">edos</span><span class="p">,</span> <span class="n">symbols_lso</span> <span class="o">=</span> <span class="n">intg</span><span class="o">.</span><span class="n">edos</span><span class="p">,</span> <span class="n">intg</span><span class="o">.</span><span class="n">symbols_lso</span>

        <span class="c1"># Get grid of axes.</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">combined_spins</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">axmat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axmat</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ntypat</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">axmat</span><span class="p">,</span> <span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntypat</span><span class="p">))</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>

        <span class="c1"># The code below expectes a matrix of axes of shape[nsppol, self.ntypat]</span>
        <span class="c1"># If spins are plotted on the same graph (combined_spins), I build a new matrix so that</span>
        <span class="c1"># axmat[spin=0] is axmat[spin=1] and aliased_axis is set to True</span>
        <span class="n">aliased_axis</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">combined_spins</span><span class="p">:</span>
            <span class="n">aliased_axis</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">axmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">axmat</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">axmat</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span>

        <span class="n">spin_sign</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stacked</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">with_spin_sign</span><span class="p">:</span> <span class="n">spin_sign</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                <span class="c1"># Loop over the columns of the grid.</span>
                <span class="k">for</span> <span class="n">isymb</span><span class="p">,</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">):</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">axmat</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">isymb</span><span class="p">]</span>

                    <span class="c1"># Plot total DOS.</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">spin_sign</span> <span class="o">*</span> <span class="n">edos</span><span class="o">.</span><span class="n">spin_dos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                    <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Tot&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">isymb</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span> <span class="k">if</span> <span class="n">with_info</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmax_symbol</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                        <span class="c1"># Plot PJ-DOS(l, spin)</span>
                        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">spin_sign</span> <span class="o">*</span> <span class="n">symbols_lso</span><span class="p">[</span><span class="n">symbol</span><span class="p">][</span><span class="n">l</span><span class="p">,</span> <span class="n">spin</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2tex</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">isymb</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">l2color</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span> <span class="k">if</span> <span class="n">with_info</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

                    <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
                    <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Plot stacked PJDOS</span>
            <span class="c1"># Loop over the columns of the grid.</span>
            <span class="c1">#ls_stackdos = intg.ls_stackdos</span>
            <span class="n">spin_sign</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
            <span class="n">zerodos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">with_spin_sign</span><span class="p">:</span> <span class="n">spin_sign</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">for</span> <span class="n">isymb</span><span class="p">,</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">):</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">axmat</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">isymb</span><span class="p">]</span>

                    <span class="c1"># Plot total DOS.</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">spin_sign</span> <span class="o">*</span> <span class="n">edos</span><span class="o">.</span><span class="n">spin_dos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                    <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Tot&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">isymb</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span> <span class="k">if</span> <span class="n">with_info</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

                    <span class="c1"># Plot cumulative PJ-DOS(l, spin)</span>
                    <span class="n">stack</span> <span class="o">=</span> <span class="n">intg</span><span class="o">.</span><span class="n">get_lstack_symbol</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">spin</span><span class="p">)</span> <span class="o">*</span> <span class="n">spin_sign</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmax_symbol</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">yup</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
                        <span class="n">ydown</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">l</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">zerodos</span>
                        <span class="n">label</span> <span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (stacked)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2tex</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">isymb</span><span class="p">,</span> <span class="n">spin</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                        <span class="n">fill</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">exchange_xy</span> <span class="k">else</span> <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span>
                        <span class="n">fill</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">yup</span><span class="p">,</span> <span class="n">ydown</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">l2color</span><span class="p">[</span><span class="n">l</span><span class="p">],</span>
                             <span class="n">label</span><span class="o">=</span><span class="n">label</span> <span class="k">if</span> <span class="n">with_info</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

                    <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
                    <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="c1"># Decorate axis.</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">aliased_axis</span> <span class="ow">and</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="k">break</span> <span class="c1"># Don&#39;t repeat yourself!</span>

            <span class="k">for</span> <span class="n">itype</span><span class="p">,</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axmat</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">itype</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">with_info</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">combined_spins</span><span class="p">:</span>
                        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Type: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">symbol</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin2tex</span><span class="p">[</span><span class="n">spin</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">symbol</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Display yticklabels on the first plot and last plot only.</span>
                <span class="c1"># and display the legend only on the first plot.</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Energy [eV]&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">itype</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">with_info</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;DOS [states/eV]&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;DOS [states/eV]&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">itype</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntypat</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Plots in the middle: don&#39;t show labels.</span>
                    <span class="c1"># Trick: Don&#39;t change the labels but set their fontsize to 0 otherwise</span>
                    <span class="c1"># also the other axes are affecred (likely due to sharey=True).</span>
                    <span class="c1"># ax.set_yticklabels([])</span>
                    <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_major_ticks</span><span class="p">():</span>
                        <span class="n">tick</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="FatBandsFile.plot_fatbands_with_pjdos"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.fatbands.FatBandsFile.plot_fatbands_with_pjdos">[docs]</a>    <span class="k">def</span> <span class="nf">plot_fatbands_with_pjdos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">blist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="s2">&quot;type&quot;</span><span class="p">,</span>
                                 <span class="n">pjdosfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">edos_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                 <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the fatbands and the PJDOS on the same figure, a.k.a the Sistine Chapel.</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - `fermie`: shift all eigenvalues to have zero energy at the Fermi energy.</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">            fact:  float used to scale the stripe size.</span>
<span class="sd">            blist: List of band indices for the fatband plot. If None, all bands are included</span>
<span class="sd">            pjdosfile: FATBANDS file used to compute the PJDOS. If None, the PJDOS is taken from self.</span>
<span class="sd">            edos_kwargs:</span>
<span class="sd">            stacked:</span>
<span class="sd">            width_ratio:</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">closeit</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">pjdosfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pjdosfile</span><span class="p">,</span> <span class="n">FatBandsFile</span><span class="p">):</span>
                <span class="c1"># String --&gt; open the file here and close it before returning.</span>
                <span class="n">pjdosfile</span> <span class="o">=</span> <span class="n">FatBandsFile</span><span class="p">(</span><span class="n">pjdosfile</span><span class="p">)</span>
                <span class="n">closeit</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Compute PJDOS from self.</span>
            <span class="n">pjdosfile</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">edos_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">edos_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Build plot grid.</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="k">import</span> <span class="n">GridSpec</span><span class="p">,</span> <span class="n">GridSpecFromSubplotSpec</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="c1"># Define number of columns depending on view</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ntypat</span><span class="p">,</span> <span class="n">lview</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lsize</span><span class="p">)[</span><span class="n">view</span><span class="p">]</span>
        <span class="n">gspec</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">)</span>
        <span class="n">fatbands_axmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="n">ncols</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="n">pjdos_axmat</span> <span class="o">=</span> <span class="n">fatbands_axmat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">icol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">):</span>
                <span class="n">subgrid</span> <span class="o">=</span> <span class="n">GridSpecFromSubplotSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">subplot_spec</span><span class="o">=</span><span class="n">gspec</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">icol</span><span class="p">],</span>
                                                  <span class="n">width_ratios</span><span class="o">=</span><span class="n">width_ratios</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
                <span class="c1"># Similar plots share the x-axis. All plots share the y-axis.</span>
                <span class="n">prev_fatbax</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="p">(</span><span class="n">icol</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="n">fatbands_axmat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">subgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sharex</span><span class="o">=</span><span class="n">prev_fatbax</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">prev_fatbax</span><span class="p">)</span>
                <span class="n">prev_pjdosax</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="p">(</span><span class="n">icol</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="n">pjdos_axmat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">subgrid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sharex</span><span class="o">=</span><span class="n">prev_pjdosax</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
                <span class="n">fatbands_axmat</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">icol</span><span class="p">]</span> <span class="o">=</span> <span class="n">ax1</span>
                <span class="n">pjdos_axmat</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">icol</span><span class="p">]</span> <span class="o">=</span> <span class="n">ax2</span>

        <span class="c1"># Plot bands on fatbands_axmat and PJDOS on pjdos_axmat.</span>
        <span class="k">if</span> <span class="n">view</span> <span class="o">==</span> <span class="s2">&quot;lview&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_fatbands_lview</span><span class="p">(</span><span class="n">e0</span><span class="o">=</span><span class="n">e0</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="n">fact</span><span class="p">,</span> <span class="n">blist</span><span class="o">=</span><span class="n">blist</span><span class="p">,</span> <span class="n">axmat</span><span class="o">=</span><span class="n">fatbands_axmat</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="n">ylims</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">pjdosfile</span><span class="o">.</span><span class="n">plot_pjdos_lview</span><span class="p">(</span><span class="n">e0</span><span class="o">=</span><span class="n">e0</span><span class="p">,</span> <span class="n">axmat</span><span class="o">=</span><span class="n">pjdos_axmat</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">stacked</span><span class="o">=</span><span class="n">stacked</span><span class="p">,</span> <span class="n">combined_spins</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                       <span class="n">with_info</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">with_spin_sign</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="n">ylims</span><span class="p">,</span>
                                       <span class="o">**</span><span class="n">edos_kwargs</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_fatbands_typeview</span><span class="p">(</span><span class="n">e0</span><span class="o">=</span><span class="n">e0</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="n">fact</span><span class="p">,</span> <span class="n">blist</span><span class="o">=</span><span class="n">blist</span><span class="p">,</span> <span class="n">axmat</span><span class="o">=</span><span class="n">fatbands_axmat</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="n">ylims</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">pjdosfile</span><span class="o">.</span><span class="n">plot_pjdos_typeview</span><span class="p">(</span><span class="n">e0</span><span class="o">=</span><span class="n">e0</span><span class="p">,</span> <span class="n">axmat</span><span class="o">=</span><span class="n">pjdos_axmat</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">stacked</span><span class="o">=</span><span class="n">stacked</span><span class="p">,</span> <span class="n">combined_spins</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                          <span class="n">with_info</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">with_spin_sign</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="n">ylims</span><span class="p">,</span>
                                          <span class="o">**</span><span class="n">edos_kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know how to handle view=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">view</span><span class="p">))</span>

        <span class="c1"># Remove labels from DOS plots.</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">pjdos_axmat</span><span class="o">.</span><span class="n">ravel</span><span class="p">():</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">xtick</span><span class="p">,</span> <span class="n">ytick</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_major_ticks</span><span class="p">(),</span> <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_major_ticks</span><span class="p">()):</span>
                <span class="n">xtick</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">ytick</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">closeit</span><span class="p">:</span> <span class="n">pjdosfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="FatBandsFile.plot_pawdos_terms"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.fatbands.FatBandsFile.plot_pawdos_terms">[docs]</a>    <span class="k">def</span> <span class="nf">plot_pawdos_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot ...</span>

<span class="sd">        Args:</span>
<span class="sd">            method: String defining the method for the computation of the DOS.</span>
<span class="sd">            step: Energy step (eV) of the linear mesh.</span>
<span class="sd">            width: Standard deviation (eV) of the gaussian.</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">usepaw</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;This is not a PAW calculation!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prtdos</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;prtdos == 3 is required!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># TODO: More tests.</span>
        <span class="c1">#if self.pawprtdos != 0:</span>

        <span class="c1"># Onsite contributions.</span>
        <span class="c1"># fracts_paw1,(dtset%nkpt,dtset%mband,dtset%nsppol,new%ndosfraction))</span>
        <span class="c1">#wshape = (self.natom, self.mbesslang, self.nsppol, self.mband, self.nkpt)</span>
        <span class="n">wal_sbk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wal_sbk</span>
        <span class="n">paw1_wal_sbk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_wal_sbk</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;dos_fractions_paw1&quot;</span><span class="p">)</span>
        <span class="n">pawt1_wal_sbk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_wal_sbk</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;dos_fractions_pawt1&quot;</span><span class="p">)</span>

        <span class="n">ebands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span>
        <span class="n">kpoints</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">kpoints</span>
        <span class="n">nband_sk</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">nband_sk</span>
        <span class="n">eigens</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">eigens</span>

        <span class="c1"># Compute the linear mesh for DOS.</span>
        <span class="n">epad</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">e_min</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">enemin</span><span class="p">()</span> <span class="o">-</span> <span class="n">epad</span>
        <span class="n">e_max</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">enemax</span><span class="p">()</span> <span class="o">+</span> <span class="n">epad</span>

        <span class="n">nw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">e_max</span> <span class="o">-</span> <span class="n">e_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">step</span><span class="p">)</span>
        <span class="n">mesh</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">e_min</span><span class="p">,</span> <span class="n">e_max</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">nw</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">retstep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">totdos_al</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="n">nw</span><span class="p">))</span>
        <span class="n">paw1dos_al</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="n">nw</span><span class="p">))</span>
        <span class="n">pawt1dos_al</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="n">nw</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">kpoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">kpoints</span><span class="p">):</span>
                    <span class="n">weight</span> <span class="o">=</span> <span class="n">kpoint</span><span class="o">.</span><span class="n">weight</span>
                    <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nband_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">k</span><span class="p">]):</span>
                        <span class="n">gs</span> <span class="o">=</span> <span class="n">gaussian</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">band</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">iatom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">):</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_atom</span><span class="p">[</span><span class="n">iatom</span><span class="p">]:</span> <span class="k">continue</span>
                            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmax_atom</span><span class="p">[</span><span class="n">iatom</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                                <span class="n">totdos_al</span><span class="p">[</span><span class="n">iatom</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">spin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">gs</span> <span class="o">*</span> <span class="n">wal_sbk</span><span class="p">[</span><span class="n">iatom</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span>
                                <span class="n">paw1dos_al</span><span class="p">[</span><span class="n">iatom</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">spin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">gs</span> <span class="o">*</span> <span class="n">paw1_wal_sbk</span><span class="p">[</span><span class="n">iatom</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span>
                                <span class="n">pawt1dos_al</span><span class="p">[</span><span class="n">iatom</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">spin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">gs</span> <span class="o">*</span> <span class="n">pawt1_wal_sbk</span><span class="p">[</span><span class="n">iatom</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Method </span><span class="si">%s</span><span class="s2"> is not supported&quot;</span> <span class="o">%</span> <span class="n">method</span><span class="p">)</span>

        <span class="c1"># TOT = PW + AE - PS</span>
        <span class="n">pwdos_al</span> <span class="o">=</span> <span class="n">totdos_al</span> <span class="o">-</span> <span class="n">paw1dos_al</span> <span class="o">+</span> <span class="n">pawt1dos_al</span>

        <span class="c1"># Build plot grid.</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axmat</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">has_atom</span><span class="p">),</span> <span class="n">ncols</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lsize</span><span class="p">,</span>
                                  <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">irow</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">iatom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_atom</span><span class="p">[</span><span class="n">iatom</span><span class="p">]:</span> <span class="k">continue</span>
            <span class="n">irow</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1">#for l in range(self.lmax_atom[iatom]+1):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lsize</span><span class="p">):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axmat</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">l</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmax_atom</span><span class="p">[</span><span class="n">iatom</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># don&#39;t show this plots and cycle</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">l</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="c1"># Only the first column show labels.</span>
                    <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_major_ticks</span><span class="p">():</span>
                        <span class="n">tick</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                    <span class="n">spin_sign</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">totdos_al</span><span class="p">[</span><span class="n">iatom</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">spin</span><span class="p">]</span> <span class="o">*</span> <span class="n">spin_sign</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
                            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Total&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">irow</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">spin</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">pwdos_al</span><span class="p">[</span><span class="n">iatom</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">spin</span><span class="p">]</span> <span class="o">*</span> <span class="n">spin_sign</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span>
                            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;PW part&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">irow</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">spin</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">paw1dos_al</span><span class="p">[</span><span class="n">iatom</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">spin</span><span class="p">]</span> <span class="o">*</span> <span class="n">spin_sign</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span>
                            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;AE-onsite&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">irow</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">spin</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">pawt1dos_al</span><span class="p">[</span><span class="n">iatom</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">spin</span><span class="p">]</span> <span class="o">*</span> <span class="n">spin_sign</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span>
                            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;PS-onsite&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">irow</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">spin</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axmat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Energy [eV]&#39;</span><span class="p">)</span>
            <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="FatBandsFile.plot_pjdos_spinor"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.fatbands.FatBandsFile.plot_pjdos_spinor">[docs]</a>    <span class="k">def</span> <span class="nf">plot_pjdos_spinor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">terms</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;sigma_x&quot;</span><span class="p">,</span> <span class="s2">&quot;sigma_y&quot;</span><span class="p">,</span> <span class="s2">&quot;sigma_z&quot;</span><span class="p">),</span>
                          <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                          <span class="n">blist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="c1">#stacked=True,</span>
                         <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="c1">#with_info=True,</span>
                         <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the PJ-DOS on a linear mesh.</span>

<span class="sd">        Args:</span>
<span class="sd">            terms:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - `fermie`: shift all eigenvalues to have zero energy at the Fermi energy.</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">            method: String defining the method for the computation of the DOS.</span>
<span class="sd">            step: Energy step (eV) of the linear mesh.</span>
<span class="sd">            width: Standard deviation (eV) of the gaussian.</span>
<span class="sd">            stacked: True if DOS curves</span>
<span class="sd">            ax:</span>
<span class="sd">            exchange_xy: True if the dos should be plotted on the x axis instead of y.</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: To be tested.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prtdos</span> <span class="o">!=</span> <span class="mi">5</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;This method assumes prtdos=5 and nspinor=2 but file has prtdos=</span><span class="si">%s</span><span class="s2"> and nspinor=</span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prtdos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">intg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dos_integrator</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;Error while trying to compute the DOS.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Verify that the k-points form a homogenous sampling of the BZ.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Returning None</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Get energy mesh from total DOS and define the zero of energy</span>
        <span class="c1"># Note that the mesh is not not spin-dependent.</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">intg</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">mesh</span> <span class="o">-=</span> <span class="n">e0</span>
        <span class="n">ebands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span>
        <span class="n">mybands</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">ebands</span><span class="o">.</span><span class="n">mband</span><span class="p">)</span> <span class="k">if</span> <span class="n">blist</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">blist</span>

        <span class="c1"># Read data from file.</span>
        <span class="c1"># Dos fractions contains: [ndosfraction, nsppol, mband, nkpt].</span>
        <span class="c1"># where the first dimension stores: (up,up  up,down  down,up  down,down  sigma_x sigma_y sigma_z)</span>
        <span class="n">w_sbk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;dos_fractions&quot;</span><span class="p">)</span>
        <span class="n">term2idx</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;up-up&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;up-down&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;down-up&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;down-down&quot;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;sigma_x&quot;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;sigma_y&quot;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;sigma_z&quot;</span><span class="p">:</span><span class="mi">6</span><span class="p">}</span>

        <span class="n">spin0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">terms</span> <span class="o">=</span> <span class="n">list_strings</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span>
        <span class="n">dos_terms</span> <span class="o">=</span> <span class="p">{</span><span class="n">term</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="p">))</span> <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">}</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">k</span><span class="o">.</span><span class="n">weight</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ebands</span><span class="o">.</span><span class="n">kpoints</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">terms</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">term2idx</span><span class="p">[</span><span class="n">term</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">mybands</span><span class="p">:</span>
                <span class="n">gaussians_dos</span><span class="p">(</span><span class="n">dos_terms</span><span class="p">[</span><span class="n">term</span><span class="p">],</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span>
                              <span class="n">w_sbk</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">spin0</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="p">:],</span> <span class="n">ebands</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin0</span><span class="p">,</span> <span class="p">:,</span> <span class="n">band</span><span class="p">],</span> <span class="n">weights</span><span class="p">)</span>

        <span class="c1"># Plot doses.</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">term</span><span class="p">,</span> <span class="n">yvals</span> <span class="ow">in</span> <span class="n">dos_terms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">yvals</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spinors2color</span><span class="p">[</span><span class="n">term</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spinors2tex</span><span class="p">[</span><span class="n">term</span><span class="p">])</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Energy [eV]&quot;</span><span class="p">)</span>
        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="FatBandsFile.write_notebook"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.fatbands.FatBandsFile.write_notebook">[docs]</a>    <span class="k">def</span> <span class="nf">write_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write an ipython notebook to nbpath. If nbpath is None, a temporay file in the current</span>
<span class="sd">        working directory is created. Return path to the notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbformat</span><span class="p">,</span> <span class="n">nbv</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nbformat_nbv_nb</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;fbnc = abilab.abiopen(&#39;</span><span class="si">%s</span><span class="s2">&#39;)</span><span class="se">\n</span><span class="s2">print(fbnc)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;fbnc.structure&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;fig = fbnc.ebands.kpoints.plot()&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;xlims = (None, None)</span><span class="se">\n</span><span class="s2">ylims = (None, None)&quot;</span><span class="p">),</span>
            <span class="c1">#nbv.new_code_cell(&quot;fig = fbnc.ebands.plot(ylims=ylims)&quot;),</span>
        <span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prtdos</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                <span class="n">nbv</span><span class="o">.</span><span class="n">new_markdown_cell</span><span class="p">(</span><span class="s2">&quot;## Fatbands plots with L-character </span><span class="se">\n</span><span class="s2">(require `prtdos=3`)&quot;</span><span class="p">),</span>
                <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;fig = fbnc.plot_fatbands_typeview(ylims=ylims)&quot;</span><span class="p">),</span>
                <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;fig = fbnc.plot_fatbands_lview(ylims=ylims)&quot;</span><span class="p">),</span>
                <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;fig = fbnc.plot_fatbands_siteview(ylims=ylims)&quot;</span><span class="p">),</span>
            <span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prtdos</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prtdosm</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                <span class="n">nbv</span><span class="o">.</span><span class="n">new_markdown_cell</span><span class="p">(</span><span class="s2">&quot;## Fatbands plots with LM-character </span><span class="se">\n</span><span class="s2">(require `prtdos = 3 and prtdosm != 0`)&quot;</span><span class="p">),</span>
                <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;fig = fbnc.plot_fatbands_mview(iatom=0, ylims=ylims)&quot;</span><span class="p">),</span>
            <span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prtdos</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                <span class="n">nbv</span><span class="o">.</span><span class="n">new_markdown_cell</span><span class="p">(</span><span class="s2">&quot;## Fatbands plots with Spin-character </span><span class="se">\n</span><span class="s2">(require `prtdos = 5 and nspinor == 2`)&quot;</span><span class="p">),</span>
                <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;fig = fbnc.plot_fatbands_spinor(ylims=ylims)&quot;</span><span class="p">),</span>
            <span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prtdos</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">is_mpmesh</span><span class="p">:</span>
            <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                <span class="n">nbv</span><span class="o">.</span><span class="n">new_markdown_cell</span><span class="p">(</span><span class="s2">&quot;## L-DOSes plots </span><span class="se">\n</span><span class="s2">(require `prtdos = 3` and BZ sampling)&quot;</span><span class="p">),</span>
                <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;fig = fbnc.plot_pjdos_lview(xlims=xlims)&quot;</span><span class="p">),</span>
                <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;fig = fbnc.plot_pjdos_typeview(xlims=xlims)&quot;</span><span class="p">),</span>
            <span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prtdos</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">is_path</span><span class="p">:</span>
            <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                <span class="n">nbv</span><span class="o">.</span><span class="n">new_markdown_cell</span><span class="p">(</span><span class="s2">&quot;## L-DOSes with fatbands</span><span class="se">\n</span><span class="s2">&quot;</span>
                                     <span class="s2">&quot;(require `prtdos=3`, `fbnc` must contain a k-path, &quot;</span>
                                     <span class="s2">&quot;`pjdosfile` is a `FATBANDS.nc` file with a BZ sampling)&quot;</span><span class="p">),</span>
                <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;fig = fbnc.plot_fatbands_with_pjdos(pjdosfile=None, ylims=ylims, view=&#39;type&#39;)&quot;</span><span class="p">),</span>
            <span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">usepaw</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prtdos</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                <span class="n">nbv</span><span class="o">.</span><span class="n">new_markdown_cell</span><span class="p">(</span><span class="s2">&quot;## PAW L-DOS decomposed into smooth PW part, AE and PS terms&quot;</span><span class="p">),</span>
                <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;fig = fbnc.plot_pawdos_terms()&quot;</span><span class="p">),</span>
            <span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_nb_nbpath</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nbpath</span><span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">_DosIntegrator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object is responsible for the integration of the DOS/PJDOS.</span>
<span class="sd">    It&#39;s an internal object that should not be instantiated directly outside of this module.</span>
<span class="sd">    PJDOSes are computed lazily and stored in the integrator so that we can reuse the results</span>
<span class="sd">    if needed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fbfile</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fbfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">fbfile</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">width</span>

        <span class="c1"># Compute Total DOS from ebands and define energy mesh.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edos</span> <span class="o">=</span> <span class="n">fbfile</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">get_edos</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edos</span><span class="o">.</span><span class="n">spin_dos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mesh</span>

    <span class="c1">#@lazy_property</span>
    <span class="c1">#def site_edos(self):</span>
    <span class="c1">#    &quot;&quot;&quot;Array [natom, nsppol, lmax**2]&quot;&quot;&quot;</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">symbols_lso</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fbfile</span><span class="p">,</span> <span class="n">ebands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fbfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fbfile</span><span class="o">.</span><span class="n">ebands</span>

        <span class="c1"># Compute l-decomposed PJDOS for each type of atom.</span>
        <span class="n">symbols_lso</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">fbfile</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
                <span class="n">lmax</span> <span class="o">=</span> <span class="n">fbfile</span><span class="o">.</span><span class="n">lmax_symbol</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
                <span class="n">wlsbk</span> <span class="o">=</span> <span class="n">fbfile</span><span class="o">.</span><span class="n">get_wl_symbol</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                <span class="n">lso</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">fbfile</span><span class="o">.</span><span class="n">lsize</span><span class="p">,</span> <span class="n">fbfile</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)))</span>
                <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fbfile</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">kpoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ebands</span><span class="o">.</span><span class="n">kpoints</span><span class="p">):</span>
                        <span class="n">weight</span> <span class="o">=</span> <span class="n">kpoint</span><span class="o">.</span><span class="n">weight</span>
                        <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ebands</span><span class="o">.</span><span class="n">nband_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">k</span><span class="p">]):</span>
                            <span class="n">e</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">band</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lmax</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                                <span class="n">lso</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">spin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">wlsbk</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">*</span>\
                                                <span class="n">weight</span> <span class="o">*</span> <span class="n">gaussian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
                <span class="n">symbols_lso</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">lso</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Method </span><span class="si">%s</span><span class="s2"> is not supported&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">symbols_lso</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">ls_stackdos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute `ls_stackdos` datastructure for stacked DOS.</span>
<span class="sd">        ls_stackdos maps (l, spin) onto a numpy array [nsymbols, nfreqs] where</span>
<span class="sd">        [isymb, :] contains the cumulative sum of the PJDOS(l,s) up to symbol isymb.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fbfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fbfile</span>
        <span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">product</span>
        <span class="n">dls</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">lso</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols_lso</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">spin</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">fbfile</span><span class="o">.</span><span class="n">lmax_symbol</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">fbfile</span><span class="o">.</span><span class="n">nsppol</span><span class="p">)):</span>
                <span class="n">dls</span><span class="p">[(</span><span class="n">l</span><span class="p">,</span> <span class="n">spin</span><span class="p">)][</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">lso</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">spin</span><span class="p">]</span>

        <span class="n">ls_stackdos</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">nsymb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fbfile</span><span class="o">.</span><span class="n">symbols</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">spin</span><span class="p">),</span> <span class="n">dvals</span> <span class="ow">in</span> <span class="n">dls</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nsymb</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">isymb</span><span class="p">,</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fbfile</span><span class="o">.</span><span class="n">symbols</span><span class="p">):</span>
                <span class="n">arr</span><span class="p">[</span><span class="n">isymb</span><span class="p">]</span> <span class="o">=</span> <span class="n">dvals</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
            <span class="n">ls_stackdos</span><span class="p">[(</span><span class="n">l</span><span class="p">,</span> <span class="n">spin</span><span class="p">)]</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ls_stackdos</span>

    <span class="k">def</span> <span class="nf">get_lstack_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">spin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return numpy array with the cumulative sum over l for a given</span>
<span class="sd">        atom type (specified by chemical symbol) and spin.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lso</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols_lso</span><span class="p">[</span><span class="n">symbol</span><span class="p">][:,</span> <span class="n">spin</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lso</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2017, The AbiPy group.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    
    <a href="https://github.com/abinit/abipy" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>