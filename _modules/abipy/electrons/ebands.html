

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>abipy.electrons.ebands &mdash; abipy 0.9.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/jupyter-sphinx.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/thebelab.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/my_style.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-dataframe.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-rendered-html.css" type="text/css" />

  
  

  
  

  

  
    <script type="text/javascript" src="https://cdn.plot.ly/plotly-latest.min.js"></script> 
    
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/thebelab-helper.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> abipy
          

          
          </a>

          
            
            
              <div class="version">
                0.9.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../features.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Getting AbiPy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../zzbiblio.html">Bibliography</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../scripts/index.html">Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../graphical_interface.html">Graphical interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gallery/index.html">AbiPy Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../postprocessing_howto.html">Post-processing How-To</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../workflows/taskmanager.html">TaskManager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../workflows/manager_examples.html">Manager Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../flow_gallery/index.html">Flow Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../flows_howto.html">Flows How-To</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../coding_guide.html">Coding guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html">Documenting AbiPy</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">abipy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>abipy.electrons.ebands</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for abipy.electrons.ebands</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: utf-8</span>
<span class="sd">&quot;&quot;&quot;Classes to analyse electronic structures.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pymatgen.core.units</span> <span class="k">as</span> <span class="nn">units</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">from</span> <span class="nn">monty.string</span> <span class="kn">import</span> <span class="n">is_string</span><span class="p">,</span> <span class="n">list_strings</span><span class="p">,</span> <span class="n">marquee</span>
<span class="kn">from</span> <span class="nn">monty.termcolor</span> <span class="kn">import</span> <span class="n">cprint</span>
<span class="kn">from</span> <span class="nn">monty.json</span> <span class="kn">import</span> <span class="n">MontyEncoder</span>
<span class="kn">from</span> <span class="nn">monty.collections</span> <span class="kn">import</span> <span class="n">AttrDict</span><span class="p">,</span> <span class="n">dict2namedtuple</span>
<span class="kn">from</span> <span class="nn">monty.functools</span> <span class="kn">import</span> <span class="n">lazy_property</span>
<span class="kn">from</span> <span class="nn">monty.bisect</span> <span class="kn">import</span> <span class="n">find_le</span><span class="p">,</span> <span class="n">find_gt</span>
<span class="kn">from</span> <span class="nn">pymatgen.util.serialization</span> <span class="kn">import</span> <span class="n">pmg_serialize</span>
<span class="kn">from</span> <span class="nn">pymatgen.electronic_structure.core</span> <span class="kn">import</span> <span class="n">Spin</span> <span class="k">as</span> <span class="n">PmgSpin</span>
<span class="kn">from</span> <span class="nn">abipy.core.func1d</span> <span class="kn">import</span> <span class="n">Function1D</span>
<span class="kn">from</span> <span class="nn">abipy.core.mixins</span> <span class="kn">import</span> <span class="n">Has_Structure</span><span class="p">,</span> <span class="n">NotebookWriter</span>
<span class="kn">from</span> <span class="nn">abipy.core.kpoints</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Kpoint</span><span class="p">,</span> <span class="n">KpointList</span><span class="p">,</span> <span class="n">Kpath</span><span class="p">,</span> <span class="n">IrredZone</span><span class="p">,</span> <span class="n">KSamplingInfo</span><span class="p">,</span> <span class="n">KpointsReaderMixin</span><span class="p">,</span>
    <span class="n">Ktables</span><span class="p">,</span> <span class="n">has_timrev_from_kptopt</span><span class="p">,</span> <span class="n">map_grid2ibz</span><span class="p">)</span> <span class="c1">#, kmesh_from_mpdivs)</span>
<span class="kn">from</span> <span class="nn">abipy.core.structure</span> <span class="kn">import</span> <span class="n">Structure</span>
<span class="kn">from</span> <span class="nn">abipy.iotools</span> <span class="kn">import</span> <span class="n">ETSF_Reader</span>
<span class="kn">from</span> <span class="nn">abipy.tools</span> <span class="kn">import</span> <span class="n">duck</span>
<span class="kn">from</span> <span class="nn">abipy.tools.numtools</span> <span class="kn">import</span> <span class="n">gaussian</span>
<span class="kn">from</span> <span class="nn">abipy.tools.plotting</span> <span class="kn">import</span> <span class="p">(</span><span class="n">set_axlims</span><span class="p">,</span> <span class="n">add_fig_kwargs</span><span class="p">,</span> <span class="n">get_ax_fig_plt</span><span class="p">,</span> <span class="n">get_axarray_fig_plt</span><span class="p">,</span>
    <span class="n">get_ax3d_fig_plt</span><span class="p">,</span> <span class="n">rotate_ticklabels</span><span class="p">,</span> <span class="n">set_visible</span><span class="p">,</span> <span class="n">plot_unit_cell</span><span class="p">,</span> <span class="n">set_ax_xylabels</span><span class="p">,</span> <span class="n">get_figs_plotly</span><span class="p">,</span>
    <span class="n">get_fig_plotly</span><span class="p">,</span> <span class="n">add_plotly_fig_kwargs</span><span class="p">,</span> <span class="n">PlotlyRowColDesc</span><span class="p">,</span> <span class="n">plotly_klabels</span><span class="p">,</span> <span class="n">plotly_set_lims</span><span class="p">)</span>


<span class="n">SUBSCRIPT_UNICODE</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;0&quot;</span><span class="p">:</span> <span class="s2">&quot;₀&quot;</span><span class="p">,</span>
                <span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="s2">&quot;₁&quot;</span><span class="p">,</span>
                <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="s2">&quot;₂&quot;</span><span class="p">,</span>
                <span class="s2">&quot;3&quot;</span><span class="p">:</span> <span class="s2">&quot;₃&quot;</span><span class="p">,</span>
                <span class="s2">&quot;4&quot;</span><span class="p">:</span> <span class="s2">&quot;₄&quot;</span><span class="p">,</span>
                <span class="s2">&quot;5&quot;</span><span class="p">:</span> <span class="s2">&quot;₅&quot;</span><span class="p">,</span>
                <span class="s2">&quot;6&quot;</span><span class="p">:</span> <span class="s2">&quot;₆&quot;</span><span class="p">,</span>
                <span class="s2">&quot;7&quot;</span><span class="p">:</span> <span class="s2">&quot;₇&quot;</span><span class="p">,</span>
                <span class="s2">&quot;8&quot;</span><span class="p">:</span> <span class="s2">&quot;₈&quot;</span><span class="p">,</span>
                <span class="s2">&quot;9&quot;</span><span class="p">:</span> <span class="s2">&quot;₉&quot;</span><span class="p">,</span>
            <span class="p">}</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;ElectronBands&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ElectronDos&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dataframe_from_ebands&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ElectronBandsPlotter&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ElectronDosPlotter&quot;</span><span class="p">,</span>
<span class="p">]</span>


<span class="k">class</span> <span class="nc">Electron</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;Electron&quot;</span><span class="p">,</span> <span class="s2">&quot;spin kpoint band eig occ kidx&quot;</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Single-particle state.</span>

<span class="sd">    .. Attributes:</span>

<span class="sd">        spin: spin index (C convention, i.e &gt;= 0)</span>
<span class="sd">        kpoint: |Kpoint| object.</span>
<span class="sd">        band: band index. (C convention, i.e &gt;= 0)</span>
<span class="sd">        eig: KS eigenvalue.</span>
<span class="sd">        occ: Occupation factor.</span>
<span class="sd">        kidx: Index of the k-point in the initial array.</span>

<span class="sd">    .. note::</span>

<span class="sd">        Energies are in eV.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">spin</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoint</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">kpoint</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">band</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">band</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;spin: </span><span class="si">%d</span><span class="s2">, kpt: </span><span class="si">%s</span><span class="s2">, band: </span><span class="si">%d</span><span class="s2">, eig: </span><span class="si">%.3f</span><span class="s2">, occ: </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">occ</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">skb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tuple with (spin, kpoint, band).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">band</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Shallow copy.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">f</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">})</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_fields</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">()):</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert self into a dict.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_asdict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">to_strdict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ordered dictionary mapping fields --&gt; strings.&quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">iscomplexobj</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.e-3</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">v</span><span class="o">.</span><span class="n">real</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.2f%+.2f</span><span class="s2">j&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">v</span>
                <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="c1">#print(&quot;k&quot;, k, str(exc))</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tips</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dictionary with the description of the fields.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">TIPS</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">TIPS</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class method that returns a dictionary with the description of the fields.</span>
<span class="sd">        The string are extracted from the class doc string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_TIPS</span>

        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># Parse the doc string.</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_TIPS</span> <span class="o">=</span> <span class="n">_TIPS</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.. Attributes&quot;</span><span class="p">):</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="k">break</span>

            <span class="k">def</span> <span class="nf">num_leadblanks</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Returns the number of the leading whitespaces in a string&quot;&quot;&quot;</span>
                <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())</span>

            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>

                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">field</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span><span class="p">):</span>
                        <span class="n">nblanks</span> <span class="o">=</span> <span class="n">num_leadblanks</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        <span class="n">desc</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
                            <span class="k">if</span> <span class="n">nblanks</span> <span class="o">==</span> <span class="n">num_leadblanks</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                                <span class="k">break</span>
                            <span class="n">desc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())</span>

                        <span class="n">_TIPS</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span>

            <span class="n">diffset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">_TIPS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">diffset</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The following fields are not documented: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">diffset</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">_TIPS</span>


<span class="k">class</span> <span class="nc">ElectronTransition</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object describes an electronic transition between two single-particle states.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_state</span><span class="p">,</span> <span class="n">out_state</span><span class="p">,</span> <span class="n">all_kinds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            in_state, out_state: Initial and finale state (:class:`Electron` instances).</span>
<span class="sd">            all_kinds: List of tuple. Each tuple gives the index of the k-point of the (initial, final) state.</span>
<span class="sd">                Used to plot e.g. all the optical gaps when there are equivalent k-points along the path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_state</span> <span class="o">=</span> <span class="n">in_state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_state</span> <span class="o">=</span> <span class="n">out_state</span>
        <span class="k">if</span> <span class="n">all_kinds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_kinds</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_state</span><span class="o">.</span><span class="n">kidx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_state</span><span class="o">.</span><span class="n">kidx</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Provide default.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_kinds</span> <span class="o">=</span> <span class="n">all_kinds</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Energy: </span><span class="si">%.3f</span><span class="s2"> (eV)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Initial state: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_state</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Final state:   </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_state</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_state</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">in_state</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_state</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">out_state</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">energy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Transition energy in eV.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_state</span><span class="o">.</span><span class="n">eig</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_state</span><span class="o">.</span><span class="n">eig</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">qpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;k_final - k_initial&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_state</span><span class="o">.</span><span class="n">kpoint</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_state</span><span class="o">.</span><span class="n">kpoint</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">is_direct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if direct transition.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_state</span><span class="o">.</span><span class="n">kpoint</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_state</span><span class="o">.</span><span class="n">kpoint</span>


<span class="k">class</span> <span class="nc">Smearing</span><span class="p">(</span><span class="n">AttrDict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stores data and information about the smearing technique.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_MANDATORY_KEYS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;scheme&quot;</span><span class="p">,</span>
        <span class="s2">&quot;occopt&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tsmear_ev&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Makes Smearing obey the general json interface used in pymatgen for easier serialization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_MANDATORY_KEYS</span><span class="p">})</span>

    <span class="nd">@pmg_serialize</span>
    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Makes Smearing obey the general json interface used in pymatgen for easier serialization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a JSON_ string representation of the MSONable object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(),</span> <span class="bp">cls</span><span class="o">=</span><span class="n">MontyEncoder</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">as_smearing</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">        Convert obj into a Smearing instance.</span>
<span class="sd">        Accepts: Smearing instance, None (if info are not available), Dict-like object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span> <span class="k">return</span> <span class="n">obj</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">scheme</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">occopt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">tsmear_ev</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="c1"># Assume dict-like object.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know how to convert </span><span class="si">%s</span><span class="s2"> into Smearing object:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)))</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">mkey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MANDATORY_KEYS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mkey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Mandatory key </span><span class="si">%s</span><span class="s2"> must be provided&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">mkey</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;smearing scheme: </span><span class="si">%s</span><span class="s2"> (occopt </span><span class="si">%d</span><span class="s2">), tsmear_eV: </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">occopt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsmear_ev</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_metallic_scheme</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if we are using a metallic scheme for occupancies.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">occopt</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">StatParams</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;StatParams&quot;</span><span class="p">,</span> <span class="s2">&quot;mean stdev min max&quot;</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;Named tuple with statistical parameters.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;mean = </span><span class="si">%.3f</span><span class="s2">, stdev = </span><span class="si">%.3f</span><span class="s2">, min = </span><span class="si">%.3f</span><span class="s2">, max = </span><span class="si">%.3f</span><span class="s2"> (eV)&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdev</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ElectronBandsError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exceptions raised by ElectronBands.&quot;&quot;&quot;</span>


<div class="viewcode-block" id="ElectronBands"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands">[docs]</a><span class="k">class</span> <span class="nc">ElectronBands</span><span class="p">(</span><span class="n">Has_Structure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Object storing the electron band structure.</span>

<span class="sd">    .. attribute:: fermie</span>

<span class="sd">            Fermi level in eV. Note that, if the band structure has been computed</span>
<span class="sd">            with a NSCF run, fermie corresponds to the fermi level obtained</span>
<span class="sd">            in the SCF run that produced the density used for the band structure calculation.</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: ElectronBands</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Error</span> <span class="o">=</span> <span class="n">ElectronBandsError</span>

    <span class="c1"># FIXME</span>
    <span class="c1"># Increase a bit the value of fermie used in bisection routines to solve the problem mentioned below</span>
    <span class="n">pad_fermie</span> <span class="o">=</span> <span class="mf">1e-3</span>

    <span class="c1"># One should check whether fermie is recomputed at the end of the SCF cyle</span>
    <span class="c1"># I have problems in finding homos/lumos in semiconductors (e.g. Si)</span>
    <span class="c1"># because fermie is slightly smaller than the CBM:</span>

    <span class="c1"># fermie 5.59845327874</span>
    <span class="c1"># homos [Electron(spin=0, kpoint=[0.000, 0.000, 0.000], band=1, eig=5.5984532787385985, occ=2.0)]</span>
    <span class="c1"># lumos [Electron(spin=0, kpoint=[0.000, 0.000, 0.000], band=2, eig=5.5984532788661543, occ=2.0)]</span>
    <span class="c1">#</span>
    <span class="c1"># There&#39;s also another possible problem if the DEN is computed on a grid that does not contain the CBM (e.g. Gamma)</span>
    <span class="c1"># because the CBM obtained with the NSCF band structure run will be likely above the Ef computed previously.</span>

<div class="viewcode-block" id="ElectronBands.from_file"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.from_file">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize an instance of |ElectronBands| from the netCDF file ``filepath``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filepath</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.nc&quot;</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">ElectronsReader</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">r</span><span class="p">:</span>
                <span class="n">new</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_ebands</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;ElectronBands can only be initialized from nc files&quot;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">new</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="bp">cls</span>
        <span class="k">return</span> <span class="n">new</span></div>

<div class="viewcode-block" id="ElectronBands.from_binary_string"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.from_binary_string">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_binary_string</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">bstring</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build object from a binary string with the netcdf data.</span>
<span class="sd">        Useful for implementing GUIs in which widgets returns binary data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">workdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="n">fd</span><span class="p">,</span> <span class="n">tmp_path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.nc&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bstring</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.from_dict"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reconstruct object from the dictionary in MSONable format produced by as_dict.&quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">kd</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;kpoints&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">kd</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;@module&quot;</span><span class="p">)</span>

        <span class="n">kpoints_cls</span> <span class="o">=</span> <span class="n">KpointList</span><span class="o">.</span><span class="n">subclass_from_name</span><span class="p">(</span><span class="n">kd</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;@class&quot;</span><span class="p">))</span>
        <span class="n">kpoints</span> <span class="o">=</span> <span class="n">kpoints_cls</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">kd</span><span class="p">)</span>

        <span class="c1"># Needed to support old dictionaries</span>
        <span class="k">if</span> <span class="s2">&quot;nspden&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;nspden&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="s2">&quot;nspinor&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;nspinor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">Structure</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;structure&quot;</span><span class="p">]),</span> <span class="n">kpoints</span><span class="p">,</span>
                   <span class="n">d</span><span class="p">[</span><span class="s2">&quot;eigens&quot;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;fermie&quot;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;occfacts&quot;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;nelect&quot;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;nspinor&quot;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;nspden&quot;</span><span class="p">],</span>
                   <span class="n">nband_sk</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;nband_sk&quot;</span><span class="p">],</span> <span class="n">smearing</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;smearing&quot;</span><span class="p">],</span>
                   <span class="n">linewidths</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;linewidths&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                   <span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.as_dict"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.as_dict">[docs]</a>    <span class="nd">@pmg_serialize</span>
    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return dictionary with JSON serialization.&quot;&quot;&quot;</span>
        <span class="n">linewidths</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_linewidths</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">linewidths</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">structure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(),</span>
            <span class="n">kpoints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(),</span>
            <span class="n">eigens</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
            <span class="n">fermie</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">),</span>
            <span class="n">occfacts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">occfacts</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
            <span class="n">nelect</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nelect</span><span class="p">),</span>
            <span class="n">nspinor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span><span class="p">,</span>
            <span class="n">nspden</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nspden</span><span class="p">,</span>
            <span class="n">nband_sk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
            <span class="n">smearing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smearing</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(),</span>
            <span class="n">linewidths</span><span class="o">=</span><span class="n">linewidths</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.as_ebands"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.as_ebands">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">as_ebands</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an instance of |ElectronBands| from a generic object `obj`.</span>
<span class="sd">        Supports:</span>

<span class="sd">            - instances of cls</span>
<span class="sd">            - files (string) that can be open with abiopen and that provide an `ebands` attribute.</span>
<span class="sd">            - objects providing an `ebands` attribute</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obj</span>

        <span class="k">elif</span> <span class="n">is_string</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="c1"># path?</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pickle&quot;</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">as_ebands</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_EBANDS.nc&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

            <span class="kn">from</span> <span class="nn">abipy.abilab</span> <span class="kn">import</span> <span class="n">abiopen</span><span class="p">,</span> <span class="n">abifile_subclass_from_filename</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_</span> <span class="o">=</span> <span class="n">abifile_subclass_from_filename</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="n">use_abiopen</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="c1"># This is needed to treat the case in which we are trying to read ElectronBands</span>
                <span class="c1"># from a nc file that is not known to AbiPy.</span>
                <span class="n">use_abiopen</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">use_abiopen</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">abiopen</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="k">as</span> <span class="n">abifile</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">abifile</span><span class="o">.</span><span class="n">ebands</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;ebands&quot;</span><span class="p">):</span>
            <span class="c1"># object with ebands</span>
            <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">ebands</span>

        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know how to extract ebands from object `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span></div>

<div class="viewcode-block" id="ElectronBands.from_mpid"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.from_mpid">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_mpid</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">material_id</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">nelect</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">has_timerev</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nspinor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nspden</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">line_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read bandstructure data corresponding to a materials project ``material_id``.</span>
<span class="sd">        and return Abipy ElectronBands object. Return None if bands are not available.</span>

<span class="sd">        Args:</span>
<span class="sd">            material_id (str): Materials Project material_id (a string, e.g., mp-1234).</span>
<span class="sd">            api_key (str): A String API key for accessing the MaterialsProject</span>
<span class="sd">                REST interface. Please apply on the Materials Project website for one.</span>
<span class="sd">                If this is None, the code will check if there is a `PMG_MAPI_KEY` in</span>
<span class="sd">                your .pmgrc.yaml. If so, it will use that environment</span>
<span class="sd">                This makes easier for heavy users to simply add</span>
<span class="sd">                this environment variable to their setups and MPRester can</span>
<span class="sd">                then be called without any arguments.</span>
<span class="sd">            endpoint (str): Url of endpoint to access the MaterialsProject REST interface.</span>
<span class="sd">                Defaults to the standard Materials Project REST address, but</span>
<span class="sd">                can be changed to other urls implementing a similar interface.</span>
<span class="sd">            nelect: Number of electrons in the unit cell.</span>
<span class="sd">            nspinor: Number of spinor components.</span>
<span class="sd">            line_mode (bool): If True, fetch a BandStructureSymmLine object</span>
<span class="sd">                (default). If False, return the uniform band structure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get pytmatgen structure and convert it to abipy structure</span>
        <span class="kn">from</span> <span class="nn">abipy.core</span> <span class="kn">import</span> <span class="n">restapi</span>
        <span class="k">with</span> <span class="n">restapi</span><span class="o">.</span><span class="n">get_mprester</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">)</span> <span class="k">as</span> <span class="n">rest</span><span class="p">:</span>
            <span class="n">pmgb</span> <span class="o">=</span> <span class="n">rest</span><span class="o">.</span><span class="n">get_bandstructure_by_material_id</span><span class="p">(</span><span class="n">material_id</span><span class="o">=</span><span class="n">material_id</span><span class="p">,</span> <span class="n">line_mode</span><span class="o">=</span><span class="n">line_mode</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pmgb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># Structure is set to None so we have to perform another request and patch the object.</span>
            <span class="n">structure</span> <span class="o">=</span> <span class="n">rest</span><span class="o">.</span><span class="n">get_structure_by_material_id</span><span class="p">(</span><span class="n">material_id</span><span class="p">,</span> <span class="n">final</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pmgb</span><span class="o">.</span><span class="n">structure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">pmgb</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">structure</span>

        <span class="k">if</span> <span class="n">nelect</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Get nelect from valence band maximum index.</span>
            <span class="k">if</span> <span class="n">pmgb</span><span class="o">.</span><span class="n">is_metal</span><span class="p">():</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Nelect must be specified if metallic bands.&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">pmgb</span><span class="o">.</span><span class="n">get_vbm</span><span class="p">()</span>
                <span class="n">iv_up</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;band_index&quot;</span><span class="p">][</span><span class="n">PmgSpin</span><span class="o">.</span><span class="n">up</span><span class="p">])</span>
                <span class="n">nelect</span> <span class="o">=</span> <span class="p">(</span><span class="n">iv_up</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
                <span class="c1">#print(&quot;iv_up&quot;, iv_up, &quot;nelect: &quot;, nelect)</span>
                <span class="k">if</span> <span class="n">pmgb</span><span class="o">.</span><span class="n">is_spin_polarized</span><span class="p">:</span>
                    <span class="n">iv_down</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;band_index&quot;</span><span class="p">][</span><span class="n">PmgSpin</span><span class="o">.</span><span class="n">down</span><span class="p">])</span>
                    <span class="k">assert</span> <span class="n">iv_down</span> <span class="o">==</span> <span class="n">iv_up</span>

        <span class="c1">#ksampling = KSamplingInfo.from_kbounds(kbounds)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_pymatgen</span><span class="p">(</span><span class="n">pmgb</span><span class="p">,</span> <span class="n">nelect</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">has_timerev</span><span class="o">=</span><span class="n">has_timerev</span><span class="p">,</span>
                                 <span class="n">ksampling</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nspinor</span><span class="o">=</span><span class="n">nspinor</span><span class="p">,</span> <span class="n">nspden</span><span class="o">=</span><span class="n">nspden</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.to_json"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.to_json">[docs]</a>    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a JSON string representation of the MSONable object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(),</span> <span class="bp">cls</span><span class="o">=</span><span class="n">MontyEncoder</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">kpoints</span><span class="p">,</span> <span class="n">eigens</span><span class="p">,</span> <span class="n">fermie</span><span class="p">,</span> <span class="n">occfacts</span><span class="p">,</span> <span class="n">nelect</span><span class="p">,</span> <span class="n">nspinor</span><span class="p">,</span> <span class="n">nspden</span><span class="p">,</span>
                 <span class="n">nband_sk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            structure: |Structure| object.</span>
<span class="sd">            kpoints: |KpointList| instance.</span>
<span class="sd">            eigens: Array-like object with the eigenvalues (eV) stored as [s, k, b]</span>
<span class="sd">                where s: spin , k: kpoint, b: band index</span>
<span class="sd">            fermie: Fermi level in eV.</span>
<span class="sd">            occfacts: Occupation factors (same shape as eigens)</span>
<span class="sd">            nelect: Number of valence electrons in the unit cell.</span>
<span class="sd">            nspinor: Number of spinor components</span>
<span class="sd">            nspden: Number of independent density components.</span>
<span class="sd">            nband_sk: Array-like object with the number of bands treated at each [spin,kpoint]</span>
<span class="sd">                      If not given, nband_sk is initialized from eigens.</span>
<span class="sd">            smearing: :class:`Smearing` object storing information on the smearing technique.</span>
<span class="sd">            linewidths: Array-like object with the linewidths (eV) stored as [s, k, b]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span> <span class="o">=</span> <span class="n">structure</span>

        <span class="c1"># Eigenvalues and occupancies are stored in ndarrays ordered by [spin,kpt,band]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eigens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_3d</span><span class="p">(</span><span class="n">eigens</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_occfacts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_3d</span><span class="p">(</span><span class="n">occfacts</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eigens</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occfacts</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_linewidths</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">linewidths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_linewidths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">linewidths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eigens</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mband</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspden</span> <span class="o">=</span> <span class="n">nspinor</span><span class="p">,</span> <span class="n">nspden</span>

        <span class="k">if</span> <span class="n">nband_sk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nband_sk</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span> <span class="o">*</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mband</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span> <span class="o">=</span> <span class="n">kpoints</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">,</span> <span class="n">KpointList</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">smearing</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">smearing</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">smearing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nelect</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fermie</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;|Structure| object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">_auto_klabels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Find the k-point names in the pymatgen database.</span>
        <span class="c1"># We&#39;ll use _auto_klabels to label the point in the matplotlib plot</span>
        <span class="c1"># if klabels are not specified by the user.</span>

        <span class="n">_auto_klabels</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="c1"># If the first or the last k-point are not recognized in findname_in_hsym_stars</span>
        <span class="c1"># matplotlib won&#39;t show the full band structure along the k-path</span>
        <span class="c1"># because the labels are not defined. So we have to make sure that</span>
        <span class="c1"># the labels for the extrema of the path are always defined.</span>
        <span class="n">_auto_klabels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">kpoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">kpoint</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">kpoint</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">findname_in_hsym_stars</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span>
            <span class="c1">#if name is not None:</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                <span class="n">_auto_klabels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
                <span class="k">if</span> <span class="n">kpoint</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">kpoint</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="n">last</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">last</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_auto_klabels</span><span class="p">:</span> <span class="n">_auto_klabels</span><span class="p">[</span><span class="n">last</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

        <span class="k">return</span> <span class="n">_auto_klabels</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation (short version)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">%s</span><span class="s2">, nk=</span><span class="si">%d</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, id=</span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;self + other returns a |ElectronBandsPlotter|.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="n">ElectronBands</span><span class="p">,</span> <span class="n">ElectronBandsPlotter</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Cannot add </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)))</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">ElectronBandsPlotter</span><span class="p">):</span>
            <span class="n">self_key</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">other</span><span class="o">.</span><span class="n">add_ebands</span><span class="p">(</span><span class="n">self_key</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">other</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plotter</span> <span class="o">=</span> <span class="n">ElectronBandsPlotter</span><span class="p">()</span>
            <span class="n">self_key</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">add_ebands</span><span class="p">(</span><span class="n">self_key</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="n">self_key</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">other_key</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">add_ebands</span><span class="p">(</span><span class="n">other_key</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">plotter</span>

    <span class="fm">__radd__</span> <span class="o">=</span> <span class="fm">__add__</span>

<div class="viewcode-block" id="ElectronBands.get_plotter_with"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.get_plotter_with">[docs]</a>    <span class="k">def</span> <span class="nf">get_plotter_with</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">self_key</span><span class="p">,</span> <span class="n">other_key</span><span class="p">,</span> <span class="n">other_ebands</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build and |ElectronBandsPlotter| from self and other, use self_key and other_key as keywords</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plotter</span> <span class="o">=</span> <span class="n">ElectronBandsPlotter</span><span class="p">()</span>
        <span class="n">plotter</span><span class="o">.</span><span class="n">add_ebands</span><span class="p">(</span><span class="n">self_key</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">plotter</span><span class="o">.</span><span class="n">add_ebands</span><span class="p">(</span><span class="n">other_key</span><span class="p">,</span> <span class="n">other_ebands</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">plotter</span></div>

    <span class="c1"># Handy variables used to loop</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Spin range&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nband</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nband</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nband</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nband</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">kidxs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Range with the index of the k-points.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">eigens</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Eigenvalues in eV. |numpy-array| with shape [nspin, nkpt, mband].&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eigens</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">linewidths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;linewidths in eV. |numpy-array| with shape [nspin, nkpt, mband].&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_linewidths</span>

    <span class="nd">@linewidths</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">linewidths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">linewidths</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the linewidths. Accept real array of shape [nspin, nkpt, mband] or None.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">linewidths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">linewidths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">linewidths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_linewidths</span> <span class="o">=</span> <span class="n">linewidths</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_linewidths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if bands with linewidths.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_linewidths&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">occfacts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Occupation factors. |numpy-array| with shape [nspin, nkpt, mband].&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occfacts</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">reciprocal_lattice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;|Lattice| with the reciprocal lattice vectors in Angstrom.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Shape of the array with the eigenvalues.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mband</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_metallic_scheme</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if we are using a metallic scheme for occupancies.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">smearing</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">smearing</span><span class="o">.</span><span class="n">has_metallic_scheme</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;ebands.smearing is not defined, assuming has_metallic_scheme = False&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="ElectronBands.set_fermie_to_vbm"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.set_fermie_to_vbm">[docs]</a>    <span class="k">def</span> <span class="nf">set_fermie_to_vbm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the Fermi energy to the valence band maximum (VBM).</span>
<span class="sd">        Useful when the initial fermie energy comes from a GS-SCF calculation</span>
<span class="sd">        that may underestimate the Fermi energy because e.g. the IBZ sampling</span>
<span class="sd">        is shifted whereas the true VMB is at Gamma.</span>

<span class="sd">        Return: New fermi energy in eV.</span>

<span class="sd">        .. warning:</span>

<span class="sd">            Assume spin-unpolarized band energies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">iv</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nelect</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">new_fermie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">iv</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_fermie</span><span class="p">(</span><span class="n">new_fermie</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.set_fermie_from_edos"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.set_fermie_from_edos">[docs]</a>    <span class="k">def</span> <span class="nf">set_fermie_from_edos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edos</span><span class="p">,</span> <span class="n">nelect</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the Fermi level using the integrated DOS computed in edos.</span>

<span class="sd">         Args:</span>
<span class="sd">            edos: |ElectronDos| object.</span>
<span class="sd">            nelect: Number of electrons. If None, the number of electrons in self. is used</span>

<span class="sd">        Return: New fermi energy in eV.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">nelect</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_fermie</span> <span class="o">=</span> <span class="n">edos</span><span class="o">.</span><span class="n">find_mu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nelect</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_fermie</span> <span class="o">=</span> <span class="n">edos</span><span class="o">.</span><span class="n">find_mu</span><span class="p">(</span><span class="n">nelect</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_fermie</span><span class="p">(</span><span class="n">new_fermie</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.set_fermie"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.set_fermie">[docs]</a>    <span class="k">def</span> <span class="nf">set_fermie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_fermie</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the new fermi energy. Return new value&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span> <span class="o">=</span> <span class="n">new_fermie</span>
        <span class="c1"># TODO change occfacts</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span></div>

<div class="viewcode-block" id="ElectronBands.with_points_along_path"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.with_points_along_path">[docs]</a>    <span class="k">def</span> <span class="nf">with_points_along_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frac_bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">knames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dist_tol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build new |ElectronBands| object containing the k-points along the</span>
<span class="sd">        input k-path specified by `frac_bounds`. Useful to extract energies along a path</span>
<span class="sd">        from calculation performed in the IBZ.</span>

<span class="sd">        Args:</span>
<span class="sd">            frac_bounds: [M, 3] array  with the vertexes of the k-path in reduced coordinates.</span>
<span class="sd">                If None, the k-path is automatically selected from the structure.</span>
<span class="sd">            knames: List of strings with the k-point labels defining the k-path. It has precedence over frac_bounds.</span>
<span class="sd">            dist_tol: A point is considered to be on the path if its distance from the line</span>
<span class="sd">                is less than dist_tol.</span>

<span class="sd">        Return:</span>
<span class="sd">            namedtuple with the following attributes::</span>

<span class="sd">                ebands: |ElectronBands| object.</span>
<span class="sd">                ik_new2prev: Correspondence between the k-points in the new ebands and the kpoint</span>
<span class="sd">                    of the previous band structure (self).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Construct the stars of the k-points for all k-points in self.</span>
        <span class="c1"># In principle, the input k-path is arbitrary and not necessarily in the IBZ used for self</span>
        <span class="c1"># so we have to build the k-stars and find the k-points lying along the path and keep</span>
        <span class="c1"># track of the mapping kpt --&gt; star --&gt; kgw</span>
        <span class="c1"># TODO: This part becomes a bottleneck for large nk!</span>
        <span class="n">stars</span> <span class="o">=</span> <span class="p">[</span><span class="n">kpoint</span><span class="o">.</span><span class="n">compute_star</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">abi_spacegroup</span><span class="o">.</span><span class="n">fm_symmops</span><span class="p">)</span> <span class="k">for</span> <span class="n">kpoint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">]</span>
        <span class="n">cart_coords</span><span class="p">,</span> <span class="n">back2istar</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">istar</span><span class="p">,</span> <span class="n">star</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stars</span><span class="p">):</span>
            <span class="n">cart_coords</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">k</span><span class="o">.</span><span class="n">cart_coords</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">star</span><span class="p">])</span>
            <span class="n">back2istar</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">istar</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">star</span><span class="p">))</span>
        <span class="n">cart_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">cart_coords</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">knames</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">frac_bounds</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="n">frac_bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">get_kcoords_from_names</span><span class="p">(</span><span class="n">knames</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">frac_bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">frac_bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">calc_kptbounds</span><span class="p">()</span>

        <span class="c1"># Find (star) k-points on the path.</span>
        <span class="n">cart_bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="o">.</span><span class="n">get_cartesian_coords</span><span class="p">(</span><span class="n">frac_bounds</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">abipy.core.kpoints</span> <span class="kn">import</span> <span class="n">find_points_along_path</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">find_points_along_path</span><span class="p">(</span><span class="n">cart_bounds</span><span class="p">,</span> <span class="n">cart_coords</span><span class="p">,</span> <span class="n">dist_tol</span><span class="o">=</span><span class="n">dist_tol</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">ikfound</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Find zero points lying on the input k-path. Try to increase dist_tol&quot;</span><span class="p">)</span>

        <span class="n">new_eigens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">ikfound</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">mband</span><span class="p">))</span>
        <span class="n">new_occfacts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">new_eigens</span><span class="p">)</span>
        <span class="n">new_linewidths</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linewidths</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">new_eigens</span><span class="p">)</span>
        <span class="n">new_frac_coords</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Correspondence new.kpoints --&gt; self.ebands.kpoints</span>
        <span class="c1"># Useful if client code has to rearrange other arrays ordered according to self.ebands.kpoints.</span>
        <span class="n">ik_new2prev</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ik</span><span class="p">,</span> <span class="n">ik_new</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">ikfound</span><span class="p">):</span>
            <span class="c1"># Stars are ordered as self.kpoints to this is the index we need to access self.eigens.</span>
            <span class="c1"># and trasfer the data from self to new</span>
            <span class="n">ik_self</span> <span class="o">=</span> <span class="n">back2istar</span><span class="p">[</span><span class="n">ik_new</span><span class="p">]</span>
            <span class="n">ik_new2prev</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ik_self</span><span class="p">)</span>
            <span class="n">fcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="o">.</span><span class="n">get_fractional_coords</span><span class="p">(</span><span class="n">cart_coords</span><span class="p">[</span><span class="n">ik_new</span><span class="p">])</span>
            <span class="c1">#print(&quot;fcs&quot;, fcs, &quot;dist&quot;, p.dist_list[ik])</span>
            <span class="n">new_frac_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fcs</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                <span class="n">new_eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik_self</span><span class="p">]</span>
                <span class="n">new_occfacts</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">occfacts</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik_self</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linewidths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">new_linewidths</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linewidths</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik_self</span><span class="p">]</span>

        <span class="n">new_kpoints</span> <span class="o">=</span> <span class="n">Kpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">,</span> <span class="n">new_frac_coords</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">new_ebands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">new_kpoints</span><span class="p">,</span> <span class="n">new_eigens</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">,</span> <span class="n">new_occfacts</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspden</span><span class="p">,</span>
                             <span class="n">smearing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smearing</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="n">new_linewidths</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dict2namedtuple</span><span class="p">(</span><span class="n">ebands</span><span class="o">=</span><span class="n">new_ebands</span><span class="p">,</span> <span class="n">ik_new2prev</span><span class="o">=</span><span class="n">ik_new2prev</span><span class="p">)</span></div>

    <span class="c1">#def select_bands(self, bands, kinds=None):</span>
    <span class="c1">#    &quot;&quot;&quot;Build new ElectronBands object by selecting bands via band_slice (slice object).&quot;&quot;&quot;</span>
    <span class="c1">#    bands = np.array(bands)</span>
    <span class="c1">#    kinds = np.array(kinds) if kinds is not None else np.array(range(self.nkpt))</span>
    <span class="c1">#    # This won&#39;t work because I need a KpointList object.</span>
    <span class="c1">#    new_kpoints = self.kpoints[kinds]</span>
    <span class="c1">#    new_eigens = self.eigens[:, kinds, bands].copy()</span>
    <span class="c1">#    new_occfacts = self.occupation[:, kinds, bands].copy()</span>
    <span class="c1">#    new_linewidths = None if not self.linewidths else self.linewidths[:, kinds, bands].copy()</span>

    <span class="c1">#    return self.__class__(self.structure, new_kpoints, new_eigens, self.fermie, new_occfacts,</span>
    <span class="c1">#                          self.nelect, self.nspinor, self.nspden,</span>
    <span class="c1">#                          smearing=self.smearing, linewidths=new_linewidths)</span>

<div class="viewcode-block" id="ElectronBands.empty_with_ibz"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.empty_with_ibz">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">empty_with_ibz</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ngkpt</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">fermie</span><span class="p">,</span> <span class="n">nelect</span><span class="p">,</span> <span class="n">nsppol</span><span class="p">,</span> <span class="n">nspinor</span><span class="p">,</span> <span class="n">nspden</span><span class="p">,</span> <span class="n">mband</span><span class="p">,</span>
                       <span class="n">shiftk</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">kptopt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">abipy.abio.factories</span> <span class="kn">import</span> <span class="n">gs_input</span>
        <span class="kn">from</span> <span class="nn">abipy.data.hgh_pseudos</span> <span class="kn">import</span> <span class="n">HGH_TABLE</span>
        <span class="n">gsinp</span> <span class="o">=</span> <span class="n">gs_input</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">HGH_TABLE</span><span class="p">,</span> <span class="n">spin_mode</span><span class="o">=</span><span class="s2">&quot;unpolarized&quot;</span><span class="p">)</span>
        <span class="n">ibz</span> <span class="o">=</span> <span class="n">gsinp</span><span class="o">.</span><span class="n">abiget_ibz</span><span class="p">(</span><span class="n">ngkpt</span><span class="o">=</span><span class="n">ngkpt</span><span class="p">,</span> <span class="n">shiftk</span><span class="o">=</span><span class="n">shiftk</span><span class="p">,</span> <span class="n">kptopt</span><span class="o">=</span><span class="n">kptopt</span><span class="p">)</span>
        <span class="n">ksampling</span> <span class="o">=</span> <span class="n">KSamplingInfo</span><span class="o">.</span><span class="n">from_mpdivs</span><span class="p">(</span><span class="n">ngkpt</span><span class="p">,</span> <span class="n">shiftk</span><span class="p">,</span> <span class="n">kptopt</span><span class="p">)</span>

        <span class="n">kpoints</span> <span class="o">=</span> <span class="n">IrredZone</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">,</span> <span class="n">ibz</span><span class="o">.</span><span class="n">points</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">ibz</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span>
                            <span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ksampling</span><span class="o">=</span><span class="n">ksampling</span><span class="p">)</span>

        <span class="n">new_eigens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nsppol</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">kpoints</span><span class="p">),</span> <span class="n">mband</span><span class="p">))</span>
        <span class="n">new_occfacts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">new_eigens</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">kpoints</span><span class="p">,</span> <span class="n">new_eigens</span><span class="p">,</span> <span class="n">fermie</span><span class="p">,</span> <span class="n">new_occfacts</span><span class="p">,</span>
                   <span class="n">nelect</span><span class="p">,</span> <span class="n">nspinor</span><span class="p">,</span> <span class="n">nspden</span><span class="p">,</span>
                   <span class="n">smearing</span><span class="o">=</span><span class="n">smearing</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="n">linewidths</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.get_dict4pandas"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.get_dict4pandas">[docs]</a>    <span class="k">def</span> <span class="nf">get_dict4pandas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_geo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_spglib</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a :class:`OrderedDict` with the most important parameters:</span>

<span class="sd">            - Chemical formula and number of atoms.</span>
<span class="sd">            - Lattice lengths, angles and volume.</span>
<span class="sd">            - The spacegroup number computed by Abinit (set to None if not available).</span>
<span class="sd">            - The spacegroup number and symbol computed by spglib (set to None not `with_spglib`).</span>

<span class="sd">        Useful to construct pandas DataFrames</span>

<span class="sd">        Args:</span>
<span class="sd">            with_geo: True if structure info should be added to the dataframe</span>
<span class="sd">            with_spglib: If True, spglib_ is invoked to get the spacegroup symbol and number.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">odict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([</span>
            <span class="p">(</span><span class="s2">&quot;nsppol&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;nspinor&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;nspden&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspden</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;nkpt&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;nband&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span>
            <span class="p">(</span><span class="s2">&quot;nelect&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">),</span>

        <span class="p">])</span>

        <span class="c1"># Add info on structure.</span>
        <span class="k">if</span> <span class="n">with_geo</span><span class="p">:</span>
            <span class="n">odict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">get_dict4pandas</span><span class="p">(</span><span class="n">with_spglib</span><span class="o">=</span><span class="n">with_spglib</span><span class="p">))</span>

        <span class="n">odict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smearing</span><span class="p">)</span>

        <span class="n">bws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandwidths</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
            <span class="n">odict</span><span class="p">[</span><span class="s2">&quot;bandwidth_spin</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">spin</span><span class="p">]</span> <span class="o">=</span> <span class="n">bws</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span>

        <span class="n">enough_bands</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mband</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">enough_bands</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
                <span class="n">odict</span><span class="p">[</span><span class="s2">&quot;fundgap_spin</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">spin</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fundamental_gaps</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span><span class="o">.</span><span class="n">energy</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
                <span class="n">odict</span><span class="p">[</span><span class="s2">&quot;dirgap_spin</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">spin</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">direct_gaps</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span><span class="o">.</span><span class="n">energy</span>

            <span class="c1"># Select min gap over spins.</span>
            <span class="n">min_fgap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fundamental_gaps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">min_dgap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">direct_gaps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">fgap0</span><span class="p">,</span> <span class="n">fgap1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fundamental_gaps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">fundamental_gaps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">min_fgap</span> <span class="o">=</span> <span class="n">fgap0</span> <span class="k">if</span> <span class="n">fgap0</span><span class="o">.</span><span class="n">energy</span> <span class="o">&lt;</span> <span class="n">fgap1</span><span class="o">.</span><span class="n">energy</span> <span class="k">else</span> <span class="n">fgap1</span>
                <span class="n">dgap0</span><span class="p">,</span> <span class="n">dgap1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">direct_gaps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">direct_gaps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">min_dgap</span> <span class="o">=</span> <span class="n">dgap0</span> <span class="k">if</span> <span class="n">dgap0</span><span class="o">.</span><span class="n">energy</span> <span class="o">&lt;</span> <span class="n">dgap1</span><span class="o">.</span><span class="n">energy</span> <span class="k">else</span> <span class="n">dgap1</span>

            <span class="c1"># These quantities are not spin-dependent.</span>
            <span class="n">odict</span><span class="p">[</span><span class="s2">&quot;gap_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;direct&quot;</span> <span class="k">if</span> <span class="n">min_fgap</span><span class="o">.</span><span class="n">is_direct</span> <span class="k">else</span> <span class="s2">&quot;indirect&quot;</span>
            <span class="n">odict</span><span class="p">[</span><span class="s2">&quot;fundgap_kstart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">min_fgap</span><span class="o">.</span><span class="n">in_state</span><span class="o">.</span><span class="n">kpoint</span><span class="p">)</span>
            <span class="n">odict</span><span class="p">[</span><span class="s2">&quot;fundgap_kend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">min_fgap</span><span class="o">.</span><span class="n">out_state</span><span class="o">.</span><span class="n">kpoint</span><span class="p">)</span>
            <span class="n">odict</span><span class="p">[</span><span class="s2">&quot;dirgap_kstart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">min_dgap</span><span class="o">.</span><span class="n">in_state</span><span class="o">.</span><span class="n">kpoint</span><span class="p">)</span>
            <span class="n">odict</span><span class="p">[</span><span class="s2">&quot;dirgap_kend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">min_dgap</span><span class="o">.</span><span class="n">out_state</span><span class="o">.</span><span class="n">kpoint</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">odict</span></div>

<div class="viewcode-block" id="ElectronBands.has_bzmesh"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.has_bzmesh">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">has_bzmesh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if the k-point sampling is homogeneous.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">,</span> <span class="n">IrredZone</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.has_bzpath"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.has_bzpath">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">has_bzpath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if the bands are computed on a k-path.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">,</span> <span class="n">Kpath</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.kptopt"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.kptopt">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">kptopt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The value of the kptopt input variable.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">ksampling</span><span class="o">.</span><span class="n">kptopt</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;ebands.kpoints.ksampling.kptopt is not defined, assuming kptopt = 1&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="ElectronBands.has_timrev"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.has_timrev">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">has_timrev</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if time-reversal symmetry is used in the BZ sampling.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">has_timrev_from_kptopt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kptopt</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.supports_fermi_surface"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.supports_fermi_surface">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">supports_fermi_surface</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        True if the kpoints used for the energies can be employed to visualize Fermi surface.</span>
<span class="sd">        Fermi surface viewers require gamma-centered k-mesh.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">is_mpmesh</span><span class="p">:</span>
            <span class="n">mpdivs</span><span class="p">,</span> <span class="n">shifts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">mpdivs_shifts</span>
            <span class="k">if</span> <span class="n">shifts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">shifts</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="ElectronBands.kindex"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.kindex">[docs]</a>    <span class="k">def</span> <span class="nf">kindex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The index of the k-point in the internal list of k-points.</span>
<span class="sd">        Accepts: |Kpoint| instance or integer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">duck</span><span class="o">.</span><span class="n">is_intlike</span><span class="p">(</span><span class="n">kpoint</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.skb_iter"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.skb_iter">[docs]</a>    <span class="k">def</span> <span class="nf">skb_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterator over (spin, k, band) indices.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kidxs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik</span><span class="p">]):</span>
                    <span class="k">yield</span> <span class="n">spin</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">band</span></div>

<div class="viewcode-block" id="ElectronBands.deepcopy"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.deepcopy">[docs]</a>    <span class="k">def</span> <span class="nf">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deep copy of the ElectronBands object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.degeneracies"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.degeneracies">[docs]</a>    <span class="k">def</span> <span class="nf">degeneracies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">bands_range</span><span class="p">,</span> <span class="n">tol_ediff</span><span class="o">=</span><span class="mf">1.e-3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list with the indices of the degenerate bands.</span>

<span class="sd">        Args:</span>
<span class="sd">            spin: Spin index.</span>
<span class="sd">            kpoint: K-point index or |Kpoint| object</span>
<span class="sd">            bands_range: List of band indices to analyze.</span>
<span class="sd">            tol_ediff: Tolerance on the energy difference (in eV)</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of tuples [(e0, bands_e0), (e1, bands_e1, ....]</span>
<span class="sd">            Each tuple stores the degenerate energy and a list with the band indices.</span>
<span class="sd">            The band structure of silicon at Gamma, for example, will produce something like:</span>
<span class="sd">            [(-6.3, [0]), (5.6, [1, 2, 3]), (8.1, [4, 5, 6])]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Find the index of the k-point</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kindex</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span>

        <span class="c1"># Extract the energies we are interested in.</span>
        <span class="n">bands_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bands_range</span><span class="p">)</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">band</span><span class="p">]</span> <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">bands_list</span><span class="p">]</span>

        <span class="c1"># Group bands according to their degeneracy.</span>
        <span class="n">bstart</span><span class="p">,</span> <span class="n">deg_ebands</span> <span class="o">=</span> <span class="n">bands_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[]</span>
        <span class="n">e0</span><span class="p">,</span> <span class="n">bs</span> <span class="o">=</span> <span class="n">energies</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">bstart</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">band</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">energies</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="n">band</span> <span class="o">+=</span> <span class="p">(</span><span class="n">bstart</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">new_deg</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">e</span><span class="o">-</span><span class="n">e0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tol_ediff</span>

            <span class="k">if</span> <span class="n">new_deg</span><span class="p">:</span>
                <span class="n">ebs</span> <span class="o">=</span> <span class="p">(</span><span class="n">e0</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>
                <span class="n">deg_ebands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ebs</span><span class="p">)</span>
                <span class="n">e0</span><span class="p">,</span> <span class="n">bs</span> <span class="o">=</span> <span class="n">e</span><span class="p">,</span> <span class="p">[</span><span class="n">band</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>

        <span class="n">deg_ebands</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">e0</span><span class="p">,</span> <span class="n">bs</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">deg_ebands</span></div>

<div class="viewcode-block" id="ElectronBands.enemin"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.enemin">[docs]</a>    <span class="k">def</span> <span class="nf">enemin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the minimum of the eigenvalues.&quot;&quot;&quot;</span>
        <span class="n">spin_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span>
        <span class="k">if</span> <span class="n">spin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
            <span class="n">spin_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">spin</span><span class="p">]</span>

        <span class="n">my_kidxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kidxs</span>

        <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
            <span class="n">my_bands</span> <span class="o">=</span> <span class="p">[</span><span class="n">band</span><span class="p">]</span>

        <span class="n">emin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="n">spin_range</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">my_kidxs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">my_bands</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">my_bands</span><span class="p">:</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">band</span><span class="p">]</span>
                    <span class="n">emin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">emin</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">emin</span></div>

<div class="viewcode-block" id="ElectronBands.enemax"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.enemax">[docs]</a>    <span class="k">def</span> <span class="nf">enemax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the maximum of the eigenvalues.&quot;&quot;&quot;</span>
        <span class="n">spin_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span>
        <span class="k">if</span> <span class="n">spin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
            <span class="n">spin_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">spin</span><span class="p">]</span>

        <span class="n">my_kidxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kidxs</span>

        <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
            <span class="n">my_bands</span> <span class="o">=</span> <span class="p">[</span><span class="n">band</span><span class="p">]</span>

        <span class="n">emax</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="n">spin_range</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">my_kidxs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">my_bands</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">my_bands</span><span class="p">:</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">band</span><span class="p">]</span>
                    <span class="n">emax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">emax</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">emax</span></div>

<div class="viewcode-block" id="ElectronBands.dispersionless_states"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.dispersionless_states">[docs]</a>    <span class="k">def</span> <span class="nf">dispersionless_states</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">erange</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deltae</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">kfact</span><span class="o">=</span><span class="mf">0.9</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function detects dispersionless states.</span>
<span class="sd">        A state is dispersionless if there are more that (nkpt * kfact) energies</span>
<span class="sd">        in the energy intervale [e0 - deltae, e0 + deltae]</span>

<span class="sd">        Args:</span>
<span class="sd">            erange=Energy range to be analyzed in the form [emin, emax]</span>
<span class="sd">            deltae: Defines the energy interval in eV around the KS eigenvalue.</span>
<span class="sd">            kfact: Can be used to change the criterion used to detect dispersionless states.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of :class:`Electron` objects. Each item contains information on</span>
<span class="sd">            the energy, the occupation and the location of the dispersionless band.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">erange</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">erange</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
        <span class="n">kref</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">dless_states</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">kref</span><span class="p">]):</span>
                <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">kref</span><span class="p">,</span> <span class="n">band</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">erange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">e0</span> <span class="o">&gt;</span> <span class="n">erange</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="k">continue</span>
                <span class="n">hrange</span> <span class="o">=</span> <span class="p">[</span><span class="n">e0</span> <span class="o">-</span> <span class="n">deltae</span><span class="p">,</span> <span class="n">e0</span> <span class="o">+</span> <span class="n">deltae</span><span class="p">]</span>
                <span class="n">hist</span><span class="p">,</span> <span class="n">bin_hedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,:,:],</span>
                    <span class="n">bins</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">hrange</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="c1">#print(&quot;hist&quot;, hist, &quot;hrange&quot;, hrange, &quot;bin_hedges&quot;, bin_hedges)</span>

                <span class="k">if</span> <span class="n">hist</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span> <span class="o">*</span> <span class="n">kfact</span><span class="p">:</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_electron_state</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kref</span><span class="p">,</span> <span class="n">band</span><span class="p">)</span>
                    <span class="n">dless_states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dless_states</span></div>

<div class="viewcode-block" id="ElectronBands.get_dataframe"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.get_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">get_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a |pandas-DataFrame| with the following columns:</span>

<span class="sd">          [&#39;spin&#39;, &#39;kidx&#39;, &#39;band&#39;, &#39;eig&#39;, &#39;occ&#39;, &#39;kpoint&#39;]</span>

<span class="sd">        where:</span>

<span class="sd">        ==============  ==========================</span>
<span class="sd">        Column          Meaning</span>
<span class="sd">        ==============  ==========================</span>
<span class="sd">        spin            spin index</span>
<span class="sd">        kidx            k-point index</span>
<span class="sd">        band            band index</span>
<span class="sd">        eig             KS eigenvalue in eV.</span>
<span class="sd">        occ             Occupation of the state.</span>
<span class="sd">        kpoint          :class:`Kpoint` object</span>
<span class="sd">        ==============  ==========================</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - `fermie`: shift all eigenvalues to have zero energy at the Fermi energy (`self.fermie`).</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">                The Fermi energy is saved in frame.fermie</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">kpoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">]):</span>
                    <span class="n">eig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">band</span><span class="p">]</span> <span class="o">-</span> <span class="n">e0</span>
                    <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">([</span>
                               <span class="p">(</span><span class="s2">&quot;spin&quot;</span><span class="p">,</span> <span class="n">spin</span><span class="p">),</span>
                               <span class="p">(</span><span class="s2">&quot;kidx&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span>
                               <span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="n">band</span><span class="p">),</span>
                               <span class="p">(</span><span class="s2">&quot;eig&quot;</span><span class="p">,</span> <span class="n">eig</span><span class="p">),</span>
                               <span class="p">(</span><span class="s2">&quot;occ&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">occfacts</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">band</span><span class="p">]),</span>
                               <span class="p">(</span><span class="s2">&quot;kpoint&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">[</span><span class="n">k</span><span class="p">]),</span>
                            <span class="p">]))</span>

        <span class="n">frame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">fermie</span> <span class="o">=</span> <span class="n">e0</span>
        <span class="k">return</span> <span class="n">frame</span></div>

<div class="viewcode-block" id="ElectronBands.boxplot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.boxplot">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">boxplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">brange</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">swarm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use seaborn_ to draw a box plot to show distributions of eigenvalues with respect to the band index.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: |matplotlib-Axes| or None if a new figure should be created.</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - ``fermie``: shift all eigenvalues to have zero energy at the Fermi energy (``self.fermie``).</span>
<span class="sd">                -  Number e.g ``e0 = 0.5``: shift all eigenvalues to have zero energy at 0.5 eV.</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to ``e0 = 0``.</span>
<span class="sd">            brange: Only bands such as ``brange[0] &lt;= band_index &lt; brange[1]`` are included in the plot.</span>
<span class="sd">            swarm: True to show the datapoints on top of the boxes</span>
<span class="sd">            kwargs: Keyword arguments passed to seaborn boxplot.</span>

<span class="sd">        Return: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the dataframe and select bands</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dataframe</span><span class="p">(</span><span class="n">e0</span><span class="o">=</span><span class="n">e0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">brange</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[(</span><span class="n">frame</span><span class="p">[</span><span class="s2">&quot;band&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">brange</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">frame</span><span class="p">[</span><span class="s2">&quot;band&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">brange</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
        <span class="n">hue</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;spin&quot;</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;eig&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">frame</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="n">hue</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">swarm</span><span class="p">:</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">swarmplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;eig&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">frame</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="n">hue</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;.25&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="ElectronBands.from_pymatgen"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.from_pymatgen">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_pymatgen</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pmg_bands</span><span class="p">,</span> <span class="n">nelect</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">has_timerev</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">ksampling</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nspinor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nspden</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a pymatgen bandstructure object to an Abipy |ElectronBands| object.</span>

<span class="sd">        Args:</span>
<span class="sd">            pmg_bands: pymatgen bandstructure object.</span>
<span class="sd">            nelect: Number of electrons in unit cell.</span>
<span class="sd">            weights: List of K-points weights (normalized to one, same order as pmg_bands.kpoints).</span>
<span class="sd">                This argument is optional but recommended when ``pmg_bands`` represents an IBZ sampling.</span>
<span class="sd">                If weights are not provided, Abipy methods requiring integrations in the BZ won&#39;t work.</span>
<span class="sd">            has_timerev: True if time-reversal symmetry can be used.</span>
<span class="sd">            ksampling: dictionary with parameters passed to :class:`KSamplingInfo` defining the k-points sampling.</span>
<span class="sd">                If None, hard-coded values are used. This argument is recommended if IBZ sampling.</span>
<span class="sd">            smearing: dictionary with parameters passed to :class:`Smearing`</span>
<span class="sd">                If None, default hard-coded values are used.</span>
<span class="sd">            nspinor: Number of spinor components.</span>
<span class="sd">            nspden: Number of independent spin-density components.</span>
<span class="sd">                If None, nspden is automatically computed from nsppol</span>

<span class="sd">        .. warning::</span>

<span class="sd">            The Abipy bandstructure contains more information than the pymatgen object so</span>
<span class="sd">            the conversion is not complete, especially if you rely on the default values.</span>
<span class="sd">            Please read carefylly the docstring and the code and use the optional arguments to pass</span>
<span class="sd">            additional data required by AbiPy if you need a complete conversion.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">pymatgen.electronic_structure.bandstructure</span> <span class="kn">import</span> <span class="n">BandStructure</span><span class="p">,</span> <span class="n">BandStructureSymmLine</span>

        <span class="c1"># Cast to abipy structure and call spglib to init AbinitSpaceGroup.</span>
        <span class="n">abipy_structure</span> <span class="o">=</span> <span class="n">Structure</span><span class="o">.</span><span class="n">as_structure</span><span class="p">(</span><span class="n">pmg_bands</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">abipy_structure</span><span class="o">.</span><span class="n">has_abi_spacegroup</span><span class="p">:</span>
            <span class="n">abipy_structure</span><span class="o">.</span><span class="n">spgset_abi_spacegroup</span><span class="p">(</span><span class="n">has_timerev</span><span class="p">)</span>

        <span class="c1"># Get dimensions.</span>
        <span class="n">nsppol</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">pmg_bands</span><span class="o">.</span><span class="n">is_spin_polarized</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">nspden</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nspinor</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">nspden</span> <span class="o">=</span> <span class="n">nsppol</span>
            <span class="k">if</span> <span class="n">nspinor</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="n">nspden</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">nkpt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pmg_bands</span><span class="o">.</span><span class="n">kpoints</span><span class="p">)</span>

        <span class="n">smearing</span> <span class="o">=</span> <span class="n">Smearing</span><span class="o">.</span><span class="n">as_smearing</span><span class="p">(</span><span class="n">smearing</span><span class="p">)</span>
        <span class="n">ksampling</span> <span class="o">=</span> <span class="n">KSamplingInfo</span><span class="o">.</span><span class="n">as_ksampling</span><span class="p">(</span><span class="n">ksampling</span><span class="p">)</span>

        <span class="c1"># Build numpy array with eigenvalues.</span>
        <span class="n">abipy_eigens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nsppol</span><span class="p">,</span> <span class="n">nkpt</span><span class="p">,</span> <span class="n">pmg_bands</span><span class="o">.</span><span class="n">nb_bands</span><span class="p">))</span>
        <span class="n">abipy_eigens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pmg_bands</span><span class="o">.</span><span class="n">bands</span><span class="p">[</span><span class="n">PmgSpin</span><span class="o">.</span><span class="n">up</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">abipy_eigens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pmg_bands</span><span class="o">.</span><span class="n">bands</span><span class="p">[</span><span class="n">PmgSpin</span><span class="o">.</span><span class="n">down</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Compute occupation factors. Note that pmg bands don&#39;t have occfact so</span>
        <span class="c1"># I have to compute them from the eigens assuming T=0)</span>
        <span class="n">atol</span> <span class="o">=</span> <span class="mf">1e-4</span>
        <span class="n">abipy_occfacts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">abipy_eigens</span> <span class="o">&lt;=</span> <span class="n">pmg_bands</span><span class="o">.</span><span class="n">efermi</span> <span class="o">+</span> <span class="n">atol</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nsppol</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">abipy_occfacts</span> <span class="o">*=</span> <span class="mi">2</span>

        <span class="n">reciprocal_lattice</span> <span class="o">=</span> <span class="n">pmg_bands</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">reciprocal_lattice</span>
        <span class="n">frac_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">k</span><span class="o">.</span><span class="n">frac_coords</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">pmg_bands</span><span class="o">.</span><span class="n">kpoints</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pmg_bands</span><span class="p">,</span> <span class="n">BandStructureSymmLine</span><span class="p">):</span>
            <span class="n">abipy_kpoints</span> <span class="o">=</span> <span class="n">Kpath</span><span class="p">(</span><span class="n">reciprocal_lattice</span><span class="p">,</span> <span class="n">frac_coords</span><span class="p">,</span>
                                  <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ksampling</span><span class="o">=</span><span class="n">ksampling</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pmg_bands</span><span class="p">,</span> <span class="n">BandStructure</span><span class="p">):</span>
            <span class="n">abipy_kpoints</span> <span class="o">=</span> <span class="n">IrredZone</span><span class="p">(</span><span class="n">reciprocal_lattice</span><span class="p">,</span> <span class="n">frac_coords</span><span class="p">,</span>
                                      <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ksampling</span><span class="o">=</span><span class="n">ksampling</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know how to handle type: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">pmg_bands</span><span class="p">))</span>

        <span class="c1"># Find names of the kpoints.</span>
        <span class="k">for</span> <span class="n">kpoint</span> <span class="ow">in</span> <span class="n">abipy_kpoints</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">abipy_structure</span><span class="o">.</span><span class="n">findname_in_hsym_stars</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">abipy_structure</span><span class="p">,</span> <span class="n">abipy_kpoints</span><span class="p">,</span> <span class="n">abipy_eigens</span><span class="p">,</span> <span class="n">pmg_bands</span><span class="o">.</span><span class="n">efermi</span><span class="p">,</span> <span class="n">abipy_occfacts</span><span class="p">,</span>
                   <span class="n">nelect</span><span class="p">,</span> <span class="n">nspinor</span><span class="p">,</span> <span class="n">nspden</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="n">smearing</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.to_pymatgen"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.to_pymatgen">[docs]</a>    <span class="k">def</span> <span class="nf">to_pymatgen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a pymatgen bandstructure object from an Abipy |ElectronBands| object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">pymatgen.electronic_structure.bandstructure</span> <span class="kn">import</span> <span class="n">BandStructure</span><span class="p">,</span> <span class="n">BandStructureSymmLine</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="c1"># eigenvals is a dict of energies for spin up and spin down</span>
        <span class="c1"># {Spin.up:[][], Spin.down:[][]}, the first index of the array</span>
        <span class="c1"># [][] refers to the band and the second to the index of the</span>
        <span class="c1"># kpoint. The kpoints are ordered according to the order of the</span>
        <span class="c1"># kpoints array. If the band structure is not spin polarized, we</span>
        <span class="c1"># only store one data set under Spin.up</span>
        <span class="n">eigenvals</span> <span class="o">=</span> <span class="p">{</span><span class="n">PmgSpin</span><span class="o">.</span><span class="n">up</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">eigenvals</span><span class="p">[</span><span class="n">PmgSpin</span><span class="o">.</span><span class="n">down</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">is_path</span><span class="p">:</span>
            <span class="n">labels_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">k</span><span class="o">.</span><span class="n">frac_coords</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">BandStructureSymmLine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">,</span> <span class="n">eigenvals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">,</span>
                                         <span class="n">labels_dict</span><span class="p">,</span> <span class="n">coords_are_cartesian</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">projections</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BandStructure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">,</span> <span class="n">eigenvals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">,</span>
                                 <span class="n">labels_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coords_are_cartesian</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">projections</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_electron_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build an instance of :class:`Electron` from the spin, kpoint and band index</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kidx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kindex</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Electron</span><span class="p">(</span><span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span>
                        <span class="n">kpoint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">[</span><span class="n">kidx</span><span class="p">],</span>
                        <span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">,</span>
                        <span class="n">eig</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">kidx</span><span class="p">,</span> <span class="n">band</span><span class="p">],</span>
                        <span class="n">occ</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">occfacts</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">kidx</span><span class="p">,</span> <span class="n">band</span><span class="p">],</span>
                        <span class="n">kidx</span><span class="o">=</span><span class="n">kidx</span><span class="p">,</span>
                        <span class="c1">#fermie=self.fermie</span>
                        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lomos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;lomo states for each spin channel as a list of nsppol :class:`Electron`.&quot;&quot;&quot;</span>
        <span class="n">lomos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">*</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
            <span class="n">lomo_kidx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
            <span class="n">lomos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_electron_state</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">lomo_kidx</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lomos</span>

<div class="viewcode-block" id="ElectronBands.lomo_sk"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.lomo_sk">[docs]</a>    <span class="k">def</span> <span class="nf">lomo_sk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the LOMO state for the given spin, kpoint.</span>

<span class="sd">        Args:</span>
<span class="sd">            spin: Spin index</span>
<span class="sd">            kpoint: Index of the kpoint or |Kpoint| object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_electron_state</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.homo_sk"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.homo_sk">[docs]</a>    <span class="k">def</span> <span class="nf">homo_sk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the HOMO state for the given spin, kpoint.</span>

<span class="sd">        Args:</span>
<span class="sd">            spin: Spin index</span>
<span class="sd">            kpoint: Index of the kpoint or |Kpoint| object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kindex</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span>
        <span class="c1"># Find rightmost value less than or equal to fermie.</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">find_le</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">,:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_fermie</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_electron_state</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.lumo_sk"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.lumo_sk">[docs]</a>    <span class="k">def</span> <span class="nf">lumo_sk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the LUMO state for the given spin, kpoint.</span>

<span class="sd">        Args:</span>
<span class="sd">            spin: Spin index</span>
<span class="sd">            kpoint: Index of the kpoint or |Kpoint| object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kindex</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span>
        <span class="c1"># Find leftmost value greater than fermie.</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">find_gt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">,:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_fermie</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_electron_state</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">homos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;homo states for each spin channel as a list of nsppol :class:`Electron`.&quot;&quot;&quot;</span>
        <span class="n">homos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">*</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
            <span class="n">blist</span><span class="p">,</span> <span class="n">enes</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kidxs</span><span class="p">:</span>
                <span class="c1"># Find rightmost value less than or equal to fermie.</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">find_le</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">,:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_fermie</span><span class="p">)</span>
                <span class="n">blist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                <span class="n">enes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">b</span><span class="p">])</span>

            <span class="n">homo_kidx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">enes</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
            <span class="n">homo_band</span> <span class="o">=</span> <span class="n">blist</span><span class="p">[</span><span class="n">homo_kidx</span><span class="p">]</span>

            <span class="c1"># Build Electron instance.</span>
            <span class="n">homos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_electron_state</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">homo_kidx</span><span class="p">,</span> <span class="n">homo_band</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">homos</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lumos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        lumo states for each spin channel as a list of nsppol :class:`Electron`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lumos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">*</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
            <span class="n">blist</span><span class="p">,</span> <span class="n">enes</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kidxs</span><span class="p">:</span>
                <span class="c1"># Find leftmost value greater than fermie.</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">find_gt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_fermie</span><span class="p">)</span>
                <span class="n">blist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                <span class="n">enes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>

            <span class="c1">#enes = np.array(enes)</span>
            <span class="c1">#kinds = np.where(enes == enes.min())[0]</span>
            <span class="c1">#lumo_kidx = np.asscalar(kinds[len(kinds) // 2])</span>
            <span class="n">lumo_kidx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">enes</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
            <span class="n">lumo_band</span> <span class="o">=</span> <span class="n">blist</span><span class="p">[</span><span class="n">lumo_kidx</span><span class="p">]</span>

            <span class="c1"># Build Electron instance.</span>
            <span class="n">lumos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_electron_state</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">lumo_kidx</span><span class="p">,</span> <span class="n">lumo_band</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lumos</span>

    <span class="c1">#def is_metal(self, spin)</span>
    <span class="c1">#    &quot;&quot;&quot;True if this spin channel is metallic.&quot;&quot;&quot;</span>
    <span class="c1">#    if not self.has_metallic_scheme: return False</span>
    <span class="c1">#    for k in self.kidxs:</span>
    <span class="c1">#        # Find leftmost value greater than x.</span>
    <span class="c1">#        b = find_gt(self.eigens[spin,k,:], self.fermie)</span>
    <span class="c1">#        if self.eigens[spin,k,b] &lt; self.fermie + 0.01:</span>
    <span class="c1">#            return True</span>

    <span class="c1">#def is_semimetal(self, spin)</span>
    <span class="c1">#    &quot;&quot;&quot;True if this spin channel is semi-metal.&quot;&quot;&quot;</span>
    <span class="c1">#    fun_gaps = self.fundamental_gaps</span>
    <span class="c1">#    for spin in self.spins:</span>
    <span class="c1">#       if abs(fun_gaps.ene) &lt;  TOL_EGAP</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bandwidths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The bandwidth for each spin channel i.e. the energy difference (homo - lomo).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">homos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span><span class="o">.</span><span class="n">eig</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lomos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span><span class="o">.</span><span class="n">eig</span> <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fundamental_gaps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of :class:`ElectronTransition` with info on the fundamental gaps for each spin.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">ElectronTransition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">homos</span><span class="p">[</span><span class="n">spin</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lumos</span><span class="p">[</span><span class="n">spin</span><span class="p">])</span> <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">direct_gaps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of `nsppol` :class:`ElectronTransition` with info on the direct gaps for each spin.&quot;&quot;&quot;</span>
        <span class="n">dirgaps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">*</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
            <span class="n">gaps</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kidxs</span><span class="p">:</span>
                <span class="n">homo_sk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">homo_sk</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                <span class="n">lumo_sk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lumo_sk</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                <span class="n">gaps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lumo_sk</span><span class="o">.</span><span class="n">eig</span> <span class="o">-</span> <span class="n">homo_sk</span><span class="o">.</span><span class="n">eig</span><span class="p">)</span>

            <span class="c1"># Find the index of the k-point where the direct gap is located.</span>
            <span class="c1"># If there multiple k-points along the path, prefer the one in the center</span>
            <span class="c1"># If not possible e.g. direct at G with G-X-L-G path avoid points on the right border of the graph</span>
            <span class="n">gaps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gaps</span><span class="p">)</span>
            <span class="n">kinds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">gaps</span> <span class="o">==</span> <span class="n">gaps</span><span class="o">.</span><span class="n">min</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">kdir</span> <span class="o">=</span> <span class="n">kinds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">all_kinds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">kinds</span><span class="p">,</span> <span class="n">kinds</span><span class="p">))</span>
            <span class="c1">#kdir = kinds[len(kinds) // 2]</span>
            <span class="c1">#kdir = np.array(gaps).argmin()</span>
            <span class="n">dirgaps</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span> <span class="o">=</span> <span class="n">ElectronTransition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">homo_sk</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kdir</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lumo_sk</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kdir</span><span class="p">),</span> <span class="n">all_kinds</span><span class="o">=</span><span class="n">all_kinds</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dirgaps</span>

<div class="viewcode-block" id="ElectronBands.get_gaps_string"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.get_gaps_string">[docs]</a>    <span class="k">def</span> <span class="nf">get_gaps_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_latex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unicode</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return string with info about fundamental and direct gap (if not metallic scheme)</span>

<span class="sd">        Args:</span>
<span class="sd">            with_latex: True to get latex symbols for the gap names and formula else text.</span>
<span class="sd">            unicode: True to get unicode symbols for the formula else text.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">enough_bands</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mband</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">with_latex</span><span class="p">:</span>
            <span class="n">dg_name</span><span class="p">,</span> <span class="n">fg_name</span> <span class="o">=</span> <span class="s2">&quot;$E^</span><span class="si">{dir}</span><span class="s2">_</span><span class="si">{gap}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="s2">&quot;$E^</span><span class="si">{fund}</span><span class="s2">_</span><span class="si">{gap}</span><span class="s2">$&quot;</span>
            <span class="n">formula</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">latex_formula</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dg_name</span><span class="p">,</span> <span class="n">fg_name</span> <span class="o">=</span> <span class="s2">&quot;direct gap&quot;</span><span class="p">,</span> <span class="s2">&quot;fundamental gap&quot;</span>
            <span class="n">formula</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">formula</span>

        <span class="k">if</span> <span class="n">unicode</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">re</span>
            <span class="n">numl</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d&#39;</span><span class="p">,</span> <span class="n">formula</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">numl</span><span class="p">:</span>
                <span class="n">formula</span> <span class="o">=</span> <span class="n">formula</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">SUBSCRIPT_UNICODE</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">enough_bands</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_metallic_scheme</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.2f</span><span class="s2">, </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.2f</span><span class="s2"> (eV)&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">formula</span><span class="p">,</span>
                    <span class="n">dg_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">direct_gaps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span>
                    <span class="n">fg_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fundamental_gaps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">energy</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">direct_gaps</span><span class="p">]</span>
                <span class="n">fgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">energy</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fundamental_gaps</span><span class="p">]</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.2f</span><span class="s2"> (</span><span class="si">%.2f</span><span class="s2">), </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.2f</span><span class="s2"> (</span><span class="si">%.2f</span><span class="s2">) (eV)&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">formula</span><span class="p">,</span>
                    <span class="n">dg_name</span><span class="p">,</span> <span class="n">dgs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dgs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">fg_name</span><span class="p">,</span> <span class="n">fgs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fgs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">return</span> <span class="n">s</span></div>

<div class="viewcode-block" id="ElectronBands.get_kpoints_and_band_range_for_edges"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.get_kpoints_and_band_range_for_edges">[docs]</a>    <span class="k">def</span> <span class="nf">get_kpoints_and_band_range_for_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the reduced coordinates and the band indice associate to the band edges.</span>
<span class="sd">        Important: Call set_fermie_to_vbm() to set the Fermi level to the VBM before calling this method.</span>

<span class="sd">        Return: (k0_list, effmass_bands_f90) (Fortran notation)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
        <span class="n">k0_list</span><span class="p">,</span> <span class="n">effmass_bands_f90</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span>
            <span class="n">homo</span><span class="p">,</span> <span class="n">lumo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">homos</span><span class="p">[</span><span class="n">spin</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lumos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span>
            <span class="n">k</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">homo</span><span class="o">.</span><span class="n">kpoint</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">)</span>
            <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">homo</span><span class="o">.</span><span class="n">band</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># C --&gt; F index</span>
            <span class="n">k</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">lumo</span><span class="o">.</span><span class="n">kpoint</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">)</span>
            <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">lumo</span><span class="o">.</span><span class="n">band</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="ow">or</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot find band extrema, dict:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">:&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">k0_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">effmass_bands_f90</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

        <span class="c1"># Set small values to zero.</span>
        <span class="n">k0_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">k0_list</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">k0_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">k0_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-12</span><span class="p">,</span> <span class="n">k0_list</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

        <span class="n">effmass_bands_f90</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">effmass_bands_f90</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="c1">#print(&quot;k0_list:\n&quot;, k0_list, &quot;\neffmass_bands_f90:\n&quot;, effmass_bands_f90)</span>

        <span class="k">return</span> <span class="n">k0_list</span><span class="p">,</span> <span class="n">effmass_bands_f90</span></div>

<div class="viewcode-block" id="ElectronBands.to_string"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_structure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_kpoints</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Human-readable string with useful info such as band gaps, position of HOMO, LOMO...</span>

<span class="sd">        Args:</span>
<span class="sd">            with_structure: False if structural info shoud not be displayed.</span>
<span class="sd">            with_kpoints: False if k-point info shoud not be displayed.</span>
<span class="sd">            verbose: Verbosity level.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">with_structure</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Structure&quot;</span><span class="p">))</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Number of electrons: </span><span class="si">%s</span><span class="s2">, Fermi level: </span><span class="si">%.3f</span><span class="s2"> (eV)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nelect</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;nsppol: </span><span class="si">%d</span><span class="s2">, nkpt: </span><span class="si">%d</span><span class="s2">, mband: </span><span class="si">%d</span><span class="s2">, nspinor: </span><span class="si">%s</span><span class="s2">, nspden: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mband</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspden</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smearing</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">indent</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;    &quot;</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    &quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_metallic_scheme</span><span class="p">:</span>
            <span class="n">enough_bands</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mband</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt; For spin </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">spin</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">enough_bands</span><span class="p">:</span>
                    <span class="c1"># This can fail so we have to catch the exception.</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Direct gap:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">indent</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">direct_gaps</span><span class="p">[</span><span class="n">spin</span><span class="p">])))</span>
                        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Fundamental gap:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">indent</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fundamental_gaps</span><span class="p">[</span><span class="n">spin</span><span class="p">])))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;WARNING: Cannot compute direct and fundamental gap.&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Exception:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>

                <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Bandwidth: </span><span class="si">%.3f</span><span class="s2"> (eV)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandwidths</span><span class="p">[</span><span class="n">spin</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Valence minimum located at:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">indent</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lomos</span><span class="p">[</span><span class="n">spin</span><span class="p">])))</span>

                <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Valence maximum located at:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">indent</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">homos</span><span class="p">[</span><span class="n">spin</span><span class="p">])))</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Cannot assume enough states for this!</span>
                    <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Conduction minimum located at:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">indent</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lumos</span><span class="p">[</span><span class="n">spin</span><span class="p">])))</span>
                    <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;TIP: Call set_fermie_to_vbm() to set the Fermi level to the VBM if this is a non-magnetic semiconductor</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">with_kpoints</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;K-points&quot;</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.new_with_irred_kpoints"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.new_with_irred_kpoints">[docs]</a>    <span class="k">def</span> <span class="nf">new_with_irred_kpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prune_step</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a new |ElectronBands| object in which only the irreducible k-points are kept.</span>
<span class="sd">        This method is mainly used to prepare the band structure interpolation as the interpolator</span>
<span class="sd">        will likely fail if the input k-path contains symmetrical k-points.</span>

<span class="sd">        Args:</span>
<span class="sd">            prune_step: Optional argument used to select a subset of the irreducible points found.</span>
<span class="sd">            If ``prune_step`` is None, all irreducible k-points are used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the index of the irreducible kpoints.</span>
        <span class="kn">from</span> <span class="nn">abipy.core.kpoints</span> <span class="kn">import</span> <span class="n">find_irred_kpoints_generic</span>
        <span class="n">nmt</span> <span class="o">=</span> <span class="n">find_irred_kpoints_generic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">)</span>
        <span class="n">irred_map</span> <span class="o">=</span> <span class="n">nmt</span><span class="o">.</span><span class="n">irred_map</span>

        <span class="k">if</span> <span class="n">prune_step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">irred_map</span> <span class="o">=</span> <span class="n">irred_map</span><span class="p">[::</span><span class="n">prune_step</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Build new set of k-points</span>
        <span class="n">new_kcoords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">[</span><span class="n">irred_map</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">new_kpoints</span> <span class="o">=</span> <span class="n">KpointList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">,</span> <span class="n">new_kcoords</span><span class="p">,</span>
                                 <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ksampling</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">ksampling</span><span class="p">)</span>

        <span class="c1"># Extract eigevanlues and occupation factors associated to irred k-points.</span>
        <span class="n">new_eigens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[:,</span> <span class="n">irred_map</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">new_occfacts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">occfacts</span><span class="p">[:,</span> <span class="n">irred_map</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">new_kpoints</span><span class="p">,</span> <span class="n">new_eigens</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">,</span> <span class="n">new_occfacts</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspden</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.spacing"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.spacing">[docs]</a>    <span class="k">def</span> <span class="nf">spacing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the statistical parameters of the energy spacing, i.e. e[b+1] - e[b]</span>

<span class="sd">        Returns:</span>
<span class="sd">            ``namedtuple`` with the statistical parameters in eV</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ediff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">mband</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">StatParams</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">ediff</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">),</span> <span class="n">stdev</span><span class="o">=</span><span class="n">ediff</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">),</span>
                          <span class="nb">min</span><span class="o">=</span><span class="n">ediff</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">),</span> <span class="nb">max</span><span class="o">=</span><span class="n">ediff</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">))</span></div>

<div class="viewcode-block" id="ElectronBands.statdiff"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.statdiff">[docs]</a>    <span class="k">def</span> <span class="nf">statdiff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">numpy_op</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compare the eigenenergies of two bands and compute the</span>
<span class="sd">        statistical parameters: mean, standard deviation, min and max</span>
<span class="sd">        The bands are aligned wrt to their fermi level.</span>

<span class="sd">        Args:</span>
<span class="sd">            other: |ElectronBands| object.</span>
<span class="sd">            axis:  Axis along which the statistical parameters are computed.</span>
<span class="sd">                The default is to compute the parameters of the flattened array.</span>
<span class="sd">            numpy_op: Numpy function to apply to the difference of the eigenvalues. The</span>
<span class="sd">                      default computes ``|self.eigens - other.eigens|``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ``namedtuple`` with the statistical parameters in eV</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ediff</span> <span class="o">=</span> <span class="n">numpy_op</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigens</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">eigens</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">fermie</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">StatParams</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">ediff</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">),</span> <span class="n">stdev</span><span class="o">=</span><span class="n">ediff</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">),</span>
                          <span class="nb">min</span><span class="o">=</span><span class="n">ediff</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">),</span> <span class="nb">max</span><span class="o">=</span><span class="n">ediff</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">))</span></div>

<div class="viewcode-block" id="ElectronBands.ipw_edos_widget"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.ipw_edos_widget">[docs]</a>    <span class="k">def</span> <span class="nf">ipw_edos_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an ipython widget with controllers to compute the electron DOS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">plot_dos</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
            <span class="n">edos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_edos</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>
            <span class="n">edos</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

        <span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">ipw</span>
        <span class="k">return</span> <span class="n">ipw</span><span class="o">.</span><span class="n">interact_manual</span><span class="p">(</span>
                <span class="n">plot_dos</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span> <span class="s2">&quot;tetra&quot;</span><span class="p">],</span>
                <span class="n">step</span><span class="o">=</span><span class="n">ipw</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Step of linear mesh (eV)&quot;</span><span class="p">),</span>
                <span class="n">width</span><span class="o">=</span><span class="n">ipw</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Gaussian broadening (eV)&quot;</span><span class="p">),</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.get_edos"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.get_edos">[docs]</a>    <span class="k">def</span> <span class="nf">get_edos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the electronic DOS on a linear mesh.</span>

<span class="sd">        Args:</span>
<span class="sd">            method: String defining the method for the computation of the DOS.</span>
<span class="sd">            step: Energy step (eV) of the linear mesh.</span>
<span class="sd">            width: Standard deviation (eV) of the gaussian.</span>

<span class="sd">        Returns: |ElectronDos| object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">check_weights</span><span class="p">()</span>

        <span class="c1"># Compute linear mesh.</span>
        <span class="n">epad</span> <span class="o">=</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">width</span>
        <span class="n">e_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enemin</span><span class="p">()</span> <span class="o">-</span> <span class="n">epad</span>
        <span class="n">e_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enemax</span><span class="p">()</span> <span class="o">+</span> <span class="n">epad</span>
        <span class="n">nw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">e_max</span> <span class="o">-</span> <span class="n">e_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">step</span><span class="p">)</span>
        <span class="n">mesh</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">e_min</span><span class="p">,</span> <span class="n">e_max</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">nw</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">retstep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># TODO: Write cython version.</span>
        <span class="n">dos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="n">nw</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">kpoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">):</span>
                    <span class="n">weight</span> <span class="o">=</span> <span class="n">kpoint</span><span class="o">.</span><span class="n">weight</span>
                    <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">]):</span>
                        <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">band</span><span class="p">]</span>
                        <span class="n">dos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">gaussian</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Method </span><span class="si">%s</span><span class="s2"> is not supported&quot;</span> <span class="o">%</span> <span class="n">method</span><span class="p">)</span>

        <span class="c1"># Use fermie from Abinit if we are not using metallic scheme for occopt.</span>
        <span class="n">fermie</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#if self.smearing[&quot;occopt&quot;] == 1:</span>
        <span class="c1">#    print(&quot;using fermie from GSR&quot;)</span>
        <span class="c1">#    fermie = self.fermie</span>
        <span class="n">edos</span> <span class="o">=</span> <span class="n">ElectronDos</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">dos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span><span class="p">,</span> <span class="n">fermie</span><span class="o">=</span><span class="n">fermie</span><span class="p">)</span>
        <span class="c1">#print(&quot;ebands.fermie&quot;, self.fermie, &quot;edos.fermie&quot;, edos.fermie)</span>
        <span class="k">return</span> <span class="n">edos</span></div>

<div class="viewcode-block" id="ElectronBands.compare_gauss_edos"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.compare_gauss_edos">[docs]</a>    <span class="k">def</span> <span class="nf">compare_gauss_edos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">widths</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the electronic DOS with the Gaussian method for different values</span>
<span class="sd">        of the broadening. Return plotter object.</span>

<span class="sd">        Args:</span>
<span class="sd">            widths: List with the tandard deviation (eV) of the gaussian.</span>
<span class="sd">            step: Energy step (eV) of the linear mesh.</span>

<span class="sd">        Return: |ElectronDosPlotter|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">edos_plotter</span> <span class="o">=</span> <span class="n">ElectronDosPlotter</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">width</span> <span class="ow">in</span> <span class="n">widths</span><span class="p">:</span>
            <span class="n">edos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_edos</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>
            <span class="n">label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$\sigma = </span><span class="si">%s</span><span class="s2">$ (eV)&quot;</span> <span class="o">%</span> <span class="n">width</span>
            <span class="n">edos_plotter</span><span class="o">.</span><span class="n">add_edos</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">edos</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">edos_plotter</span></div>

<div class="viewcode-block" id="ElectronBands.plot_transitions"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.plot_transitions">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_transitions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">omega_ev</span><span class="p">,</span> <span class="n">qpt</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">atol_ev</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">atol_kdiff</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
                         <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot energy bands with arrows signaling possible k --&gt; k + q indipendent-particle transitions</span>
<span class="sd">        of energy ``omega_ev`` connecting occupied to empty states.</span>

<span class="sd">        Args:</span>
<span class="sd">            omega_ev: Transition energy in eV.</span>
<span class="sd">            qpt: Q-point in reduced coordinates.</span>
<span class="sd">            atol_ev: Absolute tolerance for energy difference in eV</span>
<span class="sd">            atol_kdiff: Tolerance used to compare k-points.</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                or scalar e.g. `left`. If left (right) is None, default values are used</span>
<span class="sd">            alpha: The alpha blending value, between 0 (transparent) and 1 (opaque)</span>
<span class="sd">            ax: |matplotlib-Axes| or None if a new figure should be created.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="s2">&quot;fermie&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="n">e0</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="n">ylims</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Pre-compute mapping k_index --&gt; (k + q)_index, g0</span>
        <span class="n">k2kqg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">get_k2kqg_map</span><span class="p">(</span><span class="n">qpt</span><span class="p">,</span> <span class="n">atol_kdiff</span><span class="o">=</span><span class="n">atol_kdiff</span><span class="p">)</span>

        <span class="c1"># Add arrows to the plot (different colors for spin up/down)</span>
        <span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">FancyArrowPatch</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
            <span class="n">cachek</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">arrow_opts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;k&quot;</span><span class="p">}</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">}</span>
            <span class="n">arrow_opts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-|&gt;&quot;</span><span class="p">,))</span>
            <span class="k">for</span> <span class="n">ik</span><span class="p">,</span> <span class="p">(</span><span class="n">ikq</span><span class="p">,</span> <span class="n">g0</span><span class="p">)</span> <span class="ow">in</span> <span class="n">k2kqg</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">dx</span> <span class="o">=</span> <span class="n">ikq</span> <span class="o">-</span> <span class="n">ik</span>
                <span class="n">ek</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik</span><span class="p">]</span>
                <span class="n">ekq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikq</span><span class="p">]</span>
                <span class="c1"># Find rightmost value less than or equal to fermie.</span>
                <span class="n">nv_k</span> <span class="o">=</span> <span class="n">cachek</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nv_k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">nv_k</span> <span class="o">=</span> <span class="n">find_le</span><span class="p">(</span><span class="n">ek</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_fermie</span><span class="p">)</span>
                    <span class="n">cachek</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span> <span class="o">=</span> <span class="n">nv_k</span>

                <span class="k">if</span> <span class="n">ik</span> <span class="o">==</span> <span class="n">ikq</span><span class="p">:</span>
                    <span class="n">nv_kq</span> <span class="o">=</span> <span class="n">nv_k</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nv_kq</span> <span class="o">=</span> <span class="n">cachek</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ikq</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">nv_kq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">nv_kq</span> <span class="o">=</span> <span class="n">find_le</span><span class="p">(</span><span class="n">ekq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_fermie</span><span class="p">)</span>
                        <span class="n">cachek</span><span class="p">[</span><span class="n">ikq</span><span class="p">]</span> <span class="o">=</span> <span class="n">nv_kq</span>

                <span class="c1">#print(&quot;nv_k:&quot;, nv_k, &quot;nc_kq&quot;, nv_kq)</span>
                <span class="k">for</span> <span class="n">v_k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nv_k</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">c_kq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nv_kq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nband</span><span class="p">):</span>
                        <span class="n">dy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikq</span><span class="p">,</span> <span class="n">c_kq</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">v_k</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dy</span> <span class="o">-</span> <span class="n">omega_ev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">atol_ev</span><span class="p">:</span> <span class="k">continue</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">v_k</span><span class="p">]</span> <span class="o">-</span> <span class="n">e0</span>
                        <span class="c1"># http://matthiaseisen.com/matplotlib/shapes/arrow/</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="n">FancyArrowPatch</span><span class="p">((</span><span class="n">ik</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">ik</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">dy</span><span class="p">),</span>
                                <span class="n">connectionstyle</span><span class="o">=</span><span class="s1">&#39;arc3&#39;</span><span class="p">,</span> <span class="n">mutation_scale</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                                <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="o">**</span><span class="n">arrow_opts</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="ElectronBands.get_ejdos"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.get_ejdos">[docs]</a>    <span class="k">def</span> <span class="nf">get_ejdos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">valence</span><span class="p">,</span> <span class="n">conduction</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the join density of states at q == 0.</span>

<span class="sd">            :math:`\sum_{kbv} f_{vk} (1 - f_{ck}) \delta(\omega - E_{ck} + E_{vk})`</span>

<span class="sd">        .. warning::</span>

<span class="sd">            The present implementation assumes an energy gap</span>

<span class="sd">        Args:</span>
<span class="sd">            spin: Spin index.</span>
<span class="sd">            valence: Int or iterable with the valence indices.</span>
<span class="sd">            conduction: Int or iterable with the conduction indices.</span>
<span class="sd">            method (str): String defining the integraion method.</span>
<span class="sd">            step: Energy step (eV) of the linear mesh.</span>
<span class="sd">            width: Standard deviation (eV) of the gaussian.</span>
<span class="sd">            mesh: Frequency mesh to use. If None, the mesh is computed automatically from the eigenvalues.</span>

<span class="sd">        Returns: |Function1D| object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Generalize to k+q with</span>
        <span class="c1"># k2kqg = self.kpoints.get_k2kqg_map(qpt, atol_kdiff=atol_kdiff)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">check_weights</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">valence</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span> <span class="n">valence</span> <span class="o">=</span> <span class="p">[</span><span class="n">valence</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conduction</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span> <span class="n">conduction</span> <span class="o">=</span> <span class="p">[</span><span class="n">conduction</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">mesh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Compute the linear mesh.</span>
            <span class="n">cmin</span><span class="p">,</span> <span class="n">cmax</span> <span class="o">=</span> <span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conduction</span><span class="p">:</span>
                <span class="n">cmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,:,</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                <span class="n">cmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,:,</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">valence</span><span class="p">:</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,:,</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                <span class="n">vmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">vmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,:,</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

            <span class="n">e_min</span> <span class="o">=</span> <span class="n">cmin</span> <span class="o">-</span> <span class="n">vmax</span>
            <span class="n">e_min</span> <span class="o">-=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">e_min</span><span class="p">)</span>
            <span class="n">e_max</span> <span class="o">=</span> <span class="n">cmax</span> <span class="o">-</span> <span class="n">vmin</span>
            <span class="n">e_max</span> <span class="o">+=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">e_max</span><span class="p">)</span>

            <span class="n">nw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">e_max</span> <span class="o">-</span> <span class="n">e_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">step</span><span class="p">)</span>
            <span class="n">mesh</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">e_min</span><span class="p">,</span> <span class="n">e_max</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">nw</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">retstep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nw</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>

        <span class="n">jdos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nw</span><span class="p">)</span>

        <span class="c1"># Normalize the occupation factors.</span>
        <span class="n">full</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="mf">1.0</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">kpoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">):</span>
                <span class="n">weight</span> <span class="o">=</span> <span class="n">kpoint</span><span class="o">.</span><span class="n">weight</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conduction</span><span class="p">:</span>
                    <span class="n">ec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span>
                    <span class="n">fc</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">occfacts</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">c</span><span class="p">]</span> <span class="o">/</span> <span class="n">full</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">valence</span><span class="p">:</span>
                        <span class="n">ev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span>
                        <span class="n">fv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">occfacts</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span> <span class="o">/</span> <span class="n">full</span>
                        <span class="n">fact</span> <span class="o">=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">fv</span> <span class="o">*</span> <span class="n">fc</span>
                        <span class="n">jdos</span> <span class="o">+=</span> <span class="n">fact</span> <span class="o">*</span> <span class="n">gaussian</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">ec</span><span class="o">-</span><span class="n">ev</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Method </span><span class="si">%s</span><span class="s2"> is not supported&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">Function1D</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">jdos</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.plot_ejdosvc"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.plot_ejdosvc">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_ejdosvc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vrange</span><span class="p">,</span> <span class="n">crange</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">,</span>
                     <span class="n">cumulative</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the decomposition of the joint-density of States (JDOS).</span>

<span class="sd">        .. warning::</span>

<span class="sd">            The present implementation assumes an energy gap</span>

<span class="sd">        Args:</span>
<span class="sd">            vrange: Int or `Iterable` with the indices of the valence bands to consider.</span>
<span class="sd">            crange: Int or `Iterable` with the indices of the conduction bands to consider.</span>
<span class="sd">            method: String defining the method.</span>
<span class="sd">            step: Energy step (eV) of the linear mesh.</span>
<span class="sd">            width: Standard deviation (eV) of the gaussian.</span>
<span class="sd">            colormap: Have a look at the colormaps here and decide which one you like:</span>
<span class="sd">                http://matplotlib.sourceforge.net/examples/pylab_examples/show_colormaps.html</span>
<span class="sd">            cumulative: True for cumulative plots (default).</span>
<span class="sd">            ax: |matplotlib-Axes| or None if a new figure should be created.</span>
<span class="sd">            alpha: The alpha blending value, between 0 (transparent) and 1 (opaque)</span>
<span class="sd">            fontsize: fontsize for legends and titles</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">crange</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span> <span class="n">crange</span> <span class="o">=</span> <span class="p">[</span><span class="n">crange</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vrange</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span> <span class="n">vrange</span> <span class="o">=</span> <span class="p">[</span><span class="n">vrange</span><span class="p">]</span>

        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Energy (eV)&#39;</span><span class="p">)</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>
        <span class="n">lw</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;lw&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
            <span class="n">spin_sign</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span> <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>

            <span class="c1"># Get total JDOS for this spin</span>
            <span class="n">tot_jdos</span> <span class="o">=</span> <span class="n">spin_sign</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ejdos</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">vrange</span><span class="p">,</span> <span class="n">crange</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>

            <span class="c1"># Decomposition in terms of v --&gt; c transitions.</span>
            <span class="n">jdos_vc</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vrange</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">crange</span><span class="p">:</span>
                    <span class="n">jd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ejdos</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="n">tot_jdos</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
                    <span class="n">jdos_vc</span><span class="p">[(</span><span class="n">v</span><span class="p">,</span> <span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="n">spin_sign</span> <span class="o">*</span> <span class="n">jd</span>

            <span class="c1"># Plot data for this spin.</span>
            <span class="k">if</span> <span class="n">cumulative</span><span class="p">:</span>
                <span class="n">cumulative</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tot_jdos</span><span class="p">))</span>
                <span class="n">num_plots</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">jdos_vc</span><span class="p">),</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">jdos</span> <span class="ow">in</span> <span class="n">jdos_vc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$v=</span><span class="si">%s</span><span class="s2"> \rightarrow c=</span><span class="si">%s</span><span class="s2">, \sigma=</span><span class="si">%s</span><span class="s2">$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_plots</span><span class="p">)</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">jdos</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">jdos</span><span class="o">.</span><span class="n">values</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cumulative</span> <span class="o">+</span> <span class="n">y</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cumulative</span><span class="p">,</span> <span class="n">cumulative</span> <span class="o">+</span> <span class="n">y</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
                    <span class="n">cumulative</span> <span class="o">+=</span> <span class="n">jdos</span><span class="o">.</span><span class="n">values</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">num_plots</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">jdos_vc</span><span class="p">),</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">jdos</span> <span class="ow">in</span> <span class="n">jdos_vc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_plots</span><span class="p">)</span>
                    <span class="n">jdos</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$v=</span><span class="si">%s</span><span class="s2"> \rightarrow c=</span><span class="si">%s</span><span class="s2">, \sigma=</span><span class="si">%s</span><span class="s2">$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">tot_jdos</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;Total JDOS, $\sigma=</span><span class="si">%s</span><span class="s2">$&quot;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="ElectronBands.apply_scissors"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.apply_scissors">[docs]</a>    <span class="k">def</span> <span class="nf">apply_scissors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scissors</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Modify the band structure with the scissors operator.</span>

<span class="sd">        Args:</span>
<span class="sd">            scissors: An instance of :class:`Scissors`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            New instance of |ElectronBands| with modified energies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scissors</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="n">scissors</span> <span class="o">=</span> <span class="p">[</span><span class="n">scissors</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">scissors</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expecting two scissors operators for spin up and down&quot;</span><span class="p">)</span>

        <span class="c1"># Create new array with same shape as self.</span>
        <span class="n">qp_energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Calculate quasi-particle energies with the scissors operator.</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
            <span class="n">sciss</span> <span class="o">=</span> <span class="n">scissors</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kidxs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">]):</span>
                    <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">band</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">qp_ene</span> <span class="o">=</span> <span class="n">e0</span> <span class="o">+</span> <span class="n">sciss</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">sciss</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
                        <span class="k">raise</span>

                    <span class="c1"># Update the energy.</span>
                    <span class="n">qp_energies</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="n">qp_ene</span>

        <span class="c1"># Apply the scissors to the Fermi level as well.</span>
        <span class="c1"># NB: This should be ok for semiconductors in which fermie == CBM (abinit convention)</span>
        <span class="c1"># and there&#39;s usually one CBM state whose QP correction is expected to be reproduced</span>
        <span class="c1"># almost exactly by the polyfit.</span>
        <span class="c1"># Not sure about metals. Besides occupations are not changed here!</span>
        <span class="n">fermie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span> <span class="o">+</span> <span class="n">scissors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">)</span>
        <span class="c1">#fermie = self.fermie</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;KS fermie&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">,</span> <span class="s2">&quot;--&gt; QP fermie&quot;</span><span class="p">,</span> <span class="n">fermie</span><span class="p">,</span> <span class="s2">&quot;Delta(QP-KS)=&quot;</span><span class="p">,</span> <span class="n">fermie</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">,</span> <span class="n">qp_energies</span><span class="p">,</span> <span class="n">fermie</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">occfacts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspden</span><span class="p">,</span>
            <span class="n">nband_sk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nband_sk</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smearing</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.plot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.plot">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">band_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">klabels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_gaps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_phfreq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the electronic band structure with matplotlib.</span>

<span class="sd">        Args:</span>
<span class="sd">            spin: Spin index. None to plot both spins.</span>
<span class="sd">            band_range: Tuple specifying the minimum and maximum band to plot (default: all bands are plotted)</span>
<span class="sd">            klabels: dictionary whose keys are tuple with the reduced</span>
<span class="sd">                coordinates of the k-points. The values are the labels. e.g.</span>
<span class="sd">                ``klabels = {(0.0,0.0,0.0): &quot;$\Gamma$&quot;, (0.5,0,0):&quot;L&quot;}``.</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - ``fermie``: shift all eigenvalues to have zero energy at the Fermi energy (``self.fermie``).</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">            ax: |matplotlib-Axes| or None if a new figure should be created.</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                   or scalar e.g. ``left``. If left (right) is None, default values are used</span>
<span class="sd">            points: Marker object with the position and the size of the marker.</span>
<span class="sd">                Used for plotting purpose e.g. QP energies, energy derivatives...</span>
<span class="sd">            with_gaps: True to add markers and arrows showing the fundamental and the direct gap.</span>
<span class="sd">                IMPORTANT: If the gaps are now showed correctly in a non-magnetic semiconductor,</span>
<span class="sd">                    call `ebands.set_fermie_to_vbm()` to align the Fermi level at the top of the valence</span>
<span class="sd">                    bands before executing `ebands.plot().</span>
<span class="sd">                    The Fermi energy stored in the object, indeed, comes from the GS calculation</span>
<span class="sd">                    that produced the DEN file. If the k-mesh used for the GS and the CBM is e.g. at Gamma,</span>
<span class="sd">                    the Fermi energy will be underestimated and a manual aligment is needed.</span>
<span class="sd">            max_phfreq: Max phonon frequency in eV to activate scatterplot showing</span>
<span class="sd">                possible phonon absorption/emission processes based on energy-conservation alone.</span>
<span class="sd">                All final states whose energy is within +- max_phfreq of the initial state are included.</span>
<span class="sd">                By default, the four electronic states defining the fundamental and the direct gaps</span>
<span class="sd">                are considered as initial state (not available for metals).</span>
<span class="sd">            fontsize: fontsize for legends and titles</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Select spins</span>
        <span class="n">spin_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span> <span class="k">if</span> <span class="n">spin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">spin</span><span class="p">]</span>

        <span class="c1"># Select the band range.</span>
        <span class="k">if</span> <span class="n">band_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">band_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mband</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">band_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">band_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">band_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="c1"># Decorate the axis (e.g add ticks and labels).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decorate_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">klabels</span><span class="o">=</span><span class="n">klabels</span><span class="p">)</span>
        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="c1"># Plot the band energies.</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="n">spin_list</span><span class="p">:</span>
            <span class="n">opts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">}</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> \
                   <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">}</span>
            <span class="c1"># This to pass kwargs to plot_ax and avoid both lw and linewidth in opts</span>
            <span class="k">if</span> <span class="s2">&quot;lw&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;linewidth&quot;</span><span class="p">)</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">ib</span><span class="p">,</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">band_list</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ib</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="n">e0</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">s</span><span class="p">),</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">with_gaps</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mband</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span> <span class="o">//</span> <span class="mi">2</span><span class="p">):</span>
            <span class="c1"># Show fundamental and direct gaps for each spin.</span>
            <span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">FancyArrowPatch</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
                <span class="n">f_gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fundamental_gaps</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span>
                <span class="n">d_gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">direct_gaps</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span>
                <span class="c1"># Need arrows only if fundamental and direct gaps for this spin are different.</span>
                <span class="n">need_arrows</span> <span class="o">=</span> <span class="n">f_gap</span> <span class="o">!=</span> <span class="n">d_gap</span>

                <span class="n">arrow_opts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;k&quot;</span><span class="p">}</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">}</span>
                <span class="n">arrow_opts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">,</span> <span class="n">connectionstyle</span><span class="o">=</span><span class="s1">&#39;arc3&#39;</span><span class="p">,</span>
                                  <span class="n">mutation_scale</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
                <span class="n">scatter_opts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">}</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;green&quot;</span><span class="p">}</span>
                <span class="n">scatter_opts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

                <span class="c1"># Fundamental gap.</span>
                <span class="n">mgap</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">for</span> <span class="n">ik1</span><span class="p">,</span> <span class="n">ik2</span> <span class="ow">in</span> <span class="n">f_gap</span><span class="o">.</span><span class="n">all_kinds</span><span class="p">:</span>
                    <span class="n">posA</span> <span class="o">=</span> <span class="p">(</span><span class="n">ik1</span><span class="p">,</span> <span class="n">f_gap</span><span class="o">.</span><span class="n">in_state</span><span class="o">.</span><span class="n">eig</span> <span class="o">-</span> <span class="n">e0</span><span class="p">)</span>
                    <span class="n">posB</span> <span class="o">=</span> <span class="p">(</span><span class="n">ik2</span><span class="p">,</span> <span class="n">f_gap</span><span class="o">.</span><span class="n">out_state</span><span class="o">.</span><span class="n">eig</span> <span class="o">-</span> <span class="n">e0</span><span class="p">)</span>
                    <span class="n">mgap</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">mgap</span><span class="p">,</span> <span class="n">posA</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">posB</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">posA</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">posA</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="n">scatter_opts</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">posB</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">posB</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="n">scatter_opts</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">need_arrows</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">FancyArrowPatch</span><span class="p">(</span><span class="n">posA</span><span class="o">=</span><span class="n">posA</span><span class="p">,</span> <span class="n">posB</span><span class="o">=</span><span class="n">posB</span><span class="p">,</span> <span class="o">**</span><span class="n">arrow_opts</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">d_gap</span> <span class="o">!=</span> <span class="n">f_gap</span><span class="p">:</span>
                    <span class="c1"># Direct gap.</span>
                    <span class="k">for</span> <span class="n">ik1</span><span class="p">,</span> <span class="n">ik2</span> <span class="ow">in</span> <span class="n">d_gap</span><span class="o">.</span><span class="n">all_kinds</span><span class="p">:</span>
                        <span class="n">posA</span> <span class="o">=</span> <span class="p">(</span><span class="n">ik1</span><span class="p">,</span> <span class="n">d_gap</span><span class="o">.</span><span class="n">in_state</span><span class="o">.</span><span class="n">eig</span> <span class="o">-</span> <span class="n">e0</span><span class="p">)</span>
                        <span class="n">posB</span> <span class="o">=</span> <span class="p">(</span><span class="n">ik2</span><span class="p">,</span> <span class="n">d_gap</span><span class="o">.</span><span class="n">out_state</span><span class="o">.</span><span class="n">eig</span> <span class="o">-</span> <span class="n">e0</span><span class="p">)</span>
                        <span class="n">mgap</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">mgap</span><span class="p">,</span> <span class="n">posA</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">posB</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">posA</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">posA</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="n">scatter_opts</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">posB</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">posB</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="n">scatter_opts</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">need_arrows</span><span class="p">:</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">FancyArrowPatch</span><span class="p">(</span><span class="n">posA</span><span class="o">=</span><span class="n">posA</span><span class="p">,</span> <span class="n">posB</span><span class="o">=</span><span class="n">posB</span><span class="p">,</span> <span class="o">**</span><span class="n">arrow_opts</span><span class="p">))</span>

            <span class="c1"># Try to set nice limits if not given by user.</span>
            <span class="k">if</span> <span class="n">ylims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="n">mgap</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="o">+</span><span class="n">mgap</span> <span class="o">+</span> <span class="mi">5</span><span class="p">),</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

            <span class="n">gaps_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_gaps_string</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">gaps_string</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">gaps_string</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">max_phfreq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mband</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span> <span class="o">//</span> <span class="mi">2</span><span class="p">):</span>
            <span class="c1"># Add markers showing phonon absorption/emission processes.</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
                <span class="c1">#scatter_opts = {&quot;color&quot;: &quot;steelblue&quot;} if spin == 0 else {&quot;color&quot;: &quot;teal&quot;}</span>
                <span class="n">scatter_opts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                <span class="n">items</span> <span class="o">=</span> <span class="p">([</span><span class="s2">&quot;fundamental_gaps&quot;</span><span class="p">,</span> <span class="s2">&quot;direct_gaps&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;in_state&quot;</span><span class="p">,</span> <span class="s2">&quot;out_state&quot;</span><span class="p">])</span>
                <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">items</span><span class="p">)))</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">gap_name</span><span class="p">,</span> <span class="n">state_name</span><span class="p">)</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                    <span class="c1"># Use getattr to extract gaps, equivalent to:</span>
                    <span class="c1">#   gap = self.fundamental_gaps[spin]</span>
                    <span class="c1">#   e_start = gap.out_state.eig</span>
                    <span class="n">gap</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gap_name</span><span class="p">)[</span><span class="n">spin</span><span class="p">]</span>
                    <span class="n">e_start</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">gap</span><span class="p">,</span> <span class="n">state_name</span><span class="p">)</span><span class="o">.</span><span class="n">eig</span>
                    <span class="n">scatter_opts</span><span class="p">[</span><span class="s2">&quot;marker&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;o&quot;</span>
                    <span class="n">scatter_opts</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;cool&quot;</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;summer&quot;</span><span class="p">)(</span><span class="n">i</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>

                    <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mband</span><span class="p">):</span>
                        <span class="n">eks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="p">:,</span> <span class="n">band</span><span class="p">]</span>
                        <span class="n">where</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">e_start</span> <span class="o">-</span> <span class="n">eks</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_phfreq</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">where</span><span class="p">):</span> <span class="k">continue</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">eks</span><span class="p">[</span><span class="n">where</span><span class="p">]</span> <span class="o">-</span> <span class="n">e0</span><span class="p">,</span> <span class="o">**</span><span class="n">scatter_opts</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="ElectronBands.plotly"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.plotly">[docs]</a>    <span class="nd">@add_plotly_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plotly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">band_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">klabels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rcd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_gaps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_phfreq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the electronic band structure with plotly.</span>

<span class="sd">        Args:</span>
<span class="sd">            spin: Spin index. None to plot both spins.</span>
<span class="sd">            band_range: Tuple specifying the minimum and maximum band to plot (default: all bands are plotted)</span>
<span class="sd">            klabels: dictionary whose keys are tuple with the reduced</span>
<span class="sd">                coordinates of the k-points. The values are the labels. e.g.</span>
<span class="sd">                ``klabels = {(0.0,0.0,0.0): &quot;$\Gamma$&quot;, (0.5,0,0):&quot;L&quot;}``.</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - ``fermie``: shift all eigenvalues to have zero energy at the Fermi energy (``self.fermie``).</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">            fig: plotly figure or None if a new figure should be created.</span>
<span class="sd">            rcd: PlotlyRowColDesc object used when fig is not None to specify the (row, col) of the subplot in the grid.</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">            points: Marker object with the position and the size of the marker.</span>
<span class="sd">                Used for plotting purpose e.g. QP energies, energy derivatives.</span>
<span class="sd">            with_gaps: True to add markers and arrows showing the fundamental and the direct gap.</span>
<span class="sd">                IMPORTANT: If the gaps are now showed correctly in a non-magnetic semiconductor,</span>
<span class="sd">                call `ebands.set_fermie_to_vbm()` to align the Fermi level at the top of the valence</span>
<span class="sd">                bands before executing `ebands.plot().</span>
<span class="sd">                The Fermi energy stored in the object, indeed, comes from the GS calculation</span>
<span class="sd">                that produced the DEN file. If the k-mesh used for the GS and the CBM is e.g. at Gamma,</span>
<span class="sd">                the Fermi energy will be underestimated and a manual aligment is needed.</span>
<span class="sd">            max_phfreq: Max phonon frequency in eV to activate scatterplot showing</span>
<span class="sd">                possible phonon absorption/emission processes based on energy-conservation alone.</span>
<span class="sd">                All final states whose energy is within +- max_phfreq of the initial state are included.</span>
<span class="sd">                By default, the four electronic states defining the fundamental and the direct gaps</span>
<span class="sd">                are considered as initial state (not available for metals).</span>
<span class="sd">            fontsize: fontsize for legends and titles</span>
<span class="sd">            kwargs: Passed to fig.add_scatter method.</span>

<span class="sd">        Returns: |plotly.graph_objects.Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Select spins</span>
        <span class="n">spin_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span> <span class="k">if</span> <span class="n">spin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">spin</span><span class="p">]</span>

        <span class="c1"># Select the band range.</span>
        <span class="k">if</span> <span class="n">band_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">band_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mband</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">band_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">band_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">band_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_fig_plotly</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>
        <span class="n">rcd</span> <span class="o">=</span> <span class="n">PlotlyRowColDesc</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">rcd</span><span class="p">)</span>
        <span class="n">ply_row</span><span class="p">,</span> <span class="n">ply_col</span> <span class="o">=</span> <span class="n">rcd</span><span class="o">.</span><span class="n">ply_row</span><span class="p">,</span> <span class="n">rcd</span><span class="o">.</span><span class="n">ply_col</span>

        <span class="c1"># Decorate the axis (e.g add ticks and labels).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decorate_plotly</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">klabels</span><span class="o">=</span><span class="n">klabels</span><span class="p">,</span> <span class="n">iax</span><span class="o">=</span><span class="n">rcd</span><span class="o">.</span><span class="n">iax</span><span class="p">)</span>
        <span class="n">plotly_set_lims</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="c1"># Plot the band energies.</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="n">spin_list</span><span class="p">:</span>
            <span class="n">lw</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;lw&quot;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
            <span class="n">line_opts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">lw</span><span class="p">}</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">lw</span><span class="p">}</span>

            <span class="k">for</span> <span class="n">ib</span><span class="p">,</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">band_list</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ib</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plotly_traces</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">rcd</span><span class="o">=</span><span class="n">rcd</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">,</span> <span class="n">line_opts</span><span class="o">=</span><span class="n">line_opts</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">points</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="n">e0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="n">ply_row</span><span class="p">,</span>
                            <span class="n">col</span><span class="o">=</span><span class="n">ply_col</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">s</span><span class="p">),</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">with_gaps</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mband</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span> <span class="o">//</span> <span class="mi">2</span><span class="p">):</span>
            <span class="c1"># Show fundamental and direct gaps for each spin.</span>
            <span class="kn">from</span> <span class="nn">plotly.figure_factory</span> <span class="kn">import</span> <span class="n">create_quiver</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
                <span class="n">f_gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fundamental_gaps</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span>
                <span class="n">d_gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">direct_gaps</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span>
                <span class="c1"># Need arrows only if fundamental and direct gaps for this spin are different.</span>
                <span class="n">need_arrows</span> <span class="o">=</span> <span class="n">f_gap</span> <span class="o">!=</span> <span class="n">d_gap</span>

                <span class="n">arrow_opts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;gray&quot;</span><span class="p">}</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;orange&quot;</span><span class="p">}</span>
                <span class="n">scatter_opts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">}</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;green&quot;</span><span class="p">}</span>
                <span class="n">scatter_opts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">opacity</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

                <span class="c1"># Fundamental gap.</span>
                <span class="n">mgap</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">for</span> <span class="n">ik1</span><span class="p">,</span> <span class="n">ik2</span> <span class="ow">in</span> <span class="n">f_gap</span><span class="o">.</span><span class="n">all_kinds</span><span class="p">:</span>
                    <span class="n">posA</span> <span class="o">=</span> <span class="p">(</span><span class="n">ik1</span><span class="p">,</span> <span class="n">f_gap</span><span class="o">.</span><span class="n">in_state</span><span class="o">.</span><span class="n">eig</span> <span class="o">-</span> <span class="n">e0</span><span class="p">)</span>
                    <span class="n">posB</span> <span class="o">=</span> <span class="p">(</span><span class="n">ik2</span><span class="p">,</span> <span class="n">f_gap</span><span class="o">.</span><span class="n">out_state</span><span class="o">.</span><span class="n">eig</span> <span class="o">-</span> <span class="n">e0</span><span class="p">)</span>
                    <span class="n">mgap</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">mgap</span><span class="p">,</span> <span class="n">posA</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">posB</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">posA</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">posB</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">posA</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">posB</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                    <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">scatter_opts</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="n">ply_row</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">ply_col</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">need_arrows</span><span class="p">:</span>
                        <span class="n">figcq</span> <span class="o">=</span> <span class="n">create_quiver</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">posA</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">posA</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">u</span><span class="o">=</span><span class="p">[</span><span class="n">posB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">posA</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">v</span><span class="o">=</span><span class="p">[</span><span class="n">posB</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">posA</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                                              <span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">arrow_scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hoverinfo</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                                              <span class="n">marker</span><span class="o">=</span><span class="n">arrow_opts</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">figcq</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="o">=</span><span class="n">ply_row</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">ply_col</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">d_gap</span> <span class="o">!=</span> <span class="n">f_gap</span><span class="p">:</span>
                    <span class="c1"># Direct gap.</span>
                    <span class="k">for</span> <span class="n">ik1</span><span class="p">,</span> <span class="n">ik2</span> <span class="ow">in</span> <span class="n">d_gap</span><span class="o">.</span><span class="n">all_kinds</span><span class="p">:</span>
                        <span class="n">posA</span> <span class="o">=</span> <span class="p">(</span><span class="n">ik1</span><span class="p">,</span> <span class="n">d_gap</span><span class="o">.</span><span class="n">in_state</span><span class="o">.</span><span class="n">eig</span> <span class="o">-</span> <span class="n">e0</span><span class="p">)</span>
                        <span class="n">posB</span> <span class="o">=</span> <span class="p">(</span><span class="n">ik2</span><span class="p">,</span> <span class="n">d_gap</span><span class="o">.</span><span class="n">out_state</span><span class="o">.</span><span class="n">eig</span> <span class="o">-</span> <span class="n">e0</span><span class="p">)</span>
                        <span class="n">mgap</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">mgap</span><span class="p">,</span> <span class="n">posA</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">posB</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">posA</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">posB</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">posA</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">posB</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                                 <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">scatter_opts</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="n">ply_row</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">ply_col</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">need_arrows</span><span class="p">:</span>
                            <span class="n">figcq</span> <span class="o">=</span> <span class="n">create_quiver</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">posA</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">posA</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">u</span><span class="o">=</span><span class="p">[</span><span class="n">posB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">posA</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">v</span><span class="o">=</span><span class="p">[</span><span class="n">posB</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">posA</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                                                  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">arrow_scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hoverinfo</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                                                  <span class="n">marker</span><span class="o">=</span><span class="n">arrow_opts</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
                            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">figcq</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="o">=</span><span class="n">ply_row</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">ply_col</span><span class="p">)</span>

            <span class="c1"># Try to set nice limits if not given by user.</span>
            <span class="k">if</span> <span class="n">ylims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plotly_set_lims</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="n">mgap</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="o">+</span><span class="n">mgap</span> <span class="o">+</span> <span class="mi">5</span><span class="p">),</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

            <span class="n">gaps_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_gaps_string</span><span class="p">(</span><span class="n">with_latex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unicode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">gaps_string</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">annotations</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">gaps_string</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">xref</span><span class="o">=</span><span class="s1">&#39;paper&#39;</span><span class="p">,</span>
                                               <span class="n">xanchor</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">yref</span><span class="o">=</span><span class="s1">&#39;paper&#39;</span><span class="p">,</span> <span class="n">yanchor</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">showarrow</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">max_phfreq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mband</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span> <span class="o">//</span> <span class="mi">2</span><span class="p">):</span>
            <span class="c1"># Add markers showing phonon absorption/emission processes.</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
                <span class="c1">#scatter_opts = {&quot;color&quot;: &quot;steelblue&quot;} if spin == 0 else {&quot;color&quot;: &quot;teal&quot;}</span>
                <span class="n">scatter_opts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">opacity</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
                <span class="n">items</span> <span class="o">=</span> <span class="p">([</span><span class="s2">&quot;fundamental_gaps&quot;</span><span class="p">,</span> <span class="s2">&quot;direct_gaps&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;in_state&quot;</span><span class="p">,</span> <span class="s2">&quot;out_state&quot;</span><span class="p">])</span>
                <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">items</span><span class="p">)))</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">gap_name</span><span class="p">,</span> <span class="n">state_name</span><span class="p">)</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                    <span class="c1"># Use getattr to extract gaps, equivalent to:</span>
                    <span class="c1">#   gap = self.fundamental_gaps[spin]</span>
                    <span class="c1">#   e_start = gap.out_state.eig</span>
                    <span class="n">gap</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gap_name</span><span class="p">)[</span><span class="n">spin</span><span class="p">]</span>
                    <span class="n">e_start</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">gap</span><span class="p">,</span> <span class="n">state_name</span><span class="p">)</span><span class="o">.</span><span class="n">eig</span>
                    <span class="n">scatter_opts</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
                    <span class="n">scatter_opts</span><span class="p">[</span><span class="s2">&quot;colorscale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;dense&quot;</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;Burgyl&quot;</span>

                    <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mband</span><span class="p">):</span>
                        <span class="n">eks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="p">:,</span> <span class="n">band</span><span class="p">]</span>
                        <span class="n">where</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">e_start</span> <span class="o">-</span> <span class="n">eks</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_phfreq</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">where</span><span class="p">):</span> <span class="k">continue</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">where</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">eks</span><span class="p">[</span><span class="n">where</span><span class="p">]</span> <span class="o">-</span> <span class="n">e0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
                                        <span class="n">marker</span><span class="o">=</span><span class="n">scatter_opts</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="n">ply_row</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">ply_col</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="ElectronBands.plot_scatter3d"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.plot_scatter3d">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_scatter3d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use matplotlib ``scatter3D`` to produce a scatter plot of the eigenvalues in 3D.</span>
<span class="sd">        The color of the points gives the energy of the state wrt to the Fermi level.</span>

<span class="sd">        Args:</span>
<span class="sd">            band: Band index</span>
<span class="sd">            spin: Spin index.</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - ``fermie``: shift all eigenvalues to have zero energy at the Fermi energy (``self.fermie``).</span>
<span class="sd">                -  Number e.g ``e0 = 0.5``: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to ``e0 = 0``.</span>
<span class="sd">            colormap: Have a look at the colormaps here and decide which one you like:</span>
<span class="sd">                &lt;http://matplotlib.sourceforge.net/examples/pylab_examples/show_colormaps.html&gt;</span>
<span class="sd">            ax: matplotlib :class:`Axes3D` or None if a new figure should be created.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kcart_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">get_cart_coords</span><span class="p">()</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="p">:,</span> <span class="n">band</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax3d_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>
        <span class="c1">#ax.scatter3D(xs, ys, zs, s=6, alpha=0.8, marker=&#39;,&#39;, facecolors=cmap(N), lw=0)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter3D</span><span class="p">(</span><span class="n">kcart_coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">kcart_coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">zs</span><span class="o">=</span><span class="n">kcart_coords</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">zdir</span><span class="o">=</span><span class="s1">&#39;z&#39;</span><span class="p">,</span>
                         <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">depthshade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>

        <span class="c1">#self.structure.plot_bz(ax=ax, pmg_path=False, with_labels=False, show=False, linewidth=0)</span>
        <span class="kn">from</span> <span class="nn">pymatgen.electronic_structure.plotter</span> <span class="kn">import</span> <span class="n">plot_wigner_seitz</span>
        <span class="n">plot_wigner_seitz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$K_x$&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$K_y$&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s2">&quot;$K_z$&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c1">#ax.set_title(structure.composition.formula)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="ElectronBands.decorate_ax"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.decorate_ax">[docs]</a>    <span class="k">def</span> <span class="nf">decorate_ax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add k-labels, title and unit name to axis ax.</span>

<span class="sd">        Args:</span>
<span class="sd">            title:</span>
<span class="sd">            fontsize</span>
<span class="sd">            klabels:</span>
<span class="sd">            klabel_size:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">fontsize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;fontsize&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Energy (eV)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Wave Vector&quot;</span><span class="p">)</span>

        <span class="c1"># Set ticks and labels.</span>
        <span class="n">klabels</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;klabels&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ticks</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_ticks_and_labels</span><span class="p">(</span><span class="n">klabels</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ticks</span><span class="p">:</span>
            <span class="c1"># Don&#39;t show label if previous k-point is the same.</span>
            <span class="k">for</span> <span class="n">il</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">labels</span><span class="p">[</span><span class="n">il</span><span class="p">]</span> <span class="o">==</span> <span class="n">labels</span><span class="p">[</span><span class="n">il</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="n">labels</span><span class="p">[</span><span class="n">il</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="c1">#print(&quot;ticks&quot;, ticks, &quot;\nlabels&quot;, labels)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;klabel_size&quot;</span><span class="p">,</span> <span class="s2">&quot;large&quot;</span><span class="p">))</span>
            <span class="c1">#print(&quot;ticks&quot;, len(ticks), ticks)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">ticks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ticks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="ElectronBands.decorate_plotly"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.decorate_plotly">[docs]</a>    <span class="k">def</span> <span class="nf">decorate_plotly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add q-labels and unit name to figure ``fig``.</span>
<span class="sd">        Use units=&quot;&quot; to add k-labels without unit name.</span>
<span class="sd">        Args:</span>
<span class="sd">            klabels:</span>
<span class="sd">            klabel_size:</span>
<span class="sd">            iax: An int, use iax=n to decorate the nth axis when the fig has subplots.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">iax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;iax&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">xaxis</span> <span class="o">=</span> <span class="s1">&#39;xaxis</span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">iax</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="n">xaxis</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Wave Vector&quot;</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;yaxis</span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">iax</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Energy (eV)&quot;</span>

        <span class="c1"># Set ticks and labels.</span>
        <span class="n">klabels</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;klabels&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ticks</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_ticks_and_labels</span><span class="p">(</span><span class="n">klabels</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ticks</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">plotly_klabels</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="n">xaxis</span><span class="p">]</span><span class="o">.</span><span class="n">tickvals</span> <span class="o">=</span> <span class="n">ticks</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="n">xaxis</span><span class="p">]</span><span class="o">.</span><span class="n">ticktext</span> <span class="o">=</span> <span class="n">labels</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="n">xaxis</span><span class="p">]</span><span class="o">.</span><span class="n">tickfont</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;klabel_size&quot;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="n">xaxis</span><span class="p">]</span><span class="o">.</span><span class="n">range</span> <span class="o">=</span> <span class="p">(</span><span class="n">ticks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ticks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="ElectronBands.get_e0"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.get_e0">[docs]</a>    <span class="k">def</span> <span class="nf">get_e0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - ``fermie``: shift all eigenvalues to have zero energy at the Fermi energy (``self.fermie``).</span>
<span class="sd">                -  Number e.g ``e0 = 0.5``: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to ``e0 = 0``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">e0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="k">elif</span> <span class="n">is_string</span><span class="p">(</span><span class="n">e0</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">e0</span> <span class="o">==</span> <span class="s2">&quot;fermie&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span>
            <span class="k">elif</span> <span class="n">e0</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">0.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wrong value for e0: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Assume number</span>
            <span class="k">return</span> <span class="n">e0</span></div>

<div class="viewcode-block" id="ElectronBands.plot_ax"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.plot_ax">[docs]</a>    <span class="k">def</span> <span class="nf">plot_ax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to plot the energies for (spin, band) on the axis ax with matplotlib..</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: |matplotlib-Axes|.</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot.</span>
<span class="sd">            spin: Spin index. If None, all spins are plotted.</span>
<span class="sd">            band: Band index, If None, all bands are plotted.</span>
<span class="sd">            kwargs: Passed to ax.plot</span>

<span class="sd">        Return: matplotlib lines</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spin_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">)</span> <span class="k">if</span> <span class="n">spin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">spin</span><span class="p">]</span>
        <span class="n">band_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mband</span><span class="p">)</span> <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">band</span><span class="p">]</span>

        <span class="n">label</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># Handle linewidths</span>
        <span class="n">with_linewidths</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;with_linewidths&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_linewidths</span>
        <span class="k">if</span> <span class="n">with_linewidths</span><span class="p">:</span>
            <span class="n">lw_opts</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;lw_opts&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">))</span>
            <span class="n">lw_fact</span> <span class="o">=</span> <span class="n">lw_opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;fact&quot;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>

        <span class="n">xx</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">),</span> <span class="p">[]</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="n">spin_range</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">band_range</span><span class="p">:</span>
                <span class="n">yy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="p">:,</span> <span class="n">band</span><span class="p">]</span> <span class="o">-</span> <span class="n">e0</span>

                <span class="c1"># Set label only at the first iteration</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
                <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">with_linewidths</span><span class="p">:</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linewidths</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="p">:,</span> <span class="n">band</span><span class="p">]</span> <span class="o">*</span> <span class="n">lw_fact</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="n">lw_color</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">()</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">-</span> <span class="n">w</span><span class="p">,</span> <span class="n">yy</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">lw_color</span><span class="p">,</span> <span class="o">**</span><span class="n">lw_opts</span><span class="p">)</span>
                    <span class="c1">#, alpha=self.alpha, facecolor=self.l2color[l])</span>

        <span class="k">return</span> <span class="n">lines</span></div>

<div class="viewcode-block" id="ElectronBands.plotly_traces"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.plotly_traces">[docs]</a>    <span class="k">def</span> <span class="nf">plotly_traces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">rcd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">line_opts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to plot the energies for (spin, band) on figure ``fig``.</span>

<span class="sd">        Args:</span>
<span class="sd">            fig: |plotly.graph_objects.Figure|.</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot.</span>
<span class="sd">            rcd: PlotlyRowColDesc object used when fig is not None to specify the (row, col) of the subplot in the grid.</span>
<span class="sd">            spin: Spin index. If None, all spins are plotted.</span>
<span class="sd">            band: Band index, If None, all bands are plotted.</span>
<span class="sd">            showlegend: Determines whether or not an item corresponding to this trace is shown in the legend.</span>
<span class="sd">            kwargs: Passed to fig.add_scatter method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spin_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">)</span> <span class="k">if</span> <span class="n">spin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">spin</span><span class="p">]</span>
        <span class="n">band_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mband</span><span class="p">)</span> <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">band</span><span class="p">]</span>

        <span class="n">label</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="c1"># Handle linewidths</span>
        <span class="n">with_linewidths</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;with_linewidths&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_linewidths</span>
        <span class="k">if</span> <span class="n">with_linewidths</span><span class="p">:</span>
            <span class="n">lw_opts</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;lw_opts&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">opacity</span><span class="o">=</span><span class="mf">0.6</span><span class="p">))</span>
            <span class="n">lw_fact</span> <span class="o">=</span> <span class="n">lw_opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;fact&quot;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>

        <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">)</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="n">spin_range</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">band_range</span><span class="p">:</span>
                <span class="n">yy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="p">:,</span> <span class="n">band</span><span class="p">]</span> <span class="o">-</span> <span class="n">e0</span>

                <span class="c1"># Set label only at the first iteration</span>
                <span class="n">rcd</span> <span class="o">=</span> <span class="n">PlotlyRowColDesc</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">rcd</span><span class="p">)</span>
                <span class="n">ply_row</span><span class="p">,</span> <span class="n">ply_col</span> <span class="o">=</span> <span class="n">rcd</span><span class="o">.</span><span class="n">ply_row</span><span class="p">,</span> <span class="n">rcd</span><span class="o">.</span><span class="n">ply_col</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xx</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">yy</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="n">showlegend</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">line_opts</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                                <span class="n">row</span><span class="o">=</span><span class="n">ply_row</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">ply_col</span><span class="p">)</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">showlegend</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="n">with_linewidths</span><span class="p">:</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linewidths</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="p">:,</span> <span class="n">band</span><span class="p">]</span> <span class="o">*</span> <span class="n">lw_fact</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>
                    <span class="c1">#lw_color = lines[-1].get_color()</span>
                    <span class="c1"># solution 1: Use scater points to fill</span>
                    <span class="c1"># solution 2: add two traces and fill the area between</span>
                    <span class="c1"># color problem</span>
                    <span class="c1">#!! ax.fill_between(xx, yy - w, yy + w, facecolor=lw_color, **lw_opts)</span>
                    <span class="c1">#, alpha=self.alpha, facecolor=self.l2color[l])</span>

    <span class="k">def</span> <span class="nf">_make_ticks_and_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">klabels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return ticks and labels from the mapping qlabels.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">klabels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">kcoord</span><span class="p">,</span> <span class="n">kname</span> <span class="ow">in</span> <span class="n">klabels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Build Kpoint instance.</span>
                <span class="n">ktick</span> <span class="o">=</span> <span class="n">Kpoint</span><span class="p">(</span><span class="n">kcoord</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">kpt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">ktick</span> <span class="o">==</span> <span class="n">kpt</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">kname</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_klabels</span>

        <span class="c1"># Return ticks, labels</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

<div class="viewcode-block" id="ElectronBands.plot_with_edos"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.plot_with_edos">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_with_edos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edos</span><span class="p">,</span> <span class="n">klabels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">with_gaps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_phfreq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the band structure and the DOS with matplotlib.</span>

<span class="sd">        Args:</span>
<span class="sd">            edos: An instance of |ElectronDos|.</span>
<span class="sd">            klabels: dictionary whose keys are tuple with the reduced coordinates of the k-points.</span>
<span class="sd">                The values are the labels. e.g. ``klabels = {(0.0,0.0,0.0): &quot;$\Gamma$&quot;, (0.5,0,0): &quot;L&quot;}``.</span>
<span class="sd">            ax_list: The axes for the bandstructure plot and the DOS plot. If ax_list is None, a new figure</span>
<span class="sd">                is created and the two axes are automatically generated.</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                   or scalar e.g. ``left``. If left (right) is None, default values are used</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values::</span>

<span class="sd">                * ``fermie``: shift all eigenvalues and the DOS to have zero energy at the Fermi energy.</span>
<span class="sd">                   Note that, by default, the Fermi energy is taken from the band structure object</span>
<span class="sd">                   i.e. the Fermi energy computed at the end of the SCF file that produced the density.</span>
<span class="sd">                   This should be ok in semiconductors. In metals, however, a better value of the Fermi energy</span>
<span class="sd">                   can be obtained from the DOS provided that the k-sampling for the DOS is much denser than</span>
<span class="sd">                   the one used to compute the density. See ``edos_fermie``.</span>
<span class="sd">                * ``edos_fermie``: Use the Fermi energy computed from the DOS to define the zero of energy in both subplots.</span>
<span class="sd">                *  Number e.g ``e0 = 0.5``: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                *  None: Don&#39;t shift energies, equivalent to ``e0 = 0``</span>

<span class="sd">            points: Marker object with the position and the size of the marker.</span>
<span class="sd">                Used for plotting purpose e.g. QP energies, energy derivatives...</span>
<span class="sd">            with_gaps: True to add markers and arrows showing the fundamental and the direct gap.</span>
<span class="sd">            max_phfreq: Max phonon frequency in eV to activate scatterplot showing</span>
<span class="sd">                possible phonon absorption/emission processes based on energy-conservation alone.</span>
<span class="sd">                All final states whose energy is within +- max_phfreq of the initial state are included.</span>
<span class="sd">                By default, the four electronic states defining the fundamental and the direct gaps</span>
<span class="sd">                are considered as initial state (not available for metals).</span>
<span class="sd">            width_ratios: Defines the ratio between the band structure plot and the dos plot.</span>

<span class="sd">        Return: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="kn">import</span> <span class="n">GridSpec</span>

        <span class="k">if</span> <span class="n">ax_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Build axes and align bands and DOS.</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">gspec</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="n">width_ratios</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
            <span class="n">ax0</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Take them from ax_list.</span>
            <span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">ax_list</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>

        <span class="c1"># Define the zero of energy.</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span> <span class="k">if</span> <span class="n">e0</span> <span class="o">!=</span> <span class="s2">&quot;edos_fermie&quot;</span> <span class="k">else</span> <span class="n">edos</span><span class="o">.</span><span class="n">fermie</span>
        <span class="c1">#if not kwargs: kwargs = {&quot;color&quot;: &quot;black&quot;, &quot;linewidth&quot;: 2.0}</span>

        <span class="c1"># Plot the band structure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">e0</span><span class="o">=</span><span class="n">e0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax0</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="n">ylims</span><span class="p">,</span> <span class="n">klabels</span><span class="o">=</span><span class="n">klabels</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="n">points</span><span class="p">,</span>
                  <span class="n">with_gaps</span><span class="o">=</span><span class="n">with_gaps</span><span class="p">,</span> <span class="n">max_phfreq</span><span class="o">=</span><span class="n">max_phfreq</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Plot the DOS</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">opts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">}</span>
            <span class="n">edos</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
                <span class="n">opts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">}</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> \
                       <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">}</span>
                <span class="n">edos</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">)</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="ElectronBands.plotly_with_edos"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.plotly_with_edos">[docs]</a>    <span class="nd">@add_plotly_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plotly_with_edos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edos</span><span class="p">,</span> <span class="n">klabels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">with_gaps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_phfreq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the band structure and the DOS with plotly.</span>

<span class="sd">        Args:</span>
<span class="sd">            edos: An instance of |ElectronDos|.</span>
<span class="sd">            klabels: dictionary whose keys are tuple with the reduced coordinates of the k-points.</span>
<span class="sd">                The values are the labels. e.g. ``klabels = {(0.0,0.0,0.0): &quot;$\Gamma$&quot;, (0.5,0,0): &quot;L&quot;}``.</span>
<span class="sd">            fig: The |plotly.graph_objects.Figure| with two distinct plots for the bandstructure plot and the DOS plot.</span>
<span class="sd">                If fig is None, a new figure is created.</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values::</span>

<span class="sd">                * ``fermie``: shift all eigenvalues and the DOS to have zero energy at the Fermi energy.</span>
<span class="sd">                   Note that, by default, the Fermi energy is taken from the band structure object</span>
<span class="sd">                   i.e. the Fermi energy computed at the end of the SCF file that produced the density.</span>
<span class="sd">                   This should be ok in semiconductors. In metals, however, a better value of the Fermi energy</span>
<span class="sd">                   can be obtained from the DOS provided that the k-sampling for the DOS is much denser than</span>
<span class="sd">                   the one used to compute the density. See ``edos_fermie``.</span>
<span class="sd">                * ``edos_fermie``: Use the Fermi energy computed from the DOS to define the zero of energy in both subplots.</span>
<span class="sd">                *  Number e.g ``e0 = 0.5``: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                *  None: Don&#39;t shift energies, equivalent to ``e0 = 0``</span>

<span class="sd">            points: Marker object with the position and the size of the marker.</span>
<span class="sd">                Used for plotting purpose e.g. QP energies, energy derivatives...</span>
<span class="sd">            with_gaps: True to add markers and arrows showing the fundamental and the direct gap.</span>
<span class="sd">            max_phfreq: Max phonon frequency in eV to activate scatterplot showing</span>
<span class="sd">                possible phonon absorption/emission processes based on energy-conservation alone.</span>
<span class="sd">                All final states whose energy is within +- max_phfreq of the initial state are included.</span>
<span class="sd">                By default, the four electronic states defining the fundamental and the direct gaps</span>
<span class="sd">                are considered as initial state (not available for metals).</span>
<span class="sd">            width_ratios: Defines the ratio between the band structure plot and the dos plot.</span>

<span class="sd">        Return: |plotly.graph_objects.Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Build fig.</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_figs_plotly</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                     <span class="n">horizontal_spacing</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">column_widths</span><span class="o">=</span><span class="n">width_ratios</span><span class="p">)</span>

        <span class="c1"># Define the zero of energy.</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span> <span class="k">if</span> <span class="n">e0</span> <span class="o">!=</span> <span class="s2">&quot;edos_fermie&quot;</span> <span class="k">else</span> <span class="n">edos</span><span class="o">.</span><span class="n">fermie</span>
        <span class="c1">#if not kwargs: kwargs = {&quot;color&quot;: &quot;black&quot;, &quot;linewidth&quot;: 2.0}</span>

        <span class="c1"># Plot the band structure</span>
        <span class="n">rcd</span> <span class="o">=</span> <span class="n">PlotlyRowColDesc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotly</span><span class="p">(</span><span class="n">e0</span><span class="o">=</span><span class="n">e0</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">rcd</span><span class="o">=</span><span class="n">rcd</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="n">ylims</span><span class="p">,</span> <span class="n">klabels</span><span class="o">=</span><span class="n">klabels</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="n">points</span><span class="p">,</span>
                  <span class="n">with_gaps</span><span class="o">=</span><span class="n">with_gaps</span><span class="p">,</span> <span class="n">max_phfreq</span><span class="o">=</span><span class="n">max_phfreq</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Plot the DOS</span>
        <span class="n">rcd</span> <span class="o">=</span> <span class="n">PlotlyRowColDesc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">opts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">}</span>
            <span class="n">edos</span><span class="o">.</span><span class="n">plotly_traces</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rcd</span><span class="o">=</span><span class="n">rcd</span><span class="p">,</span> <span class="n">line_opts</span><span class="o">=</span><span class="n">opts</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
                <span class="n">opts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">}</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> \
                       <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">}</span>
                <span class="n">edos</span><span class="o">.</span><span class="n">plotly_traces</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rcd</span><span class="o">=</span><span class="n">rcd</span><span class="p">,</span> <span class="n">line_opts</span><span class="o">=</span><span class="n">opts</span><span class="p">)</span>

        <span class="n">plotly_set_lims</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="ElectronBands.plot_lws_vs_e0"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.plot_lws_vs_e0">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_lws_vs_e0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot electronic linewidths vs KS energy with matplotlib.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: |matplotlib-Axes| or None if a new figure should be created.</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - ``fermie``: shift all eigenvalues to have zero energy at the Fermi energy (``self.fermie``).</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">            function: Apply this function to the values before plotting</span>
<span class="sd">            exchange_xy: True to exchange x-y axis.</span>
<span class="sd">            xlims, ylims: Set the data limits for the x-axis or the y-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                   or scalar e.g. ``left``. If left (right) is None, default values are used</span>
<span class="sd">            fontsize: fontsize for titles and legend.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_linewidths</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="n">xlabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$\epsilon_</span><span class="si">{KS}</span><span class="s2">\;(eV)$&quot;</span>
        <span class="k">if</span> <span class="n">e0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$\epsilon_</span><span class="si">{KS}</span><span class="s2">-\epsilon_F\;(eV)$&quot;</span>

        <span class="c1"># DSU sort to get lw(e) with sorted energies.</span>
        <span class="n">e0mesh</span><span class="p">,</span> <span class="n">lws</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="o">.</span><span class="n">flat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linewidths</span><span class="o">.</span><span class="n">flat</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
        <span class="n">e0mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">e0mesh</span><span class="p">)</span> <span class="o">-</span> <span class="n">e0</span>

        <span class="n">kw_linestyle</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;linestyle&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
        <span class="c1">#kw_lw = kwargs.pop(&quot;lw&quot;, 1)</span>
        <span class="c1">#kw_lw = kwargs.pop(&quot;markersize&quot;, 5)</span>
        <span class="n">kw_color</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
        <span class="n">kw_label</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">e0mesh</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">function</span><span class="p">(</span><span class="n">lw</span><span class="p">)</span> <span class="k">for</span> <span class="n">lw</span> <span class="ow">in</span> <span class="n">lws</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span><span class="p">,</span> <span class="n">xx</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">kw_linestyle</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">kw_color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">kw_label</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1">#ax.scatter(xx, yy)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;Linewidth (eV)&quot;</span>
        <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">xlabel</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kw_linestyle</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="ElectronBands.to_xmgrace"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.to_xmgrace">[docs]</a>    <span class="k">def</span> <span class="nf">to_xmgrace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write xmgrace_ file with band structure energies and labels for high-symmetry k-points.</span>

<span class="sd">        Args:</span>
<span class="sd">            filepath: String with filename or stream.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">is_stream</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;write&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_stream</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">filepath</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">w</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">emef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigens</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">datetime</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;# Grace project file&quot;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;# Generated by abipy on: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()))</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;# Crystalline structure:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="n">w</span><span class="p">(</span><span class="s2">&quot;# </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;# mband: </span><span class="si">%d</span><span class="s2">, nkpt: </span><span class="si">%d</span><span class="s2">, nsppol: </span><span class="si">%d</span><span class="s2">, nspinor: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mband</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span><span class="p">))</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;# nelect: </span><span class="si">%8.2f</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nelect</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smearing</span><span class="p">)))</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;# Energies are in eV. Zero set to efermi, previously it was at: </span><span class="si">%s</span><span class="s2"> (eV)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;# List of k-points and their index (C notation i.e. count from 0)&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ik</span><span class="p">,</span> <span class="n">kpt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">):</span>
            <span class="n">w</span><span class="p">(</span><span class="s2">&quot;# </span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">kpt</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">)))</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;@page size 792, 612&quot;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;@page scroll 5%&quot;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;@page inout 5%&quot;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;@link page off&quot;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;@with g0&quot;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;@world xmin 0.00&quot;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@world xmax </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@world ymin </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">emef</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@world ymax </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">emef</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@default linewidth 1.5&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  tick on&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  tick major 1&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  tick major color 1&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  tick major linestyle 3&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  tick major grid on&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  tick spec type both&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  tick major 0, 0&#39;</span><span class="p">)</span>

        <span class="n">kticks</span><span class="p">,</span> <span class="n">klabels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_ticks_and_labels</span><span class="p">(</span><span class="n">klabels</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  tick spec </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">kticks</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ik</span><span class="p">,</span> <span class="p">(</span><span class="n">ktick</span><span class="p">,</span> <span class="n">klabel</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">kticks</span><span class="p">,</span> <span class="n">klabels</span><span class="p">)):</span>
            <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  tick major </span><span class="si">%d</span><span class="s1">, </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="n">ktick</span><span class="p">))</span>
            <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  ticklabel </span><span class="si">%d</span><span class="s1">, &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="n">klabel</span><span class="p">))</span>

        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  ticklabel char size 1.500000&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@yaxis  tick major 10&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@yaxis  label &quot;Band Energy (eV)&quot;&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@yaxis  label char size 1.500000&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@yaxis  ticklabel char size 1.500000&#39;</span><span class="p">)</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mband</span><span class="p">):</span>
                <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@    s</span><span class="si">%d</span><span class="s1"> line color </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">spin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">ii</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mband</span><span class="p">):</span>
                <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@target G0.S</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ii</span><span class="p">)</span>
                <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@type xy&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span><span class="p">):</span>
                    <span class="n">w</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> </span><span class="si">%.8E</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="n">emef</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">band</span><span class="p">]))</span>
                <span class="n">w</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_stream</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="ElectronBands.to_bxsf"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.to_bxsf">[docs]</a>    <span class="k">def</span> <span class="nf">to_bxsf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export the full band structure to ``filepath`` in BXSF format</span>
<span class="sd">        suitable for the visualization of isosurfaces with xcrysden_ (xcrysden --bxsf FILE).</span>
<span class="sd">        Require k-points in IBZ and gamma-centered k-mesh.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_ebands3d</span><span class="p">()</span><span class="o">.</span><span class="n">to_bxsf</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.get_ebands3d"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.get_ebands3d">[docs]</a>    <span class="k">def</span> <span class="nf">get_ebands3d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ElectronBands3D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_timrev</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.derivatives"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.derivatives">[docs]</a>    <span class="k">def</span> <span class="nf">derivatives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">acc</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the derivative of the eigenvalues wrt to k.</span>

<span class="sd">        Args:</span>
<span class="sd">            spin: Spin index</span>
<span class="sd">            band: Band index</span>
<span class="sd">            order:</span>
<span class="sd">            acc:</span>

<span class="sd">        Returns:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">is_path</span><span class="p">:</span>
            <span class="c1"># Extract the energy branch.</span>
            <span class="n">ebranch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="p">:,</span> <span class="n">band</span><span class="p">]</span>
            <span class="c1"># Simulate free-electron bands. This will produce all(effective masses == 1)</span>
            <span class="c1">#ebranch = 0.5 * units.Ha_to_eV * np.array([(k.norm * units.bohr_to_ang)**2 for k in self.kpoints])</span>

            <span class="c1"># Compute derivatives by finite differences.</span>
            <span class="n">ders_onlines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">finite_diff</span><span class="p">(</span><span class="n">ebranch</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">acc</span><span class="o">=</span><span class="n">acc</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ders_onlines</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Derivatives on homogeneous k-meshes are not supported yet&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.effective_masses"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.effective_masses">[docs]</a>    <span class="k">def</span> <span class="nf">effective_masses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">acc</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the effective masses for the given ``spin`` and ``band`` index.</span>
<span class="sd">        Use finite difference with accuracy ``acc``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            |numpy-array| of size self.nkpt with effective masses.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ders2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">derivatives</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">acc</span><span class="o">=</span><span class="n">acc</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">eV_to_Ha</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">bohr_to_ang</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">ders2</span></div>

<div class="viewcode-block" id="ElectronBands.get_effmass_line"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.get_effmass_line">[docs]</a>    <span class="k">def</span> <span class="nf">get_effmass_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">acc</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the effective masses along a k-line. Requires band energies on a k-path.</span>

<span class="sd">        Args:</span>
<span class="sd">            spin: Spin index.</span>
<span class="sd">            kpoint: integer, list of fractional coordinates or |Kpoint| object.</span>
<span class="sd">            band: Band index.</span>
<span class="sd">            acc: accuracy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;This code is still under development. API may change!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">is_path</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;get_effmass_line requires k-points along a path. Got:</span><span class="se">\n</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">))</span>

        <span class="c1"># We have to understand if the k-point is a vertex or not.</span>
        <span class="c1"># If it is a vertex, we have to compute the left and right derivative</span>
        <span class="c1"># If kpt is inside the line, left and right derivatives are supposed to be equal</span>
        <span class="kn">from</span> <span class="nn">abipy.tools.derivatives</span> <span class="kn">import</span> <span class="n">finite_diff</span>

        <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">get_all_kindices</span><span class="p">(</span><span class="n">kpoint</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">iline</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">lines</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">ik</span> <span class="o">&gt;=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot find k-index `</span><span class="si">%s</span><span class="s2">` in lines: `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">lines</span><span class="p">))</span>

            <span class="n">kpos</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span>
            <span class="n">is_inside</span> <span class="o">=</span> <span class="n">kpos</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">do_right</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">is_inside</span><span class="p">)</span> <span class="ow">and</span> <span class="n">kpos</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">iline</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="n">evals_on_line</span><span class="p">,</span> <span class="n">h_left</span><span class="p">,</span> <span class="n">vers_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eigens_hvers_iline</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">iline</span><span class="p">)</span>
            <span class="n">d2</span> <span class="o">=</span> <span class="n">finite_diff</span><span class="p">(</span><span class="n">evals_on_line</span><span class="p">,</span> <span class="n">h_left</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">acc</span><span class="o">=</span><span class="n">acc</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">kpos</span><span class="p">)</span>
            <span class="n">em_left</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">d2</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">eV_to_Ha</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">bohr_to_ang</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">em_right</span> <span class="o">=</span> <span class="n">em_left</span>
            <span class="n">h_right</span><span class="p">,</span> <span class="n">vers_right</span> <span class="o">=</span> <span class="n">h_left</span><span class="p">,</span> <span class="n">vers_left</span>

            <span class="k">if</span> <span class="n">do_right</span><span class="p">:</span>
                <span class="n">kpos_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">iline</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">kpos_right</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="n">evals_on_line</span><span class="p">,</span> <span class="n">h_right</span><span class="p">,</span> <span class="n">vers_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eigens_hvers_iline</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">iline</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">d2</span> <span class="o">=</span> <span class="n">finite_diff</span><span class="p">(</span><span class="n">evals_on_line</span><span class="p">,</span> <span class="n">h_right</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">acc</span><span class="o">=</span><span class="n">acc</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">kpos_right</span><span class="p">)</span>
                <span class="n">em_right</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">d2</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">eV_to_Ha</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">bohr_to_ang</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>

            <span class="n">lines</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;For spin: </span><span class="si">%s</span><span class="s2">, band: </span><span class="si">%s</span><span class="s2">, k-point: </span><span class="si">%s</span><span class="s2">, eig: </span><span class="si">%.3f</span><span class="s2"> [eV], accuracy: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="p">[</span><span class="n">ik</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">band</span><span class="p">],</span> <span class="n">acc</span><span class="p">))</span>
            <span class="c1">#app(&quot;K-point: %s, eigenvalue: %s (eV)&quot; % (repr(self.kpoint), self.eig))</span>
            <span class="c1">#app(&quot;h_left: %s, h_right %s&quot; % (self.h_left, self.h_right))</span>
            <span class="c1">#app(&quot;is_inside: %s, vers_left: %s, vers_right: %s&quot; % (self.is_inside, self.vers_left, self.vers_right))</span>
            <span class="k">if</span> <span class="n">em_left</span> <span class="o">!=</span> <span class="n">em_right</span><span class="p">:</span>
                <span class="n">app</span><span class="p">(</span><span class="s2">&quot;emass_left: </span><span class="si">%.3f</span><span class="s2">, emass_right: </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">em_left</span><span class="p">,</span> <span class="n">em_right</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">app</span><span class="p">(</span><span class="s2">&quot;emass: </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">em_left</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_eigens_hvers_iline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">iline</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">iline</span><span class="p">]</span>
        <span class="n">evals_on_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">band</span><span class="p">]</span>
        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;For finite difference derivatives, the path must be homogeneous!</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                             <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]))</span>

        <span class="k">return</span> <span class="n">evals_on_line</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">versors</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

<div class="viewcode-block" id="ElectronBands.interpolate"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.interpolate">[docs]</a>    <span class="k">def</span> <span class="nf">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lpratio</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">knames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vertices_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">line_density</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                    <span class="n">kmesh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_shift</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bstart</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bstop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Interpolate energies in k-space along a k-path and, optionally, in the IBZ for DOS calculations.</span>
<span class="sd">        Note that the interpolation will likely fail if there are symmetrical k-points in the input set of k-points</span>
<span class="sd">        so it&#39;s recommended to call this method with energies obtained in the IBZ.</span>

<span class="sd">        Args:</span>
<span class="sd">            lpratio: Ratio between the number of star functions and the number of ab-initio k-points.</span>
<span class="sd">                The default should be OK in many systems, larger values may be required for accurate derivatives.</span>
<span class="sd">            knames: List of strings with the k-point labels for the k-path. Has precedence over ``vertices_names``.</span>
<span class="sd">            vertices_names: Used to specify the k-path for the interpolated band structure</span>
<span class="sd">                It&#39;s a list of tuple, each tuple is of the form (kfrac_coords, kname) where</span>
<span class="sd">                kfrac_coords are the reduced coordinates of the k-point and kname is a string with the name of</span>
<span class="sd">                the k-point. Each point represents a vertex of the k-path. ``line_density`` defines</span>
<span class="sd">                the density of the sampling. If None, the k-path is automatically generated according</span>
<span class="sd">                to the point group of the system.</span>
<span class="sd">            line_density: Number of points in the smallest segment of the k-path.</span>
<span class="sd">                If 0, use list of k-points given in vertices_names</span>
<span class="sd">            kmesh: Used to activate the interpolation on the homogeneous mesh for DOS (uses spglib_ API).</span>
<span class="sd">                kmesh is given by three integers and specifies mesh numbers along reciprocal primitive axis.</span>
<span class="sd">            is_shift: three integers (spglib_ API). When is_shift is not None, the kmesh is shifted along</span>
<span class="sd">                the axis in half of adjacent mesh points irrespective of the mesh numbers. None means unshited mesh.</span>
<span class="sd">            bstart, bstop: Select the range of band to be used in the interpolation</span>
<span class="sd">            filter_params: TO BE described.</span>
<span class="sd">            verbose: Verbosity level</span>

<span class="sd">        Returns:</span>
<span class="sd">                namedtuple with the following attributes::</span>

<span class="sd">                    ebands_kpath: |ElectronBands| with the interpolated band structure on the k-path.</span>
<span class="sd">                    ebands_kmesh: |ElectronBands| with the interpolated band structure on the k-mesh.</span>
<span class="sd">                        None if ``kmesh`` is not given.</span>
<span class="sd">                    interpolator: |SkwInterpolator| object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get symmetries from abinit spacegroup (read from file).</span>
        <span class="n">abispg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">abi_spacegroup</span>
        <span class="k">if</span> <span class="n">abispg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">abispg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">spgset_abi_spacegroup</span><span class="p">(</span><span class="n">has_timerev</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">has_timrev</span><span class="p">)</span>

        <span class="n">fm_symrel</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">afm</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">abispg</span><span class="o">.</span><span class="n">symrel</span><span class="p">,</span> <span class="n">abispg</span><span class="o">.</span><span class="n">symafm</span><span class="p">)</span> <span class="k">if</span> <span class="n">afm</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nband</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nband</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="ow">and</span> <span class="n">bstart</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">bstop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Bands object contains nband </span><span class="si">%s</span><span class="s2"> with nelect </span><span class="si">%s</span><span class="s2">. You may want to use bstart, bstop to select bands.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nband</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span><span class="p">),</span> <span class="s2">&quot;yellow&quot;</span><span class="p">)</span>

        <span class="c1"># Build interpolator.</span>
        <span class="kn">from</span> <span class="nn">abipy.core.skw</span> <span class="kn">import</span> <span class="n">SkwInterpolator</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">atomic_numbers</span><span class="p">)</span>

        <span class="n">skw</span> <span class="o">=</span> <span class="n">SkwInterpolator</span><span class="p">(</span><span class="n">lpratio</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[:,:,</span><span class="n">bstart</span><span class="p">:</span><span class="n">bstop</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span><span class="p">,</span>
                              <span class="n">cell</span><span class="p">,</span> <span class="n">fm_symrel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_timrev</span><span class="p">,</span>
                              <span class="n">filter_params</span><span class="o">=</span><span class="n">filter_params</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="c1"># Generate k-points for interpolation.</span>
        <span class="k">if</span> <span class="n">knames</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kpath</span> <span class="o">=</span> <span class="n">Kpath</span><span class="o">.</span><span class="n">from_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">knames</span><span class="p">,</span> <span class="n">line_density</span><span class="o">=</span><span class="n">line_density</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vertices_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">vertices_names</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">,</span> <span class="n">k</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">hsym_kpoints</span><span class="p">]</span>
            <span class="n">kpath</span> <span class="o">=</span> <span class="n">Kpath</span><span class="o">.</span><span class="n">from_vertices_and_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">vertices_names</span><span class="p">,</span> <span class="n">line_density</span><span class="o">=</span><span class="n">line_density</span><span class="p">)</span>

        <span class="c1"># Interpolate energies.</span>
        <span class="n">eigens_kpath</span> <span class="o">=</span> <span class="n">skw</span><span class="o">.</span><span class="n">interp_kpts</span><span class="p">(</span><span class="n">kpath</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">)</span><span class="o">.</span><span class="n">eigens</span>

        <span class="c1"># Build new ebands object.</span>
        <span class="n">occfacts_kpath</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">eigens_kpath</span><span class="p">)</span>
        <span class="n">ebands_kpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">kpath</span><span class="p">,</span> <span class="n">eigens_kpath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">,</span> <span class="n">occfacts_kpath</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspden</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smearing</span><span class="p">)</span>
        <span class="n">ebands_kmesh</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">kmesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Get kpts and weights in the IBZ.</span>
            <span class="n">kdos</span> <span class="o">=</span> <span class="n">Ktables</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">kmesh</span><span class="p">,</span> <span class="n">is_shift</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_timrev</span><span class="p">)</span>
            <span class="n">eigens_kmesh</span> <span class="o">=</span> <span class="n">skw</span><span class="o">.</span><span class="n">interp_kpts</span><span class="p">(</span><span class="n">kdos</span><span class="o">.</span><span class="n">ibz</span><span class="p">)</span><span class="o">.</span><span class="n">eigens</span>

            <span class="c1"># Build new ebands object with k-mesh</span>
            <span class="c1">#kptopt = kptopt_from_timrev()</span>
            <span class="n">ksampling</span> <span class="o">=</span> <span class="n">KSamplingInfo</span><span class="o">.</span><span class="n">from_mpdivs</span><span class="p">(</span><span class="n">mpdivs</span><span class="o">=</span><span class="n">kmesh</span><span class="p">,</span> <span class="n">shifts</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">kptopt</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">kpts_kmesh</span> <span class="o">=</span> <span class="n">IrredZone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">,</span> <span class="n">kdos</span><span class="o">.</span><span class="n">ibz</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">kdos</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span>
                                   <span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ksampling</span><span class="o">=</span><span class="n">ksampling</span><span class="p">)</span>
            <span class="n">occfacts_kmesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">eigens_kmesh</span><span class="p">)</span>

            <span class="n">ebands_kmesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">kpts_kmesh</span><span class="p">,</span> <span class="n">eigens_kmesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">,</span> <span class="n">occfacts_kmesh</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspden</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smearing</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dict2namedtuple</span><span class="p">(</span><span class="n">ebands_kpath</span><span class="o">=</span><span class="n">ebands_kpath</span><span class="p">,</span> <span class="n">ebands_kmesh</span><span class="o">=</span><span class="n">ebands_kmesh</span><span class="p">,</span> <span class="n">interpolator</span><span class="o">=</span><span class="n">skw</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBands.get_collinear_mag"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBands.get_collinear_mag">[docs]</a>    <span class="k">def</span> <span class="nf">get_collinear_mag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the total collinear magnetization in Bohr magneton as the difference</span>
<span class="sd">        between the spin up and spin down densities.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: the total magnetization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspden</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot calculate collinear magnetization for nsppol: </span><span class="si">{}</span><span class="s2">, &quot;</span>
                                 <span class="s2">&quot;nspinor </span><span class="si">{}</span><span class="s2">, nspden </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspinor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspden</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rhoup</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">weights</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">occfacts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">rhoudown</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">weights</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">occfacts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">rhoup</span> <span class="o">-</span> <span class="n">rhoudown</span></div></div>


<div class="viewcode-block" id="dataframe_from_ebands"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.dataframe_from_ebands">[docs]</a><span class="k">def</span> <span class="nf">dataframe_from_ebands</span><span class="p">(</span><span class="n">ebands_objects</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_spglib</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a pandas dataframe with the most important results available in a list of band structures.</span>

<span class="sd">    Args:</span>
<span class="sd">        ebands_objects: List of objects that can be converted to structure.</span>
<span class="sd">            Support netcdf filenames or |ElectronBands| objects</span>
<span class="sd">            See ``ElectronBands.as_ebands`` for the complete list.</span>
<span class="sd">        index: Index of the dataframe.</span>
<span class="sd">        with_spglib: If True, spglib is invoked to get the spacegroup symbol and number.</span>

<span class="sd">    Return: |pandas-DataFrame|</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ebands_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ElectronBands</span><span class="o">.</span><span class="n">as_ebands</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">ebands_objects</span><span class="p">]</span>
    <span class="c1"># Use OrderedDict to have columns ordered nicely.</span>
    <span class="n">odict_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ebands</span><span class="o">.</span><span class="n">get_dict4pandas</span><span class="p">(</span><span class="n">with_spglib</span><span class="o">=</span><span class="n">with_spglib</span><span class="p">))</span> <span class="k">for</span> <span class="n">ebands</span> <span class="ow">in</span> <span class="n">ebands_list</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">odict_list</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
                        <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">odict_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">odict_list</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="ElectronBandsPlotter"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBandsPlotter">[docs]</a><span class="k">class</span> <span class="nc">ElectronBandsPlotter</span><span class="p">(</span><span class="n">NotebookWriter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for plotting electronic band structure and DOSes.</span>
<span class="sd">    Supports plots on the same graph or separated plots.</span>

<span class="sd">    Usage example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        plotter = ElectronBandsPlotter()</span>
<span class="sd">        plotter.add_ebands(&quot;foo-label&quot;, &quot;foo_GSR.nc&quot;)</span>
<span class="sd">        plotter.add_ebands(&quot;bar-label&quot;, &quot;bar_WFK.nc&quot;)</span>
<span class="sd">        fig = plotter.gridplot()</span>

<span class="sd">    Dictionary with the mapping label --&gt; edos.</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: ElectronBandsPlotter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Used in iter_lineopt to generate matplotlib linestyles.</span>
    <span class="n">_LINE_COLORS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">]</span>
    <span class="n">_LINE_STYLES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="s2">&quot;-.&quot;</span><span class="p">,]</span>
    <span class="n">_LINE_WIDTHS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_ebands</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">key_edos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">edos_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            key_ebands: List of (label, ebands) tuples.</span>
<span class="sd">                ebands is any object that can be converted into |ElectronBands| e.g. ncfile, path.</span>
<span class="sd">            key_edos: List of (label, edos) tuples.</span>
<span class="sd">                edos is any object that can be converted into |ElectronDos|.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key_ebands</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">key_ebands</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">key_ebands</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">ElectronBands</span><span class="o">.</span><span class="n">as_ebands</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">key_ebands</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">key_ebands</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">key_edos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">key_edos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">key_edos</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">ElectronDos</span><span class="o">.</span><span class="n">as_edos</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">edos_kwargs</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">key_edos</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">key_edos</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key_edos</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">key_ebands</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;key_ebands must be specifed when key_dos is not None&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_ebands</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_edos</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;key_ebands and key_edos must have the same number of elements.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Invoked by repr&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="nb">repr</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Invoked by str&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="p">)</span>

<div class="viewcode-block" id="ElectronBandsPlotter.add_plotter"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBandsPlotter.add_plotter">[docs]</a>    <span class="k">def</span> <span class="nf">add_plotter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Merge two plotters, return new plotter.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know to add </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">))</span>

        <span class="n">key_ebands</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">ebands_dict</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="n">key_edos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">edoses_dict</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">key_ebands</span><span class="o">=</span><span class="n">key_ebands</span><span class="p">,</span> <span class="n">key_edos</span><span class="o">=</span><span class="n">key_edos</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBandsPlotter.to_string"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBandsPlotter.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">ebands</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">%d</span><span class="s2">] </span><span class="si">%s</span><span class="s2"> --&gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">func</span><span class="p">(</span><span class="n">ebands</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">edos</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">app</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">%d</span><span class="s2">] </span><span class="si">%s</span><span class="s2"> --&gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">func</span><span class="p">(</span><span class="n">edos</span><span class="p">)))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBandsPlotter.get_ebands_frame"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBandsPlotter.get_ebands_frame">[docs]</a>    <span class="k">def</span> <span class="nf">get_ebands_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_spglib</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a |pandas-DataFrame| with the most important results available in the band structures.</span>
<span class="sd">        Useful to analyze band-gaps.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">dataframe_from_ebands</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                                     <span class="n">index</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">with_spglib</span><span class="o">=</span><span class="n">with_spglib</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ebands_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;List of |ElectronBands| objects.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">edoses_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;List of |ElectronDos| objects.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

<div class="viewcode-block" id="ElectronBandsPlotter.iter_lineopt"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBandsPlotter.iter_lineopt">[docs]</a>    <span class="k">def</span> <span class="nf">iter_lineopt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generates matplotlib linestyles.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_LINE_WIDTHS</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_LINE_STYLES</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LINE_COLORS</span><span class="p">):</span>
            <span class="k">yield</span> <span class="p">{</span><span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;linestyle&quot;</span><span class="p">:</span> <span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">o</span><span class="p">[</span><span class="mi">2</span><span class="p">]}</span></div>

<div class="viewcode-block" id="ElectronBandsPlotter.add_ebands"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBandsPlotter.add_ebands">[docs]</a>    <span class="k">def</span> <span class="nf">add_ebands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">edos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">edos_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a band structure and optionally an edos to the plotter.</span>

<span class="sd">        Args:</span>
<span class="sd">            label: label for the bands. Must be unique.</span>
<span class="sd">            bands: |ElectronBands| object.</span>
<span class="sd">            edos: |ElectronDos| object.</span>
<span class="sd">            edos_kwargs: optional dictionary with the options passed to ``get_edos`` to compute the electron DOS.</span>
<span class="sd">                Used only if ``edos`` is not None and it&#39;s not an |ElectronDos| instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;label </span><span class="si">%s</span><span class="s2"> is already in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">ElectronBands</span><span class="o">.</span><span class="n">as_ebands</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">edos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">ElectronDos</span><span class="o">.</span><span class="n">as_edos</span><span class="p">(</span><span class="n">edos</span><span class="p">,</span> <span class="n">edos_kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBandsPlotter.bands_statdiff"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBandsPlotter.bands_statdiff">[docs]</a>    <span class="k">def</span> <span class="nf">bands_statdiff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compare the reference bands with index ref with the other bands stored in the plotter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">ref</span><span class="p">:</span>
                <span class="n">ref_label</span> <span class="o">=</span> <span class="n">label</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ref index </span><span class="si">%s</span><span class="s2"> is &gt; number of bands&quot;</span> <span class="o">%</span> <span class="n">ref</span><span class="p">)</span>

        <span class="n">ref_bands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="p">[</span><span class="n">ref_label</span><span class="p">]</span>

        <span class="n">text</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">bands</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="n">ref_label</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">stat</span> <span class="o">=</span> <span class="n">ref_bands</span><span class="o">.</span><span class="n">statdiff</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span>
            <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">stat</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBandsPlotter.yield_figs"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBandsPlotter.yield_figs">[docs]</a>    <span class="k">def</span> <span class="nf">yield_figs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function *generates* a predefined list of matplotlib figures with minimal input from the user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">mname</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;gridplot&quot;</span><span class="p">,</span> <span class="s2">&quot;boxplot&quot;</span><span class="p">):</span>
            <span class="k">yield</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mname</span><span class="p">)(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

    <span class="c1">#def yield_plotly_figs(self, **kwargs):  # pragma: no cover</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    This function *generates* a predefined list of matplotlib figures with minimal input from the user.</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    for mname in (&quot;gridplot&quot;, &quot;boxplot&quot;):</span>
    <span class="c1">#        yield getattr(self, mname)(show=False)</span>

<div class="viewcode-block" id="ElectronBandsPlotter.combiplot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBandsPlotter.combiplot">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">combiplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                  <span class="n">linestyle_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the band structure and the DOS on the same figure.</span>
<span class="sd">        Use ``gridplot`` to plot band structures on different figures.</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values::</span>
<span class="sd">                - `fermie`: shift all eigenvalues to have zero energy at the Fermi energy (ebands.fermie)</span>
<span class="sd">                   Note that, by default, the Fermi energy is taken from the band structure object</span>
<span class="sd">                   i.e. the Fermi energy computed at the end of the SCF file that produced the density.</span>
<span class="sd">                   This should be ok in semiconductors. In metals, however, a better value of the Fermi energy</span>
<span class="sd">                   can be obtained from the DOS provided that the k-sampling for the DOS is much denser than</span>
<span class="sd">                   the one used to compute the density. See `edos_fermie`.</span>
<span class="sd">                - ``edos_fermie``: Use the Fermi energy computed from the DOS to define the zero of energy in both subplots.</span>
<span class="sd">                   Available only if plotter contains dos objects.</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used</span>
<span class="sd">            width_ratios: Defines the ratio between the band structure plot and the dos plot.</span>
<span class="sd">                Used when there are DOS stored in the plotter.</span>
<span class="sd">            fontsize: fontsize for titles and legend.</span>
<span class="sd">            linestyle_dict: Dictionary mapping labels to matplotlib linestyle options.</span>

<span class="sd">        Returns: |matplotlib-Figure|.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="kn">import</span> <span class="n">GridSpec</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="p">:</span>
            <span class="c1"># Build grid with two axes.</span>
            <span class="n">gspec</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="n">width_ratios</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
            <span class="c1"># bands and DOS will share the y-axis</span>
            <span class="n">ax0</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax0</span><span class="p">)</span>
            <span class="n">ax_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># One axis for bands only</span>
            <span class="n">ax0</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
            <span class="n">ax_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax0</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">ax_list</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="c1"># Plot ebands.</span>
        <span class="n">lines</span><span class="p">,</span> <span class="n">legends</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">my_kwargs</span><span class="p">,</span> <span class="n">opts_label</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="p">{}</span>
        <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">nkpt_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ebands</span><span class="o">.</span><span class="n">nkpt</span> <span class="k">for</span> <span class="n">ebands</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">nk</span> <span class="o">!=</span> <span class="n">nkpt_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">nk</span> <span class="ow">in</span> <span class="n">nkpt_list</span><span class="p">):</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;WARNING: Bands have different number of k-points:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">nkpt_list</span><span class="p">),</span> <span class="s2">&quot;yellow&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">ebands</span><span class="p">),</span> <span class="n">lineopt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_lineopt</span><span class="p">()):</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">linestyle_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">linestyle_dict</span><span class="p">:</span>
                <span class="n">my_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">linestyle_dict</span><span class="p">[</span><span class="n">label</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">my_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">lineopt</span><span class="p">)</span>

            <span class="n">opts_label</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">my_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># Get energy zero.</span>
            <span class="n">mye0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">fermie</span> <span class="k">if</span> <span class="n">e0</span> <span class="o">==</span> <span class="s2">&quot;edos_fermie&quot;</span> <span class="k">else</span> <span class="n">ebands</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>

            <span class="n">l</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax0</span><span class="p">,</span> <span class="n">mye0</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">my_kwargs</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># Use relative paths if label is a file.</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">label</span><span class="p">):</span>
                <span class="n">legends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">legends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">label</span><span class="p">)</span>

            <span class="c1"># Set ticks and labels, legends.</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ebands</span><span class="o">.</span><span class="n">decorate_ax</span><span class="p">(</span><span class="n">ax0</span><span class="p">)</span>

        <span class="n">ax0</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">legends</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Add DOSes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">ax_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">edos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">ebands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
                <span class="n">mye0</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span> <span class="k">if</span> <span class="n">e0</span> <span class="o">!=</span> <span class="s2">&quot;edos_fermie&quot;</span> <span class="k">else</span> <span class="n">edos</span><span class="o">.</span><span class="n">fermie</span>
                <span class="n">edos</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">mye0</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">opts_label</span><span class="p">[</span><span class="n">label</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="c1"># An alias for combiplot.</span>
    <span class="n">plot</span> <span class="o">=</span> <span class="n">combiplot</span>

<div class="viewcode-block" id="ElectronBandsPlotter.gridplot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBandsPlotter.gridplot">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">gridplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">with_dos</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_gaps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_phfreq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot multiple electron bandstructures and optionally DOSes on a grid.</span>

<span class="sd">        Args:</span>
<span class="sd">            eb_objects: List of objects from which the band structures are extracted.</span>
<span class="sd">                Each item in eb_objects is either a string with the path of the netcdf file,</span>
<span class="sd">                or one of the abipy object with an ``ebands`` attribute or a |ElectronBands| object.</span>
<span class="sd">            edos_objects: List of objects from which the electron DOSes are extracted.</span>
<span class="sd">                Accept filepaths or |ElectronDos| objects. If edos_objects is not None,</span>
<span class="sd">                each subplot in the grid contains a band structure with DOS else a simple bandstructure plot.</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values::</span>

<span class="sd">                - ``fermie``: shift all eigenvalues and the DOS to have zero energy at the Fermi energy.</span>
<span class="sd">                   Note that, by default, the Fermi energy is taken from the band structure object</span>
<span class="sd">                   i.e. the Fermi energy computed at the end of the SCF file that produced the density.</span>
<span class="sd">                   This should be ok in semiconductors. In metals, however, a better value of the Fermi energy</span>
<span class="sd">                   can be obtained from the DOS provided that the k-sampling for the DOS is much denser than</span>
<span class="sd">                   the one used to compute the density. See `edos_fermie`.</span>
<span class="sd">                - ``edos_fermie``: Use the Fermi energy computed from the DOS to define the zero of energy in both subplots.</span>
<span class="sd">                   Available only if edos_objects is not None</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>

<span class="sd">            with_dos: True if DOS should be printed.</span>
<span class="sd">            with_gaps: True to add markesr and arrows showing the fundamental and the direct gap.</span>
<span class="sd">            max_phfreq: Max phonon frequency in eV to activate scatterplot showing</span>
<span class="sd">                possible phonon absorptions/emission processes based on energy-conservation alone.</span>
<span class="sd">                All final states whose energy is within +- max_phfreq of the initial state are included.</span>
<span class="sd">                By default, the four electronic states defining the fundamental and the direct gaps</span>
<span class="sd">                are considered as initial state (not available for metals).</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. ```(left, right)``</span>
<span class="sd">                   or scalar e.g. ``left``. If left (right) is None, default values are used</span>
<span class="sd">            fontsize: fontsize for titles and legend.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">titles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">ebands_list</span><span class="p">,</span> <span class="n">edos_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edoses_list</span>

        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
        <span class="n">numeb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ebands_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">numeb</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="n">numeb</span> <span class="o">//</span> <span class="n">ncols</span> <span class="o">+</span> <span class="n">numeb</span> <span class="o">%</span> <span class="n">ncols</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">edos_list</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">with_dos</span><span class="p">:</span>
            <span class="c1"># Plot grid with bands only.</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax_list</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax_list</span> <span class="o">=</span> <span class="n">ax_list</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="c1"># don&#39;t show the last ax if numeb is odd.</span>
            <span class="k">if</span> <span class="n">numeb</span> <span class="o">%</span> <span class="n">ncols</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ax_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ebands</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ebands_list</span><span class="p">,</span> <span class="n">ax_list</span><span class="p">)):</span>
                <span class="n">irow</span><span class="p">,</span> <span class="n">icol</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ncols</span><span class="p">)</span>
                <span class="n">ebands</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="n">e0</span><span class="p">,</span> <span class="n">with_gaps</span><span class="o">=</span><span class="n">with_gaps</span><span class="p">,</span> <span class="n">max_phfreq</span><span class="o">=</span><span class="n">max_phfreq</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>
                <span class="c1"># This to handle with_gaps = True</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_title</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">title</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">irow</span><span class="p">,</span> <span class="n">icol</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">set_visible</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;ylabel&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Plot grid with bands + DOS. see http://matplotlib.org/users/gridspec.html</span>
            <span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="kn">import</span> <span class="n">GridSpec</span><span class="p">,</span> <span class="n">GridSpecFromSubplotSpec</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">gspec</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ebands</span><span class="p">,</span> <span class="n">edos</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ebands_list</span><span class="p">,</span> <span class="n">edos_list</span><span class="p">)):</span>
                <span class="n">subgrid</span> <span class="o">=</span> <span class="n">GridSpecFromSubplotSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">subplot_spec</span><span class="o">=</span><span class="n">gspec</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
                <span class="c1"># Get axes and align bands and DOS.</span>
                <span class="n">ax0</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">subgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">subgrid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax0</span><span class="p">)</span>
                <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax0</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>
                <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

                <span class="c1"># Define the zero of energy and plot</span>
                <span class="n">mye0</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span> <span class="k">if</span> <span class="n">e0</span> <span class="o">!=</span> <span class="s2">&quot;edos_fermie&quot;</span> <span class="k">else</span> <span class="n">edos</span><span class="o">.</span><span class="n">fermie</span>
                <span class="n">ebands</span><span class="o">.</span><span class="n">plot_with_edos</span><span class="p">(</span><span class="n">edos</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="n">mye0</span><span class="p">,</span> <span class="n">ax_list</span><span class="o">=</span><span class="p">(</span><span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span><span class="p">),</span> <span class="n">with_gaps</span><span class="o">=</span><span class="n">with_gaps</span><span class="p">,</span>
                                      <span class="n">max_phfreq</span><span class="o">=</span><span class="n">max_phfreq</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="c1"># This to handle with_gaps = True</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">ax0</span><span class="o">.</span><span class="n">get_title</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">title</span><span class="p">:</span> <span class="n">ax0</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">ncols</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span><span class="p">):</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="ElectronBandsPlotter.boxplot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBandsPlotter.boxplot">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">boxplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">brange</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">swarm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use seaborn_ to draw a box plot to show distributions of eigenvalues with respect to the band index.</span>
<span class="sd">        Band structures are drawn on different subplots.</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - ``fermie``: shift all eigenvalues to have zero energy at the Fermi energy (`self.fermie`).</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">            brange: Only bands such as ``brange[0] &lt;= band_index &lt; brange[1]`` are included in the plot.</span>
<span class="sd">            swarm: True to show the datapoints on top of the boxes</span>
<span class="sd">            fontsize: Fontsize for title.</span>
<span class="sd">            kwargs: Keyword arguments passed to seaborn boxplot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Build grid of plots.</span>
        <span class="n">num_plots</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">nrows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">num_plots</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_plots</span> <span class="o">//</span> <span class="n">ncols</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_plots</span> <span class="o">%</span> <span class="n">ncols</span><span class="p">)</span>

        <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                                <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax_list</span> <span class="o">=</span> <span class="n">ax_list</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="c1"># don&#39;t show the last ax if numeb is odd.</span>
        <span class="k">if</span> <span class="n">num_plots</span> <span class="o">%</span> <span class="n">ncols</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ax_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">ebands</span><span class="p">),</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">ax_list</span><span class="p">):</span>
            <span class="n">ebands</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">brange</span><span class="o">=</span><span class="n">brange</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="ElectronBandsPlotter.combiboxplot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBandsPlotter.combiboxplot">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">combiboxplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">brange</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">swarm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use seaborn_ to draw a box plot comparing the distributions of the eigenvalues</span>
<span class="sd">        Band structures are drawn on the same plot.</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - ``fermie``: shift all eigenvalues to have zero energy at the Fermi energy (`self.fermie`).</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>

<span class="sd">            brange: Only bands such as ``brange[0] &lt;= band_index &lt; brange[1]`` are included in the plot.</span>
<span class="sd">            swarm: True to show the datapoints on top of the boxes</span>
<span class="sd">            ax: |matplotlib-Axes| or None if a new figure should be created.</span>
<span class="sd">            kwargs: Keyword arguments passed to seaborn boxplot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spin_polarized</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">frames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">ebands</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Get the dataframe, select bands and add column with label</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">get_dataframe</span><span class="p">(</span><span class="n">e0</span><span class="o">=</span><span class="n">e0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">brange</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[(</span><span class="n">frame</span><span class="p">[</span><span class="s2">&quot;band&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">brange</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">frame</span><span class="p">[</span><span class="s2">&quot;band&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">brange</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="n">frame</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>
            <span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ebands</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="n">spin_polarized</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Merge frames ignoring index (not meaningful)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">frames</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">spin_polarized</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;eig&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">swarm</span><span class="p">:</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">swarmplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;eig&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;.25&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Generate two subplots for spin-up / spin-down channels.</span>
            <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
            <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;ax == None not implemented when nsppol==2&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax_list</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">spin</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">ax_list</span><span class="o">.</span><span class="n">ravel</span><span class="p">()):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">data_spin</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;spin&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">spin</span><span class="p">]</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;eig&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_spin</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">swarm</span><span class="p">:</span>
                    <span class="n">sns</span><span class="o">.</span><span class="n">swarmplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;eig&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_spin</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;.25&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="ElectronBandsPlotter.plot_band_edges"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBandsPlotter.plot_band_edges">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_band_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">epad_ev</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">set_fermie_to_vbm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the band edges for electrons and holes on two separated plots for all ebands in ebands_dict.</span>
<span class="sd">        Useful for comparing band structures obtained with/without SOC or bands obtained with different settings.</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - ``fermie``: shift all eigenvalues to have zero energy at the Fermi energy (`self.fermie`).</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">            epad_ev: Add this energy window in eV above VBM and below CBM.</span>
<span class="sd">            set_fermie_to_vbm: True if Fermi energy should be recomputed and fixed at max occupied energy level.</span>
<span class="sd">            colormap: matplotlib colormap.</span>
<span class="sd">            fontsize: legend and title fontsize.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Two subplots for CBM and VBM</span>
        <span class="n">num_plots</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">nrows</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
        <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                                <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax_list</span> <span class="o">=</span> <span class="n">ax_list</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>
        <span class="n">nb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ax_list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">iband</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">ebands</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">set_fermie_to_vbm</span><span class="p">:</span>
                    <span class="c1"># This is needed when the fermi energy is computed in the GS part</span>
                    <span class="c1"># with a mesh that does not contain the band edges.</span>
                    <span class="n">ebands</span><span class="o">.</span><span class="n">set_fermie_to_vbm</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">ix</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Conduction</span>
                    <span class="n">ymin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">ebands</span><span class="o">.</span><span class="n">lumos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span><span class="o">.</span><span class="n">eig</span> <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="n">ebands</span><span class="o">.</span><span class="n">spins</span><span class="p">))</span> <span class="o">-</span> <span class="mf">0.1</span>
                    <span class="n">ymax</span> <span class="o">=</span> <span class="n">ymin</span> <span class="o">+</span> <span class="n">epad_ev</span>
                <span class="k">elif</span> <span class="n">ix</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Valence</span>
                    <span class="n">ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">ebands</span><span class="o">.</span><span class="n">homos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span><span class="o">.</span><span class="n">eig</span> <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="n">ebands</span><span class="o">.</span><span class="n">spins</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.1</span>
                    <span class="n">ymin</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">epad_ev</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wrong ix: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ix</span><span class="p">)</span>

                <span class="c1"># Defin ylims and energy shift.</span>
                <span class="n">this_e0</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
                <span class="n">ylims</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymin</span> <span class="o">-</span> <span class="n">this_e0</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">this_e0</span><span class="p">)</span>
                <span class="n">ebands</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="n">e0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">iband</span><span class="p">)</span> <span class="o">/</span> <span class="n">nb</span><span class="p">),</span> <span class="n">ylims</span><span class="o">=</span><span class="n">ylims</span><span class="p">,</span>
                            <span class="n">label</span><span class="o">=</span><span class="n">label</span> <span class="k">if</span> <span class="n">ix</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ix</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="ElectronBandsPlotter.animate"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBandsPlotter.animate">[docs]</a>    <span class="k">def</span> <span class="nf">animate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">savefile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use matplotlib_ to animate a list of band structure plots (with or without DOS).</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values::</span>

<span class="sd">                * ``fermie``: shift all eigenvalues and the DOS to have zero energy at the Fermi energy.</span>
<span class="sd">                   Note that, by default, the Fermi energy is taken from the band structure object</span>
<span class="sd">                   i.e. the Fermi energy computed at the end of the SCF file that produced the density.</span>
<span class="sd">                   See `edos_fermie`.</span>
<span class="sd">                * ``edos_fermie``: Use the Fermi energy computed from the DOS to define the zero of energy in both subplots.</span>
<span class="sd">                *  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                *  None: Don&#39;t shift energies, equivalent to e0=0</span>

<span class="sd">            interval: draws a new frame every interval milliseconds.</span>
<span class="sd">            savefile: Use e.g. &#39;myanimation.mp4&#39; to save the animation in mp4 format.</span>
<span class="sd">            width_ratios: Defines the ratio between the band structure plot and the dos plot.</span>
<span class="sd">                Used when there are DOS stored in the plotter.</span>
<span class="sd">            show: True if the animation should be shown immediately</span>

<span class="sd">        Returns: Animation object.</span>

<span class="sd">        .. See also::</span>

<span class="sd">            http://matplotlib.org/api/animation_api.html</span>
<span class="sd">            http://jakevdp.github.io/blog/2012/08/18/matplotlib-animation-tutorial/</span>

<span class="sd">        .. Note::</span>

<span class="sd">            It would be nice to animate the title of the plot, unfortunately</span>
<span class="sd">            this feature is not available in the present version of matplotlib.</span>
<span class="sd">            See: http://stackoverflow.com/questions/17558096/animated-title-in-matplotlib</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ebands_list</span><span class="p">,</span> <span class="n">edos_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edoses_list</span>
        <span class="k">if</span> <span class="n">edos_list</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">edos_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ebands_list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The number of objects for DOS must be equal to the number of bands&quot;</span><span class="p">)</span>
        <span class="c1">#titles = list(self.ebands_dict.keys())</span>

        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plotax_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">}</span>

        <span class="n">artists</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">edos_list</span><span class="p">:</span>
            <span class="c1"># Animation with band structures</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ebands_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decorate_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ebands</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ebands_list</span><span class="p">):</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="o">**</span><span class="n">plotax_kwargs</span><span class="p">)</span>
                <span class="c1">#if titles is not None: lines += [ax.set_title(titles[i])]</span>
                <span class="n">artists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Animation with band structures + DOS.</span>
            <span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="kn">import</span> <span class="n">GridSpec</span>
            <span class="n">gspec</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="n">width_ratios</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
            <span class="n">ax0</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax0</span><span class="p">)</span>
            <span class="n">ebands_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decorate_ax</span><span class="p">(</span><span class="n">ax0</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ebands</span><span class="p">,</span> <span class="n">edos</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ebands_list</span><span class="p">,</span> <span class="n">edos_list</span><span class="p">)):</span>
                <span class="c1"># Define the zero of energy to align bands and dos</span>
                <span class="n">mye0</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span> <span class="k">if</span> <span class="n">e0</span> <span class="o">!=</span> <span class="s2">&quot;edos_fermie&quot;</span> <span class="k">else</span> <span class="n">edos</span><span class="o">.</span><span class="n">fermie</span>
                <span class="n">ebands_lines</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax0</span><span class="p">,</span> <span class="n">mye0</span><span class="p">,</span> <span class="o">**</span><span class="n">plotax_kwargs</span><span class="p">)</span>
                <span class="n">edos_lines</span> <span class="o">=</span> <span class="n">edos</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">mye0</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">plotax_kwargs</span><span class="p">)</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">ebands_lines</span> <span class="o">+</span> <span class="n">edos_lines</span>
                <span class="c1">#if titles is not None: lines += [ax.set_title(titles[i])]</span>
                <span class="n">artists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">matplotlib.animation</span> <span class="k">as</span> <span class="nn">animation</span>
        <span class="n">anim</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">ArtistAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">artists</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span>
                                         <span class="n">blit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># True is faster but then the movie starts with an empty frame!</span>
                                         <span class="c1">#repeat_delay=1000</span>
                                         <span class="p">)</span>

        <span class="k">if</span> <span class="n">savefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">anim</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">savefile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">anim</span></div>

    <span class="k">def</span> <span class="nf">_repr_html_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Integration with jupyter_ notebooks.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ipw_select_plot</span><span class="p">()</span>

<div class="viewcode-block" id="ElectronBandsPlotter.ipw_select_plot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBandsPlotter.ipw_select_plot">[docs]</a>    <span class="k">def</span> <span class="nf">ipw_select_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an ipython widget with controllers to select the plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">plot_callback</span><span class="p">(</span><span class="n">plot_type</span><span class="p">,</span> <span class="n">e0</span><span class="p">):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_type</span><span class="p">)(</span><span class="n">e0</span><span class="o">=</span><span class="n">e0</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;animate&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="n">r</span>

        <span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">ipw</span>
        <span class="k">return</span> <span class="n">ipw</span><span class="o">.</span><span class="n">interact_manual</span><span class="p">(</span>
                <span class="n">plot_callback</span><span class="p">,</span>
                <span class="n">plot_type</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;combiplot&quot;</span><span class="p">,</span> <span class="s2">&quot;gridplot&quot;</span><span class="p">,</span> <span class="s2">&quot;boxplot&quot;</span><span class="p">,</span> <span class="s2">&quot;combiboxplot&quot;</span><span class="p">,</span> <span class="s2">&quot;animate&quot;</span><span class="p">],</span>
                <span class="n">e0</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="s2">&quot;0.0&quot;</span><span class="p">],</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="ElectronBandsPlotter.write_notebook"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronBandsPlotter.write_notebook">[docs]</a>    <span class="k">def</span> <span class="nf">write_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a jupyter_ notebook to ``nbpath``. If nbpath is None, a temporay file in the current</span>
<span class="sd">        working directory is created. Return path to the notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbformat</span><span class="p">,</span> <span class="n">nbv</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nbformat_nbv_nb</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Use pickle file for data persistence.</span>
        <span class="n">tmpfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickle_dump</span><span class="p">()</span>

        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="c1">#nbv.new_markdown_cell(&quot;# This is a markdown cell&quot;),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;plotter = abilab.ElectronBandsPlotter.pickle_load(&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="n">tmpfile</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;print(plotter)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;frame = plotter.get_ebands_frame()</span><span class="se">\n</span><span class="s2">display(frame)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;ylims = (None, None)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;plotter.gridplot(ylims=ylims);&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;plotter.combiplot(ylims=ylims);&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;plotter.boxplot();&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;plotter.combiboxplot();&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;if False: anim = plotter.animate()&quot;</span><span class="p">),</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_nb_nbpath</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nbpath</span><span class="p">)</span></div></div>

    <span class="c1">#def _can_use_basenames_as_labels(self):</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    Return True if all labels represent valid files and the basenames are unique</span>
    <span class="c1">#    In this case one can use the file basename instead of the full path in the plots.</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    if not all(os.path.exists(l) for l in self.ebands_dict): return False</span>
    <span class="c1">#    labels = [os.path.basename(l) for l in self.ebands_dict]</span>
    <span class="c1">#    return len(set(labels)) == len(labels)</span>


<span class="k">class</span> <span class="nc">ElectronsReader</span><span class="p">(</span><span class="n">ETSF_Reader</span><span class="p">,</span> <span class="n">KpointsReaderMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object reads band structure data from a netcdf_ file.</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: ElectronReader</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">read_ebands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an instance of |ElectronBands|. Main entry point for client code</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ebands</span> <span class="o">=</span> <span class="n">ElectronBands</span><span class="p">(</span>
            <span class="n">structure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_structure</span><span class="p">(),</span>
            <span class="n">kpoints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_kpoints</span><span class="p">(),</span>
            <span class="n">eigens</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_eigenvalues</span><span class="p">(),</span>
            <span class="n">fermie</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_fermie</span><span class="p">(),</span>
            <span class="n">occfacts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_occupations</span><span class="p">(),</span>
            <span class="n">nelect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_nelect</span><span class="p">(),</span>
            <span class="n">nspinor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_nspinor</span><span class="p">(),</span>
            <span class="n">nspden</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_nspden</span><span class="p">(),</span>
            <span class="n">nband_sk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_nband_sk</span><span class="p">(),</span>
            <span class="n">smearing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_smearing</span><span class="p">(),</span>
            <span class="p">)</span>

        <span class="c1"># This is to solve the typical problem in semiconductors that shows up</span>
        <span class="c1"># when the Fermi level from the GS run computed with a shifted k-mesh</span>
        <span class="c1"># underestimates the CBM at Gamma.</span>
        <span class="c1">#if ebands.nsppol == 1 and ebands.nspden == 1 and</span>
        <span class="k">if</span> <span class="n">ebands</span><span class="o">.</span><span class="n">smearing</span><span class="o">.</span><span class="n">occopt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ebands</span><span class="o">.</span><span class="n">set_fermie_to_vbm</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">ebands</span>

    <span class="k">def</span> <span class="nf">read_nband_sk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;|numpy-array| with the number of bands indexed by [s, k].&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;number_of_states&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_nspinor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of spinors.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_dimvalue</span><span class="p">(</span><span class="s2">&quot;number_of_spinor_components&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_nsppol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of independent spins (collinear case).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_dimvalue</span><span class="p">(</span><span class="s2">&quot;number_of_spins&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_nspden</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of spin-density components&quot;&quot;&quot;</span>
        <span class="c1"># FIXME: default 1 is needed for SIGRES files (abinit8)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_dimvalue</span><span class="p">(</span><span class="s2">&quot;number_of_components&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_tsmear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;smearing_width&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_eigenvalues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Eigenvalues in eV.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">units</span><span class="o">.</span><span class="n">ArrayWithUnit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;eigenvalues&quot;</span><span class="p">),</span> <span class="s2">&quot;Ha&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;eV&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_occupations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Occupancies.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;occupations&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_fermie</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fermi level in eV.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">units</span><span class="o">.</span><span class="n">Energy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;fermi_energy&quot;</span><span class="p">),</span> <span class="s2">&quot;Ha&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;eV&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_nelect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of valence electrons.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;number_of_electrons&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_smearing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a :class:`Smearing` instance with info on the smearing technique.&quot;&quot;&quot;</span>
        <span class="n">occopt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;occopt&quot;</span><span class="p">))</span>
        <span class="n">scheme</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_string</span><span class="p">(</span><span class="s2">&quot;smearing_scheme&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Smearing</span><span class="p">(</span>
            <span class="n">scheme</span><span class="o">=</span><span class="n">scheme</span><span class="p">,</span>
            <span class="n">occopt</span><span class="o">=</span><span class="n">occopt</span><span class="p">,</span>
            <span class="n">tsmear_ev</span><span class="o">=</span><span class="n">units</span><span class="o">.</span><span class="n">Energy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;smearing_width&quot;</span><span class="p">),</span> <span class="s2">&quot;Ha&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;eV&quot;</span><span class="p">)</span>
        <span class="p">)</span>


<div class="viewcode-block" id="ElectronDos"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDos">[docs]</a><span class="k">class</span> <span class="nc">ElectronDos</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object stores the electronic density of states.</span>
<span class="sd">    It is usually created by calling the get_edos method of |ElectronBands|.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">spin_dos</span><span class="p">,</span> <span class="n">nelect</span><span class="p">,</span> <span class="n">fermie</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spin_idos</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            mesh: array-like object with the mesh points in eV.</span>
<span class="sd">            spin_dos: array-like object with the DOS for the different spins (even if spin-unpolarized calculation).</span>
<span class="sd">                Shape is:</span>
<span class="sd">                      (1, nw) if spin-unpolarized.</span>
<span class="sd">                      (2, nw) if spin-polarized.</span>
<span class="sd">            nelect: Number of electrons in the unit cell.</span>
<span class="sd">            fermie: Fermi level in eV. If None, fermie is obtained from the idos integral.</span>
<span class="sd">            spin_idos: array-like object with the IDOS for the different spins (even if spin-unpolarized calculation).</span>
<span class="sd">                Shape is:</span>
<span class="sd">                      (1, nw) if spin-unpolarized.</span>
<span class="sd">                      (2, nw) if spin-polarized case.</span>

<span class="sd">                This argument is usually used when we have an IDOS computed with a more accurate method e.g.</span>
<span class="sd">                tetrahedron integration so that we can use these values instead of integrating the input DOS.</span>

<span class="sd">        .. note::</span>

<span class="sd">            mesh is given in eV, spin_dos is in states/eV.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spin_dos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">spin_dos</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spin_dos</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span> <span class="o">=</span> <span class="n">nelect</span>
        <span class="k">if</span> <span class="n">spin_idos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spin_idos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">spin_idos</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">spin_idos</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span>

        <span class="c1"># Save DOS and IDOS for each spin.</span>
        <span class="n">sumv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spin_dos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_idos</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ispin</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spin_dos</span><span class="p">):</span>
            <span class="n">sumv</span> <span class="o">+=</span> <span class="n">values</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">Function1D</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spin_dos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="c1"># Compute IDOS or take it from spin_idos.</span>
            <span class="k">if</span> <span class="n">spin_idos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spin_idos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">integral</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spin_idos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Function1D</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">spin_idos</span><span class="p">[</span><span class="n">ispin</span><span class="p">]))</span>

        <span class="c1"># Total DOS and IDOS.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">sumv</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">sumv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tot_dos</span> <span class="o">=</span> <span class="n">Function1D</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">sumv</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spin_idos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Compute IDOS from DOS</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tot_idos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_dos</span><span class="o">.</span><span class="n">integral</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get IDOS from input (e.g. tetra)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">sumv</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">spin_idos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="n">sumv</span> <span class="o">=</span> <span class="n">spin_idos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">spin_idos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tot_idos</span> <span class="o">=</span> <span class="n">Function1D</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">sumv</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fermie</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fermie</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># *Compute* fermie from nelect. Note that this value may differ</span>
            <span class="c1"># from the one stored in ElectronBands (coming from the SCF run)</span>
            <span class="c1"># The accuracy of self.fermie depends on the number of k-points used for the DOS</span>
            <span class="c1"># and the parameters used to call ebands.get_edos.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_mu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nelect</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;tot_idos values:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_idos</span><span class="p">)</span>
                <span class="k">raise</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

<div class="viewcode-block" id="ElectronDos.to_string"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDos.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;nsppol: </span><span class="si">%d</span><span class="s2">, nelect: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nelect</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Fermi energy: </span><span class="si">%s</span><span class="s2"> (eV) (recomputed from nelect):&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronDos.as_edos"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDos.as_edos">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">as_edos</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">edos_kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an instance of |ElectronDos| from a generic object ``obj``.</span>
<span class="sd">        Supports:</span>

<span class="sd">            - instances of cls</span>
<span class="sd">            - files (string) that can be open with abiopen and that provide an `ebands` attribute.</span>
<span class="sd">            - objects providing an `ebands` or `get_edos` attribute</span>

<span class="sd">        Args:</span>
<span class="sd">            edos_kwargs: optional dictionary with the options passed to `get_edos` to compute the electron DOS.</span>
<span class="sd">            Used when obj is not already an instance of ``cls``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">edos_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">edos_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obj</span>
        <span class="k">elif</span> <span class="n">is_string</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="c1"># path?</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pickle&quot;</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">as_edos</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">),</span> <span class="n">edos_kwargs</span><span class="p">)</span>

            <span class="kn">from</span> <span class="nn">abipy.abilab</span> <span class="kn">import</span> <span class="n">abiopen</span>
            <span class="k">with</span> <span class="n">abiopen</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="k">as</span> <span class="n">abifile</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">abifile</span><span class="p">,</span> <span class="s2">&quot;ebands&quot;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">abifile</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">get_edos</span><span class="p">(</span><span class="o">**</span><span class="n">edos_kwargs</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">abifile</span><span class="p">,</span> <span class="s2">&quot;edos&quot;</span><span class="p">):</span>
                    <span class="c1"># This to handle e.g. the _EDOS file.</span>
                    <span class="k">return</span> <span class="n">abifile</span><span class="o">.</span><span class="n">edos</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know how to extract ElectronDos object from: `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>

        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;ebands&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">get_edos</span><span class="p">(</span><span class="o">**</span><span class="n">edos_kwargs</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;get_edos&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_edos</span><span class="p">(</span><span class="o">**</span><span class="n">edos_kwargs</span><span class="p">)</span>

        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know how to create `ElectronDos` from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">nsppol</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">f1</span><span class="p">,</span> <span class="n">f2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spin_dos</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">spin_dos</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">f1</span> <span class="o">!=</span> <span class="n">f2</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span>

<div class="viewcode-block" id="ElectronDos.dos_idos"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDos.dos_idos">[docs]</a>    <span class="k">def</span> <span class="nf">dos_idos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns DOS and IDOS for given spin. Total DOS and IDOS if spin is None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">spin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_dos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_idos</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dos</span><span class="p">[</span><span class="n">spin</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_idos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span></div>

<div class="viewcode-block" id="ElectronDos.find_mu"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDos.find_mu">[docs]</a>    <span class="k">def</span> <span class="nf">find_mu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nelect</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds the chemical potential given the number of electrons.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">idos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_idos</span> <span class="k">if</span> <span class="n">spin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_idos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span>

        <span class="c1"># Cannot use bisection because DOS might be negative due to smearing.</span>
        <span class="c1"># This one is safer albeit slower.</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ene</span><span class="p">,</span> <span class="n">intg</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idos</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">intg</span> <span class="o">&gt;</span> <span class="n">nelect</span><span class="p">:</span> <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If the mesh is not large enough, we never cross nelect</span>
            <span class="c1"># If the last point in IDOS is sufficiently close to nelect</span>
            <span class="c1"># use it as Fermi level.</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">idos</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">nelect</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-3</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idos</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot find I(e) such that I(e) &gt; nelect&quot;</span><span class="p">)</span>

        <span class="c1"># Use linear interpolation to find mu (useful if mesh is coarse)</span>
        <span class="n">e0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">idos</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">e1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">idos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">e1</span> <span class="o">-</span> <span class="n">e0</span><span class="p">)</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">e0</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="p">(</span><span class="n">nelect</span> <span class="o">-</span> <span class="n">beta</span><span class="p">)</span> <span class="o">/</span> <span class="n">alpha</span>
        <span class="c1">#print(&quot;idos[i-1]:&quot;, idos[i-1], &quot;idos[i]:&quot;, idos[i], &quot;intg&quot;, intg, &quot;nelect&quot;, nelect)</span>
        <span class="c1">#print(&quot;mu linear&quot;, mu)</span>
        <span class="k">return</span> <span class="n">mu</span></div>

<div class="viewcode-block" id="ElectronDos.up_minus_down"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDos.up_minus_down">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">up_minus_down</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function1D with dos_up - dos_down</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># DOH!</span>
            <span class="k">return</span> <span class="n">Function1D</span><span class="o">.</span><span class="n">from_constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spin_dos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div>

<div class="viewcode-block" id="ElectronDos.get_e0"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDos.get_e0">[docs]</a>    <span class="k">def</span> <span class="nf">get_e0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - `fermie`: shift all eigenvalues to have zero energy at the Fermi energy (`self.fermie`).</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">e0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="k">elif</span> <span class="n">is_string</span><span class="p">(</span><span class="n">e0</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">e0</span> <span class="o">==</span> <span class="s2">&quot;fermie&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span>
            <span class="k">elif</span> <span class="n">e0</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">0.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Wrong value for e0: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Assume number</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronDos.plot_ax"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDos.plot_ax">[docs]</a>    <span class="k">def</span> <span class="nf">plot_ax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;dos&quot;</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to plot the DOS data on the matplotlib axis ``ax``.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: |matplotlib-Axes|.</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot.</span>
<span class="sd">            spin: selects the spin component, None for total DOS, IDOS.</span>
<span class="sd">            what: string selecting what will be plotted. &quot;dos&quot; for DOS, &quot;idos&quot; for IDOS</span>
<span class="sd">            fact: Multiplication factor for DOS/IDOS. Usually +-1 for spin DOS</span>
<span class="sd">            exchange_xy: True to exchange x-y axis.</span>
<span class="sd">            kwargs: Options passed to matplotlib ``ax.plot``</span>

<span class="sd">        Return: list of lines added to the axis ax.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dosf</span><span class="p">,</span> <span class="n">idosf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dos_idos</span><span class="p">(</span><span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">)</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>

        <span class="n">w2f</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;dos&quot;</span><span class="p">:</span> <span class="n">dosf</span><span class="p">,</span> <span class="s2">&quot;idos&quot;</span><span class="p">:</span> <span class="n">idosf</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">what</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">w2f</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown value for what: `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">what</span><span class="p">))</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">w2f</span><span class="p">[</span><span class="n">what</span><span class="p">]</span>

        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">mesh</span> <span class="o">-</span> <span class="n">e0</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">fact</span>
        <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span><span class="p">,</span> <span class="n">xx</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">lines</span></div>

<div class="viewcode-block" id="ElectronDos.plotly_traces"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDos.plotly_traces">[docs]</a>    <span class="k">def</span> <span class="nf">plotly_traces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;dos&quot;</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rcd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trace_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                      <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">line_opts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to plot the DOS data on the ``fig`` with plotly.</span>

<span class="sd">        Args:</span>
<span class="sd">            fig: |plotly.graph_objects.Figure|.</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot.</span>
<span class="sd">            spin: selects the spin component, None for total DOS, IDOS.</span>
<span class="sd">            what: string selecting what will be plotted. &quot;dos&quot; for DOS, &quot;idos&quot; for IDOS</span>
<span class="sd">            fact: Multiplication factor for DOS/IDOS. Usually +-1 for spin DOS</span>
<span class="sd">            exchange_xy: True to exchange x-y axis.</span>
<span class="sd">            rcd: PlotlyRowColDesc object used to specify the (row, col) of the subplot in the grid.</span>
<span class="sd">            trace_name: Name of the trace.</span>
<span class="sd">            showlegend: Determines whether or not an item corresponding to this trace is shown in the legend.</span>
<span class="sd">            line_opts: Dict of options passed to |plotly.graph_objects.scatter.Line|</span>
<span class="sd">            kwargs: Options passed to fig.add_scatter method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dosf</span><span class="p">,</span> <span class="n">idosf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dos_idos</span><span class="p">(</span><span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">)</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>

        <span class="n">w2f</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;dos&quot;</span><span class="p">:</span> <span class="n">dosf</span><span class="p">,</span> <span class="s2">&quot;idos&quot;</span><span class="p">:</span> <span class="n">idosf</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">what</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">w2f</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown value for what: `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">what</span><span class="p">))</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">w2f</span><span class="p">[</span><span class="n">what</span><span class="p">]</span>

        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">mesh</span> <span class="o">-</span> <span class="n">e0</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">fact</span>
        <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span><span class="p">,</span> <span class="n">xx</span>
        <span class="n">rcd</span> <span class="o">=</span> <span class="n">PlotlyRowColDesc</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">rcd</span><span class="p">)</span>
        <span class="n">ply_row</span><span class="p">,</span> <span class="n">ply_col</span> <span class="o">=</span> <span class="n">rcd</span><span class="o">.</span><span class="n">ply_row</span><span class="p">,</span> <span class="n">rcd</span><span class="o">.</span><span class="n">ply_col</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xx</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">yy</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">trace_name</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="n">showlegend</span><span class="p">,</span>
                        <span class="n">line</span><span class="o">=</span><span class="n">line_opts</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="n">ply_row</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">ply_col</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronDos.plot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDos.plot">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot electronic DOS with matplotlib.</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - ``fermie``: shift all eigenvalues to have zero energy at the Fermi energy (``self.fermie``).</span>
<span class="sd">                - Number e.g ``e0 = 0.5``: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                - None: Don&#39;t shift energies, equivalent to ``e0 = 0``.</span>
<span class="sd">            spin: Selects the spin component, None if total DOS is wanted.</span>
<span class="sd">            ax: |matplotlib-Axes| or None if a new figure should be created.</span>
<span class="sd">            exchange_xy: True to exchange x-y axis.</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                or scalar e.g. ``left``. If left (right) is None, default values are used</span>
<span class="sd">            ylims: Set data limits for the y-axis.</span>
<span class="sd">            kwargs: options passed to ``ax.plot``.</span>

<span class="sd">        Return: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
            <span class="n">opts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> \
                   <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">spin_sign</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span><span class="o">.</span><span class="n">mesh</span> <span class="o">-</span> <span class="n">e0</span><span class="p">,</span> <span class="n">spin_sign</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;Energy (eV)&#39;</span><span class="p">,</span> <span class="s1">&#39;DOS (states/eV)&#39;</span>
        <span class="n">set_ax_xylabels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="p">)</span>
        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="ElectronDos.plotly"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDos.plotly">[docs]</a>    <span class="nd">@add_plotly_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plotly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">trace_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot electronic DOS with plotly.</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - ``fermie``: shift all eigenvalues to have zero energy at the Fermi energy (``self.fermie``).</span>
<span class="sd">                - Number e.g ``e0 = 0.5``: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                - None: Don&#39;t shift energies, equivalent to ``e0 = 0``.</span>
<span class="sd">            spin: Selects the spin component, None if total DOS is wanted.</span>
<span class="sd">            fig: |plotly.graph_objects.Figure|.</span>
<span class="sd">            exchange_xy: True to exchange x-y axis.</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. ``(left, right)``.</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. ``(left, right)``.</span>
<span class="sd">            trace_name: Name of the trace.</span>
<span class="sd">            showlegend: Determines whether or not an item corresponding to this trace is shown in the legend.</span>
<span class="sd">            kwargs: Options passed to fig.add_scatter method.</span>

<span class="sd">        Return: |plotly.graph_objects.Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_fig_plotly</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
            <span class="n">opts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> \
                   <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span>
            <span class="c1"># opts.update(kwargs)</span>
            <span class="n">spin_sign</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span><span class="o">.</span><span class="n">mesh</span> <span class="o">-</span> <span class="n">e0</span><span class="p">,</span> <span class="n">spin_sign</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dos</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">trace_name</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="n">showlegend</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">opts</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;Energy (eV)&#39;</span><span class="p">,</span> <span class="s1">&#39;DOS (states/eV)&#39;</span>
        <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">xlabel</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">xlabel</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">ylabel</span>
        <span class="n">plotly_set_lims</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">plotly_set_lims</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="ElectronDos.plot_dos_idos"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDos.plot_dos_idos">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_dos_idos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">ax_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot electronic DOS and Integrated DOS on two different subplots with matplotlib.</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - ``fermie``: shift all eigenvalues to have zero energy at the Fermi energy (``self.fermie``).</span>
<span class="sd">                -  Number e.g ``e0 = 0.5``: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to ``e0 = 0``.</span>
<span class="sd">            ax_list: The axes for the DOS and IDOS plot. If ax_list is None, a new figure</span>
<span class="sd">                is created and the two axes are automatically generated.</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                   or scalar e.g. ``left``. If left (right) is None, default values are used</span>
<span class="sd">            height_ratios:</span>
<span class="sd">            kwargs: options passed to ``plot_ax``</span>

<span class="sd">        Return: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="kn">import</span> <span class="n">GridSpec</span>

        <span class="k">if</span> <span class="n">ax_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">gspec</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="n">height_ratios</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
            <span class="n">ax0</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax0</span><span class="p">)</span>
            <span class="n">ax_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">ax_list</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>

            <span class="n">ax0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;TOT IDOS&quot;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;TOT DOS&quot;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Energy (eV)&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">ax_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
            <span class="n">opts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> \
                   <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="c1"># Plot Total dos if unpolarized.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">spin</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e0</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;idos&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">e0</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;dos&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="ElectronDos.plotly_dos_idos"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDos.plotly_dos_idos">[docs]</a>    <span class="nd">@add_plotly_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plotly_dos_idos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot electronic DOS and Integrated DOS on two different subplots with plotly.</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - ``fermie``: shift all eigenvalues to have zero energy at the Fermi energy (``self.fermie``).</span>
<span class="sd">                -  Number e.g ``e0 = 0.5``: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to ``e0 = 0``.</span>
<span class="sd">            fig: The |plotly.graph_objects.Figure| with two distinct plots for the DOS and IDOS plot.</span>
<span class="sd">                If fig is None, a new figure is created.</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. ``(left, right)``.</span>
<span class="sd">            height_ratios:</span>
<span class="sd">            kwargs: Options passed to plotly_traces method.</span>

<span class="sd">        Return: |plotly.graph_objects.Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_figs_plotly</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">vertical_spacing</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">row_heights</span><span class="o">=</span><span class="n">height_ratios</span><span class="p">)</span>
            <span class="n">plotly_set_lims</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;yaxis1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s2">&quot;TOT IDOS&quot;</span><span class="p">}</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;yaxis2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s2">&quot;TOT DOS&quot;</span><span class="p">}</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;xaxis2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;Energy (eV)&#39;</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
            <span class="n">opts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> \
                   <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span>
            <span class="c1"># Plot Total dos if unpolarized.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">spin</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">rcd</span> <span class="o">=</span> <span class="n">PlotlyRowColDesc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotly_traces</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;idos&quot;</span><span class="p">,</span> <span class="n">rcd</span><span class="o">=</span><span class="n">rcd</span><span class="p">,</span> <span class="n">line_opts</span><span class="o">=</span><span class="n">opts</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">rcd</span> <span class="o">=</span> <span class="n">PlotlyRowColDesc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotly_traces</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;dos&quot;</span><span class="p">,</span> <span class="n">rcd</span><span class="o">=</span><span class="n">rcd</span><span class="p">,</span>  <span class="n">line_opts</span><span class="o">=</span><span class="n">opts</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="ElectronDos.plot_up_minus_down"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDos.plot_up_minus_down">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_up_minus_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot Dos_up - Dow_down with matplotlib.</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - ``fermie``: shift all eigenvalues to have zero energy at the Fermi energy (``self.fermie``).</span>
<span class="sd">                -  Number e.g ``e0 = 0.5``: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to ``e0 = 0``</span>
<span class="sd">            ax: |matplotlib-Axes| or None if a new figure should be created.</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                   or scalar e.g. ``left``. If left (right) is None, default values are used</span>
<span class="sd">            kwargs: options passed to ``ax.plot``.</span>

<span class="sd">        Return: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dos_diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">up_minus_down</span>
        <span class="n">idos_diff</span> <span class="o">=</span> <span class="n">dos_diff</span><span class="o">.</span><span class="n">integral</span><span class="p">()</span>

        <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span>

        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dos_diff</span><span class="o">.</span><span class="n">mesh</span> <span class="o">-</span> <span class="n">e0</span><span class="p">,</span> <span class="n">dos_diff</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">idos_diff</span><span class="o">.</span><span class="n">mesh</span> <span class="o">-</span> <span class="n">e0</span><span class="p">,</span> <span class="n">idos_diff</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Dos_up - Dos_down (states/eV)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Energy (eV)&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="ElectronDos.plotly_up_minus_down"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDos.plotly_up_minus_down">[docs]</a>    <span class="nd">@add_plotly_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plotly_up_minus_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot Dos_up - Dow_down with plotly.</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - ``fermie``: shift all eigenvalues to have zero energy at the Fermi energy (``self.fermie``).</span>
<span class="sd">                -  Number e.g ``e0 = 0.5``: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to ``e0 = 0``</span>
<span class="sd">            fig: |plotly.graph_objects.Figure| or None if a new figure should be created.</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. ``(left, right)``.</span>
<span class="sd">            kwargs: Options passed to fig.add_scatter method.</span>

<span class="sd">        Return: |plotly.graph_objects.Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dos_diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">up_minus_down</span>
        <span class="n">idos_diff</span> <span class="o">=</span> <span class="n">dos_diff</span><span class="o">.</span><span class="n">integral</span><span class="p">()</span>

        <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">line_opts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_fig_plotly</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">dos_diff</span><span class="o">.</span><span class="n">mesh</span> <span class="o">-</span> <span class="n">e0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">dos_diff</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;DOS&#39;</span><span class="p">,</span><span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">line</span><span class="o">=</span><span class="n">line_opts</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">idos_diff</span><span class="o">.</span><span class="n">mesh</span> <span class="o">-</span> <span class="n">e0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">idos_diff</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;IDOS&#39;</span><span class="p">,</span><span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">line</span><span class="o">=</span><span class="n">line_opts</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">plotly_set_lims</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Energy (eV)&#39;</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Dos_up - Dos_down (states/eV)&#39;</span>

        <span class="k">return</span> <span class="n">fig</span></div></div>


<div class="viewcode-block" id="ElectronDosPlotter"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDosPlotter">[docs]</a><span class="k">class</span> <span class="nc">ElectronDosPlotter</span><span class="p">(</span><span class="n">NotebookWriter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for plotting multiple electronic DOSes.</span>

<span class="sd">    Usage example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        plotter = ElectronDosPlotter()</span>
<span class="sd">        plotter.add_edos(&quot;foo dos&quot;, &quot;foo.nc&quot;)</span>
<span class="sd">        plotter.add_edos(&quot;bar dos&quot;, &quot;bar.nc&quot;)</span>
<span class="sd">        fig = plotter.gridplot()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: down-up option animate?</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_edos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">edos_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key_edos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">key_edos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">key_edos</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">ElectronDos</span><span class="o">.</span><span class="n">as_edos</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">edos_kwargs</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">key_edos</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">key_edos</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">edos_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of DOSes&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

<div class="viewcode-block" id="ElectronDosPlotter.add_edos"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDosPlotter.add_edos">[docs]</a>    <span class="k">def</span> <span class="nf">add_edos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">edos</span><span class="p">,</span> <span class="n">edos_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a DOS for plotting.</span>

<span class="sd">        Args:</span>
<span class="sd">            label: label for the DOS. Must be unique.</span>
<span class="sd">            edos: |ElectronDos| object.</span>
<span class="sd">            edos_kwargs: optional dictionary with the options passed to ``get_edos`` to compute the electron DOS.</span>
<span class="sd">                Used only if ``edos`` is not an ElectronDos instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;label </span><span class="si">%s</span><span class="s2"> is already in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">ElectronDos</span><span class="o">.</span><span class="n">as_edos</span><span class="p">(</span><span class="n">edos</span><span class="p">,</span> <span class="n">edos_kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronDosPlotter.combiplot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDosPlotter.combiplot">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">combiplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what_list</span><span class="o">=</span><span class="s2">&quot;dos&quot;</span><span class="p">,</span> <span class="n">spin_mode</span><span class="o">=</span><span class="s2">&quot;automatic&quot;</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span>
                  <span class="n">ax_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the the DOSes on the same figure. Use ``gridplot`` to plot DOSes on different figures.</span>

<span class="sd">        Args:</span>
<span class="sd">            what_list: Selects quantities to plot e.g. [&quot;dos&quot;, &quot;idos&quot;] to plot DOS and integrated DOS.</span>
<span class="sd">                &quot;dos&quot; for DOS only and &quot;idos&quot; for IDOS only</span>
<span class="sd">            spin_mode: &quot;total&quot; for total (I)DOS, &quot;resolved&quot; for plotting individual contributions.</span>
<span class="sd">                Meaningful only if nsppol == 2.</span>
<span class="sd">                &quot;automatic&quot; to use &quot;resolved&quot; if at least one DOS is polarized.</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - ``fermie``: shift all eigenvalues to have zero energy at the Fermi energy (``self.fermie``).</span>
<span class="sd">                -  Number e.g ``e0 = 0.5``: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to ``e0 = 0``</span>
<span class="sd">            ax_list: List of |matplotlib-Axes| or None if a new figure should be created.</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                   or scalar e.g. ``left``. If left (right) is None, default values are used</span>
<span class="sd">            fontsize (int): fontsize for titles and legend</span>

<span class="sd">        Return: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">spin_mode</span> <span class="o">==</span> <span class="s2">&quot;automatic&quot;</span><span class="p">:</span>
            <span class="n">spin_mode</span> <span class="o">=</span> <span class="s2">&quot;resolved&quot;</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">edos</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">edos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">else</span> <span class="s2">&quot;total&quot;</span>

        <span class="n">what_list</span> <span class="o">=</span> <span class="n">list_strings</span><span class="p">(</span><span class="n">what_list</span><span class="p">)</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">what_list</span><span class="p">),</span> <span class="mi">1</span>
        <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="n">ax_list</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                                <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax_list</span> <span class="o">=</span> <span class="n">ax_list</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="n">can_use_basename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_can_use_basenames_as_labels</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">what_list</span><span class="p">,</span> <span class="n">ax_list</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">edos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">can_use_basename</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Use relative paths if label is a file.</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">label</span><span class="p">):</span> <span class="n">label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

                <span class="c1"># Here I handle spin and spin_mode.</span>
                <span class="k">if</span> <span class="n">edos</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">spin_mode</span> <span class="o">==</span> <span class="s2">&quot;total&quot;</span><span class="p">:</span>
                    <span class="c1"># Plot total values</span>
                    <span class="n">edos</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="n">what</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">spin_mode</span> <span class="o">==</span> <span class="s2">&quot;resolved&quot;</span><span class="p">:</span>
                    <span class="c1"># Plot spin resolved quantiies with sign.</span>
                    <span class="c1"># Note get_color to have same color for both spins.</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">edos</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                        <span class="n">fact</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="n">lines</span> <span class="o">=</span> <span class="n">edos</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="n">what</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="n">fact</span><span class="p">,</span>
                            <span class="n">color</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">(),</span>
                            <span class="n">label</span><span class="o">=</span><span class="n">label</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wrong value for spin_mode: `</span><span class="si">%s</span><span class="s2">`:&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">spin_mode</span><span class="p">))</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">what_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Energy (eV)&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;DOS (states/eV)&#39;</span> <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;dos&quot;</span> <span class="k">else</span> <span class="s2">&quot;IDOS&quot;</span><span class="p">)</span>
            <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="c1"># An alias for combiplot.</span>
    <span class="n">plot</span> <span class="o">=</span> <span class="n">combiplot</span>

<div class="viewcode-block" id="ElectronDosPlotter.gridplot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDosPlotter.gridplot">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">gridplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;dos&quot;</span><span class="p">,</span> <span class="n">spin_mode</span><span class="o">=</span><span class="s2">&quot;automatic&quot;</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span>
                 <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot multiple DOSes on a grid.</span>

<span class="sd">        Args:</span>
<span class="sd">            what: &quot;dos&quot; to plot DOS, &quot;idos&quot; for integrated DOS.</span>
<span class="sd">            spin_mode: &quot;total&quot; for total (I)DOS, &quot;resolved&quot; for plotting individual contributions.</span>
<span class="sd">                Meaningful only if nsppol == 2.</span>
<span class="sd">                &quot;automatic&quot; to use &quot;resolved&quot; if at least one DOS is polarized.</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values::</span>

<span class="sd">                - ``fermie``: shift all eigenvalues and the DOS to have zero energy at the Fermi energy.</span>
<span class="sd">                   Note that, by default, the Fermi energy is taken from the band structure object</span>
<span class="sd">                   i.e. the Fermi energy computed at the end of the SCF file that produced the density.</span>
<span class="sd">                   This should be ok in semiconductors. In metals, however, a better value of the Fermi energy</span>
<span class="sd">                   can be obtained from the DOS provided that the k-sampling for the DOS is much denser than</span>
<span class="sd">                   the one used to compute the density. See ``edos_fermie``.</span>
<span class="sd">                - ``edos_fermie``: Use the Fermi energy computed from the DOS to define the zero of energy in both subplots.</span>
<span class="sd">                   Available only if edos_objects is not None</span>
<span class="sd">                -  Number e.g ``e0 = 0.5``: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to ``e0 = 0``.</span>

<span class="sd">            sharex, sharey: True if x (y) axis should be shared.</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                   or scalar e.g. ``left``. If left (right) is None, default values are used</span>
<span class="sd">            fontsize: Label and title fontsize.</span>

<span class="sd">        Return: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">spin_mode</span> <span class="o">==</span> <span class="s2">&quot;automatic&quot;</span><span class="p">:</span>
            <span class="n">spin_mode</span> <span class="o">=</span> <span class="s2">&quot;resolved&quot;</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">edos</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">edos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">else</span> <span class="s2">&quot;total&quot;</span>

        <span class="n">titles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">edos_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edos_list</span>

        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
        <span class="n">numeb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">edos_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">numeb</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="n">numeb</span> <span class="o">//</span> <span class="n">ncols</span> <span class="o">+</span> <span class="n">numeb</span> <span class="o">%</span> <span class="n">ncols</span>

        <span class="c1"># Build Grid</span>
        <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                                <span class="n">sharex</span><span class="o">=</span><span class="n">sharex</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">sharey</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax_list</span> <span class="o">=</span> <span class="n">ax_list</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="c1"># don&#39;t show the last ax if numeb is odd.</span>
        <span class="k">if</span> <span class="n">numeb</span> <span class="o">%</span> <span class="n">ncols</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ax_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">((</span><span class="n">label</span><span class="p">,</span> <span class="n">edos</span><span class="p">),</span> <span class="n">ax</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">ax_list</span><span class="p">)):</span>
            <span class="n">irow</span><span class="p">,</span> <span class="n">icol</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ncols</span><span class="p">)</span>

            <span class="c1"># Here I handle spin and spin_mode.</span>
            <span class="k">if</span> <span class="n">edos</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">spin_mode</span> <span class="o">==</span> <span class="s2">&quot;total&quot;</span><span class="p">:</span>
                <span class="n">opts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span>
                <span class="n">edos</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="n">e0</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="n">what</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">spin_mode</span> <span class="o">==</span> <span class="s2">&quot;resolved&quot;</span><span class="p">:</span>
                <span class="c1"># Plot spin resolved quantiies with sign.</span>
                <span class="c1"># Note get_color to have same color for both spins.</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">edos</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                    <span class="n">fact</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="n">edos</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="n">what</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="n">fact</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">(),</span>
                        <span class="n">label</span><span class="o">=</span><span class="n">label</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wrong value for spin_mode: `</span><span class="si">%s</span><span class="s2">`:&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">spin_mode</span><span class="p">))</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">irow</span><span class="p">,</span> <span class="n">icol</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;DOS (states/eV)&#39;</span> <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;dos&quot;</span> <span class="k">else</span> <span class="s2">&quot;IDOS&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">irow</span> <span class="o">==</span> <span class="n">nrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Energy (eV)&quot;</span><span class="p">)</span>

            <span class="c1">#ax.legend(loc=&quot;best&quot;, shadow=True, fontsize=fontsize)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="ElectronDosPlotter.ipw_select_plot"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDosPlotter.ipw_select_plot">[docs]</a>    <span class="k">def</span> <span class="nf">ipw_select_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an ipython widget with controllers to select the plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">plot_callback</span><span class="p">(</span><span class="n">plot_type</span><span class="p">,</span> <span class="n">e0</span><span class="p">):</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_type</span><span class="p">)(</span><span class="n">e0</span><span class="o">=</span><span class="n">e0</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">ipw</span>
        <span class="k">return</span> <span class="n">ipw</span><span class="o">.</span><span class="n">interact_manual</span><span class="p">(</span>
                <span class="n">plot_callback</span><span class="p">,</span>
                <span class="n">plot_type</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;combiplot&quot;</span><span class="p">,</span> <span class="s2">&quot;gridplot&quot;</span><span class="p">],</span>
                <span class="n">e0</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="s2">&quot;0.0&quot;</span><span class="p">],</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="ElectronDosPlotter.yield_figs"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDosPlotter.yield_figs">[docs]</a>    <span class="k">def</span> <span class="nf">yield_figs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function *generates* a predefined list of matplotlib figures with minimal input from the user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">combiplot</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">gridplot</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="ElectronDosPlotter.write_notebook"><a class="viewcode-back" href="../../../api/electrons_api.html#abipy.electrons.ebands.ElectronDosPlotter.write_notebook">[docs]</a>    <span class="k">def</span> <span class="nf">write_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a jupyter_ notebook to nbpath. If nbpath is None, a temporay file in the current</span>
<span class="sd">        working directory is created. Return path to the notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbformat</span><span class="p">,</span> <span class="n">nbv</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nbformat_nbv_nb</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Use pickle files for data persistence.</span>
        <span class="n">tmpfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickle_dump</span><span class="p">()</span>

        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_markdown_cell</span><span class="p">(</span><span class="s2">&quot;# This is a markdown cell&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;plotter = abilab.ElectronDosPlotter.pickle_load(&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="n">tmpfile</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;print(plotter)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;xlims = (None, None)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;plotter.combiplot(xlims=xlims);&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;plotter.gridplot(xlims=xlims);&quot;</span><span class="p">),</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_nb_nbpath</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nbpath</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_can_use_basenames_as_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return True if all labels represent valid files and the basenames are unique</span>
<span class="sd">        In this case one can use the file basename instead of the full path in the plots.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="p">):</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edoses_dict</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">Bands3D</span><span class="p">(</span><span class="n">Has_Structure</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">ibz</span><span class="p">,</span> <span class="n">has_timrev</span><span class="p">,</span> <span class="n">eigens</span><span class="p">,</span> <span class="n">fermie</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This object reconstructs by symmetry the eigenvalues in the full BZ starting from the IBZ.</span>
<span class="sd">        Provides methods to extract and visualize isosurfaces.</span>

<span class="sd">        Args:</span>
<span class="sd">            structure:</span>
<span class="sd">            ibz:</span>
<span class="sd">            has_timrev:</span>
<span class="sd">            eigens:</span>
<span class="sd">            fermie</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ibz</span> <span class="o">=</span> <span class="n">ibz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span> <span class="o">=</span> <span class="n">structure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reciprocal_lattice</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">reciprocal_lattice</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_timrev</span> <span class="o">=</span> <span class="n">has_timrev</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span> <span class="o">=</span> <span class="n">fermie</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_3d</span><span class="p">(</span><span class="n">eigens</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nband</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># Sanity check.</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">eapp</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">append</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibz</span><span class="o">.</span><span class="n">is_ibz</span><span class="p">:</span>
            <span class="n">eapp</span><span class="p">(</span><span class="s2">&quot;Expecting an IBZ sampling but got </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ibz</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibz</span><span class="o">.</span><span class="n">is_mpmesh</span><span class="p">:</span>
            <span class="n">eapp</span><span class="p">(</span><span class="s2">&quot;Monkhorst-Pack meshes are required.</span><span class="se">\n</span><span class="s2">ksampling: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ibz</span><span class="o">.</span><span class="n">ksampling</span><span class="p">))</span>

        <span class="n">mpdivs</span><span class="p">,</span> <span class="n">shifts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibz</span><span class="o">.</span><span class="n">mpdivs_shifts</span>
        <span class="k">if</span> <span class="n">shifts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">shifts</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">):</span>
            <span class="n">eapp</span><span class="p">(</span><span class="s2">&quot;Gamma-centered k-meshes are required by Xcrysden.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">))</span>

        <span class="c1"># Xcrysden requires points in the unit cell (C-order)</span>
        <span class="c1"># and the mesh must include the periodic images hence pbc=True.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uc2ibz</span> <span class="o">=</span> <span class="n">map_grid2ibz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibz</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">,</span> <span class="n">mpdivs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_timrev</span><span class="p">,</span> <span class="n">pbc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpdivs</span> <span class="o">=</span> <span class="n">mpdivs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kdivs</span> <span class="o">=</span> <span class="n">mpdivs</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">mpdivs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ucdata_shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nband</span><span class="p">)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kdivs</span><span class="p">)</span>
        <span class="c1">#self.ibzdata_shape = (self.nsppol, self.nband, len(self.ibz))</span>

        <span class="c1"># Construct energy bands on unit cell grid: e_{TSk} = e_{k}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ucdata_sbk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_ibz_scalars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ucell_scalars</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ucell_vectors</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="c1">#if reference_sb is None:</span>
        <span class="c1">#self.reference_sb = [[] for _ in self.spins]</span>
        <span class="c1">#for spin in self.spins:</span>
        <span class="c1">#    self.reference_sb[spin] = {band: band for band in self.bands}</span>
        <span class="c1">#else:</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;|Structure| object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span>

    <span class="c1"># Handy variables used to loop</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nband</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
        <span class="c1"># TODO: Finalize implementation</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Structure&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_ucell_scalars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">scalars</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add scalar quantities given in the unit cell.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: keyword used to store scalars.</span>
<span class="sd">            scalars:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ucell_scalars</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">scalars</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ucdata_shape</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_ibz_scalars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">scalars</span><span class="p">,</span> <span class="n">inshape</span><span class="o">=</span><span class="s2">&quot;skb&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add scalar quantities given in the IBZ i.e. symmetrize values to get array in unit cell.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: keyword used to store symmetrized values.</span>
<span class="sd">            scalars: scalars in IBZ. See ``inshape`` for shape</span>
<span class="sd">            inshape: shape of input scalars. &quot;skb&quot; if (nsppol, nkibz, nband)</span>
<span class="sd">            &quot;sbk&quot; for (nsppol, nband, nkibz).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_ucell_scalars</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_ibz_scalars</span><span class="p">(</span><span class="n">scalars</span><span class="p">,</span> <span class="n">inshape</span><span class="o">=</span><span class="n">inshape</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">symmetrize_ibz_scalars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalars</span><span class="p">,</span> <span class="n">inshape</span><span class="o">=</span><span class="s2">&quot;skb&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Symmetrize scalar quantities given in the IBZ.</span>

<span class="sd">        Args:</span>
<span class="sd">            scalars: scalars in IBZ. See `inshape` for shape</span>
<span class="sd">            inshape: shape of input scalars. &quot;skb&quot; if (nsppol, nkibz, nband)</span>
<span class="sd">            &quot;sbk&quot; for (nsppol, nband, nkibz).</span>

<span class="sd">        Return:</span>
<span class="sd">            |numpy-array| with scalars in unit cell. shape is **always**: (nsppol, nband, nkbz)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Symmetrize scalars unit cell grid: e_{TSk} = e_{k}</span>
        <span class="n">ucdata_sbk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nband</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uc2ibz</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">inshape</span> <span class="o">==</span> <span class="s2">&quot;skb&quot;</span><span class="p">:</span>
            <span class="n">scalars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">scalars</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ibz</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">nband</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">ikuc</span><span class="p">,</span> <span class="n">ik_ibz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uc2ibz</span><span class="p">):</span>
                <span class="n">ucdata_sbk</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">ikuc</span><span class="p">]</span> <span class="o">=</span> <span class="n">scalars</span><span class="p">[:,</span> <span class="n">ik_ibz</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">elif</span> <span class="n">inshape</span> <span class="o">==</span> <span class="s2">&quot;sbk&quot;</span><span class="p">:</span>
            <span class="n">scalars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">scalars</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nband</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ibz</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">ikuc</span><span class="p">,</span> <span class="n">ik_ibz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uc2ibz</span><span class="p">):</span>
                <span class="n">ucdata_sbk</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">ikuc</span><span class="p">]</span> <span class="o">=</span> <span class="n">scalars</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">ik_ibz</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wrong inshape: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">inshape</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">ucdata_sbk</span>

    <span class="c1">#def add_ucell_vectors(self, name, vectors, inshape=&quot;skb&quot;):</span>
    <span class="c1">#    self.ucell_vectors[name] = np.reshape(vectors, self.ucdata + (3,))</span>

    <span class="c1">#def add_ibz_vectors(self, name, scalars, inshape=&quot;skb&quot;)</span>
    <span class="c1">#    self.add_ucell_vectors(name, self.symmetrize_ibz_vectors(vectors, inshape=inshape))</span>

    <span class="c1">#def wsmap(self):</span>
        <span class="c1">#ws = -np.ones(ngkpt, dtype=np.int)</span>
        <span class="c1">#for i in range(ngkpt[0]):</span>
        <span class="c1">#    ki = (i - ngkpt[0] // 2)</span>
        <span class="c1">#    if ki &lt; 0: ki += ngkpt[0]</span>
        <span class="c1">#    for j in range(ngkpt[1]):</span>
        <span class="c1">#        kj = (j - ngkpt[1] // 2)</span>
        <span class="c1">#        if kj &lt; 0: kj += ngkpt[1]</span>
        <span class="c1">#        for k in range(ngkpt[2]):</span>
        <span class="c1">#            kz = (k - ngkpt[2] // 2)</span>
        <span class="c1">#            if kz &lt; 0: kz += ngkpt[2]</span>
        <span class="c1">#            #bzgrid2ibz[gp_bz[0], gp_bz[1], gp_bz[2]] = ik_ibz</span>
        <span class="c1">#            ws[i, j, k] = bzgrid2ibz[ki, kj, kz]</span>
        <span class="c1">#bzgrid2ibz = ws</span>

    <span class="k">def</span> <span class="nf">get_isobands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return index of the bands crossing ``e0``in eV. None if no band is found.&quot;&quot;&quot;</span>
        <span class="n">isobands</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bands</span><span class="p">:</span>
                <span class="n">emin</span><span class="p">,</span> <span class="n">emax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="p">:,</span> <span class="n">band</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigens</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="p">:,</span> <span class="n">band</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">isobands</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span> <span class="ow">and</span> <span class="n">e0</span> <span class="o">&gt;</span> <span class="n">emax</span><span class="p">:</span> <span class="k">break</span>
                <span class="k">if</span> <span class="n">emax</span> <span class="o">&gt;=</span> <span class="n">e0</span> <span class="o">&gt;=</span> <span class="n">emin</span><span class="p">:</span> <span class="n">isobands</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="ow">not</span> <span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">isobands</span><span class="p">):</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">isobands</span>

    <span class="k">def</span> <span class="nf">xcrysden_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Visualize electron energy isosurfaces with xcrysden_.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">tmp_filepath</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.bxsf&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Producing BXSF file in:&quot;</span><span class="p">,</span> <span class="n">tmp_filepath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to_bxsf</span><span class="p">(</span><span class="n">tmp_filepath</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">abipy.iotools.visualizer</span> <span class="kn">import</span> <span class="n">Xcrysden</span>
        <span class="k">return</span> <span class="n">Xcrysden</span><span class="p">(</span><span class="n">tmp_filepath</span><span class="p">)()</span>

    <span class="k">def</span> <span class="nf">to_bxsf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export the full band structure to ``filepath`` in BXSF format</span>
<span class="sd">        suitable for the visualization of the Fermi surface with xcrysden_ (use ``xcrysden --bxsf FILE``).</span>
<span class="sd">        Require k-points in IBZ and gamma-centered k-mesh.</span>

<span class="sd">        Args:</span>
<span class="sd">            filepath: BXSF filename or stream.</span>
<span class="sd">            unit: Input energies are in unit ``unit``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">abipy.iotools</span> <span class="kn">import</span> <span class="n">bxsf_write</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;write&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">bxsf_write</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nband</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kdivs</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">ucdata_sbk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">bxsf_write</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nband</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kdivs</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">ucdata_sbk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">filepath</span>

    <span class="k">def</span> <span class="nf">get_e0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - `fermie`: shift all eigenvalues to have zero energy at the Fermi energy (`self.fermie`).</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">e0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="k">elif</span> <span class="n">is_string</span><span class="p">(</span><span class="n">e0</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">e0</span> <span class="o">==</span> <span class="s2">&quot;fermie&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span>
            <span class="k">elif</span> <span class="n">e0</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">0.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wrong value for e0: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Assume number</span>
            <span class="k">return</span> <span class="n">e0</span>

    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_isosurfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot isosurface with matplotlib_</span>

<span class="sd">        .. warning::</span>

<span class="sd">            Requires scikit-image package, matplotlib rendering is usually slow.</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Isolevel in eV. Default: Fermi energy.</span>
<span class="sd">            verbose: verbosity level.</span>

<span class="sd">        Return: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">skimage.measure</span> <span class="kn">import</span> <span class="n">marching_cubes_lewiner</span> <span class="k">as</span> <span class="n">marching_cubes</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">skimage.measure</span> <span class="kn">import</span> <span class="n">marching_cubes</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;scikit-image not installed.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Please install with it with `conda install scikit-image` or `pip install scikit-image`&quot;</span><span class="p">)</span>

        <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
        <span class="n">isobands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_isobands</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">isobands</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Bands for isosurface:&quot;</span><span class="p">,</span> <span class="n">isobands</span><span class="p">)</span>

        <span class="c1">#from pymatgen.electronic_structure.plotter import plot_lattice_vectors, plot_wigner_seitz</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax3d_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">plot_unit_cell</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">#plot_wigner_seitz(self.reciprocal_lattice, ax=ax, color=&quot;k&quot;, linewidth=1)</span>

        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ib</span><span class="p">,</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">isobands</span><span class="p">[</span><span class="n">spin</span><span class="p">]):</span>
                <span class="c1"># From http://scikit-image.org/docs/stable/api/skimage.measure.html#marching-cubes</span>
                <span class="c1"># verts: (V, 3) array</span>
                <span class="c1">#   Spatial coordinates for V unique mesh vertices. Coordinate order matches input volume (M, N, P).</span>
                <span class="c1"># faces: (F, 3) array</span>
                <span class="c1">#   Define triangular faces via referencing vertex indices from verts.</span>
                <span class="c1">#   This algorithm specifically outputs triangles, so each face has exactly three indices.</span>
                <span class="c1"># normals: (V, 3) array</span>
                <span class="c1">#   The normal direction at each vertex, as calculated from the data.</span>
                <span class="c1"># values: (V, ) array</span>
                <span class="c1">#   Gives a measure for the maximum value of the data in the local region near each vertex.</span>
                <span class="c1">#   This can be used by visualization tools to apply a colormap to the mesh</span>
                <span class="n">voldata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ucdata_sbk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">kdivs</span><span class="p">)</span>
                <span class="n">verts</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="n">normals</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">marching_cubes</span><span class="p">(</span><span class="n">voldata</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">e0</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="p">))</span>
                <span class="c1">#verts, faces, normals, values = marching_cubes_lewiner(voldata, level=e0, spacing=tuple(self.spacing))</span>
                <span class="n">verts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="o">.</span><span class="n">get_cartesian_coords</span><span class="p">(</span><span class="n">verts</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">cmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ib</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">isobands</span><span class="p">[</span><span class="n">spin</span><span class="p">]))</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">plot_trisurf</span><span class="p">(</span><span class="n">verts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">verts</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">faces</span><span class="p">,</span> <span class="n">verts</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="c1">#, cmap=&#39;Spectral&#39;, lw=1, antialiased=True)</span>

                <span class="c1"># mayavi package:</span>
                <span class="c1">#mlab.triangular_mesh([v[0] for v in verts], [v[1] for v in verts], [v[2] for v in verts], faces)</span>
                <span class="c1">#, color=(0, 0, 0))</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span> <span class="nf">mvplot_isosurfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot isosurface with mayavi_</span>

<span class="sd">        Args:</span>
<span class="sd">            e0:</span>
<span class="sd">            verbose:</span>
<span class="sd">            show:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Find bands crossing e0.</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
        <span class="n">isobands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_isobands</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">isobands</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Bands for isosurface:&quot;</span><span class="p">,</span> <span class="n">isobands</span><span class="p">)</span>

        <span class="c1">#from pymatgen.electronic_structure.plotter import plot_fermi_surface</span>
        <span class="c1">#spin, band = 0, 4</span>
        <span class="c1">#for i, band in enumerate(isobands[spin]):</span>
        <span class="c1">#data = np.reshape(isoenes[0][band], mpdivs + 1 if pbc else mpdivs)</span>
        <span class="c1">#plot_fermi_surface(data, self.structure, False, energy_levels=[e0]) interative=not (i == len(isobands[spin]) - 1))</span>

        <span class="c1"># Plot isosurface with mayavi.</span>
        <span class="kn">from</span> <span class="nn">abipy.display</span> <span class="kn">import</span> <span class="n">mvtk</span>
        <span class="n">figure</span><span class="p">,</span> <span class="n">mlab</span> <span class="o">=</span> <span class="n">mvtk</span><span class="o">.</span><span class="n">get_fig_mlab</span><span class="p">(</span><span class="n">figure</span><span class="o">=</span><span class="n">figure</span><span class="p">)</span>
        <span class="n">mvtk</span><span class="o">.</span><span class="n">plot_unit_cell</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">figure</span><span class="p">)</span>
        <span class="n">mvtk</span><span class="o">.</span><span class="n">plot_wigner_seitz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">figure</span><span class="p">)</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="o">.</span><span class="n">matrix</span>

        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spins</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">isobands</span><span class="p">[</span><span class="n">spin</span><span class="p">]:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ucdata_sbk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">kdivs</span><span class="p">)</span>
                <span class="n">cp</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">contour3d</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">contours</span><span class="o">=</span><span class="p">[</span><span class="n">e0</span><span class="p">],</span> <span class="n">transparent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="c1">#colormap=&#39;hot&#39;, color=(0, 0, 1), opacity=1.0, figure=figure)</span>
                                    <span class="n">colormap</span><span class="o">=</span><span class="s1">&#39;Set3&#39;</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">figure</span><span class="p">)</span>

                <span class="n">polydata</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">actors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">input</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">polydata</span><span class="o">.</span><span class="n">points</span><span class="p">)</span> <span class="c1">#  - 1  # TODO this + mpdivs should be correct</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;shape:&quot;</span><span class="p">,</span> <span class="n">pts</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">pts</span><span class="p">)</span>
                <span class="n">polydata</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">cell</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
                <span class="c1">#polydata.points = np.dot(pts, cell / np.array(self.mpdivs)[:, np.newaxis])</span>
                <span class="n">mlab</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">distance</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">figure</span><span class="p">)</span>

        <span class="c1"># Add k-point labels.</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">k</span><span class="o">.</span><span class="n">frac_coords</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">hsym_kpoints</span><span class="p">}</span>
        <span class="n">mvtk</span><span class="o">.</span><span class="n">plot_labels</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">lattice</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">figure</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">show</span><span class="p">:</span> <span class="n">mlab</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">figure</span>

    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_contour</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">plane</span><span class="o">=</span><span class="s2">&quot;xy&quot;</span><span class="p">,</span> <span class="n">elevation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Contour plot with matplotlib.</span>

<span class="sd">        Args:</span>
<span class="sd">            band: Band index</span>
<span class="sd">            spin: Spin index.</span>
<span class="sd">            plane:</span>
<span class="sd">            elevation:</span>
<span class="sd">            ax: |matplotlib-Axes| or None if a new figure should be created.</span>
<span class="sd">            fontsize: Label and title fontsize.</span>

<span class="sd">        Return: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ucdata_sbk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">kdivs</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kdivs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kdivs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kdivs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kdivs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">fxy</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">elevation</span><span class="p">]</span>

        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fxy</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">kvert</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">xy</span><span class="o">=</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="n">xz</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">yz</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">)[</span><span class="n">plane</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Band </span><span class="si">%s</span><span class="s2"> in </span><span class="si">%s</span><span class="s2"> plane at $K_{</span><span class="si">%s</span><span class="s2">}=</span><span class="si">%d</span><span class="s2">$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">kvert</span><span class="p">,</span> <span class="n">elevation</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$K_</span><span class="si">%s</span><span class="s2">$&quot;</span> <span class="o">%</span> <span class="n">plane</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$K_</span><span class="si">%s</span><span class="s2">$&quot;</span> <span class="o">%</span> <span class="n">plane</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">fig</span>

    <span class="c1">#def interpolate(self, densify_mpdivs):</span>
        <span class="c1">#densify_mpdivs = np.array(densify_mpdivs)</span>
        <span class="c1">#if np.any(densify_mpdivs &gt; 1):</span>
        <span class="c1">#dense_mpdivs = densify_mpdivs * mpdivs</span>
        <span class="c1">#dense_kpts = kmesh_from_mpdivs(dense_mpdivs, shifts=(0, 0, 0), pbc=pbc, order=&quot;unit_cell&quot;)</span>
        <span class="c1">#from scipy.interpolate import RegularGridInterpolator</span>
        <span class="c1">#x = np.arange(0, mpdivs[0] + 1) / mpdivs[0]</span>
        <span class="c1">#y = np.arange(0, mpdivs[1] + 1) / mpdivs[1]</span>
        <span class="c1">#z = np.arange(0, mpdivs[2] + 1) / mpdivs[2]</span>
        <span class="c1">#for spin in self.spins:</span>
        <span class="c1">#    for band in isobands[spin]:</span>
        <span class="c1">#        interp = RegularGridInterpolator((x, y, z), isoenes[spin][band], method=&#39;linear&#39;)</span>
        <span class="c1">#        isoenes[spin][band] = interp(dense_mpdivs)</span>

    <span class="c1">#def mvplot_surf(self):</span>
        <span class="c1">#spin, band = 0, 2</span>
        <span class="c1">#data = np.reshape(isoenes[spin][band], mpdivs + 1 if pbc else mpdivs)</span>
        <span class="c1">#x, y = np.arange(data.shape[0]), np.arange(data.shape[1])</span>
        <span class="c1">#cp = mlab.surf(x, y, data[0,:,:], figure=figure)</span>
        <span class="c1">#polydata = cp.actor.actors[0].mapper.input</span>
        <span class="c1">#pts = np.array(polydata.points) # - 1</span>
        <span class="c1">#xs, ys, zs = pts.T</span>
        <span class="c1">#print(pts.shape)</span>
        <span class="c1">#print(zs)</span>
        <span class="c1">#polydata.points = np.dot(pts, cell / np.array(data.shape)[:, np.newaxis])</span>

        <span class="c1">#data = np.reshape(isoenes[spin][band+1], mpdivs + 1 if pbc else mpdivs)</span>
        <span class="c1">#cp = mlab.surf(x, y, data[0,:,:], figure=figure)</span>
        <span class="c1">#polydata = cp.actor.actors[0].mapper.input</span>
        <span class="c1">#pts = np.array(polydata.points) # - 1</span>
        <span class="c1">#polydata.points = np.dot(pts, cell / np.array(data.shape)[:, np.newaxis])</span>
        <span class="c1">#mlab.view(distance=&quot;auto&quot;, figure=figure)</span>
        <span class="c1">#if show: mlab.show()</span>
        <span class="c1">#return</span>

    <span class="k">def</span> <span class="nf">mvplot_cutplanes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;Plot cutplanes with mayavi_.&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ucdata_sbk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">band</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">kdivs</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fermie</span>
        <span class="n">contours</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>

        <span class="kn">from</span> <span class="nn">abipy.display</span> <span class="kn">import</span> <span class="n">mvtk</span>
        <span class="n">figure</span><span class="p">,</span> <span class="n">mlab</span> <span class="o">=</span> <span class="n">mvtk</span><span class="o">.</span><span class="n">get_fig_mlab</span><span class="p">(</span><span class="n">figure</span><span class="o">=</span><span class="n">figure</span><span class="p">)</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">scalar_field</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="n">mlab</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">image_plane_widget</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">plane_orientation</span><span class="o">=</span><span class="s1">&#39;x_axes&#39;</span><span class="p">,</span> <span class="n">slice_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kdivs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">mlab</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">image_plane_widget</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">plane_orientation</span><span class="o">=</span><span class="s1">&#39;y_axes&#39;</span><span class="p">,</span> <span class="n">slice_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kdivs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">mlab</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">image_plane_widget</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">plane_orientation</span><span class="o">=</span><span class="s1">&#39;z_axes&#39;</span><span class="p">,</span> <span class="n">slice_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kdivs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">mlab</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">iso_surface</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">contours</span><span class="o">=</span><span class="n">contours</span><span class="p">)</span> <span class="c1">#, opacity=0.1)</span>
        <span class="c1">#mlab.pipeline.iso_surface(src, contours=[data.min()+ 0.1 * data.ptp()], opacity=0.1)</span>
        <span class="n">mlab</span><span class="o">.</span><span class="n">outline</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">show</span><span class="p">:</span> <span class="n">mlab</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">figure</span>

    <span class="c1">#def write_data(self, workdir, fmt=&quot;cube&quot;, rmdir=False)</span>


<span class="k">class</span> <span class="nc">ElectronBands3D</span><span class="p">(</span><span class="n">Bands3D</span><span class="p">):</span>
    <span class="k">pass</span>
    <span class="c1">#def make_fermisurfer_dir(self, workdir)</span>

<span class="c1">#class PhononBands3D(Bands3D):</span>
<span class="c1">#    pass</span>


<span class="k">class</span> <span class="nc">RobotWithEbands</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mixin class for robots associated to files with |ElectronBands|.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">combiplot_ebands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wraps combiplot method of |ElectronBandsPlotter|. kwargs passed to combiplot.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ebands_plotter</span><span class="p">()</span><span class="o">.</span><span class="n">combiplot</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">gridplot_ebands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wraps gridplot method of |ElectronBandsPlotter|. kwargs passed to gridplot.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ebands_plotter</span><span class="p">()</span><span class="o">.</span><span class="n">gridplot</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">boxplot_ebands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wraps boxplot method of |ElectronBandsPlotter|. kwargs passed to boxplot.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ebands_plotter</span><span class="p">()</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">combiboxplot_ebands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wraps combiboxplot method of |ElectronDosPlotter|. kwargs passed to combiboxplot.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ebands_plotter</span><span class="p">()</span><span class="o">.</span><span class="n">combiboxplot</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">combiplot_edos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wraps combiplot method of |ElectronDosPlotter|. kwargs passed to combiplot.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_edos_plotter</span><span class="p">()</span><span class="o">.</span><span class="n">combiplot</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">gridplot_edos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wraps gridplot method of |ElectronDosPlotter|. kwargs passed to gridplot.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_edos_plotter</span><span class="p">()</span><span class="o">.</span><span class="n">gridplot</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_ebands_plotter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kselect</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_abifile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build and return an instance of |ElectronBandsPlotter| or a subclass if ``cls`` is not None.</span>

<span class="sd">        Args:</span>
<span class="sd">            kselect (str): Used to select particula `ebands`.</span>
<span class="sd">                &quot;path&quot; to select bands given on a k-path, &quot;ibz&quot; for bands with IBZ sampling.</span>
<span class="sd">                None has not effect</span>
<span class="sd">            filter_abifile: Function that receives an ``abifile`` object and returns</span>
<span class="sd">                True if the file should be added to the plotter.</span>
<span class="sd">            cls: subclass of |ElectronBandsPlotter|.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plotter</span> <span class="o">=</span> <span class="n">ElectronBandsPlotter</span><span class="p">()</span> <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">cls</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">abifile</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">filter_abifile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">filter_abifile</span><span class="p">(</span><span class="n">abifile</span><span class="p">):</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="n">kselect</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">kselect</span> <span class="o">==</span> <span class="s2">&quot;path&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">abifile</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">is_path</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="n">kselect</span> <span class="o">==</span> <span class="s2">&quot;ibz&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">abifile</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">is_ibz</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">add_ebands</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">abifile</span><span class="o">.</span><span class="n">ebands</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">plotter</span>

    <span class="k">def</span> <span class="nf">get_edos_plotter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_abifile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build and return an instance of |ElectronDosPlotter| or a subclass is cls is not None.</span>

<span class="sd">        Args:</span>
<span class="sd">            filter_abifile: Function that receives an ``abifile` object and returns</span>
<span class="sd">                True if the file should be added to the plotter.</span>
<span class="sd">            cls: subclass of |ElectronDosPlotter|.</span>
<span class="sd">            kwargs: Arguments passed to ebands.get_edos</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plotter</span> <span class="o">=</span> <span class="n">ElectronDosPlotter</span><span class="p">()</span> <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">cls</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">abifile</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">filter_abifile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">filter_abifile</span><span class="p">(</span><span class="n">abifile</span><span class="p">):</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">abifile</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">is_ibz</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Skipping </span><span class="si">%s</span><span class="s2"> because kpoint sampling not IBZ&quot;</span> <span class="o">%</span> <span class="n">abifile</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;magenta&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">add_edos</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">abifile</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">get_edos</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">plotter</span>

    <span class="c1">#def get_ebands_dataframe(self, with_spglib=True):</span>
    <span class="c1">#    return dataframe_from_ebands(self.ncfiles, index=list(self.keys()), with_spglib=with_spglib)</span>

    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_egaps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the convergence of the direct and fundamental gaps</span>
<span class="sd">        wrt to the ``sortby`` parameter. Values can optionally be grouped by ``hue``.</span>

<span class="sd">        Args:</span>
<span class="sd">            sortby: Define the convergence parameter, sort files and produce plot labels.</span>
<span class="sd">                Can be None, string or function. If None, no sorting is performed.</span>
<span class="sd">                If string and not empty it&#39;s assumed that the abifile has an attribute</span>
<span class="sd">                with the same name and `getattr` is invoked.</span>
<span class="sd">                If callable, the output of sortby(abifile) is used.</span>
<span class="sd">            hue: Variable that define subsets of the data, which will be drawn on separate lines.</span>
<span class="sd">                Accepts callable or string</span>
<span class="sd">                If string, it&#39;s assumed that the abifile has an attribute with the same name and getattr is invoked.</span>
<span class="sd">                If callable, the output of hue(abifile) is used.</span>
<span class="sd">            fontsize: legend and label fontsize.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Note: Handling nsppol &gt; 1 and the case in which we have abifiles with different nsppol is a bit tricky</span>
        <span class="c1"># hence we have to handle the different cases explicitly (see get_xy)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="n">max_nsppol</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">nsppol</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">)</span>

        <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fundamental_gaps&quot;</span><span class="p">,</span> <span class="s2">&quot;direct_gaps&quot;</span><span class="p">,</span> <span class="s2">&quot;bandwidths&quot;</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">get_xy</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">all_xvals</span><span class="p">,</span> <span class="n">all_abifiles</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Extract (xvals, yvals) from all_abifiles for given (item, spin) and initial all_xvals.</span>
<span class="sd">            Here we handle the case in which we have files with different nsppol.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">xvals</span><span class="p">,</span> <span class="n">yvals</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">af</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_abifiles</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">spin</span> <span class="o">&gt;</span> <span class="n">af</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">xvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_xvals</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
                    <span class="n">yy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">(</span><span class="n">af</span><span class="o">.</span><span class="n">ebands</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">yy</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">af</span><span class="o">.</span><span class="n">ebands</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;fundamental_gaps&quot;</span><span class="p">,</span> <span class="s2">&quot;direct_gaps&quot;</span><span class="p">):</span>
                        <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span><span class="o">.</span><span class="n">energy</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span>

                <span class="n">yvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">xvals</span><span class="p">,</span> <span class="n">yvals</span>

        <span class="c1"># Build grid plot.</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">),</span> <span class="mi">1</span>
        <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                                <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax_list</span> <span class="o">=</span> <span class="n">ax_list</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="c1"># Sort and group files if hue.</span>
        <span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">labels</span><span class="p">,</span> <span class="n">ncfiles</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="n">sortby</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_and_sortby</span><span class="p">(</span><span class="n">hue</span><span class="p">,</span> <span class="n">sortby</span><span class="p">)</span>

        <span class="n">marker_spin</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;v&quot;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ax_list</span><span class="p">,</span> <span class="n">items</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_nsppol</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Extract data.</span>
                    <span class="n">xvals</span><span class="p">,</span> <span class="n">yvals</span> <span class="o">=</span> <span class="n">get_xy</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_string</span><span class="p">(</span><span class="n">xvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">yvals</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">marker_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Must handle list of strings in a different way.</span>
                        <span class="n">xn</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xvals</span><span class="p">))</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xn</span><span class="p">,</span> <span class="n">yvals</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">marker_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xn</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                        <span class="c1"># Extract data.</span>
                        <span class="n">xvals</span><span class="p">,</span> <span class="n">yvals</span> <span class="o">=</span> <span class="n">get_xy</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">xvalues</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">abifiles</span><span class="p">)</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_label</span><span class="p">(</span><span class="n">hue</span><span class="p">),</span> <span class="n">g</span><span class="o">.</span><span class="n">hvalue</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">yvals</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">marker_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_label</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_label</span><span class="p">(</span><span class="n">sortby</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">sortby</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">rotate_ticklabels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span> <span class="nf">get_ebands_code_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of notebook cells.&quot;&quot;&quot;</span>
        <span class="n">nbformat</span><span class="p">,</span> <span class="n">nbv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nbformat_nbv</span><span class="p">()</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;## Code to compare multiple ElectronBands objects&quot;</span> <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="c1"># Try not pollute namespace with lots of variables.</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_markdown_cell</span><span class="p">(</span><span class="n">title</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;robot.get_ebands_plotter().ipw_select_plot();&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;robot.get_edos_plotter().ipw_select_plot();&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;#robot.plot_egaps(sorby=None, hue=None);&quot;</span><span class="p">),</span>
        <span class="p">]</span>

    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">gridplot_with_hue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hue</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot multiple electron bandstructures on a grid. Group bands by ``hue``.</span>

<span class="sd">        Example:</span>

<span class="sd">            robot.gridplot_with_hue(&quot;nkpt&quot;)</span>

<span class="sd">        Args:</span>
<span class="sd">            hue: Variable that define subsets of the phonon bands, which will be drawn on separate plots.</span>
<span class="sd">                Accepts callable or string</span>
<span class="sd">                If string, it&#39;s assumed that `abifile has an attribute with the same name and getattr is invoked.</span>
<span class="sd">                Dot notation is also supported e.g. hue=&quot;structure.formula&quot; --&gt; abifile.structure.formula</span>
<span class="sd">                If callable, the output of hue(abifile) is used.</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                or scalar e.g. `left`. If left (right) is None, default values are used</span>
<span class="sd">            fontsize: legend and title fontsize.</span>
<span class="sd">            sharex, sharey: True if X and Y axes should be shared.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Group abifiles by hue.</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_and_sortby</span><span class="p">(</span><span class="n">hue</span><span class="p">,</span> <span class="n">func_or_string</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">),</span> <span class="mi">1</span>

        <span class="c1"># Plot grid with phonon bands only.</span>
        <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                                <span class="n">sharex</span><span class="o">=</span><span class="n">sharex</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">sharey</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax_list</span> <span class="o">=</span> <span class="n">ax_list</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="s2">&quot;fermie&quot;</span>  <span class="c1"># Each ebands is aligned with respect to its Fermi energy.</span>

        <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">grp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ax_list</span><span class="p">,</span> <span class="n">groups</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ebands_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">abifile</span><span class="o">.</span><span class="n">ebands</span> <span class="k">for</span> <span class="n">abifile</span> <span class="ow">in</span> <span class="n">grp</span><span class="o">.</span><span class="n">abifiles</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_label</span><span class="p">(</span><span class="n">hue</span><span class="p">),</span> <span class="n">grp</span><span class="o">.</span><span class="n">hvalue</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

            <span class="n">nkpt_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ebands</span><span class="o">.</span><span class="n">nkpt</span> <span class="k">for</span> <span class="n">ebands</span> <span class="ow">in</span> <span class="n">ebands_list</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">nk</span> <span class="o">!=</span> <span class="n">nkpt_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">nk</span> <span class="ow">in</span> <span class="n">nkpt_list</span><span class="p">):</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;WARNING: Bands have different number of k-points:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">nkpt_list</span><span class="p">),</span> <span class="s2">&quot;yellow&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ebands</span><span class="p">,</span> <span class="n">lineopts</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ebands_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_lineopt</span><span class="p">())):</span>
                <span class="c1"># Plot all branches with lineopts and set the label of the last line produced.</span>
                <span class="n">ebands</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="o">**</span><span class="n">lineopts</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">grp</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

                <span class="c1"># Set ticks and labels</span>
                <span class="c1"># (NB: we do this only for the first ebands, in principle ebands</span>
                <span class="c1"># in the group could have different k-points but there&#39;s need to be so strict here.</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ebands</span><span class="o">.</span><span class="n">decorate_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">klabels</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

            <span class="c1"># Set legends.</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>


<span class="kn">from</span> <span class="nn">abipy.core.mixins</span> <span class="kn">import</span> <span class="n">TextFile</span> <span class="c1">#, AbinitNcFile, NotebookWriter</span>
<span class="kn">from</span> <span class="nn">abipy.abio.robots</span> <span class="kn">import</span> <span class="n">Robot</span>


<span class="k">def</span> <span class="nf">find_yaml_section_in_lines</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>

    <span class="n">magic</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;--- !</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">in_doc</span><span class="p">,</span> <span class="n">buf</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="s2">&quot;#&quot;</span><span class="p">:</span> <span class="k">break</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>

        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">magic</span><span class="p">):</span>
            <span class="n">in_doc</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">in_doc</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">):</span>
            <span class="n">in_doc</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="n">in_doc</span><span class="p">:</span>
            <span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">buf</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot fine Yaml tag: `</span><span class="si">{</span><span class="n">magic</span><span class="si">}</span><span class="s2">`&quot;</span><span class="p">)</span>

    <span class="kn">import</span> <span class="nn">ruamel.yaml</span> <span class="k">as</span> <span class="nn">yaml</span>
    <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">EdosFile</span><span class="p">(</span><span class="n">TextFile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object provides an interface to the _EDOS file</span>
<span class="sd">    (electron DOS usually computed with the tetrahedron method).</span>
<span class="sd">    The EdosFile has an ElectronDos edos object.</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: EdosFile</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parses the EDOS file and construct self.edos object.&quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

        <span class="c1"># Fortran implementation (eV units). See edos_write in m_ebands.F90.</span>
        <span class="c1">#</span>
        <span class="c1"># write(unt,&quot;(a)&quot;)&quot;# Energy           DOS_TOT          IDOS_TOT         DOS[spin=UP]     IDOS[spin=UP] ...&quot;</span>
        <span class="c1"># do iw=1,edos%nw</span>
        <span class="c1">#   write(unt,&#39;(es17.8)&#39;,advance=&#39;no&#39;)(edos%mesh(iw) - efermi) * cfact</span>
        <span class="c1">#   do spin=0,edos%nsppol</span>
        <span class="c1">#     write(unt,&#39;(2es17.8)&#39;,advance=&#39;no&#39;)max(edos%dos(iw,spin) / cfact, tol30), max(edos%idos(iw,spin), tol30)</span>
        <span class="c1">#   end do</span>
        <span class="c1">#   write(unt,*)</span>
        <span class="c1"># end do</span>

        <span class="n">header</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
                <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">header_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edos_params</span> <span class="o">=</span> <span class="n">find_yaml_section_in_lines</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="s2">&quot;EDOS_PARAMS&quot;</span><span class="p">)</span>
        <span class="c1">#print(self.edos_params)</span>
        <span class="n">nelect</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edos_params</span><span class="p">[</span><span class="s2">&quot;nelect&quot;</span><span class="p">])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="c1"># Spin unpolarized case.</span>
            <span class="n">spin_dos</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">spin_idos</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
            <span class="c1"># Spin unpolarized case.</span>
            <span class="n">spin_dos</span> <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]]</span>
            <span class="n">spin_idos</span> <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know how to interpret </span><span class="si">%d</span><span class="s2"> columns in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">filepath</span><span class="p">))</span>

        <span class="c1">#print(mesh.shape, spin_dos.shape, spin_idos.shape)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edos</span> <span class="o">=</span> <span class="n">ElectronDos</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">spin_dos</span><span class="p">,</span> <span class="n">nelect</span><span class="p">,</span> <span class="n">fermie</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spin_idos</span><span class="o">=</span><span class="n">spin_idos</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header_string</span><span class="p">];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edos</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">yield_figs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function *generates* a predefined list of matplotlib figures with minimal input from the user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">edos</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">edos</span><span class="o">.</span><span class="n">plot_dos_idos</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">edos</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">edos</span><span class="o">.</span><span class="n">plot_up_minus_down</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">EdosRobot</span><span class="p">(</span><span class="n">Robot</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This robot analyzes the results contained in multiple EDOS files.</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: EdosRobot</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">EXT</span> <span class="o">=</span> <span class="s2">&quot;EDOS&quot;</span>

    <span class="c1">#def yield_figs(self, **kwargs):  # pragma: no cover</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    This function *generates* a predefined list of matplotlib figures with minimal input from the user.</span>
    <span class="c1">#    Used in abiview.py to get a quick look at the results.</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    yield self.plot_lattice_convergence(show=False)</span>
    <span class="c1">#    yield self.plot_gsr_convergence(show=False)</span>
    <span class="c1">#    for fig in self.get_ebands_plotter().yield_figs(): yield fig</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, M. Giantomassi and the AbiPy group.
      <span class="lastupdated">
        Last updated on May 29, 2021.
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>