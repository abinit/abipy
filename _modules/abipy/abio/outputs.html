

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>abipy.abio.outputs &mdash; abipy 0.9.1 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/jupyter-sphinx.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/thebelab.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/plot_directive.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/my_style.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-dataframe.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-rendered-html.css" type="text/css" />

  
  

  
  

  

  
    <script type="text/javascript" src="https://cdn.plot.ly/plotly-latest.min.js"></script> 
    
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/thebelab-helper.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> abipy
          

          
          </a>

          
            
            
              <div class="version">
                0.9.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../features.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Getting AbiPy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../zzbiblio.html">Bibliography</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../scripts/index.html">Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../graphical_interface.html">Graphical interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gallery/index.html">AbiPy Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../postprocessing_howto.html">Post-processing How-To</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../workflows/taskmanager.html">TaskManager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../workflows/manager_examples.html">Manager Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../flow_gallery/index.html">Flow Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../flows_howto.html">Flows How-To</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../coding_guide.html">Coding guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html">Documenting AbiPy</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">abipy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>abipy.abio.outputs</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for abipy.abio.outputs</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Objects used to extract and plot results from output files in text format.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">from</span> <span class="nn">monty.string</span> <span class="kn">import</span> <span class="n">is_string</span><span class="p">,</span> <span class="n">marquee</span>
<span class="kn">from</span> <span class="nn">monty.functools</span> <span class="kn">import</span> <span class="n">lazy_property</span>
<span class="kn">from</span> <span class="nn">monty.termcolor</span> <span class="kn">import</span> <span class="n">cprint</span>
<span class="kn">from</span> <span class="nn">pymatgen.core.units</span> <span class="kn">import</span> <span class="n">bohr_to_ang</span>
<span class="kn">from</span> <span class="nn">abipy.core.symmetries</span> <span class="kn">import</span> <span class="n">AbinitSpaceGroup</span>
<span class="kn">from</span> <span class="nn">abipy.core.structure</span> <span class="kn">import</span> <span class="n">Structure</span><span class="p">,</span> <span class="n">dataframes_from_structures</span>
<span class="kn">from</span> <span class="nn">abipy.core.kpoints</span> <span class="kn">import</span> <span class="n">has_timrev_from_kptopt</span>
<span class="kn">from</span> <span class="nn">abipy.core.mixins</span> <span class="kn">import</span> <span class="n">TextFile</span><span class="p">,</span> <span class="n">AbinitNcFile</span><span class="p">,</span> <span class="n">NotebookWriter</span>
<span class="kn">from</span> <span class="nn">abipy.abio.inputs</span> <span class="kn">import</span> <span class="n">GEOVARS</span>
<span class="kn">from</span> <span class="nn">abipy.abio.timer</span> <span class="kn">import</span> <span class="n">AbinitTimerParser</span>
<span class="kn">from</span> <span class="nn">abipy.abio.robots</span> <span class="kn">import</span> <span class="n">Robot</span>
<span class="kn">from</span> <span class="nn">abipy.flowtk</span> <span class="kn">import</span> <span class="n">EventsParser</span><span class="p">,</span> <span class="n">NetcdfReader</span><span class="p">,</span> <span class="n">GroundStateScfCycle</span><span class="p">,</span> <span class="n">D2DEScfCycle</span>


<div class="viewcode-block" id="AbinitTextFile"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.AbinitTextFile">[docs]</a><span class="k">class</span> <span class="nc">AbinitTextFile</span><span class="p">(</span><span class="n">TextFile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for the ABINIT main output files and log files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">events</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List of ABINIT events reported in the file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Parse the file the first time the property is accessed or when mtime is changed.</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">st_mtime</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_mtime</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_events&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_events</span> <span class="o">=</span> <span class="n">EventsParser</span><span class="p">()</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_events</span>

<div class="viewcode-block" id="AbinitTextFile.get_timer"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.AbinitTextFile.get_timer">[docs]</a>    <span class="k">def</span> <span class="nf">get_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Timer data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">timer</span> <span class="o">=</span> <span class="n">AbinitTimerParser</span><span class="p">()</span>
        <span class="n">timer</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">timer</span></div></div>


<div class="viewcode-block" id="AbinitLogFile"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.AbinitLogFile">[docs]</a><span class="k">class</span> <span class="nc">AbinitLogFile</span><span class="p">(</span><span class="n">AbinitTextFile</span><span class="p">,</span> <span class="n">NotebookWriter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class representing the Abinit log file.</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: AbinitLogFile</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AbinitLogFile.to_string"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.AbinitLogFile.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbinitLogFile.plot"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.AbinitLogFile.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Empty placeholder.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="AbinitLogFile.yield_figs"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.AbinitLogFile.yield_figs">[docs]</a>    <span class="k">def</span> <span class="nf">yield_figs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function *generates* a predefined list of matplotlib figures with minimal input from the user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">yield</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="AbinitLogFile.write_notebook"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.AbinitLogFile.write_notebook">[docs]</a>    <span class="k">def</span> <span class="nf">write_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a jupyter_ notebook to ``nbpath``. If nbpath is None, a temporay file in the current</span>
<span class="sd">        working directory is created. Return path to the notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbformat</span><span class="p">,</span> <span class="n">nbv</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nbformat_nbv_nb</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;abilog = abilab.abiopen(&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;print(abilog.events)&quot;</span><span class="p">),</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_nb_nbpath</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nbpath</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="AbinitOutputFile"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.AbinitOutputFile">[docs]</a><span class="k">class</span> <span class="nc">AbinitOutputFile</span><span class="p">(</span><span class="n">AbinitTextFile</span><span class="p">,</span> <span class="n">NotebookWriter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class representing the main Abinit output file.</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: AbinitOutputFile</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Extract number of errors and warnings.</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_level</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        header: String with the input variables</span>
<span class="sd">        footer: String with the output variables</span>
<span class="sd">        datasets: Dictionary mapping dataset index to list of strings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get code version and find magic line signaling that the output file is completed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_completed</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overall_cputime</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">overall_walltime</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proc0_cputime</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc0_walltime</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fh</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.Version&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;- Proc.&quot;</span><span class="p">):</span>
                    <span class="c1">#- Proc.   0 individual time (sec): cpu=         25.5  wall=         26.1</span>
                    <span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">proc0_walltime</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">proc0_cputime</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;+Overall time&quot;</span><span class="p">):</span>
                    <span class="c1">#+Overall time at end (sec) : cpu=         25.5  wall=         26.1</span>
                    <span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">overall_cputime</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">overall_walltime</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

                <span class="k">if</span> <span class="s2">&quot; Calculation completed.&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">run_completed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Parse header to get important dimensions and variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">footer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">where</span> <span class="o">=</span> <span class="s2">&quot;in_header&quot;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fh</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;== DATASET&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="c1"># Save dataset number</span>
                    <span class="c1"># == DATASET  1 ==================================================================</span>
                    <span class="n">where</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">assert</span> <span class="n">where</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">where</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">elif</span> <span class="s2">&quot;== END DATASET(S) &quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">where</span> <span class="o">=</span> <span class="s2">&quot;in_footer&quot;</span>

                <span class="k">if</span> <span class="n">where</span> <span class="o">==</span> <span class="s2">&quot;in_header&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">where</span> <span class="o">==</span> <span class="s2">&quot;in_footer&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">footer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># dataset number --&gt; lines</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">where</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_level</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;header:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
        <span class="c1"># Output files produced in dryrun_mode contain the following line:</span>
        <span class="c1"># abinit : before driver, prtvol=0, debugging mode =&gt; will skip driver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dryrun_mode</span> <span class="o">=</span> <span class="s2">&quot;debugging mode =&gt; will skip driver&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span>
        <span class="c1">#print(&quot;dryrun_mode:&quot;, self.dryrun_mode)</span>

        <span class="c1">#if &quot; jdtset &quot; in self.header: raise NotImplementedError(&quot;jdtset is not supported&quot;)</span>
        <span class="c1">#if &quot; udtset &quot; in self.header: raise NotImplementedError(&quot;udtset is not supported&quot;)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ndtset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">:</span>
            <span class="c1">#raise NotImplementedError(&quot;Empty dataset sections.&quot;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ndtset</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Empty dataset&quot;</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_level</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_level</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">footer</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">footer</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_level</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;footer:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">footer</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initial_vars_global</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_vars_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_variables</span><span class="p">(</span><span class="s2">&quot;header&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_vars_global</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_vars_dataset</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_completed</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dryrun_mode</span><span class="p">:</span>
                <span class="c1"># footer is not present. Copy values from header.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">final_vars_global</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_vars_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_vars_global</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_vars_dataset</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">final_vars_global</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_vars_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_variables</span><span class="p">(</span><span class="s2">&quot;footer&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="p">):</span>
        <span class="n">vars_global</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">vars_dataset</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">())</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
        <span class="c1">#print(&quot;keys&quot;, vars_dataset.keys())</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;header&quot;</span><span class="p">:</span>
            <span class="n">magic_start</span> <span class="o">=</span> <span class="s2">&quot; -outvars: echo values of preprocessed input variables --------&quot;</span>
        <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;footer&quot;</span><span class="p">:</span>
            <span class="n">magic_start</span> <span class="o">=</span> <span class="s2">&quot; -outvars: echo values of variables after computation  --------&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid value for what: `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">what</span><span class="p">))</span>

        <span class="n">magic_stop</span> <span class="o">=</span> <span class="s2">&quot;================================================================================&quot;</span>

        <span class="c1"># Select relevant portion with variables.</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">magic_start</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot find magic_start line: `</span><span class="si">%s</span><span class="s2">`</span><span class="se">\n</span><span class="s2">Perhaps this is not an Abinit output file!&quot;</span> <span class="o">%</span> <span class="n">magic_start</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">magic_stop</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot find magic_stop line: `</span><span class="si">%s</span><span class="s2">`</span><span class="se">\n</span><span class="s2">Perhaps this is not an Abinit output file!&quot;</span> <span class="o">%</span> <span class="n">magic_stop</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Parse data. Assume format:</span>
        <span class="c1">#   timopt          -1</span>
        <span class="c1">#    tnons      0.0000000  0.0000000  0.0000000     0.2500000  0.2500000  0.2500000</span>
        <span class="c1">#               0.0000000  0.0000000  0.0000000     0.2500000  0.2500000  0.2500000</span>
        <span class="k">def</span> <span class="nf">get_dtindex_key_value</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">s</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">isalpha</span><span class="p">():</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">break</span>
                <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot find dataset index in token: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>

            <span class="c1">#print(line, &quot;\n&quot;, l)</span>
            <span class="n">dtindex</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">l</span><span class="p">:</span>
                <span class="n">l</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                <span class="n">dtindex</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">l</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">dtindex</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span>

        <span class="c1"># (varname, dtindex), [line1, line2 ...]</span>
        <span class="n">stack_var</span><span class="p">,</span> <span class="n">stack_lines</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">pop_stack</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">stack_lines</span><span class="p">:</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">dtidx</span> <span class="o">=</span> <span class="n">stack_var</span>
                <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stack_lines</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dtidx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">vars_global</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vars_dataset</span><span class="p">[</span><span class="n">dtidx</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span> <span class="k">continue</span>
            <span class="c1"># Ignore first char</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span> <span class="k">continue</span>
            <span class="c1">#print(&quot;line&quot;, line)</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isalpha</span><span class="p">():</span>
                <span class="n">pop_stack</span><span class="p">()</span>
                <span class="n">stack_lines</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">dtidx</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_dtindex_key_value</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">stack_var</span> <span class="o">=</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">dtidx</span><span class="p">)</span>
                <span class="n">stack_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stack_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="n">pop_stack</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">vars_global</span><span class="p">,</span> <span class="n">vars_dataset</span>

    <span class="k">def</span> <span class="nf">_get_structures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;header&quot;</span><span class="p">:</span>
            <span class="n">vars_global</span><span class="p">,</span> <span class="n">vars_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_vars_global</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_vars_dataset</span>
        <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;footer&quot;</span><span class="p">:</span>
            <span class="n">vars_global</span><span class="p">,</span> <span class="n">vars_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_vars_global</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_vars_dataset</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid value for what: `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">what</span><span class="p">))</span>

        <span class="c1">#print(&quot;global&quot;, vars_global[&quot;acell&quot;])</span>
        <span class="kn">from</span> <span class="nn">abipy.abio.abivars</span> <span class="kn">import</span> <span class="n">is_abiunit</span>
        <span class="n">inigeo</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">vars_global</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">GEOVARS</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">vars_global</span><span class="p">}</span>

        <span class="n">spgvars</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;spgroup&quot;</span><span class="p">,</span> <span class="s2">&quot;symrel&quot;</span><span class="p">,</span> <span class="s2">&quot;tnons&quot;</span><span class="p">,</span> <span class="s2">&quot;symafm&quot;</span><span class="p">)</span>
        <span class="n">spgd_global</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">vars_global</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">spgvars</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">vars_global</span><span class="p">}</span>
        <span class="n">global_kptopt</span> <span class="o">=</span> <span class="n">vars_global</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kptopt&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">structures</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">:</span>
            <span class="c1"># This code breaks down if there are conflicting GEOVARS in globals and dataset.</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">inigeo</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">vars_dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">GEOVARS</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">vars_dataset</span><span class="p">[</span><span class="n">i</span><span class="p">]})</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Must handle possible unit.</span>
                <span class="n">fact</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
                <span class="k">if</span> <span class="n">is_abiunit</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">tokens</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">tokens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">unit</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;angstr&quot;</span><span class="p">,</span> <span class="s2">&quot;angstrom&quot;</span><span class="p">,</span> <span class="s2">&quot;angstroms&quot;</span><span class="p">):</span>
                        <span class="n">fact</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">bohr_to_ang</span>
                    <span class="k">elif</span> <span class="n">unit</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;bohr&quot;</span><span class="p">,</span> <span class="s2">&quot;bohrs&quot;</span><span class="p">,</span> <span class="s2">&quot;au&quot;</span><span class="p">):</span>
                        <span class="n">fact</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know how to handle unit: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">unit</span><span class="p">)</span>

                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;ntypat&quot;</span><span class="p">,</span> <span class="s2">&quot;typat&quot;</span><span class="p">,</span> <span class="s2">&quot;natom&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="nb">int</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1">#print(key, s)</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
                    <span class="c1">#print(key, value)</span>
                    <span class="k">if</span> <span class="n">fact</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span> <span class="n">value</span> <span class="o">*=</span> <span class="n">fact</span> <span class="c1"># Do not change integer arrays e.g typat!</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">exc</span>

            <span class="k">if</span> <span class="s2">&quot;rprim&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span> <span class="ow">and</span> <span class="s2">&quot;angdeg&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;rprim&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;natom&quot;</span> <span class="ow">in</span> <span class="n">d</span> <span class="ow">and</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;natom&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;xred&quot;</span><span class="p">,</span> <span class="s2">&quot;xcart&quot;</span><span class="p">,</span> <span class="s2">&quot;xangst&quot;</span><span class="p">)):</span>
                <span class="n">d</span><span class="p">[</span><span class="s2">&quot;xred&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="c1">#print(d)</span>
            <span class="n">abistr</span> <span class="o">=</span> <span class="n">Structure</span><span class="o">.</span><span class="n">from_abivars</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

            <span class="c1"># Extract Abinit spacegroup.</span>
            <span class="n">spgd</span> <span class="o">=</span> <span class="n">spgd_global</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">spgd</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">vars_dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">spgvars</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">vars_dataset</span><span class="p">[</span><span class="n">i</span><span class="p">]})</span>

            <span class="n">spgid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">spgd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spgroup&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">if</span> <span class="s2">&quot;symrel&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">spgd</span><span class="p">:</span>
                <span class="n">symrel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
                <span class="n">spgd</span><span class="p">[</span><span class="s2">&quot;symrel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">symrel</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">symrel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">spgd</span><span class="p">[</span><span class="s2">&quot;symrel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="n">nsym</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">symrel</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">nsym</span> <span class="o">==</span> <span class="n">spgd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nsym&quot;</span><span class="p">,</span> <span class="n">nsym</span><span class="p">)</span> <span class="c1">#; print(symrel.shape)</span>

            <span class="k">if</span> <span class="s2">&quot;tnons&quot;</span> <span class="ow">in</span> <span class="n">spgd</span><span class="p">:</span>
                <span class="n">tnons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">spgd</span><span class="p">[</span><span class="s2">&quot;tnons&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="n">nsym</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tnons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nsym</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

            <span class="k">if</span> <span class="s2">&quot;symafm&quot;</span> <span class="ow">in</span> <span class="n">spgd</span><span class="p">:</span>
                <span class="n">symafm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">spgd</span><span class="p">[</span><span class="s2">&quot;symafm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">symafm</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">nsym</span><span class="p">,)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">symafm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nsym</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">has_timerev</span> <span class="o">=</span> <span class="n">has_timrev_from_kptopt</span><span class="p">(</span><span class="n">vars_dataset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kptopt&quot;</span><span class="p">,</span> <span class="n">global_kptopt</span><span class="p">))</span>
                <span class="n">abi_spacegroup</span> <span class="o">=</span> <span class="n">AbinitSpaceGroup</span><span class="p">(</span><span class="n">spgid</span><span class="p">,</span> <span class="n">symrel</span><span class="p">,</span> <span class="n">tnons</span><span class="p">,</span> <span class="n">symafm</span><span class="p">,</span> <span class="n">has_timerev</span><span class="p">,</span> <span class="n">inord</span><span class="o">=</span><span class="s2">&quot;C&quot;</span><span class="p">)</span>
                <span class="n">abistr</span><span class="o">.</span><span class="n">set_abi_spacegroup</span><span class="p">(</span><span class="n">abi_spacegroup</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cannot build AbinitSpaceGroup from the variables reported in file!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>

            <span class="n">structures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">abistr</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">structures</span>

<div class="viewcode-block" id="AbinitOutputFile.initial_structures"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.AbinitOutputFile.initial_structures">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">initial_structures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of initial |Structure|.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_structures</span><span class="p">(</span><span class="s2">&quot;header&quot;</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_same_initial_structures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if all initial structures are equal.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_structures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_structures</span><span class="p">)</span>

<div class="viewcode-block" id="AbinitOutputFile.final_structures"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.AbinitOutputFile.final_structures">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">final_structures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of final |Structure|.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_completed</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_structures</span><span class="p">(</span><span class="s2">&quot;footer&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Cannot extract final structures from file.</span><span class="se">\n</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="AbinitOutputFile.initial_structure"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.AbinitOutputFile.initial_structure">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">initial_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The |Structure| defined in the output file.</span>

<span class="sd">        If the input file contains multiple datasets **AND** the datasets</span>
<span class="sd">        have different structures, this property returns None.</span>
<span class="sd">        In this case, one has to access the structure of the individual datasets.</span>
<span class="sd">        For example:</span>

<span class="sd">            self.initial_structures[0]</span>

<span class="sd">        gives the structure of the first dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_same_initial_structures</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Datasets have different structures. Returning None. Use initial_structures[0]&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_structures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_same_final_structures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if all initial structures are equal.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_structures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_structures</span><span class="p">)</span>

<div class="viewcode-block" id="AbinitOutputFile.final_structure"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.AbinitOutputFile.final_structure">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">final_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The |Structure| defined in the output file.</span>

<span class="sd">        If the input file contains multiple datasets **AND** the datasets</span>
<span class="sd">        have different structures, this property returns None.</span>
<span class="sd">        In this case, one has to access the structure of the individual datasets.</span>
<span class="sd">        For example:</span>

<span class="sd">            self.final_structures[0]</span>

<span class="sd">        gives the structure of the first dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_same_final_structures</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Datasets have different structures. Returning None. Use final_structures[0]&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_structures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="AbinitOutputFile.diff_datasets"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.AbinitOutputFile.diff_datasets">[docs]</a>    <span class="k">def</span> <span class="nf">diff_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt_list1</span><span class="p">,</span> <span class="n">dt_list2</span><span class="p">,</span> <span class="n">with_params</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">differ</span><span class="o">=</span><span class="s2">&quot;html&quot;</span><span class="p">,</span> <span class="n">dryrun</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compare datasets</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt_list1</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span> <span class="n">dt_list1</span> <span class="o">=</span> <span class="p">[</span><span class="n">dt_list1</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt_list2</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span> <span class="n">dt_list2</span> <span class="o">=</span> <span class="p">[</span><span class="n">dt_list2</span><span class="p">]</span>

        <span class="n">dt_lists</span> <span class="o">=</span> <span class="p">[</span><span class="n">dt_list1</span><span class="p">,</span> <span class="n">dt_list2</span><span class="p">]</span>
        <span class="kn">import</span> <span class="nn">tempfile</span>
        <span class="n">tmp_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">tmpname</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">tmp_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmpname</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmpname</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">with_params</span><span class="p">:</span> <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">idt</span> <span class="ow">in</span> <span class="n">dt_lists</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">idt</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">with_params</span><span class="p">:</span> <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">footer</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">differ</span> <span class="o">==</span> <span class="s2">&quot;html&quot;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">abipy.tools.devtools</span> <span class="kn">import</span> <span class="n">HtmlDiff</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">HtmlDiff</span><span class="p">(</span><span class="n">tmp_names</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dryrun</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">diff</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">diff</span><span class="o">.</span><span class="n">open_browser</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">differ</span><span class="p">,</span> <span class="n">tmp_names</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tmp_names</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">dryrun</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cmd</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

<div class="viewcode-block" id="AbinitOutputFile.to_string"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.AbinitOutputFile.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ndtset: </span><span class="si">%d</span><span class="s2">, completed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndtset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_completed</span><span class="p">)]</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>

        <span class="c1"># Different cases depending whether final structures are available</span>
        <span class="c1"># and whether structures are equivalent.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_completed</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_same_final_structures</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_structure</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_structure</span><span class="p">:</span>
                    <span class="c1"># Structural relaxation.</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">dataframes_from_structures</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_structure</span><span class="p">],</span>
                                                    <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;initial&quot;</span><span class="p">,</span> <span class="s2">&quot;final&quot;</span><span class="p">])</span>
                    <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Lattice parameters:&quot;</span><span class="p">)</span>
                    <span class="n">app</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">lattice</span><span class="p">))</span>
                    <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Atomic coordinates:&quot;</span><span class="p">)</span>
                    <span class="n">app</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">coords</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># initial == final. Print final structure.</span>
                    <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_structure</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Final structures are not available.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_same_initial_structures</span><span class="p">:</span>
                <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_structure</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">dataframes_from_structures</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_structures</span><span class="p">,</span>
                                                <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndtset</span><span class="p">)])</span>
                <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Lattice parameters:&quot;</span><span class="p">)</span>
                <span class="n">app</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">lattice</span><span class="p">))</span>
                <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Atomic coordinates:&quot;</span><span class="p">)</span>
                <span class="n">app</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">coords</span><span class="p">))</span>

        <span class="c1"># Print dataframe with dimensions.</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dims_spginfo_dataframe</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">abipy.tools.printing</span> <span class="kn">import</span> <span class="n">print_dataframe</span>
        <span class="n">strio</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">print_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">strio</span><span class="p">)</span>
        <span class="n">strio</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="s2">&quot;Dimensions of calculation&quot;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">strio</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbinitOutputFile.get_dims_spginfo_dataframe"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.AbinitOutputFile.get_dims_spginfo_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">get_dims_spginfo_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the section with the dimensions of the calculation. Return Dataframe.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dims_dataset</span><span class="p">,</span> <span class="n">spginfo_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dims_spginfo_dataset</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dtind</span><span class="p">,</span> <span class="n">dims</span> <span class="ow">in</span> <span class="n">dims_dataset</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="n">d</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dtind</span>
            <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span>
            <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">spginfo_dataset</span><span class="p">[</span><span class="n">dtind</span><span class="p">])</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">rows</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;dataset&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="AbinitOutputFile.get_dims_spginfo_dataset"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.AbinitOutputFile.get_dims_spginfo_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">get_dims_spginfo_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the section with the dimensions of the calculation. Return dictionaries</span>

<span class="sd">        Args:</span>
<span class="sd">            verbose: Verbosity level.</span>

<span class="sd">        Return: (dims_dataset, spginfo_dataset)</span>
<span class="sd">            where dims_dataset[i] is an OrderedDict with the dimensions of dataset `i`</span>
<span class="sd">            spginfo_dataset[i] is a dictionary with space group information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If single dataset, we have to parse</span>
        <span class="c1">#</span>
        <span class="c1">#  Symmetries : space group Fd -3 m (#227); Bravais cF (face-center cubic)</span>
        <span class="c1"># ================================================================================</span>
        <span class="c1">#  Values of the parameters that define the memory need of the present run</span>
        <span class="c1">#      intxc =       0    ionmov =       0      iscf =       7    lmnmax =       6</span>
        <span class="c1">#      lnmax =       6     mgfft =      18  mpssoang =       3    mqgrid =    3001</span>
        <span class="c1">#      natom =       2  nloc_mem =       1    nspden =       1   nspinor =       1</span>
        <span class="c1">#     nsppol =       1      nsym =      48    n1xccc =    2501    ntypat =       1</span>
        <span class="c1">#     occopt =       1   xclevel =       2</span>
        <span class="c1"># -    mband =           8        mffmem =           1         mkmem =          29</span>
        <span class="c1">#        mpw =         202          nfft =        5832          nkpt =          29</span>
        <span class="c1"># ================================================================================</span>
        <span class="c1"># P This job should need less than                       3.389 Mbytes of memory.</span>
        <span class="c1">#   Rough estimation (10% accuracy) of disk space for files :</span>
        <span class="c1"># _ WF disk file :      0.717 Mbytes ; DEN or POT disk file :      0.046 Mbytes.</span>
        <span class="c1"># ================================================================================</span>

        <span class="c1"># If multi datasets we have to parse:</span>

        <span class="c1">#  DATASET    2 : space group F-4 3 m (#216); Bravais cF (face-center cubic)</span>
        <span class="c1"># ================================================================================</span>
        <span class="c1">#  Values of the parameters that define the memory need for DATASET  2.</span>
        <span class="c1">#      intxc =       0    ionmov =       0      iscf =       7    lmnmax =       2</span>
        <span class="c1">#      lnmax =       2     mgfft =      12  mpssoang =       3    mqgrid =    3001</span>
        <span class="c1">#      natom =       2  nloc_mem =       1    nspden =       1   nspinor =       1</span>
        <span class="c1">#     nsppol =       1      nsym =      24    n1xccc =    2501    ntypat =       2</span>
        <span class="c1">#     occopt =       1   xclevel =       1</span>
        <span class="c1"># -    mband =          10        mffmem =           1         mkmem =           2</span>
        <span class="c1">#        mpw =          69          nfft =        1728          nkpt =           2</span>
        <span class="c1"># ================================================================================</span>
        <span class="c1"># P This job should need less than                       1.331 Mbytes of memory.</span>
        <span class="c1">#   Rough estimation (10% accuracy) of disk space for files :</span>
        <span class="c1"># _ WF disk file :      0.023 Mbytes ; DEN or POT disk file :      0.015 Mbytes.</span>
        <span class="c1"># ================================================================================</span>

        <span class="n">magic</span> <span class="o">=</span> <span class="s2">&quot;Values of the parameters that define the memory need&quot;</span>
        <span class="n">memory_pre</span> <span class="o">=</span> <span class="s2">&quot;P This job should need less than&quot;</span>
        <span class="n">magic_exit</span> <span class="o">=</span> <span class="s2">&quot;------------- Echo of variables that govern the present computation&quot;</span>
        <span class="n">filesizes_pre</span> <span class="o">=</span> <span class="s2">&quot;_ WF disk file :&quot;</span>
        <span class="c1">#verbose = 1</span>

        <span class="k">def</span> <span class="nf">parse_spgline</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Parse the line with space group info, return dict.&quot;&quot;&quot;</span>
            <span class="c1"># Could use regular expressions ...</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;space group&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># the unit cell is not primitive</span>
                <span class="k">return</span> <span class="p">{}</span>

            <span class="n">spg_str</span><span class="p">,</span> <span class="n">brav_str</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;space group&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
            <span class="n">toks</span> <span class="o">=</span> <span class="n">spg_str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;spg_symbol&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toks</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                <span class="s2">&quot;spg_number&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
                <span class="s2">&quot;bravais&quot;</span><span class="p">:</span> <span class="n">brav_str</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
            <span class="p">}</span>

        <span class="kn">from</span> <span class="nn">abipy.tools.numtools</span> <span class="kn">import</span> <span class="n">grouper</span>
        <span class="n">dims_dataset</span><span class="p">,</span> <span class="n">spginfo_dataset</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(),</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">inblock</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inblock:&quot;</span><span class="p">,</span> <span class="n">inblock</span><span class="p">,</span> <span class="s2">&quot; at line:&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">magic_exit</span><span class="p">):</span> <span class="k">break</span>

                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">line</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;===&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">)</span>
                    <span class="c1">#or line.startswith(&quot;P&quot;)</span>
                    <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Rough estimation&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;PAW method is used&quot;</span><span class="p">)):</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;DATASET&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Symmetries :&quot;</span><span class="p">):</span>
                    <span class="c1"># Get dataset index, parse space group and lattice info, init new dims dict.</span>
                    <span class="n">inblock</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Symmetries :&quot;</span><span class="p">):</span>
                        <span class="c1"># No multidataset</span>
                        <span class="n">dtindex</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                        <span class="n">dtindex</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                    <span class="n">dims_dataset</span><span class="p">[</span><span class="n">dtindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">dims</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
                    <span class="n">spginfo_dataset</span><span class="p">[</span><span class="n">dtindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">parse_spgline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">inblock</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">magic</span><span class="p">):</span>
                    <span class="n">inblock</span> <span class="o">=</span> <span class="mi">2</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">inblock</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="c1"># Lines with data.</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;For the susceptibility&quot;</span><span class="p">):</span> <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">memory_pre</span><span class="p">):</span>
                        <span class="n">dims</span><span class="p">[</span><span class="s2">&quot;mem_per_proc_mb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">memory_pre</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">filesizes_pre</span><span class="p">):</span>
                        <span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                        <span class="n">mbpos</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Mbytes&quot;</span><span class="p">)]</span>
                        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">mbpos</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
                        <span class="n">dims</span><span class="p">[</span><span class="s2">&quot;wfk_size_mb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="n">mbpos</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                        <span class="n">dims</span><span class="p">[</span><span class="s2">&quot;denpot_size_mb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="n">mbpos</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                    <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Pmy_natom=&quot;</span><span class="p">):</span>
                        <span class="n">dims</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">my_natom</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Pmy_natom=&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
                        <span class="c1">#print(&quot;my_natom&quot;, dims[&quot;my_natom&quot;])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span> <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                        <span class="n">tokens</span> <span class="o">=</span> <span class="n">grouper</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
                        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;tokens:&quot;</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
                        <span class="n">dims</span><span class="o">.</span><span class="n">update</span><span class="p">([(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">])</span>

            <span class="k">return</span> <span class="n">dims_dataset</span><span class="p">,</span> <span class="n">spginfo_dataset</span></div>

<div class="viewcode-block" id="AbinitOutputFile.next_gs_scf_cycle"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.AbinitOutputFile.next_gs_scf_cycle">[docs]</a>    <span class="k">def</span> <span class="nf">next_gs_scf_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the next :class:`GroundStateScfCycle` in the file. None if not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">GroundStateScfCycle</span><span class="o">.</span><span class="n">from_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbinitOutputFile.get_all_gs_scf_cycles"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.AbinitOutputFile.get_all_gs_scf_cycles">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_gs_scf_cycles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of :class:`GroundStateScfCycle` objects. Empty list if no entry is found.&quot;&quot;&quot;</span>
        <span class="c1"># NOTE: get_all should not used with next because of the call to self.seek(0)</span>
        <span class="c1"># The API should be refactored</span>
        <span class="n">cycles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">cycle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_gs_scf_cycle</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cycle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">break</span>
            <span class="n">cycles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cycle</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cycles</span></div>

<div class="viewcode-block" id="AbinitOutputFile.next_d2de_scf_cycle"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.AbinitOutputFile.next_d2de_scf_cycle">[docs]</a>    <span class="k">def</span> <span class="nf">next_d2de_scf_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return :class:`D2DEScfCycle` with information on the DFPT iterations. None if not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">D2DEScfCycle</span><span class="o">.</span><span class="n">from_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbinitOutputFile.get_all_d2de_scf_cycles"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.AbinitOutputFile.get_all_d2de_scf_cycles">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_d2de_scf_cycles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of :class:`D2DEScfCycle` objects. Empty list if no entry is found.&quot;&quot;&quot;</span>
        <span class="n">cycles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">cycle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_d2de_scf_cycle</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cycle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">break</span>
            <span class="n">cycles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cycle</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cycles</span></div>

<div class="viewcode-block" id="AbinitOutputFile.plot"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.AbinitOutputFile.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_timer</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot GS/DFPT SCF cycles and timer data found in the output file.</span>

<span class="sd">        Args:</span>
<span class="sd">            with_timer: True if timer section should be plotted</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">abipy.tools.plotting</span> <span class="kn">import</span> <span class="n">MplExpose</span>
        <span class="k">with</span> <span class="n">MplExpose</span><span class="p">(</span><span class="n">slide_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">slide_timeout</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">e</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yield_figs</span><span class="p">(</span><span class="n">tight_layout</span><span class="o">=</span><span class="n">tight_layout</span><span class="p">,</span> <span class="n">with_timer</span><span class="o">=</span><span class="n">with_timer</span><span class="p">))</span></div>

    <span class="c1"># TODO: Use header and vars to understand if we have SCF/DFPT/Relaxation</span>
<div class="viewcode-block" id="AbinitOutputFile.yield_figs"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.AbinitOutputFile.yield_figs">[docs]</a>    <span class="k">def</span> <span class="nf">yield_figs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function *generates* a predefined list of matplotlib figures with minimal input from the user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tight_layout</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;tight_layout&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">with_timer</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;with_timer&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">icycle</span><span class="p">,</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_all_gs_scf_cycles</span><span class="p">()):</span>
            <span class="k">yield</span> <span class="n">cycle</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;SCF cycle #</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">icycle</span><span class="p">,</span> <span class="n">tight_layout</span><span class="o">=</span><span class="n">tight_layout</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">icycle</span><span class="p">,</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_all_d2de_scf_cycles</span><span class="p">()):</span>
            <span class="k">yield</span> <span class="n">cycle</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;DFPT cycle #</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">icycle</span><span class="p">,</span> <span class="n">tight_layout</span><span class="o">=</span><span class="n">tight_layout</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">with_timer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_timer</span><span class="p">()</span><span class="o">.</span><span class="n">plot_all</span><span class="p">(</span><span class="n">tight_layout</span><span class="o">=</span><span class="n">tight_layout</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Abinit output files does not contain timopt data&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbinitOutputFile.compare_gs_scf_cycles"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.AbinitOutputFile.compare_gs_scf_cycles">[docs]</a>    <span class="k">def</span> <span class="nf">compare_gs_scf_cycles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">others</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Produce and returns a list of matplotlib_ figure comparing the GS self-consistent</span>
<span class="sd">        cycle in self with the ones in others.</span>

<span class="sd">        Args:</span>
<span class="sd">            others: list of :class:`AbinitOutputFile` objects or strings with paths to output files.</span>
<span class="sd">            show: True to diplay plots.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Open file here if we receive a string. Files will be closed before returning</span>
        <span class="n">close_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">other</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">others</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">is_string</span><span class="p">(</span><span class="n">other</span><span class="p">):</span>
                <span class="n">others</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
                <span class="n">close_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">figures</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">cycle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_gs_scf_cycle</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cycle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">break</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">cycle</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">other</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">others</span><span class="p">):</span>
                <span class="n">other_cycle</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">next_gs_scf_cycle</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">other_cycle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">break</span>
                <span class="n">last</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">others</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">other_cycle</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax_list</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="n">show</span> <span class="ow">and</span> <span class="n">last</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">last</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                    <span class="n">figures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">other</span> <span class="ow">in</span> <span class="n">others</span><span class="p">:</span> <span class="n">other</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">close_files</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">close_files</span><span class="p">:</span> <span class="n">others</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">figures</span></div>

<div class="viewcode-block" id="AbinitOutputFile.compare_d2de_scf_cycles"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.AbinitOutputFile.compare_d2de_scf_cycles">[docs]</a>    <span class="k">def</span> <span class="nf">compare_d2de_scf_cycles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">others</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Produce and returns a matplotlib_ figure comparing the DFPT self-consistent</span>
<span class="sd">        cycle in self with the ones in others.</span>

<span class="sd">        Args:</span>
<span class="sd">            others: list of :class:`AbinitOutputFile` objects or strings with paths to output files.</span>
<span class="sd">            show: True to diplay plots.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Open file here if we receive a string. Files will be closed before returning</span>
        <span class="n">close_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">other</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">others</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">is_string</span><span class="p">(</span><span class="n">other</span><span class="p">):</span>
                <span class="n">others</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
                <span class="n">close_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">figures</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">cycle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_d2de_scf_cycle</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cycle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">break</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">cycle</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">other</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">others</span><span class="p">):</span>
                <span class="n">other_cycle</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">next_d2de_scf_cycle</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">other_cycle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">break</span>
                <span class="n">last</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">others</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">other_cycle</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax_list</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="n">show</span> <span class="ow">and</span> <span class="n">last</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">last</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                    <span class="n">figures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">other</span> <span class="ow">in</span> <span class="n">others</span><span class="p">:</span> <span class="n">other</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">close_files</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">close_files</span><span class="p">:</span> <span class="n">others</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">figures</span></div>

<div class="viewcode-block" id="AbinitOutputFile.get_panel"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.AbinitOutputFile.get_panel">[docs]</a>    <span class="k">def</span> <span class="nf">get_panel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build panel with widgets to interact with the Abinit output file either in a notebook or in panel app.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">abipy.panels.outputs</span> <span class="kn">import</span> <span class="n">AbinitOutputFilePanel</span>
        <span class="k">return</span> <span class="n">AbinitOutputFilePanel</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_panel</span><span class="p">()</span></div>

<div class="viewcode-block" id="AbinitOutputFile.write_notebook"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.AbinitOutputFile.write_notebook">[docs]</a>    <span class="k">def</span> <span class="nf">write_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a jupyter_ notebook to nbpath. If ``nbpath`` is None, a temporay file in the current</span>
<span class="sd">        working directory is created. Return path to the notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbformat</span><span class="p">,</span> <span class="n">nbv</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nbformat_nbv_nb</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;abo = abilab.abiopen(&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;print(abo.events)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;abo.plot()&quot;</span><span class="p">),</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_nb_nbpath</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nbpath</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="validate_output_parser"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.validate_output_parser">[docs]</a><span class="k">def</span> <span class="nf">validate_output_parser</span><span class="p">(</span><span class="n">abitests_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_files</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate/test Abinit output parser.</span>

<span class="sd">    Args:</span>
<span class="sd">        dirpath: Abinit tests directory.</span>
<span class="sd">        output_files: List of Abinit output files.</span>

<span class="sd">    Return: Exit code.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">is_abinit_output</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        True if path is one of the output files used in the Abinit Test suite.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.abo&quot;</span><span class="p">):</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.out&quot;</span><span class="p">):</span> <span class="k">return</span> <span class="kc">False</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fh</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;abinit&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Files are collected in paths.</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">abitests_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Analyzing directory </span><span class="si">%s</span><span class="s2"> for input files&quot;</span> <span class="o">%</span> <span class="n">abitests_dir</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">abitests_dir</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">is_abinit_output</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Analyzing files:&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_files</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">output_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_abinit_output</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span> <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

    <span class="n">nfiles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nfiles</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Empty list of input files.&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> Abinit output files&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">))</span>
    <span class="n">errpaths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">AbinitOutputFile</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">out</span><span class="o">.</span><span class="n">run_completed</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="ne">NotImplementedError</span><span class="p">):</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;FAILED&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
                <span class="n">errpaths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="kn">import</span> <span class="nn">traceback</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="c1">#print(&quot;[%s]: Exception:\n%s&quot; % (path, str(exc)))</span>
                <span class="c1">#with open(path, &quot;rt&quot;) as fh:</span>
                <span class="c1">#    print(10*&quot;=&quot; + &quot;Input File&quot; + 10*&quot;=&quot;)</span>
                <span class="c1">#    print(fh.read())</span>
                <span class="c1">#    print()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;NOTIMPLEMENTED&quot;</span><span class="p">,</span> <span class="s2">&quot;magenta&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">errpaths</span><span class="p">:</span>
        <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;failed: </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2"> [</span><span class="si">%.1f%%</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">errpaths</span><span class="p">),</span> <span class="n">nfiles</span><span class="p">,</span> <span class="mi">100</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">errpaths</span><span class="p">)</span><span class="o">/</span><span class="n">nfiles</span><span class="p">),</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">epath</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">errpaths</span><span class="p">):</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">%d</span><span class="s2">] </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">epath</span><span class="p">),</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;All input files successfully parsed!&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">errpaths</span><span class="p">)</span></div>


<div class="viewcode-block" id="AboRobot"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.AboRobot">[docs]</a><span class="k">class</span> <span class="nc">AboRobot</span><span class="p">(</span><span class="n">Robot</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This robot analyzes the results contained in multiple Abinit output files.</span>
<span class="sd">    Can compare dimensions, SCF cycles, analyze timers.</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: AboRobot</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">EXT</span> <span class="o">=</span> <span class="s2">&quot;abo&quot;</span>

<div class="viewcode-block" id="AboRobot.get_dims_dataframe"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.AboRobot.get_dims_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">get_dims_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_time</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build and return |pandas-DataFrame| with the dimensions of the calculation.</span>

<span class="sd">        Args:</span>
<span class="sd">            with_time: True if walltime and cputime should be added</span>
<span class="sd">            index: Index of the dataframe. Use relative paths of files if None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rows</span><span class="p">,</span> <span class="n">my_index</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">abo</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dims_dataset</span><span class="p">,</span> <span class="n">spg_dataset</span> <span class="o">=</span> <span class="n">abo</span><span class="o">.</span><span class="n">get_dims_spginfo_dataset</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Exception while trying to get dimensions from </span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">abo</span><span class="o">.</span><span class="n">relpath</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)),</span> <span class="s2">&quot;yellow&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">dtindex</span><span class="p">,</span> <span class="n">dims</span> <span class="ow">in</span> <span class="n">dims_dataset</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">dims</span> <span class="o">=</span> <span class="n">dims</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">dims</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;dtset&quot;</span><span class="p">:</span> <span class="n">dtindex</span><span class="p">})</span>
                <span class="c1"># Add walltime and cputime in seconds</span>
                <span class="k">if</span> <span class="n">with_time</span><span class="p">:</span>
                    <span class="n">dims</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">abo</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span>
                        <span class="p">(</span><span class="s2">&quot;overall_cputime&quot;</span><span class="p">,</span> <span class="s2">&quot;proc0_cputime&quot;</span><span class="p">,</span> <span class="s2">&quot;overall_walltime&quot;</span><span class="p">,</span> <span class="s2">&quot;proc0_walltime&quot;</span><span class="p">)]))</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span>
                <span class="n">my_index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">abo</span><span class="o">.</span><span class="n">relpath</span> <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">my_index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span></div>

<div class="viewcode-block" id="AboRobot.get_dataframe"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.AboRobot.get_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">get_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_geo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_dims</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">abspath</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">funcs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a |pandas-DataFrame| with the most important results and the filenames as index.</span>

<span class="sd">        Args:</span>
<span class="sd">            with_geo: True if structure info should be added to the dataframe</span>
<span class="sd">            with_dims: True if dimensions should be added</span>
<span class="sd">            abspath: True if paths in index should be absolute. Default: Relative to getcwd().</span>
<span class="sd">            funcs: Function or list of functions to execute to add more data to the DataFrame.</span>
<span class="sd">                Each function receives a |GsrFile| object and returns a tuple (key, value)</span>
<span class="sd">                where key is a string with the name of column and value is the value to be inserted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rows</span><span class="p">,</span> <span class="n">row_names</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">abo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">row_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">with_dims</span><span class="p">:</span>
                <span class="n">dims_dataset</span><span class="p">,</span> <span class="n">spg_dataset</span> <span class="o">=</span> <span class="n">abo</span><span class="o">.</span><span class="n">get_dims_spginfo_dataset</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims_dataset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Multiple datasets are not supported. ARGH!&quot;</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">)</span>
                <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dims_dataset</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="c1"># Add info on structure.</span>
            <span class="k">if</span> <span class="n">with_geo</span> <span class="ow">and</span> <span class="n">abo</span><span class="o">.</span><span class="n">run_completed</span><span class="p">:</span>
                <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">abo</span><span class="o">.</span><span class="n">final_structure</span><span class="o">.</span><span class="n">get_dict4pandas</span><span class="p">(</span><span class="n">with_spglib</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

            <span class="c1"># Execute functions</span>
            <span class="k">if</span> <span class="n">funcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exec_funcs</span><span class="p">(</span><span class="n">funcs</span><span class="p">,</span> <span class="n">abo</span><span class="p">))</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="n">row_names</span> <span class="o">=</span> <span class="n">row_names</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">abspath</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_relpaths</span><span class="p">(</span><span class="n">row_names</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">row_names</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span></div>

<div class="viewcode-block" id="AboRobot.get_time_dataframe"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.AboRobot.get_time_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">get_time_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a |pandas-DataFrame| with the wall-time, cpu time in seconds and the filenames as index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rows</span><span class="p">,</span> <span class="n">row_names</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">abo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">row_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">abo</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span>
                <span class="p">(</span><span class="s2">&quot;overall_cputime&quot;</span><span class="p">,</span> <span class="s2">&quot;proc0_cputime&quot;</span><span class="p">,</span> <span class="s2">&quot;overall_walltime&quot;</span><span class="p">,</span> <span class="s2">&quot;proc0_walltime&quot;</span><span class="p">)])</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">row_names</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span></div>

    <span class="c1"># TODO</span>
    <span class="c1">#def gridplot_timer(self)</span>

<div class="viewcode-block" id="AboRobot.yield_figs"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.AboRobot.yield_figs">[docs]</a>    <span class="k">def</span> <span class="nf">yield_figs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function *generates* a predefined list of matplotlib figures with minimal input from the user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">yield</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="AboRobot.write_notebook"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.AboRobot.write_notebook">[docs]</a>    <span class="k">def</span> <span class="nf">write_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a jupyter_ notebook to nbpath. If nbpath is None, a temporay file in the current</span>
<span class="sd">        working directory is created. Return path to the notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbformat</span><span class="p">,</span> <span class="n">nbv</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nbformat_nbv_nb</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">[(</span><span class="n">l</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="c1">#nbv.new_markdown_cell(&quot;# This is a markdown cell&quot;),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;robot = abilab.AboRobot(*</span><span class="si">%s</span><span class="s2">)</span><span class="se">\n</span><span class="s2">robot.trim_paths()</span><span class="se">\n</span><span class="s2">robot&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">)),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;# robot.get_dims_dataframe()&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;robot.get_dataframe()&quot;</span><span class="p">),</span>
        <span class="p">])</span>

        <span class="c1"># Mixins</span>
        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_baserobot_code_cells</span><span class="p">())</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_nb_nbpath</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nbpath</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="OutNcFile"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.OutNcFile">[docs]</a><span class="k">class</span> <span class="nc">OutNcFile</span><span class="p">(</span><span class="n">AbinitNcFile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class representing the _OUT.nc file containing the dataset results</span>
<span class="sd">    produced at the end of the run. The netcdf variables can be accessed</span>
<span class="sd">    via instance attribute e.g. ``outfile.ecut``. Provides integration with ipython_.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: This object is deprecated</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="n">NetcdfReader</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_varscache</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">rootgrp</span><span class="o">.</span><span class="n">variables</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ipython integration.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_varscache</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

    <span class="k">def</span> <span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># Look in self._varscache</span>
            <span class="n">varscache</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="s2">&quot;_varscache&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">varscache</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Cannot find attribute </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="s2">&quot;reader&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">varscache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">varscache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">varscache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

<div class="viewcode-block" id="OutNcFile.params"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.OutNcFile.params">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;:class:`OrderedDict` with parameters that might be subject to convergence studies.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="OutNcFile.close"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.OutNcFile.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close the file.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="OutNcFile.get_allvars"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.outputs.OutNcFile.get_allvars">[docs]</a>    <span class="k">def</span> <span class="nf">get_allvars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read all netcdf_ variables present in the file.</span>
<span class="sd">        Return dictionary varname --&gt; value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varscache</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_varscache</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varscache</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, M. Giantomassi and the AbiPy group.
      <span class="lastupdated">
        Last updated on Jun 16, 2021.
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>