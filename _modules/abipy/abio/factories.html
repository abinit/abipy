<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>abipy.abio.factories &#8212; abipy 0.3.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/my_style.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.3.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html">
          abipy</a>
        <span class="navbar-text navbar-version pull-left"><b>0.3.0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../features.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Getting AbiPy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../zzbiblio.html">Bibliography</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../scripts/index.html">Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gallery/index.html">AbiPy Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../postprocessing_howto.html">Post-processing How-To</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../workflows/taskmanager.html">TaskManager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../workflows/manager_examples.html">Manager Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../flow_gallery/index.html">Flow Gallery</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../coding_guide.html">Coding guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html">Documenting AbiPy</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <h1>Source code for abipy.abio.factories</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: utf-8</span>
<span class="sd">&quot;&quot;&quot;Factory functions for Abinit input files &quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">unicode_literals</span><span class="p">,</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pymatgen.io.abinit.abiobjects</span> <span class="k">as</span> <span class="nn">aobj</span>

<span class="kn">from</span> <span class="nn">enum</span> <span class="k">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">monty.collections</span> <span class="k">import</span> <span class="n">AttrDict</span>
<span class="kn">from</span> <span class="nn">monty.string</span> <span class="k">import</span> <span class="n">is_string</span>
<span class="kn">from</span> <span class="nn">monty.json</span> <span class="k">import</span> <span class="n">jsanitize</span><span class="p">,</span> <span class="n">MontyDecoder</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pymatgen.util.serialization</span> <span class="k">import</span> <span class="n">pmg_serialize</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pymatgen.serializers.json_coders</span> <span class="k">import</span> <span class="n">pmg_serialize</span>
<span class="kn">from</span> <span class="nn">abipy.flowtk</span> <span class="k">import</span> <span class="n">PseudoTable</span>
<span class="kn">from</span> <span class="nn">abipy.core.structure</span> <span class="k">import</span> <span class="n">Structure</span>
<span class="kn">from</span> <span class="nn">abipy.abio.inputs</span> <span class="k">import</span> <span class="n">AbinitInput</span><span class="p">,</span> <span class="n">MultiDataset</span>
<span class="kn">from</span> <span class="nn">abipy.abio.input_tags</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">monty.json</span> <span class="k">import</span> <span class="n">MSONable</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;gs_input&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ebands_input&quot;</span><span class="p">,</span>
    <span class="s2">&quot;phonons_from_gsinput&quot;</span><span class="p">,</span>
    <span class="s2">&quot;g0w0_with_ppmodel_inputs&quot;</span><span class="p">,</span>
    <span class="s2">&quot;g0w0_convergence_inputs&quot;</span><span class="p">,</span>
    <span class="s2">&quot;bse_with_mdf_inputs&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ion_ioncell_relax_input&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ion_ioncell_relax_and_ebands_input&quot;</span><span class="p">,</span>
    <span class="s2">&quot;scf_phonons_inputs&quot;</span><span class="p">,</span>
    <span class="s2">&quot;piezo_elastic_inputs_from_gsinput&quot;</span><span class="p">,</span>
    <span class="s2">&quot;scf_piezo_elastic_inputs&quot;</span><span class="p">,</span>
    <span class="s2">&quot;scf_for_phonons&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dte_from_gsinput&quot;</span>
<span class="p">]</span>


<span class="c1"># TODO: To be discussed:</span>
<span class="c1">#    1) extra_abivars is more similar to a hack. The factory functions are designed for</span>
<span class="c1">#       HPC hence we cannot allow the user to inject something we cannot control easily</span>
<span class="c1">#       Shall we remove it?</span>
<span class="c1">#    2) scf_nband and nscf_band should be computed from the pseudos, the structure</span>
<span class="c1">#       and some approximation for the band dispersion.</span>
<span class="c1">#       SCF fails if nband is too small or has problems if we don&#39;t have enough partially</span>
<span class="c1">#       occupied states in metals (can write EventHandler but it would be nice if we could</span>
<span class="c1">#       fix this problem in advance.</span>
<span class="c1">#    3) How do we handle options related to parallelism e.g. paral_kgb?</span>
<span class="c1">#    4) The API of the factory functions must be simple enough so that we can easily generate</span>
<span class="c1">#       flows but, on the other hand, we would like to decorate the input with extra features</span>
<span class="c1">#       e.g. we would like to do a LDA+U band structure, a LDA+U relaxation etc.</span>
<span class="c1">#       For a possible solution based on factory functions see:</span>
<span class="c1">#</span>
<span class="c1">#            http://python-3-patterns-idioms-test.readthedocs.org/en/latest/Factory.html</span>
<span class="c1">#</span>
<span class="c1">#       for decorator pattern see:</span>
<span class="c1">#</span>
<span class="c1">#            http://www.tutorialspoint.com/design_pattern/decorator_pattern.htm</span>


<span class="c1"># Name of the (default) tolerance used by the runlevels.</span>
<span class="n">_runl2tolname</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;scf&quot;</span><span class="p">:</span> <span class="s1">&#39;tolvrs&#39;</span><span class="p">,</span>
    <span class="s2">&quot;nscf&quot;</span><span class="p">:</span> <span class="s1">&#39;tolwfr&#39;</span><span class="p">,</span>
    <span class="s2">&quot;dfpt&quot;</span><span class="p">:</span> <span class="s1">&#39;toldfe&#39;</span><span class="p">,</span>        <span class="c1"># ?</span>
    <span class="s2">&quot;screening&quot;</span><span class="p">:</span> <span class="s1">&#39;toldfe&#39;</span><span class="p">,</span>   <span class="c1"># dummy</span>
    <span class="s2">&quot;sigma&quot;</span><span class="p">:</span> <span class="s1">&#39;toldfe&#39;</span><span class="p">,</span>       <span class="c1"># dummy</span>
    <span class="s2">&quot;bse&quot;</span><span class="p">:</span> <span class="s1">&#39;toldfe&#39;</span><span class="p">,</span>         <span class="c1"># ?</span>
    <span class="s2">&quot;relax&quot;</span><span class="p">:</span> <span class="s1">&#39;tolrff&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># Tolerances for the different levels of accuracy.</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Tolerance&#39;</span><span class="p">,</span> <span class="s2">&quot;low normal high&quot;</span><span class="p">)</span>
<span class="n">_tolerances</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;toldfe&quot;</span><span class="p">:</span> <span class="n">T</span><span class="p">(</span><span class="mf">1.e-7</span><span class="p">,</span>  <span class="mf">1.e-8</span><span class="p">,</span>  <span class="mf">1.e-9</span><span class="p">),</span>
    <span class="s2">&quot;tolvrs&quot;</span><span class="p">:</span> <span class="n">T</span><span class="p">(</span><span class="mf">1.e-7</span><span class="p">,</span>  <span class="mf">1.e-8</span><span class="p">,</span>  <span class="mf">1.e-9</span><span class="p">),</span>
    <span class="s2">&quot;tolwfr&quot;</span><span class="p">:</span> <span class="n">T</span><span class="p">(</span><span class="mf">1.e-15</span><span class="p">,</span> <span class="mf">1.e-17</span><span class="p">,</span> <span class="mf">1.e-19</span><span class="p">),</span>
    <span class="s2">&quot;tolrff&quot;</span><span class="p">:</span> <span class="n">T</span><span class="p">(</span><span class="mf">0.04</span><span class="p">,</span>   <span class="mf">0.02</span><span class="p">,</span>   <span class="mf">0.01</span><span class="p">)}</span>
<span class="k">del</span> <span class="n">T</span>


<span class="c1"># Default values used if user do not specify them</span>
<span class="c1"># TODO: Design an object similar to DictVaspInputSet</span>
<span class="n">_DEFAULTS</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">kppa</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">class</span> <span class="nc">ShiftMode</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class defining the mode to be used for the shifts.</span>
<span class="sd">    G: Gamma centered</span>
<span class="sd">    M: Monkhorst-Pack ((0.5, 0.5, 0.5))</span>
<span class="sd">    S: Symmetric. Respects the chksymbreak with multiple shifts</span>
<span class="sd">    O: OneSymmetric. Respects the chksymbreak with a single shift (as in &#39;S&#39; if a single shift is given, gamma</span>
<span class="sd">        centered otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">GammaCentered</span> <span class="o">=</span> <span class="s1">&#39;G&#39;</span>
    <span class="n">MonkhorstPack</span> <span class="o">=</span> <span class="s1">&#39;M&#39;</span>
    <span class="n">Symmetric</span> <span class="o">=</span> <span class="s1">&#39;S&#39;</span>
    <span class="n">OneSymmetric</span> <span class="o">=</span> <span class="s1">&#39;O&#39;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_object</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an instance of ShiftMode based on the type of object passed. Converts strings to ShiftMode depending</span>
<span class="sd">        on the iniital letter of the string. G for GammaCenterd, M for MonkhorstPack, S for Symmetric, O for OneSymmetric.</span>
<span class="sd">        Case insensitive.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obj</span>
        <span class="k">elif</span> <span class="n">is_string</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The object provided is not handled: type&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_stopping_criterion</span><span class="p">(</span><span class="n">runlevel</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the stopping criterion for this runlevel with the given accuracy.&quot;&quot;&quot;</span>
    <span class="n">tolname</span> <span class="o">=</span> <span class="n">_runl2tolname</span><span class="p">[</span><span class="n">runlevel</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">tolname</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_tolerances</span><span class="p">[</span><span class="n">tolname</span><span class="p">],</span> <span class="n">accuracy</span><span class="p">)}</span>


<span class="k">def</span> <span class="nf">_find_ecut_pawecutdg</span><span class="p">(</span><span class="n">ecut</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a |AttrDict| with the value of ``ecut`` and ``pawecutdg``.&quot;&quot;&quot;</span>
    <span class="c1"># Get ecut and pawecutdg from the pseudo hints.</span>
    <span class="k">if</span> <span class="n">ecut</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">pawecutdg</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">ispaw</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pseudos</span><span class="p">)):</span>
        <span class="n">has_hints</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">has_hints</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pseudos</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ecut</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">has_hints</span><span class="p">:</span>
            <span class="n">ecut</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">hint_for_accuracy</span><span class="p">(</span><span class="n">accuracy</span><span class="p">)</span><span class="o">.</span><span class="n">ecut</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pseudos</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AbinitInput</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;ecut is None but pseudos do not provide hints for ecut&quot;</span><span class="p">)</span>

    <span class="c1"># TODO: This should be the new API.</span>
    <span class="k">if</span> <span class="n">pawecutdg</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">ispaw</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pseudos</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">has_hints</span><span class="p">:</span>
            <span class="n">pawecutdg</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">hint_for_accuracy</span><span class="p">(</span><span class="n">accuracy</span><span class="p">)</span><span class="o">.</span><span class="n">pawecutdg</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pseudos</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;pawecutdg is None but pseudos do not provide hints&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">AttrDict</span><span class="p">(</span><span class="n">ecut</span><span class="o">=</span><span class="n">ecut</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="n">pawecutdg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_find_scf_nband</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span> <span class="n">electrons</span><span class="p">,</span> <span class="n">spinat</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the value of ``nband``.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">electrons</span><span class="o">.</span><span class="n">nband</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">electrons</span><span class="o">.</span><span class="n">nband</span>

    <span class="n">nsppol</span><span class="p">,</span> <span class="n">smearing</span> <span class="o">=</span> <span class="n">electrons</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="n">electrons</span><span class="o">.</span><span class="n">smearing</span>

    <span class="c1"># Number of valence electrons including possible extra charge</span>
    <span class="n">nval</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">num_valence_electrons</span><span class="p">(</span><span class="n">pseudos</span><span class="p">)</span>
    <span class="n">nval</span> <span class="o">-=</span> <span class="n">electrons</span><span class="o">.</span><span class="n">charge</span>

    <span class="c1"># First guess (semiconductors)</span>
    <span class="n">nband</span> <span class="o">=</span> <span class="n">nval</span> <span class="o">//</span> <span class="mi">2</span>

    <span class="c1"># TODO: Find better algorithm</span>
    <span class="c1"># If nband is too small we may kill the job, increase nband and restart</span>
    <span class="c1"># but this change could cause problems in the other steps of the calculation</span>
    <span class="c1"># if the change is not propagated e.g. phonons in metals.</span>
    <span class="k">if</span> <span class="n">smearing</span><span class="p">:</span>
        <span class="c1"># metallic occupation</span>
        <span class="n">nband</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">nband</span><span class="o">*</span><span class="mf">1.2</span><span class="p">),</span> <span class="n">nband</span><span class="o">+</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nband</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">nband</span><span class="o">*</span><span class="mf">1.1</span><span class="p">),</span> <span class="n">nband</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span>

    <span class="c1"># Increase number of bands based on the starting magnetization</span>
    <span class="k">if</span> <span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">spinat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nband</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spinat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>

    <span class="c1"># Force even nband (easier to divide among procs, mandatory if nspinor == 2)</span>
    <span class="n">nband</span> <span class="o">+=</span> <span class="n">nband</span> <span class="o">%</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">nband</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_shifts</span><span class="p">(</span><span class="n">shift_mode</span><span class="p">,</span> <span class="n">structure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gives the shifts based on the selected shift mode and on the symmetry of the structure.</span>
<span class="sd">    G: Gamma centered</span>
<span class="sd">    M: Monkhorst-Pack ((0.5, 0.5, 0.5))</span>
<span class="sd">    S: Symmetric. Respects the chksymbreak with multiple shifts</span>
<span class="sd">    O: OneSymmetric. Respects the chksymbreak with a single shift (as in &#39;S&#39; if a single shift is given, gamma</span>
<span class="sd">        centered otherwise.</span>

<span class="sd">    Note: for some cases (e.g. body centered tetragonal), both the Symmetric and OneSymmetric may fail to satisfy the</span>
<span class="sd">        ``chksymbreak`` condition (Abinit input variable).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">shift_mode</span> <span class="o">==</span> <span class="n">ShiftMode</span><span class="o">.</span><span class="n">GammaCentered</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">shift_mode</span> <span class="o">==</span> <span class="n">ShiftMode</span><span class="o">.</span><span class="n">MonkhorstPack</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">((</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">shift_mode</span> <span class="o">==</span> <span class="n">ShiftMode</span><span class="o">.</span><span class="n">Symmetric</span><span class="p">:</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="n">Structure</span><span class="o">.</span><span class="n">from_sites</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">structure</span><span class="o">.</span><span class="n">calc_shiftk</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">shift_mode</span> <span class="o">==</span> <span class="n">ShiftMode</span><span class="o">.</span><span class="n">OneSymmetric</span><span class="p">:</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="n">Structure</span><span class="o">.</span><span class="n">from_sites</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">calc_shiftk</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shifts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">shifts</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;shift_mode `</span><span class="si">%s</span><span class="s2"> `not valid.&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">shift_mode</span><span class="p">))</span>


<div class="viewcode-block" id="gs_input"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.factories.gs_input">[docs]</a><span class="k">def</span> <span class="nf">gs_input</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span>
             <span class="n">kppa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ecut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scf_nband</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="n">spin_mode</span><span class="o">=</span><span class="s2">&quot;polarized&quot;</span><span class="p">,</span>
             <span class="n">smearing</span><span class="o">=</span><span class="s2">&quot;fermi_dirac:0.1 eV&quot;</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scf_algorithm</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a |AbinitInput| for ground-state calculation.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure: |Structure| object.</span>
<span class="sd">        pseudos: List of filenames or list of |Pseudo| objects or |PseudoTable| object.</span>
<span class="sd">        kppa: Defines the sampling used for the SCF run. Defaults to 1000 if not given.</span>
<span class="sd">        ecut: cutoff energy in Ha (if None, ecut is initialized from the pseudos according to accuracy)</span>
<span class="sd">        pawecutdg: cutoff energy in Ha for PAW double-grid (if None, pawecutdg is initialized from the pseudos</span>
<span class="sd">            according to accuracy)</span>
<span class="sd">        scf_nband: Number of bands for SCF run. If scf_nband is None, nband is automatically initialized</span>
<span class="sd">            from the list of pseudos, the structure and the smearing option.</span>
<span class="sd">        accuracy: Accuracy of the calculation.</span>
<span class="sd">        spin_mode: Spin polarization.</span>
<span class="sd">        smearing: Smearing technique.</span>
<span class="sd">        charge: Electronic charge added to the unit cell.</span>
<span class="sd">        scf_algorithm: Algorithm used for solving of the SCF cycle.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">multi</span> <span class="o">=</span> <span class="n">ebands_input</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span>
                 <span class="n">kppa</span><span class="o">=</span><span class="n">kppa</span><span class="p">,</span> <span class="n">ndivsm</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">ecut</span><span class="o">=</span><span class="n">ecut</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="n">pawecutdg</span><span class="p">,</span> <span class="n">scf_nband</span><span class="o">=</span><span class="n">scf_nband</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">spin_mode</span><span class="o">=</span><span class="n">spin_mode</span><span class="p">,</span>
                 <span class="n">smearing</span><span class="o">=</span><span class="n">smearing</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">,</span> <span class="n">scf_algorithm</span><span class="o">=</span><span class="n">scf_algorithm</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">multi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="ebands_input"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.factories.ebands_input">[docs]</a><span class="k">def</span> <span class="nf">ebands_input</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span>
                 <span class="n">kppa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nscf_nband</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ndivsm</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                 <span class="n">ecut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scf_nband</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="n">spin_mode</span><span class="o">=</span><span class="s2">&quot;polarized&quot;</span><span class="p">,</span>
                 <span class="n">smearing</span><span class="o">=</span><span class="s2">&quot;fermi_dirac:0.1 eV&quot;</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scf_algorithm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dos_kppa</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a |MultiDataset| object for band structure calculations.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure: |Structure| object.</span>
<span class="sd">        pseudos: List of filenames or list of |Pseudo| objects or |PseudoTable| object.</span>
<span class="sd">        kppa: Defines the sampling used for the SCF run. Defaults to 1000 if not given.</span>
<span class="sd">        nscf_nband: Number of bands included in the NSCF run. Set to scf_nband + 10 if None.</span>
<span class="sd">        ndivsm: Number of divisions used to sample the smallest segment of the k-path.</span>
<span class="sd">            if 0, only the GS input is returned in multi[0].</span>
<span class="sd">        ecut: cutoff energy in Ha (if None, ecut is initialized from the pseudos according to accuracy)</span>
<span class="sd">        pawecutdg: cutoff energy in Ha for PAW double-grid (if None, pawecutdg is initialized from the pseudos</span>
<span class="sd">            according to accuracy)</span>
<span class="sd">        scf_nband: Number of bands for SCF run. If scf_nband is None, nband is automatically initialized</span>
<span class="sd">            from the list of pseudos, the structure and the smearing option.</span>
<span class="sd">        accuracy: Accuracy of the calculation.</span>
<span class="sd">        spin_mode: Spin polarization.</span>
<span class="sd">        smearing: Smearing technique.</span>
<span class="sd">        charge: Electronic charge added to the unit cell.</span>
<span class="sd">        scf_algorithm: Algorithm used for solving of the SCF cycle.</span>
<span class="sd">        dos_kppa: Scalar or List of integers with the number of k-points per atom</span>
<span class="sd">            to be used for the computation of the DOS (None if DOS is not wanted).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">structure</span> <span class="o">=</span> <span class="n">Structure</span><span class="o">.</span><span class="n">as_structure</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dos_kppa</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dos_kppa</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">dos_kppa</span> <span class="o">=</span> <span class="p">[</span><span class="n">dos_kppa</span><span class="p">]</span>

    <span class="n">multi</span> <span class="o">=</span> <span class="n">MultiDataset</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span> <span class="n">ndtset</span><span class="o">=</span><span class="mi">2</span> <span class="k">if</span> <span class="n">dos_kppa</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">2</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">dos_kppa</span><span class="p">))</span>

    <span class="c1"># Set the cutoff energies.</span>
    <span class="n">multi</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">_find_ecut_pawecutdg</span><span class="p">(</span><span class="n">ecut</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="p">,</span> <span class="n">multi</span><span class="o">.</span><span class="n">pseudos</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">))</span>

    <span class="c1"># SCF calculation.</span>
    <span class="n">kppa</span> <span class="o">=</span> <span class="n">_DEFAULTS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kppa&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">kppa</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">kppa</span>
    <span class="n">scf_ksampling</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">KSampling</span><span class="o">.</span><span class="n">automatic_density</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">kppa</span><span class="p">,</span> <span class="n">chksymbreak</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">scf_electrons</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">Electrons</span><span class="p">(</span><span class="n">spin_mode</span><span class="o">=</span><span class="n">spin_mode</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="n">smearing</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">scf_algorithm</span><span class="p">,</span>
                                   <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">,</span> <span class="n">nband</span><span class="o">=</span><span class="n">scf_nband</span><span class="p">,</span> <span class="n">fband</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">spin_mode</span> <span class="o">==</span> <span class="s2">&quot;polarized&quot;</span><span class="p">:</span>
        <span class="n">multi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_autospinat</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">scf_electrons</span><span class="o">.</span><span class="n">nband</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scf_electrons</span><span class="o">.</span><span class="n">nband</span> <span class="o">=</span> <span class="n">_find_scf_nband</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">multi</span><span class="o">.</span><span class="n">pseudos</span><span class="p">,</span> <span class="n">scf_electrons</span><span class="p">,</span> <span class="n">multi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;spinat&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

    <span class="n">multi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">scf_ksampling</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="n">multi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">scf_electrons</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="n">multi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">_stopping_criterion</span><span class="p">(</span><span class="s2">&quot;scf&quot;</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">ndivsm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">multi</span>

    <span class="c1"># Band structure calculation.</span>
    <span class="n">nscf_ksampling</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">KSampling</span><span class="o">.</span><span class="n">path_from_structure</span><span class="p">(</span><span class="n">ndivsm</span><span class="p">,</span> <span class="n">structure</span><span class="p">)</span>
    <span class="n">nscf_nband</span> <span class="o">=</span> <span class="n">scf_electrons</span><span class="o">.</span><span class="n">nband</span> <span class="o">+</span> <span class="mi">10</span> <span class="k">if</span> <span class="n">nscf_nband</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">nscf_nband</span>
    <span class="n">nscf_electrons</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">Electrons</span><span class="p">(</span><span class="n">spin_mode</span><span class="o">=</span><span class="n">spin_mode</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="n">smearing</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;iscf&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">2</span><span class="p">},</span>
                                    <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">,</span> <span class="n">nband</span><span class="o">=</span><span class="n">nscf_nband</span><span class="p">,</span> <span class="n">fband</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">multi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">nscf_ksampling</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="n">multi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">nscf_electrons</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="n">multi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">_stopping_criterion</span><span class="p">(</span><span class="s2">&quot;nscf&quot;</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">))</span>

    <span class="c1"># DOS calculation with different values of kppa.</span>
    <span class="k">if</span> <span class="n">dos_kppa</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">kppa</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dos_kppa</span><span class="p">):</span>
            <span class="n">dos_ksampling</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">KSampling</span><span class="o">.</span><span class="n">automatic_density</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">kppa</span><span class="p">,</span> <span class="n">chksymbreak</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1">#dos_ksampling = aobj.KSampling.monkhorst(dos_ngkpt, shiftk=dos_shiftk, chksymbreak=0)</span>
            <span class="n">dos_electrons</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">Electrons</span><span class="p">(</span><span class="n">spin_mode</span><span class="o">=</span><span class="n">spin_mode</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="n">smearing</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;iscf&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">2</span><span class="p">},</span>
                                           <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">,</span> <span class="n">nband</span><span class="o">=</span><span class="n">nscf_nband</span><span class="p">)</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">i</span>
            <span class="n">multi</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">dos_ksampling</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
            <span class="n">multi</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">dos_electrons</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
            <span class="n">multi</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">_stopping_criterion</span><span class="p">(</span><span class="s2">&quot;nscf&quot;</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">multi</span></div>


<div class="viewcode-block" id="ion_ioncell_relax_input"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.factories.ion_ioncell_relax_input">[docs]</a><span class="k">def</span> <span class="nf">ion_ioncell_relax_input</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span>
                            <span class="n">kppa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nband</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">ecut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="n">spin_mode</span><span class="o">=</span><span class="s2">&quot;polarized&quot;</span><span class="p">,</span>
                            <span class="n">smearing</span><span class="o">=</span><span class="s2">&quot;fermi_dirac:0.1 eV&quot;</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scf_algorithm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shift_mode</span><span class="o">=</span><span class="s1">&#39;Monkhorst-pack&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a |MultiDataset| for a structural relaxation. The first dataset optmizes the</span>
<span class="sd">    atomic positions at fixed unit cell. The second datasets optimizes both ions and unit cell parameters.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure: |Structure| object.</span>
<span class="sd">        pseudos: List of filenames or list of |Pseudo| objects or |PseudoTable| object.</span>
<span class="sd">        kppa: Defines the sampling used for the Brillouin zone.</span>
<span class="sd">        nband: Number of bands included in the SCF run.</span>
<span class="sd">        accuracy: Accuracy of the calculation.</span>
<span class="sd">        spin_mode: Spin polarization.</span>
<span class="sd">        smearing: Smearing technique.</span>
<span class="sd">        charge: Electronic charge added to the unit cell.</span>
<span class="sd">        scf_algorithm: Algorithm used for the solution of the SCF cycle.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">structure</span> <span class="o">=</span> <span class="n">Structure</span><span class="o">.</span><span class="n">as_structure</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
    <span class="n">multi</span> <span class="o">=</span> <span class="n">MultiDataset</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span> <span class="n">ndtset</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Set the cutoff energies.</span>
    <span class="n">multi</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">_find_ecut_pawecutdg</span><span class="p">(</span><span class="n">ecut</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="p">,</span> <span class="n">multi</span><span class="o">.</span><span class="n">pseudos</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">))</span>

    <span class="n">kppa</span> <span class="o">=</span> <span class="n">_DEFAULTS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kppa&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">kppa</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">kppa</span>

    <span class="n">shift_mode</span> <span class="o">=</span> <span class="n">ShiftMode</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">shift_mode</span><span class="p">)</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="n">_get_shifts</span><span class="p">(</span><span class="n">shift_mode</span><span class="p">,</span> <span class="n">structure</span><span class="p">)</span>
    <span class="n">ksampling</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">KSampling</span><span class="o">.</span><span class="n">automatic_density</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">kppa</span><span class="p">,</span> <span class="n">chksymbreak</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shifts</span><span class="o">=</span><span class="n">shifts</span><span class="p">)</span>
    <span class="n">electrons</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">Electrons</span><span class="p">(</span><span class="n">spin_mode</span><span class="o">=</span><span class="n">spin_mode</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="n">smearing</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">scf_algorithm</span><span class="p">,</span>
                               <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">,</span> <span class="n">nband</span><span class="o">=</span><span class="n">nband</span><span class="p">,</span> <span class="n">fband</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">spin_mode</span> <span class="o">==</span> <span class="s2">&quot;polarized&quot;</span><span class="p">:</span>
        <span class="n">spinat_dict</span> <span class="o">=</span> <span class="n">multi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_autospinat</span><span class="p">()</span>
        <span class="n">multi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">spinat_dict</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">electrons</span><span class="o">.</span><span class="n">nband</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">electrons</span><span class="o">.</span><span class="n">nband</span> <span class="o">=</span> <span class="n">_find_scf_nband</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">multi</span><span class="o">.</span><span class="n">pseudos</span><span class="p">,</span> <span class="n">electrons</span><span class="p">,</span> <span class="n">multi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;spinat&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

    <span class="n">ion_relax</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">RelaxationMethod</span><span class="o">.</span><span class="n">atoms_only</span><span class="p">(</span><span class="n">atoms_constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">ioncell_relax</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">RelaxationMethod</span><span class="o">.</span><span class="n">atoms_and_cell</span><span class="p">(</span><span class="n">atoms_constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">multi</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">electrons</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="n">multi</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">ksampling</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>

    <span class="n">multi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">ion_relax</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="n">multi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">_stopping_criterion</span><span class="p">(</span><span class="s2">&quot;relax&quot;</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">))</span>

    <span class="n">multi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">ioncell_relax</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="n">multi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">_stopping_criterion</span><span class="p">(</span><span class="s2">&quot;relax&quot;</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">multi</span></div>


<div class="viewcode-block" id="ion_ioncell_relax_and_ebands_input"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.factories.ion_ioncell_relax_and_ebands_input">[docs]</a><span class="k">def</span> <span class="nf">ion_ioncell_relax_and_ebands_input</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span>
                                       <span class="n">kppa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nband</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                       <span class="n">ecut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="n">spin_mode</span><span class="o">=</span><span class="s2">&quot;polarized&quot;</span><span class="p">,</span>
                                       <span class="n">smearing</span><span class="o">=</span><span class="s2">&quot;fermi_dirac:0.1 eV&quot;</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scf_algorithm</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a |MultiDataset| for a structural relaxation followed by a band structure run.</span>
<span class="sd">    The first dataset optimizes the atomic positions at fixed unit cell.</span>
<span class="sd">    The second datasets optimizes both ions and unit cell parameters.</span>
<span class="sd">    The other datasets perform a band structure calculation.</span>

<span class="sd">    .. warning::</span>

<span class="sd">        Client code is responsible for propagating the relaxed structure obtained with the</span>
<span class="sd">        second dataset to the inputs used for the band structure calculation.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure: |Structure| object.</span>
<span class="sd">        pseudos: List of filenames or list of |Pseudo| objects or |PseudoTable| object.</span>
<span class="sd">        kppa: Defines the sampling used for the Brillouin zone.</span>
<span class="sd">        nband: Number of bands included in the SCF run.</span>
<span class="sd">        accuracy: Accuracy of the calculation.</span>
<span class="sd">        spin_mode: Spin polarization.</span>
<span class="sd">        smearing: Smearing technique.</span>
<span class="sd">        charge: Electronic charge added to the unit cell.</span>
<span class="sd">        scf_algorithm: Algorithm used for solving of the SCF cycle.</span>

<span class="sd">    Returns: |MultiDataset| object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">structure</span> <span class="o">=</span> <span class="n">Structure</span><span class="o">.</span><span class="n">as_structure</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>

    <span class="n">relax_multi</span> <span class="o">=</span> <span class="n">ion_ioncell_relax_input</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span>
                                          <span class="n">kppa</span><span class="o">=</span><span class="n">kppa</span><span class="p">,</span> <span class="n">nband</span><span class="o">=</span><span class="n">nband</span><span class="p">,</span>
                                          <span class="n">ecut</span><span class="o">=</span><span class="n">ecut</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="n">pawecutdg</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">spin_mode</span><span class="o">=</span><span class="n">spin_mode</span><span class="p">,</span>
                                          <span class="n">smearing</span><span class="o">=</span><span class="n">smearing</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">,</span> <span class="n">scf_algorithm</span><span class="o">=</span><span class="n">scf_algorithm</span><span class="p">)</span>

    <span class="n">ebands_multi</span> <span class="o">=</span> <span class="n">ebands_input</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span>
                                <span class="n">kppa</span><span class="o">=</span><span class="n">kppa</span><span class="p">,</span> <span class="n">nscf_nband</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ndivsm</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                                <span class="n">ecut</span><span class="o">=</span><span class="n">ecut</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="n">pawecutdg</span><span class="p">,</span> <span class="n">scf_nband</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">spin_mode</span><span class="o">=</span><span class="n">spin_mode</span><span class="p">,</span>
                                <span class="n">smearing</span><span class="o">=</span><span class="n">smearing</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">,</span> <span class="n">scf_algorithm</span><span class="o">=</span><span class="n">scf_algorithm</span><span class="p">,</span> <span class="n">dos_kppa</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">relax_multi</span> <span class="o">+</span> <span class="n">ebands_multi</span></div>


<div class="viewcode-block" id="g0w0_with_ppmodel_inputs"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.factories.g0w0_with_ppmodel_inputs">[docs]</a><span class="k">def</span> <span class="nf">g0w0_with_ppmodel_inputs</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span>
                             <span class="n">kppa</span><span class="p">,</span> <span class="n">nscf_nband</span><span class="p">,</span> <span class="n">ecuteps</span><span class="p">,</span> <span class="n">ecutsigx</span><span class="p">,</span>
                             <span class="n">ecut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shifts</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                             <span class="n">accuracy</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="n">spin_mode</span><span class="o">=</span><span class="s2">&quot;polarized&quot;</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="s2">&quot;fermi_dirac:0.1 eV&quot;</span><span class="p">,</span>
                             <span class="n">ppmodel</span><span class="o">=</span><span class="s2">&quot;godby&quot;</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scf_algorithm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inclvkb</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">scr_nband</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">sigma_nband</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gw_qprange</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a |MultiDataset| object that performs G0W0 calculations with the plasmon pole approximation.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure: |Structure| object.</span>
<span class="sd">        pseudos: List of filenames or list of |Pseudo| objects or |PseudoTable| object.</span>
<span class="sd">        kppa: Defines the sampling used for the SCF run.</span>
<span class="sd">        nscf_nband: Number of bands included in the NSCF run.</span>
<span class="sd">        ecuteps: Cutoff energy [Ha] for the screening matrix.</span>
<span class="sd">        ecutsigx: Cutoff energy [Ha] for the exchange part of the self-energy.</span>
<span class="sd">        ecut: cutoff energy in Ha (if None, ecut is initialized from the pseudos according to accuracy)</span>
<span class="sd">        pawecutdg: cutoff energy in Ha for PAW double-grid (if None, pawecutdg is initialized</span>
<span class="sd">            from the pseudos according to accuracy)</span>
<span class="sd">        shifts: Shifts for k-mesh.</span>
<span class="sd">        accuracy: Accuracy of the calculation.</span>
<span class="sd">        spin_mode: Spin polarization.</span>
<span class="sd">        smearing: Smearing technique.</span>
<span class="sd">        ppmodel: Plasmonpole technique.</span>
<span class="sd">        charge: Electronic charge added to the unit cell.</span>
<span class="sd">        scf_algorithm: Algorithm used for solving of the SCF cycle.</span>
<span class="sd">        inclvkb: Treatment of the dipole matrix elements (see abinit variable).</span>
<span class="sd">        scr_nband: Number of bands used to compute the screening (default is nscf_nband)</span>
<span class="sd">        sigma_nband: Number of bands used to compute the self-energy (default is nscf_nband)</span>
<span class="sd">        gw_qprange: Option for the automatic selection of k-points and bands for GW corrections.</span>
<span class="sd">            See Abinit docs for more detail. The default value makes the code compute the</span>
<span class="sd">            QP energies for all the point in the IBZ and one band above and one band below the Fermi level.</span>

<span class="sd">    .. versionchanged: 0.3</span>

<span class="sd">        The default value of ``shifts`` changed in v0.3 from (0.5, 0.5, 0.5) to (0.0, 0.0, 0.0).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">structure</span> <span class="o">=</span> <span class="n">Structure</span><span class="o">.</span><span class="n">as_structure</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
    <span class="n">multi</span> <span class="o">=</span> <span class="n">MultiDataset</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span> <span class="n">ndtset</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="c1"># Set the cutoff energies.</span>
    <span class="n">multi</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">_find_ecut_pawecutdg</span><span class="p">(</span><span class="n">ecut</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="p">,</span> <span class="n">multi</span><span class="o">.</span><span class="n">pseudos</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">))</span>

    <span class="n">scf_ksampling</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">KSampling</span><span class="o">.</span><span class="n">automatic_density</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">kppa</span><span class="p">,</span> <span class="n">chksymbreak</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shifts</span><span class="o">=</span><span class="n">shifts</span><span class="p">)</span>
    <span class="n">scf_electrons</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">Electrons</span><span class="p">(</span><span class="n">spin_mode</span><span class="o">=</span><span class="n">spin_mode</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="n">smearing</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">scf_algorithm</span><span class="p">,</span>
                                   <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">,</span> <span class="n">nband</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fband</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">scf_electrons</span><span class="o">.</span><span class="n">nband</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scf_electrons</span><span class="o">.</span><span class="n">nband</span> <span class="o">=</span> <span class="n">_find_scf_nband</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">multi</span><span class="o">.</span><span class="n">pseudos</span><span class="p">,</span> <span class="n">scf_electrons</span><span class="p">)</span>

    <span class="n">multi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">scf_ksampling</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="n">multi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">scf_electrons</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="n">multi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">_stopping_criterion</span><span class="p">(</span><span class="s2">&quot;scf&quot;</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">))</span>

    <span class="n">nscf_ksampling</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">KSampling</span><span class="o">.</span><span class="n">automatic_density</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">kppa</span><span class="p">,</span> <span class="n">chksymbreak</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shifts</span><span class="o">=</span><span class="n">shifts</span><span class="p">)</span>
    <span class="n">nscf_electrons</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">Electrons</span><span class="p">(</span><span class="n">spin_mode</span><span class="o">=</span><span class="n">spin_mode</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="n">smearing</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;iscf&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">2</span><span class="p">},</span>
                                    <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">,</span> <span class="n">nband</span><span class="o">=</span><span class="n">nscf_nband</span><span class="p">,</span> <span class="n">fband</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">multi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">nscf_ksampling</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="n">multi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">nscf_electrons</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="n">multi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">_stopping_criterion</span><span class="p">(</span><span class="s2">&quot;nscf&quot;</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">))</span>
    <span class="c1"># nbdbuf</span>

    <span class="c1"># Screening.</span>
    <span class="k">if</span> <span class="n">scr_nband</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">scr_nband</span> <span class="o">=</span> <span class="n">nscf_nband</span>
    <span class="n">screening</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">Screening</span><span class="p">(</span><span class="n">ecuteps</span><span class="p">,</span> <span class="n">scr_nband</span><span class="p">,</span> <span class="n">w_type</span><span class="o">=</span><span class="s2">&quot;RPA&quot;</span><span class="p">,</span> <span class="n">sc_mode</span><span class="o">=</span><span class="s2">&quot;one_shot&quot;</span><span class="p">,</span>
                               <span class="n">hilbert</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ecutwfn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inclvkb</span><span class="o">=</span><span class="n">inclvkb</span><span class="p">)</span>

    <span class="n">multi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">nscf_ksampling</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="n">multi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">nscf_electrons</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="n">multi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">screening</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="n">multi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">_stopping_criterion</span><span class="p">(</span><span class="s2">&quot;screening&quot;</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">))</span> <span class="c1"># Dummy</span>

    <span class="c1"># Sigma.</span>
    <span class="k">if</span> <span class="n">sigma_nband</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">sigma_nband</span> <span class="o">=</span> <span class="n">nscf_nband</span>
    <span class="n">self_energy</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">SelfEnergy</span><span class="p">(</span><span class="s2">&quot;gw&quot;</span><span class="p">,</span> <span class="s2">&quot;one_shot&quot;</span><span class="p">,</span> <span class="n">sigma_nband</span><span class="p">,</span> <span class="n">ecutsigx</span><span class="p">,</span> <span class="n">screening</span><span class="p">,</span>
                                  <span class="n">gw_qprange</span><span class="o">=</span><span class="n">gw_qprange</span><span class="p">,</span> <span class="n">ppmodel</span><span class="o">=</span><span class="n">ppmodel</span><span class="p">)</span>

    <span class="n">multi</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">nscf_ksampling</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="n">multi</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">nscf_electrons</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="n">multi</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">self_energy</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="n">multi</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">_stopping_criterion</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">))</span> <span class="c1"># Dummy</span>

    <span class="c1"># TODO: Cannot use istwfk != 1.</span>
    <span class="n">multi</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">istwfk</span><span class="o">=</span><span class="s2">&quot;*1&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">multi</span></div>


<div class="viewcode-block" id="g0w0_convergence_inputs"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.factories.g0w0_convergence_inputs">[docs]</a><span class="k">def</span> <span class="nf">g0w0_convergence_inputs</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span> <span class="n">kppa</span><span class="p">,</span> <span class="n">nscf_nband</span><span class="p">,</span> <span class="n">ecuteps</span><span class="p">,</span> <span class="n">ecutsigx</span><span class="p">,</span> <span class="n">scf_nband</span><span class="p">,</span> <span class="n">ecut</span><span class="p">,</span>
                            <span class="n">accuracy</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="n">spin_mode</span><span class="o">=</span><span class="s2">&quot;polarized&quot;</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="s2">&quot;fermi_dirac:0.1 eV&quot;</span><span class="p">,</span>
                            <span class="n">response_models</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scf_algorithm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inclvkb</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                            <span class="n">gw_qprange</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nksmall</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extra_abivars</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a |MultiDataset| object to generate a G0W0 work for the given the material.</span>
<span class="sd">    See also :cite:`Setten2017`.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure: |Structure| object</span>
<span class="sd">        pseudos: List of |Pseudo| objects.</span>
<span class="sd">        kppa: k points per reciprocal atom.</span>
<span class="sd">        scf_nband: number of scf bands</span>
<span class="sd">        ecut: ecut for all calcs that that are not ecut convergence  cals at scf level</span>
<span class="sd">        scf_ Defines the sampling used for the SCF run.</span>
<span class="sd">        nscf_nband: a list of number of bands included in the screening and sigmaruns.</span>
<span class="sd">            The NSCF run will be done with the maximum.</span>
<span class="sd">        ecuteps: list of Cutoff energy [Ha] for the screening matrix.</span>
<span class="sd">        ecutsigx: Cutoff energy [Ha] for the exchange part of the self-energy.</span>
<span class="sd">        accuracy: Accuracy of the calculation.</span>
<span class="sd">        spin_mode: Spin polarization.</span>
<span class="sd">        smearing: Smearing technique.</span>
<span class="sd">        charge: Electronic charge added to the unit cell.</span>
<span class="sd">        scf_algorithm: Algorithm used for solving of the SCF cycle.</span>
<span class="sd">        inclvkb: Treatment of the dipole matrix elements (see abinit variable).</span>
<span class="sd">        response_models: List of response models</span>
<span class="sd">        gw_qprange: selectpr for the qpoint mesh</span>
<span class="sd">        gamma: is true a gamma centered mesh is enforced</span>
<span class="sd">        nksmall: Kpoint division for additional band and dos calculations</span>
<span class="sd">        extra_abivars: Dictionary with extra variables passed to ABINIT for all tasks.</span>

<span class="sd">    extra abivars that are provided with _s appended will be take as a list of values to be tested a scf level</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">extra_abivars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">extra_abivars</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">response_models</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">response_models</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;godby&quot;</span><span class="p">]</span>

    <span class="n">scf_diffs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">extra_abivars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="c1">#for k in extra_abivars.keys():</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">k</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;_s&#39;</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">k</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">extra_abivars</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="c1"># to_add.update({k: values[-1]})</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="n">diff_abivars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">diff_abivars</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">if</span> <span class="n">pseudos</span><span class="o">.</span><span class="n">allpaw</span> <span class="ow">and</span> <span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;ecut&#39;</span><span class="p">:</span>
                    <span class="n">diff_abivars</span><span class="p">[</span><span class="s1">&#39;pawecutdg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff_abivars</span><span class="p">[</span><span class="s1">&#39;ecut&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
                <span class="n">scf_diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diff_abivars</span><span class="p">)</span>

    <span class="n">extra_abivars_all</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">ecut</span><span class="o">=</span><span class="n">ecut</span><span class="p">,</span>
        <span class="n">paral_kgb</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">istwfk</span><span class="o">=</span><span class="s2">&quot;*1&quot;</span><span class="p">,</span>
        <span class="n">timopt</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">nbdbuf</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">extra_abivars_all</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extra_abivars</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pseudos</span><span class="o">.</span><span class="n">allpaw</span><span class="p">:</span>
        <span class="n">extra_abivars_all</span><span class="p">[</span><span class="s1">&#39;pawecutdg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extra_abivars_all</span><span class="p">[</span><span class="s1">&#39;ecut&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>

    <span class="n">extra_abivars_gw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">inclvkb</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">symsigma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">gwpara</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">gwmem</span><span class="o">=</span><span class="s1">&#39;10&#39;</span><span class="p">,</span>
        <span class="n">prtsuscep</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span>

    <span class="c1"># all these too many options are for development only the current idea for the final version is</span>
    <span class="c1">#if gamma:</span>
    <span class="c1">#    scf_ksampling = aobj.KSampling.automatic_density(structure=structure, kppa=10000, chksymbreak=0, shifts=(0, 0, 0))</span>
    <span class="c1">#    nscf_ksampling = aobj.KSampling.gamma_centered(kpts=(2, 2, 2))</span>
    <span class="c1">#    if kppa &lt;= 13:</span>
    <span class="c1">#        nscf_ksampling = aobj.KSampling.gamma_centered(kpts=(scf_kppa, scf_kppa, scf_kppa))</span>
    <span class="c1">#    else:</span>
    <span class="c1">#        nscf_ksampling = aobj.KSampling.automatic_density(structure, scf_kppa, chksymbreak=0, shifts=(0, 0, 0))</span>
    <span class="c1">#else:</span>
    <span class="c1">#    scf_ksampling = aobj.KSampling.automatic_density(structure, scf_kppa, chksymbreak=0)</span>
    <span class="c1">#    nscf_ksampling = aobj.KSampling.automatic_density(structure, scf_kppa, chksymbreak=0)</span>

    <span class="k">if</span> <span class="n">gamma</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">kppa</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">scf_ksampling</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">KSampling</span><span class="o">.</span><span class="n">gamma_centered</span><span class="p">(</span><span class="n">kpts</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">nscf_ksampling</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">KSampling</span><span class="o">.</span><span class="n">gamma_centered</span><span class="p">(</span><span class="n">kpts</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">kppa</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">scf_ksampling</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">KSampling</span><span class="o">.</span><span class="n">gamma_centered</span><span class="p">(</span><span class="n">kpts</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">nscf_ksampling</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">KSampling</span><span class="o">.</span><span class="n">gamma_centered</span><span class="p">(</span><span class="n">kpts</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">kppa</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">scf_ksampling</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">KSampling</span><span class="o">.</span><span class="n">gamma_centered</span><span class="p">(</span><span class="n">kpts</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">kppa</span><span class="p">,</span> <span class="o">-</span><span class="n">kppa</span><span class="p">,</span> <span class="o">-</span><span class="n">kppa</span><span class="p">))</span>
            <span class="n">nscf_ksampling</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">KSampling</span><span class="o">.</span><span class="n">gamma_centered</span><span class="p">(</span><span class="n">kpts</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">kppa</span> <span class="o">&lt;=</span> <span class="mi">13</span><span class="p">:</span>
            <span class="n">scf_ksampling</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">KSampling</span><span class="o">.</span><span class="n">gamma_centered</span><span class="p">(</span><span class="n">kpts</span><span class="o">=</span><span class="p">(</span><span class="n">kppa</span><span class="p">,</span> <span class="n">kppa</span><span class="p">,</span> <span class="n">kppa</span><span class="p">))</span>
            <span class="n">nscf_ksampling</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">KSampling</span><span class="o">.</span><span class="n">gamma_centered</span><span class="p">(</span><span class="n">kpts</span><span class="o">=</span><span class="p">(</span><span class="n">kppa</span><span class="p">,</span> <span class="n">kppa</span><span class="p">,</span> <span class="n">kppa</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scf_ksampling</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">KSampling</span><span class="o">.</span><span class="n">automatic_density</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">kppa</span><span class="p">,</span> <span class="n">chksymbreak</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shifts</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">nscf_ksampling</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">KSampling</span><span class="o">.</span><span class="n">automatic_density</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">kppa</span><span class="p">,</span> <span class="n">chksymbreak</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shifts</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># this is the original behaviour before the development of the gwwrapper</span>
        <span class="n">scf_ksampling</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">KSampling</span><span class="o">.</span><span class="n">automatic_density</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">kppa</span><span class="p">,</span> <span class="n">chksymbreak</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">nscf_ksampling</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">KSampling</span><span class="o">.</span><span class="n">automatic_density</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">kppa</span><span class="p">,</span> <span class="n">chksymbreak</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">scf_electrons</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">Electrons</span><span class="p">(</span><span class="n">spin_mode</span><span class="o">=</span><span class="n">spin_mode</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="n">smearing</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">scf_algorithm</span><span class="p">,</span>
                                   <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">,</span> <span class="n">nband</span><span class="o">=</span><span class="n">scf_nband</span><span class="p">,</span> <span class="n">fband</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">nscf_electrons</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">Electrons</span><span class="p">(</span><span class="n">spin_mode</span><span class="o">=</span><span class="n">spin_mode</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="n">smearing</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;iscf&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">2</span><span class="p">},</span>
                                    <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">,</span> <span class="n">nband</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">nscf_nband</span><span class="p">),</span> <span class="n">fband</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">multi_scf</span> <span class="o">=</span> <span class="n">MultiDataset</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span> <span class="n">ndtset</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">scf_diffs</span><span class="p">)))</span>

    <span class="n">multi_scf</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">scf_ksampling</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="n">multi_scf</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">scf_electrons</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="n">multi_scf</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">extra_abivars_all</span><span class="p">)</span>
    <span class="n">multi_scf</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">_stopping_criterion</span><span class="p">(</span><span class="n">runlevel</span><span class="o">=</span><span class="s2">&quot;scf&quot;</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="n">accuracy</span><span class="p">))</span>
    <span class="n">multi_scf</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">extra_abivars</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">variables</span><span class="p">,</span> <span class="n">abinput</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">scf_diffs</span><span class="p">,</span> <span class="n">multi_scf</span><span class="p">):</span>
        <span class="n">abinput</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span>

    <span class="n">scf_inputs</span> <span class="o">=</span> <span class="n">multi_scf</span><span class="o">.</span><span class="n">split_datasets</span><span class="p">()</span>

    <span class="c1"># create nscf inputs</span>
    <span class="n">ndtset</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">if</span> <span class="n">nksmall</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="n">nscf_multi</span> <span class="o">=</span> <span class="n">MultiDataset</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="o">=</span><span class="n">pseudos</span><span class="p">,</span> <span class="n">ndtset</span><span class="o">=</span><span class="n">ndtset</span><span class="p">)</span>

    <span class="n">nscf_multi</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">nscf_electrons</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="n">nscf_multi</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">extra_abivars_all</span><span class="p">)</span>
    <span class="n">nscf_multi</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">_stopping_criterion</span><span class="p">(</span><span class="n">runlevel</span><span class="o">=</span><span class="s2">&quot;nscf&quot;</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="n">accuracy</span><span class="p">))</span>

    <span class="n">nscf_multi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">nscf_ksampling</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">nksmall</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># if nksmall add bandstructure and dos calculations as well</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;added band structure calculation&#39;</span><span class="p">)</span>
        <span class="n">bands_ksampling</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">KSampling</span><span class="o">.</span><span class="n">path_from_structure</span><span class="p">(</span><span class="n">ndivsm</span><span class="o">=</span><span class="n">nksmall</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">)</span>
        <span class="n">dos_ksampling</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">KSampling</span><span class="o">.</span><span class="n">automatic_density</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span> <span class="n">kppa</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>
        <span class="n">nscf_multi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">bands_ksampling</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
        <span class="n">nscf_multi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">({</span><span class="s1">&#39;chksymbreak&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
        <span class="n">nscf_multi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">dos_ksampling</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
        <span class="n">nscf_multi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">({</span><span class="s1">&#39;chksymbreak&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>

    <span class="n">nscf_inputs</span> <span class="o">=</span> <span class="n">nscf_multi</span><span class="o">.</span><span class="n">split_datasets</span><span class="p">()</span>

    <span class="c1"># create screening and sigma inputs</span>

    <span class="c1">#if scr_nband is None:</span>
    <span class="c1">#   scr_nband = nscf_nband_nscf</span>
    <span class="c1">#if sigma_nband is None:</span>
    <span class="c1">#     sigma_nband = nscf_nband_nscf</span>

    <span class="k">if</span> <span class="s1">&#39;cd&#39;</span> <span class="ow">in</span> <span class="n">response_models</span><span class="p">:</span>
        <span class="n">hilbert</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">HilbertTransform</span><span class="p">(</span><span class="n">nomegasf</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">domegasf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spmeth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nfreqre</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">freqremax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nfreqim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                        <span class="n">freqremin</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">scr_inputs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sigma_inputs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1">#print(&quot;ecuteps&quot;, ecuteps, &quot;nscf_nband&quot;, nscf_nband)</span>

    <span class="k">for</span> <span class="n">response_model</span> <span class="ow">in</span> <span class="n">response_models</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ecuteps_v</span> <span class="ow">in</span> <span class="n">ecuteps</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">nscf_nband_v</span> <span class="ow">in</span> <span class="n">nscf_nband</span><span class="p">:</span>
                <span class="n">scr_nband</span> <span class="o">=</span> <span class="n">nscf_nband_v</span>
                <span class="n">sigma_nband</span> <span class="o">=</span> <span class="n">nscf_nband_v</span>
                <span class="n">multi</span> <span class="o">=</span> <span class="n">MultiDataset</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span> <span class="n">ndtset</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">multi</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">nscf_ksampling</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
                <span class="n">multi</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">nscf_electrons</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
                <span class="n">multi</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">extra_abivars_all</span><span class="p">)</span>
                <span class="n">multi</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">extra_abivars_gw</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">response_model</span> <span class="o">==</span> <span class="s1">&#39;cd&#39;</span><span class="p">:</span>
                    <span class="n">screening</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">Screening</span><span class="p">(</span><span class="n">ecuteps_v</span><span class="p">,</span> <span class="n">scr_nband</span><span class="p">,</span> <span class="n">w_type</span><span class="o">=</span><span class="s2">&quot;RPA&quot;</span><span class="p">,</span> <span class="n">sc_mode</span><span class="o">=</span><span class="s2">&quot;one_shot&quot;</span><span class="p">,</span> <span class="n">hilbert</span><span class="o">=</span><span class="n">hilbert</span><span class="p">,</span>
                                               <span class="n">ecutwfn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inclvkb</span><span class="o">=</span><span class="n">inclvkb</span><span class="p">)</span>
                    <span class="n">self_energy</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">SelfEnergy</span><span class="p">(</span><span class="s2">&quot;gw&quot;</span><span class="p">,</span> <span class="s2">&quot;one_shot&quot;</span><span class="p">,</span> <span class="n">sigma_nband</span><span class="p">,</span> <span class="n">ecutsigx</span><span class="p">,</span> <span class="n">screening</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ppmodel</span> <span class="o">=</span> <span class="n">response_model</span>
                    <span class="n">screening</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">Screening</span><span class="p">(</span><span class="n">ecuteps_v</span><span class="p">,</span> <span class="n">scr_nband</span><span class="p">,</span> <span class="n">w_type</span><span class="o">=</span><span class="s2">&quot;RPA&quot;</span><span class="p">,</span> <span class="n">sc_mode</span><span class="o">=</span><span class="s2">&quot;one_shot&quot;</span><span class="p">,</span>
                                               <span class="n">hilbert</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ecutwfn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inclvkb</span><span class="o">=</span><span class="n">inclvkb</span><span class="p">)</span>
                    <span class="n">self_energy</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">SelfEnergy</span><span class="p">(</span><span class="s2">&quot;gw&quot;</span><span class="p">,</span> <span class="s2">&quot;one_shot&quot;</span><span class="p">,</span> <span class="n">sigma_nband</span><span class="p">,</span> <span class="n">ecutsigx</span><span class="p">,</span> <span class="n">screening</span><span class="p">,</span>
                                                  <span class="n">gw_qprange</span><span class="o">=</span><span class="n">gw_qprange</span><span class="p">,</span> <span class="n">ppmodel</span><span class="o">=</span><span class="n">ppmodel</span><span class="p">)</span>
                <span class="n">multi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">screening</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
                <span class="n">multi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">_stopping_criterion</span><span class="p">(</span><span class="s2">&quot;screening&quot;</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">))</span>  <span class="c1"># Dummy</span>
                <span class="n">multi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">self_energy</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
                <span class="n">multi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">_stopping_criterion</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">))</span>  <span class="c1"># Dummy</span>

                <span class="n">scr_input</span><span class="p">,</span> <span class="n">sigma_input</span> <span class="o">=</span> <span class="n">multi</span><span class="o">.</span><span class="n">split_datasets</span><span class="p">()</span>
                <span class="n">scr_inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scr_input</span><span class="p">)</span>
                <span class="n">sigma_inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sigma_input</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">scf_inputs</span><span class="p">,</span> <span class="n">nscf_inputs</span><span class="p">,</span> <span class="n">scr_inputs</span><span class="p">,</span> <span class="n">sigma_inputs</span></div>


<div class="viewcode-block" id="bse_with_mdf_inputs"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.factories.bse_with_mdf_inputs">[docs]</a><span class="k">def</span> <span class="nf">bse_with_mdf_inputs</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span>
                        <span class="n">scf_kppa</span><span class="p">,</span> <span class="n">nscf_nband</span><span class="p">,</span> <span class="n">nscf_ngkpt</span><span class="p">,</span> <span class="n">nscf_shiftk</span><span class="p">,</span>
                        <span class="n">ecuteps</span><span class="p">,</span> <span class="n">bs_loband</span><span class="p">,</span> <span class="n">bs_nband</span><span class="p">,</span> <span class="n">mbpt_sciss</span><span class="p">,</span> <span class="n">mdf_epsinf</span><span class="p">,</span>
                        <span class="n">ecut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">exc_type</span><span class="o">=</span><span class="s2">&quot;TDA&quot;</span><span class="p">,</span> <span class="n">bs_algo</span><span class="o">=</span><span class="s2">&quot;haydock&quot;</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="n">spin_mode</span><span class="o">=</span><span class="s2">&quot;polarized&quot;</span><span class="p">,</span>
                        <span class="n">smearing</span><span class="o">=</span><span class="s2">&quot;fermi_dirac:0.1 eV&quot;</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scf_algorithm</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a |MultiDataset| object that performs a GS + NSCF + Bethe-Salpeter calculation.</span>
<span class="sd">    The self-energy corrections are approximated with the scissors operator.</span>
<span class="sd">    The screening is modeled with the model dielectric function.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure: |Structure| object.</span>
<span class="sd">        pseudos: List of filenames or list of |Pseudo| objects or |PseudoTable| object.</span>
<span class="sd">        scf_kppa: Defines the sampling used for the SCF run.</span>
<span class="sd">        nscf_nband: Number of bands included in the NSCF run.</span>
<span class="sd">        nscf_ngkpt: Divisions of the k-mesh used for the NSCF and the BSE run.</span>
<span class="sd">        nscf_shiftk: Shifts used for the NSCF and the BSE run.</span>
<span class="sd">        ecuteps: Cutoff energy [Ha] for the screening matrix.</span>
<span class="sd">        bs_loband: Index of the first occupied band included the e-h basis set</span>
<span class="sd">            (ABINIT convention i.e. first band starts at 1).</span>
<span class="sd">            Can be scalar or array of shape (nsppol,)</span>
<span class="sd">        bs_nband: Highest band idex used for the construction of the e-h basis set.</span>
<span class="sd">        mbpt_sciss: Scissor energy in Hartree.</span>
<span class="sd">        mdf_epsinf: Value of the macroscopic dielectric function used in expression for the model dielectric function.</span>
<span class="sd">        ecut: cutoff energy in Ha (if None, ecut is initialized from the pseudos according to accuracy)</span>
<span class="sd">        pawecutdg: cutoff energy in Ha for PAW double-grid (if None, pawecutdg is initialized from the pseudos</span>
<span class="sd">            according to accuracy)</span>
<span class="sd">        exc_type: Approximation used for the BSE Hamiltonian (Tamm-Dancoff or coupling).</span>
<span class="sd">        bs_algo: Algorith for the computatio of the macroscopic dielectric function.</span>
<span class="sd">        accuracy: Accuracy of the calculation.</span>
<span class="sd">        spin_mode: Spin polarization.</span>
<span class="sd">        smearing: Smearing technique.</span>
<span class="sd">        charge: Electronic charge added to the unit cell.</span>
<span class="sd">        scf_algorithm: Algorithm used for solving the SCF cycle.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">structure</span> <span class="o">=</span> <span class="n">Structure</span><span class="o">.</span><span class="n">as_structure</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
    <span class="n">multi</span> <span class="o">=</span> <span class="n">MultiDataset</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span> <span class="n">ndtset</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1"># Set the cutoff energies.</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">_find_ecut_pawecutdg</span><span class="p">(</span><span class="n">ecut</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="p">,</span> <span class="n">multi</span><span class="o">.</span><span class="n">pseudos</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">)</span>
    <span class="n">multi</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">ecut</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">ecut</span><span class="p">,</span> <span class="n">ecutwfn</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">ecut</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">pawecutdg</span><span class="p">)</span>

    <span class="c1"># Ground-state</span>
    <span class="n">scf_ksampling</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">KSampling</span><span class="o">.</span><span class="n">automatic_density</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">scf_kppa</span><span class="p">,</span> <span class="n">chksymbreak</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">scf_electrons</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">Electrons</span><span class="p">(</span><span class="n">spin_mode</span><span class="o">=</span><span class="n">spin_mode</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="n">smearing</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">scf_algorithm</span><span class="p">,</span>
                                   <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">,</span> <span class="n">nband</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fband</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">scf_electrons</span><span class="o">.</span><span class="n">nband</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scf_electrons</span><span class="o">.</span><span class="n">nband</span> <span class="o">=</span> <span class="n">_find_scf_nband</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">multi</span><span class="o">.</span><span class="n">pseudos</span><span class="p">,</span> <span class="n">scf_electrons</span><span class="p">)</span>

    <span class="n">multi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">scf_ksampling</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="n">multi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">scf_electrons</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="n">multi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">_stopping_criterion</span><span class="p">(</span><span class="s2">&quot;scf&quot;</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">))</span>

    <span class="c1"># NSCF calculation with the randomly-shifted k-mesh.</span>
    <span class="n">nscf_ksampling</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">KSampling</span><span class="o">.</span><span class="n">monkhorst</span><span class="p">(</span><span class="n">nscf_ngkpt</span><span class="p">,</span> <span class="n">shiftk</span><span class="o">=</span><span class="n">nscf_shiftk</span><span class="p">,</span> <span class="n">chksymbreak</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">nscf_electrons</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">Electrons</span><span class="p">(</span><span class="n">spin_mode</span><span class="o">=</span><span class="n">spin_mode</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="n">smearing</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;iscf&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">2</span><span class="p">},</span>
                                    <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">,</span> <span class="n">nband</span><span class="o">=</span><span class="n">nscf_nband</span><span class="p">,</span> <span class="n">fband</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">multi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">nscf_ksampling</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="n">multi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">nscf_electrons</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="n">multi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">_stopping_criterion</span><span class="p">(</span><span class="s2">&quot;nscf&quot;</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">))</span>

    <span class="c1"># BSE calculation.</span>
    <span class="n">exc_ham</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">ExcHamiltonian</span><span class="p">(</span><span class="n">bs_loband</span><span class="p">,</span> <span class="n">bs_nband</span><span class="p">,</span> <span class="n">mbpt_sciss</span><span class="p">,</span> <span class="n">coulomb_mode</span><span class="o">=</span><span class="s2">&quot;model_df&quot;</span><span class="p">,</span> <span class="n">ecuteps</span><span class="o">=</span><span class="n">ecuteps</span><span class="p">,</span>
                                  <span class="n">spin_mode</span><span class="o">=</span><span class="n">spin_mode</span><span class="p">,</span> <span class="n">mdf_epsinf</span><span class="o">=</span><span class="n">mdf_epsinf</span><span class="p">,</span> <span class="n">exc_type</span><span class="o">=</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">algo</span><span class="o">=</span><span class="n">bs_algo</span><span class="p">,</span>
                                  <span class="n">bs_freq_mesh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_lf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">zcut</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">multi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">nscf_ksampling</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="n">multi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">nscf_electrons</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="n">multi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">exc_ham</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="c1">#multi[2].set_vars(_stopping_criterion(&quot;nscf&quot;, accuracy))</span>

    <span class="c1"># TODO: Cannot use istwfk != 1.</span>
    <span class="n">multi</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">istwfk</span><span class="o">=</span><span class="s2">&quot;*1&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">multi</span></div>


<div class="viewcode-block" id="scf_phonons_inputs"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.factories.scf_phonons_inputs">[docs]</a><span class="k">def</span> <span class="nf">scf_phonons_inputs</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span> <span class="n">kppa</span><span class="p">,</span>
                       <span class="n">ecut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scf_nband</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="n">spin_mode</span><span class="o">=</span><span class="s2">&quot;polarized&quot;</span><span class="p">,</span>
                       <span class="n">smearing</span><span class="o">=</span><span class="s2">&quot;fermi_dirac:0.1 eV&quot;</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scf_algorithm</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># TODO: Please check the unused variables in the function</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of input files for performing phonon calculations.</span>
<span class="sd">    GS input + the input files for the phonon calculation.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure: |Structure| object.</span>
<span class="sd">        pseudos: List of filenames or list of |Pseudo| objects or |PseudoTable| object.</span>
<span class="sd">        kppa: Defines the sampling used for the SCF run.</span>
<span class="sd">        ecut: cutoff energy in Ha (if None, ecut is initialized from the pseudos according to accuracy)</span>
<span class="sd">        pawecutdg: cutoff energy in Ha for PAW double-grid (if None, pawecutdg is initialized from the</span>
<span class="sd">            pseudos according to accuracy)</span>
<span class="sd">        scf_nband: Number of bands for SCF run. If scf_nband is None, nband is automatically initialized from the list of</span>
<span class="sd">            pseudos, the structure and the smearing option.</span>
<span class="sd">        accuracy: Accuracy of the calculation.</span>
<span class="sd">        spin_mode: Spin polarization.</span>
<span class="sd">        smearing: Smearing technique.</span>
<span class="sd">        charge: Electronic charge added to the unit cell.</span>
<span class="sd">        scf_algorithm: Algorithm used for solving of the SCF cycle.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Build the input file for the GS run.</span>
    <span class="n">gs_inp</span> <span class="o">=</span> <span class="n">AbinitInput</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="o">=</span><span class="n">pseudos</span><span class="p">)</span>

    <span class="c1"># Set the cutoff energies.</span>
    <span class="n">gs_inp</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">_find_ecut_pawecutdg</span><span class="p">(</span><span class="n">ecut</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="p">,</span> <span class="n">gs_inp</span><span class="o">.</span><span class="n">pseudos</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">))</span>

    <span class="n">ksampling</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">KSampling</span><span class="o">.</span><span class="n">automatic_density</span><span class="p">(</span><span class="n">gs_inp</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">kppa</span><span class="p">,</span> <span class="n">chksymbreak</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">gs_inp</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">ksampling</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="n">gs_inp</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">tolvrs</span><span class="o">=</span><span class="mf">1.0e-18</span><span class="p">)</span>

    <span class="c1"># Get the qpoints in the IBZ. Note that here we use a q-mesh with ngkpt=(4,4,4) and shiftk=(0,0,0)</span>
    <span class="c1"># i.e. the same parameters used for the k-mesh in gs_inp.</span>
    <span class="n">qpoints</span> <span class="o">=</span> <span class="n">gs_inp</span><span class="o">.</span><span class="n">abiget_ibz</span><span class="p">(</span><span class="n">ngkpt</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">shiftk</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">kptopt</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">points</span>
    <span class="c1">#print(&quot;get_ibz qpoints:&quot;, qpoints)</span>

    <span class="c1"># Build the input files for the q-points in the IBZ.</span>
    <span class="c1">#ph_inputs = MultiDataset(gs_inp.structure, pseudos=gs_inp.pseudos, ndtset=len(qpoints))</span>

    <span class="n">ph_inputs</span> <span class="o">=</span> <span class="n">MultiDataset</span><span class="o">.</span><span class="n">replicate_input</span><span class="p">(</span><span class="n">gs_inp</span><span class="p">,</span> <span class="n">ndtset</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">qpoints</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">ph_inp</span><span class="p">,</span> <span class="n">qpt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ph_inputs</span><span class="p">,</span> <span class="n">qpoints</span><span class="p">):</span>
        <span class="c1"># Response-function calculation for phonons.</span>
        <span class="n">ph_inp</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span>
            <span class="n">rfphon</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>        <span class="c1"># Will consider phonon-type perturbation</span>
            <span class="n">nqpt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>          <span class="c1"># One wavevector is to be considered</span>
            <span class="n">qpt</span><span class="o">=</span><span class="n">qpt</span><span class="p">,</span>         <span class="c1"># This wavevector is q=0 (Gamma)</span>
            <span class="n">tolwfr</span><span class="o">=</span><span class="mf">1.0e-20</span><span class="p">,</span>
            <span class="n">kptopt</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>        <span class="c1"># TODO: One could use symmetries for Gamma.</span>
        <span class="p">)</span>
            <span class="c1">#rfatpol   1 1   # Only the first atom is displaced</span>
            <span class="c1">#rfdir   1 0 0   # Along the first reduced coordinate axis</span>
            <span class="c1">#kptopt   2      # Automatic generation of k points, taking</span>

        <span class="n">irred_perts</span> <span class="o">=</span> <span class="n">ph_inp</span><span class="o">.</span><span class="n">abiget_irred_phperts</span><span class="p">()</span>
        <span class="c1"># TODO irred_perts is not used ??</span>

        <span class="c1">#for pert in irred_perts:</span>
        <span class="c1">#    #print(pert)</span>
        <span class="c1">#    # TODO this will work for phonons, but not for the other types of perturbations.</span>
        <span class="c1">#    ph_inp = q_inp.deepcopy()</span>
        <span class="c1">#    rfdir = 3 * [0]</span>
        <span class="c1">#    rfdir[pert.idir -1] = 1</span>
        <span class="c1">#    ph_inp.set_vars(</span>
        <span class="c1">#        rfdir=rfdir,</span>
        <span class="c1">#        rfatpol=[pert.ipert, pert.ipert]</span>
        <span class="c1">#    )</span>
        <span class="c1">#    ph_inputs.append(ph_inp)</span>

    <span class="c1"># Split input into gs_inp and ph_inputs</span>
    <span class="n">all_inps</span> <span class="o">=</span> <span class="p">[</span><span class="n">gs_inp</span><span class="p">]</span>
    <span class="n">all_inps</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ph_inputs</span><span class="o">.</span><span class="n">split_datasets</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">all_inps</span></div>


<div class="viewcode-block" id="phonons_from_gsinput"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.factories.phonons_from_gsinput">[docs]</a><span class="k">def</span> <span class="nf">phonons_from_gsinput</span><span class="p">(</span><span class="n">gs_inp</span><span class="p">,</span> <span class="n">ph_ngqpt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">qpoints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_ddk</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_dde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_bec</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">ph_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ddk_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dde_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wfq_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">qpoints_to_skip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of inputs in the form of a MultiDataset to perform phonon calculations, based on</span>
<span class="sd">    a ground state |AbinitInput|.</span>
<span class="sd">    It will determine if WFQ files should be calculated for some q points and add the NSCF AbinitInputs to the set.</span>
<span class="sd">    The inputs have the following tags, according to their function: &quot;ddk&quot;, &quot;dde&quot;, &quot;nscf&quot;, &quot;ph_q_pert&quot;.</span>
<span class="sd">    All of them have the tag &quot;phonon&quot;.</span>

<span class="sd">    Args:</span>
<span class="sd">        gs_inp: an |AbinitInput| representing a ground state calculation, likely the SCF performed to get the WFK.</span>
<span class="sd">        ph_ngqpt: a list of three integers representing the gamma centered q-point grid used for the calculation.</span>
<span class="sd">            If None and qpoint==None the ngkpt value present in the gs_input will be used.</span>
<span class="sd">            Incompatible with qpoints.</span>
<span class="sd">        qpoints: a list of of coordinatesq points in reduced coordinates for which the phonon perturbations will</span>
<span class="sd">            be calculated. Incompatible with ph_ngqpt.</span>
<span class="sd">        with_ddk: If True, if Gamma is included in the list of qpoints it will add inputs for the calculations of</span>
<span class="sd">            the DDK.</span>
<span class="sd">        with_dde: If True, if Gamma is included in the list of qpoints it will add inputs for the calculations of</span>
<span class="sd">            the DDE. Automatically sets with_ddk=True.</span>
<span class="sd">        with_bec: If Truem if Gamma is included in the list of qpoints the DDE will be calculated in the same</span>
<span class="sd">            input as the phonons. This will allow to determine the BECs.</span>
<span class="sd">            Automatically sets with_ddk=True and with_dde=False.</span>
<span class="sd">        ph_tol: a dictionary with a single key defining the type of tolarence used for the phonon calculations and</span>
<span class="sd">            its value. Default: {&quot;tolvrs&quot;: 1.0e-10}.</span>
<span class="sd">        ddk_tol: a dictionary with a single key defining the type of tolarence used for the DDK calculations and</span>
<span class="sd">            its value. Default: {&quot;tolwfr&quot;: 1.0e-22}.</span>
<span class="sd">        dde_tol: a dictionary with a single key defining the type of tolarence used for the DDE calculations and</span>
<span class="sd">            its value. Default: {&quot;tolvrs&quot;: 1.0e-10}.</span>
<span class="sd">        wfq_tol: a dictionary with a single key defining the type of tolarence used for the NSCF calculations of</span>
<span class="sd">            the WFQ and its value. Default {&quot;tolwfr&quot;: 1.0e-22}.</span>
<span class="sd">        qpoints_to_skip: a list of coordinates of q points in reduced coordinates that will be skipped.</span>
<span class="sd">            Useful when calculating multiple grids for the same system to avoid duplicate calculations.</span>
<span class="sd">            If a DDB needs to be extended with more q points use e.g. ddb.qpoints.to_array().</span>
<span class="sd">        manager: |TaskManager| of the task. If None, the manager is initialized from the config file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gs_inp</span> <span class="o">=</span> <span class="n">gs_inp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
    <span class="n">gs_inp</span><span class="o">.</span><span class="n">pop_irdvars</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">with_dde</span><span class="p">:</span>
        <span class="n">with_ddk</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">with_bec</span><span class="p">:</span>
        <span class="n">with_ddk</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">with_dde</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">ph_tol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ph_tol</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tolvrs&quot;</span><span class="p">:</span> <span class="mf">1.0e-10</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">ddk_tol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ddk_tol</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tolwfr&quot;</span><span class="p">:</span> <span class="mf">1.0e-22</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">dde_tol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dde_tol</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tolvrs&quot;</span><span class="p">:</span> <span class="mf">1.0e-10</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">wfq_tol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">wfq_tol</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tolwfr&quot;</span><span class="p">:</span> <span class="mf">1.0e-22</span><span class="p">}</span>

    <span class="n">multi</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">qpoints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ph_ngqpt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ph_ngqpt and qpoints can&#39;t be used together&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">qpoints</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ph_ngqpt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ph_ngqpt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gs_inp</span><span class="p">[</span><span class="s2">&quot;ngkpt&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ph_ngqpt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ph_ngqpt</span><span class="p">)</span>

        <span class="n">qpoints</span> <span class="o">=</span> <span class="n">gs_inp</span><span class="o">.</span><span class="n">abiget_ibz</span><span class="p">(</span><span class="n">ngkpt</span><span class="o">=</span><span class="n">ph_ngqpt</span><span class="p">,</span> <span class="n">shiftk</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">kptopt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span><span class="o">.</span><span class="n">points</span>

    <span class="k">if</span> <span class="n">qpoints_to_skip</span><span class="p">:</span>
        <span class="n">preserved_qpoints</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">qpoints</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">ddb_q</span><span class="p">)</span> <span class="k">for</span> <span class="n">ddb_q</span> <span class="ow">in</span> <span class="n">qpoints_to_skip</span><span class="p">):</span>
                <span class="n">preserved_qpoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="n">qpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">preserved_qpoints</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ph_ngqpt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">gs_inp</span><span class="p">[</span><span class="s2">&quot;ngkpt&quot;</span><span class="p">]</span> <span class="o">%</span> <span class="n">ph_ngqpt</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="c1"># find which q points are needed and build nscf inputs to calculate the WFQ</span>
        <span class="n">kpts</span> <span class="o">=</span> <span class="n">gs_inp</span><span class="o">.</span><span class="n">abiget_ibz</span><span class="p">(</span><span class="n">shiftk</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">kptopt</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">nscf_qpt</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">qpoints</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kpts</span><span class="p">:</span>
                <span class="n">nscf_qpt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nscf_qpt</span><span class="p">:</span>
            <span class="n">multi_nscf</span> <span class="o">=</span> <span class="n">MultiDataset</span><span class="o">.</span><span class="n">replicate_input</span><span class="p">(</span><span class="n">gs_inp</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nscf_qpt</span><span class="p">))</span>
            <span class="n">multi_nscf</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">kptopt</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nqpt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">iscf</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">wfq_tol</span><span class="p">:</span>
                <span class="n">multi_nscf</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="o">**</span><span class="n">wfq_tol</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">multi_nscf</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">tolwfr</span><span class="o">=</span><span class="mf">1e-22</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">nscf_inp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">nscf_qpt</span><span class="p">,</span> <span class="n">multi_nscf</span><span class="p">):</span>
                <span class="n">nscf_inp</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">qpt</span><span class="o">=</span><span class="n">q</span><span class="p">)</span>

            <span class="n">multi_nscf</span><span class="o">.</span><span class="n">add_tags</span><span class="p">(</span><span class="n">NSCF</span><span class="p">)</span>

            <span class="n">multi</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">multi_nscf</span><span class="p">)</span>

    <span class="c1"># Build the input files for the q-points in the IBZ.</span>
    <span class="c1"># Response-function calculation for phonons.</span>
    <span class="k">for</span> <span class="n">qpt</span> <span class="ow">in</span> <span class="n">qpoints</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">qpt</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">with_ddk</span><span class="p">:</span>
                <span class="n">multi_ddk</span> <span class="o">=</span> <span class="n">gs_inp</span><span class="o">.</span><span class="n">make_ddk_inputs</span><span class="p">(</span><span class="n">tolerance</span><span class="o">=</span><span class="n">ddk_tol</span><span class="p">)</span>
                <span class="n">multi_ddk</span><span class="o">.</span><span class="n">add_tags</span><span class="p">(</span><span class="n">DDK</span><span class="p">)</span>
                <span class="n">multi</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">multi_ddk</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">with_dde</span><span class="p">:</span>
                <span class="n">multi_dde</span> <span class="o">=</span> <span class="n">gs_inp</span><span class="o">.</span><span class="n">make_dde_inputs</span><span class="p">(</span><span class="n">dde_tol</span><span class="p">)</span>
                <span class="n">multi_dde</span><span class="o">.</span><span class="n">add_tags</span><span class="p">(</span><span class="n">DDE</span><span class="p">)</span>
                <span class="n">multi</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">multi_dde</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">with_bec</span><span class="p">:</span>
                <span class="n">multi_bec</span> <span class="o">=</span> <span class="n">gs_inp</span><span class="o">.</span><span class="n">make_bec_inputs</span><span class="p">(</span><span class="n">ph_tol</span><span class="p">)</span>
                <span class="n">multi_bec</span><span class="o">.</span><span class="n">add_tags</span><span class="p">(</span><span class="n">BEC</span><span class="p">)</span>
                <span class="n">multi</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">multi_bec</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="n">multi_ph_q</span> <span class="o">=</span> <span class="n">gs_inp</span><span class="o">.</span><span class="n">make_ph_inputs_qpoint</span><span class="p">(</span><span class="n">qpt</span><span class="p">,</span> <span class="n">ph_tol</span><span class="p">)</span>
        <span class="n">multi_ph_q</span><span class="o">.</span><span class="n">add_tags</span><span class="p">(</span><span class="n">PH_Q_PERT</span><span class="p">)</span>
        <span class="n">multi</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">multi_ph_q</span><span class="p">)</span>

    <span class="n">multi</span> <span class="o">=</span> <span class="n">MultiDataset</span><span class="o">.</span><span class="n">from_inputs</span><span class="p">(</span><span class="n">multi</span><span class="p">)</span>
    <span class="n">multi</span><span class="o">.</span><span class="n">add_tags</span><span class="p">(</span><span class="n">PHONON</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">multi</span></div>

<div class="viewcode-block" id="piezo_elastic_inputs_from_gsinput"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.factories.piezo_elastic_inputs_from_gsinput">[docs]</a><span class="k">def</span> <span class="nf">piezo_elastic_inputs_from_gsinput</span><span class="p">(</span><span class="n">gs_inp</span><span class="p">,</span> <span class="n">ddk_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rf_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ddk_split</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rf_split</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a |MultiDataset| for performing elastic and piezoelectric constants calculations.</span>
<span class="sd">    GS input + the input files for the elastic and piezoelectric constants calculation.</span>

<span class="sd">    Args:</span>
<span class="sd">        gs_inp: Ground State input to build piezo elastic inputs from.</span>
<span class="sd">        ddk_tol: Tolerance for the DDK calculation (i.e. {&quot;tolwfr&quot;: 1.0e-20}).</span>
<span class="sd">        rf_tol: Tolerance for the Strain RF calculations (i.e. {&quot;tolvrs&quot;: 1.0e-12}).</span>
<span class="sd">        ddk_split: Whether to split the DDK calculations.</span>
<span class="sd">        rf_split: whether to split the RF calculations.</span>
<span class="sd">        manager: |TaskManager| of the task. If None, the manager is initialized from the config file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Ddk input(s)</span>
    <span class="k">if</span> <span class="n">ddk_split</span><span class="p">:</span>
        <span class="n">multi</span> <span class="o">=</span> <span class="n">gs_inp</span><span class="o">.</span><span class="n">make_ddk_inputs</span><span class="p">(</span><span class="n">tolerance</span><span class="o">=</span><span class="n">ddk_tol</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ddk_inp</span> <span class="o">=</span> <span class="n">gs_inp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>

        <span class="n">ddk_inp</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span>
                    <span class="n">rfelfd</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>             <span class="c1"># Activate the calculation of the d/dk perturbation</span>
                    <span class="n">rfdir</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>        <span class="c1"># All directions</span>
                    <span class="n">nqpt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>               <span class="c1"># One wavevector is to be considered</span>
                    <span class="n">qpt</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>        <span class="c1"># q-wavevector.</span>
                    <span class="n">kptopt</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>             <span class="c1"># Take into account time-reversal symmetry.</span>
                    <span class="n">iscf</span><span class="o">=-</span><span class="mi">3</span><span class="p">,</span>              <span class="c1"># The d/dk perturbation must be treated in a non-self-consistent way</span>
                    <span class="n">paral_kgb</span><span class="o">=</span><span class="mi">0</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="n">ddk_tol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ddk_tol</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tolwfr&quot;</span><span class="p">:</span> <span class="mf">1.0e-20</span><span class="p">}</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ddk_tol</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_tolerances</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ddk_tol</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid tolerance: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ddk_tol</span><span class="p">))</span>
        <span class="n">ddk_inp</span><span class="o">.</span><span class="n">pop_tolerances</span><span class="p">()</span>
        <span class="n">ddk_inp</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">ddk_tol</span><span class="p">)</span>
        <span class="c1"># Adding buffer to help convergence ...</span>
        <span class="k">if</span> <span class="s1">&#39;nbdbuf&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ddk_inp</span><span class="p">:</span>
            <span class="n">nbdbuf</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.1</span><span class="o">*</span><span class="n">ddk_inp</span><span class="p">[</span><span class="s1">&#39;nband&#39;</span><span class="p">]),</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">ddk_inp</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">nband</span><span class="o">=</span><span class="n">ddk_inp</span><span class="p">[</span><span class="s1">&#39;nband&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">nbdbuf</span><span class="p">,</span> <span class="n">nbdbuf</span><span class="o">=</span><span class="n">nbdbuf</span><span class="p">)</span>

        <span class="n">multi</span> <span class="o">=</span> <span class="n">MultiDataset</span><span class="o">.</span><span class="n">from_inputs</span><span class="p">([</span><span class="n">ddk_inp</span><span class="p">])</span>
    <span class="n">multi</span><span class="o">.</span><span class="n">add_tags</span><span class="p">(</span><span class="n">DDK</span><span class="p">)</span>

    <span class="c1"># Response Function input(s)</span>
    <span class="k">if</span> <span class="n">rf_split</span><span class="p">:</span>
        <span class="n">multi_rf</span> <span class="o">=</span> <span class="n">gs_inp</span><span class="o">.</span><span class="n">make_strain_perts_inputs</span><span class="p">(</span><span class="n">tolerance</span><span class="o">=</span><span class="n">rf_tol</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rf_inp</span> <span class="o">=</span> <span class="n">gs_inp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>

        <span class="n">rf_inp</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">rfphon</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>                          <span class="c1"># Atomic displacement perturbation</span>
                        <span class="n">rfatpol</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">gs_inp</span><span class="o">.</span><span class="n">structure</span><span class="p">)),</span> <span class="c1"># Perturbation of all atoms</span>
                        <span class="n">rfstrs</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>                          <span class="c1"># Do the strain perturbations</span>
                        <span class="n">rfdir</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>                     <span class="c1"># All directions</span>
                        <span class="n">nqpt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>                            <span class="c1"># One wavevector is to be considered</span>
                        <span class="n">qpt</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>                     <span class="c1"># q-wavevector.</span>
                        <span class="n">kptopt</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>                          <span class="c1"># Take into account time-reversal symmetry.</span>
                        <span class="n">iscf</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>                            <span class="c1"># The rfstrs perturbation must be treated in a</span>
                                                           <span class="c1">#  self-consistent way</span>
                        <span class="n">paral_kgb</span><span class="o">=</span><span class="mi">0</span>
                        <span class="p">)</span>

        <span class="k">if</span> <span class="n">rf_tol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rf_tol</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tolvrs&quot;</span><span class="p">:</span> <span class="mf">1.0e-12</span><span class="p">}</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rf_tol</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_tolerances</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">rf_tol</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid tolerance: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rf_tol</span><span class="p">))</span>
        <span class="n">rf_inp</span><span class="o">.</span><span class="n">pop_tolerances</span><span class="p">()</span>
        <span class="n">rf_inp</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">rf_tol</span><span class="p">)</span>

        <span class="c1"># Adding buffer to help convergence ...</span>
        <span class="k">if</span> <span class="s1">&#39;nbdbuf&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rf_inp</span><span class="p">:</span>
            <span class="n">nbdbuf</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.1</span><span class="o">*</span><span class="n">rf_inp</span><span class="p">[</span><span class="s1">&#39;nband&#39;</span><span class="p">]),</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">rf_inp</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">nband</span><span class="o">=</span><span class="n">rf_inp</span><span class="p">[</span><span class="s1">&#39;nband&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">nbdbuf</span><span class="p">,</span> <span class="n">nbdbuf</span><span class="o">=</span><span class="n">nbdbuf</span><span class="p">)</span>

        <span class="n">multi_rf</span> <span class="o">=</span> <span class="n">MultiDataset</span><span class="o">.</span><span class="n">from_inputs</span><span class="p">([</span><span class="n">rf_inp</span><span class="p">])</span>
    <span class="n">multi_rf</span><span class="o">.</span><span class="n">add_tags</span><span class="p">([</span><span class="n">DFPT</span><span class="p">,</span> <span class="n">STRAIN</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="n">multi_rf</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">inp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rfphon&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">inp</span><span class="o">.</span><span class="n">add_tags</span><span class="p">(</span><span class="n">PHONON</span><span class="p">)</span>

    <span class="n">multi</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">multi_rf</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">multi</span></div>


<div class="viewcode-block" id="scf_piezo_elastic_inputs"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.factories.scf_piezo_elastic_inputs">[docs]</a><span class="k">def</span> <span class="nf">scf_piezo_elastic_inputs</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span> <span class="n">kppa</span><span class="p">,</span> <span class="n">ecut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scf_nband</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">accuracy</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="n">spin_mode</span><span class="o">=</span><span class="s2">&quot;polarized&quot;</span><span class="p">,</span>
                             <span class="n">smearing</span><span class="o">=</span><span class="s2">&quot;fermi_dirac:0.1 eV&quot;</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scf_algorithm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">ddk_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rf_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ddk_split</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rf_split</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a |MultiDataset| for performing elastic and piezoelectric constants calculations.</span>
<span class="sd">    GS input + the input files for the elastic and piezoelectric constants calculation.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure: |Structure| object.</span>
<span class="sd">        pseudos: List of filenames or list of |Pseudo| objects or |PseudoTable| object.</span>
<span class="sd">        kppa: Defines the sampling used for the SCF run.</span>
<span class="sd">        ecut: cutoff energy in Ha (if None, ecut is initialized from the pseudos according to accuracy)</span>
<span class="sd">        pawecutdg: cutoff energy in Ha for PAW double-grid (if None, pawecutdg is initialized from the</span>
<span class="sd">            pseudos according to accuracy)</span>
<span class="sd">        scf_nband: Number of bands for SCF run. If scf_nband is None, nband is automatically initialized</span>
<span class="sd">            from the list of pseudos, the structure and the smearing option.</span>
<span class="sd">        accuracy: Accuracy of the calculation.</span>
<span class="sd">        spin_mode: Spin polarization.</span>
<span class="sd">        smearing: Smearing technique.</span>
<span class="sd">        charge: Electronic charge added to the unit cell.</span>
<span class="sd">        scf_algorithm: Algorithm used for solving of the SCF cycle.</span>
<span class="sd">        ddk_tol: Tolerance for the Ddk calculation (i.e. {&quot;tolwfr&quot;: 1.0e-20}).</span>
<span class="sd">        rf_tol: Tolerance for the Strain RF calculations (i.e. {&quot;tolvrs&quot;: 1.0e-12}).</span>
<span class="sd">        ddk_split: Whether to split the ddk calculations.</span>
<span class="sd">        rf_split: whether to split the RF calculations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Build the input file for the GS run.</span>
    <span class="n">gs_inp</span> <span class="o">=</span> <span class="n">scf_input</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="o">=</span><span class="n">pseudos</span><span class="p">,</span> <span class="n">kppa</span><span class="o">=</span><span class="n">kppa</span><span class="p">,</span> <span class="n">ecut</span><span class="o">=</span><span class="n">ecut</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="n">pawecutdg</span><span class="p">,</span>
                       <span class="n">nband</span><span class="o">=</span><span class="n">scf_nband</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">spin_mode</span><span class="o">=</span><span class="n">spin_mode</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="n">smearing</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">,</span>
                       <span class="n">scf_algorithm</span><span class="o">=</span><span class="n">scf_algorithm</span><span class="p">,</span> <span class="n">shift_mode</span><span class="o">=</span><span class="s2">&quot;Gamma-centered&quot;</span><span class="p">)</span>

    <span class="c1"># Adding buffer to help convergence ...</span>
    <span class="n">nbdbuf</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.1</span><span class="o">*</span><span class="n">gs_inp</span><span class="p">[</span><span class="s1">&#39;nband&#39;</span><span class="p">]),</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">gs_inp</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">nband</span><span class="o">=</span><span class="n">gs_inp</span><span class="p">[</span><span class="s1">&#39;nband&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">nbdbuf</span><span class="p">,</span> <span class="n">nbdbuf</span><span class="o">=</span><span class="n">nbdbuf</span><span class="p">)</span>

    <span class="n">multi</span> <span class="o">=</span> <span class="n">MultiDataset</span><span class="o">.</span><span class="n">from_inputs</span><span class="p">([</span><span class="n">gs_inp</span><span class="p">])</span>

    <span class="n">piezo_elastic_inputs</span> <span class="o">=</span> <span class="n">piezo_elastic_inputs_from_gsinput</span><span class="p">(</span><span class="n">gs_inp</span><span class="o">=</span><span class="n">gs_inp</span><span class="p">,</span> <span class="n">ddk_tol</span><span class="o">=</span><span class="n">ddk_tol</span><span class="p">,</span> <span class="n">rf_tol</span><span class="o">=</span><span class="n">rf_tol</span><span class="p">)</span>

    <span class="n">multi</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">piezo_elastic_inputs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">multi</span></div>


<span class="k">def</span> <span class="nf">scf_input</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span> <span class="n">kppa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ecut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nband</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span>
              <span class="n">spin_mode</span><span class="o">=</span><span class="s2">&quot;polarized&quot;</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="s2">&quot;fermi_dirac:0.1 eV&quot;</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scf_algorithm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">shift_mode</span><span class="o">=</span><span class="s2">&quot;Monkhorst-Pack&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns an |AbinitInput| object for standard GS calculations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">structure</span> <span class="o">=</span> <span class="n">Structure</span><span class="o">.</span><span class="n">as_structure</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>

    <span class="n">abinit_input</span> <span class="o">=</span> <span class="n">AbinitInput</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">)</span>

    <span class="c1"># Set the cutoff energies.</span>
    <span class="n">abinit_input</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">_find_ecut_pawecutdg</span><span class="p">(</span><span class="n">ecut</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="p">,</span> <span class="n">abinit_input</span><span class="o">.</span><span class="n">pseudos</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">))</span>

    <span class="c1"># SCF calculation.</span>
    <span class="n">kppa</span> <span class="o">=</span> <span class="n">_DEFAULTS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kppa&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">kppa</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">kppa</span>
    <span class="n">shift_mode</span> <span class="o">=</span> <span class="n">ShiftMode</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">shift_mode</span><span class="p">)</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="n">_get_shifts</span><span class="p">(</span><span class="n">shift_mode</span><span class="p">,</span> <span class="n">structure</span><span class="p">)</span>
    <span class="n">scf_ksampling</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">KSampling</span><span class="o">.</span><span class="n">automatic_density</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">kppa</span><span class="p">,</span> <span class="n">chksymbreak</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shifts</span><span class="o">=</span><span class="n">shifts</span><span class="p">)</span>
    <span class="n">scf_electrons</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">Electrons</span><span class="p">(</span><span class="n">spin_mode</span><span class="o">=</span><span class="n">spin_mode</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="n">smearing</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">scf_algorithm</span><span class="p">,</span>
                                   <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">,</span> <span class="n">nband</span><span class="o">=</span><span class="n">nband</span><span class="p">,</span> <span class="n">fband</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">spin_mode</span> <span class="o">==</span> <span class="s2">&quot;polarized&quot;</span><span class="p">:</span>
        <span class="n">abinit_input</span><span class="o">.</span><span class="n">set_autospinat</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">scf_electrons</span><span class="o">.</span><span class="n">nband</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scf_electrons</span><span class="o">.</span><span class="n">nband</span> <span class="o">=</span> <span class="n">_find_scf_nband</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">abinit_input</span><span class="o">.</span><span class="n">pseudos</span><span class="p">,</span> <span class="n">scf_electrons</span><span class="p">,</span>
                                              <span class="n">abinit_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;spinat&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

    <span class="n">abinit_input</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">scf_ksampling</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="n">abinit_input</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">scf_electrons</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="n">abinit_input</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">_stopping_criterion</span><span class="p">(</span><span class="s2">&quot;scf&quot;</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">abinit_input</span>


<span class="k">def</span> <span class="nf">ebands_from_gsinput</span><span class="p">(</span><span class="n">gsinput</span><span class="p">,</span> <span class="n">nband</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ndivsm</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return an |AbinitInput| object to compute a band structure from a GS SCF input.</span>

<span class="sd">    Args:</span>
<span class="sd">        gsinput:</span>
<span class="sd">        nband:</span>
<span class="sd">        ndivsm:</span>
<span class="sd">        accuracy:</span>

<span class="sd">    Return: |AbinitInput|</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># create a copy to avoid messing with the previous input</span>
    <span class="n">bands_input</span> <span class="o">=</span> <span class="n">gsinput</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>

    <span class="n">bands_input</span><span class="o">.</span><span class="n">pop_irdvars</span><span class="p">()</span>

    <span class="n">nscf_ksampling</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">KSampling</span><span class="o">.</span><span class="n">path_from_structure</span><span class="p">(</span><span class="n">ndivsm</span><span class="p">,</span> <span class="n">gsinput</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nband</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nband</span> <span class="o">=</span> <span class="n">gsinput</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nband&quot;</span><span class="p">,</span> <span class="n">gsinput</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">num_valence_electrons</span><span class="p">(</span><span class="n">gsinput</span><span class="o">.</span><span class="n">pseudos</span><span class="p">))</span> <span class="o">+</span> <span class="mi">10</span>

    <span class="n">bands_input</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">nscf_ksampling</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="n">bands_input</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">nband</span><span class="o">=</span><span class="n">nband</span><span class="p">,</span> <span class="n">iscf</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">bands_input</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">_stopping_criterion</span><span class="p">(</span><span class="s2">&quot;nscf&quot;</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">bands_input</span>


<span class="k">def</span> <span class="nf">dos_from_gsinput</span><span class="p">(</span><span class="n">gsinput</span><span class="p">,</span> <span class="n">dos_kppa</span><span class="p">,</span> <span class="n">nband</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="n">pdos</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="c1"># create a copy to avoid messing with the previous input</span>
    <span class="n">dos_input</span> <span class="o">=</span> <span class="n">gsinput</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
    <span class="n">dos_input</span><span class="o">.</span><span class="n">pop_irdvars</span><span class="p">()</span>

    <span class="n">dos_ksampling</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">KSampling</span><span class="o">.</span><span class="n">automatic_density</span><span class="p">(</span><span class="n">dos_input</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">dos_kppa</span><span class="p">,</span> <span class="n">chksymbreak</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">dos_input</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">dos_ksampling</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="n">dos_input</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">iscf</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="n">ionmov</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">dos_input</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">_stopping_criterion</span><span class="p">(</span><span class="s2">&quot;nscf&quot;</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">pdos</span><span class="p">:</span>
        <span class="c1"># FIXME</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">dos_input</span>


<span class="k">def</span> <span class="nf">ioncell_relax_from_gsinput</span><span class="p">(</span><span class="n">gsinput</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">):</span>

    <span class="n">ioncell_input</span> <span class="o">=</span> <span class="n">gsinput</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
    <span class="n">ioncell_input</span><span class="o">.</span><span class="n">pop_irdvars</span><span class="p">()</span>

    <span class="n">ioncell_relax</span> <span class="o">=</span> <span class="n">aobj</span><span class="o">.</span><span class="n">RelaxationMethod</span><span class="o">.</span><span class="n">atoms_and_cell</span><span class="p">(</span><span class="n">atoms_constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">ioncell_input</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">ioncell_relax</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">())</span>
    <span class="n">ioncell_input</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">_stopping_criterion</span><span class="p">(</span><span class="s2">&quot;relax&quot;</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">ioncell_input</span>


<span class="k">def</span> <span class="nf">hybrid_oneshot_input</span><span class="p">(</span><span class="n">gsinput</span><span class="p">,</span> <span class="n">functional</span><span class="o">=</span><span class="s2">&quot;hse06&quot;</span><span class="p">,</span> <span class="n">ecutsigx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gw_qprange</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

    <span class="n">hybrid_input</span> <span class="o">=</span> <span class="n">gsinput</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
    <span class="n">hybrid_input</span><span class="o">.</span><span class="n">pop_irdvars</span><span class="p">()</span>

    <span class="n">functional</span> <span class="o">=</span> <span class="n">functional</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">functional</span> <span class="o">==</span> <span class="s1">&#39;hse06&#39;</span><span class="p">:</span>
        <span class="n">gwcalctyp</span> <span class="o">=</span> <span class="mi">115</span>
        <span class="n">icutcoul</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">rcut</span> <span class="o">=</span> <span class="mf">9.090909</span>
    <span class="k">elif</span> <span class="n">functional</span> <span class="o">==</span> <span class="s1">&#39;pbe0&#39;</span><span class="p">:</span>
        <span class="n">gwcalctyp</span> <span class="o">=</span> <span class="mi">215</span>
        <span class="n">icutcoul</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="n">rcut</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">elif</span> <span class="n">functional</span> <span class="o">==</span> <span class="s1">&#39;b3lyp&#39;</span><span class="p">:</span>
        <span class="n">gwcalctyp</span> <span class="o">=</span> <span class="mi">315</span>
        <span class="n">icutcoul</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="n">rcut</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknow functional </span><span class="si">{0}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">functional</span><span class="p">))</span>

    <span class="n">ecut</span> <span class="o">=</span> <span class="n">hybrid_input</span><span class="p">[</span><span class="s1">&#39;ecut&#39;</span><span class="p">]</span>
    <span class="n">ecutsigx</span> <span class="o">=</span> <span class="n">ecutsigx</span> <span class="ow">or</span> <span class="mi">2</span><span class="o">*</span><span class="n">ecut</span>

    <span class="n">hybrid_input</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">optdriver</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">gwcalctyp</span><span class="o">=</span><span class="n">gwcalctyp</span><span class="p">,</span> <span class="n">gw_nstep</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">gwpara</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">icutcoul</span><span class="o">=</span><span class="n">icutcoul</span><span class="p">,</span> <span class="n">rcut</span><span class="o">=</span><span class="n">rcut</span><span class="p">,</span>
                          <span class="n">gw_qprange</span><span class="o">=</span><span class="n">gw_qprange</span><span class="p">,</span> <span class="n">ecutwfn</span><span class="o">=</span><span class="n">ecut</span><span class="o">*</span><span class="mf">0.995</span><span class="p">,</span> <span class="n">ecutsigx</span><span class="o">=</span><span class="n">ecutsigx</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">hybrid_input</span>


<span class="k">def</span> <span class="nf">hybrid_scf_input</span><span class="p">(</span><span class="n">gsinput</span><span class="p">,</span> <span class="n">functional</span><span class="o">=</span><span class="s2">&quot;hse06&quot;</span><span class="p">,</span> <span class="n">ecutsigx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gw_qprange</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

    <span class="n">hybrid_input</span> <span class="o">=</span> <span class="n">hybrid_oneshot_input</span><span class="p">(</span><span class="n">gsinput</span><span class="o">=</span><span class="n">gsinput</span><span class="p">,</span> <span class="n">functional</span><span class="o">=</span><span class="n">functional</span><span class="p">,</span> <span class="n">ecutsigx</span><span class="o">=</span><span class="n">ecutsigx</span><span class="p">,</span> <span class="n">gw_qprange</span><span class="o">=</span><span class="n">gw_qprange</span><span class="p">)</span>

    <span class="n">hybrid_input</span><span class="p">[</span><span class="s1">&#39;gwcalctyp&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">10</span>

    <span class="k">return</span> <span class="n">hybrid_input</span>


<div class="viewcode-block" id="scf_for_phonons"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.factories.scf_for_phonons">[docs]</a><span class="k">def</span> <span class="nf">scf_for_phonons</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span> <span class="n">kppa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ecut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nband</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span>
                    <span class="n">spin_mode</span><span class="o">=</span><span class="s2">&quot;polarized&quot;</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="s2">&quot;fermi_dirac:0.1 eV&quot;</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scf_algorithm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">shift_mode</span><span class="o">=</span><span class="s2">&quot;Symmetric&quot;</span><span class="p">):</span>

    <span class="n">abiinput</span> <span class="o">=</span> <span class="n">scf_input</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="o">=</span><span class="n">pseudos</span><span class="p">,</span> <span class="n">kppa</span><span class="o">=</span><span class="n">kppa</span><span class="p">,</span> <span class="n">ecut</span><span class="o">=</span><span class="n">ecut</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="n">pawecutdg</span><span class="p">,</span> <span class="n">nband</span><span class="o">=</span><span class="n">nband</span><span class="p">,</span>
                         <span class="n">accuracy</span><span class="o">=</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">spin_mode</span><span class="o">=</span><span class="n">spin_mode</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="n">smearing</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">,</span>
                         <span class="n">scf_algorithm</span><span class="o">=</span><span class="n">scf_algorithm</span><span class="p">,</span> <span class="n">shift_mode</span><span class="o">=</span><span class="n">shift_mode</span><span class="p">)</span>

    <span class="n">nbdbuf</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="c1"># with no smearing set the minimum number of bands plus some nbdbuf</span>
    <span class="k">if</span> <span class="n">smearing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nval</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">num_valence_electrons</span><span class="p">(</span><span class="n">pseudos</span><span class="p">)</span>
        <span class="n">nval</span> <span class="o">-=</span> <span class="n">abiinput</span><span class="p">[</span><span class="s1">&#39;charge&#39;</span><span class="p">]</span>
        <span class="n">nband</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">nval</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">nbdbuf</span><span class="p">)</span>
        <span class="n">abiinput</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">nband</span><span class="o">=</span><span class="n">nband</span><span class="p">)</span>

    <span class="c1"># enforce symmetries and add a buffer of bands to ease convergence with tolwfr</span>
    <span class="n">abiinput</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">chksymbreak</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nbdbuf</span><span class="o">=</span><span class="n">nbdbuf</span><span class="p">,</span> <span class="n">tolwfr</span><span class="o">=</span><span class="mf">1.e-22</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">abiinput</span></div>


<div class="viewcode-block" id="dte_from_gsinput"><a class="viewcode-back" href="../../../api/abio_api.html#abipy.abio.factories.dte_from_gsinput">[docs]</a><span class="k">def</span> <span class="nf">dte_from_gsinput</span><span class="p">(</span><span class="n">gs_inp</span><span class="p">,</span> <span class="n">use_phonons</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ph_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ddk_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dde_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dte_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">skip_dte_permutations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of inputs in the form of a |MultiDataset| to perform calculations of non-linear properties, based on</span>
<span class="sd">    a ground state AbinitInput.</span>

<span class="sd">    The inputs have the following tags, according to their function: &quot;ddk&quot;, &quot;dde&quot;, &quot;ph_q_pert&quot; and &quot;dte&quot;.</span>
<span class="sd">    All of them have the tag &quot;dfpt&quot;.</span>

<span class="sd">    Args:</span>
<span class="sd">        gs_inp: an |AbinitInput| representing a ground state calculation, likely the SCF performed to get the WFK.</span>
<span class="sd">        use_phonons: determine wether the phonon perturbations at gamma should be included or not</span>
<span class="sd">        ph_tol: a dictionary with a single key defining the type of tolarence used for the phonon calculations and</span>
<span class="sd">            its value. Default: {&quot;tolvrs&quot;: 1.0e-22}.</span>
<span class="sd">        ddk_tol: a dictionary with a single key defining the type of tolarence used for the DDK calculations and</span>
<span class="sd">            its value. Default: {&quot;tolwfr&quot;: 1.0e-22}.</span>
<span class="sd">        dde_tol: a dictionary with a single key defining the type of tolarence used for the DDE calculations and</span>
<span class="sd">            its value. Default: {&quot;tolvrs&quot;: 1.0e-22}.</span>
<span class="sd">        dte_tol: a dictionary with a single key defining the type of tolarence used for the DTE calculations and</span>
<span class="sd">            its value. Default: {&quot;tolwfr&quot;: 1.0e-20}.</span>
<span class="sd">        skip_dte_permutations:</span>
<span class="sd">        manager: |TaskManager| of the task. If None, the manager is initialized from the config file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gs_inp</span> <span class="o">=</span> <span class="n">gs_inp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
    <span class="n">gs_inp</span><span class="o">.</span><span class="n">pop_irdvars</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">ph_tol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ph_tol</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tolvrs&quot;</span><span class="p">:</span> <span class="mf">1.0e-22</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">ddk_tol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ddk_tol</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tolwfr&quot;</span><span class="p">:</span> <span class="mf">1.0e-22</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">dde_tol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dde_tol</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tolvrs&quot;</span><span class="p">:</span> <span class="mf">1.0e-22</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">dte_tol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dte_tol</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tolwfr&quot;</span><span class="p">:</span> <span class="mf">1.0e-20</span><span class="p">}</span>

    <span class="n">multi</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">multi_ddk</span> <span class="o">=</span> <span class="n">gs_inp</span><span class="o">.</span><span class="n">make_ddk_inputs</span><span class="p">(</span><span class="n">tolerance</span><span class="o">=</span><span class="n">ddk_tol</span><span class="p">)</span>
    <span class="n">multi_ddk</span><span class="o">.</span><span class="n">add_tags</span><span class="p">(</span><span class="n">DDK</span><span class="p">)</span>
    <span class="n">multi</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">multi_ddk</span><span class="p">)</span>
    <span class="n">multi_dde</span> <span class="o">=</span> <span class="n">gs_inp</span><span class="o">.</span><span class="n">make_dde_inputs</span><span class="p">(</span><span class="n">dde_tol</span><span class="p">,</span> <span class="n">use_symmetries</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>
    <span class="n">multi_dde</span><span class="o">.</span><span class="n">add_tags</span><span class="p">(</span><span class="n">DDE</span><span class="p">)</span>
    <span class="n">multi</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">multi_dde</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">use_phonons</span><span class="p">:</span>
        <span class="n">multi_ph</span> <span class="o">=</span> <span class="n">gs_inp</span><span class="o">.</span><span class="n">make_ph_inputs_qpoint</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">ph_tol</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>
        <span class="n">multi_ph</span><span class="o">.</span><span class="n">add_tags</span><span class="p">(</span><span class="n">PH_Q_PERT</span><span class="p">)</span>
        <span class="n">multi</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">multi_ph</span><span class="p">)</span>

    <span class="c1"># non-linear calculations do not accept more bands than those in the valence. Set the correct values.</span>
    <span class="c1"># Do this as last, so not to intrfere with the the generation of the other steps.</span>
    <span class="n">nval</span> <span class="o">=</span> <span class="n">gs_inp</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">num_valence_electrons</span><span class="p">(</span><span class="n">gs_inp</span><span class="o">.</span><span class="n">pseudos</span><span class="p">)</span>
    <span class="n">nval</span> <span class="o">-=</span> <span class="n">gs_inp</span><span class="p">[</span><span class="s1">&#39;charge&#39;</span><span class="p">]</span>
    <span class="n">nband</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">nval</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">gs_inp</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">nband</span><span class="o">=</span><span class="n">nband</span><span class="p">)</span>
    <span class="n">gs_inp</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;nbdbuf&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">multi_dte</span> <span class="o">=</span> <span class="n">gs_inp</span><span class="o">.</span><span class="n">make_dte_inputs</span><span class="p">(</span><span class="n">phonon_pert</span><span class="o">=</span><span class="n">use_phonons</span><span class="p">,</span> <span class="n">skip_permutations</span><span class="o">=</span><span class="n">skip_dte_permutations</span><span class="p">,</span>
                                       <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>
    <span class="n">multi_dte</span><span class="o">.</span><span class="n">add_tags</span><span class="p">(</span><span class="n">DTE</span><span class="p">)</span>
    <span class="n">multi</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">multi_dte</span><span class="p">)</span>

    <span class="n">multi</span> <span class="o">=</span> <span class="n">MultiDataset</span><span class="o">.</span><span class="n">from_inputs</span><span class="p">(</span><span class="n">multi</span><span class="p">)</span>
    <span class="n">multi</span><span class="o">.</span><span class="n">add_tags</span><span class="p">(</span><span class="n">DFPT</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">multi</span></div>


<span class="c1">#FIXME if the pseudos are passed as a PseudoTable the whole table will be serialized,</span>
<span class="c1"># it would be better to filter on the structure elements</span>
<span class="k">class</span> <span class="nc">InputFactory</span><span class="p">(</span><span class="n">MSONable</span><span class="p">):</span>
    <span class="n">factory_function</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">input_required</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory_function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;The factory function should be specified&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

    <span class="k">def</span> <span class="nf">build_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">previous_input</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># make a copy to pop additional parameteres</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">decorators</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;decorators&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">decorators</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">decorators</span> <span class="o">=</span> <span class="p">[</span><span class="n">decorators</span><span class="p">]</span>
        <span class="n">extra_abivars</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;extra_abivars&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_required</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">previous_input</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;An input is required for factory function </span><span class="si">{0}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factory_function</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
            <span class="n">abiinput</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory_function</span><span class="p">(</span><span class="n">previous_input</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">abiinput</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory_function</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">decorators</span><span class="p">:</span>
            <span class="n">abiinput</span> <span class="o">=</span> <span class="n">d</span><span class="p">(</span><span class="n">abiinput</span><span class="p">)</span>
        <span class="n">abiinput</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">extra_abivars</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">abiinput</span>

    <span class="nd">@pmg_serialize</span>
    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># sanitize to avoid numpy arrays and serialize MSONable objects</span>
        <span class="k">return</span> <span class="n">jsanitize</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">MontyDecoder</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">*</span><span class="n">dec</span><span class="o">.</span><span class="n">process_decoded</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]),</span> <span class="o">**</span><span class="n">dec</span><span class="o">.</span><span class="n">process_decoded</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">]))</span>


<span class="k">class</span> <span class="nc">BandsFromGsFactory</span><span class="p">(</span><span class="n">InputFactory</span><span class="p">):</span>
    <span class="n">factory_function</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">ebands_from_gsinput</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">IoncellRelaxFromGsFactory</span><span class="p">(</span><span class="n">InputFactory</span><span class="p">):</span>
    <span class="n">factory_function</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">ioncell_relax_from_gsinput</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">HybridOneShotFromGsFactory</span><span class="p">(</span><span class="n">InputFactory</span><span class="p">):</span>
    <span class="n">factory_function</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">hybrid_oneshot_input</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">HybridScfFromGsFactory</span><span class="p">(</span><span class="n">InputFactory</span><span class="p">):</span>
    <span class="n">factory_function</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">hybrid_scf_input</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ScfFactory</span><span class="p">(</span><span class="n">InputFactory</span><span class="p">):</span>
    <span class="n">factory_function</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">scf_input</span><span class="p">)</span>
    <span class="n">input_required</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">class</span> <span class="nc">ScfForPhononsFactory</span><span class="p">(</span><span class="n">InputFactory</span><span class="p">):</span>
    <span class="n">factory_function</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">scf_for_phonons</span><span class="p">)</span>
    <span class="n">input_required</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">class</span> <span class="nc">PhononsFromGsFactory</span><span class="p">(</span><span class="n">InputFactory</span><span class="p">):</span>
    <span class="n">factory_function</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">phonons_from_gsinput</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PiezoElasticFactory</span><span class="p">(</span><span class="n">InputFactory</span><span class="p">):</span>
    <span class="n">factory_function</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">scf_piezo_elastic_inputs</span><span class="p">)</span>
    <span class="n">input_required</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">class</span> <span class="nc">PiezoElasticFromGsFactory</span><span class="p">(</span><span class="n">InputFactory</span><span class="p">):</span>
    <span class="n">factory_function</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">piezo_elastic_inputs_from_gsinput</span><span class="p">)</span>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2018, The AbiPy group.<br/>
      Last updated on Feb 22, 2018.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.5.<br/>
    </p>
  </div>
</footer>
  </body>
</html>