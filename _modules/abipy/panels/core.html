

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>abipy.panels.core &mdash; abipy 0.9.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/jupyter-sphinx.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/thebelab.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/my_style.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-dataframe.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-rendered-html.css" type="text/css" />

  
  

  
  

  

  
    <script type="text/javascript" src="https://cdn.plot.ly/plotly-latest.min.js"></script> 
    
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/thebelab-helper.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> abipy
          

          
          </a>

          
            
            
              <div class="version">
                0.9.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../features.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Getting AbiPy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../zzbiblio.html">Bibliography</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../scripts/index.html">Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../graphical_interface.html">Graphical interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gallery/index.html">AbiPy Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../postprocessing_howto.html">Post-processing How-To</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../workflows/taskmanager.html">TaskManager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../workflows/manager_examples.html">Manager Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../flow_gallery/index.html">Flow Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../flows_howto.html">Flows How-To</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../coding_guide.html">Coding guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html">Documenting AbiPy</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">abipy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>abipy.panels.core</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for abipy.panels.core</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;&quot;Basic tools and mixin classes for AbiPy panels.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">io</span>
<span class="c1">#import pathlib</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">param</span>
<span class="kn">import</span> <span class="nn">panel</span> <span class="k">as</span> <span class="nn">pn</span>
<span class="kn">import</span> <span class="nn">panel.widgets</span> <span class="k">as</span> <span class="nn">pnw</span>
<span class="kn">import</span> <span class="nn">bokeh.models.widgets</span> <span class="k">as</span> <span class="nn">bkw</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">monty.functools</span> <span class="kn">import</span> <span class="n">lazy_property</span>
<span class="kn">from</span> <span class="nn">monty.termcolor</span> <span class="kn">import</span> <span class="n">cprint</span>
<span class="kn">from</span> <span class="nn">abipy.core</span> <span class="kn">import</span> <span class="n">abinit_units</span> <span class="k">as</span> <span class="n">abu</span>
<span class="kn">from</span> <span class="nn">abipy.tools.plotting</span> <span class="kn">import</span> <span class="n">push_to_chart_studio</span>

<span class="c1">#pathlib.Path(__file__) / &quot;assets&quot;</span>


<div class="viewcode-block" id="abipanel"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.abipanel">[docs]</a><span class="k">def</span> <span class="nf">abipanel</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Activate panel extensions used by AbiPy. Return panel module.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">panel</span> <span class="k">as</span> <span class="nn">pn</span>
    <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Use `conda install panel` or `pip install panel` to install the python package.&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">exc</span>

    <span class="n">extensions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;plotly&quot;</span><span class="p">,</span>
        <span class="c1">#&quot;mathjax&quot;,</span>
        <span class="c1">#&quot;katex&quot;,</span>
    <span class="p">]</span>

    <span class="c1">#print(&quot;loading extensions:&quot;, extensions)</span>
    <span class="n">pn</span><span class="o">.</span><span class="n">extension</span><span class="p">(</span><span class="o">*</span><span class="n">extensions</span><span class="p">)</span> <span class="c1"># , raw_css=[css])</span>

    <span class="n">pn</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">js_files</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="c1"># This for copy to clipboard.</span>
        <span class="s2">&quot;clipboard&quot;</span><span class="p">:</span> <span class="s2">&quot;https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js&quot;</span><span class="p">,</span>
        <span class="s2">&quot;jsmol&quot;</span><span class="p">:</span> <span class="s2">&quot;http://chemapps.stolaf.edu/jmol/jsmol/JSmol.min.js&quot;</span><span class="p">,</span>
    <span class="p">})</span>

    <span class="c1">#pn.config.js_files.update({</span>
    <span class="c1">#    &#39;ngl&#39;: &#39;https://cdn.jsdelivr.net/gh/arose/ngl@v2.0.0-dev.33/dist/ngl.js&#39;,</span>
    <span class="c1">#})</span>
    <span class="c1">#pn.extension(comms=&#39;ipywidgets&#39;)</span>

    <span class="k">return</span> <span class="n">pn</span></div>


<div class="viewcode-block" id="gen_id"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.gen_id">[docs]</a><span class="k">def</span> <span class="nf">gen_id</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pre</span><span class="o">=</span><span class="s2">&quot;uuid-&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate ``n`` universally unique identifiers prepended with ``pre`` string.</span>
<span class="sd">    Return string if n == 1 or list of strings if n &gt; 1</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># The HTML4 spec says:</span>
    <span class="c1"># ID and NAME tokens must begin with a letter ([A-Za-z]) and may be followed by any number of letters,</span>
    <span class="c1"># digits ([0-9]), hyphens (&quot;-&quot;), underscores (&quot;_&quot;), colons (&quot;:&quot;), and periods (&quot;.&quot;).</span>
    <span class="kn">import</span> <span class="nn">uuid</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pre</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">pre</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;n must be &gt; 0 but got </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">))</span></div>


<div class="viewcode-block" id="get_template_cls_from_name"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.get_template_cls_from_name">[docs]</a><span class="k">def</span> <span class="nf">get_template_cls_from_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return panel template from string.</span>
<span class="sd">    Support name in the form `FastList` as well as `FastListTemplate`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Example: pn.template.FastGridTemplate or pn.template.GoldenTemplate</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">template</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">template</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="n">try_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;Template&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">template</span><span class="p">,</span> <span class="n">try_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">template</span><span class="p">,</span> <span class="n">try_name</span><span class="p">)</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Don&#39;t know how to return panel template from string: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"></span>
<span class="s2">Possible templates are: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="depends_on_btn_click"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.depends_on_btn_click">[docs]</a><span class="k">def</span> <span class="nf">depends_on_btn_click</span><span class="p">(</span><span class="n">btn_name</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">decorated</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">btn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">btn_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">btn</span><span class="o">.</span><span class="n">clicks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span>
            <span class="k">with</span> <span class="n">ButtonContext</span><span class="p">(</span><span class="n">btn</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">btn_name</span><span class="si">}</span><span class="s2">.clicks&quot;</span><span class="p">)(</span><span class="n">decorated</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">decorator</span></div>


<div class="viewcode-block" id="HTMLwithClipboardBtn"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.HTMLwithClipboardBtn">[docs]</a><span class="k">class</span> <span class="nc">HTMLwithClipboardBtn</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">HTML</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Receives an HTML string and returns an HTML pane with a button that allows the user</span>
<span class="sd">    to copy the content to the system clipboard.</span>
<span class="sd">    Requires call to abipanel to load JS the extension.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># This counter is shared by all the instances. We use it so that the js script is included only once.</span>
    <span class="n">_init_counter</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">object</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">btn_cls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="nb">object</span><span class="o">=</span><span class="nb">object</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_init_counter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">my_id</span> <span class="o">=</span> <span class="n">gen_id</span><span class="p">()</span>
        <span class="n">btn_cls</span> <span class="o">=</span> <span class="s2">&quot;bk bk-btn bk-btn-default&quot;</span> <span class="k">if</span> <span class="n">btn_cls</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">btn_cls</span><span class="p">)</span>

        <span class="c1"># Build new HTML string with js section if first call.</span>
        <span class="n">new_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;div id=&quot;</span><span class="si">{</span><span class="n">my_id</span><span class="si">}</span><span class="s2">&quot;&gt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="si">}</span><span class="s2">&lt;/div&gt;</span>
<span class="s2">&lt;br&gt;</span>
<span class="s2">&lt;button class=&quot;clip-btn </span><span class="si">{</span><span class="n">btn_cls</span><span class="si">}</span><span class="s2">&quot; type=&quot;button&quot; data-clipboard-target=&quot;#</span><span class="si">{</span><span class="n">my_id</span><span class="si">}</span><span class="s2">&quot;&gt; Copy to clipboard &lt;/button&gt;</span>
<span class="s2">&lt;hr&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_counter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">new_text</span> <span class="o">+=</span> <span class="s2">&quot;&lt;script&gt; $(document).ready(function() {new ClipboardJS(&#39;.clip-btn&#39;)}) &lt;/script&gt; &quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">object</span> <span class="o">=</span> <span class="n">new_text</span></div>


<div class="viewcode-block" id="mpl"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.mpl">[docs]</a><span class="k">def</span> <span class="nf">mpl</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">sizing_mode</span><span class="o">=</span><span class="s1">&#39;stretch_width&#39;</span><span class="p">,</span> <span class="n">with_controls</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">with_divider</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function returning a panel Column with a matplotly pane followed by</span>
<span class="sd">    a divider and (optionally) controls to customize the figure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#try:</span>
    <span class="c1">#    from ipympl.backend_nbagg import FigureManager, Canvas, is_interactive</span>
    <span class="c1">#    interactive = True</span>
    <span class="c1">#except:</span>
    <span class="c1">#    interactive = False</span>

    <span class="n">col</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sizing_mode</span><span class="o">=</span><span class="n">sizing_mode</span><span class="p">);</span> <span class="n">ca</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">append</span>
    <span class="n">mpl_pane</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Matplotlib</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">ca</span><span class="p">(</span><span class="n">mpl_pane</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">with_controls</span><span class="p">:</span>
        <span class="n">ca</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">Accordion</span><span class="p">((</span><span class="s2">&quot;matplotlib controls&quot;</span><span class="p">,</span> <span class="n">mpl_pane</span><span class="o">.</span><span class="n">controls</span><span class="p">(</span><span class="n">jslink</span><span class="o">=</span><span class="kc">True</span><span class="p">))))</span>
        <span class="n">ca</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">Divider</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">with_divider</span><span class="p">:</span>
        <span class="n">ca</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">Divider</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">col</span></div>


<div class="viewcode-block" id="ply"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.ply">[docs]</a><span class="k">def</span> <span class="nf">ply</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">sizing_mode</span><span class="o">=</span><span class="s1">&#39;stretch_width&#39;</span><span class="p">,</span> <span class="n">with_chart_studio</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_help</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">with_divider</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_controls</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function returning a panel Column with a plotly pane,  buttons to push the figure</span>
<span class="sd">    to plotly chart studio and, optionally, controls to customize the figure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sizing_mode</span><span class="o">=</span><span class="n">sizing_mode</span><span class="p">);</span> <span class="n">ca</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">append</span>
    <span class="n">plotly_pane</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Plotly</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;responsive&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
    <span class="n">ca</span><span class="p">(</span><span class="n">plotly_pane</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">with_chart_studio</span><span class="p">:</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Markdown</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>

<span class="s2">The button on the left allows you to **upload the figure** to the</span>
<span class="s2">plotly [chart studio server](https://plotly.com/chart-studio-help/)</span>
<span class="s2">so that it is possible to share the figure or customize it via the chart studio editor.</span>
<span class="s2">In order to use this feature, you need to create a free account following the instructions</span>
<span class="s2">reported [in this page](https://plotly.com/chart-studio-help/how-to-sign-up-to-plotly/).</span>
<span class="s2">Then **add the following section** to your $HOME/.pmgrc.yaml configuration file:</span>

<span class="s2">```yaml</span>
<span class="s2">PLOTLY_USERNAME: john_doe  # Replace with your username</span>
<span class="s2">PLOTLY_API_KEY: secret     # To get your api_key go to: profile &gt; settings &gt; regenerate key</span>
<span class="s2">```</span>

<span class="s2">so that AbiPy can authenticate your user on the chart studio portal before pushing the figure to the cloud.</span>
<span class="s2">If everything is properly configured, a new window is automatically created in your browser.</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

        <span class="n">btn</span> <span class="o">=</span> <span class="n">pnw</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Upload to chart studio server&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">push_to_cs</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">ButtonContext</span><span class="p">(</span><span class="n">btn</span><span class="p">):</span>
                <span class="n">push_to_chart_studio</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="n">btn</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">push_to_cs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">with_help</span><span class="p">:</span>
            <span class="n">acc</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">Accordion</span><span class="p">((</span><span class="s2">&quot;What is this?&quot;</span><span class="p">,</span> <span class="n">md</span><span class="p">))</span>
            <span class="n">ca</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">btn</span><span class="p">,</span> <span class="n">acc</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ca</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">btn</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">with_controls</span><span class="p">:</span>
        <span class="n">ca</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">Accordion</span><span class="p">((</span><span class="s2">&quot;plotly controls&quot;</span><span class="p">,</span> <span class="n">plotly_pane</span><span class="o">.</span><span class="n">controls</span><span class="p">(</span><span class="n">jslink</span><span class="o">=</span><span class="kc">True</span><span class="p">))))</span>

    <span class="k">if</span> <span class="n">with_divider</span><span class="p">:</span>
        <span class="n">ca</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">Divider</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">col</span></div>


<div class="viewcode-block" id="dfc"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.dfc">[docs]</a><span class="k">def</span> <span class="nf">dfc</span><span class="p">(</span><span class="n">df</span><span class="p">,</span>
        <span class="n">wdg_type</span><span class="o">=</span><span class="s2">&quot;dataframe&quot;</span><span class="p">,</span>
        <span class="c1">#wdg_type=&quot;tabulator&quot;,  # More recent version</span>
        <span class="n">with_export_btn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_controls</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">with_divider</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function returning a panel Column with a DataFrame or Tabulator widget followed by</span>
<span class="sd">    a divider and (optionally) controls to customize the figure.</span>

<span class="sd">    Note that not all the options work as exected. See comments below.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;disabled&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;disabled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1">#if &quot;sizing_mode&quot; not in kwargs: kwargs[&quot;sizing_mode&quot;] = &quot;stretch_both&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;sizing_mode&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;sizing_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;scale_width&quot;</span>
    <span class="k">if</span> <span class="n">transpose</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">wdg_type</span> <span class="o">==</span> <span class="s2">&quot;dataframe&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;auto_edit&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;auto_edit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">pnw</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">wdg_type</span> <span class="o">==</span> <span class="s2">&quot;tabulator&quot;</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">pnw</span><span class="o">.</span><span class="n">Tabulator</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Don&#39;t know how to handle widget type: `</span><span class="si">{</span><span class="n">wdg_type</span><span class="si">}</span><span class="s2">`&quot;</span><span class="p">)</span>

    <span class="n">col</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sizing_mode</span><span class="o">=</span><span class="s1">&#39;stretch_both&#39;</span><span class="p">);</span> <span class="n">ca</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">append</span>
    <span class="n">ca</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">with_export_btn</span><span class="p">:</span>
        <span class="c1"># Define callbacks with closure.</span>
        <span class="c1">#clip_button = pnw.Button(name=&quot;Copy to clipboard&quot;)</span>
        <span class="c1">#def to_clipboard(event):</span>
        <span class="c1">#    df.to_clipboard()</span>
        <span class="c1">#clip_button.on_click(to_clipboard)</span>

        <span class="k">def</span> <span class="nf">to_xlsx</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Based on https://panel.holoviz.org/gallery/simple/file_download_examples.html</span>
<span class="sd">            NB: This requires xlsxwriter package else pandas raises ModuleNotFoundError.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;xlsxwriter&#39;</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s2">&quot;DataFrame&quot;</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>  <span class="c1"># Important!</span>
            <span class="n">output</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">output</span>

        <span class="k">def</span> <span class="nf">to_latex</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;Convert DataFrame to latex string.&quot;&quot;&quot;</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_latex</span><span class="p">(</span><span class="n">buf</span><span class="o">=</span><span class="n">output</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">output</span>

        <span class="k">def</span> <span class="nf">to_md</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;Convert DataFrame to markdown string.&quot;&quot;&quot;</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_markdown</span><span class="p">(</span><span class="n">buf</span><span class="o">=</span><span class="n">output</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">output</span>

        <span class="k">def</span> <span class="nf">to_json</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;Convert DataFrame to json string.&quot;&quot;&quot;</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">path_or_buf</span><span class="o">=</span><span class="n">output</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">output</span>

        <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">xlsx</span><span class="o">=</span><span class="n">pnw</span><span class="o">.</span><span class="n">FileDownload</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;data.xlsx&quot;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">to_xlsx</span><span class="p">),</span>
            <span class="n">tex</span><span class="o">=</span><span class="n">pnw</span><span class="o">.</span><span class="n">FileDownload</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;data.tex&quot;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">to_latex</span><span class="p">),</span>
            <span class="n">md</span><span class="o">=</span><span class="n">pnw</span><span class="o">.</span><span class="n">FileDownload</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;data.md&quot;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">to_md</span><span class="p">),</span>
            <span class="n">json</span><span class="o">=</span><span class="n">pnw</span><span class="o">.</span><span class="n">FileDownload</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;data.json&quot;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">to_json</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Clicked menu item: &quot;</span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">new</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
            <span class="n">file_download</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">new</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">file_download</span><span class="p">)</span>
            <span class="c1">#file_download._clicks = -1</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calling transfer&quot;</span><span class="p">)</span>
            <span class="n">file_download</span><span class="o">.</span><span class="n">_transfer</span><span class="p">()</span>
            <span class="c1">#return file_download.callback()</span>

        <span class="c1"># FIXME: Menu button occupies less space but the upload does not work</span>
        <span class="c1">#menu_btn = pnw.MenuButton(name=&#39;Export to:&#39;, items=list(d.keys()))</span>
        <span class="c1">#menu_btn.on_click(download)</span>
        <span class="c1">#ca(menu_btn)</span>

        <span class="c1"># For the time being we use a Row with buttons.</span>
        <span class="n">ca</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="o">*</span><span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">sizing_mode</span><span class="o">=</span><span class="s2">&quot;scale_width&quot;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">with_controls</span><span class="p">:</span>
        <span class="n">ca</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">Accordion</span><span class="p">((</span><span class="s2">&quot;dataframe controls&quot;</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">controls</span><span class="p">(</span><span class="n">jslink</span><span class="o">=</span><span class="kc">True</span><span class="p">))))</span>

    <span class="k">if</span> <span class="n">with_divider</span><span class="p">:</span>
        <span class="n">ca</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">Divider</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">col</span></div>


<div class="viewcode-block" id="MyMarkdown"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.MyMarkdown">[docs]</a><span class="k">class</span> <span class="nc">MyMarkdown</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Markdown</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Markdown pane renders the markdown markup language to HTML and</span>
<span class="sd">    displays it inside a bokeh Div model. It has no explicit</span>
<span class="sd">    priority since it cannot be easily be distinguished from a</span>
<span class="sd">    standard string, therefore it has to be invoked explicitly.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">extensions</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="p">[</span>
        <span class="c1"># Extensions used by the superclass.</span>
        <span class="s2">&quot;extra&quot;</span><span class="p">,</span> <span class="s2">&quot;smarty&quot;</span><span class="p">,</span> <span class="s2">&quot;codehilite&quot;</span><span class="p">,</span>
        <span class="c1"># My extensions</span>
        <span class="c1">#&#39;pymdownx.arithmatex&#39;,</span>
        <span class="c1">#&#39;pymdownx.details&#39;,</span>
        <span class="c1">#&quot;pymdownx.tabbed&quot;,</span>
    <span class="p">],</span>

        <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Markdown extension to apply when transforming markup.&quot;&quot;&quot;</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="ButtonContext"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.ButtonContext">[docs]</a><span class="k">class</span> <span class="nc">ButtonContext</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A context manager for buttons triggering computations on the server.</span>

<span class="sd">    This manager disables the button when we __enter__ and changes the name of the button to &quot;running&quot;.</span>
<span class="sd">    It reverts to the initial state of the button ocne __exit__ is invoked, showing the Exception type</span>
<span class="sd">    in a &quot;red&quot; button if an exception is raised during the computation.</span>

<span class="sd">    This a very important tool because we need to disable the button when we start the computation</span>
<span class="sd">    to prevent the user from triggering multiple callbacks while the server is still working.</span>
<span class="sd">    At the same time, whathever happens in the callback, the button should go back to &quot;clickable&quot; mode</span>
<span class="sd">    when the callback returns so that the user can try to change the parameters and rerun.</span>

<span class="sd">    Note also that we want to provide some graphical feedback to the user if something goes wrong.</span>
<span class="sd">    At present we don&#39;t expose the python traceback on the client.</span>
<span class="sd">    It would be nice but we need panel machinery to do that.</span>
<span class="sd">    Moreover this is not the recommended approach for security reasons so we just change the &quot;color&quot;</span>
<span class="sd">    of the button and use the string representation of the exception as button name.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">btn</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">btn</span> <span class="o">=</span> <span class="n">btn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_type</span> <span class="o">=</span> <span class="n">btn</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">btn</span><span class="o">.</span><span class="n">button_type</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Disable the button.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">btn</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Executing ...&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">btn</span><span class="o">.</span><span class="n">button_type</span> <span class="o">=</span> <span class="s2">&quot;warning&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">btn</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">btn</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="c1"># First of all, reenable the button so that the user can stil interact with the GUI.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">btn</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">exc_type</span><span class="p">:</span>
            <span class="c1"># Exception --&gt; signal to the user that something went wrong for 2 seconds.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">btn</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">btn</span><span class="o">.</span><span class="n">button_type</span> <span class="o">=</span> <span class="s2">&quot;danger&quot;</span>
            <span class="kn">import</span> <span class="nn">time</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Back to the original button state.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">btn</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">btn</span><span class="o">.</span><span class="n">button_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_type</span>

        <span class="c1"># Don&#39;t handle the exception</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="AbipyParameterized"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.AbipyParameterized">[docs]</a><span class="k">class</span> <span class="nc">AbipyParameterized</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">Parameterized</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base classs for AbiPy panels. Provide widgets for parameters supported by the differet AbiPy methods.</span>
<span class="sd">    and helper functions to perform typical operations when build dashboards from python.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">verbose</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">Integer</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Verbosity Level&quot;</span><span class="p">)</span>
    <span class="n">mpi_procs</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">Integer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Number of MPI processes used for running Fortran code.&quot;</span><span class="p">)</span>

    <span class="c1"># mode = &quot;webapp&quot; This flag may be used to limit the user and/or decide the options that should</span>
    <span class="c1"># be exposed. For instance structure_viewer == &quot;Vesta&quot; does not make sense in webapp mode</span>

    <span class="n">warning</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Markdown</span><span class="p">(</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Please **refresh** the page using the refresh button of the browser if plotly figures are not shown.</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">)</span>

    <span class="c1">#def __repr__(self):</span>
    <span class="c1">#    # https://github.com/holoviz/param/issues/396</span>
    <span class="c1">#    return f&quot;AbiPyParametrized(name=&#39;{self.name}&#39;)&quot;</span>

<div class="viewcode-block" id="AbipyParameterized.mpl_kwargs"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.AbipyParameterized.mpl_kwargs">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">mpl_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Default arguments passed to AbiPy matplotlib plot methods.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fig_close</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbipyParameterized.pws_col"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.AbipyParameterized.pws_col">[docs]</a>    <span class="k">def</span> <span class="nf">pws_col</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pws</span><span class="p">(</span><span class="n">keys</span><span class="p">))</span></div>

    <span class="c1">#def pws_row(self, keys):</span>
    <span class="c1">#    return pn.Row(*self.pws(keys))</span>

<div class="viewcode-block" id="AbipyParameterized.pws"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.AbipyParameterized.pws">[docs]</a>    <span class="k">def</span> <span class="nf">pws</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function returning the list of parameters and widgets defined in self from a list of strings.</span>
<span class="sd">        Accepts also widget or parameter instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">items</span><span class="p">,</span> <span class="n">miss</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">:</span>
                    <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
                    <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
                    <span class="c1"># Markdown string</span>
                    <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">miss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Assume widget instance.</span>
                <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">miss</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find `</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">miss</span><span class="p">)</span><span class="si">}</span><span class="s2">` in param or in attribute space&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">items</span></div>

<div class="viewcode-block" id="AbipyParameterized.helpc"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.AbipyParameterized.helpc">[docs]</a>    <span class="k">def</span> <span class="nf">helpc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_name</span><span class="p">,</span> <span class="n">extra_items</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add accordion with a brief description and a warning after the button.</span>
<span class="sd">        The description of the tool is taken from the docstring of the callback.</span>
<span class="sd">        Return Column.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">();</span> <span class="n">ca</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">append</span>

        <span class="n">acc</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">Accordion</span><span class="p">((</span><span class="s2">&quot;Help&quot;</span><span class="p">,</span> <span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Markdown</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_name</span><span class="p">)</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)))</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">):</span>
            <span class="n">acc</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;Warning&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">extra_items</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">extra_items</span><span class="p">:</span>
                <span class="n">acc</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">item</span><span class="p">))</span>

        <span class="n">ca</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">Divider</span><span class="p">())</span>
        <span class="n">ca</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">col</span></div>

<div class="viewcode-block" id="AbipyParameterized.html_with_clipboard_btn"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.AbipyParameterized.html_with_clipboard_btn">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">html_with_clipboard_btn</span><span class="p">(</span><span class="n">html_str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">HTMLwithClipboardBtn</span><span class="p">(</span><span class="n">html_str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbipyParameterized.get_software_stack"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.AbipyParameterized.get_software_stack">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_software_stack</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;Return column with version of python packages in tabular format.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">abipy.abilab</span> <span class="kn">import</span> <span class="n">software_stack</span>
        <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s2">&quot;## Software stack:&quot;</span><span class="p">,</span> <span class="n">dfc</span><span class="p">(</span><span class="n">software_stack</span><span class="p">(</span><span class="n">as_dataframe</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">with_export_btn</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                         <span class="n">sizing_mode</span><span class="o">=</span><span class="s2">&quot;scale_width&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbipyParameterized.get_template_from_tabs"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.AbipyParameterized.get_template_from_tabs">[docs]</a>    <span class="k">def</span> <span class="nf">get_template_from_tabs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tabs</span><span class="p">,</span> <span class="n">template</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method receives panel Tabs, include them in a template and return the panel template.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">template</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tabs</span>

        <span class="bp">cls</span> <span class="o">=</span> <span class="n">get_template_cls_from_name</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="c1"># A title to show in the header. Also added to the document head meta settings and as the browser tab title.</span>
            <span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">header_background</span><span class="o">=</span><span class="s2">&quot;#ff8c00&quot;</span><span class="p">,</span> <span class="c1"># Dark orange</span>
            <span class="c1">#favicon (str): URI of favicon to add to the document head (if local file, favicon is base64 encoded as URI).</span>
            <span class="c1">#logo (str): URI of logo to add to the header (if local file, logo is base64 encoded as URI).</span>
            <span class="c1">#sidebar_footer (str): Can be used to insert additional HTML. For example a menu, some additional info, links etc.</span>
            <span class="c1">#enable_theme_toggle=False,  # If True a switch to toggle the Theme is shown. Default is True.</span>
        <span class="p">)</span>

        <span class="n">template</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="s2">&quot;append&quot;</span><span class="p">):</span>
            <span class="n">template</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tabs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Assume .main area acts like a GridSpec</span>
            <span class="n">template</span><span class="o">.</span><span class="n">main</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="n">tabs</span>

        <span class="c1"># Get widgets associated to Ph-bands tab and insert them in the slidebar</span>
        <span class="c1">#row = tabs[1]</span>
        <span class="c1">#controllers_col, out = row[0], row[1]</span>
        <span class="c1">#template.sidebar.append(controllers_col)</span>
        <span class="c1">#template.main.append(out)</span>

        <span class="k">return</span> <span class="n">template</span></div></div>


<div class="viewcode-block" id="HasStructureParams"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.HasStructureParams">[docs]</a><span class="k">class</span> <span class="nc">HasStructureParams</span><span class="p">(</span><span class="n">AbipyParameterized</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mixin class for panel objects providing a |Structure| object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">structure_viewer</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">ObjectSelector</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                            <span class="n">objects</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;jsmol&quot;</span><span class="p">,</span> <span class="s2">&quot;vesta&quot;</span><span class="p">,</span> <span class="s2">&quot;xcrysden&quot;</span><span class="p">,</span> <span class="s2">&quot;vtk&quot;</span><span class="p">,</span> <span class="s2">&quot;crystalk&quot;</span><span class="p">,</span> <span class="s2">&quot;ngl&quot;</span><span class="p">,</span>
                                                     <span class="s2">&quot;matplotlib&quot;</span><span class="p">,</span> <span class="s2">&quot;plotly&quot;</span><span class="p">,</span> <span class="s2">&quot;ase_atoms&quot;</span><span class="p">,</span> <span class="s2">&quot;mayavi&quot;</span><span class="p">])</span>

    <span class="c1">#def __init__(self, **params):</span>
    <span class="c1">#    self.struct_view_btn = pnw.Button(name=&quot;View structure&quot;, button_type=&#39;primary&#39;)</span>
    <span class="c1">#    super(self).__init__(**params)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Structure object provided by the subclass.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subclass </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2"> should implement `structure` attribute.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="HasStructureParams.view_structure"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.HasStructureParams.view_structure">[docs]</a>    <span class="nd">@pn</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s2">&quot;structure_viewer&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">view_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Visualize input structure.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure_viewer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">()</span>

        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure_viewer</span>

        <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="s2">&quot;jsmol&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsmol_html</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>
            <span class="c1">#pn.extension(comms=&#39;ipywidgets&#39;) #, js_files=js_files)</span>
            <span class="c1">#view = self.structure.get_jsmol_view()</span>
            <span class="c1">#from ipywidgets_bokeh import IPyWidget</span>
            <span class="c1">#view = IPyWidget(widget=view) #, width=800, height=300)</span>
            <span class="c1">#import ipywidgets as ipw</span>
            <span class="c1">#from IPython.display import display</span>
            <span class="c1">#display(view)</span>
            <span class="c1">#return pn.Row(display(view))</span>
            <span class="c1">#view = pn.ipywidget(view)</span>
            <span class="n">view</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">panel</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>
            <span class="c1">#view = pn.pane.IPyWidget(view)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>
            <span class="c1">#view = pn.Column(view, sizing_mode=&#39;stretch_width&#39;)</span>
            <span class="k">return</span> <span class="n">view</span>

        <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="s2">&quot;crystalk&quot;</span><span class="p">:</span>
            <span class="n">view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">get_crystaltk_view</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">panel</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="s2">&quot;plotly&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">plotly</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="s2">&quot;ngl&quot;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">pymatgen.io.babel</span> <span class="kn">import</span> <span class="n">BabelMolAdaptor</span>
            <span class="kn">from</span> <span class="nn">pymatgen.io.xyz</span> <span class="kn">import</span> <span class="n">XYZ</span>
            <span class="c1"># string_data = self.structure.to(fmt=&quot;xyz&quot;)</span>

            <span class="c1">#writer = BabelMolAdaptor(self)</span>
            <span class="c1">#string_data = str(XYZ(self.structure))</span>
            <span class="c1">#adapt = BabelMolAdaptor.from_string(string_data, file_format=&quot;xyz&quot;)</span>
            <span class="c1">##pdb_string =</span>
            <span class="c1">#print(pdb_string)</span>

            <span class="c1">#from awesome_panel_extesions.pane.widgets.ngl_viewer import NGLViewer</span>
            <span class="c1">#view = NGLViewer()</span>

            <span class="n">view</span><span class="o">.</span><span class="n">pdb_string</span> <span class="o">=</span> <span class="n">pdb_string</span>
            <span class="k">return</span> <span class="n">view</span>

            <span class="c1">#js_files = {&#39;ngl&#39;: &#39;https://cdn.jsdelivr.net/gh/arose/ngl@v2.0.0-dev.33/dist/ngl.js&#39;}</span>
            <span class="c1">#pn.extension(comms=&#39;ipywidgets&#39;, js_files=js_files)</span>
            <span class="c1">#view = self.structure.get_ngl_view()</span>
            <span class="c1">#return pn.panel(view)</span>

            <span class="c1">#pn.config.js_files[&quot;ngl&quot;]=&quot;https://cdn.jsdelivr.net/gh/arose/ngl@v2.0.0-dev.33/dist/ngl.js&quot;</span>
            <span class="c1">#pn.extension()</span>

            <span class="n">html</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&lt;div id=&quot;viewport&quot; style=&quot;width:100%; height:100%;&quot;&gt;&lt;/div&gt;</span>
<span class="s2">            &lt;script&gt;</span>
<span class="s2">            stage = new NGL.Stage(&quot;viewport&quot;);</span>
<span class="s2">            stage.loadFile(&quot;rcsb://1NKT.mmtf&quot;, {defaultRepresentation: true});</span>
<span class="s2">            &lt;/script&gt;&quot;&quot;&quot;</span>

            <span class="n">ngl_pane</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">ngl_pane</span><span class="p">)</span>
            <span class="n">view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">get_ngl_view</span><span class="p">()</span>

        <span class="c1">#return self.structure.crystaltoolkitview()</span>
        <span class="c1">#import nglview as nv</span>
        <span class="c1">#view = nv.demo(gui=False)</span>

        <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="s2">&quot;ase_atoms&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mpl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">plot_atoms</span><span class="p">(</span><span class="n">rotations</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mpl_kwargs</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">visualize</span><span class="p">(</span><span class="n">appname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">structure_viewer</span><span class="p">)</span></div>

<div class="viewcode-block" id="HasStructureParams.get_struct_view_tab_entry"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.HasStructureParams.get_struct_view_tab_entry">[docs]</a>    <span class="k">def</span> <span class="nf">get_struct_view_tab_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return tab entry to visualize the structure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pws_col</span><span class="p">([</span><span class="s2">&quot;### Visualize structure&quot;</span><span class="p">,</span> <span class="s2">&quot;structure_viewer&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">helpc</span><span class="p">(</span><span class="s2">&quot;view_structure&quot;</span><span class="p">)]),</span>
            <span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">view_structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_structure_info</span><span class="p">())</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="HasStructureParams.get_structure_info"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.HasStructureParams.get_structure_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_structure_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return Column with lattice parameters, angles and atomic positions grouped by type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">get_structure_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="get_structure_info"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.get_structure_info">[docs]</a><span class="k">def</span> <span class="nf">get_structure_info</span><span class="p">(</span><span class="n">structure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return Column with lattice parameters, angles and atomic positions grouped by type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sizing_mode</span><span class="o">=</span><span class="s1">&#39;scale_width&#39;</span><span class="p">);</span> <span class="n">ca</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">append</span><span class="p">;</span> <span class="n">cext</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">extend</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">get_dict4pandas</span><span class="p">(</span><span class="n">with_spglib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">keys</span> <span class="o">=</span> <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="c1">#&quot;formula&quot;, &quot;natom&quot;, &quot;volume&quot;,</span>
                    <span class="s2">&quot;abi_spg_number&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;spglib_symb&quot;</span><span class="p">,</span> <span class="s2">&quot;spglib_num&quot;</span><span class="p">,</span>  <span class="s2">&quot;spglib_lattice_type&quot;</span><span class="p">]</span>
    <span class="n">df_spg</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
    <span class="n">cext</span><span class="p">([</span><span class="s2">&quot;# Spacegroup:&quot;</span><span class="p">,</span> <span class="n">dfc</span><span class="p">(</span><span class="n">df_spg</span><span class="p">,</span> <span class="n">with_export_btn</span><span class="o">=</span><span class="kc">False</span><span class="p">)])</span>

    <span class="c1"># Build dataframe with lattice lenghts.</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">keys</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">)</span>
    <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ang_Bohr</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">})</span>
    <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">})</span>
    <span class="n">df_len</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Bohr&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="s2">&quot;Lattice lenghts&quot;</span><span class="p">)</span>

    <span class="c1"># Build dataframe with lattice angles.</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">keys</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">,</span> <span class="s2">&quot;gamma&quot;</span><span class="p">)</span>
    <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">})</span>
    <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">})</span>
    <span class="n">df_ang</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Degrees&quot;</span><span class="p">,</span> <span class="s2">&quot;Radians&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="s2">&quot;Lattice angles&quot;</span><span class="p">)</span>

    <span class="n">cext</span><span class="p">([</span><span class="s2">&quot;# Lattice lengths:&quot;</span><span class="p">,</span> <span class="n">dfc</span><span class="p">(</span><span class="n">df_len</span><span class="p">,</span> <span class="n">with_export_btn</span><span class="o">=</span><span class="kc">False</span><span class="p">)])</span>
    <span class="n">cext</span><span class="p">([</span><span class="s2">&quot;# Lattice angles:&quot;</span><span class="p">,</span> <span class="n">dfc</span><span class="p">(</span><span class="n">df_ang</span><span class="p">,</span> <span class="n">with_export_btn</span><span class="o">=</span><span class="kc">False</span><span class="p">)])</span>
    <span class="c1">#row = pn.Row(dfc(df_len, with_export_btn=False), dfc(df_ang, with_export_btn=False), sizing_mode=&quot;scale_width&quot;)</span>
    <span class="c1">#ca(row)</span>

    <span class="c1"># Build dataframe with atomic positions grouped by element symbol.</span>
    <span class="n">symb2df</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">get_symb2coords_dataframe</span><span class="p">()</span>
    <span class="n">accord</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">Accordion</span><span class="p">(</span><span class="n">sizing_mode</span><span class="o">=</span><span class="s1">&#39;stretch_width&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">symb</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">symb2df</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">accord</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;Coordinates of </span><span class="si">{</span><span class="n">symb</span><span class="si">}</span><span class="s2"> sites:&quot;</span><span class="p">,</span> <span class="n">dfc</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">with_export_btn</span><span class="o">=</span><span class="kc">False</span><span class="p">)))</span>
    <span class="n">ca</span><span class="p">(</span><span class="n">accord</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">col</span></div>


<div class="viewcode-block" id="PanelWithNcFile"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.PanelWithNcFile">[docs]</a><span class="k">class</span> <span class="nc">PanelWithNcFile</span><span class="p">(</span><span class="n">AbipyParameterized</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This frame allows the user to inspect the dimensions and the variables reported in a netcdf file.</span>
<span class="sd">    Tab showing information on the netcdf file.</span>

<span class="sd">    Subclasses should implement the `ncfile` property</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ncfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;abc does not play well with parametrized so we rely on this to enforce the protocol.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;subclass should implement the `ncfile` property.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="PanelWithNcFile.get_ncfile_panel"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.PanelWithNcFile.get_ncfile_panel">[docs]</a>    <span class="k">def</span> <span class="nf">get_ncfile_panel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sizing_mode</span><span class="o">=</span><span class="s1">&#39;stretch_width&#39;</span><span class="p">);</span> <span class="n">ca</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">append</span>

        <span class="c1">#nc_grpname = pnw.Select(name=&quot;nc group name&quot;, options=[&quot;/&quot;])</span>

        <span class="c1"># Get dataframe with dimensions.</span>
        <span class="n">dims_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncfile</span><span class="o">.</span><span class="n">get_dims_dataframe</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">ca</span><span class="p">(</span><span class="n">dfc</span><span class="p">(</span><span class="n">dims_df</span><span class="p">))</span>

        <span class="c1">#vars_df = self.ncfile.get_dims_dataframe(path=&quot;/&quot;)</span>
        <span class="c1">#ca(dfc(vars_df))</span>

        <span class="c1">#ca((&quot;NCFile&quot;, pn.Row(</span>
        <span class="c1">#    pn.Column(&quot;# NC dimensions and variables&quot;,</span>
        <span class="c1">#              dfc(dims_df, wdg_type=&quot;tabulator&quot;),</span>
        <span class="c1">#             )),</span>
        <span class="c1">#))</span>

        <span class="k">return</span> <span class="n">col</span></div></div>


<div class="viewcode-block" id="PanelWithElectronBands"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.PanelWithElectronBands">[docs]</a><span class="k">class</span> <span class="nc">PanelWithElectronBands</span><span class="p">(</span><span class="n">AbipyParameterized</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mixin class for panel object associated to AbiPy object providing an |ElectronBands| object.</span>

<span class="sd">    Subclasses should implement the `ebands` property.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Bands plot</span>
    <span class="n">with_gaps</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1">#ebands_ylims</span>
    <span class="c1">#ebands_e0</span>
    <span class="c1"># e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
    <span class="c1">#     - `fermie`: shift all eigenvalues to have zero energy at the Fermi energy (`self.fermie`).</span>
    <span class="c1">#     -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
    <span class="c1">#     -  None: Don&#39;t shift energies, equivalent to e0=0</span>
    <span class="n">set_fermie_to_vbm</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Set Fermie to VBM&quot;</span><span class="p">)</span>

    <span class="c1"># e-DOS plot.</span>
    <span class="n">edos_method</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">ObjectSelector</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span> <span class="n">objects</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span> <span class="s2">&quot;tetra&quot;</span><span class="p">],</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;e-DOS method&quot;</span><span class="p">)</span>
    <span class="n">edos_step_ev</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;e-DOS step in eV&#39;</span><span class="p">)</span>
    <span class="n">edos_width_ev</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;e-DOS Gaussian broadening in eV&#39;</span><span class="p">)</span>

    <span class="c1"># SKW interpolation of the KS band energies.</span>
    <span class="n">skw_lpratio</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">Integer</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
    <span class="n">skw_line_density</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">Integer</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>

    <span class="c1"># For the max size of file see: https://github.com/holoviz/panel/issues/1559</span>
    <span class="n">ebands_kpath</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ebands_kpath_fileinput</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">FileSelector</span><span class="p">()</span>
    <span class="n">ebands_kmesh</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ebands_kmesh_fileinput</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">FileSelector</span><span class="p">()</span>

    <span class="c1"># Fermi surface plotter.</span>
    <span class="n">fs_viewer</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">ObjectSelector</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">objects</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;matplotlib&quot;</span><span class="p">,</span> <span class="s2">&quot;xcrysden&quot;</span><span class="p">])</span>
    <span class="n">plot_fermi_surface_btn</span> <span class="o">=</span> <span class="n">pnw</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Plot Fermi surface&quot;</span><span class="p">,</span> <span class="n">button_type</span><span class="o">=</span><span class="s1">&#39;primary&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>

        <span class="c1"># Create buttons</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_ebands_btn</span> <span class="o">=</span> <span class="n">pnw</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Plot e-bands&quot;</span><span class="p">,</span> <span class="n">button_type</span><span class="o">=</span><span class="s1">&#39;primary&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_edos_btn</span> <span class="o">=</span> <span class="n">pnw</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Plot e-DOS&quot;</span><span class="p">,</span> <span class="n">button_type</span><span class="o">=</span><span class="s1">&#39;primary&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_skw_btn</span> <span class="o">=</span> <span class="n">pnw</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Plot SKW interpolant&quot;</span><span class="p">,</span> <span class="n">button_type</span><span class="o">=</span><span class="s1">&#39;primary&#39;</span><span class="p">)</span>

        <span class="c1">#ebands_kpath_fileinput = pnw.FileInput(accept=&quot;.nc&quot;)</span>
        <span class="c1">#ebands_kmesh_fileinput = pnw.FileInput(accept=&quot;.nc&quot;)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ebands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;abc does not play well with parametrized so we rely on this to enforce the protocol.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;subclass should implement `ebands` property.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="PanelWithElectronBands.get_ebands_kpath"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.PanelWithElectronBands.get_ebands_kpath">[docs]</a>    <span class="nd">@pn</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s2">&quot;ebands_kpath_fileinput&quot;</span><span class="p">,</span> <span class="n">watch</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_ebands_kpath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Receives the netcdf file selected by the user as binary string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands_kpath_fileinput</span><span class="p">))</span>
        <span class="n">bstring</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands_kpath_fileinput</span>

        <span class="c1">#with ButtonContext(self.ebands_kpath_fileinput):</span>
        <span class="kn">from</span> <span class="nn">abipy.electrons</span> <span class="kn">import</span> <span class="n">ElectronBands</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ebands_kpath</span> <span class="o">=</span> <span class="n">ElectronBands</span><span class="o">.</span><span class="n">from_binary_string</span><span class="p">(</span><span class="n">bstring</span><span class="p">)</span></div>

<div class="viewcode-block" id="PanelWithElectronBands.get_plot_ebands_widgets"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.PanelWithElectronBands.get_plot_ebands_widgets">[docs]</a>    <span class="k">def</span> <span class="nf">get_plot_ebands_widgets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Column with the widgets used to plot ebands.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pws_col</span><span class="p">([</span><span class="s2">&quot;with_gaps&quot;</span><span class="p">,</span> <span class="s2">&quot;set_fermie_to_vbm&quot;</span><span class="p">,</span> <span class="s2">&quot;plot_ebands_btn&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="PanelWithElectronBands.on_plot_ebands_btn"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.PanelWithElectronBands.on_plot_ebands_btn">[docs]</a>    <span class="nd">@depends_on_btn_click</span><span class="p">(</span><span class="s1">&#39;plot_ebands_btn&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">on_plot_ebands_btn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Button triggering ebands plot.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_fermie_to_vbm</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">set_fermie_to_vbm</span><span class="p">()</span>

        <span class="n">col</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sizing_mode</span><span class="o">=</span><span class="s1">&#39;stretch_width&#39;</span><span class="p">);</span> <span class="n">ca</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">append</span>
        <span class="n">ca</span><span class="p">(</span><span class="s2">&quot;## Electronic band structure:&quot;</span><span class="p">)</span>
        <span class="n">fig1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">plotly</span><span class="p">(</span><span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_gaps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">with_gaps</span><span class="p">,</span> <span class="n">max_phfreq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ca</span><span class="p">(</span><span class="n">ply</span><span class="p">(</span><span class="n">fig1</span><span class="p">))</span>

        <span class="n">ca</span><span class="p">(</span><span class="s2">&quot;## Brillouin zone and **k**-path:&quot;</span><span class="p">)</span>
        <span class="c1">#kpath_pane = mpl(self.ebands.kpoints.plot(**self.mpl_kwargs), with_divider=False)</span>
        <span class="n">kpath_pane</span> <span class="o">=</span> <span class="n">ply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">plotly</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">with_divider</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">df_kpts</span> <span class="o">=</span> <span class="n">dfc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">get_highsym_datataframe</span><span class="p">(),</span> <span class="n">with_divider</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ca</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">kpath_pane</span><span class="p">,</span> <span class="n">df_kpts</span><span class="p">))</span>
        <span class="n">ca</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">Divider</span><span class="p">())</span>
        <span class="c1">#ca(bkw.PreText(text=self.ebands.to_string(verbose=self.verbose)))</span>

        <span class="k">return</span> <span class="n">col</span></div>

<div class="viewcode-block" id="PanelWithElectronBands.get_plot_edos_widgets"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.PanelWithElectronBands.get_plot_edos_widgets">[docs]</a>    <span class="k">def</span> <span class="nf">get_plot_edos_widgets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Column with widgets associated to the e-DOS computation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pws_col</span><span class="p">([</span><span class="s2">&quot;edos_method&quot;</span><span class="p">,</span> <span class="s2">&quot;edos_step_ev&quot;</span><span class="p">,</span> <span class="s2">&quot;edos_width_ev&quot;</span><span class="p">,</span> <span class="s2">&quot;plot_edos_btn&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="PanelWithElectronBands.on_plot_edos_btn"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.PanelWithElectronBands.on_plot_edos_btn">[docs]</a>    <span class="nd">@depends_on_btn_click</span><span class="p">(</span><span class="s1">&#39;plot_edos_btn&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">on_plot_edos_btn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Button triggering edos plot.&quot;&quot;&quot;</span>
        <span class="n">edos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">get_edos</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">edos_method</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">edos_step_ev</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">edos_width_ev</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">mpl</span><span class="p">(</span><span class="n">edos</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mpl_kwargs</span><span class="p">)),</span> <span class="n">sizing_mode</span><span class="o">=</span><span class="s1">&#39;scale_width&#39;</span><span class="p">)</span></div>
        <span class="c1">#return pn.Row(ply(edos.plotly(show=False))), sizing_mode=&#39;scale_width&#39;)</span>

<div class="viewcode-block" id="PanelWithElectronBands.on_plot_skw_btn"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.PanelWithElectronBands.on_plot_skw_btn">[docs]</a>    <span class="nd">@depends_on_btn_click</span><span class="p">(</span><span class="s1">&#39;plot_skw_btn&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">on_plot_skw_btn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sizing_mode</span><span class="o">=</span><span class="s1">&#39;stretch_width&#39;</span><span class="p">);</span> <span class="n">ca</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">append</span>

        <span class="n">intp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">lpratio</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">skw_lpratio</span><span class="p">,</span> <span class="n">line_density</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">skw_line_density</span><span class="p">,</span>
                                       <span class="n">kmesh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_shift</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bstart</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bstop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                       <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

        <span class="n">ca</span><span class="p">(</span><span class="s2">&quot;## SKW interpolated bands along an automatically selected high-symmetry **k**-path&quot;</span><span class="p">)</span>
        <span class="n">ca</span><span class="p">(</span><span class="n">ply</span><span class="p">(</span><span class="n">intp</span><span class="o">.</span><span class="n">ebands_kpath</span><span class="o">.</span><span class="n">plotly</span><span class="p">(</span><span class="n">with_gaps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">with_gaps</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands_kpath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ca</span><span class="p">(</span><span class="s2">&quot;## Input bands taken from file uploaded by user:&quot;</span><span class="p">)</span>
            <span class="n">ca</span><span class="p">(</span><span class="n">ply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands_kpath</span><span class="o">.</span><span class="n">plotly</span><span class="p">(</span><span class="n">with_gaps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">with_gaps</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)))</span>

            <span class="c1"># Use line_density 0 to interpolate on the same set of k-points given in self.ebands_kpath</span>
            <span class="n">vertices_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">kpt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands_kpath</span><span class="o">.</span><span class="n">kpoints</span><span class="p">:</span>
                <span class="n">vertices_names</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">kpt</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">,</span> <span class="n">kpt</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

            <span class="n">intp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">lpratio</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">skw_lpratio</span><span class="p">,</span> <span class="n">vertices_names</span><span class="o">=</span><span class="n">vertices_names</span><span class="p">,</span> <span class="n">line_density</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                            <span class="n">kmesh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_shift</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bstart</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bstop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                            <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

            <span class="n">plotter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands_kpath</span><span class="o">.</span><span class="n">get_plotter_with</span><span class="p">(</span><span class="s2">&quot;Input&quot;</span><span class="p">,</span> <span class="s2">&quot;Interpolated&quot;</span><span class="p">,</span> <span class="n">intp</span><span class="o">.</span><span class="n">ebands_kpath</span><span class="p">)</span>
            <span class="n">ca</span><span class="p">(</span><span class="s2">&quot;## Input bands vs SKW interpolated bands:&quot;</span><span class="p">)</span>
            <span class="n">ca</span><span class="p">(</span><span class="n">mpl</span><span class="p">(</span><span class="n">plotter</span><span class="o">.</span><span class="n">combiplot</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)))</span>
            <span class="c1">#ca(mpl(plotter.combiplotly(show=False)))</span>

        <span class="k">return</span> <span class="n">col</span></div>

<div class="viewcode-block" id="PanelWithElectronBands.get_plot_skw_widgets"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.PanelWithElectronBands.get_plot_skw_widgets">[docs]</a>    <span class="k">def</span> <span class="nf">get_plot_skw_widgets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Widgets to compute e-DOS.&quot;&quot;&quot;</span>

        <span class="n">wdg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands_kmesh_fileinput</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;ebands_kpath_fileinput&#39;</span><span class="p">],</span>
            <span class="n">widgets</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ebands_kpath_fileinput&#39;</span><span class="p">:</span> <span class="n">pn</span><span class="o">.</span><span class="n">widgets</span><span class="o">.</span><span class="n">FileInput</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pws_col</span><span class="p">([</span><span class="s2">&quot;skw_lpratio&quot;</span><span class="p">,</span> <span class="s2">&quot;skw_line_density&quot;</span><span class="p">,</span> <span class="s2">&quot;with_gaps&quot;</span><span class="p">,</span> <span class="n">wdg</span><span class="p">,</span> <span class="s2">&quot;plot_skw_btn&quot;</span><span class="p">]),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_plot_skw_btn</span><span class="p">)</span></div>

<div class="viewcode-block" id="PanelWithElectronBands.get_plot_fermi_surface_widgets"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.PanelWithElectronBands.get_plot_fermi_surface_widgets">[docs]</a>    <span class="k">def</span> <span class="nf">get_plot_fermi_surface_widgets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Widgets to compute the Fermi surface.&quot;&quot;&quot;</span>
        <span class="c1">#return pn.Column(self.fs_viewer, self.plot_fermi_surface_btn)</span>
        <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pws_col</span><span class="p">([</span><span class="s2">&quot;skw_fs_viewer&quot;</span><span class="p">,</span> <span class="s2">&quot;plot_fermi_surface_btn&quot;</span><span class="p">]),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_plot_skw_btn</span><span class="p">)</span></div>

<div class="viewcode-block" id="PanelWithElectronBands.on_plot_fermi_surface_btn"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.PanelWithElectronBands.on_plot_fermi_surface_btn">[docs]</a>    <span class="nd">@depends_on_btn_click</span><span class="p">(</span><span class="s1">&#39;plot_fermi_surface_btn&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">on_plot_fermi_surface_btn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#if self.fs_viewer is None: return pn.pane.HTML()</span>

        <span class="c1"># Cache eb3d</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_eb3d&quot;</span><span class="p">):</span>
            <span class="n">eb3d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eb3d</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Build ebands in full BZ.</span>
            <span class="n">eb3d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eb3d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">get_ebands3d</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs_viewer</span> <span class="o">==</span> <span class="s2">&quot;matplotlib&quot;</span><span class="p">:</span>
            <span class="c1"># Use matplotlib to plot isosurfaces corresponding to the Fermi level (default)</span>
            <span class="c1"># Warning: requires skimage package, rendering could be slow.</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">eb3d</span><span class="o">.</span><span class="n">plot_isosurfaces</span><span class="p">(</span><span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mpl_kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">mpl</span><span class="p">(</span><span class="n">fig</span><span class="p">),</span> <span class="n">sizing_mode</span><span class="o">=</span><span class="s1">&#39;scale_width&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid choice: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs_viewer</span><span class="p">)</span></div></div>

        <span class="c1">#elif self.fs_viewer == &quot;xcrysden&quot;:</span>
            <span class="c1"># Alternatively, it&#39;s possible to export the data in xcrysden format</span>
            <span class="c1"># and then use `xcrysden --bxsf mgb2.bxsf`</span>
            <span class="c1">#eb3d.to_bxsf(&quot;mgb2.bxsf&quot;)</span>
            <span class="c1"># If you have mayavi installed, try:</span>
            <span class="c1">#eb3d.mvplot_isosurfaces()</span>


<div class="viewcode-block" id="BaseRobotPanel"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.BaseRobotPanel">[docs]</a><span class="k">class</span> <span class="nc">BaseRobotPanel</span><span class="p">(</span><span class="n">AbipyParameterized</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for panels with AbiPy robot.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compare_params_btn</span> <span class="o">=</span> <span class="n">pnw</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Compare structures&quot;</span><span class="p">,</span> <span class="n">button_type</span><span class="o">=</span><span class="s1">&#39;primary&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transpose_params</span> <span class="o">=</span> <span class="n">pnw</span><span class="o">.</span><span class="n">Checkbox</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Transpose tables&#39;</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

<div class="viewcode-block" id="BaseRobotPanel.on_compare_params_btn"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.BaseRobotPanel.on_compare_params_btn">[docs]</a>    <span class="nd">@depends_on_btn_click</span><span class="p">(</span><span class="s2">&quot;compare_params_btn&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">on_compare_params_btn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sizing_mode</span><span class="o">=</span><span class="s1">&#39;stretch_width&#39;</span><span class="p">);</span> <span class="n">ca</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">append</span>
        <span class="n">transpose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transpose_params</span><span class="o">.</span><span class="n">value</span>

        <span class="n">dfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">get_structure_dataframes</span><span class="p">()</span>
        <span class="n">ca</span><span class="p">(</span><span class="s2">&quot;# Lattice daframe&quot;</span><span class="p">)</span>
        <span class="n">ca</span><span class="p">(</span><span class="n">dfc</span><span class="p">(</span><span class="n">dfs</span><span class="o">.</span><span class="n">lattice</span><span class="p">,</span> <span class="n">transpose</span><span class="o">=</span><span class="n">transpose</span><span class="p">))</span>

        <span class="n">ca</span><span class="p">(</span><span class="s2">&quot;# Params daframe&quot;</span><span class="p">)</span>
        <span class="n">ca</span><span class="p">(</span><span class="n">dfc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">get_params_dataframe</span><span class="p">(),</span> <span class="n">transpose</span><span class="o">=</span><span class="n">transpose</span><span class="p">))</span>

        <span class="n">accord</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">Accordion</span><span class="p">(</span><span class="n">sizing_mode</span><span class="o">=</span><span class="s1">&#39;stretch_width&#39;</span><span class="p">)</span>
        <span class="n">accord</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;Atomic positions&quot;</span><span class="p">,</span> <span class="n">dfc</span><span class="p">(</span><span class="n">dfs</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">transpose</span><span class="o">=</span><span class="n">transpose</span><span class="p">)))</span>
        <span class="n">ca</span><span class="p">(</span><span class="n">accord</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">col</span></div>

    <span class="c1"># TODO: widgets to change robot labels.</span>

<div class="viewcode-block" id="BaseRobotPanel.get_compare_params_widgets"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.BaseRobotPanel.get_compare_params_widgets">[docs]</a>    <span class="k">def</span> <span class="nf">get_compare_params_widgets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compare_params_btn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transpose_params</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_compare_params_btn</span><span class="p">,</span>
            <span class="n">sizing_mode</span><span class="o">=</span><span class="s2">&quot;scale_both&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="PanelWithEbandsRobot"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.PanelWithEbandsRobot">[docs]</a><span class="k">class</span> <span class="nc">PanelWithEbandsRobot</span><span class="p">(</span><span class="n">BaseRobotPanel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mixin class for panels with a robot that owns a list of of |ElectronBands|</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>

        <span class="c1"># Widgets to plot ebands.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ebands_plotter_mode</span> <span class="o">=</span> <span class="n">pnw</span><span class="o">.</span><span class="n">Select</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Plot Mode&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;gridplot&quot;</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;gridplot&quot;</span><span class="p">,</span> <span class="s2">&quot;combiplot&quot;</span><span class="p">,</span> <span class="s2">&quot;boxplot&quot;</span><span class="p">,</span> <span class="s2">&quot;combiboxplot&quot;</span><span class="p">])</span> <span class="c1"># &quot;animate&quot;,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ebands_plotter_btn</span> <span class="o">=</span> <span class="n">pnw</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Plot&quot;</span><span class="p">,</span> <span class="n">button_type</span><span class="o">=</span><span class="s1">&#39;primary&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ebands_df_checkbox</span> <span class="o">=</span> <span class="n">pnw</span><span class="o">.</span><span class="n">Checkbox</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;With Ebands DataFrame&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Widgets to plot edos.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edos_plotter_mode</span> <span class="o">=</span> <span class="n">pnw</span><span class="o">.</span><span class="n">Select</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Plot Mode&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;gridplot&quot;</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;gridplot&quot;</span><span class="p">,</span> <span class="s2">&quot;combiplot&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edos_plotter_btn</span> <span class="o">=</span> <span class="n">pnw</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Plot&quot;</span><span class="p">,</span> <span class="n">button_type</span><span class="o">=</span><span class="s1">&#39;primary&#39;</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

<div class="viewcode-block" id="PanelWithEbandsRobot.get_ebands_plotter_widgets"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.PanelWithEbandsRobot.get_ebands_plotter_widgets">[docs]</a>    <span class="k">def</span> <span class="nf">get_ebands_plotter_widgets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands_plotter_mode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands_df_checkbox</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands_plotter_btn</span><span class="p">)</span></div>

<div class="viewcode-block" id="PanelWithEbandsRobot.on_ebands_plotter_btn"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.PanelWithEbandsRobot.on_ebands_plotter_btn">[docs]</a>    <span class="nd">@depends_on_btn_click</span><span class="p">(</span><span class="s2">&quot;ebands_plotter_btn&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">on_ebands_plotter_btn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">ebands_plotter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">get_ebands_plotter</span><span class="p">()</span>
        <span class="n">plot_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands_plotter_mode</span><span class="o">.</span><span class="n">value</span>
        <span class="n">plot_func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ebands_plotter</span><span class="p">,</span> <span class="n">plot_mode</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know how to handle plot_mode: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">plot_mode</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_func</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mpl_kwargs</span><span class="p">)</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">mpl</span><span class="p">(</span><span class="n">fig</span><span class="p">),</span> <span class="n">sizing_mode</span><span class="o">=</span><span class="s1">&#39;scale_width&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands_df_checkbox</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">ebands_plotter</span><span class="o">.</span><span class="n">get_ebands_frame</span><span class="p">(</span><span class="n">with_spglib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfc</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">sizing_mode</span><span class="o">=</span><span class="s1">&#39;scale_width&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PanelWithEbandsRobot.get_edos_plotter_widgets"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.PanelWithEbandsRobot.get_edos_plotter_widgets">[docs]</a>    <span class="k">def</span> <span class="nf">get_edos_plotter_widgets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edos_plotter_mode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edos_plotter_btn</span><span class="p">)</span></div>

<div class="viewcode-block" id="PanelWithEbandsRobot.on_edos_plotter_btn"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.PanelWithEbandsRobot.on_edos_plotter_btn">[docs]</a>    <span class="nd">@depends_on_btn_click</span><span class="p">(</span><span class="s2">&quot;edos_plotter_btn&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">on_edos_plotter_btn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot the electronic density of states.&quot;&quot;&quot;</span>
        <span class="n">edos_plotter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">get_edos_plotter</span><span class="p">()</span>
        <span class="n">plot_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edos_plotter_mode</span><span class="o">.</span><span class="n">value</span>
        <span class="n">plot_func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">edos_plotter</span><span class="p">,</span> <span class="n">plot_mode</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know how to handle plot_mode: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">plot_mode</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_func</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mpl_kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">mpl</span><span class="p">(</span><span class="n">fig</span><span class="p">)),</span> <span class="n">sizing_mode</span><span class="o">=</span><span class="s1">&#39;scale_width&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="jsmol_html"><a class="viewcode-back" href="../../../api/panels_api.html#abipy.panels.core.jsmol_html">[docs]</a><span class="k">def</span> <span class="nf">jsmol_html</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="s2">&quot;false&quot;</span><span class="p">):</span>

    <span class="n">cif_str</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">write_cif_with_spglib_symms</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ret_string</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#, symprec=symprec</span>

    <span class="c1"># There&#39;s a bug in boken when we use strings with several &#39;&quot; quotation marks</span>
    <span class="c1"># To bypass the problem I create a json list of strings and then I use a js variable</span>
    <span class="c1"># to recreate the cif file by joining the tokens.</span>
    <span class="c1"># const elements = [&#39;Fire&#39;, &#39;Air&#39;, &#39;Water&#39;];</span>
    <span class="c1"># var string = elements.join(&#39;\n&#39;);</span>
    <span class="kn">import</span> <span class="nn">json</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">cif_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="c1">#print(&quot;lines:&quot;, lines)</span>

    <span class="n">jsmol_div_id</span> <span class="o">=</span> <span class="n">gen_id</span><span class="p">()</span>
    <span class="n">jsmol_app_name</span> <span class="o">=</span> <span class="s2">&quot;js1&quot;</span>
    <span class="n">supercell</span> <span class="o">=</span> <span class="s2">&quot;{2, 2, 2}&quot;</span>
    <span class="n">supercell</span> <span class="o">=</span> <span class="s2">&quot;{1, 1, 1}&quot;</span>

    <span class="c1">#script_str = &#39;load inline &quot;%s&quot; {1 1 1};&#39; % cif_str</span>
    <span class="c1">#script_str = &quot;load $caffeine&quot;</span>

    <span class="c1"># http://wiki.jmol.org/index.php/Jmol_JavaScript_Object/Functions#getAppletHtml</span>

    <span class="n">html</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;script type=&quot;text/javascript&quot;&gt;</span>
<span class="s2">    $(document).ready(function() </span><span class="se">{{</span><span class="s2"></span>

<span class="s2">       const lines = </span><span class="si">{</span><span class="n">lines</span><span class="si">}</span><span class="s2">;</span>
<span class="s2">       var script_str = &#39;load inline &quot; &#39; + lines.join(&#39;</span><span class="se">\\</span><span class="s2">n&#39;) + &#39;&quot; </span><span class="si">{</span><span class="n">supercell</span><span class="si">}</span><span class="s2">&#39;;</span>
<span class="s2">       //console.log(script_str);</span>

<span class="s2">       var Info = </span><span class="se">{{</span><span class="s2"></span>
<span class="s2">           color: &quot;</span><span class="si">{</span><span class="n">color</span><span class="si">}</span><span class="s2">&quot;,</span>
<span class="s2">           spin: </span><span class="si">{</span><span class="n">spin</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">           antialiasDisplay: true,</span>
<span class="s2">           width: </span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">           height: </span><span class="si">{</span><span class="n">height</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">           j2sPath: &quot;http://chemapps.stolaf.edu/jmol/jsmol/j2s&quot;,</span>
<span class="s2">           serverURL: &quot;http://chemapps.stolaf.edu/jmol/jsmol/php/jsmol.php&quot;,</span>
<span class="s2">           script: script_str,</span>
<span class="s2">           use: &#39;html5&#39;,</span>
<span class="s2">           disableInitialConsole: true,</span>
<span class="s2">           disableJ2SLoadMonitor: true,</span>
<span class="s2">           debug: false</span>
<span class="s2">       </span><span class="se">}}</span><span class="s2">;</span>

<span class="s2">       $(&quot;#</span><span class="si">{</span><span class="n">jsmol_div_id</span><span class="si">}</span><span class="s2">&quot;).html(Jmol.getAppletHtml(&quot;</span><span class="si">{</span><span class="n">jsmol_app_name</span><span class="si">}</span><span class="s2">&quot;, Info));</span>
<span class="s2">    </span><span class="se">}}</span><span class="s2">);</span>
<span class="s2">&lt;/script&gt;</span>

<span class="s2">&lt;div id=&quot;</span><span class="si">{</span><span class="n">jsmol_div_id</span><span class="si">}</span><span class="s2">&quot; style=&quot;height: 100%; width: 100%; position: relative;&quot;&gt;&lt;/div&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>

    <span class="c1">#print(html)</span>
    <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">sizing_mode</span><span class="o">=</span><span class="s2">&quot;stretch_width&quot;</span><span class="p">),</span> <span class="n">sizing_mode</span><span class="o">=</span><span class="s2">&quot;stretch_width&quot;</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, M. Giantomassi and the AbiPy group.
      <span class="lastupdated">
        Last updated on May 28, 2021.
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>