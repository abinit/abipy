<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>abipy.eph.eph &#8212; abipy 0.2.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html">
          abipy</a>
        <span class="navbar-text navbar-version pull-left"><b>0.2.0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../features.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Getting AbiPy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../whats_new.html">What’s new in abipy</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../scripts/index.html">Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gallery/index.html">AbiPy Gallery</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../workflows/taskmanager.html">TaskManager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../flow_gallery/index.html">AbiPy Flow Gallery</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../devel/index.html">Developers’ Guide</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <h1>Source code for abipy.eph.eph</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: utf-8</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains objects for the postprocessing of EPH calculations.</span>

<span class="sd">Warning:</span>
<span class="sd">    Work in progress, DO NOT USE THIS CODE.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">unicode_literals</span><span class="p">,</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pymatgen.core.units</span> <span class="k">as</span> <span class="nn">units</span>
<span class="kn">import</span> <span class="nn">abipy.core.abinit_units</span> <span class="k">as</span> <span class="nn">abu</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="k">import</span> <span class="n">cumtrapz</span><span class="p">,</span> <span class="n">simps</span>
<span class="kn">from</span> <span class="nn">monty.string</span> <span class="k">import</span> <span class="n">marquee</span><span class="p">,</span> <span class="n">list_strings</span>
<span class="kn">from</span> <span class="nn">monty.functools</span> <span class="k">import</span> <span class="n">lazy_property</span>
<span class="kn">from</span> <span class="nn">abipy.core.mixins</span> <span class="k">import</span> <span class="n">AbinitNcFile</span><span class="p">,</span> <span class="n">Has_Structure</span><span class="p">,</span> <span class="n">Has_ElectronBands</span><span class="p">,</span> <span class="n">NotebookWriter</span>
<span class="kn">from</span> <span class="nn">abipy.core.kpoints</span> <span class="k">import</span> <span class="n">Kpath</span>
<span class="kn">from</span> <span class="nn">abipy.tools.plotting</span> <span class="k">import</span> <span class="n">add_fig_kwargs</span><span class="p">,</span> <span class="n">get_ax_fig_plt</span><span class="p">,</span> <span class="n">set_axlims</span>
<span class="kn">from</span> <span class="nn">abipy.electrons.ebands</span> <span class="k">import</span> <span class="n">ElectronsReader</span><span class="p">,</span> <span class="n">ElectronDos</span><span class="p">,</span> <span class="n">RobotWithEbands</span>
<span class="kn">from</span> <span class="nn">abipy.dfpt.phonons</span> <span class="k">import</span> <span class="p">(</span><span class="n">PhononBands</span><span class="p">,</span> <span class="n">PhononDos</span><span class="p">,</span> <span class="n">RobotWithPhbands</span><span class="p">,</span>
    <span class="n">factor_ev2units</span><span class="p">,</span> <span class="n">unit_tag</span><span class="p">,</span> <span class="n">dos_label_from_units</span><span class="p">,</span> <span class="n">wlabel_from_units</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">abipy.abio.robots</span> <span class="k">import</span> <span class="n">Robot</span>


<div class="viewcode-block" id="A2f"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.A2f">[docs]</a><span class="k">class</span> <span class="nc">A2f</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Eliashberg function a2F(w). Energies are in eV.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Markers used for up/down bands.</span>
    <span class="n">marker_spin</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;v&quot;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">values_spin</span><span class="p">,</span> <span class="n">values_spin_nu</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            mesh: Energy mesh in eV</span>

<span class="sd">        values(nomega,0:natom3,nsppol)</span>
<span class="sd">        vals(w,1:natom,1:nsppol): a2f(w) decomposed per phonon branch and spin</span>
<span class="sd">        vals(w,0,1:nsppol): a2f(w) summed over phonons modes, decomposed in spin</span>

<span class="sd">        TODO: Add metadata (qsampling, broadening, possibility of computing a2f directly?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh</span>

        <span class="c1"># Spin dependent and total a2F(w)</span>
        <span class="n">values_spin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">values_spin</span><span class="p">)</span>
        <span class="n">values_spin_nu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_3d</span><span class="p">(</span><span class="n">values_spin_nu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values_spin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmodes</span> <span class="o">=</span> <span class="n">values_spin_nu</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmodes</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">natom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmodes</span> <span class="o">//</span> <span class="mi">3</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">values_spin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">values_spin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values_nu</span> <span class="o">=</span> <span class="n">values_spin_nu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">values_spin_nu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">values_spin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values_nu</span> <span class="o">=</span> <span class="n">values_spin_nu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid nsppol: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">values_spin</span> <span class="o">=</span> <span class="n">values_spin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values_spin_nu</span> <span class="o">=</span> <span class="n">values_spin_nu</span>
        <span class="c1">#self.lambdaw ?</span>

<div class="viewcode-block" id="A2f.iw0"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.A2f.iw0">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">iw0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Index of the first point in the mesh whose value is &gt;= 0</span>
<span class="sd">        Integrals are performed with wmesh[iw0 + 1, :] i.e. unstable modes are neglected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">:</span> <span class="k">return</span> <span class="n">i</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot find zero in energy mesh&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

<div class="viewcode-block" id="A2f.to_string"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.A2f.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation with verbosity level `verbose`.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>

        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Eliashberg Function&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">title</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">title</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Mesh from </span><span class="si">%.4f</span><span class="s2"> to </span><span class="si">%.4f</span><span class="s2"> [eV] with </span><span class="si">%d</span><span class="s2"> points&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)))</span>

        <span class="c1"># TODO: Add ElectronDos</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Isotropic lambda: </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambda_iso</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Omega_log: </span><span class="si">%s</span><span class="s2"> [eV], </span><span class="si">%s</span><span class="s2"> [K]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">omega_log</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_log</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">eV_to_K</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">mustar</span> <span class="ow">in</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">):</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">For mustar </span><span class="si">%s</span><span class="s2">: McMillan Tc: </span><span class="si">%s</span><span class="s2"> [K]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mustar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mcmillan_tc</span><span class="p">(</span><span class="n">mustar</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="c1"># $\int dw [a2F(w)/w] w^n$</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
                <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Moment </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_moment</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="A2f.lambda_iso"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.A2f.lambda_iso">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">lambda_iso</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Isotropic lambda.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_moment</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="A2f.omega_log"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.A2f.omega_log">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">omega_log</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get log moment of alpha^2F: exp((2/\lambda) \int dw a2F(w) ln(w)/w)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#return 270 / abu.eV_to_K</span>
        <span class="n">iw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iw0</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">wmesh</span><span class="p">,</span> <span class="n">a2fw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">[</span><span class="n">iw</span><span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">iw</span><span class="p">:]</span>

        <span class="c1">#ax, fig, plt = get_ax_fig_plt(ax=None)</span>
        <span class="c1">#ax.plot(wmesh, a2fw / wmesh * np.log(wmesh))</span>
        <span class="c1">#plt.show()</span>

        <span class="n">fw</span> <span class="o">=</span> <span class="n">a2fw</span> <span class="o">/</span> <span class="n">wmesh</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">wmesh</span><span class="p">)</span>
        <span class="n">integral</span> <span class="o">=</span> <span class="n">simps</span><span class="p">(</span><span class="n">fw</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">wmesh</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_iso</span> <span class="o">*</span> <span class="n">integral</span><span class="p">)</span></div>

<div class="viewcode-block" id="A2f.get_moment"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.A2f.get_moment">[docs]</a>    <span class="k">def</span> <span class="nf">get_moment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cumulative</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the moment of a2F(w) i.e. $\int dw [a2F(w)/w] w^n$</span>
<span class="sd">        From Allen PRL 59 1460 (See also Grimvall, Eq 6.72 page 175)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wmesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iw0</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">spin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">a2fw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iw0</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a2fw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">iw0</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>

        <span class="c1"># Primitive is given on the same mesh as self.</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="n">a2fw</span> <span class="o">*</span> <span class="p">(</span><span class="n">wmesh</span> <span class="o">**</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">vals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iw0</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">cumtrapz</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">wmesh</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vals</span> <span class="k">if</span> <span class="n">cumulative</span> <span class="k">else</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>

<div class="viewcode-block" id="A2f.get_moment_nu"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.A2f.get_moment_nu">[docs]</a>    <span class="k">def</span> <span class="nf">get_moment_nu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cumulative</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the moment of a2F(w) i.e. $\int dw [a2F(w)/w] w^n$</span>
<span class="sd">        From Allen PRL 59 1460 (See also Grimvall, Eq 6.72 page 175)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wmesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iw0</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">spin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">a2fw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values_nu</span><span class="p">[</span><span class="n">nu</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">iw0</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a2fw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values_spin_nu</span><span class="p">[</span><span class="n">spin</span><span class="p">][</span><span class="n">nu</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">iw0</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>

        <span class="c1"># Primitive is given on the same mesh as self.</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="n">a2fw</span> <span class="o">*</span> <span class="p">(</span><span class="n">wmesh</span> <span class="o">**</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">vals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iw0</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">cumtrapz</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">wmesh</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vals</span> <span class="k">if</span> <span class="n">cumulative</span> <span class="k">else</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>

<div class="viewcode-block" id="A2f.get_mcmillan_tc"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.A2f.get_mcmillan_tc">[docs]</a>    <span class="k">def</span> <span class="nf">get_mcmillan_tc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mustar</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the critical temperature with the McMillan equation and the input mustar.</span>

<span class="sd">        Return:</span>
<span class="sd">            Tc in Kelvin degrees</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tc</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">omega_log</span> <span class="o">/</span> <span class="mf">1.2</span><span class="p">)</span> <span class="o">*</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">1.04</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_iso</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambda_iso</span> <span class="o">-</span> <span class="n">mustar</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="mf">0.62</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_iso</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">tc</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">eV_to_K</span></div>

<div class="viewcode-block" id="A2f.get_mustar_from_tc"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.A2f.get_mustar_from_tc">[docs]</a>    <span class="k">def</span> <span class="nf">get_mustar_from_tc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the value of mustar that gives the critical temperature `tc` in the McMillan equation.</span>

<span class="sd">        Args:</span>
<span class="sd">            tc:</span>
<span class="sd">                Critical temperature in Kelvin</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_iso</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.04</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">l</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.2</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">kb_eVK</span> <span class="o">*</span> <span class="n">tc</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_log</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">num</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">0.62</span> <span class="o">*</span> <span class="n">l</span><span class="p">)</span></div>

<div class="viewcode-block" id="A2f.plot"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.A2f.plot">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="n">with_lambda</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot a2F(w), it&#39;s primitive lambda(w) and optionally the individual</span>
<span class="sd">        contributions due to the phonon branches.</span>

<span class="sd">        Args:</span>
<span class="sd">            units: Units for phonon plots. Possible values in</span>
<span class="sd">                (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;). Case-insensitive.</span>
<span class="sd">            with_lambda:</span>
<span class="sd">            exchange_xy: True to exchange x-y axes.</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>
<span class="sd">            xlims: Set the data limits for the y-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                    or scalar e.g. `left`. If left (right) is None, default values are used</span>
<span class="sd">            ylims: Limits for y-axis. See xlims for API.</span>
<span class="sd">            label: True to add legend label to each curve.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="s2">&quot;&quot;</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="n">wfactor</span> <span class="o">=</span> <span class="n">factor_ev2units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>

        <span class="c1"># TODO Better handling of styles</span>
        <span class="n">style</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;linestyle&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span>
            <span class="n">color</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">),</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;linewidth&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Plot a2f(w)</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">*</span> <span class="n">wfactor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span>
        <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span><span class="p">,</span> <span class="n">xx</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>

        <span class="c1"># Plot lambda(w)</span>
        <span class="k">if</span> <span class="n">with_lambda</span><span class="p">:</span>
            <span class="n">lambda_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_moment</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cumulative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">l_ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
            <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">*</span> <span class="n">wfactor</span><span class="p">,</span> <span class="n">lambda_w</span>
            <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span><span class="p">,</span> <span class="n">xx</span>
            <span class="n">l_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>
            <span class="n">l_ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\lambda(\omega)$&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># Plot spin resolved a2f(w).</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">*</span> <span class="n">wfactor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span><span class="p">,</span> <span class="n">xx</span>
                <span class="n">ax_plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">marker_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">],</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>

        <span class="n">xlabel</span> <span class="o">=</span> <span class="n">wlabel_from_units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$\alpha^2F(\omega)$&quot;</span>
        <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">xlabel</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">label</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="A2f.plot_nuterms"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.A2f.plot_nuterms">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_nuterms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="n">axmat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_lambda</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot a2F(w), it&#39;s primitive lambda(w) and optionally the individual</span>
<span class="sd">        contributions due to the phonon branches.</span>

<span class="sd">        Args:</span>
<span class="sd">            units: Units for phonon plots. Possible values in (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;).</span>
<span class="sd">                Case-insensitive.</span>
<span class="sd">            axmat: Matrix of axis of shape [natom, 3]. None if a new figure should be created.</span>
<span class="sd">            xlims: Set the data limits for the y-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                    or scalar e.g. `left`. If left (right) is None, default values are used</span>
<span class="sd">            ylims: Limits for y-axis. See xlims for API.</span>
<span class="sd">            label: True to add legend label to each curve.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="s2">&quot;&quot;</span>
        <span class="c1"># Get axmat and fig.</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="k">if</span> <span class="n">axmat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axmat</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">axmat</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>

        <span class="n">wfactor</span> <span class="o">=</span> <span class="n">factor_ev2units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
        <span class="n">wvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">*</span> <span class="n">wfactor</span>

        <span class="k">if</span> <span class="n">with_lambda</span><span class="p">:</span>
            <span class="n">lax_nu</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axmat</span><span class="o">.</span><span class="n">flat</span><span class="p">]</span>
            <span class="c1"># Share axis after creation. Based on</span>
            <span class="c1"># https://stackoverflow.com/questions/42973223/how-share-x-axis-of-two-subplots-after-they-are-created</span>
            <span class="n">lax_nu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_shared_x_axes</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">lax_nu</span><span class="p">)</span>
            <span class="n">lax_nu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_shared_y_axes</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">lax_nu</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lax_nu</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
                <span class="c1">#ax.set_xticklabels([])</span>

        <span class="c1"># TODO Better handling of styles</span>
        <span class="n">a2f_style</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;linestyle&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span>
            <span class="n">color</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">),</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;linewidth&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">lambda_style</span> <span class="o">=</span> <span class="n">a2f_style</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">lambda_style</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span>

        <span class="kn">import</span> <span class="nn">itertools</span>
        <span class="k">for</span> <span class="n">idir</span><span class="p">,</span> <span class="n">iatom</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">)):</span>
            <span class="n">nu</span> <span class="o">=</span> <span class="n">idir</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">iatom</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axmat</span><span class="p">[</span><span class="n">iatom</span><span class="p">,</span> <span class="n">idir</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\nu = </span><span class="si">%d</span><span class="s2">$&quot;</span> <span class="o">%</span> <span class="n">nu</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">idir</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\alpha^2F(\omega)$&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
                <span class="c1"># Turn off tick labels</span>
                <span class="c1">#ax.set_yticklabels([])</span>
                <span class="c1">#ax.set_yticks([])</span>

            <span class="k">if</span> <span class="n">iatom</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">natom</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">wlabel_from_units</span><span class="p">(</span><span class="n">units</span><span class="p">))</span>
            <span class="c1">#set_axlims(ax, xlims, &quot;x&quot;)</span>
            <span class="c1">#set_axlims(ax, ylims, &quot;y&quot;)</span>

            <span class="c1"># Plot total a2f(w)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wvals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values_nu</span><span class="p">[</span><span class="n">nu</span><span class="p">],</span> <span class="o">**</span><span class="n">a2f_style</span><span class="p">)</span>

            <span class="c1"># Plot lambda(w)</span>
            <span class="k">if</span> <span class="n">with_lambda</span><span class="p">:</span>
                <span class="n">lambdaw_nu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_moment_nu</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nu</span><span class="o">=</span><span class="n">nu</span><span class="p">,</span> <span class="n">cumulative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">lax</span> <span class="o">=</span> <span class="n">lax_nu</span><span class="p">[</span><span class="n">nu</span><span class="p">]</span>
                <span class="n">lax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wvals</span><span class="p">,</span> <span class="n">lambdaw_nu</span><span class="p">,</span> <span class="o">**</span><span class="n">lambda_style</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">idir</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">lax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\lambda_{\nu}(\omega)$&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">lambda_style</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">])</span>

            <span class="c1">#if self.nsppol == 2:</span>
            <span class="c1">#   # Plot spin resolved a2f(w)</span>
            <span class="c1">#   for spin in range(self.nsppol):</span>
            <span class="c1">#       ax.plot(self.mesh, self.values_spin_nu[spin, nu],</span>
            <span class="c1">#               marker=self.marker_spin[spin], **a2f_style)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="A2f.plot_a2"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.A2f.plot_a2">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_a2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phdos</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Grid with 3 plots (a2F, F, a2F).</span>

<span class="sd">        Args:</span>
<span class="sd">            phdos:</span>
<span class="sd">            atol:</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">phdos</span> <span class="o">=</span> <span class="n">PhononDos</span><span class="o">.</span><span class="n">as_phdos</span><span class="p">(</span><span class="n">phdos</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax_list</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Spline phdos onto a2f mesh and compute a2F(w) / F(w)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">phdos</span><span class="o">.</span><span class="n">spline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">atol</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">atol</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">ax_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\alpha^2(\omega)$ [1/eV]&quot;</span><span class="p">)</span>

        <span class="c1"># Plot F. TODO: This should not be called plot_dos_idos!</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">ax_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">phdos</span><span class="o">.</span><span class="n">plot_dos_idos</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$F(\omega)$ [states/eV]&quot;</span><span class="p">)</span>

        <span class="c1"># Plot a2f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax_list</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="A2f.plot_tc_vs_mustar"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.A2f.plot_tc_vs_mustar">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_tc_vs_mustar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot Tc(mustar)</span>

<span class="sd">        Args:</span>
<span class="sd">            start: The starting value of the sequence.</span>
<span class="sd">            stop: The end value of the sequence</span>
<span class="sd">            num: int, optional</span>
<span class="sd">                Number of samples to generate. Default is 50. Must be non-negative.</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO start and stop to avoid singularity in Mc Tc</span>
        <span class="n">mustar_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="p">)</span>
        <span class="n">tc_vals</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_mcmillan_tc</span><span class="p">(</span><span class="n">mustar</span><span class="p">)</span> <span class="k">for</span> <span class="n">mustar</span> <span class="ow">in</span> <span class="n">mustar_values</span><span class="p">]</span>

        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mustar_values</span><span class="p">,</span> <span class="n">tc_vals</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\mu^*$&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$T_c [K]$&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div></div>


<div class="viewcode-block" id="A2Ftr"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.A2Ftr">[docs]</a><span class="k">class</span> <span class="nc">A2Ftr</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="c1"># Markers used for up/down bands (collinear spin)</span>
    <span class="n">marker_spin</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;v&quot;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">vals_in</span><span class="p">,</span> <span class="n">vals_out</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            mesh: Energy mesh in eV</span>

<span class="sd">        vals_in(nomega,3,3,0:natom3,nsppol)</span>
<span class="sd">        Eliashberg transport functions for in and out scattering</span>
<span class="sd">        vals_in(w,3,3,1:natom3,1:nsppol): a2f_tr(w) decomposed per phonon branch and spin</span>
<span class="sd">        vals_in(w,3,3,0,1:nsppol): a2f_tr(w) summed over phonons modes, decomposed in spin</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh</span>

<div class="viewcode-block" id="A2Ftr.iw0"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.A2Ftr.iw0">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">iw0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Index of the first point in the mesh whose value is &gt;= 0</span>
<span class="sd">        Integrals are performed with wmesh[iw0 + 1, :] i.e. unstable modes are neglected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">:</span> <span class="k">return</span> <span class="n">i</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot find zero in energy mesh&quot;</span><span class="p">)</span></div></div>


<span class="c1"># TODO Change name.</span>
<div class="viewcode-block" id="EphFile"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.EphFile">[docs]</a><span class="k">class</span> <span class="nc">EphFile</span><span class="p">(</span><span class="n">AbinitNcFile</span><span class="p">,</span> <span class="n">Has_Structure</span><span class="p">,</span> <span class="n">Has_ElectronBands</span><span class="p">,</span> <span class="n">NotebookWriter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This file contains the phonon linewidths, EliashbergFunction, the phonon bands,</span>
<span class="sd">    the `ElectronBands` and `ElectronDos` on the k-mesh.</span>
<span class="sd">    Provides methods to plot results.</span>

<span class="sd">    Usage example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        with EphFile(&quot;out_EPH.nc&quot;) as ncfile:</span>
<span class="sd">            print(ncfile)</span>
<span class="sd">            ncfile.ebands.plot()</span>
<span class="sd">            ncfile.phbands.plot()</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="EphFile.from_file"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.EphFile.from_file">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the object from a Netcdf file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EphFile</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="n">EphReader</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

<div class="viewcode-block" id="EphFile.to_string"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.EphFile.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>

        <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="s2">&quot;File Info&quot;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filestat</span><span class="p">(</span><span class="n">as_string</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Structure&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">with_structure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Electronic Bands&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phbands</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">with_structure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Phonon Bands&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="c1"># E-PH section</span>
        <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="s2">&quot;E-PH calculation&quot;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Has transport a2Ftr(w): </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_a2ftr</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a2f_qcoarse</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;A2f(w) on the ab-initio q-mesh:&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a2f_qintp</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;A2f(w) interpolated on the dense q-mesh:&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="EphFile.ebands"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.EphFile.ebands">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">ebands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;:class:`ElectronBands` object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_ebands</span><span class="p">()</span></div>

<div class="viewcode-block" id="EphFile.edos"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.EphFile.edos">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">edos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;:class:`ElectronDos` object with e-DOS computed by Abinit.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_edos</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;:class:`Structure` object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">structure</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">phbands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;:class:`PhononBands` object with frequencies along the q-path.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_phbands_qpath</span><span class="p">()</span>

    <span class="c1">#@lazy_property</span>
    <span class="c1">#def params(self):</span>
    <span class="c1">#    &quot;&quot;&quot;Dictionary with the parameters that are usually tested for convergence.&quot;&quot;&quot;</span>
    <span class="c1">#    return {k: v for k, v in self.header.items() if k in (&quot;nkpt&quot;, &quot;nsppol&quot;, &quot;ecut&quot;, &quot;tsmear&quot;, &quot;ixc&quot;)}</span>

<div class="viewcode-block" id="EphFile.a2f_qcoarse"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.EphFile.a2f_qcoarse">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">a2f_qcoarse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :class:`A2f` with the Eliashberg function a2F(w)</span>
<span class="sd">        computed on the (coarse) ab-initio q-mesh.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_a2f</span><span class="p">(</span><span class="n">qsamp</span><span class="o">=</span><span class="s2">&quot;qcoarse&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="EphFile.a2f_qintp"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.EphFile.a2f_qintp">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">a2f_qintp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :class:`A2f` with the Eliashberg function a2F(w)</span>
<span class="sd">        computed on the dense q-mesh by Fourier interpolation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_a2f</span><span class="p">(</span><span class="n">qsamp</span><span class="o">=</span><span class="s2">&quot;qintp&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="EphFile.get_a2f_qsamp"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.EphFile.get_a2f_qsamp">[docs]</a>    <span class="k">def</span> <span class="nf">get_a2f_qsamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qsamp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the :class:`A2f` object associated to q-sampling `qsamp`.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">qsamp</span> <span class="o">==</span> <span class="s2">&quot;qcoarse&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">a2f_qcoarse</span>
        <span class="k">if</span> <span class="n">qsamp</span> <span class="o">==</span> <span class="s2">&quot;qintp&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">a2f_qintp</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid value for qsamp `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">qsamp</span><span class="p">))</span></div>

<div class="viewcode-block" id="EphFile.has_a2ftr"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.EphFile.has_a2ftr">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">has_a2ftr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if netcdf file contains transport data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;a2ftr_qcoarse&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">rootgrp</span><span class="o">.</span><span class="n">variables</span></div>

<div class="viewcode-block" id="EphFile.a2ftr_qcoarse"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.EphFile.a2ftr_qcoarse">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">a2ftr_qcoarse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :class:`A2ftr` with the Eliashberg transport spectral function a2F_tr(w, x, x&#39;)</span>
<span class="sd">        computed on the (coarse) ab-initio q-mesh</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_a2ftr</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_a2ftr</span><span class="p">(</span><span class="n">qsamp</span><span class="o">=</span><span class="s2">&quot;qcoarse&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="EphFile.a2ftr_qinpt"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.EphFile.a2ftr_qinpt">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">a2ftr_qinpt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :class:`A2ftr` with the Eliashberg transport spectral function a2F_tr(w, x, x&#39;)</span>
<span class="sd">        computed on the dense q-mesh by Fourier interpolation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_a2ftr</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_a2ftr</span><span class="p">(</span><span class="n">qsamp</span><span class="o">=</span><span class="s2">&quot;qintp&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="EphFile.get_a2ftr_qsamp"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.EphFile.get_a2ftr_qsamp">[docs]</a>    <span class="k">def</span> <span class="nf">get_a2ftr_qsamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qsamp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the :class:`A2ftr` object associated to q-sampling `qsamp`.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">qsamp</span> <span class="o">==</span> <span class="s2">&quot;qcoarse&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">a2ftr_qcoarse</span>
        <span class="k">if</span> <span class="n">qsamp</span> <span class="o">==</span> <span class="s2">&quot;qintp&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">a2ftr_qintp</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid value for qsamp `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">qsamp</span><span class="p">))</span></div>

<div class="viewcode-block" id="EphFile.close"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.EphFile.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close the file.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="EphFile.plot_eph_strength"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.EphFile.plot_eph_strength">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_eph_strength</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;lambda&quot;</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot phonon bands with eph coupling strength lambda(q, nu)</span>

<span class="sd">        Args:</span>
<span class="sd">            what: `lambda` for eph strength, gamma for phonon linewidths.</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>
<span class="sd">            label: String used to label the plot in the legend.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="c1"># Plot phonon bands</span>
        <span class="c1">#self.phbands.plot(ax=ax, units=units, show=False)</span>

        <span class="c1"># Decorate the axis (e.g add ticks and labels).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phbands</span><span class="o">.</span><span class="n">decorate_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Add eph coupling.</span>
        <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;lambda&quot;</span><span class="p">:</span>
            <span class="n">yvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_phlambda_qpath</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$\lambda(q,\nu)$&quot;</span>
        <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;gamma&quot;</span><span class="p">:</span>
            <span class="n">yvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_phgamma_qpath</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$\gamma(q,\nu)$ [eV]&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid value for what: `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">what</span><span class="p">))</span>

        <span class="n">style</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;linestyle&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span>
            <span class="n">color</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">),</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;linewidth&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">xvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phbands</span><span class="o">.</span><span class="n">qpoints</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">nu</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phbands</span><span class="o">.</span><span class="n">branches</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">yvals</span><span class="p">[:,</span> <span class="n">nu</span><span class="p">],</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">label</span> <span class="k">if</span> <span class="p">(</span><span class="n">nu</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">label</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">style</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">label</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="EphFile.plot"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.EphFile.plot">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;lambda&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot phonon bands with eph coupling strength lambda(q, nu) or gamma(q, nu)</span>

<span class="sd">        Args:</span>
<span class="sd">            what: `lambda` for eph strength, gamma for ph linewidth.</span>
<span class="sd">            units: Units for phonon plots. Possible values in (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;).</span>
<span class="sd">                Case-insensitive.</span>
<span class="sd">            scale: float used to scale the marker size.</span>
<span class="sd">            alpha: The alpha blending value for the markers between 0 (transparent) and 1 (opaque)</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="c1"># Plot phonon bands.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phbands</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Add eph coupling.</span>
        <span class="n">xvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phbands</span><span class="o">.</span><span class="n">qpoints</span><span class="p">))</span>
        <span class="n">yvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phbands</span><span class="o">.</span><span class="n">phfreqs</span> <span class="o">*</span> <span class="n">factor_ev2units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>

        <span class="c1"># [0] is for the number_of_spins</span>
        <span class="c1"># TODO units</span>
        <span class="c1">#if what == &quot;lambda&quot;:</span>
        <span class="c1">#    s = self.reader.read_phlambda_qpath()[0]</span>
        <span class="c1">#    scale = 100</span>
        <span class="c1">#elif what == &quot;gamma&quot;:</span>
        <span class="c1">#    s = self.reader.read_phgamma_qpath()[0]</span>
        <span class="c1">#    scale = 1</span>
        <span class="c1">#else:</span>
        <span class="c1">#    raise ValueError(&quot;Invalid value fo what: `%s`&quot; % what)</span>

        <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">gammas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_phgamma_qpath</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">gam_min</span><span class="p">,</span> <span class="n">gam_max</span> <span class="o">=</span> <span class="n">gammas</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">gammas</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">lambdas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_phlambda_qpath</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lamb_min</span><span class="p">,</span> <span class="n">lamb_max</span> <span class="o">=</span> <span class="n">lambdas</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">lambdas</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;jet&quot;</span>

        <span class="k">for</span> <span class="n">nu</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phbands</span><span class="o">.</span><span class="n">branches</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            scale = 100000</span>
<span class="sd">            ax.scatter(xvals, yvals[:, nu], s=(scale * np.abs(gammas[:, nu]))**2,</span>
<span class="sd">                       c=lambdas[:, nu],</span>
<span class="sd">                       vmin=lamb_min, vmax=lamb_max,</span>
<span class="sd">                       cmap=cmap,</span>
<span class="sd">                       marker=&quot;o&quot;,</span>
<span class="sd">                       #c=color,</span>
<span class="sd">                       #alpha=alpha</span>
<span class="sd">                       #label=term if ib == 0 else None</span>
<span class="sd">            )</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="n">scale</span> <span class="o">=</span> <span class="mi">500</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">yvals</span><span class="p">[:,</span> <span class="n">nu</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="n">scale</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lambdas</span><span class="p">[:,</span> <span class="n">nu</span><span class="p">]),</span>
                       <span class="n">c</span><span class="o">=</span><span class="n">gammas</span><span class="p">[:,</span> <span class="n">nu</span><span class="p">],</span>
                       <span class="n">vmin</span><span class="o">=</span><span class="n">gam_min</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">gam_max</span><span class="p">,</span>
                       <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                       <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
                       <span class="c1">#c=color,</span>
                       <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                       <span class="c1">#label=term if ib == 0 else None</span>
            <span class="p">)</span>

        <span class="c1"># Make a color bar</span>
        <span class="c1">#plt.colorbar(ax, cmap=cmap)</span>

        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="EphFile.plot_a2f_interpol"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.EphFile.plot_a2f_interpol">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_a2f_interpol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="c1">#linestyle_qsamp = dict(qcoarse=&quot;--&quot;, qintp=&quot;-&quot;)</span>
        <span class="k">for</span> <span class="n">qsamp</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;qcoarse&quot;</span><span class="p">,</span> <span class="s2">&quot;qintp&quot;</span><span class="p">]:</span>
            <span class="n">a2f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_a2f_qsamp</span><span class="p">(</span><span class="n">qsamp</span><span class="p">)</span>
            <span class="n">a2f</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="n">ylims</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">with_lambda</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1">#ax.yaxis.set_ticks_position(&quot;right&quot;)</span>
            <span class="c1">#ax.yaxis.set_label_position(&quot;right&quot;)</span>
            <span class="c1">#ax.tick_params(labelbottom=&#39;off&#39;)</span>
            <span class="c1">#ax.set_ylabel(&quot;&quot;)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="EphFile.plot_with_a2f"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.EphFile.plot_with_a2f">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_with_a2f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="n">qsamp</span><span class="o">=</span><span class="s2">&quot;qintp&quot;</span><span class="p">,</span> <span class="n">phdos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot phonon bands with lambda(q, nu) + a2F(w) + phonon DOS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Max three additional axes with [a2F, a2F_tr, DOS]</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">width_ratios</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_a2ftr</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">width_ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">phdos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">phdos</span> <span class="o">=</span> <span class="n">PhononDos</span><span class="o">.</span><span class="n">as_phdos</span><span class="p">(</span><span class="n">phdos</span><span class="p">)</span>
            <span class="n">ncols</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">width_ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>

        <span class="c1"># Build grid plot.</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="k">import</span> <span class="n">GridSpec</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">gspec</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="n">width_ratios</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="n">ax_phbands</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">ax_doses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax_phbands</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>
            <span class="n">ax_doses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

        <span class="c1"># Plot phonon bands with markers.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="n">ylims</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_phbands</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Plot a2F(w)</span>
        <span class="n">a2f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_a2f_qsamp</span><span class="p">(</span><span class="n">qsamp</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">ax_doses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">a2f</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="n">ylims</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">with_lambda</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
        <span class="c1">#ax.yaxis.set_label_position(&quot;right&quot;)</span>
        <span class="c1">#ax.tick_params(labelbottom=&#39;off&#39;)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Plot a2Ftr(w)</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_a2ftr</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">ax_doses</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
            <span class="n">a2ftr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_a2ftr_qsamp</span><span class="p">(</span><span class="n">qsamp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a2ftr</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="n">ylims</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
            <span class="c1">#ax.yaxis.set_label_position(&quot;right&quot;)</span>
            <span class="c1">#ax.tick_params(labelbottom=&#39;off&#39;)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">ix</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Plot DOS g(w)</span>
        <span class="k">if</span> <span class="n">phdos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">ax_doses</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
            <span class="n">phdos</span><span class="o">.</span><span class="n">plot_dos_idos</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
            <span class="c1">#ax.yaxis.set_label_position(&quot;right&quot;)</span>
            <span class="c1">#ax.tick_params(labelbottom=&#39;off&#39;)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$F(\omega)$&quot;</span><span class="p">)</span>
            <span class="c1">#ax.set_ylabel(&quot;&quot;)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="EphFile.write_notebook"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.EphFile.write_notebook">[docs]</a>    <span class="k">def</span> <span class="nf">write_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write an ipython notebook to nbpath. If nbpath is None, a temporay file in the current</span>
<span class="sd">        working directory is created. Return path to the notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbformat</span><span class="p">,</span> <span class="n">nbv</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nbformat_nbv_nb</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;ncfile = abilab.abiopen(&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;print(ncfile)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;ncfile.ebands.plot();&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;ncfile.plot();&quot;</span><span class="p">),</span>
            <span class="c1">#nbv.new_code_cell(&quot;ncfile.plot_phlinewidths();&quot;),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;ncfile.plot_with_a2f();&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;ncfile.a2f.plot();&quot;</span><span class="p">),</span>
        <span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_a2ftr</span><span class="p">:</span>
            <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;ncfile.a2ftr.plot();&quot;</span><span class="p">),</span>
                <span class="c1">#nbv.new_code_cell(&quot;ncfile.plot_with_a2ftr();&quot;),</span>
            <span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_nb_nbpath</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nbpath</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="EphRobot"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.EphRobot">[docs]</a><span class="k">class</span> <span class="nc">EphRobot</span><span class="p">(</span><span class="n">Robot</span><span class="p">,</span> <span class="n">RobotWithEbands</span><span class="p">,</span> <span class="n">RobotWithPhbands</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This robot analyzes the results contained in multiple EPH.nc files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#TODO: Method to plot the convergence of DOS(e_F)</span>
    <span class="n">EXT</span> <span class="o">=</span> <span class="s2">&quot;EPH&quot;</span>

    <span class="n">linestyle_qsamp</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">qcoarse</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">qintp</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>

    <span class="n">all_qsamps</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;qcoarse&quot;</span><span class="p">,</span> <span class="s2">&quot;qintp&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="EphRobot.get_dataframe"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.EphRobot.get_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">get_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">abspath</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">with_geo</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">funcs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build and return a pandas dataframe with results</span>

<span class="sd">        Args:</span>
<span class="sd">            abspath: True if paths in index should be absolute. Default: Relative to getcwd().</span>
<span class="sd">            with_geo: True if structure info should be added to the dataframe</span>
<span class="sd">            funcs: Function or list of functions to execute to add more data to the DataFrame.</span>
<span class="sd">                Each function receives a :class:`EphFile` object and returns a tuple (key, value)</span>
<span class="sd">                where key is a string with the name of column and value is the value to be inserted.</span>

<span class="sd">        Return:</span>
<span class="sd">            pandas DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rows</span><span class="p">,</span> <span class="n">row_names</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">row_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">qsamp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_qsamps</span><span class="p">:</span>
                <span class="n">a2f</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">get_a2f_qsamp</span><span class="p">(</span><span class="n">qsamp</span><span class="p">)</span>
                <span class="n">d</span><span class="p">[</span><span class="s2">&quot;lambda_&quot;</span> <span class="o">+</span> <span class="n">qsamp</span><span class="p">]</span> <span class="o">=</span> <span class="n">a2f</span><span class="o">.</span><span class="n">lambda_iso</span>
                <span class="n">d</span><span class="p">[</span><span class="s2">&quot;omegalog_&quot;</span> <span class="o">+</span> <span class="n">qsamp</span><span class="p">]</span> <span class="o">=</span> <span class="n">a2f</span><span class="o">.</span><span class="n">omega_log</span>

                <span class="c1"># Add transport properties.</span>
                <span class="k">if</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">has_a2ftr</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">qsamp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_qsamps</span><span class="p">:</span>
                        <span class="n">a2ftr</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">get_a2ftr_qsamp</span><span class="p">(</span><span class="n">qsamp</span><span class="p">)</span>
                        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;lambdatr_avg_&quot;</span> <span class="o">+</span> <span class="n">qsamp</span><span class="p">]</span> <span class="o">=</span> <span class="n">a2f</span><span class="o">.</span><span class="n">lambda_tr</span>

            <span class="c1"># Add convergence parameters</span>
            <span class="c1">#d.update(ncfile.params)</span>

            <span class="c1"># Add info on structure.</span>
            <span class="k">if</span> <span class="n">with_geo</span><span class="p">:</span>
                <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ncfile</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">get_dict4pandas</span><span class="p">(</span><span class="n">with_spglib</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

            <span class="c1"># Execute functions.</span>
            <span class="k">if</span> <span class="n">funcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exec_funcs</span><span class="p">(</span><span class="n">funcs</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">))</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="n">row_names</span> <span class="o">=</span> <span class="n">row_names</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">abspath</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_relpaths</span><span class="p">(</span><span class="n">row_names</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">row_names</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span></div>

<div class="viewcode-block" id="EphRobot.plot_lambda_convergence"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.EphRobot.plot_lambda_convergence">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_lambda_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;lambda&quot;</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the convergence of the lambda(q, nu) parameters wrt to the `sortby` parameter.</span>

<span class="sd">        Args:</span>
<span class="sd">            what: `lambda` for eph strength, gamma for phonon linewidths.</span>
<span class="sd">            sortby: Define the convergence parameter, sort files and produce plot labels.</span>
<span class="sd">            Can be None, string or function.</span>
<span class="sd">                If None, no sorting is performed.</span>
<span class="sd">                If string, it&#39;s assumed that the ncfile has an attribute with the same name</span>
<span class="sd">                and `getattr` is invoked.</span>
<span class="sd">                If callable, the output of callable(ncfile) is used.</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>
<span class="sd">            cmap:</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="n">sortby</span><span class="p">)):</span>
            <span class="n">ncfile</span><span class="o">.</span><span class="n">plot_eph_strength</span><span class="p">(</span>
                    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                    <span class="n">what</span><span class="o">=</span><span class="n">what</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="n">ylims</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sortby_label</span><span class="p">(</span><span class="n">sortby</span><span class="p">,</span> <span class="n">param</span><span class="p">),</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)),</span>
                    <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="EphRobot.plot_a2f_convergence"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.EphRobot.plot_a2f_convergence">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_a2f_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">qsamps</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the convergence of the Eliashberg function wrt to the `sortby` parameter.</span>

<span class="sd">        Args:</span>
<span class="sd">            sortby: Define the convergence parameter, sort files and produce plot labels.</span>
<span class="sd">            Can be None, string or function.</span>
<span class="sd">                If None, no sorting is performed.</span>
<span class="sd">                If string, it&#39;s assumed that the ncfile has an attribute with the same name</span>
<span class="sd">                and `getattr` is invoked.</span>
<span class="sd">                If callable, the output of callable(ncfile) is used.</span>
<span class="sd">            qsamps:</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used.</span>
<span class="sd">            cmap: matplotlib color map.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qsamps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_qsamps</span> <span class="k">if</span> <span class="n">qsamps</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span> <span class="k">else</span> <span class="n">list_strings</span><span class="p">(</span><span class="n">qsamps</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="n">sortby</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">qsamp</span> <span class="ow">in</span> <span class="n">qsamps</span><span class="p">:</span>
                <span class="n">ncfile</span><span class="o">.</span><span class="n">get_a2f_qsamp</span><span class="p">(</span><span class="n">qsamp</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sortby_label</span><span class="p">(</span><span class="n">sortby</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">qsamp</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)),</span>
                    <span class="n">linestyle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linestyle_qsamp</span><span class="p">[</span><span class="n">qsamp</span><span class="p">],</span>
                    <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="c1">#@add_fig_kwargs</span>
    <span class="c1">#def plot_a2ftr_convergence(self, sortby=&quot;&quot;, qsamps=&quot;all&quot;, ax=None, xlims=None,</span>
    <span class="c1">#                           cmap=&quot;viridis&quot;, **kwargs):</span>
    <span class="c1">#    qsamps = self.all_qsamps if qsamps == &quot;all&quot; else list_strings(qsamps)</span>
    <span class="c1">#    ax, fig, plt = get_ax_fig_plt(ax=ax)</span>
    <span class="c1">#    cmap = plt.get_cmap(cmap)</span>
    <span class="c1">#    for i, (label, ncfile, param) in enumerate(self.sortby(sortby)):</span>
    <span class="c1">#        for qsamp in qsamps:</span>
    <span class="c1">#            ncfile.get_a2ftr_qsamp(qsamp).plot(</span>
    <span class="c1">#                    ax=ax=ax,</span>
    <span class="c1">#                    label=self.sortby_label(sortby, param),</span>
    <span class="c1">#                    color=cmap(i / len(self)),</span>
    <span class="c1">#                    show=False,</span>
    <span class="c1">#                    )</span>
    <span class="c1">#    set_axlims(ax, xlims, &quot;x&quot;)</span>
    <span class="c1">#    return fig</span>

<div class="viewcode-block" id="EphRobot.write_notebook"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.EphRobot.write_notebook">[docs]</a>    <span class="k">def</span> <span class="nf">write_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a jupyter notebook to nbpath. If nbpath is None, a temporay file in the current</span>
<span class="sd">        working directory is created. Return path to the notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbformat</span><span class="p">,</span> <span class="n">nbv</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nbformat_nbv_nb</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">[(</span><span class="n">l</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="c1">#nbv.new_markdown_cell(&quot;# This is a markdown cell&quot;),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;robot = abilab.EphRobot(*</span><span class="si">%s</span><span class="s2">)</span><span class="se">\n</span><span class="s2">robot.trim_paths()</span><span class="se">\n</span><span class="s2">robot&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">)),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;data = robot.get_dataframe()</span><span class="se">\n</span><span class="s2">data&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;robot.plot_lambda_convergence();&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;robot.plot_a2f_convergence();&quot;</span><span class="p">),</span>
        <span class="p">])</span>

        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">ncf</span><span class="o">.</span><span class="n">has_a2ftr</span> <span class="k">for</span> <span class="n">ncf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">):</span>
            <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;robot.plot_a2ftr_convergence();&quot;</span><span class="p">),</span>
            <span class="p">])</span>

        <span class="c1"># Mixins.</span>
        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_baserobot_code_cells</span><span class="p">())</span>
        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_ebands_code_cells</span><span class="p">())</span>
        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_phbands_code_cells</span><span class="p">())</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_nb_nbpath</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nbpath</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="EphReader"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.EphReader">[docs]</a><span class="k">class</span> <span class="nc">EphReader</span><span class="p">(</span><span class="n">ElectronsReader</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads data from EPH file and constructs objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="EphReader.read_edos"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.EphReader.read_edos">[docs]</a>    <span class="k">def</span> <span class="nf">read_edos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the ElectronDos used to compute EPH quantities.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;edos_mesh&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">Ha_to_eV</span>
        <span class="c1"># [nsppol+1, nw] arrays with TOT_DOS, Spin_up, Spin_down in a.u.</span>
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s2">&quot;edos_dos&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># Spin polarized. Extract up-down components.</span>
            <span class="n">spin_dos</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">Ha_to_eV</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Spin unpolarized. Extract Tot DOS</span>
            <span class="n">spin_dos</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">Ha_to_eV</span>

        <span class="c1">#spin_idos = self.read_variable(&quot;edos_idos&quot;)[1:, :] / units.Ha_to_eV</span>
        <span class="n">nelect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;number_of_electrons&quot;</span><span class="p">)</span>
        <span class="n">fermie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;fermi_energy&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">Ha_to_eV</span>
        <span class="k">return</span> <span class="n">ElectronDos</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">spin_dos</span><span class="p">,</span> <span class="n">nelect</span><span class="p">,</span> <span class="n">fermie</span><span class="o">=</span><span class="n">fermie</span><span class="p">)</span></div>

<div class="viewcode-block" id="EphReader.read_phbands_qpath"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.EphReader.read_phbands_qpath">[docs]</a>    <span class="k">def</span> <span class="nf">read_phbands_qpath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read and return :class:`PhononBands` computed along the path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_structure</span><span class="p">()</span>

        <span class="c1"># Build the list of q-points</span>
        <span class="n">qpoints</span> <span class="o">=</span> <span class="n">Kpath</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">,</span>
                        <span class="n">frac_coords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;qpath&quot;</span><span class="p">),</span>
                        <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ksampling</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1">#nctkarr_t(&#39;phfreq_qpath&#39;, &quot;dp&quot;, &quot;natom3, nqpath&quot;),&amp;</span>
        <span class="n">phfreqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;phfreq_qpath&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">Ha_to_eV</span>
        <span class="n">phdispl_cart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;phdispl_cart_qpath&quot;</span><span class="p">,</span> <span class="n">cmode</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">bohr_to_ang</span>

        <span class="n">amu_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;atomic_mass_units&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">amu_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">atom_species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;atomic_numbers&quot;</span><span class="p">)</span>
            <span class="n">amu</span> <span class="o">=</span> <span class="p">{</span><span class="n">at</span><span class="p">:</span> <span class="n">a</span> <span class="k">for</span> <span class="n">at</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">atom_species</span><span class="p">,</span> <span class="n">amu_list</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;atomic_mass_units is not present!&quot;</span><span class="p">)</span>
            <span class="n">amu</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">PhononBands</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span>
                           <span class="n">qpoints</span><span class="o">=</span><span class="n">qpoints</span><span class="p">,</span>
                           <span class="n">phfreqs</span><span class="o">=</span><span class="n">phfreqs</span><span class="p">,</span>
                           <span class="n">phdispl_cart</span><span class="o">=</span><span class="n">phdispl_cart</span><span class="p">,</span>
                           <span class="n">non_anal_ph</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">amu</span><span class="o">=</span><span class="n">amu</span><span class="p">,</span>
                           <span class="p">)</span></div>

<div class="viewcode-block" id="EphReader.read_phlambda_qpath"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.EphReader.read_phlambda_qpath">[docs]</a>    <span class="k">def</span> <span class="nf">read_phlambda_qpath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads the EPH coupling strength *interpolated* along the q-path.</span>
<span class="sd">        Shape [nsppol, nqpath, natom3]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;phlambda_qpath&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="EphReader.read_phgamma_qpath"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.EphReader.read_phgamma_qpath">[docs]</a>    <span class="k">def</span> <span class="nf">read_phgamma_qpath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads the phonon linewidths *interpolated* along the q-path.</span>
<span class="sd">        Return results in eV</span>
<span class="sd">        Shape [nsppol, nqpath, natom3]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;phgamma_qpath&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">Ha_to_eV</span></div>

<div class="viewcode-block" id="EphReader.read_a2f"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.eph.EphReader.read_a2f">[docs]</a>    <span class="k">def</span> <span class="nf">read_a2f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qsamp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read and return the Eliashberg function a2F(w).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">qsamp</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;qcoarse&quot;</span><span class="p">,</span> <span class="s2">&quot;qintp&quot;</span><span class="p">)</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;a2f_mesh_&quot;</span> <span class="o">+</span> <span class="n">qsamp</span><span class="p">)</span>  <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">Ha_to_eV</span>
        <span class="c1"># C shape [nsppol, natom + 1, nomega]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;a2f_values_&quot;</span> <span class="o">+</span> <span class="n">qsamp</span><span class="p">)</span> <span class="c1"># * 0.25</span>
        <span class="n">values_spin</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">values_spin_nu</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">A2f</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">values_spin</span><span class="p">,</span> <span class="n">values_spin_nu</span><span class="p">)</span></div></div>

    <span class="c1">#def read_a2ftr(self, qsamp):</span>
    <span class="c1">#    &quot;&quot;&quot;Read and return the Eliashberg transport spectral function a2F_tr(w, x, x&#39;).&quot;&quot;&quot;</span>
    <span class="c1">#    assert qsamp in (&quot;qcoarse&quot;, &quot;qintp&quot;)</span>
    <span class="c1">#    mesh = self.read_value(&quot;a2ftr_mesh_&quot; + qsamp) * units.Ha_to_eV</span>
    <span class="c1">#    # Transpose tensor components F --&gt; C</span>
    <span class="c1">#    vals_in = self.read_value(&quot;a2ftr_in_&quot; + qsamp)</span>
    <span class="c1">#    vals_out = self.read_value(&quot;a2ftr_out_&quot; + qsamp)</span>
    <span class="c1">#    return A2ftr(mesh=mesh, vals_in, vals_out)</span>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2017, The AbiPy group.<br/>
      Last updated on Dec 13, 2017.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.5.<br/>
    </p>
  </div>
</footer>
  </body>
</html>