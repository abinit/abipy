

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>abipy.eph.sigeph &mdash; abipy 0.9.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/jupyter-sphinx.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/thebelab.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/my_style.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-dataframe.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-rendered-html.css" type="text/css" />

  
  

  
  

  

  
    <script type="text/javascript" src="https://cdn.plot.ly/plotly-latest.min.js"></script> 
    
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/thebelab-helper.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> abipy
          

          
          </a>

          
            
            
              <div class="version">
                0.9.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../features.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Getting AbiPy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../zzbiblio.html">Bibliography</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../scripts/index.html">Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../graphical_interface.html">Graphical interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gallery/index.html">AbiPy Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../postprocessing_howto.html">Post-processing How-To</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../workflows/taskmanager.html">TaskManager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../workflows/manager_examples.html">Manager Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../flow_gallery/index.html">Flow Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../flows_howto.html">Flows How-To</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../coding_guide.html">Coding guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html">Documenting AbiPy</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">abipy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>abipy.eph.sigeph</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for abipy.eph.sigeph</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: utf-8</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains objects for postprocessing e-ph calculations</span>
<span class="sd">using the results stored in the SIGEPH.nc file.</span>

<span class="sd">For a theoretical introduction see :cite:`Giustino2017`</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">abipy.core.abinit_units</span> <span class="k">as</span> <span class="nn">abu</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>
<span class="kn">from</span> <span class="nn">monty.string</span> <span class="kn">import</span> <span class="n">marquee</span><span class="p">,</span> <span class="n">list_strings</span>
<span class="kn">from</span> <span class="nn">monty.functools</span> <span class="kn">import</span> <span class="n">lazy_property</span>
<span class="kn">from</span> <span class="nn">monty.termcolor</span> <span class="kn">import</span> <span class="n">cprint</span>
<span class="kn">from</span> <span class="nn">abipy.core.mixins</span> <span class="kn">import</span> <span class="n">AbinitNcFile</span><span class="p">,</span> <span class="n">Has_Structure</span><span class="p">,</span> <span class="n">Has_ElectronBands</span><span class="p">,</span> <span class="n">NotebookWriter</span>
<span class="kn">from</span> <span class="nn">abipy.core.kpoints</span> <span class="kn">import</span> <span class="n">Kpoint</span><span class="p">,</span> <span class="n">KpointList</span><span class="p">,</span> <span class="n">Kpath</span><span class="p">,</span> <span class="n">IrredZone</span><span class="p">,</span> <span class="n">has_timrev_from_kptopt</span><span class="p">,</span> <span class="n">find_points_along_path</span>
<span class="kn">from</span> <span class="nn">abipy.tools.plotting</span> <span class="kn">import</span> <span class="p">(</span><span class="n">add_fig_kwargs</span><span class="p">,</span> <span class="n">get_ax_fig_plt</span><span class="p">,</span> <span class="n">get_axarray_fig_plt</span><span class="p">,</span> <span class="n">set_axlims</span><span class="p">,</span> <span class="n">set_visible</span><span class="p">,</span>
    <span class="n">rotate_ticklabels</span><span class="p">,</span> <span class="n">ax_append_title</span><span class="p">,</span> <span class="n">set_ax_xylabels</span><span class="p">,</span> <span class="n">linestyles</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">abipy.tools</span> <span class="kn">import</span> <span class="n">duck</span>
<span class="kn">from</span> <span class="nn">abipy.tools.numtools</span> <span class="kn">import</span> <span class="n">gaussian</span>
<span class="kn">from</span> <span class="nn">abipy.electrons.ebands</span> <span class="kn">import</span> <span class="n">ElectronBands</span><span class="p">,</span> <span class="n">ElectronDos</span><span class="p">,</span> <span class="n">RobotWithEbands</span><span class="p">,</span> <span class="n">ElectronBandsPlotter</span><span class="p">,</span> <span class="n">ElectronDosPlotter</span>
<span class="kn">from</span> <span class="nn">abipy.abio.robots</span> <span class="kn">import</span> <span class="n">Robot</span>
<span class="kn">from</span> <span class="nn">abipy.eph.common</span> <span class="kn">import</span> <span class="n">BaseEphReader</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;QpTempState&quot;</span><span class="p">,</span>
    <span class="s2">&quot;QpTempList&quot;</span><span class="p">,</span>
    <span class="s2">&quot;EphSelfEnergy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SigEPhFile&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SigEPhRobot&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TdepElectronBands&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SigmaPhReader&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># TODO QPState and QPList from electrons.gw (Define base abstract class?).</span>
<span class="c1"># __eq__ based on skb?</span>
<span class="c1"># broadening, adiabatic ??</span>


<div class="viewcode-block" id="QpTempState"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.QpTempState">[docs]</a><span class="k">class</span> <span class="nc">QpTempState</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;QpTempState&quot;</span><span class="p">,</span> <span class="s2">&quot;spin kpoint band tmesh e0 qpe ze0 fan0 dw qpe_oms&quot;</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Quasi-particle result for given (spin, kpoint, band).</span>

<span class="sd">    .. Attributes:</span>

<span class="sd">        spin: Spin index (C convention, i.e &gt;= 0)</span>
<span class="sd">        kpoint: |Kpoint| object.</span>
<span class="sd">        band: band index. Global index in the band structure. (C convention, i.e &gt;= 0).</span>
<span class="sd">        tmesh: Temperature mesh in Kelvin.</span>
<span class="sd">        e0: Initial KS energy.</span>
<span class="sd">        qpe: Quasiparticle energy (complex) computed with the linearized perturbative approach (Z factor).</span>
<span class="sd">        ze0: Renormalization factor Z computed at e = e0.</span>
<span class="sd">        fan0: Fan term (complex) evaluated at e_KS</span>
<span class="sd">        dw: Debye-Waller (static, real)</span>
<span class="sd">        qpe_oms: Quasiparticle energy (real) in the on-the-mass-shell approximation:</span>
<span class="sd">            qpe_oms = e0 + Sigma(e0)</span>

<span class="sd">    .. note::</span>

<span class="sd">        Energies are in eV.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="QpTempState.qpeme0"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.QpTempState.qpeme0">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">qpeme0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;E_QP[T] - E_0 (Real part)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qpe</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">e0</span><span class="p">)</span><span class="o">.</span><span class="n">real</span></div>

<div class="viewcode-block" id="QpTempState.re_qpe"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.QpTempState.re_qpe">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">re_qpe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Real part of the QP energy.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpe</span><span class="o">.</span><span class="n">real</span></div>

<div class="viewcode-block" id="QpTempState.imag_qpe"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.QpTempState.imag_qpe">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">imag_qpe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Imaginay part of the QP energy.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpe</span><span class="o">.</span><span class="n">imag</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">re_fan0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Real part of the Fan term at KS.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fan0</span><span class="o">.</span><span class="n">real</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">imag_fan0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Imaginary part of the Fan term at KS.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fan0</span><span class="o">.</span><span class="n">imag</span>

<div class="viewcode-block" id="QpTempState.re_sig0"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.QpTempState.re_sig0">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">re_sig0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Real part of the self-energy computed at the KS energy.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_fan0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dw</span></div>

<div class="viewcode-block" id="QpTempState.imag_sig0"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.QpTempState.imag_sig0">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">imag_sig0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Imaginary part of the self-energy computed at the KS energy.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">imag_fan0</span></div>

<div class="viewcode-block" id="QpTempState.skb"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.QpTempState.skb">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">skb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tuple with (spin, kpoint, band)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">band</span></div>

<div class="viewcode-block" id="QpTempState.get_fields"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.QpTempState.get_fields">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_fields</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">()):</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;qpeme0&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_repr_html_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Integration with jupyter_ notebooks.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">_repr_html_</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

<div class="viewcode-block" id="QpTempState.to_string"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.QpTempState.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        String representation with verbosity level ``verbose`` and optional ``title``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dataframe</span><span class="p">())</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">marquee</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">),</span> <span class="n">s</span><span class="p">])</span> <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">s</span></div>

<div class="viewcode-block" id="QpTempState.get_dataframe"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.QpTempState.get_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">get_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_spin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build pandas dataframe with QP results</span>

<span class="sd">        Args:</span>
<span class="sd">            index: dataframe index.</span>
<span class="sd">            with_spin: False if spin index is not wanted.</span>
<span class="sd">            params: Optional (Ordered) dictionary with extra parameters.</span>

<span class="sd">        Return: |pandas-DataFrame|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO Add more entries (tau?)</span>
        <span class="n">od</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="s2">&quot;band e0 re_qpe qpeme0 re_sig0 imag_sig0 ze0 re_fan0 dw tmesh&quot;</span>
        <span class="k">if</span> <span class="n">with_spin</span><span class="p">:</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="s2">&quot;spin &quot;</span> <span class="o">+</span> <span class="n">tokens</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">tokens</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;e0&quot;</span><span class="p">,</span> <span class="s2">&quot;spin&quot;</span><span class="p">,</span> <span class="s2">&quot;kpoint&quot;</span><span class="p">,</span> <span class="s2">&quot;band&quot;</span><span class="p">):</span>
                <span class="c1"># This quantities do not depend on temp.</span>
                <span class="n">od</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO</span>
                <span class="c1">#if k == &quot;tmesh&quot;:</span>
                <span class="c1">#    od[&quot;T&quot;] = getattr(self, k)</span>
                <span class="c1">#else:</span>
                <span class="n">od</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">od</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">od</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span></div>

<div class="viewcode-block" id="QpTempState.get_fields_for_plot"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.QpTempState.get_fields_for_plot">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_fields_for_plot</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">vs</span><span class="p">,</span> <span class="n">with_fields</span><span class="p">,</span> <span class="n">exclude_fields</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return list of QpTempState fields to plot from input arguments.</span>

<span class="sd">        Args:</span>
<span class="sd">            vs in [&quot;temp&quot;, &quot;e0&quot;]</span>
<span class="sd">            with_fields:</span>
<span class="sd">            exclude_fields:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">vs</span> <span class="o">==</span> <span class="s2">&quot;temp&quot;</span><span class="p">:</span>
            <span class="n">all_fields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;spin&quot;</span><span class="p">,</span> <span class="s2">&quot;kpoint&quot;</span><span class="p">,</span> <span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="s2">&quot;e0&quot;</span><span class="p">,</span> <span class="s2">&quot;tmesh&quot;</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">vs</span> <span class="o">==</span> <span class="s2">&quot;e0&quot;</span><span class="p">:</span>
            <span class="n">all_fields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;spin&quot;</span><span class="p">,</span> <span class="s2">&quot;kpoint&quot;</span><span class="p">,</span> <span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="s2">&quot;e0&quot;</span><span class="p">,</span> <span class="s2">&quot;tmesh&quot;</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid vs: `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">vs</span><span class="p">))</span>

        <span class="c1"># Initialize fields.</span>
        <span class="k">if</span> <span class="n">duck</span><span class="o">.</span><span class="n">is_string</span><span class="p">(</span><span class="n">with_fields</span><span class="p">)</span> <span class="ow">and</span> <span class="n">with_fields</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">all_fields</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">list_strings</span><span class="p">(</span><span class="n">with_fields</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_fields</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Field </span><span class="si">%s</span><span class="s2"> not in allowed values </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">all_fields</span><span class="p">)))</span>

        <span class="c1"># Remove entries</span>
        <span class="k">if</span> <span class="n">exclude_fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">duck</span><span class="o">.</span><span class="n">is_string</span><span class="p">(</span><span class="n">exclude_fields</span><span class="p">):</span>
                <span class="n">exclude_fields</span> <span class="o">=</span> <span class="n">exclude_fields</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">exclude_fields</span><span class="p">:</span>
                <span class="n">fields</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fields</span></div>

<div class="viewcode-block" id="QpTempState.plot"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.QpTempState.plot">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_fields</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">exclude_fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the QP results as function of temperature.</span>

<span class="sd">        Args:</span>
<span class="sd">            with_fields: The names of the QpTempState attributes to plot as function of e0.</span>
<span class="sd">                Accepts: List of strings or string with tokens separated by blanks.</span>
<span class="sd">                See :class:`QpTempState` for the list of available fields.</span>
<span class="sd">            exclude_fields: Similar to `with_field` but excludes fields.</span>
<span class="sd">            ax_list: List of matplotlib axes for plot. If None, new figure is produced.</span>
<span class="sd">            label: Label for plot.</span>
<span class="sd">            fontsize: Fontsize for legend and title.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fields_for_plot</span><span class="p">(</span><span class="s2">&quot;temp&quot;</span><span class="p">,</span> <span class="n">with_fields</span><span class="p">,</span> <span class="n">exclude_fields</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fields</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>

        <span class="n">num_plots</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">nrows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">num_plots</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_plots</span> <span class="o">//</span> <span class="n">ncols</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_plots</span> <span class="o">%</span> <span class="n">ncols</span><span class="p">)</span>

        <span class="c1"># Build plot grid.</span>
        <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="n">ax_list</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                                <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax_list</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="n">linestyle</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;linestyle&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
        <span class="c1">#kw_color = kwargs.pop(&quot;color&quot;, None)</span>
        <span class="c1">#kw_label = kwargs.pop(&quot;label&quot;, None)</span>
        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">ax_list</span><span class="p">)):</span>
            <span class="n">irow</span><span class="p">,</span> <span class="n">icol</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">ncols</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">irow</span> <span class="o">==</span> <span class="n">nrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Temperature [K]&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="n">yy</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
            <span class="n">lbl</span> <span class="o">=</span> <span class="n">label</span> <span class="k">if</span> <span class="n">ix</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="c1"># Handle complex arrays</span>
            <span class="c1">#if np.iscomplexobj(yy):</span>
            <span class="c1">#    ax.plot(self.tmesh, yy.real, linestyle, label=lbl, **kwargs)</span>
            <span class="c1">#    ax.plot(self.tmesh, yy.imag, linestyle, label=lbl, **kwargs)</span>
            <span class="c1">#else:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span><span class="p">,</span> <span class="n">yy</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">linestyle</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">lbl</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Get around a bug in matplotlib</span>
        <span class="k">if</span> <span class="n">num_plots</span> <span class="o">%</span> <span class="n">ncols</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ax_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lbl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1">#fig.tight_layout()</span>
        <span class="k">return</span> <span class="n">fig</span></div></div>


<div class="viewcode-block" id="QpTempList"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.QpTempList">[docs]</a><span class="k">class</span> <span class="nc">QpTempList</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A list of quasiparticle corrections (usually for a given spin).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_e0sorted</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_e0sorted&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tmesh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Temperature mesh in Kelvin.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tmesh</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ntemp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of temperatures.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">%s</span><span class="s2"> at </span><span class="si">%s</span><span class="s2">, len=</span><span class="si">%d</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

<div class="viewcode-block" id="QpTempList.to_string"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.QpTempList.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
        <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="s2">&quot;QpTempList&quot;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;nqps: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;ntemps: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

    <span class="c1">#def copy(self):</span>
    <span class="c1">#    &quot;&quot;&quot;Copy of self.&quot;&quot;&quot;</span>
    <span class="c1">#    return self.__class__([qp.copy() for qp in self], is_e0sorted=self.is_e0sorted)</span>

<div class="viewcode-block" id="QpTempList.sort_by_e0"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.QpTempList.sort_by_e0">[docs]</a>    <span class="k">def</span> <span class="nf">sort_by_e0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a new :class:`QpTempList` object with the E0 energies sorted in ascending order.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">qp</span><span class="p">:</span> <span class="n">qp</span><span class="o">.</span><span class="n">e0</span><span class="p">),</span> <span class="n">is_e0sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="QpTempList.get_e0mesh"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.QpTempList.get_e0mesh">[docs]</a>    <span class="k">def</span> <span class="nf">get_e0mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the E0 energies.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_e0sorted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;QPState corrections are not sorted. Use sort_by_e0&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">qp</span><span class="o">.</span><span class="n">e0</span> <span class="k">for</span> <span class="n">qp</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">])</span></div>

<div class="viewcode-block" id="QpTempList.get_field_itemp"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.QpTempList.get_field_itemp">[docs]</a>    <span class="k">def</span> <span class="nf">get_field_itemp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">itemp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;|numpy-array| containing the values of field at temperature ``itemp``&quot;&quot;&quot;</span>
        <span class="c1">#return np.array([getattr(qp, field)[itemp] for qp in self])</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;tmesh&quot;</span><span class="p">,</span> <span class="s2">&quot;qpe&quot;</span><span class="p">,</span> <span class="s2">&quot;ze0&quot;</span><span class="p">,</span> <span class="s2">&quot;fan0&quot;</span><span class="p">,</span> <span class="s2">&quot;dw&quot;</span><span class="p">,</span> <span class="s2">&quot;qpe_oms&quot;</span><span class="p">}:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">field</span><span class="p">)[</span><span class="n">itemp</span><span class="p">]</span> <span class="k">for</span> <span class="n">qp</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">qp</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">])</span></div>

    <span class="c1">#def get_skb_field(self, skb, field):</span>
    <span class="c1">#    &quot;&quot;&quot;Return the value of field for the given spin kp band tuple, None if not found&quot;&quot;&quot;</span>
    <span class="c1">#    for qp in self:</span>
    <span class="c1">#        if qp.skb == skb:</span>
    <span class="c1">#            return getattr(qp, field)</span>
    <span class="c1">#    return None</span>

    <span class="c1">#def get_qpenes(self):</span>
    <span class="c1">#    &quot;&quot;&quot;Return an array with the :class:`QPState` energies.&quot;&quot;&quot;</span>
    <span class="c1">#    return self.get_field(&quot;qpe&quot;)</span>

    <span class="c1">#def get_qpeme0(self):</span>
    <span class="c1">#    &quot;&quot;&quot;Return an arrays with the :class:`QPState` corrections.&quot;&quot;&quot;</span>
    <span class="c1">#    return self.get_field(&quot;qpeme0&quot;)</span>

<div class="viewcode-block" id="QpTempList.merge"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.QpTempList.merge">[docs]</a>    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merge self with other. Return new :class:`QpTempList` object</span>

<span class="sd">        Raise: `ValueError` if merge cannot be done.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">skb0_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">qp</span><span class="o">.</span><span class="n">skb</span> <span class="k">for</span> <span class="n">qp</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">qp</span> <span class="ow">in</span> <span class="n">other</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">qp</span><span class="o">.</span><span class="n">skb</span> <span class="ow">in</span> <span class="n">skb0_list</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Found duplicated (s,b,k) indexes: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">qp</span><span class="o">.</span><span class="n">skb</span><span class="p">))</span>

        <span class="c1"># Test on tmesh?</span>
        <span class="c1"># TODO Why copy?</span>
        <span class="n">qps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">copy</span> <span class="k">else</span> <span class="bp">self</span> <span class="o">+</span> <span class="n">other</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">qps</span><span class="p">)</span></div>

    <span class="c1"># TODO: Linewidths</span>
<div class="viewcode-block" id="QpTempList.plot_vs_e0"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.QpTempList.plot_vs_e0">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_vs_e0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">itemp_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_fields</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">reim</span><span class="o">=</span><span class="s2">&quot;real&quot;</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
                   <span class="n">exclude_fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fermie</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">,</span> <span class="n">ax_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot QP results as a function of the initial KS energy.</span>

<span class="sd">        Args:</span>
<span class="sd">            itemp_list: List of integers to select a particular temperature. None for all</span>
<span class="sd">            with_fields: The names of the QP attributes to plot as function of e0.</span>
<span class="sd">                Accepts: List of strings or string with tokens separated by blanks.</span>
<span class="sd">                See :class:`QPState` for the list of available fields.</span>
<span class="sd">            reim: Plot the real or imaginary part</span>
<span class="sd">            function: Apply a function to the results before plotting</span>
<span class="sd">            exclude_fields: Similar to `with_field` but excludes fields.</span>
<span class="sd">            fermie: Value of the Fermi level used in plot. None for absolute e0s.</span>
<span class="sd">            colormap: matplotlib color map.</span>
<span class="sd">            ax_list: List of |matplotlib-Axes| for plot. If None, new figure is produced.</span>
<span class="sd">            xlims, ylims: Set the data limits for the x-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                   or scalar e.g. ``left``. If left (right) is None, default values are used.</span>
<span class="sd">            exchange_xy: True to exchange x-y axis.</span>
<span class="sd">            fontsize: Legend and title fontsize.</span>
<span class="sd">            kwargs: linestyle, color, label, marker</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">QpTempState</span><span class="o">.</span><span class="n">get_fields_for_plot</span><span class="p">(</span><span class="s2">&quot;e0&quot;</span><span class="p">,</span> <span class="n">with_fields</span><span class="p">,</span> <span class="n">exclude_fields</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fields</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">reim</span> <span class="o">==</span> <span class="s2">&quot;real&quot;</span><span class="p">:</span> <span class="n">ylabel_mask</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$\Re(</span><span class="si">%s</span><span class="s2">)$&quot;</span>
        <span class="k">elif</span> <span class="n">reim</span> <span class="o">==</span> <span class="s2">&quot;imag&quot;</span><span class="p">:</span> <span class="n">ylabel_mask</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$\Im(</span><span class="si">%s</span><span class="s2">)$&quot;</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid option for reim, should be &#39;real&#39; or &#39;imag&#39;&quot;</span><span class="p">)</span>

        <span class="n">num_plots</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">nrows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">num_plots</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_plots</span> <span class="o">//</span> <span class="n">ncols</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_plots</span> <span class="o">%</span> <span class="n">ncols</span><span class="p">)</span>

        <span class="c1"># Build plot grid.</span>
        <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="n">ax_list</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                                <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax_list</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>

        <span class="c1"># Get QpTempList and sort it.</span>
        <span class="n">qps</span> <span class="o">=</span> <span class="bp">self</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_e0sorted</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_by_e0</span><span class="p">()</span>
        <span class="n">e0mesh</span> <span class="o">=</span> <span class="n">qps</span><span class="o">.</span><span class="n">get_e0mesh</span><span class="p">()</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$\epsilon_</span><span class="si">{KS}</span><span class="s2">\;(eV)$&quot;</span>
        <span class="k">if</span> <span class="n">fermie</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">e0mesh</span> <span class="o">-=</span> <span class="n">fermie</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$\epsilon_</span><span class="si">{KS}</span><span class="s2">-\epsilon_F\;(eV)$&quot;</span>

        <span class="n">kw_linestyle</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;linestyle&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
        <span class="n">kw_color</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kw_label</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">itemp_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span><span class="p">))</span> <span class="k">if</span> <span class="n">itemp_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">duck</span><span class="o">.</span><span class="n">list_ints</span><span class="p">(</span><span class="n">itemp_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">ax_list</span><span class="p">)):</span>
            <span class="n">irow</span><span class="p">,</span> <span class="n">icol</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">ncols</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">irow</span> <span class="o">==</span> <span class="n">nrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">exchange_xy</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">exchange_xy</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel_mask</span> <span class="o">%</span> <span class="n">field</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">ylabel_mask</span> <span class="o">%</span> <span class="n">field</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

            <span class="n">has_legend</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Plot different temperatures.</span>
            <span class="k">for</span> <span class="n">itemp</span> <span class="ow">in</span> <span class="n">itemp_list</span><span class="p">:</span>
                <span class="n">yt</span> <span class="o">=</span> <span class="n">qps</span><span class="o">.</span><span class="n">get_field_itemp</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">itemp</span><span class="p">)</span>
                <span class="n">yt_reim</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span> <span class="n">reim</span><span class="p">)</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">kw_label</span>
                <span class="k">if</span> <span class="n">kw_label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;T = </span><span class="si">%.1f</span><span class="s2"> K&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span> <span class="k">if</span> <span class="n">ix</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">has_legend</span> <span class="o">=</span> <span class="n">has_legend</span> <span class="ow">or</span> <span class="nb">bool</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="n">xs</span> <span class="o">=</span> <span class="n">e0mesh</span>
                <span class="n">ys</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">yt_reim</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">ys</span><span class="p">,</span> <span class="n">xs</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">kw_linestyle</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">itemp</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span><span class="p">)</span> <span class="k">if</span> <span class="n">kw_color</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">kw_color</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
            <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ix</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">has_legend</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Get around a bug in matplotlib</span>
        <span class="k">if</span> <span class="n">num_plots</span> <span class="o">%</span> <span class="n">ncols</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ax_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div></div>


<div class="viewcode-block" id="EphSelfEnergy"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.EphSelfEnergy">[docs]</a><span class="k">class</span> <span class="nc">EphSelfEnergy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Electron self-energy due to phonon interaction :math:`\Sigma_{nk}(\omega,T)`</span>
<span class="sd">    Actually this object stores the diagonal matrix elements in the KS basis set.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Symbols used in matplotlib plots.</span>
    <span class="n">latex_symbol</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">re</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\Re{\Sigma(\omega)}$&quot;</span><span class="p">,</span>
        <span class="n">im</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\Im{\Sigma(\omega)}$&quot;</span><span class="p">,</span>
        <span class="n">spfunc</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$A(\omega)}$&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wmesh</span><span class="p">,</span> <span class="n">qp</span><span class="p">,</span> <span class="n">vals_e0ks</span><span class="p">,</span> <span class="n">dvals_de0ks</span><span class="p">,</span> <span class="n">dw_vals</span><span class="p">,</span> <span class="n">vals_wr</span><span class="p">,</span> <span class="n">spfunc_wr</span><span class="p">,</span>
                 <span class="n">frohl_vals_e0ks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">frohl_dvals_de0ks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">frohl_spfunc_wr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            wmesh: Frequency mesh in eV.</span>
<span class="sd">            qp: :class:`QpTempState` instance.</span>
<span class="sd">            vals_e0ks: complex [ntemp] array with Sigma_eph(omega=eKS, kT)</span>
<span class="sd">            dvals_de0ks: complex [ntemp] arrays with derivative d Sigma_eph(omega, kT) / d omega (omega=eKS)</span>
<span class="sd">            dw_vals: [ntemp] array with Debye-Waller term (static)</span>
<span class="sd">            vals_wr: [ntemp, nwr] complex array with Sigma_eph(omega, kT). enk_KS corresponds to nwr//2 + 1.</span>
<span class="sd">            spfunc_wr: [ntemp, nwr] real array with spectral function.</span>
<span class="sd">            frohl_vals_e0ks, frohl_dvals_de0ks, frohl_spfunc_wr: Contribution to the eph self-energy</span>
<span class="sd">                computed with the Frohlich model for gkq (optional).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qp</span> <span class="o">=</span> <span class="n">qp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">band</span> <span class="o">=</span> <span class="n">qp</span><span class="o">.</span><span class="n">spin</span><span class="p">,</span> <span class="n">qp</span><span class="o">.</span><span class="n">kpoint</span><span class="p">,</span> <span class="n">qp</span><span class="o">.</span><span class="n">band</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wmesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span> <span class="o">=</span> <span class="n">wmesh</span><span class="p">,</span> <span class="n">qp</span><span class="o">.</span><span class="n">tmesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nwr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wmesh</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span><span class="p">)</span>

        <span class="c1"># Get refs to values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vals_e0ks</span> <span class="o">=</span> <span class="n">vals_e0ks</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">vals_e0ks</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span><span class="p">,)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dvals_de0ks</span> <span class="o">=</span> <span class="n">dvals_de0ks</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dvals_de0ks</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span><span class="p">,)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dw_vals</span> <span class="o">=</span> <span class="n">dw_vals</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dw_vals</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span><span class="p">,)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vals_wr</span> <span class="o">=</span> <span class="n">vals_wr</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">vals_wr</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spfunc_wr</span> <span class="o">=</span> <span class="n">spfunc_wr</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">spfunc_wr</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwr</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">frohl_vals_e0ks</span> <span class="o">=</span> <span class="n">frohl_vals_e0ks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frohl_dvals_de0ks</span> <span class="o">=</span> <span class="n">frohl_dvals_de0ks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frohl_spfunc_wr</span> <span class="o">=</span> <span class="n">frohl_spfunc_wr</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

<div class="viewcode-block" id="EphSelfEnergy.to_string"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.EphSelfEnergy.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;K-point: </span><span class="si">%s</span><span class="s2">, band: </span><span class="si">%d</span><span class="s2">, spin: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoint</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Number of temperatures: </span><span class="si">%d</span><span class="s2">, from </span><span class="si">%.1f</span><span class="s2"> to </span><span class="si">%.1f</span><span class="s2"> (K)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Number of frequencies: </span><span class="si">%d</span><span class="s2">, from </span><span class="si">%.1f</span><span class="s2"> to </span><span class="si">%.1f</span><span class="s2"> (eV)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wmesh</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">wmesh</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frohl_vals_e0ks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Contains contribution given by Frohlich term.&quot;</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qp</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;QP data&quot;</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_wmesh_xlabel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zero_energy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return (wmesh, xlabel) from zero_energy input argument.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">zero_energy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wmesh</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$\omega\;(eV)$&quot;</span>
        <span class="k">elif</span> <span class="n">zero_energy</span> <span class="o">==</span> <span class="s2">&quot;e0&quot;</span><span class="p">:</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wmesh</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">qp</span><span class="o">.</span><span class="n">e0</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$\omega - \epsilon^0\;(eV)$&quot;</span>
        <span class="c1"># TODO: chemical potential? but then I have mu(T) to handle in plots!</span>
        <span class="c1">#elif zero_energy == &quot;fermie&quot;:</span>
        <span class="c1">#    xx = self.wmesh - self.fermie</span>
        <span class="c1">#    xlabel = r&quot;$\omega\;(eV)$&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid value of zero_energy: `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">zero_energy</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">xx</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">xlabel</span>

    <span class="k">def</span> <span class="nf">_get_ys_itemp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">itemp</span><span class="p">,</span> <span class="n">select_frohl</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return array(T) to plot from what and itemp index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">select_frohl</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">re</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vals_wr</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">,</span>
                <span class="n">im</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vals_wr</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span>
                <span class="n">spfunc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spfunc_wr</span><span class="p">[</span><span class="n">itemp</span><span class="p">],</span>
            <span class="p">)[</span><span class="n">what</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">re</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frohl_vals_wr</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">,</span>
                <span class="n">im</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frohl_vals_wr</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span>
                <span class="n">spfunc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frohl_spfunc_wr</span><span class="p">[</span><span class="n">itemp</span><span class="p">],</span>
            <span class="p">)[</span><span class="n">what</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_itemps_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">itemps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of temperature indices and labels from itemps.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">duck</span><span class="o">.</span><span class="n">is_string</span><span class="p">(</span><span class="n">itemps</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">itemps</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                <span class="n">itemps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid value for itemps: `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">itemps</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">itemps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">itemps</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">itemps</span> <span class="o">=</span> <span class="p">[</span><span class="n">itemps</span><span class="p">]</span> <span class="k">if</span> <span class="n">itemps</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">itemps</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span> <span class="o">&gt;</span> <span class="n">it</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">itemps</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid list of temperature indices. ntemp is </span><span class="si">%d</span><span class="s2">, received itemps:</span><span class="se">\n\t</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">itemps</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">itemps</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;T=</span><span class="si">%.1f</span><span class="s2"> K&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">itemps</span><span class="p">]</span>

<div class="viewcode-block" id="EphSelfEnergy.plot_tdep"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.EphSelfEnergy.plot_tdep">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_tdep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">itemps</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">zero_energy</span><span class="o">=</span><span class="s2">&quot;e0&quot;</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">,</span> <span class="n">ax_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">what_list</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;re&quot;</span><span class="p">,</span> <span class="s2">&quot;im&quot;</span><span class="p">,</span> <span class="s2">&quot;spfunc&quot;</span><span class="p">),</span> <span class="n">with_frohl</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the real/imaginary part of self-energy as well as the spectral function for</span>
<span class="sd">        the different temperatures with a colormap.</span>

<span class="sd">        Args:</span>
<span class="sd">            itemps: List of temperature indices. &quot;all&quot; to plot&#39;em all.</span>
<span class="sd">            zero_energy:</span>
<span class="sd">            colormap: matplotlib color map.</span>
<span class="sd">            ax_list: List of |matplotlib-Axes|. If None, new figure is produced.</span>
<span class="sd">            what_list: List of strings selecting the quantity to plot.</span>
<span class="sd">                &quot;re&quot; for real part, &quot;im&quot; for imaginary part, &quot;spfunc&quot; for spectral function A(omega).</span>
<span class="sd">            with_frohl: Visualize Frohlich contribution (if present).</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                or scalar e.g. ``left``. If left (right) is None, default values are used.</span>
<span class="sd">            fontsize: legend and label fontsize.</span>
<span class="sd">            kwargs: Keyword arguments passed to ax.plot</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># FIXME zero_energy or e0?</span>
        <span class="n">what_list</span> <span class="o">=</span> <span class="n">list_strings</span><span class="p">(</span><span class="n">what_list</span><span class="p">)</span>
        <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="n">ax_list</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">what_list</span><span class="p">),</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>
        <span class="n">xs</span><span class="p">,</span> <span class="n">xlabel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_wmesh_xlabel</span><span class="p">(</span><span class="n">zero_energy</span><span class="p">)</span>

        <span class="n">itemps</span><span class="p">,</span> <span class="n">tlabels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_itemps_labels</span><span class="p">(</span><span class="n">itemps</span><span class="p">)</span>
        <span class="n">kw_color</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kw_label</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">what_list</span><span class="p">,</span> <span class="n">ax_list</span><span class="p">)):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latex_symbol</span><span class="p">[</span><span class="n">what</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ix</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">itemp</span> <span class="ow">in</span> <span class="n">itemps</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ys_itemp</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="n">itemp</span><span class="p">),</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">itemp</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span><span class="p">)</span> <span class="k">if</span> <span class="n">kw_color</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">kw_color</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="n">tlabels</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">ix</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">kw_label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">kw_label</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">with_frohl</span><span class="p">:</span>
                    <span class="c1"># Add Frohlich contribution.</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ys_itemp</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="n">itemp</span><span class="p">,</span> <span class="n">select_frohl</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                            <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">itemp</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span><span class="p">)</span> <span class="k">if</span> <span class="n">kw_color</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">kw_color</span><span class="p">,</span>
                            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Frohlich&quot;</span><span class="p">,</span>
                            <span class="c1">#label=tlabels[itemp] if (ix == 0 and kw_label is None) else kw_label,</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="n">ix</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;title&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;K-point: </span><span class="si">%s</span><span class="s2">, band: </span><span class="si">%d</span><span class="s2">, spin: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoint</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="c1"># Alias for plot_tdep</span>
    <span class="n">plot</span> <span class="o">=</span> <span class="n">plot_tdep</span>

<div class="viewcode-block" id="EphSelfEnergy.plot_qpsolution"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.EphSelfEnergy.plot_qpsolution">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_qpsolution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">itemp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">with_int_aw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Graphical representation of the QP solution(s) along the real axis including the</span>
<span class="sd">        approximated solution obtained with the linearized equation and the on-the-mass-shell approach.</span>

<span class="sd">        Produce two subplots:</span>
<span class="sd">            1. Re/Imag part and intersection with omega - eKs</span>
<span class="sd">            2. A(w) + int^w A(w&#39;)dw&#39; + OTMS</span>

<span class="sd">        Args:</span>
<span class="sd">            itemp: Temperature index.</span>
<span class="sd">            ax_list: List of |matplotlib-Axes|. If None, new figure is produced.</span>
<span class="sd">            with_int_aw: Plot cumulative integral of A(w).</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                or scalar e.g. ``left``. If left (right) is None, default values are used.</span>
<span class="sd">            fontsize: legend and label fontsize.</span>
<span class="sd">            kwargs: Keyword arguments passed to ax.plot</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="n">ax_list</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">xs</span><span class="p">,</span> <span class="n">xlabel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_wmesh_xlabel</span><span class="p">(</span><span class="s2">&quot;e0&quot;</span><span class="p">)</span>
        <span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">ax_list</span>

        <span class="c1"># Plot Sigma(w)</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vals_wr</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\Re(\Sigma)$&quot;</span><span class="p">)</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vals_wr</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\Im(\Sigma)$&quot;</span><span class="p">)</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wmesh</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">qp</span><span class="o">.</span><span class="n">e0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">ls</span><span class="o">=</span><span class="n">linestyles</span><span class="p">[</span><span class="s2">&quot;dashed&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\omega - \epsilon^0$&quot;</span><span class="p">)</span>

        <span class="c1"># Add linearized solution</span>
        <span class="n">sig0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vals_wr</span><span class="p">[</span><span class="n">itemp</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">nwr</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">aa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dvals_de0ks</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span><span class="o">.</span><span class="n">real</span>
        <span class="n">ze0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qp</span><span class="o">.</span><span class="n">ze0</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span><span class="o">.</span><span class="n">real</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">sig0</span><span class="o">.</span><span class="n">real</span> <span class="o">+</span> <span class="n">aa</span> <span class="o">*</span> <span class="n">xs</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="n">linestyles</span><span class="p">[</span><span class="s2">&quot;densely_dotted&quot;</span><span class="p">],</span>
                 <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\Re(\Sigma^0) + \dfrac{\partial\Sigma}{\partial\omega}(\omega - \epsilon^0$)&quot;</span><span class="p">)</span>

        <span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qp</span><span class="o">.</span><span class="n">qpe</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span><span class="o">.</span><span class="n">real</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">qp</span><span class="o">.</span><span class="n">e0</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="n">sig0</span><span class="o">.</span><span class="n">real</span> <span class="o">+</span> <span class="n">aa</span> <span class="o">*</span> <span class="n">x0</span>
        <span class="n">scatter_opts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Linearized solution&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">scatter_opts</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$Z = </span><span class="si">%.2f</span><span class="s2">$&quot;</span> <span class="o">%</span> <span class="n">ze0</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="p">(</span><span class="n">x0</span> <span class="o">+</span> <span class="mf">0.02</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

        <span class="n">ax0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\Sigma(\omega - \epsilon^0)\,$(eV)&quot;</span><span class="p">)</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax0</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>

        <span class="n">ymin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vals_wr</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">vals_wr</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="n">ymin</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ymin</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.2</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vals_wr</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">vals_wr</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ymax</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.2</span>
        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax0</span><span class="p">,</span> <span class="p">[</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">],</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="c1"># Plot Dyson-Migdal A(w)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spfunc_wr</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">)</span>

        <span class="c1"># Plot Linearized A(w) (Z factor)</span>
        <span class="c1">#x0 = self.qp.qpe[itemp].real - self.qp.e0</span>
        <span class="c1">#ys = ze0 / np.pi * np.abs(sig0.imag) / ((xs - x0) ** 2 + sig0.imag ** 2)</span>
        <span class="c1">#ax1.plot(xs, ys)</span>

        <span class="c1"># Plot on mass shell energy as vertical line</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">sig0</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&quot;OTMS&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">sig0</span><span class="o">.</span><span class="n">real</span> <span class="o">+</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$A(\omega - \epsilon^0)\,$(1/eV)&quot;</span><span class="p">)</span>
        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">with_int_aw</span><span class="p">:</span>
            <span class="c1"># Instantiate a second axes that shares the same x-axis</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
            <span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">cumtrapz</span>
            <span class="n">integral</span> <span class="o">=</span> <span class="n">cumtrapz</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">xs</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">integral</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-.&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\int^{\omega - \epsilon^0} A(\omega&#39;)\,d\omega&#39;$&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
            <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax2</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;title&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;K-point: </span><span class="si">%s</span><span class="s2">, band: </span><span class="si">%d</span><span class="s2">, spin: </span><span class="si">%d</span><span class="s2">, T=</span><span class="si">%.1f</span><span class="s2"> K&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoint</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span><span class="p">[</span><span class="n">itemp</span><span class="p">])</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div></div>


<span class="k">class</span> <span class="nc">A2feph</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Eliashberg function :math:`\alpha^2F_{nk}(\omega)`</span>
<span class="sd">    obained within the adiabatic approximation (phonon freqs in Sigma are ignored)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Symbols used in matplotlib plots.</span>
    <span class="n">latex_symbol</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">gkq2</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$|g|^2$&quot;</span><span class="p">,</span>
        <span class="n">fan</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\alpha^2F_</span><span class="si">{FAN}</span><span class="s2">$&quot;</span><span class="p">,</span>
        <span class="n">dw</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\alpha^2F_</span><span class="si">{DW}</span><span class="s2">$&quot;</span><span class="p">,</span>
        <span class="n">tot</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\alpha^2F_</span><span class="si">{TOT}</span><span class="s2">$&quot;</span><span class="p">,</span>
        <span class="n">a2f</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\alpha^2F_{n{\bf</span><span class="si">{k}</span><span class="s2">}}(\omega)$&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">gkq2</span><span class="p">,</span> <span class="n">fan</span><span class="p">,</span> <span class="n">dw</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            mesh: Frequency mesh in eV</span>
<span class="sd">            gkq2:</span>
<span class="sd">            fan:</span>
<span class="sd">            dw:</span>
<span class="sd">            spin:</span>
<span class="sd">            kpoint:</span>
<span class="sd">            band:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gkq2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dw</span> <span class="o">=</span> <span class="n">gkq2</span><span class="p">,</span> <span class="n">fan</span><span class="p">,</span> <span class="n">dw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">band</span> <span class="o">=</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span>

    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;meV&quot;</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;fandw&quot;</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">with_ahc_zpr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the Eliashberg function.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: |matplotlib-Axes| or None if a new figure should be created.</span>
<span class="sd">            units: Units for phonon plots. Possible values in (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;). Case-insensitive.</span>
<span class="sd">            what=: fandw for FAN, DW. gkq2 for |gkq|^2</span>
<span class="sd">            exchange_xy: True to exchange x-y axis.</span>
<span class="sd">            with_ahc_zpr:</span>
<span class="sd">            fontsize: legend and title fontsize.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Read mesh in Ha and convert to units.</span>
        <span class="c1"># TODO: Convert yvalues</span>
        <span class="n">wmesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">phfactor_ev2units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_xy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">exchange_xy</span> <span class="k">else</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;fandw&quot;</span><span class="p">:</span>
            <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">get_xy</span><span class="p">(</span><span class="n">wmesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fan</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">latex_symbol</span><span class="p">[</span><span class="s2">&quot;fan&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">get_xy</span><span class="p">(</span><span class="n">wmesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dw</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">latex_symbol</span><span class="p">[</span><span class="s2">&quot;dw&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">sig_tot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fan</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dw</span>
            <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">get_xy</span><span class="p">(</span><span class="n">wmesh</span><span class="p">,</span> <span class="n">sig_tot</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">latex_symbol</span><span class="p">[</span><span class="s2">&quot;tot&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">with_ahc_zpr</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">cumtrapz</span>
                <span class="n">integral</span> <span class="o">=</span> <span class="n">cumtrapz</span><span class="p">(</span><span class="n">sig_tot</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wmesh</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#/ 2.0</span>
                <span class="c1">#print(&quot;ZPR: &quot;, integral[-1])</span>
                <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">get_xy</span><span class="p">(</span><span class="n">wmesh</span><span class="p">,</span> <span class="n">integral</span><span class="p">)</span>
                <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$ZPR(\omega)$&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="c1">#ax2.set_ylabel(&#39;Y2 data&#39;, color=&#39;b&#39;)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">latex_symbol</span><span class="p">[</span><span class="s2">&quot;tot&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="n">abu</span><span class="o">.</span><span class="n">wlabel_from_units</span><span class="p">(</span><span class="n">units</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">latex_symbol</span><span class="p">[</span><span class="s2">&quot;a2f&quot;</span><span class="p">]</span>
            <span class="n">set_ax_xylabels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;gkq2&quot;</span><span class="p">:</span>
            <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">get_xy</span><span class="p">(</span><span class="n">wmesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gkq2</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">latex_symbol</span><span class="p">[</span><span class="s2">&quot;gkq2&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="n">abu</span><span class="o">.</span><span class="n">wlabel_from_units</span><span class="p">(</span><span class="n">units</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">latex_symbol</span><span class="p">[</span><span class="s2">&quot;gkq2&quot;</span><span class="p">]</span>
            <span class="n">set_ax_xylabels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">what</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>


<span class="k">class</span> <span class="nc">_MyQpkindsList</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returned by find_qpkinds.&quot;&quot;&quot;</span>


<div class="viewcode-block" id="SigEPhFile"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile">[docs]</a><span class="k">class</span> <span class="nc">SigEPhFile</span><span class="p">(</span><span class="n">AbinitNcFile</span><span class="p">,</span> <span class="n">Has_Structure</span><span class="p">,</span> <span class="n">Has_ElectronBands</span><span class="p">,</span> <span class="n">NotebookWriter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This file contains the Fan-Migdal Debye-Waller self-energy, the |ElectronBands| on the k-mesh.</span>
<span class="sd">    Provides methods to analyze and plot results.</span>

<span class="sd">    Usage example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        with SigEPhFile(&quot;out_SIGEPH.nc&quot;) as ncfile:</span>
<span class="sd">            print(ncfile)</span>
<span class="sd">            ncfile.ebands.plot()</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: SigEPhFile</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Markers used for up/down bands.</span>
    <span class="n">marker_spin</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;v&quot;</span><span class="p">}</span>
    <span class="n">color_spin</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;r&quot;</span><span class="p">}</span>

<div class="viewcode-block" id="SigEPhFile.from_file"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.from_file">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the object from a netcdf file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="n">r</span> <span class="o">=</span> <span class="n">SigmaPhReader</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

        <span class="c1"># Get important dimensions.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nkcalc</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">nkcalc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">ntemp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nqbz</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">nqbz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nqibz</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">nqibz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngqpt</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">ngqpt</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">symsigma</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;symsigma&quot;</span><span class="p">)</span>
        <span class="c1"># 4 for FAN+DW, -4 for Fan Imaginary part</span>
        <span class="c1">#self.eph_task == r.read_value(&quot;eph_task&quot;, default=4)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imag_only</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;imag_only&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="c1"># TODO zcut?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zcut</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;eta&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbsum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;nbsum&quot;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bstart_sk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">bstart_sk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbcalc_sk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">nbcalc_sk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bstop_sk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">bstop_sk</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    def get_fundamental_gaps(self):</span>

<span class="sd">        ib_lumo = self.ebands.nelect // 2</span>
<span class="sd">        ib_homo = ib_lumo - 1</span>

<span class="sd">        # nctkarr_t(&quot;qp_enes&quot;, &quot;dp&quot;, &quot;two, ntemp, max_nbcalc, nkcalc, nsppol&quot;)</span>
<span class="sd">        qpes = self.reader.read_value(&quot;qp_enes&quot;, cmode=&quot;c&quot;).real * abu.Ha_eV</span>
<span class="sd">        for spin in range(self.nsppol):</span>
<span class="sd">            for ikc, kpoint in enumerate(self.sigma_kpoints):</span>
<span class="sd">                qpes[spin, ikc, :, :]</span>

<span class="sd">        def difference_matrix(a):</span>
<span class="sd">            x = np.reshape(a, (len(a), 1))</span>
<span class="sd">            return x - x.transpose()</span>

<span class="sd">        for spin, kset in enumerate(self.ebands.fundamental_gaps):</span>
<span class="sd">            ks_fgap = kset.energy</span>
<span class="sd">            # Find index in nkcalc</span>
<span class="sd">            ik_homo = self.sigkpt2index(kset.in_state.kpoint)</span>
<span class="sd">            ik_lumo = self.sigkpt2index(kset.out_state.kpoint)</span>
<span class="sd">            # nctkarr_t(&quot;qp_enes&quot;, &quot;dp&quot;, &quot;two, ntemp, max_nbcalc, nkcalc, nsppol&quot;)</span>
<span class="sd">            qpes = self.reader.read_value(&quot;qp_enes&quot;, cmode=&quot;c&quot;) * units.Ha_eV</span>
<span class="sd">            qpes[spin, ik_homo, ib_homo].real</span>
<span class="sd">            qpes[spin, ik_lumo, ib_lumo].real</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

<div class="viewcode-block" id="SigEPhFile.to_string"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>

        <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="s2">&quot;File Info&quot;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filestat</span><span class="p">(</span><span class="n">as_string</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Structure&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">with_structure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;KS Electron Bands&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="c1"># SigmaEPh section.</span>
        <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="s2">&quot;SigmaEPh calculation&quot;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imag_only</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Calculation type: Imaginary part of SigmaEPh&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Calculation type: Real + Imaginary part of SigmaEPh&quot;</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Number of k-points in Sigma_</span><span class="si">{nk}</span><span class="s2">: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nkcalc</span><span class="p">))</span>
        <span class="c1"># These variables have added recently</span>
        <span class="n">sigma_ngkpt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;sigma_ngkpt&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">sigma_erange</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;sigma_erange&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="c1">#dvdb_add_lr = self.reader.read_value(&quot;dvdb_add_lr&quot;, default=None)</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;sigma_ngkpt: </span><span class="si">%s</span><span class="s2">, sigma_erange: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sigma_ngkpt</span><span class="p">,</span> <span class="n">sigma_erange</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Max bstart: </span><span class="si">%d</span><span class="s2">, min bstop: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">max_bstart</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">min_bstop</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Initial ab-initio q-mesh:</span><span class="se">\n\t</span><span class="s2">ngqpt: </span><span class="si">%s</span><span class="s2">, with nqibz: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngqpt</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">nqibz</span><span class="p">))</span>
        <span class="n">eph_ngqpt_fine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;eph_ngqpt_fine&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">eph_ngqpt_fine</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="n">eph_ngqpt_fine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngqpt</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;q-mesh for self-energy integration (eph_ngqpt_fine): </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">eph_ngqpt_fine</span><span class="p">)))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;k-mesh for electrons:&quot;</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">ksampling</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Number of bands included in e-ph self-energy sum: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbsum</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;zcut: </span><span class="si">%.5f</span><span class="s2"> (Ha), </span><span class="si">%.3f</span><span class="s2"> (eV)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zcut</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zcut</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_eV</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Number of temperatures: </span><span class="si">%d</span><span class="s2">, from </span><span class="si">%.1f</span><span class="s2"> to </span><span class="si">%.1f</span><span class="s2"> (K)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;symsigma: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symsigma</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Has Eliashberg function: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">has_eliashberg_function</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Has Spectral function: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">has_spectral_function</span><span class="p">))</span>

        <span class="c1"># Build Table with direct gaps. Only the results for the first and the last T are shown if not verbose.</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">it_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">it_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Printing QP results for </span><span class="si">%d</span><span class="s2"> temperatures. Use --verbose to print all results.&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">it_list</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">imag_only</span><span class="p">:</span>
            <span class="c1"># QP corrections</span>
            <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">it_list</span><span class="p">:</span>
                <span class="n">app</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">KS, QP (Z factor) and on-the-mass-shell (OTMS) direct gaps in eV for T = </span><span class="si">%.1f</span><span class="s2"> K:&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span><span class="p">[</span><span class="n">it</span><span class="p">])</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">kpoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                        <span class="n">ks_gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ks_dirgaps</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">]</span>
                        <span class="n">qp_gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qp_dirgaps_t</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">it</span><span class="p">]</span>
                        <span class="n">oms_gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qp_dirgaps_otms_t</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">it</span><span class="p">]</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">spin</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">kpoint</span><span class="p">),</span> <span class="n">ks_gap</span><span class="p">,</span> <span class="n">qp_gap</span><span class="p">,</span> <span class="n">qp_gap</span> <span class="o">-</span> <span class="n">ks_gap</span><span class="p">,</span> <span class="n">oms_gap</span><span class="p">,</span> <span class="n">oms_gap</span> <span class="o">-</span> <span class="n">ks_gap</span><span class="p">])</span>
                <span class="n">app</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tabulate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
                    <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Spin&quot;</span><span class="p">,</span> <span class="s2">&quot;k-point&quot;</span><span class="p">,</span> <span class="s2">&quot;KS_gap&quot;</span><span class="p">,</span> <span class="s2">&quot;QPZ0_gap&quot;</span><span class="p">,</span> <span class="s2">&quot;QPZ0 - KS&quot;</span><span class="p">,</span> <span class="s2">&quot;OTMS_gap&quot;</span><span class="p">,</span> <span class="s2">&quot;OTMS - KS&quot;</span><span class="p">],</span>
                    <span class="n">floatfmt</span><span class="o">=</span><span class="s2">&quot;.3f&quot;</span><span class="p">)))</span>
                <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="c1">#else:</span>
        <span class="c1"># Print info on Lifetimes?</span>

        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;K-points and bands included in self-energy corrections:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">kpoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">):</span>
                    <span class="n">post</span> <span class="o">=</span> <span class="s2">&quot;ikc: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ikc</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;ikc: </span><span class="si">%d</span><span class="s2">, spin: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ikc</span><span class="p">,</span> <span class="n">spin</span><span class="p">))</span>
                    <span class="n">app</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="s2">: bstart: </span><span class="si">%d</span><span class="s2">, bstop: </span><span class="si">%d</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">repr</span><span class="p">(</span><span class="n">kpoint</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstart_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstop_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">],</span> <span class="n">post</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="SigEPhFile.ebands"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.ebands">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">ebands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;|ElectronBands| object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_ebands</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;|Structure| object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">structure</span>

<div class="viewcode-block" id="SigEPhFile.close"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close the file.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="SigEPhFile.has_spectral_function"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.has_spectral_function">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">has_spectral_function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if file contains spectral function data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">nwr</span> <span class="o">!=</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="SigEPhFile.has_eliashberg_function"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.has_eliashberg_function">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">has_eliashberg_function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if file contains Eliashberg functions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">gfw_nomega</span> <span class="o">&gt;</span> <span class="mi">0</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sigma_kpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The K-points where QP corrections have been calculated.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">sigma_kpoints</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tmesh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Temperature mesh in Kelvin.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">tmesh</span>

<div class="viewcode-block" id="SigEPhFile.kcalc2ibz"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.kcalc2ibz">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">kcalc2ibz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a mapping of the kpoints at which the self energy was calculated and the ibz</span>
<span class="sd">        i.e. the list of k-points in the band structure used to construct the self-energy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: This field is not available in the netcdf file.</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">kpoints</span><span class="p">)</span> <span class="ow">and</span>
            <span class="nb">all</span><span class="p">(</span><span class="n">k1</span> <span class="o">==</span> <span class="n">k2</span> <span class="k">for</span> <span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">kpoints</span><span class="p">))):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">))</span>

        <span class="c1"># Generic case</span>
        <span class="c1"># Map sigma_kpoints to ebands.kpoints</span>
        <span class="n">kcalc2ibz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nkcalc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">sigkpt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">):</span>
            <span class="n">kcalc2ibz</span><span class="p">[</span><span class="n">ikc</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">sigkpt</span><span class="p">)</span>

        <span class="c1">#assert np.all(kcalc2ibz == self.reader.read_value(&quot;kcalc2ibz&quot;)[0] - 1)</span>
        <span class="k">return</span> <span class="n">kcalc2ibz</span>

        <span class="c1"># nctkarr_t(&quot;kcalc2ibz&quot;, &quot;int&quot;, &quot;nkcalc, six&quot;)</span>
        <span class="n">kcalc2ibz_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;kcalc2ibz&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">kcalc2ibz_map</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="SigEPhFile.ibz2kcalc"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.ibz2kcalc">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">ibz2kcalc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mapping IBZ --&gt; K-points in self-energy.</span>
<span class="sd">        Set to -1 if IBZ k-point not present.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ibz2kcalc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">kpoints</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">ik_ibz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kcalc2ibz</span><span class="p">):</span>
            <span class="n">ibz2kcalc</span><span class="p">[</span><span class="n">ik_ibz</span><span class="p">]</span> <span class="o">=</span> <span class="n">ikc</span>
        <span class="k">return</span> <span class="n">ibz2kcalc</span></div>

<div class="viewcode-block" id="SigEPhFile.ks_dirgaps"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.ks_dirgaps">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">ks_dirgaps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        |numpy-array| of shape [nsppol, nkcalc] with the KS gaps in eV ordered as kcalc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;ks_gaps&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_eV</span></div>

<div class="viewcode-block" id="SigEPhFile.qp_dirgaps_t"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.qp_dirgaps_t">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">qp_dirgaps_t</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        |numpy-array| of shape [nsppol, nkcalc, ntemp] with the QP direct gap in eV ordered as kcalc.</span>
<span class="sd">        QP energies are computed with the linearized QP equation (Z factor)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;qp_gaps&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_to_eV</span></div>

<div class="viewcode-block" id="SigEPhFile.qp_dirgaps_otms_t"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.qp_dirgaps_otms_t">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">qp_dirgaps_otms_t</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        |numpy-array| of shape [nsppol, nkcalc, ntemp] with the QP direct gap in eV ordered as kcalc.</span>
<span class="sd">        QP energies are computed with the on-the-mass-shell approximation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;qpoms_gaps&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_to_eV</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1">#cprint(&quot;Reading old deprecated sigeph file!&quot;, &quot;yellow&quot;)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;qpadb_enes&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_to_eV</span></div>

<div class="viewcode-block" id="SigEPhFile.mu_e"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.mu_e">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">mu_e</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;mu_e[ntemp] chemical potential (eV) of electrons for the different temperatures.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;mu_e&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_eV</span></div>

<div class="viewcode-block" id="SigEPhFile.edos"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.edos">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">edos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        |ElectronDos| object computed by Abinit with the input WFK file without doping (if any).</span>
<span class="sd">        Since this field is optional, None is returned if netcdf variable is not present</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;edos_mesh&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">rootgrp</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># See m_ebands.edos_ncwrite for fileformat</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;edos_mesh&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_eV</span>
        <span class="c1"># nctkarr_t(&quot;edos_dos&quot;, &quot;dp&quot;, &quot;edos_nw, nsppol_plus1&quot;), &amp;</span>
        <span class="c1"># dos(nw,0:nsppol) Total DOS, spin up and spin down component.</span>
        <span class="n">spin_dos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;edos_dos&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_eV</span>
        <span class="n">nelect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">nelect</span>
        <span class="n">fermie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">fermie</span>

        <span class="k">return</span> <span class="n">ElectronDos</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">spin_dos</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">nelect</span><span class="p">,</span> <span class="n">fermie</span><span class="o">=</span><span class="n">fermie</span><span class="p">)</span></div>

<div class="viewcode-block" id="SigEPhFile.sigkpt2index"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.sigkpt2index">[docs]</a>    <span class="k">def</span> <span class="nf">sigkpt2index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the index of the self-energy k-point in sigma_kpoints</span>
<span class="sd">        Used to access data in the arrays that are dimensioned with [0:nkcalc]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">sigkpt2index</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span></div>

<div class="viewcode-block" id="SigEPhFile.find_qpkinds"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.find_qpkinds">[docs]</a>    <span class="k">def</span> <span class="nf">find_qpkinds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qp_kpoints</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find kpoints for QP corrections from user input.</span>
<span class="sd">        Return list of (kpt, ikcalc) tuples where kpt is a |Kpoint| and</span>
<span class="sd">        ikcalc is the index in the nkcalc array..</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">qp_kpoints</span><span class="p">,</span> <span class="n">_MyQpkindsList</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">qp_kpoints</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">qp_kpoints</span><span class="p">,</span> <span class="n">Kpoint</span><span class="p">):</span>
            <span class="n">qp_kpoints</span> <span class="o">=</span> <span class="p">[</span><span class="n">qp_kpoints</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">qp_kpoints</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">duck</span><span class="o">.</span><span class="n">is_string</span><span class="p">(</span><span class="n">qp_kpoints</span><span class="p">)</span> <span class="ow">and</span> <span class="n">qp_kpoints</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">):</span>
            <span class="c1"># qp_kpoints in (None, &quot;all&quot;)</span>
            <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nkcalc</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">duck</span><span class="o">.</span><span class="n">is_intlike</span><span class="p">(</span><span class="n">qp_kpoints</span><span class="p">):</span>
            <span class="c1"># qp_kpoints = 1</span>
            <span class="n">ikc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">qp_kpoints</span><span class="p">)</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">[</span><span class="n">ikc</span><span class="p">]],</span> <span class="p">[</span><span class="n">ikc</span><span class="p">]</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">qp_kpoints</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="c1"># either [0, 1] or [[0, 0.5, 0]]</span>
            <span class="c1"># note possible ambiguity with [0, 0, 0] that is treated as list of integers.</span>
            <span class="k">if</span> <span class="n">duck</span><span class="o">.</span><span class="n">is_intlike</span><span class="p">(</span><span class="n">qp_kpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">ik_list</span> <span class="o">=</span> <span class="n">duck</span><span class="o">.</span><span class="n">list_ints</span><span class="p">(</span><span class="n">qp_kpoints</span><span class="p">)</span>
                <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">[</span><span class="n">ikc</span><span class="p">]</span> <span class="k">for</span> <span class="n">ikc</span> <span class="ow">in</span> <span class="n">ik_list</span><span class="p">],</span> <span class="n">ik_list</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ik_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">sigkpt2index</span><span class="p">(</span><span class="n">kpt</span><span class="p">)</span> <span class="k">for</span> <span class="n">kpt</span> <span class="ow">in</span> <span class="n">qp_kpoints</span><span class="p">]</span>
                <span class="n">qp_kpoints</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">[</span><span class="n">ikc</span><span class="p">]</span> <span class="k">for</span> <span class="n">ikc</span> <span class="ow">in</span> <span class="n">ik_list</span><span class="p">]</span>
                <span class="n">items</span> <span class="o">=</span> <span class="n">qp_kpoints</span><span class="p">,</span> <span class="n">ik_list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know how to interpret `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">qp_kpoints</span><span class="p">)))</span>

        <span class="c1"># Check indices</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">eapp</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">append</span>
        <span class="k">for</span> <span class="n">ikc</span> <span class="ow">in</span> <span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">ikc</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkcalc</span><span class="p">:</span>
                <span class="n">eapp</span><span class="p">(</span><span class="s2">&quot;K-point index </span><span class="si">%d</span><span class="s2"> &gt;= nkcalc </span><span class="si">%d</span><span class="s2">, check input qp_kpoints&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ikc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkcalc</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">_MyQpkindsList</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span></div>

<div class="viewcode-block" id="SigEPhFile.params"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.params">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;:class:`OrderedDict` with the convergence parameters, e.g. ``nbsum``.&quot;&quot;&quot;</span>
        <span class="n">od</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([</span>
            <span class="p">(</span><span class="s2">&quot;nbsum&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbsum</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;zcut&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zcut</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;symsigma&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">symsigma</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;nqbz&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">nqbz</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;nqibz&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">nqibz</span><span class="p">),</span>
        <span class="p">])</span>
        <span class="c1"># Add EPH parameters.</span>
        <span class="n">od</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">common_eph_params</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">od</span></div>

<div class="viewcode-block" id="SigEPhFile.get_sigeph_skb"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.get_sigeph_skb">[docs]</a>    <span class="k">def</span> <span class="nf">get_sigeph_skb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;Return e-ph self-energy for the given (spin, kpoint, band).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_sigeph_skb</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">)</span></div>

    <span class="c1">#def get_arpes_plotter(self):</span>
    <span class="c1">#    from abipy.electrons.arpes import ArpesPlotter</span>
    <span class="c1">#    kinds</span>
    <span class="c1">#    minb, maxb</span>
    <span class="c1">#    aw: [nwr, ntemp, max_nbcalc, nkcalc, nsppol] array</span>
    <span class="c1">#    aw_meshes: [max_nbcalc, nkcalc, nsppol] array with energy mesh in eV</span>
    <span class="c1">#    arpes_ebands = self.ebands.select_bands(range(minb, maxb), kinds=kinds)</span>
    <span class="c1">#    return ArpesPlotter(arpes_ebands, aw, aw_meshes, self.tmesh)</span>

<div class="viewcode-block" id="SigEPhFile.get_dataframe"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.get_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">get_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">itemp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_params</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_spin</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">ignore_imag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns |pandas-Dataframe| with QP results for all k-points, bands and spins</span>
<span class="sd">        included in the calculation.</span>

<span class="sd">        Args:</span>
<span class="sd">            itemp: Temperature index, if None all temperatures are returned.</span>
<span class="sd">            with_params: False to exclude calculation parameters from the dataframe.</span>
<span class="sd">            ignore_imag: only real part is returned if ``ignore_imag``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df_list</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">df_list</span><span class="o">.</span><span class="n">append</span>
        <span class="n">with_spin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">with_spin</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span> <span class="k">else</span> <span class="n">with_spin</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">kpoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">):</span>
                <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dataframe_sk</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">itemp</span><span class="o">=</span><span class="n">itemp</span><span class="p">,</span> <span class="n">with_params</span><span class="o">=</span><span class="n">with_params</span><span class="p">,</span>
                    <span class="n">with_spin</span><span class="o">=</span><span class="n">with_spin</span><span class="p">,</span> <span class="n">ignore_imag</span><span class="o">=</span><span class="n">ignore_imag</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="SigEPhFile.get_dirgaps_dataframe"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.get_dirgaps_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">get_dirgaps_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">itemp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">with_params</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns |pandas-DataFrame| with QP direct gaps at the given k-point</span>

<span class="sd">        Args:</span>
<span class="sd">            kpoint: K-point in self-energy. Accepts |Kpoint|, vector or index.</span>
<span class="sd">            itemp: Temperature index, if None all temperatures are returned.</span>
<span class="sd">            spin: Spin index</span>
<span class="sd">            with_params: False to exclude calculation parameters from the dataframe.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ikc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigkpt2index</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span>
        <span class="n">it_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span><span class="p">))</span> <span class="k">if</span> <span class="n">itemp</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">itemp</span><span class="p">)]</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">it_list</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span><span class="p">[</span><span class="n">it</span><span class="p">],</span>
                     <span class="n">ks_gap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ks_dirgaps</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">],</span>
                     <span class="n">qp_gap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qp_dirgaps_t</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">it</span><span class="p">],</span>
                     <span class="n">otms_gap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qp_dirgaps_otms_t</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">it</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">with_params</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span></div>

<div class="viewcode-block" id="SigEPhFile.get_dataframe_sk"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.get_dataframe_sk">[docs]</a>    <span class="k">def</span> <span class="nf">get_dataframe_sk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">itemp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">with_params</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">with_spin</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">ignore_imag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns |pandas-DataFrame| with QP results for the given (spin, k-point).</span>

<span class="sd">        Args:</span>
<span class="sd">            spin: Spin index.</span>
<span class="sd">            kpoint: K-point in self-energy. Accepts |Kpoint|, vector or index.</span>
<span class="sd">            itemp: Temperature index, if None all temperatures are returned.</span>
<span class="sd">            index: dataframe index.</span>
<span class="sd">            with_params: False to exclude calculation parameters from the dataframe.</span>
<span class="sd">            with_spin: True to add column with spin index. &quot;auto&quot; to add it only if nsppol == 2</span>
<span class="sd">            ignore_imag: Only real part is returned if ``ignore_imag``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ikc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigkpt2index</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span>
        <span class="n">with_spin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">with_spin</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span> <span class="k">else</span> <span class="n">with_spin</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bstart_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstop_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">]):</span>
            <span class="c1"># Read QP data.</span>
            <span class="n">qp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_qp</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">ignore_imag</span><span class="o">=</span><span class="n">ignore_imag</span><span class="p">)</span>
            <span class="c1"># Convert to dataframe and add other entries useful when comparing different calculations.</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qp</span><span class="o">.</span><span class="n">get_dataframe</span><span class="p">(</span><span class="n">with_spin</span><span class="o">=</span><span class="n">with_spin</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="k">if</span> <span class="n">with_params</span> <span class="k">else</span> <span class="kc">None</span><span class="p">))</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">itemp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;tmesh&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span><span class="p">[</span><span class="n">itemp</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="SigEPhFile.get_linewidth_dos"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.get_linewidth_dos">[docs]</a>    <span class="k">def</span> <span class="nf">get_linewidth_dos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate linewidth density of states</span>

<span class="sd">        Args:</span>
<span class="sd">            method: String defining the method for the computation of the DOS.</span>
<span class="sd">            step: Energy step (eV) of the linear mesh.</span>
<span class="sd">            width: Standard deviation (eV) of the gaussian.</span>

<span class="sd">        Returns: |ElectronDos| object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ebands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span>
        <span class="n">ntemp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span>
        <span class="n">tmesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span>

        <span class="c1"># Compute linear mesh</span>
        <span class="n">nelect</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">nelect</span>
        <span class="n">fermie</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
        <span class="n">epad</span> <span class="o">=</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">width</span>
        <span class="n">min_band</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bstart_sk</span><span class="p">)</span>
        <span class="n">max_band</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bstop_sk</span><span class="p">)</span>
        <span class="n">e_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ebands</span><span class="o">.</span><span class="n">eigens</span><span class="p">[:,:,</span><span class="n">min_band</span><span class="p">])</span> <span class="o">-</span> <span class="n">epad</span>
        <span class="n">e_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ebands</span><span class="o">.</span><span class="n">eigens</span><span class="p">[:,:,</span><span class="n">max_band</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">epad</span>
        <span class="n">nw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">e_max</span> <span class="o">-</span> <span class="n">e_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">step</span><span class="p">)</span>
        <span class="n">mesh</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">e_min</span><span class="p">,</span> <span class="n">e_max</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">nw</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">retstep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># get dos</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
            <span class="n">dos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ntemp</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span><span class="n">nw</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kcalc2ibz</span><span class="p">):</span>
                    <span class="n">weight</span> <span class="o">=</span> <span class="n">ebands</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bstart_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstop_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">i</span><span class="p">]):</span>
                        <span class="n">qp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_qp</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">band</span><span class="p">)</span>
                        <span class="n">e0</span> <span class="o">=</span> <span class="n">qp</span><span class="o">.</span><span class="n">e0</span>
                        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntemp</span><span class="p">):</span>
                            <span class="n">linewidth</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">qp</span><span class="o">.</span><span class="n">fan0</span><span class="o">.</span><span class="n">imag</span><span class="p">[</span><span class="n">it</span><span class="p">])</span>
                            <span class="n">dos</span><span class="p">[</span><span class="n">it</span><span class="p">,</span><span class="n">spin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">linewidth</span> <span class="o">*</span> <span class="n">gaussian</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">e0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Method </span><span class="si">%s</span><span class="s2"> is not supported&quot;</span> <span class="o">%</span> <span class="n">method</span><span class="p">)</span>

        <span class="c1"># TODO: Specialized object with ElectronDos list?</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">ElectronDos</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">dos_t</span><span class="p">,</span> <span class="n">nelect</span><span class="p">,</span> <span class="n">fermie</span><span class="o">=</span><span class="n">fermie</span><span class="p">)</span> <span class="k">for</span> <span class="n">dos_t</span> <span class="ow">in</span> <span class="n">dos</span><span class="p">]</span></div>

<div class="viewcode-block" id="SigEPhFile.get_qp_array"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.get_qp_array">[docs]</a>    <span class="k">def</span> <span class="nf">get_qp_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ks_ebands_kpath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;qp&quot;</span><span class="p">,</span> <span class="n">rta_type</span><span class="o">=</span><span class="s2">&quot;mrta&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the lifetimes in an array with spin, kpoint and band dimensions</span>

<span class="sd">        Args:</span>
<span class="sd">            rta_type: &quot;serta&quot; for SERTA linewidths or &quot;mrta&quot; for MRTA linewidths.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;qp&quot;</span><span class="p">:</span>
            <span class="c1"># Read QP energies from file (real + imag part) and compute corrections if ks_ebands_kpath.</span>
            <span class="c1"># nctkarr_t(&quot;qp_enes&quot;, &quot;dp&quot;, &quot;two, ntemp, max_nbcalc, nkcalc, nsppol&quot;)</span>
            <span class="n">qpes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;qp_enes&quot;</span><span class="p">,</span> <span class="n">cmode</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_eV</span>

        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;ks+lifetimes&quot;</span><span class="p">:</span>
            <span class="c1"># nctkarr_t(&quot;ks_enes&quot;, &quot;dp&quot;, &quot;max_nbcalc, nkcalc, nsppol&quot;)</span>
            <span class="c1"># nctkarr_t(&quot;vals_e0ks&quot;, &quot;dp&quot;, &quot;two, ntemp, max_nbcalc, nkcalc, nsppol&quot;)</span>
            <span class="n">qpes_re</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;ks_enes&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_to_eV</span>

            <span class="k">if</span> <span class="n">rta_type</span> <span class="o">==</span> <span class="s2">&quot;serta&quot;</span><span class="p">:</span>
                <span class="n">qpes_im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;vals_e0ks&quot;</span><span class="p">,</span> <span class="n">cmode</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">imag</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_to_eV</span>
            <span class="k">elif</span> <span class="n">rta_type</span> <span class="o">==</span> <span class="s2">&quot;mrta&quot;</span><span class="p">:</span>
                <span class="n">qpes_im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;linewidth_mrta&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_to_eV</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid rta_type: `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="n">rta_type</span><span class="p">)</span>

            <span class="n">qpes</span> <span class="o">=</span> <span class="n">qpes_re</span><span class="p">[:,:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">qpes_im</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid interpolation mode: </span><span class="si">%s</span><span class="s2"> can be either &#39;qp&#39; or &#39;ks+lifetimes&#39;&quot;</span> <span class="o">%</span> <span class="n">mode</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ks_ebands_kpath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ks_ebands_kpath</span><span class="o">.</span><span class="n">structure</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;sigres.structure and ks_ebands_kpath.structures differ. Check your files!&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
            <span class="c1"># MG FIXME: Not sure this part is OK</span>
            <span class="c1"># nctkarr_t(&quot;ks_enes&quot;, &quot;dp&quot;, &quot;max_nbcalc, nkcalc, nsppol&quot;)</span>
            <span class="n">ks_enes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;ks_enes&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_to_eV</span>
            <span class="k">for</span> <span class="n">itemp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span><span class="p">):</span>
                <span class="n">qpes</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">itemp</span><span class="p">]</span> <span class="o">-=</span> <span class="n">ks_enes</span>

        <span class="c1"># Note there&#39;s no guarantee that the sigma_kpoints and the corrections have the same k-point index.</span>
        <span class="c1"># Be careful because the order of the k-points and the band range stored in the SIGRES file may differ ...</span>
        <span class="c1"># HM: Map the bands from sigeph to the electron bandstructure</span>
        <span class="n">nkibz</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">kpoints</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nkibz</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">):</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;SIGPEH file does not contain QP data for all the k-points in the IBZ!&quot;</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">)</span>

        <span class="n">nband</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">bstop_sk</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">qpes_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="n">nkibz</span><span class="p">,</span> <span class="n">nband</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">ikibz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kcalc2ibz</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ibc</span><span class="p">,</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bstart_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstop_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">])):</span>
                    <span class="n">qpes_new</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikibz</span><span class="p">,</span> <span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="n">qpes</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">ibc</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">qpes_new</span></div>

<div class="viewcode-block" id="SigEPhFile.get_lifetimes_boltztrap"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.get_lifetimes_boltztrap">[docs]</a>    <span class="k">def</span> <span class="nf">get_lifetimes_boltztrap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">rta_type</span><span class="o">=</span><span class="s2">&quot;mrta&quot;</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Produce basename.tau and basename.energy text files to be used</span>
<span class="sd">        in Boltztrap code for transport calculations.</span>

<span class="sd">        Args:</span>
<span class="sd">            basename: The basename of the files to be produced</span>
<span class="sd">            workdir: Directory where files will be produced. None for current working directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="k">if</span> <span class="n">workdir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>

        <span class="c1"># get the lifetimes as an array</span>
        <span class="n">qpes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_qp_array</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;ks+lifetimes&#39;</span><span class="p">,</span> <span class="n">rta_type</span><span class="o">=</span><span class="n">rta_type</span><span class="p">)</span>

        <span class="c1"># read from this class</span>
        <span class="n">nkibz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkpt</span>
        <span class="n">kpoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoints</span>
        <span class="n">bstart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">max_bstart</span>
        <span class="n">bstop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">min_bstop</span>
        <span class="n">ntemp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span>
        <span class="n">tmesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span>
        <span class="n">fermie_ry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">fermie</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">eV_Ry</span>
        <span class="n">struct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">structure</span>

        <span class="k">def</span> <span class="nf">write_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Function to write files for BoltzTraP&quot;&quot;&quot;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="s1">&#39;wt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">ttag</span> <span class="o">=</span> <span class="s1">&#39; for T=</span><span class="si">%12.6lf</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">T</span> <span class="k">if</span> <span class="n">T</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;BoltzTraP </span><span class="si">%s</span><span class="s1"> file generated by abipy</span><span class="si">%s</span><span class="s1">.</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">ttag</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%5d</span><span class="s1"> </span><span class="si">%5d</span><span class="s1"> </span><span class="si">%20.12e</span><span class="s1"> ! nk, nspin : lifetimes below in s </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nkibz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="n">fermie_ry</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">ispin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkibz</span><span class="p">):</span>
                        <span class="n">kpt</span> <span class="o">=</span> <span class="n">kpoints</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span>
                        <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%20.12e</span><span class="s1"> &#39;</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> !kpt nband</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bstop</span> <span class="o">-</span> <span class="n">bstart</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fmt</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">kpt</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">ibnd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bstart</span><span class="p">,</span> <span class="n">bstop</span><span class="p">):</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%20.12e</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">qpes</span><span class="p">[</span><span class="n">ispin</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">ibnd</span><span class="p">,</span> <span class="n">itemp</span><span class="p">])))</span>

        <span class="c1"># write tau</span>
        <span class="k">for</span> <span class="n">itemp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntemp</span><span class="p">):</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">tmesh</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span>
            <span class="n">filename_tau</span> <span class="o">=</span> <span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">%d</span><span class="s1">K_BLZTRP.tau_k&#39;</span> <span class="o">%</span> <span class="n">T</span>
            <span class="n">function</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">eV_s</span><span class="p">)</span>
            <span class="n">write_file</span><span class="p">(</span><span class="n">filename_tau</span><span class="p">,</span> <span class="s1">&#39;tau_k&#39;</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span><span class="n">T</span><span class="p">)</span>

        <span class="c1"># write energies</span>
        <span class="n">filename_ene</span> <span class="o">=</span> <span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_BLZTRP.energy&#39;</span>
        <span class="n">function</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">real</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">eV_Ry</span>
        <span class="n">write_file</span><span class="p">(</span><span class="n">filename_ene</span><span class="p">,</span> <span class="s1">&#39;eigen-enegies&#39;</span><span class="p">,</span> <span class="n">function</span><span class="p">)</span>

        <span class="c1"># write structure</span>
        <span class="n">fmt3</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%20.12e</span><span class="s2"> &quot;</span><span class="o">*</span><span class="mi">3</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_BLZTRP.structure&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;wt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;BoltzTraP geometry file generated by abipy.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fmt3</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ang_Bohr</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fmt3</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ang_Bohr</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fmt3</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ang_Bohr</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">struct</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">struct</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">atom</span><span class="o">.</span><span class="n">specie</span> <span class="o">+</span> <span class="n">fmt3</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">coords</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ang_Bohr</span><span class="p">))</span></div>

<div class="viewcode-block" id="SigEPhFile.interpolate"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.interpolate">[docs]</a>    <span class="k">def</span> <span class="nf">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">itemp_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lpratio</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;qp&quot;</span><span class="p">,</span> <span class="n">ks_ebands_kpath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ks_ebands_kmesh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">ks_degatol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">vertices_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">line_density</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">filter_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">only_corrections</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span> <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Interpolated the self-energy corrections in k-space on a k-path and, optionally, on a k-mesh.</span>

<span class="sd">        Args:</span>
<span class="sd">            itemp_list: List of temperature indices to interpolate. None for all.</span>
<span class="sd">            lpratio: Ratio between the number of star functions and the number of ab-initio k-points.</span>
<span class="sd">                The default should be OK in many systems, larger values may be required for accurate derivatives.</span>
<span class="sd">            mode: Interpolation mode, can be &#39;qp&#39; or &#39;ks+lifetimes&#39;</span>
<span class="sd">            ks_ebands_kpath: KS |ElectronBands| on a k-path. If present,</span>
<span class="sd">                the routine interpolates the QP corrections and apply them on top of the KS band structure</span>
<span class="sd">                This is the recommended option because QP corrections are usually smoother than the</span>
<span class="sd">                QP energies and therefore easier to interpolate. If None, the QP energies are interpolated</span>
<span class="sd">                along the path defined by ``vertices_names`` and ``line_density``.</span>
<span class="sd">            ks_ebands_kmesh: KS |ElectronBands| on a homogeneous k-mesh. If present, the routine</span>
<span class="sd">                interpolates the corrections on the k-mesh (used to compute the QP DOS)</span>
<span class="sd">            ks_degatol: Energy tolerance in eV. Used when either ``ks_ebands_kpath`` or ``ks_ebands_kmesh`` are given.</span>
<span class="sd">                KS energies are assumed to be degenerate if they differ by less than this value.</span>
<span class="sd">                The interpolator may break band degeneracies (the error is usually smaller if QP corrections</span>
<span class="sd">                are interpolated instead of QP energies). This problem can be partly solved by averaging</span>
<span class="sd">                the interpolated values over the set of KS degenerate states.</span>
<span class="sd">                A negative value disables this ad-hoc symmetrization.</span>
<span class="sd">            vertices_names: Used to specify the k-path for the interpolated QP band structure</span>
<span class="sd">                when ``ks_ebands_kpath`` is None.</span>
<span class="sd">                It&#39;s a list of tuple, each tuple is of the form (kfrac_coords, kname) where</span>
<span class="sd">                kfrac_coords are the reduced coordinates of the k-point and kname is a string with the name of</span>
<span class="sd">                the k-point. Each point represents a vertex of the k-path. ``line_density`` defines</span>
<span class="sd">                the density of the sampling. If None, the k-path is automatically generated according</span>
<span class="sd">                to the point group of the system.</span>
<span class="sd">            line_density: Number of points in the smallest segment of the k-path. Used with ``vertices_names``.</span>
<span class="sd">            filter_params: TO BE DESCRIBED</span>
<span class="sd">            only_corrections: If True, the output contains the interpolated QP corrections instead of the QP energies.</span>
<span class="sd">                Available only if ks_ebands_kpath and/or ks_ebands_kmesh are used.</span>
<span class="sd">            verbose: Verbosity level</span>

<span class="sd">        Returns: class:`TdepElectronBands`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Consistency check.</span>
        <span class="n">errlines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">eapp</span> <span class="o">=</span> <span class="n">errlines</span><span class="o">.</span><span class="n">append</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">kpoints</span><span class="p">):</span>
            <span class="n">eapp</span><span class="p">(</span><span class="s2">&quot;QP energies should be computed for all k-points in the IBZ but nkibz != nkptgw&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">eapp</span><span class="p">(</span><span class="s2">&quot;QP Interpolation requires nkptgw &gt; 1.&quot;</span><span class="p">)</span>
        <span class="c1">#if (np.any(self.bstop_sk[0, 0] != self.gwbstop_sk):</span>
        <span class="c1">#    cprint(&quot;Highest bdgw band is not constant over k-points. QP Bands will be interpolated up to...&quot;)</span>
        <span class="c1">#if (np.any(self.gwbstart_sk[0, 0] != self.gwbstart_sk):</span>
        <span class="c1">#if (np.any(self.gwbstart_sk[0, 0] != 0):</span>
        <span class="k">if</span> <span class="n">errlines</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errlines</span><span class="p">))</span>

        <span class="c1"># Get symmetries from abinit spacegroup (read from file).</span>
        <span class="n">abispg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">abi_spacegroup</span>
        <span class="n">fm_symrel</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">afm</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">abispg</span><span class="o">.</span><span class="n">symrel</span><span class="p">,</span> <span class="n">abispg</span><span class="o">.</span><span class="n">symafm</span><span class="p">)</span> <span class="k">if</span> <span class="n">afm</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">ks_ebands_kpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Generate k-points for interpolation. Will interpolate all bands available in the sigeph file.</span>
            <span class="n">bstart</span><span class="p">,</span> <span class="n">bstop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">max_bstart</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">min_bstop</span>
            <span class="k">if</span> <span class="n">vertices_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">vertices_names</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">,</span> <span class="n">k</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">hsym_kpoints</span><span class="p">]</span>
            <span class="n">kpath</span> <span class="o">=</span> <span class="n">Kpath</span><span class="o">.</span><span class="n">from_vertices_and_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">vertices_names</span><span class="p">,</span> <span class="n">line_density</span><span class="o">=</span><span class="n">line_density</span><span class="p">)</span>
            <span class="n">kfrac_coords</span><span class="p">,</span> <span class="n">knames</span> <span class="o">=</span> <span class="n">kpath</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">,</span> <span class="n">kpath</span><span class="o">.</span><span class="n">names</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use list of k-points from ks_ebands_kpath.</span>
            <span class="n">ks_ebands_kpath</span> <span class="o">=</span> <span class="n">ElectronBands</span><span class="o">.</span><span class="n">as_ebands</span><span class="p">(</span><span class="n">ks_ebands_kpath</span><span class="p">)</span>
            <span class="n">kfrac_coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">frac_coords</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ks_ebands_kpath</span><span class="o">.</span><span class="n">kpoints</span><span class="p">]</span>
            <span class="n">knames</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ks_ebands_kpath</span><span class="o">.</span><span class="n">kpoints</span><span class="p">]</span>

            <span class="c1"># Find the band range for the interpolation.</span>
            <span class="n">bstart</span><span class="p">,</span> <span class="n">bstop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ks_ebands_kpath</span><span class="o">.</span><span class="n">nband</span>
            <span class="c1"># FIXME what about bstart?</span>
            <span class="n">bstop</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bstop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">min_bstop</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ks_ebands_kpath</span><span class="o">.</span><span class="n">nband</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">min_bstop</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Number of bands in KS band structure smaller than the number of bands in GW corrections&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Highest GW bands will be ignored&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ks_ebands_kmesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># K-points and weight for DOS are taken from ks_ebands_kmesh</span>
            <span class="n">dos_kcoords</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">frac_coords</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ks_ebands_kmesh</span><span class="o">.</span><span class="n">kpoints</span><span class="p">]</span>
            <span class="n">dos_weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">weight</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ks_ebands_kmesh</span><span class="o">.</span><span class="n">kpoints</span><span class="p">]</span>

        <span class="c1"># Interpolate QP energies if ks_ebands_kpath is None else interpolate QP corrections</span>
        <span class="c1"># and re-apply them on top of the KS band structure.</span>
        <span class="n">gw_kcoords</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">frac_coords</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">]</span>

        <span class="c1"># MG FIXME: Not sure this part is OK</span>
        <span class="n">qpes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_qp_array</span><span class="p">(</span><span class="n">ks_ebands_kpath</span><span class="o">=</span><span class="n">ks_ebands_kpath</span><span class="p">)</span>

        <span class="c1"># Build interpolator for QP corrections.</span>
        <span class="kn">from</span> <span class="nn">abipy.core.skw</span> <span class="kn">import</span> <span class="n">SkwInterpolator</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">atomic_numbers</span><span class="p">)</span>
        <span class="n">has_timrev</span> <span class="o">=</span> <span class="n">has_timrev_from_kptopt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;kptopt&quot;</span><span class="p">))</span>

        <span class="n">qp_ebands_kpath_t</span><span class="p">,</span> <span class="n">qp_ebands_kmesh_t</span><span class="p">,</span> <span class="n">interpolators_t</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">itemp_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span><span class="p">))</span> <span class="k">if</span> <span class="n">itemp_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">duck</span><span class="o">.</span><span class="n">list_ints</span><span class="p">(</span><span class="n">itemp_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">itemp</span> <span class="ow">in</span> <span class="n">itemp_list</span><span class="p">:</span>
            <span class="n">skw_reim</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">reim</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;real&quot;</span><span class="p">,</span> <span class="s2">&quot;imag&quot;</span><span class="p">):</span>
                <span class="n">qpdata</span> <span class="o">=</span> <span class="n">qpes</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">bstart</span><span class="p">:</span><span class="n">bstop</span><span class="p">,</span> <span class="n">itemp</span><span class="p">]</span>
                <span class="n">qpdata</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">qpdata</span><span class="p">,</span> <span class="n">reim</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="n">skw</span> <span class="o">=</span> <span class="n">SkwInterpolator</span><span class="p">(</span><span class="n">lpratio</span><span class="p">,</span> <span class="n">gw_kcoords</span><span class="p">,</span> <span class="n">qpdata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">fermie</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">nelect</span><span class="p">,</span>
                                      <span class="n">cell</span><span class="p">,</span> <span class="n">fm_symrel</span><span class="p">,</span> <span class="n">has_timrev</span><span class="p">,</span>
                                      <span class="n">filter_params</span><span class="o">=</span><span class="n">filter_params</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
                <span class="n">skw_reim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">skw</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">ks_ebands_kpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Interpolate QP energies.</span>
                    <span class="k">if</span> <span class="n">reim</span> <span class="o">==</span> <span class="s2">&quot;real&quot;</span><span class="p">:</span>
                        <span class="n">eigens_kpath</span> <span class="o">=</span> <span class="n">skw</span><span class="o">.</span><span class="n">interp_kpts</span><span class="p">(</span><span class="n">kfrac_coords</span><span class="p">)</span><span class="o">.</span><span class="n">eigens</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lw_kpath</span> <span class="o">=</span> <span class="n">skw</span><span class="o">.</span><span class="n">interp_kpts</span><span class="p">(</span><span class="n">kfrac_coords</span><span class="p">)</span><span class="o">.</span><span class="n">eigens</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Interpolate QP energies corrections and add them to KS.</span>
                    <span class="n">ref_eigens</span> <span class="o">=</span> <span class="n">ks_ebands_kpath</span><span class="o">.</span><span class="n">eigens</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">bstart</span><span class="p">:</span><span class="n">bstop</span><span class="p">]</span>
                    <span class="n">qp_corrs</span> <span class="o">=</span> <span class="n">skw</span><span class="o">.</span><span class="n">interp_kpts_and_enforce_degs</span><span class="p">(</span><span class="n">kfrac_coords</span><span class="p">,</span> <span class="n">ref_eigens</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">ks_degatol</span><span class="p">)</span><span class="o">.</span><span class="n">eigens</span>
                    <span class="k">if</span> <span class="n">reim</span> <span class="o">==</span> <span class="s2">&quot;real&quot;</span><span class="p">:</span>
                        <span class="n">eigens_kpath</span> <span class="o">=</span> <span class="n">qp_corrs</span> <span class="k">if</span> <span class="n">only_corrections</span> <span class="k">else</span> <span class="n">ref_eigens</span> <span class="o">+</span> <span class="n">qp_corrs</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lw_kpath</span> <span class="o">=</span> <span class="n">qp_corrs</span>

                <span class="k">if</span> <span class="n">ks_ebands_kmesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Interpolate QP energies corrections and add them to KS</span>
                    <span class="n">ref_eigens</span> <span class="o">=</span> <span class="n">ks_ebands_kmesh</span><span class="o">.</span><span class="n">eigens</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">bstart</span><span class="p">:</span><span class="n">bstop</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">reim</span> <span class="o">==</span> <span class="s2">&quot;real&quot;</span><span class="p">:</span>
                        <span class="n">eigens_kmesh</span> <span class="o">=</span> <span class="n">skw</span><span class="o">.</span><span class="n">interp_kpts_and_enforce_degs</span><span class="p">(</span><span class="n">dos_kcoords</span><span class="p">,</span> <span class="n">ref_eigens</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">ks_degatol</span><span class="p">)</span><span class="o">.</span><span class="n">eigens</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">linewidths_kmesh</span> <span class="o">=</span> <span class="n">skw</span><span class="o">.</span><span class="n">interp_kpts</span><span class="p">(</span><span class="n">dos_kcoords</span><span class="p">)</span><span class="o">.</span><span class="n">eigens</span>

            <span class="n">interpolators_t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">skw_reim</span><span class="p">)</span>

            <span class="c1"># Build new ebands object with k-path.</span>
            <span class="n">kpts_kpath</span> <span class="o">=</span> <span class="n">Kpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">,</span> <span class="n">kfrac_coords</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">knames</span><span class="p">)</span>
            <span class="n">occfacts_kpath</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eigens_kpath</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

            <span class="c1"># Finding the new Fermi level of the interpolated bands is not trivial, in particular if metallic.</span>
            <span class="c1"># because one should first interpolate the QP bands on a mesh. Here I align the QP bands</span>
            <span class="c1"># at the HOMO of the KS bands.</span>
            <span class="n">homos</span> <span class="o">=</span> <span class="n">ks_ebands_kpath</span><span class="o">.</span><span class="n">homos</span> <span class="k">if</span> <span class="n">ks_ebands_kpath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">homos</span>
            <span class="n">qp_fermie</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">eigens_kpath</span><span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">spin</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">kidx</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">band</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">homos</span><span class="p">])</span>
            <span class="c1">#qp_fermie = self.ebands.fermie</span>
            <span class="c1">#qp_fermie = 0.0</span>

            <span class="n">newt</span> <span class="o">=</span> <span class="n">ElectronBands</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">kpts_kpath</span><span class="p">,</span> <span class="n">eigens_kpath</span><span class="p">,</span> <span class="n">qp_fermie</span><span class="p">,</span> <span class="n">occfacts_kpath</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">nelect</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">nspinor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">nspden</span><span class="p">,</span>
                                 <span class="n">smearing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">smearing</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="n">lw_kpath</span><span class="p">)</span>
            <span class="n">qp_ebands_kpath_t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newt</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ks_ebands_kmesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Interpolate QP corrections on the same k-mesh as the one used in the KS run.</span>
                <span class="n">ks_ebands_kmesh</span> <span class="o">=</span> <span class="n">ElectronBands</span><span class="o">.</span><span class="n">as_ebands</span><span class="p">(</span><span class="n">ks_ebands_kmesh</span><span class="p">)</span>

                <span class="c1"># Build new ebands object with k-mesh</span>
                <span class="n">kpts_kmesh</span> <span class="o">=</span> <span class="n">IrredZone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">,</span> <span class="n">dos_kcoords</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">dos_weights</span><span class="p">,</span>
                                       <span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ksampling</span><span class="o">=</span><span class="n">ks_ebands_kmesh</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">ksampling</span><span class="p">)</span>
                <span class="n">occfacts_kmesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eigens_kmesh</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

                <span class="n">newt</span> <span class="o">=</span> <span class="n">ElectronBands</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">kpts_kmesh</span><span class="p">,</span> <span class="n">eigens_kmesh</span><span class="p">,</span> <span class="n">qp_fermie</span><span class="p">,</span> <span class="n">occfacts_kmesh</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">nelect</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">nspinor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">nspden</span><span class="p">,</span>
                                     <span class="n">smearing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">smearing</span><span class="p">,</span><span class="n">linewidths</span><span class="o">=</span><span class="n">linewidths_kmesh</span><span class="p">)</span>
                <span class="n">qp_ebands_kmesh_t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newt</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">TdepElectronBands</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span><span class="p">[</span><span class="n">itemp_list</span><span class="p">],</span> <span class="n">ks_ebands_kpath</span><span class="p">,</span> <span class="n">qp_ebands_kpath_t</span><span class="p">,</span>
                                 <span class="n">ks_ebands_kmesh</span><span class="p">,</span> <span class="n">qp_ebands_kmesh_t</span><span class="p">,</span> <span class="n">interpolators_t</span><span class="p">)</span></div>

<div class="viewcode-block" id="SigEPhFile.plot_qpgaps_t"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.plot_qpgaps_t">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_qpgaps_t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qp_kpoints</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">qp_type</span><span class="o">=</span><span class="s2">&quot;qpz0&quot;</span><span class="p">,</span> <span class="n">ax_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_qpmks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the KS and the QP(T) direct gaps for all the k-points available in the SIGEPH file.</span>

<span class="sd">        Args:</span>
<span class="sd">            qp_kpoints: List of k-points in self-energy. Accept integers (list or scalars), list of vectors,</span>
<span class="sd">                or None to plot all k-points.</span>
<span class="sd">            qp_type: &quot;qpz0&quot; for linearized QP equation with Z factor at KS e0,</span>
<span class="sd">                     &quot;otms&quot; for on-the-mass-shell results.</span>
<span class="sd">            ax_list: List of |matplotlib-Axes| or None if a new figure should be created.</span>
<span class="sd">            plot_qpmks: If False, plot QP_gap, KS_gap else (QP_gap - KS_gap)</span>
<span class="sd">            fontsize: legend and title fontsize.</span>
<span class="sd">            kwargs: Passed to ax.plot method except for marker.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qpkinds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_qpkinds</span><span class="p">(</span><span class="n">qp_kpoints</span><span class="p">)</span>
        <span class="c1"># Build grid plot.</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qpkinds</span><span class="p">),</span> <span class="mi">1</span>
        <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="n">ax_list</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                                <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax_list</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">qp_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;qpz0&quot;</span><span class="p">,</span> <span class="s2">&quot;otms&quot;</span><span class="p">}:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid qp_type: `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="n">qp_type</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="p">((</span><span class="n">kpt</span><span class="p">,</span> <span class="n">ikc</span><span class="p">),</span> <span class="n">ax</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">qpkinds</span><span class="p">,</span> <span class="n">ax_list</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">plot_qpmks</span><span class="p">:</span>
                    <span class="c1"># Plot QP_{spin,kpt}(T)</span>
                    <span class="k">if</span> <span class="n">qp_type</span> <span class="o">==</span> <span class="s2">&quot;qpz0&quot;</span><span class="p">:</span> <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qp_dirgaps_t</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">qp_type</span> <span class="o">==</span> <span class="s2">&quot;otms&quot;</span><span class="p">:</span> <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qp_dirgaps_otms_t</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">]</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">marker_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="c1"># Add KS gap (assumed at T=0).</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ks_dirgaps</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">])</span> <span class="c1">#, label=&quot;KS gap %s&quot; % label)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Plot QP_{spin,kpt}(T) - KS_gap</span>
                    <span class="k">if</span> <span class="n">qp_type</span> <span class="o">==</span> <span class="s2">&quot;qpz0&quot;</span><span class="p">:</span> <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qp_dirgaps_t</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">qp_type</span> <span class="o">==</span> <span class="s2">&quot;otms&quot;</span><span class="p">:</span> <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qp_dirgaps_otms_t</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">]</span>

                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span><span class="p">,</span> <span class="n">values</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ks_dirgaps</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">],</span>
                            <span class="n">marker</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">marker_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ix</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">qpkinds</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Temperature (K)&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">plot_qpmks</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;QP - KS gap (eV)&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;QP direct gap (eV)&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;k:</span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">kpt</span><span class="p">),</span> <span class="n">qp_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">label</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="SigEPhFile.plot_qpdata_t"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.plot_qpdata_t">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_qpdata_t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the QP results as function T for a given (spin, k-point) and all bands.</span>

<span class="sd">        Args:</span>
<span class="sd">            spin: Spin index</span>
<span class="sd">            kpoint: K-point in self-energy. Accepts |Kpoint|, vector or index.</span>
<span class="sd">            band_list: List of band indices to be included. If None, all bands are shown.</span>
<span class="sd">            fontsize: legend and title fontsize.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Add more quantities DW, Fan(0)</span>
        <span class="c1"># Quantities to plot.</span>
        <span class="n">what_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;re_qpe&quot;</span><span class="p">,</span> <span class="s2">&quot;imag_qpe&quot;</span><span class="p">,</span> <span class="s2">&quot;ze0&quot;</span><span class="p">]</span>   <span class="c1"># &quot;re_fan0&quot;, &quot;imag_fan0&quot;, &quot;dw&quot;</span>

        <span class="c1"># Build grid plot.</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">what_list</span><span class="p">),</span> <span class="mi">1</span>
        <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                                <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax_list</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="c1"># Read all QPs for this (spin, kpoint) and all bands.</span>
        <span class="n">qp_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_qplist_sk</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ax_list</span><span class="p">,</span> <span class="n">what_list</span><span class="p">)):</span>
            <span class="c1"># Plot QP(T)</span>
            <span class="k">for</span> <span class="n">qp</span> <span class="ow">in</span> <span class="n">qp_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">band_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">qp</span><span class="o">.</span><span class="n">band</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">band_list</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">yvals</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">qp</span><span class="o">.</span><span class="n">tmesh</span><span class="p">,</span> <span class="n">yvals</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">marker_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">],</span>
                        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;band: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">qp</span><span class="o">.</span><span class="n">band</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">what</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ix</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">what_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Temperature [K]&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ix</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;title&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;QP results spin:</span><span class="si">%s</span><span class="s2">, k:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">qp_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">kpoint</span><span class="p">))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="SigEPhFile.qplist_spin"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.qplist_spin">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">qplist_spin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tuple of :class:`QpTempList` objects indexed by spin.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_allqps</span><span class="p">()</span></div>

<div class="viewcode-block" id="SigEPhFile.plot_qps_vs_e0"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.plot_qps_vs_e0">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_qps_vs_e0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">itemp_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_fields</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">reim</span><span class="o">=</span><span class="s2">&quot;real&quot;</span><span class="p">,</span>
                       <span class="n">function</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">exclude_fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span>
                       <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the QP results in the SIGEPH file as function of the initial KS energy.</span>

<span class="sd">        Args:</span>
<span class="sd">            itemp_list: List of integers to select a particular temperature. None means all</span>
<span class="sd">            with_fields: The names of the qp attributes to plot as function of e0.</span>
<span class="sd">                Accepts: List of strings or string with tokens separated by blanks.</span>
<span class="sd">                See :class:`QPState` for the list of available fields.</span>
<span class="sd">            reim: Plot the real or imaginary part</span>
<span class="sd">            function: Apply a function to the results before plotting</span>
<span class="sd">            exclude_fields: Similar to ``with_field`` but excludes fields.</span>
<span class="sd">            e0: Option used to define the zero of energy. Possible values:</span>
<span class="sd">                - `fermie`: shift energies to have zero energy at the Fermi level.</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">            ax_list: List of |matplotlib-Axes| for plot. If None, new figure is produced.</span>
<span class="sd">            colormap: matplotlib color map.</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                   or scalar e.g. ``left``. If left (right) is None, default values are used.</span>
<span class="sd">            ylims: Similar to xlims but for y-axis.</span>
<span class="sd">            fontsize: Legend and title fontsize.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fermie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qplist_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span><span class="o">.</span><span class="n">plot_vs_e0</span><span class="p">(</span><span class="n">itemp_list</span><span class="o">=</span><span class="n">itemp_list</span><span class="p">,</span>
                <span class="n">with_fields</span><span class="o">=</span><span class="n">with_fields</span><span class="p">,</span> <span class="n">reim</span><span class="o">=</span><span class="n">reim</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="n">function</span><span class="p">,</span> <span class="n">exclude_fields</span><span class="o">=</span><span class="n">exclude_fields</span><span class="p">,</span> <span class="n">fermie</span><span class="o">=</span><span class="n">fermie</span><span class="p">,</span>
                <span class="n">colormap</span><span class="o">=</span><span class="n">colormap</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="n">xlims</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="n">ylims</span><span class="p">,</span> <span class="n">ax_list</span><span class="o">=</span><span class="n">ax_list</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">marker_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">],</span>
                <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">ax_list</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span>

        <span class="c1">#for ix, ax in enumerate(ax_list):</span>
        <span class="c1">#    if ix != 0:</span>
        <span class="c1">#        set_visible(ax, False, &quot;legend&quot;)</span>
        <span class="c1">#    else:</span>
        <span class="c1">#        ax.legend(loc=&quot;best&quot;, fontsize=fontsize, shadow=True)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="SigEPhFile.plot_qpbands_ibzt"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.plot_qpbands_ibzt">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_qpbands_ibzt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">itemp_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the KS band structure in the IBZ with the QP(T) energies.</span>

<span class="sd">        Args:</span>
<span class="sd">            itemp_list: List of integers to select a particular temperature. None for all</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot.</span>
<span class="sd">            colormap: matplotlib color map.</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                   or scalar e.g. ``left``. If left (right) is None, default values are used.</span>
<span class="sd">            fontsize: Legend and title fontsize.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">itemp_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span><span class="p">))</span> <span class="k">if</span> <span class="n">itemp_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">duck</span><span class="o">.</span><span class="n">list_ints</span><span class="p">(</span><span class="n">itemp_list</span><span class="p">)</span>

        <span class="c1"># TODO: It seems there&#39;s a minor issue with fermie if SCF band structure.</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">get_e0</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
        <span class="c1">#print(&quot;e0&quot;,e0, self.ebands.fermie)</span>

        <span class="c1"># Build grid with (1, nsppol) plots.</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span>
        <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                                <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax_list</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>

        <span class="c1"># Read QP energies: nctkarr_t(&quot;qp_enes&quot;, &quot;dp&quot;, &quot;two, ntemp, max_nbcalc, nkcalc, nsppol&quot;)</span>
        <span class="n">qpes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;qp_enes&quot;</span><span class="p">,</span> <span class="n">cmode</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_eV</span>
        <span class="n">band_range</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">max_bstart</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">min_bstop</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">spin</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">),</span> <span class="n">ax_list</span><span class="p">):</span>
            <span class="c1"># Plot KS bands in the band range included in self-energy calculation.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="n">e0</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span> <span class="n">band_range</span><span class="o">=</span><span class="n">band_range</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># Add (scattered) QP(T) energies for the calculated k-points.</span>
            <span class="k">for</span> <span class="n">itemp</span> <span class="ow">in</span> <span class="n">itemp_list</span><span class="p">:</span>
                <span class="n">yvals</span> <span class="o">=</span> <span class="n">qpes</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">itemp</span><span class="p">]</span><span class="o">.</span><span class="n">real</span> <span class="o">-</span> <span class="n">e0</span>
                <span class="k">for</span> <span class="n">ib</span><span class="p">,</span><span class="n">band</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">*</span><span class="n">band_range</span><span class="p">)):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kcalc2ibz</span><span class="p">,</span> <span class="n">yvals</span><span class="p">[:,</span> <span class="n">ib</span><span class="p">],</span>
                        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;T = </span><span class="si">%.1f</span><span class="s2"> K&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span> <span class="k">if</span> <span class="n">band</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">itemp</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="SigEPhFile.plot_lws_vs_e0"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.plot_lws_vs_e0">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_lws_vs_e0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rta_type</span><span class="o">=</span><span class="s2">&quot;serta&quot;</span><span class="p">,</span> <span class="n">itemp_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot phonon-induced linewidths vs KS energy for different temperatures.</span>

<span class="sd">        Args:</span>
<span class="sd">            rta_type: &quot;serta&quot; for SERTA linewidths or &quot;mrta&quot; for MRTA linewidths.</span>
<span class="sd">            itemp_list: List of temperature indices to interpolate. None for all.</span>
<span class="sd">            ax: |matplotlib-Axes| or None if a new figure should be created.</span>
<span class="sd">            colormap: matplotlib color map.</span>
<span class="sd">            fontsize: fontsize for titles and legend.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="n">itemp_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span><span class="p">))</span> <span class="k">if</span> <span class="n">itemp_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">duck</span><span class="o">.</span><span class="n">list_ints</span><span class="p">(</span><span class="n">itemp_list</span><span class="p">)</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>
        <span class="c1">#if &quot;markersize&quot; not in kwargs: kwargs[&quot;markersize&quot;] = 4</span>

        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span>
        <span class="n">ks_enes</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;ks_enes&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_eV</span>

        <span class="k">if</span> <span class="n">rta_type</span> <span class="o">==</span> <span class="s2">&quot;serta&quot;</span><span class="p">:</span>
            <span class="n">lws_arr</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;vals_e0ks&quot;</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">rta_type</span> <span class="o">==</span> <span class="s2">&quot;mrta&quot;</span><span class="p">:</span>
            <span class="n">lws_arr</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;linewidth_mrta&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid rta_type: `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="n">rta_type</span><span class="p">)</span>

        <span class="n">ks_list</span><span class="p">,</span> <span class="n">lws</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">itemp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">itemp_list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">kpoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">):</span>
                    <span class="n">nb</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">nbcalc_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">it</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ks_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ks_enes</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="p">:</span><span class="n">nb</span><span class="p">])</span>
                    <span class="n">lws</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lws_arr</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="p">:</span><span class="n">nb</span><span class="p">,</span> <span class="n">itemp</span><span class="p">])</span>

        <span class="n">nt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">itemp_list</span><span class="p">)</span>
        <span class="n">ks_enes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ks_list</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">lws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lws</span><span class="p">),</span> <span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">marker</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;marker&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
        <span class="n">kw_color</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kw_label</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
            <span class="n">spin_sign</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">xs</span> <span class="o">=</span> <span class="n">ks_enes</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">itemp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">itemp_list</span><span class="p">):</span>
                <span class="n">ys</span> <span class="o">=</span> <span class="n">spin_sign</span> <span class="o">*</span> <span class="n">lws</span><span class="p">[</span><span class="n">it</span><span class="p">,</span> <span class="n">spin</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span>
                           <span class="n">label</span><span class="o">=</span><span class="n">kw_label</span> <span class="k">if</span> <span class="n">kw_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span>
                                 <span class="p">(</span><span class="s2">&quot;T = </span><span class="si">%.1f</span><span class="s2"> K&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),</span>
                           <span class="n">color</span><span class="o">=</span><span class="n">kw_color</span> <span class="k">if</span> <span class="n">kw_color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cmap</span><span class="p">(</span><span class="n">itemp</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span><span class="p">),</span>
                           <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Energy (eV)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Linewidth&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">rta_type</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="SigEPhFile.plot_tau_vtau"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.plot_tau_vtau">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_tau_vtau</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rta_type</span><span class="o">=</span><span class="s2">&quot;serta&quot;</span><span class="p">,</span> <span class="n">itemp_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot transport lifetimes, group velocities and mean free path (v * tau).</span>
<span class="sd">        as a function of the KS energy for a given relaxation time approximation.</span>

<span class="sd">        Args:</span>
<span class="sd">            rta_type: &quot;serta&quot; for SERTA linewidths or &quot;mrta&quot; for MRTA linewidths.</span>
<span class="sd">            itemp_list: List of temperature indices to interpolate. None for all.</span>
<span class="sd">            ax_list: List of |matplotlib-Axes| for plot. If None, new figure is produced.</span>
<span class="sd">            colormap: matplotlib color map.</span>
<span class="sd">            fontsize: fontsize for titles and legend.</span>
<span class="sd">            kwargs: Optional Keyword arguments.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">itemp_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span><span class="p">))</span> <span class="k">if</span> <span class="n">itemp_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">duck</span><span class="o">.</span><span class="n">list_ints</span><span class="p">(</span><span class="n">itemp_list</span><span class="p">)</span>

        <span class="c1"># Build grid with (3, 1) plots.</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span>
        <span class="n">ax_mat</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="n">ax_list</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                               <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>

        <span class="c1"># Read data from netcdf file:</span>
        <span class="c1">#</span>
        <span class="c1"># KS energies for nk states in Sigma_nk in Hartree units.</span>
        <span class="c1"># nctkarr_t(&quot;ks_enes&quot;, &quot;dp&quot;, &quot;max_nbcalc, nkcalc, nsppol&quot;)</span>
        <span class="c1">#</span>
        <span class="c1"># Diagonal elements of velocity operator in cartesian coordinates for all states in Sigma_nk.</span>
        <span class="c1"># nctkarr_t(&quot;vcar_calc&quot;, &quot;dp&quot;, &quot;three, max_nbcalc, nkcalc, nsppol&quot;)]))</span>
        <span class="c1">#</span>
        <span class="c1"># Diagonal matrix elements of self-energy in the KS basis set (imag gives SERTA linewidths)</span>
        <span class="c1"># nctkarr_t(&quot;vals_e0ks&quot;, &quot;dp&quot;, &quot;two, ntemp, max_nbcalc, nkcalc, nsppol&quot;)</span>
        <span class="c1">#</span>
        <span class="c1"># lifetimes with MRTA</span>
        <span class="c1"># nctkarr_t(&quot;linewidth_mrta&quot;, &quot;dp&quot;, &quot;ntemp, max_nbcalc, nkcalc, nsppol&quot;)</span>

        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span>
        <span class="n">ks_enes</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;ks_enes&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_eV</span>
        <span class="n">vcart</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;vcar_calc&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rta_type</span> <span class="o">==</span> <span class="s2">&quot;serta&quot;</span><span class="p">:</span>
            <span class="n">lws</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;vals_e0ks&quot;</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">rta_type</span> <span class="o">==</span> <span class="s2">&quot;mrta&quot;</span><span class="p">:</span>
            <span class="n">lws</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;linewidth_mrta&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid rta_type: `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="n">rta_type</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">taus_from_lw</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Return transport lifetime from linewidth.&quot;&quot;&quot;</span>
            <span class="c1"># TODO: times conversion fact!</span>
            <span class="n">asimag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
            <span class="n">asimag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">asimag</span> <span class="o">&gt;</span> <span class="mf">1e-8</span><span class="p">,</span> <span class="n">asimag</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">)</span>
            <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">asimag</span><span class="p">)</span>

        <span class="n">ks_list</span><span class="p">,</span> <span class="n">vels</span><span class="p">,</span> <span class="n">taus</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">itemp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">itemp_list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">kpoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">):</span>
                    <span class="n">nb</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">nbcalc_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">it</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ks_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ks_enes</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="p">:</span><span class="n">nb</span><span class="p">])</span>
                    <span class="n">taus</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">taus_from_lw</span><span class="p">(</span><span class="n">lws</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="p">:</span><span class="n">nb</span><span class="p">,</span> <span class="n">itemp</span><span class="p">]))</span>
                    <span class="n">vels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vcart</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="p">:</span><span class="n">nb</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">nt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">itemp_list</span><span class="p">)</span>
        <span class="n">ks_enes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ks_list</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">taus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">taus</span><span class="p">),</span> <span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">vels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vels</span><span class="p">),</span> <span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
             <span class="mi">0</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">vals</span><span class="o">=</span><span class="n">taus</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\tau}$&quot;</span><span class="p">),</span>
             <span class="mi">1</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">vals</span><span class="o">=</span><span class="n">vels</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$v$&quot;</span><span class="p">),</span>
             <span class="mi">2</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">vals</span><span class="o">=</span><span class="n">vels</span> <span class="o">*</span> <span class="n">taus</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$v\,\tau$&quot;</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ax_mat</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                <span class="n">spin_sign</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">xs</span> <span class="o">=</span> <span class="n">ks_enes</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">itemp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">itemp_list</span><span class="p">):</span>
                    <span class="n">ys</span> <span class="o">=</span> <span class="n">spin_sign</span> <span class="o">*</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;vals&quot;</span><span class="p">][</span><span class="n">it</span><span class="p">,</span> <span class="n">spin</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span>
                               <span class="n">label</span><span class="o">=</span><span class="s2">&quot;T = </span><span class="si">%.1f</span><span class="s2"> K&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">ix</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">itemp</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">),</span>
                               <span class="n">marker</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;marker&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">ix</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax_mat</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Energy (eV)&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;ylabel&quot;</span><span class="p">])</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ix</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">rta_type</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="SigEPhFile.plot_qpsolution_skb"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.plot_qpsolution_skb">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_qpsolution_skb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">itemp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">with_int_aw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">ax_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Graphical representation of the QP solution(s) along the real axis including the</span>
<span class="sd">        approximated solution obtained with the linearized equation and the on-the-mass-shell approach.</span>

<span class="sd">        Produce two subplots:</span>
<span class="sd">            1. Re/Imag part and intersection with omega - eKs</span>
<span class="sd">            2. A(w) + int^w A(w&#39;)dw&#39; + OTMS</span>

<span class="sd">        Args:</span>
<span class="sd">            spin: Spin index (C convention, i.e &gt;= 0).</span>
<span class="sd">            kpoint: K-point in self-energy. Accepts |Kpoint|, vector or integer defined the k-point in the kcalc array</span>
<span class="sd">            band: band index. C convention so decremented by -1 wrt Fortran index.</span>
<span class="sd">            itemp: Temperature index.</span>
<span class="sd">            with_int_aw: Plot cumulative integral of A(w).</span>
<span class="sd">            ax_list: List of |matplotlib-Axes|. If None, new figure is produced.</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                or scalar e.g. ``left``. If left (right) is None, default values are used.</span>
<span class="sd">            fontsize: legend and label fontsize.</span>
<span class="sd">            kwargs: Keyword arguments passed to ax.plot</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sigeph_skb</span><span class="p">(</span><span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="o">=</span><span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sigma</span><span class="o">.</span><span class="n">plot_qpsolution</span><span class="p">(</span><span class="n">itemp</span><span class="o">=</span><span class="n">itemp</span><span class="p">,</span> <span class="n">with_int_aw</span><span class="o">=</span><span class="n">with_int_aw</span><span class="p">,</span>
                                     <span class="n">ax_list</span><span class="o">=</span><span class="n">ax_list</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="n">xlims</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="SigEPhFile.plot_qpsolution_sk"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.plot_qpsolution_sk">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_qpsolution_sk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">itemp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">with_int_aw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">ax_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Produce grid of plots with graphical representation of the QP solution(s) along the real axis</span>
<span class="sd">        for all computed bands at given spin and kpoint. See also plot_qpsolution_skb</span>

<span class="sd">        Args:</span>
<span class="sd">            spin: Spin index (C convention, i.e &gt;= 0).</span>
<span class="sd">            kpoint: K-point in self-energy. Accepts |Kpoint|, vector or integer defined the k-point in the kcalc array</span>
<span class="sd">            band: band index. C convention so decremented by -1 wrt Fortran index.</span>
<span class="sd">            itemp: Temperature index.</span>
<span class="sd">            with_int_aw: Plot cumulative integral of A(w).</span>
<span class="sd">            ax_list: List of |matplotlib-Axes|. If None, new figure is produced.</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                or scalar e.g. ``left``. If left (right) is None, default values are used.</span>
<span class="sd">            fontsize: legend and label fontsize.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ikc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">sigkpt2index</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span>
        <span class="n">bmin</span><span class="p">,</span> <span class="n">bmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstart_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstop_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">]</span>

        <span class="c1"># Build grid plot.</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="p">(</span><span class="n">bmax</span> <span class="o">-</span> <span class="n">bmin</span><span class="p">),</span> <span class="mi">2</span>
        <span class="n">ax_mat</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                               <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ib</span><span class="p">,</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">bmin</span> <span class="p">,</span><span class="n">bmax</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_qpsolution_skb</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">itemp</span><span class="o">=</span><span class="n">itemp</span><span class="p">,</span> <span class="n">with_int_aw</span><span class="o">=</span><span class="n">with_int_aw</span><span class="p">,</span>
                                     <span class="n">ax_list</span><span class="o">=</span><span class="n">ax_mat</span><span class="p">[</span><span class="n">ib</span><span class="p">],</span> <span class="n">xlims</span><span class="o">=</span><span class="n">xlims</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ib</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">ax_mat</span><span class="p">[</span><span class="n">ib</span><span class="p">]:</span>
                    <span class="n">set_visible</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;legend&quot;</span><span class="p">,</span> <span class="s2">&quot;xlabel&quot;</span><span class="p">,</span> <span class="s2">&quot;ylabel&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="SigEPhFile.plot_qpsolution_sklineb"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.plot_qpsolution_sklineb">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_qpsolution_sklineb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kbounds</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">itemp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">with_int_aw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dist_tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
                                <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Produce grid of plots with graphical representation of the QP solution(s) along the real axis</span>
<span class="sd">        given spin and band and all (computed) kpoints along the segment defined by kbounds.</span>
<span class="sd">        See also plot_qpsolution_skb</span>

<span class="sd">        Args:</span>
<span class="sd">            spin: Spin index (C convention, i.e &gt;= 0).</span>
<span class="sd">            kbounds: List of two items defining the segment in k-space.</span>
<span class="sd">                Accept two strings with the name of the k-points e.g. [&quot;G&quot;, &quot;X&quot;] where G stands for Gamma</span>
<span class="sd">                or two vectors with fractional coords e.g. [[0,0,0], [0.5,0,0]]</span>
<span class="sd">            band: band index. C convention so decremented by -1 wrt Fortran index.</span>
<span class="sd">            itemp: Temperature index.</span>
<span class="sd">            with_int_aw: Plot cumulative integral of A(w).</span>
<span class="sd">            dist_tol: A point is considered to be on the path if its distance from the line</span>
<span class="sd">                is less than dist_tol.</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                or scalar e.g. ``left``. If left (right) is None, default values are used.</span>
<span class="sd">            fontsize: legend and label fontsize.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">kbounds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;kbounds must contain 2 items. Got `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">kbounds</span><span class="p">))</span>

        <span class="c1"># Find kpoints in self.kcalc along input segment.</span>
        <span class="n">cart_bounds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">duck</span><span class="o">.</span><span class="n">is_string</span><span class="p">(</span><span class="n">kbounds</span><span class="p">[</span><span class="n">ik</span><span class="p">]):</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">Kpoint</span><span class="o">.</span><span class="n">from_name_and_structure</span><span class="p">(</span><span class="n">kbounds</span><span class="p">[</span><span class="n">ik</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Assume frac_coords</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">Kpoint</span><span class="p">(</span><span class="n">kbounds</span><span class="p">[</span><span class="n">ik</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">)</span>
            <span class="n">cart_bounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">cart_coords</span><span class="p">)</span>
        <span class="n">cart_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cart_bounds</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

        <span class="c1"># r.ikfound is a numpy array with the indices of the points lying on the path. Empty if no point is found.</span>
        <span class="c1"># Points are already ordered according to the distance along the path.</span>
        <span class="n">cart_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="o">.</span><span class="n">get_cart_coords</span><span class="p">()</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">find_points_along_path</span><span class="p">(</span><span class="n">cart_bounds</span><span class="p">,</span> <span class="n">cart_coords</span><span class="p">,</span> <span class="n">dist_tol</span><span class="o">=</span><span class="n">dist_tol</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">ikfound</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot find k-points in Sigma_nk along segment: `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">kbounds</span><span class="p">))</span>

        <span class="c1"># Build grid plot.</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">ikfound</span><span class="p">),</span> <span class="mi">2</span>
        <span class="n">ax_mat</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                               <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">ikcalc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">ikfound</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_qpsolution_skb</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikcalc</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">itemp</span><span class="o">=</span><span class="n">itemp</span><span class="p">,</span> <span class="n">with_int_aw</span><span class="o">=</span><span class="n">with_int_aw</span><span class="p">,</span>
                                     <span class="n">ax_list</span><span class="o">=</span><span class="n">ax_mat</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span> <span class="n">xlims</span><span class="o">=</span><span class="n">xlims</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="SigEPhFile.plot_a2fw_skb"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.plot_a2fw_skb">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_a2fw_skb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;meV&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the Eliashberg function a2F_{n,k,spin}(w) (gkq2/Fan-Migdal/DW/Total contribution)</span>
<span class="sd">        for a given (spin, kpoint, band)</span>

<span class="sd">        Args:</span>
<span class="sd">            spin: Spin index</span>
<span class="sd">            kpoint: K-point in self-energy. Accepts |Kpoint|, vector or integer defined the k-point in the kcalc array</span>
<span class="sd">            band: band index. C convention so decremented by -1 wrt Fortran index.</span>
<span class="sd">            what: fandw for FAN, DW. gkq2 for $|gkq|^2$. Auto for automatic selection based on imag_only</span>
<span class="sd">            units: Units for phonon plots. Possible values in (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;). Case-insensitive.</span>
<span class="sd">            ax: |matplotlib-Axes| or None if a new figure should be created.</span>
<span class="sd">            fontsize: legend and title fontsize.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_eliashberg_function</span><span class="p">:</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;SIGEPH file does not have Eliashberg function&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
            <span class="n">what</span> <span class="o">=</span> <span class="s2">&quot;gkq2&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imag_only</span> <span class="k">else</span> <span class="s2">&quot;fandw&quot;</span>

        <span class="n">a2f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_a2feph_skb</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">a2f</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="n">what</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="SigEPhFile.plot_a2fw_skb_sum"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.plot_a2fw_skb_sum">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_a2fw_skb_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the sum of the Eliashberg functions a2F_{n,k,spin}(w) (gkq2/Fan-Migdal/DW/Total contribution)</span>
<span class="sd">        over the k-points and bands for which self-energy matrix elements have been computed.</span>

<span class="sd">       .. note::</span>

<span class="sd">            This quantity is supposed to give a qualitative</span>
<span class="sd">            The value indeed is not an integral in the BZ, besides the absolute value depends</span>
<span class="sd">            on the number of bands in the self-energy.</span>

<span class="sd">        Args:</span>
<span class="sd">            what: fandw for FAN, DW. gkq2 for $|gkq|^2$. Auto for automatic selection based on imag_only</span>
<span class="sd">            ax: |matplotlib-Axes| or None if a new figure should be created.</span>
<span class="sd">            exchange_xy: True to exchange x-y axis.</span>
<span class="sd">            fontsize: legend and title fontsize.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_eliashberg_function</span><span class="p">:</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;SIGEPH file does not have Eliashberg function&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
            <span class="n">what</span> <span class="o">=</span> <span class="s2">&quot;gkq2&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imag_only</span> <span class="k">else</span> <span class="s2">&quot;fandw&quot;</span>

        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># nctkarr_t(&quot;gfw_mesh&quot;, &quot;dp&quot;, &quot;gfw_nomega&quot;)</span>
        <span class="c1"># nctkarr_t(&quot;gfw_vals&quot;, &quot;dp&quot;, &quot;gfw_nomega, three, max_nbcalc, nkcalc, nsppol&quot;)</span>
        <span class="c1"># 1:   gkk^2 with delta(en - em)</span>
        <span class="c1"># 2:3 (Fan-Migdal/DW contribution)</span>
        <span class="c1"># Access arrays directly instead of using read_a2feph_skb because it&#39;s gonna be faster.</span>
        <span class="c1">#a2f = self.reader.read_a2feph_skb(spin, kpoint, band)</span>
        <span class="n">wmesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;gfw_mesh&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_eV</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;gfw_vals&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_eV</span> <span class="c1"># TODO check units</span>

        <span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;Energy (eV)&quot;</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
            <span class="n">asum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">gfw_nomega</span><span class="p">)</span>
            <span class="n">spin_sign</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">kpoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">):</span>
                <span class="c1"># This is not an integral in the BZ.</span>
                <span class="n">wtk</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bstart_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstop_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;gkq2&quot;</span><span class="p">:</span>
                        <span class="n">vs</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                        <span class="n">ylabel</span> <span class="o">=</span> <span class="n">what</span>
                    <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;fandw&quot;</span><span class="p">:</span>
                        <span class="n">vs</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">ylabel</span> <span class="o">=</span> <span class="n">what</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid value for what: `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="n">what</span><span class="p">)</span>
                    <span class="n">asum</span> <span class="o">+=</span> <span class="p">(</span><span class="n">spin_sign</span> <span class="o">*</span> <span class="n">wtk</span><span class="p">)</span> <span class="o">*</span> <span class="n">vs</span>

            <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">wmesh</span><span class="p">,</span> <span class="n">asum</span>
            <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">ys</span><span class="p">,</span> <span class="n">xs</span>

            <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span> <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;red&quot;</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">set_ax_xylabels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="p">)</span>

        <span class="c1">#ax.legend(loc=&quot;best&quot;, fontsize=fontsize, shadow=True)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="c1">#@add_fig_kwargs</span>
    <span class="c1">#def plot_sigeph_vcbm(self, units=&quot;meV&quot;, sharey=True, fontsize=8, **kwargs):</span>

<div class="viewcode-block" id="SigEPhFile.plot_a2fw_all"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.plot_a2fw_all">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_a2fw_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;meV&quot;</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the Eliashberg function a2F_{n,k,spin}(w) (gkq2/Fan-Migdal/DW/Total contribution)</span>
<span class="sd">        for all k-points, spin and the VBM/CBM for these k-points.</span>

<span class="sd">        Args:</span>
<span class="sd">            units: Units for phonon plots. Possible values in (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;).</span>
<span class="sd">                Case-insensitive.</span>
<span class="sd">            what: fandw for FAN, DW. gkq2 for $|gkq|^2$. Auto for automatic selection based on imag_only</span>
<span class="sd">            sharey: True if Y axes should be shared.</span>
<span class="sd">            fontsize: legend and title fontsize.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Build plot grid with (CBM, VBM) on each col. k-points along rows</span>
        <span class="n">num_plots</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">nrows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkcalc</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkcalc</span>

        <span class="n">ax_mat</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                              <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">sharey</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">marker_spin</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;v&quot;</span><span class="p">}</span>
        <span class="n">count</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
            <span class="n">what</span> <span class="o">=</span> <span class="s2">&quot;gkq2&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imag_only</span> <span class="k">else</span> <span class="s2">&quot;fandw&quot;</span>

        <span class="k">for</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">kpoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># Assume non magnetic semiconductor.</span>
                <span class="n">iv</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nelect</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">ax_mat</span><span class="p">[</span><span class="n">ikc</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_a2fw_skb</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">iv</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="n">what</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;k:</span><span class="si">%s</span><span class="s2">, band:</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">kpoint</span><span class="p">),</span> <span class="n">iv</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">ax_mat</span><span class="p">[</span><span class="n">ikc</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_a2fw_skb</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">iv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="n">what</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;k:</span><span class="si">%s</span><span class="s2">, band:</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">kpoint</span><span class="p">),</span> <span class="n">iv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">ax_mat</span><span class="p">[</span><span class="n">ikc</span><span class="p">]:</span>
                        <span class="n">set_visible</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;legend&quot;</span><span class="p">)</span>

        <span class="c1"># Show legend only for the first ax.</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ax_mat</span><span class="o">.</span><span class="n">ravel</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">set_visible</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;legend&quot;</span><span class="p">)</span>

        <span class="c1"># Show x(y)labels only if first column (last row)</span>
        <span class="k">for</span> <span class="n">irow</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrows</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">icol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">ax_mat</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="n">icol</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">icol</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">set_visible</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;ylabel&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">irow</span> <span class="o">!=</span> <span class="n">nrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span> <span class="n">set_visible</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;xlabel&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="SigEPhFile.get_panel"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.get_panel">[docs]</a>    <span class="k">def</span> <span class="nf">get_panel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build panel with widgets to interact with the |SigEPhFile| either in a notebook or in panel app.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">abipy.panels.sigeph</span> <span class="kn">import</span> <span class="n">SigEPhFilePanel</span>
        <span class="k">return</span> <span class="n">SigEPhFilePanel</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_panel</span><span class="p">()</span></div>

<div class="viewcode-block" id="SigEPhFile.yield_figs"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.yield_figs">[docs]</a>    <span class="k">def</span> <span class="nf">yield_figs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function *generates* a predefined list of matplotlib figures with minimal input from the user.</span>
<span class="sd">        Used in abiview.py to get a quick look at the results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imag_only</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rta_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;serta&quot;</span><span class="p">,</span> <span class="s2">&quot;mrta&quot;</span><span class="p">):</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_lws_vs_e0</span><span class="p">(</span><span class="n">rta_type</span><span class="o">=</span><span class="n">rta_type</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_tau_vtau</span><span class="p">(</span><span class="n">rta_type</span><span class="o">=</span><span class="n">rta_type</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_qpbands_ibzt</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1">#yield self.plot_qpgaps_t(qp_kpoints=0, show=False)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">qp_kpt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File contains more than 3 k-points. Only the first three k-points are displayed.&quot;</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_qpgaps_t</span><span class="p">(</span><span class="n">qp_kpoints</span><span class="o">=</span><span class="n">qp_kpt</span><span class="p">,</span> <span class="n">qp_type</span><span class="o">=</span><span class="s2">&quot;qpz0&quot;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_qpgaps_t</span><span class="p">(</span><span class="n">qp_kpoints</span><span class="o">=</span><span class="n">qp_kpt</span><span class="p">,</span> <span class="n">qp_type</span><span class="o">=</span><span class="s2">&quot;otms&quot;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_qps_vs_e0</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">edos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">edos</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="SigEPhFile.write_notebook"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhFile.write_notebook">[docs]</a>    <span class="k">def</span> <span class="nf">write_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a jupyter_ notebook to ``nbpath``. If nbpath is None, a temporay file in the current</span>
<span class="sd">        working directory is created. Return path to the notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbformat</span><span class="p">,</span> <span class="n">nbv</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nbformat_nbv_nb</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>

        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;ncfile = abilab.abiopen(&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;print(ncfile)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;ncfile.ebands.plot(with_gaps=True);&quot;</span><span class="p">),</span>
            <span class="c1">#nbv.new_code_cell(&quot;ncfile.get_dirgaps_dataframe(kpoint=0)&quot;),</span>
            <span class="c1">#nbv.new_code_cell(&quot;ncfile.get_dataframe(kpoint=0)&quot;),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;ncfile.plot_qpgaps_t(qptype=&#39;qpz0&#39;);&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;ncfile.plot_qpgaps_t(qptype=&#39;otms&#39;);&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;#ncfile.plot_qpgaps_t(plot_qpmks=True);&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;ncfile.plot_qps_vs_e0();&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">for spin in range(ncfile.nsppol):</span>
<span class="s2">    for sigma_kpoint in ncfile.sigma_kpoints:</span>
<span class="s2">        ncfile.plot_qpdata_t(spin, sigma_kpoint, band_list=None, fontsize=12);&quot;&quot;&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;#ncfile.get_dataframe_sk(spin=0, kpoint=(0, 0, 0))&quot;</span><span class="p">),</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_nb_nbpath</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nbpath</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="SigEPhRobot"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhRobot">[docs]</a><span class="k">class</span> <span class="nc">SigEPhRobot</span><span class="p">(</span><span class="n">Robot</span><span class="p">,</span> <span class="n">RobotWithEbands</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This robot analyzes the results contained in multiple SIGEPH.nc files.</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: SigEPhRobot</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Try to have API similar to SigresRobot</span>
    <span class="n">EXT</span> <span class="o">=</span> <span class="s2">&quot;SIGEPH&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="k">return</span>

        <span class="c1"># Check dimensions and self-energy states and issue warning.</span>
        <span class="n">warns</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">wapp</span> <span class="o">=</span> <span class="n">warns</span><span class="o">.</span><span class="n">append</span>
        <span class="n">nc0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">same_nsppol</span><span class="p">,</span> <span class="n">same_nkcalc</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">nc</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">!=</span> <span class="n">nc0</span><span class="o">.</span><span class="n">nsppol</span> <span class="k">for</span> <span class="n">nc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">):</span>
            <span class="n">same_nsppol</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">wapp</span><span class="p">(</span><span class="s2">&quot;Comparing ncfiles with different values of nsppol.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">nc</span><span class="o">.</span><span class="n">nkcalc</span> <span class="o">!=</span> <span class="n">nc0</span><span class="o">.</span><span class="n">nkcalc</span> <span class="k">for</span> <span class="n">nc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">):</span>
            <span class="n">same_nkcalc</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">wapp</span><span class="p">(</span><span class="s2">&quot;Comparing ncfiles with different number of k-points in self-energy. Doh!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">same_nsppol</span> <span class="ow">and</span> <span class="n">same_nkcalc</span><span class="p">:</span>
            <span class="c1"># FIXME</span>
            <span class="c1"># Different values of bstart_ks are difficult to handle</span>
            <span class="c1"># Because the high-level API assumes an absolute global index</span>
            <span class="c1"># Should decide how to treat this case: either raise or interpret band as an absolute band index.</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">nc</span><span class="o">.</span><span class="n">bstart_sk</span> <span class="o">!=</span> <span class="n">nc0</span><span class="o">.</span><span class="n">bstart_sk</span><span class="p">)</span> <span class="k">for</span> <span class="n">nc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">):</span>
                <span class="n">wapp</span><span class="p">(</span><span class="s2">&quot;Comparing ncfiles with different values of bstart_sk&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">nc</span><span class="o">.</span><span class="n">bstop_sk</span> <span class="o">!=</span> <span class="n">nc0</span><span class="o">.</span><span class="n">bstop_sk</span><span class="p">)</span> <span class="k">for</span> <span class="n">nc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">):</span>
                <span class="n">wapp</span><span class="p">(</span><span class="s2">&quot;Comparing ncfiles with different values of bstop_sk&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">warns</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">warns</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;yellow&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_dims_and_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test that nsppol, sigma_kpoints, tlist are consistent.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">nc0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">eapp</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">append</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">nc</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">!=</span> <span class="n">nc0</span><span class="o">.</span><span class="n">nsppol</span> <span class="k">for</span> <span class="n">nc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="n">eapp</span><span class="p">(</span><span class="s2">&quot;Files with different values of `nsppol`&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">nc</span><span class="o">.</span><span class="n">nkcalc</span> <span class="o">!=</span> <span class="n">nc0</span><span class="o">.</span><span class="n">nkcalc</span> <span class="k">for</span> <span class="n">nc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="n">eapp</span><span class="p">(</span><span class="s2">&quot;Files with different values of `nkcalc`&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">nc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="k">for</span> <span class="n">k0</span><span class="p">,</span> <span class="n">k1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">nc0</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">,</span> <span class="n">nc</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">k0</span> <span class="o">!=</span> <span class="n">k1</span><span class="p">:</span>
                        <span class="n">eapp</span><span class="p">(</span><span class="s2">&quot;Files with different values of `sigma_kpoints`&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">nc</span><span class="o">.</span><span class="n">tmesh</span><span class="p">,</span> <span class="n">nc0</span><span class="o">.</span><span class="n">tmesh</span><span class="p">)</span> <span class="k">for</span> <span class="n">nc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="n">eapp</span><span class="p">(</span><span class="s2">&quot;Files with different tmesh&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot compare multiple SIGEPH.nc files. Reason:</span><span class="se">\n</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">))</span>

<div class="viewcode-block" id="SigEPhRobot.get_dataframe_sk"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhRobot.get_dataframe_sk">[docs]</a>    <span class="k">def</span> <span class="nf">get_dataframe_sk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">with_params</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_imag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return |pandas-Dataframe| with QP results for this spin, k-point</span>

<span class="sd">        Args:</span>
<span class="sd">            spin: Spin index</span>
<span class="sd">            kpoint: K-point in self-energy. Accepts |Kpoint|, vector or index.</span>
<span class="sd">            with_params: True to add convergence parameters.</span>
<span class="sd">            ignore_imag: only real part is returned if ``ignore_imag``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df_list</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">df_list</span><span class="o">.</span><span class="n">append</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">ncfile</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">get_dataframe_sk</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                         <span class="n">with_params</span><span class="o">=</span><span class="n">with_params</span><span class="p">,</span> <span class="n">ignore_imag</span><span class="o">=</span><span class="n">ignore_imag</span><span class="p">)</span>
            <span class="n">app</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="SigEPhRobot.get_dirgaps_dataframe"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhRobot.get_dirgaps_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">get_dirgaps_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">itemp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">with_params</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns |pandas-DataFrame| with QP direct gaps at the given k-point for all the files in the robot</span>

<span class="sd">        Args:</span>
<span class="sd">            kpoint: K-point in self-energy. Accepts |Kpoint|, vector or index.</span>
<span class="sd">            itemp: Temperature index, if None all temperatures are returned.</span>
<span class="sd">            spin: Spin index</span>
<span class="sd">            with_params: False to exclude calculation parameters from the dataframe.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df_list</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">df_list</span><span class="o">.</span><span class="n">append</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">ncfile</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">get_dirgaps_dataframe</span><span class="p">(</span><span class="n">kpoint</span><span class="p">,</span> <span class="n">itemp</span><span class="o">=</span><span class="n">itemp</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span> <span class="n">with_params</span><span class="o">=</span><span class="n">with_params</span><span class="p">)</span>
            <span class="n">app</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="SigEPhRobot.get_dataframe"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhRobot.get_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">get_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_params</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_spin</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">ignore_imag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return |pandas-Dataframe| with QP results for all k-points, bands and spins</span>
<span class="sd">        present in the files treated by the robot.</span>

<span class="sd">        Args:</span>
<span class="sd">            with_params:</span>
<span class="sd">            with_spin: True to add column with spin index. &quot;auto&quot; to add it only if nsppol == 2</span>
<span class="sd">            ignore_imag: only real part is returned if ``ignore_imag``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">with_spin</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">ncfile</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">ncfile</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">)</span> <span class="k">if</span> <span class="n">with_spin</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span> <span class="k">else</span> <span class="n">with_spin</span>

        <span class="n">df_list</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">df_list</span><span class="o">.</span><span class="n">append</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">ncfile</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncfile</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">kpoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ncfile</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">):</span>
                    <span class="n">app</span><span class="p">(</span><span class="n">ncfile</span><span class="o">.</span><span class="n">get_dataframe_sk</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">with_params</span><span class="o">=</span><span class="n">with_params</span><span class="p">,</span>
                        <span class="n">with_spin</span><span class="o">=</span><span class="n">with_spin</span><span class="p">,</span> <span class="n">ignore_imag</span><span class="o">=</span><span class="n">ignore_imag</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="SigEPhRobot.plot_selfenergy_conv"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhRobot.plot_selfenergy_conv">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_selfenergy_conv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">itemp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the convergence of the EPH self-energy wrt to the ``sortby`` parameter.</span>
<span class="sd">        Values can be optionally grouped by `hue`.</span>

<span class="sd">        Args:</span>
<span class="sd">            spin: Spin index.</span>
<span class="sd">            kpoint: K-point in self-energy. Accepts |Kpoint|, vector or index.</span>
<span class="sd">            band: Band index.</span>
<span class="sd">            itemp: Temperature index.</span>
<span class="sd">            sortby: Define the convergence parameter, sort files and produce plot labels.</span>
<span class="sd">                Can be None, string or function. If None, no sorting is performed.</span>
<span class="sd">                If string and not empty it&#39;s assumed that the abifile has an attribute</span>
<span class="sd">                with the same name and `getattr` is invoked.</span>
<span class="sd">                If callable, the output of sortby(abifile) is used.</span>
<span class="sd">            hue: Variable that define subsets of the data, which will be drawn on separate lines.</span>
<span class="sd">                Accepts callable or string</span>
<span class="sd">                If string, it&#39;s assumed that the abifile has an attribute with the same name and getattr is invoked.</span>
<span class="sd">                If callable, the output of hue(abifile) is used.</span>
<span class="sd">            colormap: matplotlib color map.</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                   or scalar e.g. ``left``. If left (right) is None, default values are used.</span>
<span class="sd">            fontsize: Legend and title fontsize.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make sure that nsppol, sigma_kpoints, and tmesh are consistent.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_dims_and_params</span><span class="p">()</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax_list</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">lnp_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="n">sortby</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lnp_list</span><span class="p">):</span>
                <span class="n">sigma</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_sigeph_skb</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">)</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">sigma</span><span class="o">.</span><span class="n">plot_tdep</span><span class="p">(</span><span class="n">itemps</span><span class="o">=</span><span class="n">itemp</span><span class="p">,</span> <span class="n">ax_list</span><span class="o">=</span><span class="n">ax_list</span><span class="p">,</span>
                                      <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">ix</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">lnp_list</span><span class="p">)),</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">ax_list</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># group_and_sortby and build (3, ngroups) subplots</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_and_sortby</span><span class="p">(</span><span class="n">hue</span><span class="p">,</span> <span class="n">sortby</span><span class="p">)</span>
            <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
            <span class="n">ax_mat</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                                   <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ig</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">groups</span><span class="p">):</span>
                <span class="n">subtitle</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_label</span><span class="p">(</span><span class="n">hue</span><span class="p">),</span> <span class="n">g</span><span class="o">.</span><span class="n">hvalue</span><span class="p">)</span>
                <span class="n">ax_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ig</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">subtitle</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="p">(</span><span class="n">nclabel</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
                    <span class="n">sigma</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_sigeph_skb</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">)</span>
                    <span class="n">fig</span> <span class="o">=</span> <span class="n">sigma</span><span class="o">.</span><span class="n">plot_tdep</span><span class="p">(</span><span class="n">itemps</span><span class="o">=</span><span class="n">itemp</span><span class="p">,</span> <span class="n">ax_list</span><span class="o">=</span><span class="n">ax_mat</span><span class="p">[:,</span> <span class="n">ig</span><span class="p">],</span>
                                          <span class="n">label</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_label</span><span class="p">(</span><span class="n">sortby</span><span class="p">),</span> <span class="n">param</span><span class="p">),</span>
                                          <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">ix</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="p">)),</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ig</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">ax_mat</span><span class="p">[:,</span> <span class="n">ig</span><span class="p">]:</span>
                    <span class="n">set_visible</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;ylabel&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">ax_mat</span><span class="o">.</span><span class="n">ravel</span><span class="p">():</span>
                <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="SigEPhRobot.plot_qpgaps_t"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhRobot.plot_qpgaps_t">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_qpgaps_t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qp_kpoints</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">qp_type</span><span class="o">=</span><span class="s2">&quot;qpz0&quot;</span><span class="p">,</span> <span class="n">plot_qpmks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compare the QP(T) direct gaps for all the k-points available in the robot.</span>

<span class="sd">        Args:</span>
<span class="sd">            qp_kpoints: List of k-points in self-energy. Accept integers (list or scalars), list of vectors,</span>
<span class="sd">                or None to plot all k-points.</span>
<span class="sd">            qp_type: &quot;qpz0&quot; for linearized QP equation with Z factor compute at KS e0,</span>
<span class="sd">                     &quot;otms&quot; for on-the-mass-shell results.</span>
<span class="sd">            plot_qpmks: If False, plot QP_gap, KS_gap else (QP_gap - KS_gap)</span>
<span class="sd">            sortby: Define the convergence parameter, sort files and produce plot labels.</span>
<span class="sd">                Can be None, string or function. If None, no sorting is performed.</span>
<span class="sd">                If string and not empty it&#39;s assumed that the abifile has an attribute</span>
<span class="sd">                with the same name and `getattr` is invoked.</span>
<span class="sd">                If callable, the output of sortby(abifile) is used.</span>
<span class="sd">            hue: Variable that define subsets of the data, which will be drawn on separate lines.</span>
<span class="sd">                Accepts callable or string</span>
<span class="sd">                If string, it&#39;s assumed that the abifile has an attribute with the same name and getattr is invoked.</span>
<span class="sd">                If callable, the output of hue(abifile) is used.</span>
<span class="sd">            fontsize: legend and label fontsize.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax_list</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="p">((</span><span class="n">label</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">,</span> <span class="n">param</span><span class="p">),</span> <span class="n">lineopt</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="n">sortby</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_lineopt</span><span class="p">())):</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">plot_qpgaps_t</span><span class="p">(</span><span class="n">qp_kpoints</span><span class="o">=</span><span class="n">qp_kpoints</span><span class="p">,</span> <span class="n">qp_type</span><span class="o">=</span><span class="n">qp_type</span><span class="p">,</span> <span class="n">ax_list</span><span class="o">=</span><span class="n">ax_list</span><span class="p">,</span>
                    <span class="n">plot_qpmks</span><span class="o">=</span><span class="n">plot_qpmks</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="o">**</span><span class="n">lineopt</span><span class="p">)</span>
                    <span class="c1">#label=label if ix == 0 else None, show=False, fontsize=fontsize, **lineopt)</span>
                <span class="n">ax_list</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Need to know number of k-points here to build grid</span>
            <span class="n">qpkinds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find_qpkinds</span><span class="p">(</span><span class="n">qp_kpoints</span><span class="p">)</span>
            <span class="c1"># (nkpt, ngroups) subplots</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_and_sortby</span><span class="p">(</span><span class="n">hue</span><span class="p">,</span> <span class="n">sortby</span><span class="p">)</span>
            <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qpkinds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
            <span class="n">ax_mat</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                                   <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ig</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">groups</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="p">(</span><span class="n">nclabel</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
                    <span class="n">fig</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">plot_qpgaps_t</span><span class="p">(</span><span class="n">qp_kpoints</span><span class="o">=</span><span class="n">qpkinds</span><span class="p">,</span> <span class="n">qp_type</span><span class="o">=</span><span class="n">qp_type</span><span class="p">,</span> <span class="n">ax_list</span><span class="o">=</span><span class="n">ax_mat</span><span class="p">[:,</span> <span class="n">ig</span><span class="p">],</span>
                            <span class="n">plot_qpmks</span><span class="o">=</span><span class="n">plot_qpmks</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_label</span><span class="p">(</span><span class="n">sortby</span><span class="p">),</span> <span class="n">param</span><span class="p">),</span>
                            <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1">#, **lineopt)</span>

                <span class="c1"># Add label with hue to previous title with k-point info.</span>
                <span class="n">ax_append_title</span><span class="p">(</span><span class="n">ax_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ig</span><span class="p">],</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_label</span><span class="p">(</span><span class="n">hue</span><span class="p">),</span> <span class="n">g</span><span class="o">.</span><span class="n">hvalue</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ig</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">ax_mat</span><span class="p">[:,</span> <span class="n">ig</span><span class="p">]:</span>
                        <span class="n">set_visible</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;ylabel&quot;</span><span class="p">)</span>

            <span class="c1"># Hide legends except the first one</span>
            <span class="k">if</span> <span class="n">nrows</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">ax_mat</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">ravel</span><span class="p">():</span>
                    <span class="n">set_visible</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;legend&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="SigEPhRobot.plot_qpgaps_convergence"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhRobot.plot_qpgaps_convergence">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_qpgaps_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qp_kpoints</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">itemp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">qp_type</span><span class="o">=</span><span class="s2">&quot;qpz0&quot;</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">plot_qpmks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the convergence of the direct QP gaps at given temperature</span>
<span class="sd">        for all the k-points and spins treated by the robot.</span>

<span class="sd">        Args:</span>
<span class="sd">            qp_kpoints: List of k-points in self-energy. Accept integers (list or scalars), list of vectors,</span>
<span class="sd">                or &quot;all&quot; to plot all k-points.</span>
<span class="sd">            itemp: Temperature index.</span>
<span class="sd">            qp_type: &quot;qpz0&quot; for linear qp equation with Z factor computed at KS e0,</span>
<span class="sd">                     &quot;otms&quot; for on-the-mass-shell values.</span>
<span class="sd">            sortby: Define the convergence parameter, sort files and produce plot labels.</span>
<span class="sd">                Can be None, string or function. If None, no sorting is performed.</span>
<span class="sd">                If string and not empty it&#39;s assumed that the abifile has an attribute</span>
<span class="sd">                with the same name and `getattr` is invoked.</span>
<span class="sd">                If callable, the output of sortby(abifile) is used.</span>
<span class="sd">            hue: Variable that define subsets of the data, which will be drawn on separate lines.</span>
<span class="sd">                Accepts callable or string</span>
<span class="sd">                If string, it&#39;s assumed that the abifile has an attribute with the same name and getattr is invoked.</span>
<span class="sd">                If callable, the output of hue(abifile) is used.</span>
<span class="sd">            plot_qpmks: If False, plot QP_gap, KS_gap else (QP_gap - KS_gap)</span>
<span class="sd">            fontsize: legend and label fontsize.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make sure that nsppol, sigma_kpoints, and tmesh are consistent.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_dims_and_params</span><span class="p">()</span>

        <span class="n">nc0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nsppol</span> <span class="o">=</span> <span class="n">nc0</span><span class="o">.</span><span class="n">nsppol</span>
        <span class="n">qpkinds</span> <span class="o">=</span> <span class="n">nc0</span><span class="o">.</span><span class="n">find_qpkinds</span><span class="p">(</span><span class="n">qp_kpoints</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">qpkinds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;More that 10 k-points in file. Only 10 k-points will be show. Specify kpt index expliclty&quot;</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">)</span>
            <span class="n">qpkinds</span> <span class="o">=</span> <span class="n">qpkinds</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>

        <span class="c1"># Build grid with (nkpt, 1) plots.</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qpkinds</span><span class="p">),</span> <span class="mi">1</span>
        <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                                <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax_list</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">labels</span><span class="p">,</span> <span class="n">ncfiles</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="n">sortby</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_and_sortby</span><span class="p">(</span><span class="n">hue</span><span class="p">,</span> <span class="n">sortby</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">qp_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;qpz0&quot;</span><span class="p">,</span> <span class="s2">&quot;otms&quot;</span><span class="p">}:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid qp_type: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">qp_type</span><span class="p">)</span>

        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;QP dirgap&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">plot_qpmks</span> <span class="k">else</span> <span class="s2">&quot;QP - KS dirgap&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">qp_type</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="p">((</span><span class="n">kpt</span><span class="p">,</span> <span class="n">ikc</span><span class="p">),</span> <span class="n">ax</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">qpkinds</span><span class="p">,</span> <span class="n">ax_list</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsppol</span><span class="p">):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> k:</span><span class="si">%s</span><span class="s2">, T = </span><span class="si">%.1f</span><span class="s2"> K&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">kpt</span><span class="p">),</span> <span class="n">nc0</span><span class="o">.</span><span class="n">tmesh</span><span class="p">[</span><span class="n">itemp</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

                <span class="c1"># Extract QP dirgap for [spin, kpt, itemp]</span>
                <span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">qp_type</span> <span class="o">==</span> <span class="s2">&quot;qpz0&quot;</span><span class="p">:</span> <span class="n">yvals</span> <span class="o">=</span> <span class="p">[</span><span class="n">ncfile</span><span class="o">.</span><span class="n">qp_dirgaps_t</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">itemp</span><span class="p">]</span> <span class="k">for</span> <span class="n">ncfile</span> <span class="ow">in</span> <span class="n">ncfiles</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">qp_type</span> <span class="o">==</span> <span class="s2">&quot;otms&quot;</span><span class="p">:</span> <span class="n">yvals</span> <span class="o">=</span> <span class="p">[</span><span class="n">ncfile</span><span class="o">.</span><span class="n">qp_dirgaps_otms_t</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">itemp</span><span class="p">]</span> <span class="k">for</span> <span class="n">ncfile</span> <span class="ow">in</span> <span class="n">ncfiles</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">plot_qpmks</span><span class="p">:</span>
                        <span class="n">yvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yvals</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ncfile</span><span class="o">.</span><span class="n">ks_dirgaps</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">]</span> <span class="k">for</span> <span class="n">ncfile</span> <span class="ow">in</span> <span class="n">ncfiles</span><span class="p">])</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">duck</span><span class="o">.</span><span class="n">is_string</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">yvals</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">nc0</span><span class="o">.</span><span class="n">marker_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Must handle list of strings in a different way.</span>
                        <span class="n">xn</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xn</span><span class="p">,</span> <span class="n">yvals</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">nc0</span><span class="o">.</span><span class="n">marker_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">])</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xn</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">qp_type</span> <span class="o">==</span> <span class="s2">&quot;qpz0&quot;</span><span class="p">:</span> <span class="n">yvals</span> <span class="o">=</span> <span class="p">[</span><span class="n">ncfile</span><span class="o">.</span><span class="n">qp_dirgaps_t</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">itemp</span><span class="p">]</span> <span class="k">for</span> <span class="n">ncfile</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">abifiles</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">qp_type</span> <span class="o">==</span> <span class="s2">&quot;otms&quot;</span><span class="p">:</span> <span class="n">yvals</span> <span class="o">=</span> <span class="p">[</span><span class="n">ncfile</span><span class="o">.</span><span class="n">qp_dirgaps_otms_t</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">itemp</span><span class="p">]</span> <span class="k">for</span> <span class="n">ncfile</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">abifiles</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">plot_qpmks</span><span class="p">:</span>
                            <span class="n">yvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yvals</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ncfile</span><span class="o">.</span><span class="n">ks_dirgaps</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">]</span> <span class="k">for</span> <span class="n">ncfile</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">abifiles</span><span class="p">])</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_label</span><span class="p">(</span><span class="n">hue</span><span class="p">),</span> <span class="n">g</span><span class="o">.</span><span class="n">hvalue</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">xvalues</span><span class="p">,</span> <span class="n">yvals</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">nc0</span><span class="o">.</span><span class="n">marker_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ix</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">qpkinds</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (eV)&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_label</span><span class="p">(</span><span class="n">sortby</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">sortby</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">rotate_ticklabels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="SigEPhRobot.plot_qpdata_conv_skb"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhRobot.plot_qpdata_conv_skb">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_qpdata_conv_skb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span>
                             <span class="n">itemp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the convergence of the QP results at the given temperature for given (spin, kpoint, band)</span>

<span class="sd">        Args:</span>
<span class="sd">            spin: Spin index.</span>
<span class="sd">            kpoint: K-point in self-energy. Accepts |Kpoint|, vector or index.</span>
<span class="sd">            band: Band index.</span>
<span class="sd">            itemp: Temperature index.</span>
<span class="sd">            sortby: Define the convergence parameter, sort files and produce plot labels.</span>
<span class="sd">                Can be None, string or function. If None, no sorting is performed.</span>
<span class="sd">                If string and not empty it&#39;s assumed that the abifile has an attribute</span>
<span class="sd">                with the same name and `getattr` is invoked.</span>
<span class="sd">                If callable, the output of sortby(abifile) is used.</span>
<span class="sd">            hue: Variable that define subsets of the data, which will be drawn on separate lines.</span>
<span class="sd">                Accepts callable or string</span>
<span class="sd">                If string, it&#39;s assumed that the abifile has an attribute with the same name and getattr is invoked.</span>
<span class="sd">                If callable, the output of hue(abifile) is used.</span>
<span class="sd">            fontsize: legend and label fontsize.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make sure that nsppol, sigma_kpoints, and tmesh are consistent.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_dims_and_params</span><span class="p">()</span>

        <span class="c1"># TODO: Add more quantities DW, Fan(0)</span>
        <span class="c1"># TODO: Decide how to treat complex quantities, avoid annoying ComplexWarning</span>
        <span class="c1"># TODO: Format for g.hvalue</span>
        <span class="c1"># Treat fundamental gaps</span>
        <span class="c1"># Quantities to plot.</span>
        <span class="n">what_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;re_qpe&quot;</span><span class="p">,</span> <span class="s2">&quot;imag_qpe&quot;</span><span class="p">,</span> <span class="s2">&quot;ze0&quot;</span><span class="p">]</span>

        <span class="c1"># Build grid plot.</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">what_list</span><span class="p">),</span> <span class="mi">1</span>
        <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                                <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax_list</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="n">nc0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ikc</span> <span class="o">=</span> <span class="n">nc0</span><span class="o">.</span><span class="n">sigkpt2index</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span>
        <span class="n">kpoint</span> <span class="o">=</span> <span class="n">nc0</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">[</span><span class="n">ikc</span><span class="p">]</span>

        <span class="c1"># Sort and read QP data.</span>
        <span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">labels</span><span class="p">,</span> <span class="n">ncfiles</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="n">sortby</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">qplist</span> <span class="o">=</span> <span class="p">[</span><span class="n">ncfile</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_qp</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">)</span> <span class="k">for</span> <span class="n">ncfile</span> <span class="ow">in</span> <span class="n">ncfiles</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_and_sortby</span><span class="p">(</span><span class="n">hue</span><span class="p">,</span> <span class="n">sortby</span><span class="p">)</span>
            <span class="n">qplist_group</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">ncfile</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_qp</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">)</span> <span class="k">for</span> <span class="n">ncfile</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">abifiles</span><span class="p">]</span>
                <span class="n">qplist_group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ax_list</span><span class="p">,</span> <span class="n">what_list</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Extract QP data.</span>
                <span class="n">yvals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">what</span><span class="p">)[</span><span class="n">itemp</span><span class="p">]</span> <span class="k">for</span> <span class="n">qp</span> <span class="ow">in</span> <span class="n">qplist</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">duck</span><span class="o">.</span><span class="n">is_string</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">yvals</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">nc0</span><span class="o">.</span><span class="n">marker_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Must handle list of strings in a different way.</span>
                    <span class="n">xn</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xn</span><span class="p">,</span> <span class="n">yvals</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">nc0</span><span class="o">.</span><span class="n">marker_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">])</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xn</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">qplist</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="n">qplist_group</span><span class="p">):</span>
                    <span class="c1"># Extract QP data.</span>
                    <span class="n">yvals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">what</span><span class="p">)[</span><span class="n">itemp</span><span class="p">]</span> <span class="k">for</span> <span class="n">qp</span> <span class="ow">in</span> <span class="n">qplist</span><span class="p">]</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_label</span><span class="p">(</span><span class="n">hue</span><span class="p">),</span> <span class="n">g</span><span class="o">.</span><span class="n">hvalue</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">xvalues</span><span class="p">,</span> <span class="n">yvals</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">nc0</span><span class="o">.</span><span class="n">marker_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">],</span>
                            <span class="n">label</span><span class="o">=</span><span class="n">label</span> <span class="k">if</span> <span class="n">ix</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">what</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ix</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">what_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_label</span><span class="p">(</span><span class="n">sortby</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">sortby</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">rotate_ticklabels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ix</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">hue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;title&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;QP results spin: </span><span class="si">%s</span><span class="s2">, k:</span><span class="si">%s</span><span class="s2">, band: </span><span class="si">%s</span><span class="s2">, T = </span><span class="si">%.1f</span><span class="s2"> K&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">spin</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">kpoint</span><span class="p">),</span> <span class="n">band</span><span class="p">,</span> <span class="n">nc0</span><span class="o">.</span><span class="n">tmesh</span><span class="p">[</span><span class="n">itemp</span><span class="p">])</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="SigEPhRobot.plot_qpfield_vs_e0"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhRobot.plot_qpfield_vs_e0">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_qpfield_vs_e0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">itemp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">reim</span><span class="o">=</span><span class="s2">&quot;real&quot;</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For each file in the robot, plot one of the attributes of :class:`QpTempState`</span>
<span class="sd">        at temperature `itemp` as a function of the KS energy.</span>

<span class="sd">        Args:</span>
<span class="sd">            field (str): String defining the attribute to plot.</span>
<span class="sd">            itemp (int): Temperature index.</span>
<span class="sd">            reim: Plot the real or imaginary part</span>
<span class="sd">            function: Apply a function to the results before plotting</span>
<span class="sd">            sortby: Define the convergence parameter, sort files and produce plot labels.</span>
<span class="sd">                Can be None, string or function. If None, no sorting is performed.</span>
<span class="sd">                If string and not empty it&#39;s assumed that the abifile has an attribute</span>
<span class="sd">                with the same name and `getattr` is invoked.</span>
<span class="sd">                If callable, the output of sortby(abifile) is used.</span>
<span class="sd">            hue: Variable that define subsets of the data, which will be drawn on separate lines.</span>
<span class="sd">                Accepts callable or string</span>
<span class="sd">                If string, it is assumed that the abifile has an attribute with the same name and getattr is invoked.</span>
<span class="sd">                If callable, the output of hue(abifile) is used.</span>
<span class="sd">            colormap: matplotlib color map.</span>
<span class="sd">            fontsize: legend and label fontsize.</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot.</span>

<span class="sd">        .. note::</span>

<span class="sd">            For the meaning of the other arguments, see other robot methods.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax_list</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">lnp_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="n">sortby</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lnp_list</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">sortby</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_label</span><span class="p">(</span><span class="n">sortby</span><span class="p">),</span> <span class="n">param</span><span class="p">)</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">plot_qps_vs_e0</span><span class="p">(</span><span class="n">itemp_list</span><span class="o">=</span><span class="p">[</span><span class="n">itemp</span><span class="p">],</span> <span class="n">with_fields</span><span class="o">=</span><span class="n">list_strings</span><span class="p">(</span><span class="n">field</span><span class="p">),</span>
                    <span class="n">reim</span><span class="o">=</span><span class="n">reim</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="n">function</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="n">e0</span><span class="p">,</span> <span class="n">ax_list</span><span class="o">=</span><span class="n">ax_list</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">lnp_list</span><span class="p">)),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">ax_list</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># group_and_sortby and build (ngroups,) subplots</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_and_sortby</span><span class="p">(</span><span class="n">hue</span><span class="p">,</span> <span class="n">sortby</span><span class="p">)</span>
            <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
            <span class="n">ax_mat</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                                   <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ig</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">groups</span><span class="p">):</span>
                <span class="n">subtitle</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_label</span><span class="p">(</span><span class="n">hue</span><span class="p">),</span> <span class="n">g</span><span class="o">.</span><span class="n">hvalue</span><span class="p">)</span>
                <span class="n">ax_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ig</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">subtitle</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">nclabel</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
                    <span class="n">fig</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">plot_qps_vs_e0</span><span class="p">(</span><span class="n">itemp_list</span><span class="o">=</span><span class="p">[</span><span class="n">itemp</span><span class="p">],</span> <span class="n">with_fields</span><span class="o">=</span><span class="n">list_strings</span><span class="p">(</span><span class="n">field</span><span class="p">),</span>
                        <span class="n">reim</span><span class="o">=</span><span class="n">reim</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="n">function</span><span class="p">,</span>
                        <span class="n">e0</span><span class="o">=</span><span class="n">e0</span><span class="p">,</span> <span class="n">ax_list</span><span class="o">=</span><span class="n">ax_mat</span><span class="p">[:,</span> <span class="n">ig</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="p">)),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_label</span><span class="p">(</span><span class="n">sortby</span><span class="p">),</span> <span class="n">param</span><span class="p">),</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">ig</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">ax_mat</span><span class="p">[:,</span> <span class="n">ig</span><span class="p">]:</span>
                        <span class="n">set_visible</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;ylabel&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="SigEPhRobot.plot_lws_vs_e0"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhRobot.plot_lws_vs_e0">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_lws_vs_e0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rta_type</span><span class="o">=</span><span class="s2">&quot;serta&quot;</span><span class="p">,</span> <span class="n">itemp_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot phonon-induced linewidths vs KS energy for different temperatures for all files in the robot.</span>

<span class="sd">        Args:</span>
<span class="sd">            rta_type: &quot;serta&quot; for SERTA linewidths or &quot;mrta&quot; for MRTA linewidths.</span>
<span class="sd">            itemp_list: List of temperature indices to interpolate. None for all.</span>
<span class="sd">            colormap: matplotlib color map.</span>
<span class="sd">            fontsize: fontsize for titles and legend.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ntemp_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ncfile</span><span class="o">.</span><span class="n">ntemp</span> <span class="k">for</span> <span class="n">ncfile</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">])</span>
        <span class="n">ntemp</span> <span class="o">=</span> <span class="n">ntemp_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Consistency check</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">ntemp</span> <span class="o">!=</span> <span class="n">ntemp_list</span><span class="p">):</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Cannot compare SIGEPH files with different number of Temperatures!&quot;</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">ncfile</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ncfile</span><span class="o">.</span><span class="n">tmesh</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tmesh</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Cannot compare SIGEPH files with different Temperatures!&quot;</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="n">itemp_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">ntemp</span><span class="p">))</span> <span class="k">if</span> <span class="n">itemp_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">duck</span><span class="o">.</span><span class="n">list_ints</span><span class="p">(</span><span class="n">itemp_list</span><span class="p">)</span>

        <span class="n">num_plots</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">nrows</span> <span class="o">=</span> <span class="n">ntemp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">num_plots</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_plots</span> <span class="o">//</span> <span class="n">ncols</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_plots</span> <span class="o">%</span> <span class="n">ncols</span><span class="p">)</span>

        <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                                <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax_list</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="c1"># don&#39;t show the last ax if num_plots is odd.</span>
        <span class="k">if</span> <span class="n">num_plots</span> <span class="o">%</span> <span class="n">ncols</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ax_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">itertools</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">((</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">itemp</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ax_list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ifile</span><span class="p">,</span> <span class="n">ncfile</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">):</span>
                <span class="n">ncfile</span><span class="o">.</span><span class="n">plot_lws_vs_e0</span><span class="p">(</span><span class="n">itemp_list</span><span class="o">=</span><span class="p">[</span><span class="n">itemp</span><span class="p">],</span> <span class="n">rta_type</span><span class="o">=</span><span class="n">rta_type</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                                      <span class="n">marker</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">marker</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="n">ncfile</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span>
                                      <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">itemp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">set_visible</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;xlabel&quot;</span><span class="p">,</span> <span class="s2">&quot;ylabel&quot;</span><span class="p">,</span> <span class="s2">&quot;legend&quot;</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;T = </span><span class="si">%.1f</span><span class="s2"> K&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tmesh</span><span class="p">[</span><span class="n">itemp</span><span class="p">])</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">rta_type</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="SigEPhRobot.yield_figs"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhRobot.yield_figs">[docs]</a>    <span class="k">def</span> <span class="nf">yield_figs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function *generates* a predefined list of matplotlib figures with minimal input from the user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">imag_only</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">ncfile</span><span class="o">.</span><span class="n">imag_only</span> <span class="k">for</span> <span class="n">ncfile</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">imag_only</span><span class="p">:</span>
            <span class="c1">#print(&quot;imag_only&quot;)</span>
            <span class="k">for</span> <span class="n">rta_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;serta&quot;</span><span class="p">,</span> <span class="s2">&quot;mrta&quot;</span><span class="p">):</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_lws_vs_e0</span><span class="p">(</span><span class="n">rta_type</span><span class="o">=</span><span class="n">rta_type</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="c1">#yield self.plot_tau_vtau(rta_type=rta_type, show=False)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">itemp</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">enough</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">qp_kpt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">enough</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File contains more than </span><span class="si">{</span><span class="n">enough</span><span class="si">}</span><span class="s2"> k-points. Only the first </span><span class="si">{</span><span class="n">enough</span><span class="si">}</span><span class="s2"> k-points are displayed.&quot;</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">for</span> <span class="n">qp_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;qpz0&quot;</span><span class="p">,</span> <span class="s2">&quot;otms&quot;</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_qpgaps_convergence</span><span class="p">(</span><span class="n">qp_kpoints</span><span class="o">=</span><span class="n">qp_kpt</span><span class="p">,</span> <span class="n">qp_type</span><span class="o">=</span><span class="n">qp_type</span><span class="p">,</span> <span class="n">itemp</span><span class="o">=</span><span class="n">itemp</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_qpgaps_t</span><span class="p">(</span><span class="n">qp_kpoints</span><span class="o">=</span><span class="n">qp_kpt</span><span class="p">,</span> <span class="n">qp_type</span><span class="o">=</span><span class="n">qp_type</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="SigEPhRobot.write_notebook"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigEPhRobot.write_notebook">[docs]</a>    <span class="k">def</span> <span class="nf">write_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a jupyter_ notebook to ``nbpath``. If nbpath is None, a temporay file in the current</span>
<span class="sd">        working directory is created. Return path to the notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbformat</span><span class="p">,</span> <span class="n">nbv</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nbformat_nbv_nb</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">[(</span><span class="n">l</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="c1">#nbv.new_markdown_cell(&quot;# This is a markdown cell&quot;),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;robot = abilab.SigEPhRobot(*</span><span class="si">%s</span><span class="s2">)</span><span class="se">\n</span><span class="s2">robot.trim_paths()</span><span class="se">\n</span><span class="s2">robot&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">)),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;robot.get_params_dataframe()&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;# data = robot.get_dataframe()</span><span class="se">\n</span><span class="s2">data&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;robot.plot_qpgaps_convergence(itemp=0, sortby=None, hue=None);&quot;</span><span class="p">),</span>
            <span class="c1">#nbv.new_code_cell(&quot;robot.plot_qpgaps_t(sortby=None);&quot;),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">nc0 = robot.abifiles[0]</span>
<span class="s2">for spin in range(nc0.nsppol):</span>
<span class="s2">    for ikc, sigma_kpoint in enumerate(nc0.sigma_kpoints):</span>
<span class="s2">        for band in range(nc0.bstart_sk[spin, ikc], nc0.bstop_sk[spin, ikc]):</span>
<span class="s2">            robot.plot_qpdata_conv_skb(spin, sigma_kpoint, band, itemp=0, sortby=None, hue=None);&quot;&quot;&quot;</span><span class="p">),</span>

            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">#nc0 = robot.abifiles[0]</span>
<span class="s2">#for spin in range(nc0.nsppol):</span>
<span class="s2">#    for ikc, sigma_kpoint in enumerate(nc0.sigma_kpoints):</span>
<span class="s2">#        for band in range(nc0.bstart_sk[spin, ikc], nc0.bstop_sk[spin, ikc]):</span>
<span class="s2">#           robot.plot_selfenergy_conv(spin, sigma_kpoint, band, itemp=0, sortby=None);&quot;),&quot;&quot;&quot;</span><span class="p">),</span>
        <span class="p">])</span>

        <span class="c1"># Mixins.</span>
        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_baserobot_code_cells</span><span class="p">())</span>
        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_ebands_code_cells</span><span class="p">())</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_nb_nbpath</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nbpath</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TdepElectronBands"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.TdepElectronBands">[docs]</a><span class="k">class</span> <span class="nc">TdepElectronBands</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span> <span class="c1"># pragma: no cover</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A list of |ElectronBands| (T) with a real part renormalized by</span>
<span class="sd">    the E-PH sel-energy. Imaginary part is stored in a specialized array.</span>
<span class="sd">    This object is not supposed to be instantiated directly.</span>
<span class="sd">    It is usually constructed in SigEPhFile by interpolating the ab-initio results</span>

<span class="sd">    Provides methods to plot renormalized band structures with linewidths.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmesh</span><span class="p">,</span> <span class="n">ks_ebands_kpath</span><span class="p">,</span> <span class="n">qp_ebands_kpath_t</span><span class="p">,</span>
                 <span class="n">ks_ebands_kmesh</span><span class="p">,</span> <span class="n">qp_ebands_kmesh_t</span><span class="p">,</span> <span class="n">interpolators_t</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            tmesh: Array of temperatures in K.</span>
<span class="sd">            ks_ebands_kpath: KS bands on k-path (None if not available).</span>
<span class="sd">            qp_ebands_kpath_t: List of QP(T) bands on k-path (empty if not available).</span>
<span class="sd">            ks_ebands_kmesh: KS bands on k-mesh (None if not available).</span>
<span class="sd">            qp_ebands_kmesh_t: List of QP(T) bands on k-mesh (empty if not available).</span>
<span class="sd">            interpolators_t: [ntemp, 2] interpolators for real/imaginary part.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tmesh</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span><span class="o">.</span><span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpolators_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">interpolators_t</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interpolators_t</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ks_ebands_kpath</span> <span class="o">=</span> <span class="n">ks_ebands_kpath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qp_ebands_kpath_t</span> <span class="o">=</span> <span class="n">qp_ebands_kpath_t</span>
        <span class="k">if</span> <span class="n">qp_ebands_kpath_t</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qp_ebands_kpath_t</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ks_ebands_kmesh</span> <span class="o">=</span> <span class="n">ks_ebands_kmesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qp_ebands_kmesh_t</span> <span class="o">=</span> <span class="n">qp_ebands_kmesh_t</span>
        <span class="k">if</span> <span class="n">qp_ebands_kmesh_t</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qp_ebands_kmesh_t</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span>

<div class="viewcode-block" id="TdepElectronBands.has_kpath"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.TdepElectronBands.has_kpath">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">has_kpath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if interpolated bands on the k-path are available.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qp_ebands_kpath_t</span><span class="p">)</span></div>

<div class="viewcode-block" id="TdepElectronBands.has_kmesh"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.TdepElectronBands.has_kmesh">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">has_kmesh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if interpolated bands on the k-mesh are available.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qp_ebands_kmesh_t</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

<div class="viewcode-block" id="TdepElectronBands.to_string"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.TdepElectronBands.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation with verbosiy level ``verbose``.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Number of temperatures: </span><span class="si">%d</span><span class="s2">, tmesh[0]: </span><span class="si">%.1f</span><span class="s2">, tmesh[-1] </span><span class="si">%.1f</span><span class="s2"> [K]&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Has qp_bands on k-path: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_kpath</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Has ks_bands on k-path: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ks_ebands_kpath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Has qp_bands on k-mesh: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_kmesh</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Has ks_bands on k-mesh: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ks_ebands_kmesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="TdepElectronBands.pickle_load"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.TdepElectronBands.pickle_load">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">pickle_load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Loads the object from a pickle file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">new</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="c1">#assert cls is new.__class__</span>
            <span class="k">return</span> <span class="n">new</span></div>

<div class="viewcode-block" id="TdepElectronBands.pickle_dump"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.TdepElectronBands.pickle_dump">[docs]</a>    <span class="k">def</span> <span class="nf">pickle_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the status of the object in pickle format.</span>
<span class="sd">        If filepath is None, a temporary file is created.</span>

<span class="sd">        Return: name of the pickle file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">filepath</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.pickle&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">filepath</span></div>

<div class="viewcode-block" id="TdepElectronBands.plot_itemp_with_lws_vs_e0"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.TdepElectronBands.plot_itemp_with_lws_vs_e0">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_itemp_with_lws_vs_e0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">itemp</span><span class="p">,</span> <span class="n">ax_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                  <span class="n">function</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot bandstructure with linewidth at temperature ``itemp`` and linewidth vs the KS energies.</span>

<span class="sd">        Args:</span>
<span class="sd">            itemp: Temperature index.</span>
<span class="sd">            ax_list: The axes for the bandstructure plot and the DOS plot. If ax_list is None, a new figure</span>
<span class="sd">                is created and the two axes are automatically generated.</span>
<span class="sd">            width_ratios: Defines the ratio between the band structure plot and the dos plot.</span>
<span class="sd">            function: Apply this function to the values before plotting.</span>
<span class="sd">            fact:</span>

<span class="sd">        Return: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="kn">import</span> <span class="n">GridSpec</span>
        <span class="k">if</span> <span class="n">ax_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Build axes and align bands and DOS.</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">gspec</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="n">width_ratios</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>
            <span class="n">ax0</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Take them from ax_list.</span>
            <span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">ax_list</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>

        <span class="c1"># plot the band structure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_itemp</span><span class="p">(</span><span class="n">itemp</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax0</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="n">fact</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># plot the dos</span>
        <span class="n">dos_markersize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;markersize&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_lws_vs_e0</span><span class="p">(</span><span class="n">itemp_list</span><span class="o">=</span><span class="p">[</span><span class="n">itemp</span><span class="p">],</span><span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span>
                            <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="nb">abs</span><span class="p">,</span>
                            <span class="n">markersize</span><span class="o">=</span><span class="n">dos_markersize</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="TdepElectronBands.plot_itemp"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.TdepElectronBands.plot_itemp">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_itemp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">itemp</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fact</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot band structures with linewidth at temperature ``itemp``.</span>

<span class="sd">        Args:</span>
<span class="sd">            itemp: Temperature index.</span>
<span class="sd">            ax: |matplotlib-Axes| or None if a new figure should be created.</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot.</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                   or scalar e.g. ``left``. If left (right) is None, default values are used</span>
<span class="sd">            fontsize: Fontsize for title.</span>

<span class="sd">        Return: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#if not self.has_kpath: return None</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="c1"># Plot KS bands</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ks_ebands_kpath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ks_opts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;KS&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ks_ebands_kpath</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="o">**</span><span class="n">ks_opts</span><span class="p">)</span>

        <span class="c1"># Plot QP(T) bands with linewidths</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;T = </span><span class="si">%.1f</span><span class="s2"> K&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span>
        <span class="n">qp_opts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;QP&quot;</span><span class="p">,</span> <span class="n">lw_opts</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">fact</span><span class="o">=</span><span class="n">fact</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qp_ebands_kpath_t</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="o">**</span><span class="n">qp_opts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qp_ebands_kpath_t</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span><span class="o">.</span><span class="n">decorate_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>

        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="TdepElectronBands.plot"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.TdepElectronBands.plot">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot grid of band structures with linewidth (one plot for each temperature).</span>

<span class="sd">        Args:</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - ``fermie``: shift all eigenvalues to have zero energy at the Fermi energy (`self.fermie`).</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">            fontsize: Fontsize for title.</span>

<span class="sd">        Return: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">num_plots</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">nrows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">num_plots</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_plots</span> <span class="o">//</span> <span class="n">ncols</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_plots</span> <span class="o">%</span> <span class="n">ncols</span><span class="p">)</span>

        <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                                <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax_list</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="c1"># don&#39;t show the last ax if num_plots is odd.</span>
        <span class="k">if</span> <span class="n">num_plots</span> <span class="o">%</span> <span class="n">ncols</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ax_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

        <span class="c1">#e0 = 0</span>
        <span class="k">for</span> <span class="n">itemp</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ax_list</span><span class="p">):</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_itemp</span><span class="p">(</span><span class="n">itemp</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="n">e0</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="n">ylims</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">itemp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">set_visible</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;ylabel&quot;</span><span class="p">,</span> <span class="s2">&quot;legend&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="TdepElectronBands.plot_lws_vs_e0"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.TdepElectronBands.plot_lws_vs_e0">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_lws_vs_e0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">itemp_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s2">&quot;fermie&quot;</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot electron linewidths vs KS energy at temperature ``itemp``</span>

<span class="sd">        Args:</span>
<span class="sd">            itemp_list: List of temperature indices to interpolate. None for all.</span>
<span class="sd">            ax: |matplotlib-Axes| or None if a new figure should be created.</span>
<span class="sd">            e0: Option used to define the zero of energy in the band structure plot. Possible values:</span>
<span class="sd">                - ``fermie``: shift all eigenvalues to have zero energy at the Fermi energy (``self.fermie``).</span>
<span class="sd">                -  Number e.g e0=0.5: shift all eigenvalues to have zero energy at 0.5 eV</span>
<span class="sd">                -  None: Don&#39;t shift energies, equivalent to e0=0</span>
<span class="sd">            function: Apply this function to the values before plotting</span>
<span class="sd">            exchange_xy: True to exchange x-y axis.</span>
<span class="sd">            colormap: matplotlib color map.</span>
<span class="sd">            xlims, ylims: Set the data limits for the x-axis or the y-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                   or scalar e.g. ``left``. If left (right) is None, default values are used</span>
<span class="sd">            fontsize: fontsize for titles and legend.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">itemp_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span><span class="p">))</span> <span class="k">if</span> <span class="n">itemp_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">duck</span><span class="o">.</span><span class="n">list_ints</span><span class="p">(</span><span class="n">itemp_list</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>

        <span class="n">kw_linestyle</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;linestyle&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
        <span class="n">kw_markersize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;markersize&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="c1">#kw_color = kwargs.pop(&quot;color&quot;, None)</span>
        <span class="c1">#kw_label = kwargs.pop(&quot;label&quot;, None)</span>

        <span class="k">for</span> <span class="n">it</span><span class="p">,</span><span class="n">itemp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">itemp_list</span><span class="p">):</span>

            <span class="c1"># Select kmesh or kpath</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_kmesh</span><span class="p">:</span>
                <span class="n">qp_ebands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qp_ebands_kmesh_t</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">qp_ebands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qp_ebands_kpath_t</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span>

            <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">markersize</span><span class="o">=</span><span class="n">kw_markersize</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">kw_linestyle</span><span class="p">)</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">qp_ebands</span><span class="o">.</span><span class="n">plot_lws_vs_e0</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="n">e0</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="n">exchange_xy</span><span class="p">,</span>
                <span class="n">function</span><span class="o">=</span><span class="n">function</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="n">xlims</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="n">ylims</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;T = </span><span class="si">%.1f</span><span class="s2"> K&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span><span class="p">[</span><span class="n">itemp</span><span class="p">],</span>
                <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">it</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">itemp_list</span><span class="p">)),</span> <span class="c1"># if kw_color is None else kw_color,</span>
                <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="TdepElectronBands.get_ebands_plotter"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.TdepElectronBands.get_ebands_plotter">[docs]</a>    <span class="k">def</span> <span class="nf">get_ebands_plotter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edos_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_edos</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build and return |ElectronBandsPlotter| with KS and QP(T) results</span>

<span class="sd">        Args:</span>
<span class="sd">            edos_kwargs: optional dictionary with the options passed to ``get_edos`` to compute the electron DOS.</span>
<span class="sd">            with_edos: False if DOSes are not wanted</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_kpath</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;QP bands on k-path are required.&quot;</span><span class="p">)</span>

        <span class="n">ebands_plotter</span> <span class="o">=</span> <span class="n">ElectronBandsPlotter</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ks_ebands_kpath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ebands_plotter</span><span class="o">.</span><span class="n">add_ebands</span><span class="p">(</span><span class="s2">&quot;KS&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ks_ebands_kpath</span><span class="p">,</span>
                                      <span class="n">edos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ks_ebands_kmesh</span> <span class="k">if</span> <span class="n">with_edos</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                                      <span class="n">edos_kwargs</span><span class="o">=</span><span class="n">edos_kwargs</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">itemp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span><span class="p">):</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;T = </span><span class="si">%.1f</span><span class="s2"> K&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span>
            <span class="n">ebands_plotter</span><span class="o">.</span><span class="n">add_ebands</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qp_ebands_kpath_t</span><span class="p">[</span><span class="n">itemp</span><span class="p">],</span>
                                      <span class="n">edos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qp_ebands_kmesh_t</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">has_kmesh</span> <span class="ow">and</span> <span class="n">with_edos</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                                      <span class="n">edos_kwargs</span><span class="o">=</span><span class="n">edos_kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ebands_plotter</span></div>

<div class="viewcode-block" id="TdepElectronBands.get_edos_plotter"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.TdepElectronBands.get_edos_plotter">[docs]</a>    <span class="k">def</span> <span class="nf">get_edos_plotter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edos_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build and return |ElectronDosPlotter| with KS and QP(T) results.</span>

<span class="sd">        Args:</span>
<span class="sd">            edos_kwargs: optional dictionary with the options passed to ``get_edos`` to compute the electron DOS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_kmesh</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;QP bands on k-mesh are required.&quot;</span><span class="p">)</span>

        <span class="n">edos_plotter</span> <span class="o">=</span> <span class="n">ElectronDosPlotter</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ks_ebands_kmesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">edos_plotter</span><span class="o">.</span><span class="n">add_edos</span><span class="p">(</span><span class="s2">&quot;KS&quot;</span><span class="p">,</span> <span class="n">edos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ks_ebands_kmesh</span><span class="p">,</span> <span class="n">edos_kwargs</span><span class="o">=</span><span class="n">edos_kwargs</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">itemp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span><span class="p">):</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;T = </span><span class="si">%.1f</span><span class="s2"> K&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span><span class="p">[</span><span class="n">itemp</span><span class="p">]</span>
            <span class="n">edos_plotter</span><span class="o">.</span><span class="n">add_edos</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">edos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qp_ebands_kmesh_t</span><span class="p">[</span><span class="n">itemp</span><span class="p">],</span> <span class="n">edos_kwargs</span><span class="o">=</span><span class="n">edos_kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">edos_plotter</span></div></div>


<div class="viewcode-block" id="SigmaPhReader"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigmaPhReader">[docs]</a><span class="k">class</span> <span class="nc">SigmaPhReader</span><span class="p">(</span><span class="n">BaseEphReader</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads data from file and constructs objects.</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: SigmaPhReader</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_dimvalue</span><span class="p">(</span><span class="s2">&quot;nsppol&quot;</span><span class="p">)</span>

        <span class="c1"># Get important dimensions.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nkcalc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_dimvalue</span><span class="p">(</span><span class="s2">&quot;nkcalc&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntemp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_dimvalue</span><span class="p">(</span><span class="s2">&quot;ntemp&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nqbz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_dimvalue</span><span class="p">(</span><span class="s2">&quot;nqbz&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nqibz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_dimvalue</span><span class="p">(</span><span class="s2">&quot;nqibz&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngqpt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;ngqpt&quot;</span><span class="p">)</span>

        <span class="c1"># T mesh and frequency meshes.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ktmesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;kTmesh&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ktmesh</span> <span class="o">/</span> <span class="n">abu</span><span class="o">.</span><span class="n">kb_HaK</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ktmesh</span> <span class="o">*=</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_eV</span>

        <span class="c1"># The K-points where QP corrections have been calculated.</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_structure</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_kpoints</span> <span class="o">=</span> <span class="n">KpointList</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;kcalc&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">kpoint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">:</span>
            <span class="n">kpoint</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">findname_in_hsym_stars</span><span class="p">(</span><span class="n">kpoint</span><span class="p">))</span>

        <span class="c1"># [nsppol, nkcalc] arrays with index of KS bands computed.</span>
        <span class="c1"># Note conversion between Fortran and python convention.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bstart_sk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;bstart_ks&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbcalc_sk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;nbcalc_ks&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bstop_sk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstart_sk</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbcalc_sk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_bstart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstart_sk</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_bstop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstop_sk</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

        <span class="c1"># Number of frequency points along the real axis for Sigma(w) and spectral function A(w)</span>
        <span class="c1"># This dimension is optional, its presence signals that we have Sigma(w)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nwr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_dimvalue</span><span class="p">(</span><span class="s2">&quot;nwr&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Number of frequency points in Eliashberg functions</span>
        <span class="c1"># This quantity is optional, 0 means *not available*</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gfw_nomega</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_dimvalue</span><span class="p">(</span><span class="s2">&quot;gfw_nomega&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<div class="viewcode-block" id="SigmaPhReader.get_sigma_skb_kpoint"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigmaPhReader.get_sigma_skb_kpoint">[docs]</a>    <span class="k">def</span> <span class="nf">get_sigma_skb_kpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check k-point, band and spin index. Raise ValueError if invalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ikc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigkpt2index</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span>

        <span class="c1"># Consistency check.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ikc</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid k-point index `</span><span class="si">%d</span><span class="s2">`. should be in [0, </span><span class="si">%d</span><span class="s2">[&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ikc</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">&gt;</span> <span class="n">spin</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid spin index `</span><span class="si">%d</span><span class="s2">`. should be in [0, </span><span class="si">%d</span><span class="s2">[&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ikc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bstop_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">band</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstart_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid band index `</span><span class="si">%d</span><span class="s2">`. should be in [</span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">[&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">band</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstart_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstop_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">band</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstart_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">[</span><span class="n">ikc</span><span class="p">]</span></div>

<div class="viewcode-block" id="SigmaPhReader.sigkpt2index"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigmaPhReader.sigkpt2index">[docs]</a>    <span class="k">def</span> <span class="nf">sigkpt2index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sigma_kpoint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the index of the self-energy k-point in sigma_kpoints</span>
<span class="sd">        Used to access data in the arrays that are dimensioned [0:nkcalc]</span>
<span class="sd">        sigma_kpoint can be either an integer or list with reduced coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">duck</span><span class="o">.</span><span class="n">is_intlike</span><span class="p">(</span><span class="n">sigma_kpoint</span><span class="p">):</span>
            <span class="n">ikc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sigma_kpoint</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkcalc</span> <span class="o">&gt;</span> <span class="n">ikc</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">ikc</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;kpoint index should be in [0, </span><span class="si">%d</span><span class="s2">[ but received: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nkcalc</span><span class="p">,</span> <span class="n">ikc</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">sigma_kpoint</span><span class="p">)</span></div>

<div class="viewcode-block" id="SigmaPhReader.read_qplist_sk"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigmaPhReader.read_qplist_sk">[docs]</a>    <span class="k">def</span> <span class="nf">read_qplist_sk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">ignore_imag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read and return :class:`QpTempList` object for the given spin, kpoint.</span>

<span class="sd">        Args:</span>
<span class="sd">            spin: Spin index.</span>
<span class="sd">            kpoint: K-point in self-energy. Accepts |Kpoint|, vector or index.</span>
<span class="sd">            ignore_imag: Only real part is returned if ``ignore_imag``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ikc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigkpt2index</span><span class="p">(</span><span class="n">kpoint</span><span class="p">)</span>
        <span class="n">bstart</span><span class="p">,</span> <span class="n">bstop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstart_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstop_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">QpTempList</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">read_qp</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">ignore_imag</span><span class="o">=</span><span class="n">ignore_imag</span><span class="p">)</span>
                           <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bstart</span><span class="p">,</span> <span class="n">bstop</span><span class="p">)])</span></div>

<div class="viewcode-block" id="SigmaPhReader.read_sigeph_skb"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigmaPhReader.read_sigeph_skb">[docs]</a>    <span class="k">def</span> <span class="nf">read_sigeph_skb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the e-ph self energy for the given (spin, k-point, band).</span>

<span class="sd">        Args:</span>
<span class="sd">            spin: Spin index</span>
<span class="sd">            kpoint: K-point in self-energy. Accepts |Kpoint|, vector or index.</span>
<span class="sd">            band: band index.</span>

<span class="sd">        Return: :class:`EphSelfEnergy` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> does not contain spectral function data.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">kpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sigma_skb_kpoint</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">)</span>

        <span class="c1"># Abinit fortran (Ha units)</span>
        <span class="c1"># wrmesh_b(nwr, max_nbcalc, nkcalc, nsppol)</span>
        <span class="c1"># Frequency mesh along the real axis (Ha units) used for the different bands</span>
        <span class="c1">#print(spin, ikc, ib, self.read_variable(&quot;wrmesh_b&quot;).shape)</span>
        <span class="n">wmesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s2">&quot;wrmesh_b&quot;</span><span class="p">)[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_eV</span>

        <span class="c1"># complex(dpc) :: vals_e0ks(ntemp, max_nbcalc, nkcalc, nsppol)</span>
        <span class="c1"># Sigma_eph(omega=eKS, kT, band)</span>
        <span class="n">vals_e0ks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s2">&quot;vals_e0ks&quot;</span><span class="p">)[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_eV</span>
        <span class="n">vals_e0ks</span> <span class="o">=</span> <span class="n">vals_e0ks</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">vals_e0ks</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># complex(dpc) :: dvals_de0ks(ntemp, max_nbcalc, nkcalc, nsppol)</span>
        <span class="c1"># d Sigma_eph(omega, kT, band, kcalc, spin) / d omega (omega=eKS)</span>
        <span class="n">dvals_de0ks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s2">&quot;dvals_de0ks&quot;</span><span class="p">)[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">dvals_de0ks</span> <span class="o">=</span> <span class="n">dvals_de0ks</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">dvals_de0ks</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># real(dp) :: dw_vals(ntemp, max_nbcalc, nkcalc, nsppol)</span>
        <span class="c1"># Debye-Waller term (static).</span>
        <span class="n">dw_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s2">&quot;dw_vals&quot;</span><span class="p">)[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_eV</span>

        <span class="c1"># complex(dpc) :: vals_wr(nwr, ntemp, max_nbcalc, nkcalc, nsppol)</span>
        <span class="c1"># Sigma_eph(omega, kT, band) for given (k, spin).</span>
        <span class="c1"># Note: enk_KS corresponds to nwr/2 + 1.</span>
        <span class="n">vals_wr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s2">&quot;vals_wr&quot;</span><span class="p">)[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_eV</span>
        <span class="n">vals_wr</span> <span class="o">=</span> <span class="n">vals_wr</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">vals_wr</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Spectral function</span>
        <span class="c1"># nctkarr_t(&quot;spfunc_wr&quot;, &quot;dp&quot;, &quot;nwr, ntemp, max_nbcalc, nkcalc, nsppol&quot;)</span>
        <span class="n">spfunc_wr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s2">&quot;spfunc_wr&quot;</span><span class="p">)[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_eV</span>

        <span class="c1"># Read QP data. Note band instead of ib index.</span>
        <span class="n">qp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_qp</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">band</span><span class="p">)</span>

        <span class="c1"># Read contributions given by the Frohlich model (optional)</span>
        <span class="n">frohl_vals_e0ks</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span> <span class="n">frohl_dvals_de0ks</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span> <span class="n">frohl_spfunc_wr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#if self.read_variable(&quot;frohl_model&quot;, default=0):</span>
        <span class="c1">#    frohl_vals_e0ks = self.read_variable(&quot;frohl_vals_e0ks&quot;)[spin, ikc, ib, :, :] * abu.Ha_eV</span>
        <span class="c1">#    frohl_vals_e0ks = frohl_vals_e0ks[:, 0] + 1j * frohl_vals_e0ks[:, 1]</span>
        <span class="c1">#    frohl_dvals_de0ks = self.read_variable(&quot;frohl_dvals_de0ks&quot;)[spin, ikc, ib, :, :]</span>
        <span class="c1">#    frohl_dvals_de0ks = frohl_dvals_de0ks[:, 0] + 1j * frohl_dvals_de0ks[:, 1]</span>
        <span class="c1">#    frohl_spfunc_wr = self.read_variable(&quot;frohl_spfunc_wr&quot;)[spin, ikc, ib, :, :] / abu.Ha_eV</span>

        <span class="k">return</span> <span class="n">EphSelfEnergy</span><span class="p">(</span><span class="n">wmesh</span><span class="p">,</span> <span class="n">qp</span><span class="p">,</span> <span class="n">vals_e0ks</span><span class="p">,</span> <span class="n">dvals_de0ks</span><span class="p">,</span> <span class="n">dw_vals</span><span class="p">,</span> <span class="n">vals_wr</span><span class="p">,</span> <span class="n">spfunc_wr</span><span class="p">,</span>
                             <span class="n">frohl_vals_e0ks</span><span class="o">=</span><span class="n">frohl_vals_e0ks</span><span class="p">,</span>
                             <span class="n">frohl_dvals_de0ks</span><span class="o">=</span><span class="n">frohl_dvals_de0ks</span><span class="p">,</span>
                             <span class="n">frohl_spfunc_wr</span><span class="o">=</span><span class="n">frohl_spfunc_wr</span><span class="p">)</span></div>

<div class="viewcode-block" id="SigmaPhReader.read_a2feph_skb"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigmaPhReader.read_a2feph_skb">[docs]</a>    <span class="k">def</span> <span class="nf">read_a2feph_skb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read and return the Eliashberg function for the given (spin, k-point, band).</span>

<span class="sd">        Args:</span>
<span class="sd">            spin: Spin index</span>
<span class="sd">            kpoint: K-point in self-energy. Accepts |Kpoint|, vector or index.</span>
<span class="sd">            band: band index.</span>

<span class="sd">        Return: :class:`A2feph` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Access netcdf arrays directly instead of building a2f objects because it&#39;s gonna be faster.</span>
        <span class="c1"># nctkarr_t(&quot;gfw_mesh&quot;, &quot;dp&quot;, &quot;gfw_nomega&quot;)</span>
        <span class="c1"># nctkarr_t(&quot;gfw_vals&quot;, &quot;dp&quot;, &quot;gfw_nomega, three, max_nbcalc, nkcalc, nsppol&quot;)</span>
        <span class="c1"># 1:   gkk^2 with delta(en - em)</span>
        <span class="c1"># 2:3 (Fan-Migdal/DW contribution)</span>
        <span class="n">wmesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;gfw_mesh&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_eV</span>
        <span class="c1">#values = self.read_value(&quot;gfw_vals&quot;) # * abu.Ha_eV # TODO</span>

        <span class="c1"># Get a2f_{sbk}(w)</span>
        <span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">ibc</span><span class="p">,</span> <span class="n">kpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sigma_skb_kpoint</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">)</span>
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s2">&quot;gfw_vals&quot;</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">ibc</span><span class="p">]</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_eV</span> <span class="c1"># TODO check units</span>
        <span class="n">gkq2</span><span class="p">,</span> <span class="n">fan</span><span class="p">,</span> <span class="n">dw</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">A2feph</span><span class="p">(</span><span class="n">wmesh</span><span class="p">,</span> <span class="n">gkq2</span><span class="p">,</span> <span class="n">fan</span><span class="p">,</span> <span class="n">dw</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">)</span></div>

<div class="viewcode-block" id="SigmaPhReader.read_qp"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigmaPhReader.read_qp">[docs]</a>    <span class="k">def</span> <span class="nf">read_qp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">ignore_imag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return :class:`QpTempState` for the given (spin, kpoint, band)</span>
<span class="sd">        (NB: band is a global index i.e. unshifted)</span>
<span class="sd">        Only real part is returned if ``ignore_imag``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">ibc</span><span class="p">,</span> <span class="n">kpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sigma_skb_kpoint</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">ri</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">if</span> <span class="n">ignore_imag</span> <span class="k">else</span> <span class="n">a</span>

        <span class="c1"># (Complex) QP energies computed with the dynamic formalism.</span>
        <span class="c1"># nctkarr_t(&quot;qp_enes&quot;, &quot;dp&quot;, &quot;two, ntemp, max_nbcalc, nkcalc, nsppol&quot;)</span>
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s2">&quot;qp_enes&quot;</span><span class="p">)</span>
        <span class="n">qpe</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">ibc</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">var</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">ibc</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_eV</span>

        <span class="c1"># On-the-mass-shell QP energies.</span>
        <span class="c1"># nctkarr_t(&quot;qpoms_enes&quot;, &quot;dp&quot;, &quot;two, ntemp, max_nbcalc, nkcalc, nsppol&quot;)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s2">&quot;qpoms_enes&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1">#cprint(&quot;Reading old deprecated sigeph file!&quot;, &quot;yellow&quot;)</span>
            <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s2">&quot;qpadb_enes&quot;</span><span class="p">)</span>

        <span class="n">qpe_oms</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">ibc</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_eV</span>

        <span class="c1"># Debye-Waller term (static).</span>
        <span class="c1"># nctkarr_t(&quot;dw_vals&quot;, &quot;dp&quot;, &quot;ntemp, max_nbcalc, nkcalc, nsppol&quot;),</span>
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s2">&quot;dw_vals&quot;</span><span class="p">)</span>
        <span class="n">dw</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">ibc</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_eV</span>

        <span class="c1"># Sigma_eph(omega=eKS, kT, band, ikcalc, spin)</span>
        <span class="c1"># nctkarr_t(&quot;vals_e0ks&quot;, &quot;dp&quot;, &quot;two, ntemp, max_nbcalc, nkcalc, nsppol&quot;)</span>
        <span class="c1"># TODO: Add Fan0 instead of computing Sigma - DW?</span>
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s2">&quot;vals_e0ks&quot;</span><span class="p">)</span>
        <span class="n">sigc</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">ibc</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">var</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">ibc</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_eV</span>
        <span class="n">fan0</span> <span class="o">=</span> <span class="n">sigc</span> <span class="o">-</span> <span class="n">dw</span>

        <span class="c1"># nctkarr_t(&quot;ks_enes&quot;, &quot;dp&quot;, &quot;max_nbcalc, nkcalc, nsppol&quot;)</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s2">&quot;ks_enes&quot;</span><span class="p">)[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">ibc</span><span class="p">]</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_eV</span>

        <span class="c1"># nctkarr_t(&quot;ze0_vals&quot;, &quot;dp&quot;, &quot;ntemp, max_nbcalc, nkcalc, nsppol&quot;)</span>
        <span class="n">ze0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s2">&quot;ze0_vals&quot;</span><span class="p">)[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">ibc</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">QpTempState</span><span class="p">(</span><span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span> <span class="n">kpoint</span><span class="o">=</span><span class="n">kpoint</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">,</span> <span class="n">tmesh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tmesh</span><span class="p">,</span>
                           <span class="n">e0</span><span class="o">=</span><span class="n">e0</span><span class="p">,</span> <span class="n">qpe</span><span class="o">=</span><span class="n">ri</span><span class="p">(</span><span class="n">qpe</span><span class="p">),</span> <span class="n">ze0</span><span class="o">=</span><span class="n">ze0</span><span class="p">,</span> <span class="n">fan0</span><span class="o">=</span><span class="n">ri</span><span class="p">(</span><span class="n">fan0</span><span class="p">),</span> <span class="n">dw</span><span class="o">=</span><span class="n">dw</span><span class="p">,</span> <span class="n">qpe_oms</span><span class="o">=</span><span class="n">qpe_oms</span><span class="p">)</span></div>

<div class="viewcode-block" id="SigmaPhReader.read_allqps"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.sigeph.SigmaPhReader.read_allqps">[docs]</a>    <span class="k">def</span> <span class="nf">read_allqps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore_imag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return list with ``nsppol`` items. Each item is a :class:`QpTempList` with the QP results.</span>

<span class="sd">        Args:</span>
<span class="sd">            ignore_imag: Only real part is returned if ``ignore_imag``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qps_spin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">*</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

        <span class="c1"># TODO: Try to optimize this part.</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
            <span class="n">qps</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">kpoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_kpoints</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bstart_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bstop_sk</span><span class="p">[</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">]):</span>
                    <span class="n">qps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_qp</span><span class="p">(</span><span class="n">spin</span><span class="p">,</span> <span class="n">ikc</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">ignore_imag</span><span class="o">=</span><span class="n">ignore_imag</span><span class="p">))</span>
            <span class="n">qps_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span> <span class="o">=</span> <span class="n">QpTempList</span><span class="p">(</span><span class="n">qps</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">qps_spin</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, M. Giantomassi and the AbiPy group.
      <span class="lastupdated">
        Last updated on May 29, 2021.
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>