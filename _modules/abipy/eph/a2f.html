<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>abipy.eph.a2f &#8212; abipy 0.9.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/my_style.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/gallery-rendered-html.css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/thebelab-helper.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html">
          abipy</a>
        <span class="navbar-text navbar-version pull-left"><b>0.9.0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../features.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Getting AbiPy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../zzbiblio.html">Bibliography</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../scripts/index.html">Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../graphical_interface.html">Graphical interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gallery/index.html">AbiPy Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../postprocessing_howto.html">Post-processing How-To</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../workflows/taskmanager.html">TaskManager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../workflows/manager_examples.html">Manager Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../flow_gallery/index.html">Flow Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../flows_howto.html">Flows How-To</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../coding_guide.html">Coding guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html">Documenting AbiPy</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for abipy.eph.a2f</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: utf-8</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains objects for postprocessing A2F calculations (phonon lifetimes in metals</span>
<span class="sd">and Eliashberg function).</span>

<span class="sd">Warning:</span>
<span class="sd">    Work in progress, DO NOT USE THIS CODE.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pymatgen.core.units</span> <span class="k">as</span> <span class="nn">units</span>
<span class="kn">import</span> <span class="nn">abipy.core.abinit_units</span> <span class="k">as</span> <span class="nn">abu</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">cumtrapz</span><span class="p">,</span> <span class="n">simps</span>
<span class="kn">from</span> <span class="nn">monty.string</span> <span class="kn">import</span> <span class="n">marquee</span><span class="p">,</span> <span class="n">list_strings</span>
<span class="kn">from</span> <span class="nn">monty.functools</span> <span class="kn">import</span> <span class="n">lazy_property</span>
<span class="kn">from</span> <span class="nn">abipy.core.mixins</span> <span class="kn">import</span> <span class="n">AbinitNcFile</span><span class="p">,</span> <span class="n">Has_Structure</span><span class="p">,</span> <span class="n">Has_ElectronBands</span><span class="p">,</span> <span class="n">NotebookWriter</span>
<span class="kn">from</span> <span class="nn">abipy.core.kpoints</span> <span class="kn">import</span> <span class="n">Kpath</span>
<span class="kn">from</span> <span class="nn">abipy.tools.plotting</span> <span class="kn">import</span> <span class="p">(</span><span class="n">add_fig_kwargs</span><span class="p">,</span> <span class="n">get_ax_fig_plt</span><span class="p">,</span> <span class="n">get_axarray_fig_plt</span><span class="p">,</span> <span class="n">set_axlims</span><span class="p">,</span> <span class="n">set_visible</span><span class="p">,</span>
                                  <span class="n">rotate_ticklabels</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">abipy.tools</span> <span class="kn">import</span> <span class="n">duck</span>
<span class="kn">from</span> <span class="nn">abipy.electrons.ebands</span> <span class="kn">import</span> <span class="n">ElectronDos</span><span class="p">,</span> <span class="n">RobotWithEbands</span>
<span class="kn">from</span> <span class="nn">abipy.dfpt.phonons</span> <span class="kn">import</span> <span class="n">PhononBands</span><span class="p">,</span> <span class="n">PhononDos</span><span class="p">,</span> <span class="n">RobotWithPhbands</span>
<span class="kn">from</span> <span class="nn">abipy.abio.robots</span> <span class="kn">import</span> <span class="n">Robot</span>
<span class="kn">from</span> <span class="nn">abipy.eph.common</span> <span class="kn">import</span> <span class="n">BaseEphReader</span>


<span class="n">_LATEX_LABELS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lambda_iso&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$\lambda_</span><span class="si">{iso}</span><span class="s2">$&quot;</span><span class="p">,</span>
    <span class="s2">&quot;omega_log&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$\omega_</span><span class="si">{log}</span><span class="s2">$&quot;</span><span class="p">,</span>
    <span class="s2">&quot;a2f&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$\alpha^2F(\omega)$&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lambda&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$\lambda(\omega)$&quot;</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="A2f"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2f">[docs]</a><span class="k">class</span> <span class="nc">A2f</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Eliashberg function a2F(w). Energies are in eV.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Markers used for up/down bands.</span>
    <span class="n">marker_spin</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;v&quot;</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">values_spin</span><span class="p">,</span> <span class="n">values_spin_nu</span><span class="p">,</span> <span class="n">ngqpt</span><span class="p">,</span> <span class="n">meta</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            mesh: Energy mesh in eV</span>
<span class="sd">            values(nomega,0:natom3,nsppol)</span>
<span class="sd">            vals(w,1:natom,1:nsppol): a2f(w) decomposed per phonon branch and spin</span>
<span class="sd">            vals(w,0,1:nsppol): a2f(w) summed over phonons modes, decomposed in spin</span>
<span class="sd">            ngqpt: Q-mesh used to compute A2f.</span>
<span class="sd">            meta: Dictionary with metavariables.</span>

<span class="sd">        TODO:</span>
<span class="sd">            1. possibility of computing a2f directly from data on file?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngqpt</span> <span class="o">=</span> <span class="n">ngqpt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="n">meta</span>

        <span class="c1"># Spin dependent and total a2F(w)</span>
        <span class="n">values_spin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">values_spin</span><span class="p">)</span>
        <span class="n">values_spin_nu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_3d</span><span class="p">(</span><span class="n">values_spin_nu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values_spin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmodes</span> <span class="o">=</span> <span class="n">values_spin_nu</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmodes</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">natom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmodes</span> <span class="o">//</span> <span class="mi">3</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">values_spin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">values_spin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values_nu</span> <span class="o">=</span> <span class="n">values_spin_nu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">values_spin_nu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">values_spin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values_nu</span> <span class="o">=</span> <span class="n">values_spin_nu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid nsppol: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">values_spin</span> <span class="o">=</span> <span class="n">values_spin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values_spin_nu</span> <span class="o">=</span> <span class="n">values_spin_nu</span>
        <span class="c1">#self.lambdaw ?</span>

<div class="viewcode-block" id="A2f.iw0"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2f.iw0">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">iw0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Index of the first point in the mesh whose value is &gt;= 0</span>
<span class="sd">        Integrals are performed with wmesh[iw0 + 1, :] i.e. unstable modes are neglected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">:</span> <span class="k">return</span> <span class="n">i</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot find zero in energy mesh&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

<div class="viewcode-block" id="A2f.to_string"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2f.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        String representation with verbosity level ``verbose`` and an optional ``title``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>

        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Eliashberg Function&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">title</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">title</span><span class="p">))</span>
        <span class="c1"># TODO: Add ElectronDos</span>
        <span class="c1">#app(&quot;Isotropic lambda: %.3f&quot; % (self.lambda_iso))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Isotropic lambda: </span><span class="si">%.2f</span><span class="s2">, omega_log: </span><span class="si">%.3f</span><span class="s2"> (eV), </span><span class="si">%.3f</span><span class="s2"> (K)&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lambda_iso</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_log</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_log</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">eV_to_K</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Q-mesh: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngqpt</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Mesh from </span><span class="si">%.4f</span><span class="s2"> to </span><span class="si">%.4f</span><span class="s2"> (eV) with </span><span class="si">%d</span><span class="s2"> points&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">mustar</span> <span class="ow">in</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">):</span>
                <span class="n">app</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">For mustar </span><span class="si">%s</span><span class="s2">: McMillan Tc: </span><span class="si">%s</span><span class="s2"> [K]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mustar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mcmillan_tc</span><span class="p">(</span><span class="n">mustar</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># $\int dw [a2F(w)/w] w^n$</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
                <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Moment </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_moment</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span>

            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Meta: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="A2f.lambda_iso"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2f.lambda_iso">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">lambda_iso</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Isotropic lambda.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_moment</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="A2f.omega_log"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2f.omega_log">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">omega_log</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Logarithmic moment of alpha^2F: exp((2/\lambda) \int dw a2F(w) ln(w)/w)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">iw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iw0</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">wmesh</span><span class="p">,</span> <span class="n">a2fw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">[</span><span class="n">iw</span><span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">iw</span><span class="p">:]</span>

        <span class="n">fw</span> <span class="o">=</span> <span class="n">a2fw</span> <span class="o">/</span> <span class="n">wmesh</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">wmesh</span><span class="p">)</span>
        <span class="n">integral</span> <span class="o">=</span> <span class="n">simps</span><span class="p">(</span><span class="n">fw</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">wmesh</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_iso</span> <span class="o">*</span> <span class="n">integral</span><span class="p">)</span></div>

<div class="viewcode-block" id="A2f.get_moment"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2f.get_moment">[docs]</a>    <span class="k">def</span> <span class="nf">get_moment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cumulative</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the moment of a2F(w) i.e. $\int dw [a2F(w)/w] w^n$</span>
<span class="sd">        From Allen PRL 59 1460 (See also Grimvall, Eq 6.72 page 175)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wmesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iw0</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">spin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">a2fw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iw0</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a2fw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">iw0</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>

        <span class="c1"># Primitive is given on the same mesh as self.</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="n">a2fw</span> <span class="o">*</span> <span class="p">(</span><span class="n">wmesh</span> <span class="o">**</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">vals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iw0</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">cumtrapz</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">wmesh</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">vals</span> <span class="k">if</span> <span class="n">cumulative</span> <span class="k">else</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>

<div class="viewcode-block" id="A2f.get_moment_nu"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2f.get_moment_nu">[docs]</a>    <span class="k">def</span> <span class="nf">get_moment_nu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cumulative</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the moment of a2F(w) i.e. $\int dw [a2F(w)/w] w^n$</span>
<span class="sd">        From Allen PRL 59 1460 (See also Grimvall, Eq 6.72 page 175)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wmesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iw0</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">spin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">a2fw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values_nu</span><span class="p">[</span><span class="n">nu</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">iw0</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a2fw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values_spin_nu</span><span class="p">[</span><span class="n">spin</span><span class="p">][</span><span class="n">nu</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">iw0</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>

        <span class="c1"># Primitive is given on the same mesh as self.</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="n">a2fw</span> <span class="o">*</span> <span class="p">(</span><span class="n">wmesh</span> <span class="o">**</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">vals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iw0</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">cumtrapz</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">wmesh</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">vals</span> <span class="k">if</span> <span class="n">cumulative</span> <span class="k">else</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>

<div class="viewcode-block" id="A2f.get_mcmillan_tc"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2f.get_mcmillan_tc">[docs]</a>    <span class="k">def</span> <span class="nf">get_mcmillan_tc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mustar</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the critical temperature with the McMillan equation and the input mustar.</span>

<span class="sd">        Return: Tc in Kelvin.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tc</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">omega_log</span> <span class="o">/</span> <span class="mf">1.2</span><span class="p">)</span> <span class="o">*</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">1.04</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_iso</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambda_iso</span> <span class="o">-</span> <span class="n">mustar</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="mf">0.62</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_iso</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">tc</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">eV_to_K</span></div>

<div class="viewcode-block" id="A2f.get_mustar_from_tc"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2f.get_mustar_from_tc">[docs]</a>    <span class="k">def</span> <span class="nf">get_mustar_from_tc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the value of mustar that gives the critical temperature ``tc`` in the McMillan equation.</span>

<span class="sd">        Args:</span>
<span class="sd">            tc: Critical temperature in Kelvin.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_iso</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.04</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">l</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.2</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">kb_eVK</span> <span class="o">*</span> <span class="n">tc</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_log</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">num</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">0.62</span> <span class="o">*</span> <span class="n">l</span><span class="p">)</span></div>

<div class="viewcode-block" id="A2f.plot"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2f.plot">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;a2f&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot a2F(w) or lambda(w) depending on the value of `what`.</span>

<span class="sd">        Args:</span>
<span class="sd">            what: a2f for a2F(w), lambda for lambda(w)</span>
<span class="sd">            units: Units for phonon plots. Possible values in (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;). Case-insensitive.</span>
<span class="sd">            exchange_xy: True to exchange x-y axes.</span>
<span class="sd">            ax: |matplotlib-Axes| or None if a new figure should be created.</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                or scalar e.g. ``left``. If left (right) is None, default values are used</span>
<span class="sd">            ylims: Limits for y-axis. See xlims for API.</span>
<span class="sd">            label: True to add legend label to each curve.</span>
<span class="sd">            fontsize: Legend and title fontsize</span>
<span class="sd">            kwargs: linestyle, color, linewidth passed to ax.plot.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="s2">&quot;&quot;</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">wfactor</span> <span class="o">=</span> <span class="n">abu</span><span class="o">.</span><span class="n">phfactor_ev2units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="n">_LATEX_LABELS</span><span class="p">[</span><span class="n">what</span><span class="p">]</span>

        <span class="n">style</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;linestyle&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span>
            <span class="n">color</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">),</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;linewidth&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Plot a2f(w)</span>
        <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;a2f&quot;</span><span class="p">:</span>
            <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">*</span> <span class="n">wfactor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span>
            <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span><span class="p">,</span> <span class="n">xx</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># Plot spin resolved a2f(w).</span>
                <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsppol</span><span class="p">):</span>
                    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">*</span> <span class="n">wfactor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span><span class="p">,</span> <span class="n">xx</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">marker_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">],</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>

        <span class="c1"># Plot lambda(w)</span>
        <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;lambda&quot;</span><span class="p">:</span>
            <span class="n">lambda_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_moment</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cumulative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">*</span> <span class="n">wfactor</span><span class="p">,</span> <span class="n">lambda_w</span>
            <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span><span class="p">,</span> <span class="n">xx</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid value for what: `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">what</span><span class="p">))</span>

        <span class="n">xlabel</span> <span class="o">=</span> <span class="n">abu</span><span class="o">.</span><span class="n">wlabel_from_units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exchange_xy</span><span class="p">:</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">xlabel</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">label</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="A2f.plot_with_lambda"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2f.plot_with_lambda">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_with_lambda</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot a2F(w) and lambda(w) on the same figure.</span>

<span class="sd">        Args:</span>
<span class="sd">            units: Units for phonon plots. Possible values in (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;). Case-insensitive.</span>
<span class="sd">            ax: |matplotlib-Axes| or None if a new figure should be created.</span>
<span class="sd">            xlims: Set the data limits for the y-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                or scalar e.g. ``left``. If left (right) is None, default values are used</span>
<span class="sd">            fontsize: Legend and title fontsize</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="s2">&quot;&quot;</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">what</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s2">&quot;a2f&quot;</span><span class="p">,</span> <span class="s2">&quot;lambda&quot;</span><span class="p">]):</span>
            <span class="n">this_ax</span> <span class="o">=</span> <span class="n">ax</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">what</span><span class="o">=</span><span class="n">what</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">this_ax</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="n">xlims</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">this_ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
                <span class="n">this_ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="A2f.plot_nuterms"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2f.plot_nuterms">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_nuterms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="n">ax_mat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_lambda</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                     <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot a2F(w), lambda(w) and optionally the individual contributions due to the phonon branches.</span>

<span class="sd">        Args:</span>
<span class="sd">            units: Units for phonon plots. Possible values in (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;).</span>
<span class="sd">                Case-insensitive.</span>
<span class="sd">            ax_mat: Matrix of axis of shape [natom, 3]. None if a new figure should be created.</span>
<span class="sd">            fontsize: Legend and title fontsize.</span>
<span class="sd">            xlims: Set the data limits for the y-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                or scalar e.g. ``left``. If left (right) is None, default values are used</span>
<span class="sd">            ylims: Limits for y-axis. See xlims for API.</span>
<span class="sd">            label: True to add legend label to each curve.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="s2">&quot;&quot;</span>
        <span class="c1"># Get ax_mat and fig.</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">,</span> <span class="mi">3</span>
        <span class="n">ax_mat</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="n">ax_mat</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                               <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ax_mat</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

        <span class="n">wfactor</span> <span class="o">=</span> <span class="n">abu</span><span class="o">.</span><span class="n">phfactor_ev2units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
        <span class="n">wvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">*</span> <span class="n">wfactor</span>

        <span class="k">if</span> <span class="n">with_lambda</span><span class="p">:</span>
            <span class="n">lax_nu</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">ax_mat</span><span class="o">.</span><span class="n">flat</span><span class="p">]</span>
            <span class="c1"># Share axis after creation. Based on</span>
            <span class="c1"># https://stackoverflow.com/questions/42973223/how-share-x-axis-of-two-subplots-after-they-are-created</span>
            <span class="n">lax_nu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_shared_x_axes</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">lax_nu</span><span class="p">)</span>
            <span class="n">lax_nu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_shared_y_axes</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">lax_nu</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lax_nu</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
                <span class="c1">#ax.set_xticklabels([])</span>

        <span class="c1"># TODO Better handling of styles</span>
        <span class="n">a2f_style</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;linestyle&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span>
            <span class="n">color</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">),</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;linewidth&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">lambda_style</span> <span class="o">=</span> <span class="n">a2f_style</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">lambda_style</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span>

        <span class="kn">import</span> <span class="nn">itertools</span>
        <span class="k">for</span> <span class="n">idir</span><span class="p">,</span> <span class="n">iatom</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">)):</span>
            <span class="n">nu</span> <span class="o">=</span> <span class="n">idir</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">iatom</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">ax_mat</span><span class="p">[</span><span class="n">iatom</span><span class="p">,</span> <span class="n">idir</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\nu = </span><span class="si">%d</span><span class="s2">$&quot;</span> <span class="o">%</span> <span class="n">nu</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">idir</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\alpha^2F(\omega)$&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
                <span class="c1"># Turn off tick labels</span>
                <span class="c1">#ax.set_yticklabels([])</span>
                <span class="c1">#ax.set_yticks([])</span>

            <span class="k">if</span> <span class="n">iatom</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">natom</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">abu</span><span class="o">.</span><span class="n">wlabel_from_units</span><span class="p">(</span><span class="n">units</span><span class="p">))</span>
            <span class="c1">#set_axlims(ax, xlims, &quot;x&quot;)</span>
            <span class="c1">#set_axlims(ax, ylims, &quot;y&quot;)</span>

            <span class="c1"># Plot total a2f(w)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wvals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values_nu</span><span class="p">[</span><span class="n">nu</span><span class="p">],</span> <span class="o">**</span><span class="n">a2f_style</span><span class="p">)</span>

            <span class="c1"># Plot lambda(w)</span>
            <span class="k">if</span> <span class="n">with_lambda</span><span class="p">:</span>
                <span class="n">lambdaw_nu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_moment_nu</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nu</span><span class="o">=</span><span class="n">nu</span><span class="p">,</span> <span class="n">cumulative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">lax</span> <span class="o">=</span> <span class="n">lax_nu</span><span class="p">[</span><span class="n">nu</span><span class="p">]</span>
                <span class="n">lax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wvals</span><span class="p">,</span> <span class="n">lambdaw_nu</span><span class="p">,</span> <span class="o">**</span><span class="n">lambda_style</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">idir</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">lax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\lambda_{\nu}(\omega)$&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">lambda_style</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">])</span>

            <span class="c1">#if self.nsppol == 2:</span>
            <span class="c1">#   # Plot spin resolved a2f(w)</span>
            <span class="c1">#   for spin in range(self.nsppol):</span>
            <span class="c1">#       ax.plot(self.mesh, self.values_spin_nu[spin, nu],</span>
            <span class="c1">#               marker=self.marker_spin[spin], **a2f_style)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="A2f.plot_a2"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2f.plot_a2">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_a2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phdos</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Grid with 3 plots showing: a2F(w), F(w), a2F(w). Requires phonon DOS.</span>

<span class="sd">        Args:</span>
<span class="sd">            phdos: |PhononDos|</span>
<span class="sd">            atol: F(w) is replaced by atol in a2F(w) / F(w) ratio where :math:`|F(w)|` &lt; atol</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">phdos</span> <span class="o">=</span> <span class="n">PhononDos</span><span class="o">.</span><span class="n">as_phdos</span><span class="p">(</span><span class="n">phdos</span><span class="p">)</span>

        <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax_list</span> <span class="o">=</span> <span class="n">ax_list</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="c1"># Spline phdos onto a2f mesh and compute a2F(w) / F(w)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">phdos</span><span class="o">.</span><span class="n">spline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">atol</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">atol</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">ax_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\alpha^2(\omega)$ [1/eV]&quot;</span><span class="p">)</span>

        <span class="c1"># Plot F(w). TODO: This should not be called plot_dos_idos!</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">ax_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">phdos</span><span class="o">.</span><span class="n">plot_dos_idos</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$F(\omega)$ [states/eV]&quot;</span><span class="p">)</span>

        <span class="c1"># Plot a2f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax_list</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="A2f.plot_tc_vs_mustar"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2f.plot_tc_vs_mustar">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_tc_vs_mustar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot Tc(mustar)</span>

<span class="sd">        Args:</span>
<span class="sd">            start: The starting value of the sequence.</span>
<span class="sd">            stop: The end value of the sequence</span>
<span class="sd">            num (int): optional. Number of samples to generate. Default is 50. Must be non-negative.</span>
<span class="sd">            ax: |matplotlib-Axes| or None if a new figure should be created.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO start and stop to avoid singularity in Mc Tc</span>
        <span class="n">mustar_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="p">)</span>
        <span class="n">tc_vals</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_mcmillan_tc</span><span class="p">(</span><span class="n">mustar</span><span class="p">)</span> <span class="k">for</span> <span class="n">mustar</span> <span class="ow">in</span> <span class="n">mustar_values</span><span class="p">]</span>

        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mustar_values</span><span class="p">,</span> <span class="n">tc_vals</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\mu^*$&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$T_c$ [K]&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div></div>


<div class="viewcode-block" id="A2Ftr"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2Ftr">[docs]</a><span class="k">class</span> <span class="nc">A2Ftr</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transport Eliashberg function a2F(w). Energies are in eV.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Markers used for up/down bands (collinear spin)</span>
    <span class="n">marker_spin</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;v&quot;</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">vals_in</span><span class="p">,</span> <span class="n">vals_out</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            mesh: Energy mesh in eV</span>
<span class="sd">            vals_in(nomega,3,3,0:natom3,nsppol):</span>
<span class="sd">                Eliashberg transport functions for in and out scattering</span>
<span class="sd">            vals_in(w,3,3,1:natom3,1:nsppol): a2f_tr(w) decomposed per phonon branch and spin</span>
<span class="sd">            vals_in(w,3,3,0,1:nsppol): a2f_tr(w) summed over phonons modes, decomposed in spin</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh</span>

<div class="viewcode-block" id="A2Ftr.iw0"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2Ftr.iw0">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">iw0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Index of the first point in the mesh whose value is &gt;= 0</span>
<span class="sd">        Integrals are performed with wmesh[iw0 + 1, :] i.e. unstable modes are neglected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">:</span> <span class="k">return</span> <span class="n">i</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot find zero in energy mesh&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="A2fFile"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fFile">[docs]</a><span class="k">class</span> <span class="nc">A2fFile</span><span class="p">(</span><span class="n">AbinitNcFile</span><span class="p">,</span> <span class="n">Has_Structure</span><span class="p">,</span> <span class="n">Has_ElectronBands</span><span class="p">,</span> <span class="n">NotebookWriter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This file contains the phonon linewidths, EliashbergFunction, the |PhononBands|,</span>
<span class="sd">    the |ElectronBands| and |ElectronDos| on the k-mesh.</span>
<span class="sd">    Provides methods to analyze and plot results.</span>

<span class="sd">    Usage example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        with A2fFile(&quot;out_A2F.nc&quot;) as ncfile:</span>
<span class="sd">            print(ncfile)</span>
<span class="sd">            ncfile.ebands.plot()</span>
<span class="sd">            ncfile.phbands.plot()</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: A2fFile</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="A2fFile.from_file"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fFile.from_file">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the object from a netcdf_ file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="n">A2fReader</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

<div class="viewcode-block" id="A2fFile.to_string"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fFile.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>

        <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="s2">&quot;File Info&quot;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filestat</span><span class="p">(</span><span class="n">as_string</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Structure&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">with_structure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Electronic Bands&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phbands</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">with_structure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Phonon Bands&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="c1"># E-PH section</span>
        <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="s2">&quot;E-PH calculation&quot;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;K-mesh for electrons:&quot;</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">kpoints</span><span class="o">.</span><span class="n">ksampling</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Has transport a2Ftr(w): </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_a2ftr</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">a2f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a2f_qcoarse</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;a2f(w) on the </span><span class="si">%s</span><span class="s2"> q-mesh (ddb_ngqpt|eph_ngqpt)&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">a2f</span><span class="o">.</span><span class="n">ngqpt</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Isotropic lambda: </span><span class="si">%.2f</span><span class="s2">, omega_log: </span><span class="si">%.3f</span><span class="s2"> (eV), </span><span class="si">%.3f</span><span class="s2"> (K)&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">a2f</span><span class="o">.</span><span class="n">lambda_iso</span><span class="p">,</span> <span class="n">a2f</span><span class="o">.</span><span class="n">omega_log</span><span class="p">,</span> <span class="n">a2f</span><span class="o">.</span><span class="n">omega_log</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">eV_to_K</span><span class="p">))</span>
        <span class="c1">#app(self.a2f_qcoarse.to_string(title=title, verbose=verbose))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">a2f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a2f_qintp</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;a2f(w) Fourier interpolated on the </span><span class="si">%s</span><span class="s2"> q-mesh (ph_ngqpt)&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">a2f</span><span class="o">.</span><span class="n">ngqpt</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Isotropic lambda: </span><span class="si">%.2f</span><span class="s2">, omega_log: </span><span class="si">%.3f</span><span class="s2"> (eV), </span><span class="si">%.3f</span><span class="s2"> (K)&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">a2f</span><span class="o">.</span><span class="n">lambda_iso</span><span class="p">,</span> <span class="n">a2f</span><span class="o">.</span><span class="n">omega_log</span><span class="p">,</span> <span class="n">a2f</span><span class="o">.</span><span class="n">omega_log</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">eV_to_K</span><span class="p">))</span>
        <span class="c1">#app(self.a2f_qintp.to_string(title=title, verbose=verbose))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="A2fFile.ebands"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fFile.ebands">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">ebands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;|ElectronBands| object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_ebands</span><span class="p">()</span></div>

<div class="viewcode-block" id="A2fFile.edos"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fFile.edos">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">edos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;|ElectronDos| object with e-DOS computed by Abinit.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_edos</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;|Structure| object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebands</span><span class="o">.</span><span class="n">structure</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">phbands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        |PhononBands| object with frequencies along the q-path.</span>
<span class="sd">        Contains (interpolated) linewidths.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_phbands_qpath</span><span class="p">()</span>

<div class="viewcode-block" id="A2fFile.params"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fFile.params">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;:class:`OrderedDict` with parameters that might be subject to convergence studies.&quot;&quot;&quot;</span>
        <span class="n">od</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ebands_params</span><span class="p">()</span>
        <span class="c1"># Add EPH parameters.</span>
        <span class="n">od</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">common_eph_params</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">od</span></div>

<div class="viewcode-block" id="A2fFile.a2f_qcoarse"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fFile.a2f_qcoarse">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">a2f_qcoarse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :class:`A2f` with the Eliashberg function a2F(w) computed on the (coarse) ab-initio q-mesh.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_a2f</span><span class="p">(</span><span class="n">qsamp</span><span class="o">=</span><span class="s2">&quot;qcoarse&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="A2fFile.a2f_qintp"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fFile.a2f_qintp">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">a2f_qintp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :class:`A2f` with the Eliashberg function a2F(w) computed on the dense q-mesh by Fourier interpolation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_a2f</span><span class="p">(</span><span class="n">qsamp</span><span class="o">=</span><span class="s2">&quot;qintp&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="A2fFile.get_a2f_qsamp"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fFile.get_a2f_qsamp">[docs]</a>    <span class="k">def</span> <span class="nf">get_a2f_qsamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qsamp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the :class:`A2f` object associated to q-sampling ``qsamp``.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">qsamp</span> <span class="o">==</span> <span class="s2">&quot;qcoarse&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">a2f_qcoarse</span>
        <span class="k">if</span> <span class="n">qsamp</span> <span class="o">==</span> <span class="s2">&quot;qintp&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">a2f_qintp</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid value for qsamp `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">qsamp</span><span class="p">))</span></div>

<div class="viewcode-block" id="A2fFile.has_a2ftr"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fFile.has_a2ftr">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">has_a2ftr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if the netcdf file contains transport data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;a2ftr_qcoarse&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">rootgrp</span><span class="o">.</span><span class="n">variables</span></div>

<div class="viewcode-block" id="A2fFile.a2ftr_qcoarse"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fFile.a2ftr_qcoarse">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">a2ftr_qcoarse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :class:`A2ftr` with the Eliashberg transport spectral function a2F_tr(w, x, x&#39;)</span>
<span class="sd">        computed on the (coarse) ab-initio q-mesh</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_a2ftr</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_a2ftr</span><span class="p">(</span><span class="n">qsamp</span><span class="o">=</span><span class="s2">&quot;qcoarse&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="A2fFile.a2ftr_qintp"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fFile.a2ftr_qintp">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">a2ftr_qintp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :class:`A2ftr` with the Eliashberg transport spectral function a2F_tr(w, x, x&#39;)</span>
<span class="sd">        computed on the dense q-mesh by Fourier interpolation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_a2ftr</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_a2ftr</span><span class="p">(</span><span class="n">qsamp</span><span class="o">=</span><span class="s2">&quot;qintp&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="A2fFile.get_a2ftr_qsamp"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fFile.get_a2ftr_qsamp">[docs]</a>    <span class="k">def</span> <span class="nf">get_a2ftr_qsamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qsamp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the :class:`A2ftr` object associated to q-sampling ``qsamp``.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">qsamp</span> <span class="o">==</span> <span class="s2">&quot;qcoarse&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">a2ftr_qcoarse</span>
        <span class="k">if</span> <span class="n">qsamp</span> <span class="o">==</span> <span class="s2">&quot;qintp&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">a2ftr_qintp</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid value for qsamp `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">qsamp</span><span class="p">))</span></div>

<div class="viewcode-block" id="A2fFile.close"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fFile.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close the file.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="c1">#def interpolate(self, ddb, lpratio=5, vertices_names=None, line_density=20, filter_params=None, verbose=0):</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    Interpolate the phonon linewidths on a k-path and, optionally, on a k-mesh.</span>

    <span class="c1">#    Args:</span>
    <span class="c1">#        lpratio: Ratio between the number of star functions and the number of ab-initio k-points.</span>
    <span class="c1">#            The default should be OK in many systems, larger values may be required for accurate derivatives.</span>
    <span class="c1">#        vertices_names: Used to specify the k-path for the interpolated QP band structure</span>
    <span class="c1">#            when ``ks_ebands_kpath`` is None.</span>
    <span class="c1">#            It&#39;s a list of tuple, each tuple is of the form (kfrac_coords, kname) where</span>
    <span class="c1">#            kfrac_coords are the reduced coordinates of the k-point and kname is a string with the name of</span>
    <span class="c1">#            the k-point. Each point represents a vertex of the k-path. ``line_density`` defines</span>
    <span class="c1">#            the density of the sampling. If None, the k-path is automatically generated according</span>
    <span class="c1">#            to the point group of the system.</span>
    <span class="c1">#        line_density: Number of points in the smallest segment of the k-path. Used with ``vertices_names``.</span>
    <span class="c1">#        filter_params: TO BE DESCRIBED</span>
    <span class="c1">#        verbose: Verbosity level</span>

    <span class="c1">#    Returns:</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    # Get symmetries from abinit spacegroup (read from file).</span>
    <span class="c1">#    abispg = self.structure.abi_spacegroup</span>
    <span class="c1">#    fm_symrel = [s for (s, afm) in zip(abispg.symrel, abispg.symafm) if afm == 1]</span>

    <span class="c1">#    phbst_file, phdos_file = ddb.anaget_phbst_and_phdos_files(nqsmall=0, ndivsm=10, asr=2, chneut=1, dipdip=1,</span>
    <span class="c1">#        dos_method=&quot;tetra&quot;, lo_to_splitting=&quot;automatic&quot;, ngqpt=None, qptbounds=None, anaddb_kwargs=None, verbose=0,</span>
    <span class="c1">#        mpi_procs=1, workdir=None, manager=None)</span>

    <span class="c1">#    phbands = phbst_file.phbands</span>
    <span class="c1">#    phbst_file.close()</span>

    <span class="c1">#    # Read qibz and ab-initio linewidths from file.</span>
    <span class="c1">#    qcoords_ibz = self.reader.read_value(&quot;qibz&quot;)</span>
    <span class="c1">#    data_ibz = self.reader.read_value(&quot;phgamma_qibz&quot;) * units.Ha_to_eV</span>
    <span class="c1">#    import matplotlib.pyplot as plt</span>
    <span class="c1">#    plt.plot(data_ibz[0])</span>
    <span class="c1">#    plt.show()</span>

    <span class="c1">#    # Build interpolator.</span>
    <span class="c1">#    from abipy.core.skw import SkwInterpolator</span>
    <span class="c1">#    cell = (self.structure.lattice.matrix, self.structure.frac_coords, self.structure.atomic_numbers)</span>

    <span class="c1">#    has_timrev = True</span>
    <span class="c1">#    fermie, nelect = 0.0, 3 * len(self.structure)</span>
    <span class="c1">#    skw = SkwInterpolator(lpratio, qcoords_ibz, data_ibz, fermie, nelect,</span>
    <span class="c1">#                          cell, fm_symrel, has_timrev,</span>
    <span class="c1">#                          filter_params=filter_params, verbose=verbose)</span>

    <span class="c1">#    # Interpolate and set linewidths.</span>
    <span class="c1">#    qfrac_coords = [q.frac_coords for q in phbands.qpoints]</span>
    <span class="c1">#    phbands.linewidths = skw.interp_kpts(qfrac_coords).eigens</span>

    <span class="c1">#    return phbands</span>

<div class="viewcode-block" id="A2fFile.plot_eph_strength"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fFile.plot_eph_strength">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_eph_strength</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what_list</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;phbands&quot;</span><span class="p">,</span> <span class="s2">&quot;gamma&quot;</span><span class="p">,</span> <span class="s2">&quot;lambda&quot;</span><span class="p">),</span> <span class="n">ax_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot phonon bands with EPH coupling strength lambda(q, nu) and lambda(q, nu)</span>
<span class="sd">        These values have been Fourier interpolated by Abinit.</span>

<span class="sd">        Args:</span>
<span class="sd">            what_list: ``phfreqs`` for phonons, `lambda`` for the eph coupling strength,</span>
<span class="sd">                ``gamma`` for phonon linewidths.</span>
<span class="sd">            ax_list: List of |matplotlib-Axes| (same length as what_list)</span>
<span class="sd">                or None if a new figure should be created.</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                or scalar e.g. ``left``. If left (right) is None, default values are used</span>
<span class="sd">            label: String used to label the plot in the legend.</span>
<span class="sd">            fontsize: Legend and title fontsize.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">what_list</span> <span class="o">=</span> <span class="n">list_strings</span><span class="p">(</span><span class="n">what_list</span><span class="p">)</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">what_list</span><span class="p">),</span> <span class="mi">1</span>
        <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="n">ax_list</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                                <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax_list</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;eV&quot;</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ax_list</span><span class="p">,</span> <span class="n">what_list</span><span class="p">)):</span>
            <span class="c1"># Decorate the axis (e.g add ticks and labels).</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phbands</span><span class="o">.</span><span class="n">decorate_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;phbands&quot;</span><span class="p">:</span>
                <span class="c1"># Plot phonon bands</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">phbands</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Add eph coupling.</span>
                <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;lambda&quot;</span><span class="p">:</span>
                    <span class="n">yvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_phlambda_qpath</span><span class="p">()</span>
                    <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$\lambda(q,\nu)$&quot;</span>
                <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;gamma&quot;</span><span class="p">:</span>
                    <span class="n">yvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_phgamma_qpath</span><span class="p">()</span>
                    <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$\gamma(q,\nu)$ (eV)&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid value for what: `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">what</span><span class="p">))</span>

                <span class="n">style</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">linestyle</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;linestyle&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">),</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;linewidth&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="p">)</span>

                <span class="n">xvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phbands</span><span class="o">.</span><span class="n">qpoints</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">nu</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phbands</span><span class="o">.</span><span class="n">branches</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">yvals</span><span class="p">[:,</span> <span class="n">nu</span><span class="p">],</span>
                            <span class="n">label</span><span class="o">=</span><span class="n">label</span> <span class="k">if</span> <span class="p">(</span><span class="n">nu</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">label</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="o">**</span><span class="n">style</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>

        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">label</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="A2fFile.plot"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fFile.plot">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;gamma&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot phonon bands with gamma(q, nu) or lambda(q, nu) depending on the vaue of `what`.</span>

<span class="sd">        Args:</span>
<span class="sd">            what: ``lambda`` for eph coupling strength, ``gamma`` for phonon linewidths.</span>
<span class="sd">            units: Units for phonon plots. Possible values in (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;).</span>
<span class="sd">                Case-insensitive.</span>
<span class="sd">            scale: float used to scale the marker size.</span>
<span class="sd">            alpha: The alpha blending value for the markers between 0 (transparent) and 1 (opaque)</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                   or scalar e.g. ``left``. If left (right) is None, default values are used</span>
<span class="sd">            ax: |matplotlib-Axes| or None if a new figure should be created.</span>
<span class="sd">            colormap: matplotlib color map.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>

        <span class="c1"># Plot phonon bands.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phbands</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Add eph coupling.</span>
        <span class="n">xvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phbands</span><span class="o">.</span><span class="n">qpoints</span><span class="p">))</span>
        <span class="n">wvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phbands</span><span class="o">.</span><span class="n">phfreqs</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">phfactor_ev2units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>

        <span class="c1"># Sum contributions over nsppol (if spin-polarized)</span>
        <span class="c1"># TODO units</span>
        <span class="n">gammas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_phgamma_qpath</span><span class="p">()</span>
        <span class="n">lambdas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_phlambda_qpath</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;lambda&quot;</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="mi">500</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
            <span class="n">sqn</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span>
            <span class="n">cqn</span> <span class="o">=</span> <span class="n">gammas</span>
        <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;gamma&quot;</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">6</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
            <span class="n">sqn</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">gammas</span><span class="p">)</span>
            <span class="n">cqn</span> <span class="o">=</span> <span class="n">lambdas</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid what: `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">what</span><span class="p">))</span>

        <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">cqn</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">cqn</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phbands</span><span class="o">.</span><span class="n">branches</span><span class="p">)),</span>
                        <span class="n">wvals</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="c1"># [q, nu] --&gt; [nu, q]</span>
                        <span class="n">s</span><span class="o">=</span><span class="n">sqn</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                        <span class="n">c</span><span class="o">=</span><span class="n">cqn</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                        <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                        <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                        <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                        <span class="c1">#label=term if ib == 0 else None</span>
        <span class="p">)</span>

        <span class="c1"># Make a color bar</span>
        <span class="c1">#plt.colorbar(sc, ax=ax, orientation=&quot;horizontal&quot;, pad=0.2)</span>
        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="A2fFile.plot_a2f_interpol"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fFile.plot_a2f_interpol">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_a2f_interpol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compare ab-initio a2F(w) with interpolated values.</span>

<span class="sd">        Args:</span>
<span class="sd">            units: Units for phonon plots. Possible values in (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;).</span>
<span class="sd">                Case-insensitive.</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                or scalar e.g. ``left``. If left (right) is None, default values are used</span>
<span class="sd">            fontsize: Legend and title fontsize</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">what_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;a2f&quot;</span><span class="p">,</span> <span class="s2">&quot;lambda&quot;</span><span class="p">]</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">what_list</span><span class="p">),</span> <span class="mi">1</span>
        <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                                <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax_list</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="n">styles</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">qcoarse</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;linestyle&quot;</span><span class="p">:</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;b&quot;</span><span class="p">},</span>
            <span class="n">qintp</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;linestyle&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;r&quot;</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ax_list</span><span class="p">,</span> <span class="n">what_list</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">qsamp</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;qcoarse&quot;</span><span class="p">,</span> <span class="s2">&quot;qintp&quot;</span><span class="p">]:</span>
                <span class="n">a2f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_a2f_qsamp</span><span class="p">(</span><span class="n">qsamp</span><span class="p">)</span>
                <span class="n">a2f</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">what</span><span class="o">=</span><span class="n">what</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="n">ylims</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span>
                         <span class="n">label</span><span class="o">=</span><span class="n">qsamp</span> <span class="k">if</span> <span class="n">ix</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">styles</span><span class="p">[</span><span class="n">qsamp</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="A2fFile.plot_with_a2f"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fFile.plot_with_a2f">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_with_a2f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;gamma&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="n">qsamp</span><span class="o">=</span><span class="s2">&quot;qintp&quot;</span><span class="p">,</span> <span class="n">phdos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot phonon bands with lambda(q, nu) + a2F(w) + phonon DOS.</span>

<span class="sd">        Args:</span>
<span class="sd">            what: ``lambda`` for eph coupling strength, ``gamma`` for phonon linewidths.</span>
<span class="sd">            units: Units for phonon plots. Possible values in (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;). Case-insensitive.</span>
<span class="sd">            qsamp:</span>
<span class="sd">            phdos: |PhononDos| object. Used to plot the PhononDos on the right.</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                or scalar e.g. ``left``. If left (right) is None, default values are used</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Max three additional axes with [a2F, a2F_tr, DOS]</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">width_ratios</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_a2ftr</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">width_ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">phdos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">phdos</span> <span class="o">=</span> <span class="n">PhononDos</span><span class="o">.</span><span class="n">as_phdos</span><span class="p">(</span><span class="n">phdos</span><span class="p">)</span>
            <span class="n">ncols</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">width_ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>

        <span class="c1"># Build grid plot.</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="kn">import</span> <span class="n">GridSpec</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">gspec</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="n">width_ratios</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="n">ax_phbands</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">ax_doses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax_phbands</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>
            <span class="n">ax_doses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

        <span class="c1"># Plot phonon bands with markers.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">what</span><span class="o">=</span><span class="n">what</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="n">ylims</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_phbands</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Plot a2F(w)</span>
        <span class="n">a2f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_a2f_qsamp</span><span class="p">(</span><span class="n">qsamp</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">ax_doses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">a2f</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="n">ylims</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
        <span class="c1">#ax.yaxis.set_label_position(&quot;right&quot;)</span>
        <span class="c1">#ax.tick_params(labelbottom=&#39;off&#39;)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Plot a2Ftr(w)</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_a2ftr</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">ax_doses</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
            <span class="n">a2ftr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_a2ftr_qsamp</span><span class="p">(</span><span class="n">qsamp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a2ftr</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="n">ylims</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
            <span class="c1">#ax.yaxis.set_label_position(&quot;right&quot;)</span>
            <span class="c1">#ax.tick_params(labelbottom=&#39;off&#39;)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">ix</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Plot DOS g(w)</span>
        <span class="k">if</span> <span class="n">phdos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">ax_doses</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
            <span class="n">phdos</span><span class="o">.</span><span class="n">plot_dos_idos</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
            <span class="c1">#ax.yaxis.set_label_position(&quot;right&quot;)</span>
            <span class="c1">#ax.tick_params(labelbottom=&#39;off&#39;)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$F(\omega)$&quot;</span><span class="p">)</span>
            <span class="c1">#ax.set_ylabel(&quot;&quot;)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="A2fFile.yield_figs"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fFile.yield_figs">[docs]</a>    <span class="k">def</span> <span class="nf">yield_figs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function *generates* a predefined list of matplotlib figures with minimal input from the user.</span>
<span class="sd">        Used in abiview.py to get a quick look at the results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#yield self.plot(show=False)</span>
        <span class="c1">#yield self.plot_eph_strength(show=False)</span>
        <span class="c1">#yield self.plot_with_a2f(show=False)</span>

        <span class="c1">#for qsamp in [&quot;qcoarse&quot;, &quot;qintp&quot;]:</span>
        <span class="k">for</span> <span class="n">qsamp</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;qcoarse&quot;</span><span class="p">,]:</span>
            <span class="n">a2f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_a2f_qsamp</span><span class="p">(</span><span class="n">qsamp</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">a2f</span><span class="o">.</span><span class="n">plot_with_lambda</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;q-sampling: </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">a2f</span><span class="o">.</span><span class="n">ngqpt</span><span class="p">),</span> <span class="n">qsamp</span><span class="p">),</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

        <span class="c1">#yield self.plot_nuterms(show=False)</span>
        <span class="c1">#yield self.plot_a2(show=False)</span>
        <span class="c1">#yield self.plot_tc_vs_mustar(show=False)</span>

        <span class="c1">#if self.has_a2ftr:</span>
        <span class="c1">#    ncfile.a2ftr.plot();</span>

<div class="viewcode-block" id="A2fFile.write_notebook"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fFile.write_notebook">[docs]</a>    <span class="k">def</span> <span class="nf">write_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a jupyter_ notebook to ``nbpath``. If nbpath is None, a temporay file in the current</span>
<span class="sd">        working directory is created. Return path to the notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbformat</span><span class="p">,</span> <span class="n">nbv</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nbformat_nbv_nb</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;ncfile = abilab.abiopen(&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;print(ncfile)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;ncfile.ebands.plot();&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;ncfile.plot();&quot;</span><span class="p">),</span>
            <span class="c1">#nbv.new_code_cell(&quot;ncfile.plot_phlinewidths();&quot;),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;ncfile.plot_with_a2f();&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;ncfile.a2f.plot();&quot;</span><span class="p">),</span>
        <span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_a2ftr</span><span class="p">:</span>
            <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;ncfile.a2ftr.plot();&quot;</span><span class="p">),</span>
                <span class="c1">#nbv.new_code_cell(&quot;ncfile.plot_with_a2ftr();&quot;),</span>
            <span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_nb_nbpath</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nbpath</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="A2fRobot"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fRobot">[docs]</a><span class="k">class</span> <span class="nc">A2fRobot</span><span class="p">(</span><span class="n">Robot</span><span class="p">,</span> <span class="n">RobotWithEbands</span><span class="p">,</span> <span class="n">RobotWithPhbands</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This robot analyzes the results contained in multiple A2F.nc files.</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: A2fRobot</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#TODO: Method to plot the convergence of DOS(e_F)</span>
    <span class="n">EXT</span> <span class="o">=</span> <span class="s2">&quot;A2F&quot;</span>

    <span class="n">linestyle_qsamp</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">qcoarse</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">qintp</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
    <span class="n">marker_qsamp</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">qcoarse</span><span class="o">=</span><span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="n">qintp</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">)</span>

    <span class="c1">#all_qsamps = [&quot;qcoarse&quot;, &quot;qintp&quot;]</span>
    <span class="n">all_qsamps</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;qcoarse&quot;</span><span class="p">,]</span>

<div class="viewcode-block" id="A2fRobot.get_dataframe"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fRobot.get_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">get_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">abspath</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">with_geo</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">with_params</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">funcs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build and return a |pandas-DataFrame| with the most important results.</span>

<span class="sd">        Args:</span>
<span class="sd">            abspath: True if paths in index should be absolute. Default: Relative to getcwd().</span>
<span class="sd">            with_geo: True if structure info should be added to the dataframe</span>
<span class="sd">            funcs: Function or list of functions to execute to add more data to the DataFrame.</span>
<span class="sd">                Each function receives a :class:`A2fFile` object and returns a tuple (key, value)</span>
<span class="sd">                where key is a string with the name of column and value is the value to be inserted.</span>
<span class="sd">            with_params: False to exclude calculation parameters from the dataframe.</span>

<span class="sd">        Return: |pandas-DataFrame|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rows</span><span class="p">,</span> <span class="n">row_names</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">row_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">qsamp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_qsamps</span><span class="p">:</span>
                <span class="n">a2f</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">get_a2f_qsamp</span><span class="p">(</span><span class="n">qsamp</span><span class="p">)</span>
                <span class="n">d</span><span class="p">[</span><span class="s2">&quot;lambda_&quot;</span> <span class="o">+</span> <span class="n">qsamp</span><span class="p">]</span> <span class="o">=</span> <span class="n">a2f</span><span class="o">.</span><span class="n">lambda_iso</span>
                <span class="n">d</span><span class="p">[</span><span class="s2">&quot;omegalog_&quot;</span> <span class="o">+</span> <span class="n">qsamp</span><span class="p">]</span> <span class="o">=</span> <span class="n">a2f</span><span class="o">.</span><span class="n">omega_log</span>

                <span class="c1"># Add transport properties.</span>
                <span class="k">if</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">has_a2ftr</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">qsamp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_qsamps</span><span class="p">:</span>
                        <span class="n">a2ftr</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">get_a2ftr_qsamp</span><span class="p">(</span><span class="n">qsamp</span><span class="p">)</span>
                        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;lambdatr_avg_&quot;</span> <span class="o">+</span> <span class="n">qsamp</span><span class="p">]</span> <span class="o">=</span> <span class="n">a2f</span><span class="o">.</span><span class="n">lambda_tr</span>

            <span class="c1"># Add info on structure.</span>
            <span class="k">if</span> <span class="n">with_geo</span><span class="p">:</span>
                <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ncfile</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">get_dict4pandas</span><span class="p">(</span><span class="n">with_spglib</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

            <span class="c1"># Add convergence parameters</span>
            <span class="k">if</span> <span class="n">with_params</span><span class="p">:</span>
                <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ncfile</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

            <span class="c1"># Execute functions.</span>
            <span class="k">if</span> <span class="n">funcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exec_funcs</span><span class="p">(</span><span class="n">funcs</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">))</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="n">row_names</span> <span class="o">=</span> <span class="n">row_names</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">abspath</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_relpaths</span><span class="p">(</span><span class="n">row_names</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">row_names</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span></div>

<div class="viewcode-block" id="A2fRobot.plot_lambda_convergence"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fRobot.plot_lambda_convergence">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_lambda_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;lambda&quot;</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the convergence of the lambda(q, nu) parameters wrt to the ``sortby`` parameter.</span>

<span class="sd">        Args:</span>
<span class="sd">            what: &quot;lambda&quot; for eph strength, gamma for phonon linewidths.</span>
<span class="sd">            sortby: Define the convergence parameter, sort files and produce plot labels.</span>
<span class="sd">                Can be None, string or function. If None, no sorting is performed.</span>
<span class="sd">                If string and not empty it&#39;s assumed that the abifile has an attribute</span>
<span class="sd">                with the same name and `getattr` is invoked.</span>
<span class="sd">                If callable, the output of sortby(abifile) is used.</span>
<span class="sd">            hue: Variable that define subsets of the data, which will be drawn on separate lines.</span>
<span class="sd">                Accepts callable or string</span>
<span class="sd">                If string, it&#39;s assumed that the abifile has an attribute with the same name and getattr is invoked.</span>
<span class="sd">                If callable, the output of hue(abifile) is used.</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                   or scalar e.g. ``left``. If left (right) is None, default values are used</span>
<span class="sd">            fontsize: Legend and title fontsize.</span>
<span class="sd">            colormap: matplotlib color map.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Build (1, ngroups) grid plot.</span>
        <span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">labels_ncfiles_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="n">sortby</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_and_sortby</span><span class="p">(</span><span class="n">hue</span><span class="p">,</span> <span class="n">sortby</span><span class="p">)</span>
            <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>

        <span class="n">ax_mat</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                               <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Plot all results on the same figure with different color.</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels_ncfiles_params</span><span class="p">):</span>
                <span class="n">ncfile</span><span class="o">.</span><span class="n">plot_eph_strength</span><span class="p">(</span><span class="n">what_list</span><span class="o">=</span><span class="n">what</span><span class="p">,</span>
                        <span class="n">ax_list</span><span class="o">=</span><span class="p">[</span><span class="n">ax_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
                        <span class="n">ylims</span><span class="o">=</span><span class="n">ylims</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sortby_label</span><span class="p">(</span><span class="n">sortby</span><span class="p">,</span> <span class="n">param</span><span class="p">),</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span>
                        <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ngroup figures</span>
            <span class="k">for</span> <span class="n">ig</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">groups</span><span class="p">):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">ax_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ig</span><span class="p">]</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_label</span><span class="p">(</span><span class="n">hue</span><span class="p">),</span> <span class="n">g</span><span class="o">.</span><span class="n">hvalue</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ifile</span><span class="p">,</span> <span class="n">ncfile</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">abifiles</span><span class="p">):</span>
                    <span class="n">ncfile</span><span class="o">.</span><span class="n">plot_eph_strength</span><span class="p">(</span><span class="n">what_list</span><span class="o">=</span><span class="n">what</span><span class="p">,</span>
                        <span class="n">ax_list</span><span class="o">=</span><span class="p">[</span><span class="n">ax</span><span class="p">],</span>
                        <span class="n">ylims</span><span class="o">=</span><span class="n">ylims</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">ifile</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="p">)),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span>
                        <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="p">)</span>
                <span class="k">if</span> <span class="n">ig</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">set_visible</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;ylabel&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="A2fRobot.plot_a2f_convergence"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fRobot.plot_a2f_convergence">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_a2f_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">qsamps</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the convergence of the Eliashberg function wrt to the ``sortby`` parameter.</span>

<span class="sd">        Args:</span>
<span class="sd">            sortby: Define the convergence parameter, sort files and produce plot labels.</span>
<span class="sd">                Can be None, string or function. If None, no sorting is performed.</span>
<span class="sd">                If string and not empty it&#39;s assumed that the abifile has an attribute</span>
<span class="sd">                with the same name and `getattr` is invoked.</span>
<span class="sd">                If callable, the output of sortby(abifile) is used.</span>
<span class="sd">            hue: Variable that define subsets of the data, which will be drawn on separate lines.</span>
<span class="sd">                Accepts callable or string</span>
<span class="sd">                If string, it&#39;s assumed that the abifile has an attribute with the same name and getattr is invoked.</span>
<span class="sd">                If callable, the output of hue(abifile) is used.</span>
<span class="sd">            qsamps:</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                   or scalar e.g. ``left``. If left (right) is None, default values are used.</span>
<span class="sd">            fontsize: Legend and title fontsize.</span>
<span class="sd">            colormap: matplotlib color map.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qsamps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_qsamps</span> <span class="k">if</span> <span class="n">qsamps</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span> <span class="k">else</span> <span class="n">list_strings</span><span class="p">(</span><span class="n">qsamps</span><span class="p">)</span>
        <span class="c1">#qsamps = [&quot;qcoarse&quot;]</span>

        <span class="c1"># Build (2, ngroups) grid plot.</span>
        <span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">labels_ncfiles_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="n">sortby</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qsamps</span><span class="p">),</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_and_sortby</span><span class="p">(</span><span class="n">hue</span><span class="p">,</span> <span class="n">sortby</span><span class="p">)</span>
            <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qsamps</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>

        <span class="n">ax_mat</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                               <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">qsamp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">qsamps</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">ax_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">ncfile</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels_ncfiles_params</span><span class="p">):</span>
                    <span class="n">ncfile</span><span class="o">.</span><span class="n">get_a2f_qsamp</span><span class="p">(</span><span class="n">qsamp</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">what</span><span class="o">=</span><span class="s2">&quot;a2f&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                       <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sortby_label</span><span class="p">(</span><span class="n">sortby</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">qsamp</span><span class="p">,</span>
                       <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">j</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span>
                       <span class="n">linestyle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linestyle_qsamp</span><span class="p">[</span><span class="n">qsamp</span><span class="p">],</span>
                       <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ig</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">groups</span><span class="p">):</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">ax_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ig</span><span class="p">]</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_label</span><span class="p">(</span><span class="n">hue</span><span class="p">),</span> <span class="n">g</span><span class="o">.</span><span class="n">hvalue</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">qsamp</span>
                    <span class="k">for</span> <span class="n">ncfile</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">abifiles</span><span class="p">:</span>
                        <span class="n">ncfile</span><span class="o">.</span><span class="n">get_a2f_qsamp</span><span class="p">(</span><span class="n">qsamp</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">what</span><span class="o">=</span><span class="s2">&quot;a2f&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                            <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                            <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">ig</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="p">)),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span>
                            <span class="n">linestyle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linestyle_qsamp</span><span class="p">[</span><span class="n">qsamp</span><span class="p">],</span>
                            <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ig</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">set_visible</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;ylabel&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qsamps</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">set_visible</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;xlabel&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="A2fRobot.plot_a2fdata_convergence"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fRobot.plot_a2fdata_convergence">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_a2fdata_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">qsamps</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">what_list</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;lambda_iso&quot;</span><span class="p">,</span> <span class="s2">&quot;omega_log&quot;</span><span class="p">),</span>
                                 <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the convergence of the isotropic lambda and omega_log wrt the ``sortby`` parameter.</span>

<span class="sd">        Args:</span>
<span class="sd">            sortby: Define the convergence parameter, sort files and produce plot labels.</span>
<span class="sd">                Can be None, string or function. If None, no sorting is performed.</span>
<span class="sd">                If string and not empty it&#39;s assumed that the abifile has an attribute</span>
<span class="sd">                with the same name and `getattr` is invoked.</span>
<span class="sd">                If callable, the output of sortby(abifile) is used.</span>
<span class="sd">            hue: Variable that define subsets of the data, which will be drawn on separate lines.</span>
<span class="sd">                Accepts callable or string</span>
<span class="sd">                If string, it&#39;s assumed that the abifile has an attribute with the same name and getattr is invoked.</span>
<span class="sd">                If callable, the output of hue(abifile) is used.</span>
<span class="sd">            qsamps:</span>
<span class="sd">            what_list:</span>
<span class="sd">            fontsize: Legend and title fontsize.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">what_list</span> <span class="o">=</span> <span class="n">list_strings</span><span class="p">(</span><span class="n">what_list</span><span class="p">)</span>

        <span class="c1"># Build grid with (n, 1) plots.</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">what_list</span><span class="p">),</span> <span class="mi">1</span>
        <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                                <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax_list</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">labels</span><span class="p">,</span> <span class="n">ncfiles</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="n">sortby</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_and_sortby</span><span class="p">(</span><span class="n">hue</span><span class="p">,</span> <span class="n">sortby</span><span class="p">)</span>

        <span class="n">qsamps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_qsamps</span> <span class="k">if</span> <span class="n">qsamps</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span> <span class="k">else</span> <span class="n">list_strings</span><span class="p">(</span><span class="n">qsamps</span><span class="p">)</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;marker&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ax_list</span><span class="p">,</span> <span class="n">what_list</span><span class="p">)):</span>
            <span class="c1">#ax.set_title(what, fontsize=fontsize)</span>
            <span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">params_are_string</span> <span class="o">=</span> <span class="n">duck</span><span class="o">.</span><span class="n">is_string</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">xvals</span> <span class="o">=</span> <span class="n">params</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">params_are_string</span> <span class="k">else</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
                <span class="n">l</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">iq</span><span class="p">,</span> <span class="n">qsamp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">qsamps</span><span class="p">):</span>
                    <span class="n">a2f_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ncfile</span><span class="o">.</span><span class="n">get_a2f_qsamp</span><span class="p">(</span><span class="n">qsamp</span><span class="p">)</span> <span class="k">for</span> <span class="n">ncfile</span> <span class="ow">in</span> <span class="n">ncfiles</span><span class="p">]</span>
                    <span class="n">yvals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">a2f</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span> <span class="k">for</span> <span class="n">a2f</span> <span class="ow">in</span> <span class="n">a2f_list</span><span class="p">]</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">yvals</span><span class="p">,</span>
                                <span class="n">marker</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">marker_qsamp</span><span class="p">[</span><span class="n">qsamp</span><span class="p">],</span>
                                <span class="n">linestyle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linestyle_qsamp</span><span class="p">[</span><span class="n">qsamp</span><span class="p">],</span>
                                <span class="n">color</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">iq</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">(),</span>
                                <span class="p">)</span>
                    <span class="k">if</span> <span class="n">params_are_string</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xvals</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">iq</span><span class="p">,</span> <span class="n">qsamp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">qsamps</span><span class="p">):</span>
                        <span class="n">a2f_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ncfile</span><span class="o">.</span><span class="n">get_a2f_qsamp</span><span class="p">(</span><span class="n">qsamp</span><span class="p">)</span> <span class="k">for</span> <span class="n">ncfile</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">abifiles</span><span class="p">]</span>
                        <span class="n">yvals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">a2f</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span> <span class="k">for</span> <span class="n">a2f</span> <span class="ow">in</span> <span class="n">a2f_list</span><span class="p">]</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_label</span><span class="p">(</span><span class="n">hue</span><span class="p">),</span> <span class="n">g</span><span class="o">.</span><span class="n">hvalue</span><span class="p">)</span> <span class="k">if</span> <span class="n">iq</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
                        <span class="n">l</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">xvalues</span><span class="p">,</span> <span class="n">yvals</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                    <span class="n">marker</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">marker_qsamp</span><span class="p">[</span><span class="n">qsamp</span><span class="p">],</span>
                                    <span class="n">linestyle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linestyle_qsamp</span><span class="p">[</span><span class="n">qsamp</span><span class="p">],</span>
                                    <span class="n">color</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">iq</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">(),</span>
                                    <span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">_LATEX_LABELS</span><span class="p">[</span><span class="n">what</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">ix</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">what_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_label</span><span class="p">(</span><span class="n">sortby</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">sortby</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">rotate_ticklabels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="A2fRobot.gridplot_a2f"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fRobot.gridplot_a2f">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">gridplot_a2f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot grid with a2F(w) and lambda(w) for all files treated by the robot.</span>

<span class="sd">        Args:</span>
<span class="sd">            xlims: Set the data limits for the y-axis. Accept tuple e.g. ``(left, right)``</span>
<span class="sd">                or scalar e.g. ``left``. If left (right) is None, default values are used</span>
<span class="sd">            sharex, sharey: True to share x- and y-axis.</span>
<span class="sd">            fontsize: Legend and title fontsize</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gridplot_a2f_what</span><span class="p">(</span><span class="s2">&quot;a2f&quot;</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="n">xlims</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">sharex</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">sharey</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="c1">#@add_fig_kwargs</span>
    <span class="c1">#def gridplot_a2ftr(self, xlims=None, fontsize=8, sharex=True, sharey=True, **kwargs):</span>
    <span class="c1">#    return self._gridplot_a2f_what(&quot;a2ftr&quot;, xlims=xlims, fontsize=fontsize, sharex=sharex, sharey=sharey, **kwargs)</span>

    <span class="k">def</span> <span class="nf">_gridplot_a2f_what</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">qsamps</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal method to plot a2F or a2f_tr&quot;&quot;&quot;</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">nplots</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nplots</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="n">nplots</span> <span class="o">//</span> <span class="n">ncols</span> <span class="o">+</span> <span class="n">nplots</span> <span class="o">%</span> <span class="n">ncols</span>

        <span class="c1"># Build grid plot</span>
        <span class="n">ax_list</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                                <span class="n">sharex</span><span class="o">=</span><span class="n">sharex</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">sharey</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax_list</span> <span class="o">=</span> <span class="n">ax_list</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="c1"># don&#39;t show the last ax if nplots is odd.</span>
        <span class="k">if</span> <span class="n">nplots</span> <span class="o">%</span> <span class="n">ncols</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ax_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

        <span class="n">qsamps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_qsamps</span> <span class="k">if</span> <span class="n">qsamps</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span> <span class="k">else</span> <span class="n">list_strings</span><span class="p">(</span><span class="n">qsamps</span><span class="p">)</span>
        <span class="c1">#qsamps = [&quot;qcoarse&quot;]</span>
        <span class="k">for</span> <span class="n">qsamp</span> <span class="ow">in</span> <span class="n">qsamps</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;a2f&quot;</span><span class="p">:</span>
                <span class="n">a2f_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ncfile</span><span class="o">.</span><span class="n">get_a2f_qsamp</span><span class="p">(</span><span class="n">qsamp</span><span class="p">)</span> <span class="k">for</span> <span class="n">ncfile</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;a2ftr&quot;</span><span class="p">:</span>
                <span class="n">a2f_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_a2ftr_qsamp</span><span class="p">(</span><span class="n">qsamp</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid value for what: `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="n">what</span><span class="p">)</span>

            <span class="n">a2f_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ncfile</span><span class="o">.</span><span class="n">get_a2f_qsamp</span><span class="p">(</span><span class="n">qsamp</span><span class="p">)</span> <span class="k">for</span> <span class="n">ncfile</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">a2f</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">a2f_list</span><span class="p">,</span> <span class="n">ax_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
                <span class="n">irow</span><span class="p">,</span> <span class="n">icol</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ncols</span><span class="p">)</span>
                <span class="c1"># FIXME: Twinx is problematic</span>
                <span class="n">a2f</span><span class="o">.</span><span class="n">plot_with_lambda</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">linestyle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linestyle_qsamp</span><span class="p">[</span><span class="n">qsamp</span><span class="p">],</span>
                                     <span class="p">)</span>

                <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">irow</span><span class="p">,</span> <span class="n">icol</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">set_visible</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;ylabel&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">irow</span> <span class="o">!=</span> <span class="n">nrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">set_visible</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;xlabel&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>

    <span class="c1">#@add_fig_kwargs</span>
    <span class="c1">#def plot_a2ftr_convergence(self, sortby=None, qsamps=&quot;all&quot;, ax=None, xlims=None,</span>
    <span class="c1">#                           fontsize=8, colormap=&quot;jet&quot;, **kwargs):</span>
    <span class="c1">#    qsamps = self.all_qsamps if qsamps == &quot;all&quot; else list_strings(qsamps)</span>
    <span class="c1">#    ax, fig, plt = get_ax_fig_plt(ax=ax)</span>
    <span class="c1">#    cmap = plt.get_cmap(colormap)</span>
    <span class="c1">#    for i, (label, ncfile, param) in enumerate(self.sortby(sortby)):</span>
    <span class="c1">#        for qsamp in qsamps:</span>
    <span class="c1">#            ncfile.get_a2ftr_qsamp(qsamp).plot(</span>
    <span class="c1">#                    ax=ax=ax,</span>
    <span class="c1">#                    label=self.sortby_label(sortby, param),</span>
    <span class="c1">#                    color=cmap(i / len(self)),</span>
    <span class="c1">#                    show=False,</span>
    <span class="c1">#                    )</span>
    <span class="c1">#    set_axlims(ax, xlims, &quot;x&quot;)</span>
    <span class="c1">#    return fig</span>

<div class="viewcode-block" id="A2fRobot.yield_figs"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fRobot.yield_figs">[docs]</a>    <span class="k">def</span> <span class="nf">yield_figs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function *generates* a predefined list of matplotlib figures with minimal input from the user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#yield self.plot_lambda_convergence(show=False)</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_a2f_convergence</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_a2fdata_convergence</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">gridplot_a2f</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="A2fRobot.write_notebook"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fRobot.write_notebook">[docs]</a>    <span class="k">def</span> <span class="nf">write_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a jupyter_ notebook to ``nbpath``. If nbpath is None, a temporay file in the current</span>
<span class="sd">        working directory is created. Return path to the notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbformat</span><span class="p">,</span> <span class="n">nbv</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nbformat_nbv_nb</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">[(</span><span class="n">l</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="c1">#nbv.new_markdown_cell(&quot;# This is a markdown cell&quot;),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;robot = abilab.A2fRobot(*</span><span class="si">%s</span><span class="s2">)</span><span class="se">\n</span><span class="s2">robot.trim_paths()</span><span class="se">\n</span><span class="s2">robot&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">)),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;data = robot.get_dataframe()</span><span class="se">\n</span><span class="s2">data&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;robot.plot_lambda_convergence();&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;robot.plot_a2f_convergence();&quot;</span><span class="p">),</span>
        <span class="p">])</span>

        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">ncf</span><span class="o">.</span><span class="n">has_a2ftr</span> <span class="k">for</span> <span class="n">ncf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">):</span>
            <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;robot.plot_a2ftr_convergence();&quot;</span><span class="p">),</span>
            <span class="p">])</span>

        <span class="c1"># Mixins.</span>
        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_baserobot_code_cells</span><span class="p">())</span>
        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_ebands_code_cells</span><span class="p">())</span>
        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_phbands_code_cells</span><span class="p">())</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_nb_nbpath</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nbpath</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="A2fReader"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fReader">[docs]</a><span class="k">class</span> <span class="nc">A2fReader</span><span class="p">(</span><span class="n">BaseEphReader</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads data from the EPH.nc file and constructs objects.</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: A2fReader</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="A2fReader.read_edos"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fReader.read_edos">[docs]</a>    <span class="k">def</span> <span class="nf">read_edos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the |ElectronDos| used to compute EPH quantities.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;edos_mesh&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">Ha_to_eV</span>
        <span class="c1"># [nsppol+1, nw] arrays with TOT_DOS, Spin_up, Spin_down in a.u.</span>
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s2">&quot;edos_dos&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># Spin polarized. Extract up-down components.</span>
            <span class="n">spin_dos</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">Ha_to_eV</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Spin unpolarized. Extract Tot DOS</span>
            <span class="n">spin_dos</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">Ha_to_eV</span>

        <span class="c1">#spin_idos = self.read_variable(&quot;edos_idos&quot;)[1:, :] / units.Ha_to_eV</span>
        <span class="n">nelect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;number_of_electrons&quot;</span><span class="p">)</span>
        <span class="n">fermie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;fermi_energy&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">Ha_to_eV</span>

        <span class="k">return</span> <span class="n">ElectronDos</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">spin_dos</span><span class="p">,</span> <span class="n">nelect</span><span class="p">,</span> <span class="n">fermie</span><span class="o">=</span><span class="n">fermie</span><span class="p">)</span></div>

<div class="viewcode-block" id="A2fReader.read_phbands_qpath"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fReader.read_phbands_qpath">[docs]</a>    <span class="k">def</span> <span class="nf">read_phbands_qpath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read and return a |PhononBands| object with frequencies computed along the q-path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_structure</span><span class="p">()</span>

        <span class="c1"># Build the list of q-points</span>
        <span class="n">qpoints</span> <span class="o">=</span> <span class="n">Kpath</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">,</span>
                        <span class="n">frac_coords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;qpath&quot;</span><span class="p">),</span>
                        <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ksampling</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1">#nctkarr_t(&#39;phfreq_qpath&#39;, &quot;dp&quot;, &quot;natom3, nqpath&quot;),&amp;</span>
        <span class="n">phfreqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;phfreq_qpath&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">Ha_to_eV</span>
        <span class="n">phdispl_cart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;phdispl_cart_qpath&quot;</span><span class="p">,</span> <span class="n">cmode</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">bohr_to_ang</span>

        <span class="n">linewidths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_phgamma_qpath</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_nsppol</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># We have spin-resolved linewidths, sum over spins here.</span>
            <span class="n">linewidths</span> <span class="o">=</span> <span class="n">linewidths</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">amu_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;atomic_mass_units&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">amu_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">atom_species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;atomic_numbers&quot;</span><span class="p">)</span>
            <span class="n">amu</span> <span class="o">=</span> <span class="p">{</span><span class="n">at</span><span class="p">:</span> <span class="n">a</span> <span class="k">for</span> <span class="n">at</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">atom_species</span><span class="p">,</span> <span class="n">amu_list</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;atomic_mass_units is not present!&quot;</span><span class="p">)</span>
            <span class="n">amu</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">PhononBands</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span>
                           <span class="n">qpoints</span><span class="o">=</span><span class="n">qpoints</span><span class="p">,</span>
                           <span class="n">phfreqs</span><span class="o">=</span><span class="n">phfreqs</span><span class="p">,</span>
                           <span class="n">phdispl_cart</span><span class="o">=</span><span class="n">phdispl_cart</span><span class="p">,</span>
                           <span class="n">non_anal_ph</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">amu</span><span class="o">=</span><span class="n">amu</span><span class="p">,</span>
                           <span class="n">linewidths</span><span class="o">=</span><span class="n">linewidths</span><span class="p">,</span>
                           <span class="p">)</span></div>

<div class="viewcode-block" id="A2fReader.read_phlambda_qpath"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fReader.read_phlambda_qpath">[docs]</a>    <span class="k">def</span> <span class="nf">read_phlambda_qpath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sum_spin</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads the EPH coupling strength *interpolated* along the q-path.</span>

<span class="sd">        Return:</span>
<span class="sd">            |numpy-array| with shape [nqpath, natom3] if not sum_spin else [nsppol, nqpath, natom3]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;phlambda_qpath&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vals</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">sum_spin</span> <span class="k">else</span> <span class="n">vals</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="A2fReader.read_phgamma_qpath"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fReader.read_phgamma_qpath">[docs]</a>    <span class="k">def</span> <span class="nf">read_phgamma_qpath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sum_spin</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads the phonon linewidths (eV) *interpolated* along the q-path.</span>

<span class="sd">        Return:</span>
<span class="sd">            |numpy-array| with shape [nqpath, natom3] if not sum_spin else [nsppol, nqpath, natom3]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;phgamma_qpath&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">Ha_to_eV</span>
        <span class="k">return</span> <span class="n">vals</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">sum_spin</span> <span class="k">else</span> <span class="n">vals</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="A2fReader.read_a2f"><a class="viewcode-back" href="../../../api/eph_api.html#abipy.eph.a2f.A2fReader.read_a2f">[docs]</a>    <span class="k">def</span> <span class="nf">read_a2f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qsamp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read and return the Eliashberg function :class:`A2F`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">qsamp</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;qcoarse&quot;</span><span class="p">,</span> <span class="s2">&quot;qintp&quot;</span><span class="p">)</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;a2f_mesh_&quot;</span> <span class="o">+</span> <span class="n">qsamp</span><span class="p">)</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">Ha_to_eV</span>
        <span class="c1"># C shape [nsppol, natom + 1, nomega]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;a2f_values_&quot;</span> <span class="o">+</span> <span class="n">qsamp</span><span class="p">)</span> <span class="c1"># * 0.25</span>
        <span class="n">values_spin</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">values_spin_nu</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Extract q-mesh and meta variables.</span>
        <span class="n">ngqpt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngqpt</span> <span class="k">if</span> <span class="n">qsamp</span> <span class="o">==</span> <span class="s2">&quot;qcoarse&quot;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph_ngqpt</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">common_eph_params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span>
                <span class="p">[</span><span class="s2">&quot;eph_intmeth&quot;</span><span class="p">,</span> <span class="s2">&quot;eph_fsewin&quot;</span><span class="p">,</span> <span class="s2">&quot;eph_fsmear&quot;</span><span class="p">,</span> <span class="s2">&quot;eph_extrael&quot;</span><span class="p">,</span> <span class="s2">&quot;eph_fermie&quot;</span><span class="p">]}</span>

        <span class="k">return</span> <span class="n">A2f</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">values_spin</span><span class="p">,</span> <span class="n">values_spin_nu</span><span class="p">,</span> <span class="n">ngqpt</span><span class="p">,</span> <span class="n">meta</span><span class="p">)</span></div></div>

    <span class="c1">#def read_a2ftr(self, qsamp):</span>
    <span class="c1">#    &quot;&quot;&quot;Read and return the Eliashberg transport spectral function a2F_tr(w, x, x&#39;).&quot;&quot;&quot;</span>
    <span class="c1">#    assert qsamp in (&quot;qcoarse&quot;, &quot;qintp&quot;)</span>
    <span class="c1">#    mesh = self.read_value(&quot;a2ftr_mesh_&quot; + qsamp) * units.Ha_to_eV</span>
    <span class="c1">#    # Transpose tensor components F --&gt; C</span>
    <span class="c1">#    vals_in = self.read_value(&quot;a2ftr_in_&quot; + qsamp)</span>
    <span class="c1">#    vals_out = self.read_value(&quot;a2ftr_out_&quot; + qsamp)</span>
    <span class="c1">#    return A2ftr(mesh=mesh, vals_in, vals_out)</span>

    <span class="c1">#def read_phgamma_ibz_data(self):</span>
    <span class="c1">#     ! linewidths in IBZ</span>
    <span class="c1">#     nctkarr_t(&#39;qibz&#39;, &quot;dp&quot;, &quot;number_of_reduced_dimensions, nqibz&quot;), &amp;</span>
    <span class="c1">#     nctkarr_t(&#39;wtq&#39;, &quot;dp&quot;, &quot;nqibz&quot;), &amp;</span>
    <span class="c1">#     nctkarr_t(&#39;phfreq_qibz&#39;, &quot;dp&quot;, &quot;natom3, nqibz&quot;), &amp;</span>
    <span class="c1">#     nctkarr_t(&#39;phdispl_cart_qibz&#39;, &quot;dp&quot;, &quot;two, natom3, natom3, nqibz&quot;), &amp;</span>
    <span class="c1">#     nctkarr_t(&#39;phgamma_qibz&#39;, &quot;dp&quot;, &quot;natom3, nqibz, number_of_spins&quot;), &amp;</span>
    <span class="c1">#     nctkarr_t(&#39;phlambda_qibz&#39;, &quot;dp&quot;, &quot;natom3, nqibz, number_of_spins&quot;) &amp;</span>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2018, M. Giantomassi and the AbiPy group.<br/>
      Last updated on Mar 13, 2021.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.5.2.<br/>
    </p>
  </div>
</footer>
  </body>
</html>