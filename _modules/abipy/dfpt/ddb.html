<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>abipy.dfpt.ddb &#8212; abipy 0.7.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/my_style.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html">
          abipy</a>
        <span class="navbar-text navbar-version pull-left"><b>0.7.0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../features.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Getting AbiPy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../zzbiblio.html">Bibliography</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../scripts/index.html">Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gallery/index.html">AbiPy Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../postprocessing_howto.html">Post-processing How-To</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../workflows/taskmanager.html">TaskManager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../workflows/manager_examples.html">Manager Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../flow_gallery/index.html">Flow Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../flows_howto.html">Flows How-To</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../coding_guide.html">Coding guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html">Documenting AbiPy</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for abipy.dfpt.ddb</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: utf-8</span>
<span class="sd">&quot;&quot;&quot;DDB File.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">abipy.core.abinit_units</span> <span class="k">as</span> <span class="nn">abu</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">lru_cache</span>
<span class="kn">from</span> <span class="nn">monty.string</span> <span class="k">import</span> <span class="n">marquee</span><span class="p">,</span> <span class="n">list_strings</span>
<span class="kn">from</span> <span class="nn">monty.collections</span> <span class="k">import</span> <span class="n">AttrDict</span><span class="p">,</span> <span class="n">dict2namedtuple</span>
<span class="kn">from</span> <span class="nn">monty.functools</span> <span class="k">import</span> <span class="n">lazy_property</span>
<span class="kn">from</span> <span class="nn">monty.termcolor</span> <span class="k">import</span> <span class="n">cprint</span>
<span class="kn">from</span> <span class="nn">monty.dev</span> <span class="k">import</span> <span class="n">deprecated</span>
<span class="kn">from</span> <span class="nn">pymatgen.core.units</span> <span class="k">import</span> <span class="n">eV_to_Ha</span><span class="p">,</span> <span class="n">bohr_to_angstrom</span><span class="p">,</span> <span class="n">Energy</span>
<span class="kn">from</span> <span class="nn">abipy.flowtk</span> <span class="k">import</span> <span class="n">AnaddbTask</span>
<span class="kn">from</span> <span class="nn">abipy.core.mixins</span> <span class="k">import</span> <span class="n">TextFile</span><span class="p">,</span> <span class="n">Has_Structure</span><span class="p">,</span> <span class="n">NotebookWriter</span>
<span class="kn">from</span> <span class="nn">abipy.core.symmetries</span> <span class="k">import</span> <span class="n">AbinitSpaceGroup</span>
<span class="kn">from</span> <span class="nn">abipy.core.structure</span> <span class="k">import</span> <span class="n">Structure</span>
<span class="kn">from</span> <span class="nn">abipy.core.kpoints</span> <span class="k">import</span> <span class="n">KpointList</span><span class="p">,</span> <span class="n">Kpoint</span>
<span class="kn">from</span> <span class="nn">abipy.iotools</span> <span class="k">import</span> <span class="n">ETSF_Reader</span>
<span class="kn">from</span> <span class="nn">abipy.tools.numtools</span> <span class="k">import</span> <span class="n">data_from_cplx_mode</span>
<span class="kn">from</span> <span class="nn">abipy.abio.inputs</span> <span class="k">import</span> <span class="n">AnaddbInput</span>
<span class="kn">from</span> <span class="nn">abipy.dfpt.phonons</span> <span class="k">import</span> <span class="n">PhononDosPlotter</span><span class="p">,</span> <span class="n">PhononBandsPlotter</span>
<span class="kn">from</span> <span class="nn">abipy.dfpt.ifc</span> <span class="k">import</span> <span class="n">InteratomicForceConstants</span>
<span class="kn">from</span> <span class="nn">abipy.dfpt.elastic</span> <span class="k">import</span> <span class="n">ElasticData</span>
<span class="kn">from</span> <span class="nn">abipy.core.abinit_units</span> <span class="k">import</span> <span class="n">phfactor_ev2units</span><span class="p">,</span> <span class="n">phunit_tag</span>
<span class="kn">from</span> <span class="nn">abipy.tools.plotting</span> <span class="k">import</span> <span class="n">add_fig_kwargs</span><span class="p">,</span> <span class="n">get_ax_fig_plt</span><span class="p">,</span> <span class="n">get_axarray_fig_plt</span>
<span class="kn">from</span> <span class="nn">abipy.tools</span> <span class="k">import</span> <span class="n">duck</span>
<span class="kn">from</span> <span class="nn">abipy.tools.tensors</span> <span class="k">import</span> <span class="n">DielectricTensor</span><span class="p">,</span> <span class="n">ZstarTensor</span><span class="p">,</span> <span class="n">Stress</span>
<span class="kn">from</span> <span class="nn">abipy.abio.robots</span> <span class="k">import</span> <span class="n">Robot</span>


<div class="viewcode-block" id="DdbError"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbError">[docs]</a><span class="k">class</span> <span class="nc">DdbError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Error class raised by DDB.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="AnaddbError"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.AnaddbError">[docs]</a><span class="k">class</span> <span class="nc">AnaddbError</span><span class="p">(</span><span class="n">DdbError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exceptions raised when we try to execute :class:`AnaddbTask` in the :class:`DdbFile` methods</span>

<span class="sd">    An `AnaddbError` has a reference to the task and to the :class:`EventsReport` that contains</span>
<span class="sd">    the error messages of the run.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;task&quot;</span><span class="p">),</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;report&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">workdir = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">workdir</span><span class="p">]</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> errors&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">errors</span><span class="p">))</span>
            <span class="n">lines</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="k">for</span> <span class="n">err</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">errors</span><span class="p">]</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>


<div class="viewcode-block" id="DdbFile"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile">[docs]</a><span class="k">class</span> <span class="nc">DdbFile</span><span class="p">(</span><span class="n">TextFile</span><span class="p">,</span> <span class="n">Has_Structure</span><span class="p">,</span> <span class="n">NotebookWriter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object provides an interface to the DDB_ file produced by ABINIT</span>
<span class="sd">    as well as methods to compute phonon band structures, phonon DOS, thermodinamical properties ...</span>

<span class="sd">    About the indices (idir, ipert) used by Abinit (Fortran notation):</span>

<span class="sd">    * idir in [1, 2, 3] gives the direction (usually reduced direction, cart for strain)</span>
<span class="sd">    * ipert in [1, 2, ..., mpert] where mpert = natom + 6</span>

<span class="sd">        * ipert in [1, ..., natom] corresponds to atomic perturbations  (reduced dirs)</span>
<span class="sd">        * ipert = natom + 1 gives d/dk  (reduced dirs)</span>
<span class="sd">        * ipert = natom + 2 gives the electric field</span>
<span class="sd">        * ipert = natom + 3 gives the uniaxial stress (cartesian dirs)</span>
<span class="sd">        * ipert = natom + 4 gives the shear strees.   (cartesian dirs)</span>

<span class="sd">    .. rubric:: Inheritance</span>
<span class="sd">    .. inheritance-diagram:: DdbFile</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Error</span> <span class="o">=</span> <span class="n">DdbError</span>
    <span class="n">AnaddbError</span> <span class="o">=</span> <span class="n">AnaddbError</span>

<div class="viewcode-block" id="DdbFile.from_file"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.from_file">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Needed for the :class:`TextFile` abstract interface.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span></div>

<div class="viewcode-block" id="DdbFile.from_mpid"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.from_mpid">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_mpid</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">material_id</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fetch DDB file corresponding to a materials project ``material_id``,</span>
<span class="sd">        save it to temporary file and return new DdbFile object.</span>

<span class="sd">        Raises: MPRestError if DDB file is not available</span>

<span class="sd">        Args:</span>
<span class="sd">            material_id (str): Materials Project material_id (e.g., mp-1234).</span>
<span class="sd">            api_key (str): A String API key for accessing the MaterialsProject REST interface.</span>
<span class="sd">                If None, the code will check if there is a `PMG_MAPI_KEY` in your .pmgrc.yaml.</span>
<span class="sd">            endpoint (str): Url of endpoint to access the MaterialsProject REST interface.</span>
<span class="sd">                Defaults to the standard Materials Project REST address</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">abipy.core</span> <span class="k">import</span> <span class="n">restapi</span>
        <span class="k">with</span> <span class="n">restapi</span><span class="o">.</span><span class="n">get_mprester</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">)</span> <span class="k">as</span> <span class="n">rest</span><span class="p">:</span>
            <span class="n">ddb_string</span> <span class="o">=</span> <span class="n">rest</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s2">&quot;/materials/</span><span class="si">%s</span><span class="s2">/abinit_ddb&quot;</span> <span class="o">%</span> <span class="n">material_id</span><span class="p">)</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">tmpfile</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">material_id</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_DDB&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ddb_string</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">)</span></div>

<div class="viewcode-block" id="DdbFile.as_ddb"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.as_ddb">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">as_ddb</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an instance of |DdbFile| from a generic object `obj`.</span>
<span class="sd">        Accepts: DdbFile or filepath</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">obj</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span> <span class="k">else</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_header</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span> <span class="o">=</span> <span class="n">Structure</span><span class="o">.</span><span class="n">from_abivars</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
        <span class="c1"># Add AbinitSpacegroup (needed in guessed_ngkpt)</span>
        <span class="c1"># FIXME: kptopt is not reported in the header --&gt; has_timerev is always set to True</span>
        <span class="n">spgid</span><span class="p">,</span> <span class="n">has_timerev</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span><span class="o">.</span><span class="n">set_abi_spacegroup</span><span class="p">(</span><span class="n">AbinitSpaceGroup</span><span class="p">(</span><span class="n">spgid</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">symrel</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">tnons</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">symafm</span><span class="p">,</span> <span class="n">has_timerev</span><span class="p">))</span>

        <span class="c1"># Add forces to structure.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart_forces</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span><span class="o">.</span><span class="n">add_site_property</span><span class="p">(</span><span class="s2">&quot;cartesian_forces&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart_forces</span><span class="p">)</span>

        <span class="n">frac_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_qpoints</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_qpoints</span> <span class="o">=</span> <span class="n">KpointList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">,</span> <span class="n">frac_coords</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

<div class="viewcode-block" id="DdbFile.to_string"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">app</span><span class="p">,</span> <span class="n">extend</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">,</span> <span class="n">lines</span><span class="o">.</span><span class="n">extend</span>

        <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="s2">&quot;File Info&quot;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filestat</span><span class="p">(</span><span class="n">as_string</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Structure&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="s2">&quot;DDB Info&quot;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Number of q-points in DDB: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;guessed_ngqpt: </span><span class="si">%s</span><span class="s2"> (guess for the q-mesh divisions made by AbiPy)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">guessed_ngqpt</span><span class="p">)</span>
        <span class="c1">#if verbose:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span>
        <span class="c1">#app(&quot;Important parameters extracted from the header:&quot;)</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;ecut = </span><span class="si">%f</span><span class="s2">, ecutsm = </span><span class="si">%f</span><span class="s2">, nkpt = </span><span class="si">%d</span><span class="s2">, nsym = </span><span class="si">%d</span><span class="s2">, usepaw = </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">ecut</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">ecutsm</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">nkpt</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">nsym</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">usepaw</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;nsppol </span><span class="si">%d</span><span class="s2">, nspinor </span><span class="si">%d</span><span class="s2">, nspden </span><span class="si">%d</span><span class="s2">, ixc = </span><span class="si">%d</span><span class="s2">, occopt = </span><span class="si">%d</span><span class="s2">, tsmear = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">h</span><span class="o">.</span><span class="n">nsppol</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">nspinor</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">nspden</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">ixc</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">occopt</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">tsmear</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Has total energy: </span><span class="si">%s</span><span class="s2">, Has forces: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">total_energy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart_forces</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_energy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Total energy: </span><span class="si">%s</span><span class="s2"> [eV]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_energy</span><span class="p">)</span>
        <span class="c1">#app(&quot;Has forces: %s&quot; % (</span>
        <span class="c1">#if self.cart_forces is not None:</span>
        <span class="c1">#    app(&quot;Cartesian forces (eV/Ang):\n%s&quot; % (self.cart_forces))</span>
        <span class="c1">#    app(&quot;&quot;)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart_stress_tensor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Cartesian stress tensor in GPa with pressure </span><span class="si">%.3e</span><span class="s2"> (GPa):</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart_stress_tensor</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart_stress_tensor</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Has stress tensor: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cart_stress_tensor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Has (at least one) atomic pertubation: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_at_least_one_atomic_perturbation</span><span class="p">())</span>
        <span class="c1">#app(&quot;Has (at least one) electric-field perturbation: %s&quot; % self.has_epsinf_terms(select=&quot;at_least_one&quot;))</span>
        <span class="c1">#app(&quot;Has (all) electric-field perturbation: %s&quot; % self.has_epsinf_terms(select=&quot;all&quot;))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Has (at least one diagonal) electric-field perturbation: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">has_epsinf_terms</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="s2">&quot;at_least_one_diagoterm&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Has (at least one) Born effective charge: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_bec_terms</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="s2">&quot;at_least_one&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Has (all) strain terms: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_strain_terms</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Has (all) internal strain terms: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_internalstrain_terms</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Has (all) piezoelectric terms: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_piezoelectric_terms</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="c1"># Print q-points</span>
            <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Q-points in DDB&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Print full header.</span>
            <span class="kn">from</span> <span class="nn">pprint</span> <span class="k">import</span> <span class="n">pformat</span>
            <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="s2">&quot;DDB Header&quot;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
            <span class="n">app</span><span class="p">(</span><span class="n">pformat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;|Structure| object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">natom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of atoms in structure.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;DDB Version number (integer).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dictionary with the values reported in the header section.</span>
<span class="sd">        Use e.g. ``ddb.header.ecut`` to access its values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span>

    <span class="k">def</span> <span class="nf">_parse_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the header sections. Returns |AttrDict| dictionary.&quot;&quot;&quot;</span>
        <span class="c1">#ixc         7</span>
        <span class="c1">#kpt  0.00000000000000D+00  0.00000000000000D+00  0.00000000000000D+00</span>
        <span class="c1">#     0.25000000000000D+00  0.00000000000000D+00  0.00000000000000D+00</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">keyvals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">header_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">header_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="s2">&quot;Version&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="c1"># +DDB, Version number    100401</span>
                <span class="n">version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">line</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Description of the potentials (KB energies)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;No information on the potentials yet&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Description of the PAW dataset(s)&quot;</span><span class="p">):</span>
                <span class="c1"># Skip section with psps info.</span>
                <span class="k">break</span>

            <span class="c1"># header starts here</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">:</span>
                <span class="c1"># Python does not support exp format with D</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;D+&quot;</span><span class="p">,</span> <span class="s2">&quot;E+&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;D-&quot;</span><span class="p">,</span> <span class="s2">&quot;E-&quot;</span><span class="p">)</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">parse</span> <span class="o">=</span> <span class="nb">float</span> <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="nb">int</span>
                        <span class="n">keyvals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">parse</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)))</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="c1"># We have a new key</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">parse</span> <span class="o">=</span> <span class="nb">float</span> <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="nb">int</span>
                        <span class="n">keyvals</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">parse</span><span class="p">,</span> <span class="n">tokens</span><span class="p">))))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Exception:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">while parsing ddb header line:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                       <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span> <span class="n">line</span><span class="p">))</span>

        <span class="c1"># add the potential information</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;Database of total energy derivatives&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">header_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>

        <span class="n">h</span> <span class="o">=</span> <span class="n">AttrDict</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span> <span class="n">lines</span><span class="o">=</span><span class="n">header_lines</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">keyvals</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">h</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># Convert to array. Note that znucl is converted into integer</span>
        <span class="c1"># to avoid problems with pymatgen routines that expect integer Z</span>
        <span class="c1"># This of course will break any code for alchemical mixing.</span>
        <span class="n">arrays</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;acell&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">),</span>
            <span class="s2">&quot;amu&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">ntypat</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">),</span>
            <span class="s2">&quot;kpt&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">nkpt</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">),</span>
            <span class="s2">&quot;ngfft&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">),</span>
            <span class="c1"># This is problematic because not all occupation factors are written</span>
            <span class="c1">#&quot;occ&quot;: dict(shape=(h.nsppol, h.nkpt, h.nband), dtype=np.double),</span>
            <span class="s2">&quot;rprim&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">),</span>
            <span class="s2">&quot;spinat&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">natom</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">),</span>
            <span class="s2">&quot;symrel&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">nsym</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">),</span>
            <span class="s2">&quot;tnons&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">nsym</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">),</span>
            <span class="s2">&quot;xred&quot;</span><span class="p">:</span>  <span class="nb">dict</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">natom</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">),</span>
            <span class="c1"># In principle these two quantities are double but here we convert to int</span>
            <span class="c1"># Alchemical mixing is therefore ignored.</span>
            <span class="s2">&quot;znucl&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">ntypat</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">),</span>
            <span class="s2">&quot;zion&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">ntypat</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">),</span>
            <span class="s2">&quot;symafm&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">nsym</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">),</span>
            <span class="s2">&quot;wtk&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">nkpt</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">ainfo</span> <span class="ow">in</span> <span class="n">arrays</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">ainfo</span><span class="p">[</span><span class="s2">&quot;dtype&quot;</span><span class="p">]),</span> <span class="n">ainfo</span><span class="p">[</span><span class="s2">&quot;shape&quot;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;While Trying to reshape&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">exc</span>

        <span class="c1"># Transpose symrel because Abinit write matrices by columns.</span>
        <span class="n">h</span><span class="o">.</span><span class="n">symrel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">T</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">h</span><span class="o">.</span><span class="n">symrel</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">_read_qpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read the list q-points from the DDB file. Returns |numpy-array|.&quot;&quot;&quot;</span>
        <span class="c1"># 2nd derivatives (non-stat.)  - # elements :      36</span>
        <span class="c1"># qpt  2.50000000E-01  0.00000000E+00  0.00000000E+00   1.0</span>

        <span class="c1"># Since there are multiple occurrences of qpt in the DDB file</span>
        <span class="c1"># we use seen to remove duplicates.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">tokens</span><span class="p">,</span> <span class="n">seen</span> <span class="o">=</span> <span class="p">[],</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;qpt&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">line</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;qpt&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>

        <span class="n">qpoints</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="n">nums</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">tok</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>
            <span class="n">qpoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nums</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nums</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">qpoints</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<div class="viewcode-block" id="DdbFile.computed_dynmat"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.computed_dynmat">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">computed_dynmat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :class:`OrderedDict` mapping q-point object to --&gt; pandas Dataframe.</span>
<span class="sd">        The |pandas-DataFrame| contains the columns: &quot;idir1&quot;, &quot;ipert1&quot;, &quot;idir2&quot;, &quot;ipert2&quot;, &quot;cvalue&quot;</span>
<span class="sd">        and (idir1, ipert1, idir2, ipert2) as index.</span>

<span class="sd">        .. note::</span>

<span class="sd">            The indices follow the Abinit (Fortran) notation so they start at 1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Create mapping [(idir1, ipert1), (idir2, ipert2)] --&gt; element</span>
        <span class="n">df_columns</span> <span class="o">=</span> <span class="s2">&quot;idir1 ipert1 idir2 ipert2 cvalue&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

        <span class="n">dynmat</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">:</span>
            <span class="c1"># skip the blocks that are not related to second order derivatives</span>
            <span class="n">first_line</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">first_line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;2nd derivatives&quot;</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># Build q-point object.</span>
            <span class="n">qpt</span> <span class="o">=</span> <span class="n">Kpoint</span><span class="p">(</span><span class="n">frac_coords</span><span class="o">=</span><span class="n">block</span><span class="p">[</span><span class="s2">&quot;qpt&quot;</span><span class="p">],</span> <span class="n">lattice</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

            <span class="c1"># Build pandas dataframe with df_columns and (idir1, ipert1, idir2, ipert2) as index.</span>
            <span class="c1"># Each line in data represents an element of the dynamical matric</span>
            <span class="c1"># idir1 ipert1 idir2 ipert2 re_D im_D</span>
            <span class="n">df_rows</span><span class="p">,</span> <span class="n">df_index</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">block</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;2nd derivatives&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;qpt&quot;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">toks</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">idir1</span><span class="p">,</span> <span class="n">ipert1</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="n">idir2</span><span class="p">,</span> <span class="n">ipert2</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
                    <span class="n">toks</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">toks</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">)</span>
                    <span class="n">toks</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">toks</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">)</span>
                    <span class="n">cvalue</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;exception while parsing line: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">line</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">exc</span>

                <span class="n">df_index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p1</span> <span class="o">+</span> <span class="n">p2</span><span class="p">)</span>
                <span class="n">df_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">idir1</span><span class="o">=</span><span class="n">idir1</span><span class="p">,</span> <span class="n">ipert1</span><span class="o">=</span><span class="n">ipert1</span><span class="p">,</span> <span class="n">idir2</span><span class="o">=</span><span class="n">idir2</span><span class="p">,</span> <span class="n">ipert2</span><span class="o">=</span><span class="n">ipert2</span><span class="p">,</span> <span class="n">cvalue</span><span class="o">=</span><span class="n">cvalue</span><span class="p">))</span>

            <span class="n">dynmat</span><span class="p">[</span><span class="n">qpt</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df_rows</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df_index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">df_columns</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dynmat</span></div>

<div class="viewcode-block" id="DdbFile.blocks"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.blocks">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">blocks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        DDB blocks. List of dictionaries, Each dictionary contains the following keys.</span>
<span class="sd">        &quot;qpt&quot; with the reduced coordinates of the q-point.</span>
<span class="sd">        &quot;data&quot; that is a list of strings with the entries of the dynamical matrix for this q-point.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_blocks</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_read_blocks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># skip until the beginning of the db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">while</span> <span class="s2">&quot;Number of data blocks&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">readline</span><span class="p">():</span>
            <span class="k">pass</span>

        <span class="n">blocks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">block_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">qpt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dord</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="c1"># skip empty lines</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="s2">&quot;List of bloks and their characteristics&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="c1"># add last block when we reach the last part of the file.</span>
                <span class="c1"># This line is present only if DDB has been produced by mrgddb</span>
                <span class="k">if</span> <span class="n">block_lines</span><span class="p">:</span>
                    <span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">block_lines</span><span class="p">,</span> <span class="s2">&quot;qpt&quot;</span><span class="p">:</span> <span class="n">qpt</span><span class="p">,</span> <span class="s2">&quot;dord&quot;</span><span class="p">:</span> <span class="n">dord</span><span class="p">})</span>
                    <span class="n">block_lines</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">qpt</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">break</span>

            <span class="c1"># Don&#39;t use lstring because we may reuse block_lines to write new DDB.</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>

            <span class="c1"># new block --&gt; detect order</span>
            <span class="k">if</span> <span class="s2">&quot;# elements&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">block_lines</span><span class="p">:</span>
                    <span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">block_lines</span><span class="p">,</span> <span class="s2">&quot;qpt&quot;</span><span class="p">:</span> <span class="n">qpt</span><span class="p">,</span> <span class="s2">&quot;dord&quot;</span><span class="p">:</span> <span class="n">dord</span><span class="p">})</span>

                <span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">num_elements</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">dord</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Total energy&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s2">&quot;1st derivatives&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="s2">&quot;2nd derivatives&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="s2">&quot;3rd derivatives&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dord</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot detect derivative order from string: `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>

                <span class="n">block_lines</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">qpt</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">block_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;qpt&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">qpt</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">block_lines</span><span class="p">:</span>
            <span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">block_lines</span><span class="p">,</span> <span class="s2">&quot;qpt&quot;</span><span class="p">:</span> <span class="n">qpt</span><span class="p">,</span> <span class="s2">&quot;dord&quot;</span><span class="p">:</span> <span class="n">dord</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">blocks</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">qpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;|KpointList| object with the list of q-points in reduced coordinates.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qpoints</span>

<div class="viewcode-block" id="DdbFile.has_qpoint"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.has_qpoint">[docs]</a>    <span class="k">def</span> <span class="nf">has_qpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qpoint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if the DDB file contains this q-point.&quot;&quot;&quot;</span>
        <span class="c1">#qpoint = Kpoint.as_kpoint(qpoint, self.structure.reciprocal_lattice)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">qpoint</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="DdbFile.qindex"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.qindex">[docs]</a>    <span class="k">def</span> <span class="nf">qindex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qpoint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The index of the q-point in the internal list of q-points.</span>
<span class="sd">        Accepts: |Kpoint| instance or integer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">duck</span><span class="o">.</span><span class="n">is_intlike</span><span class="p">(</span><span class="n">qpoint</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">qpoint</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">qpoint</span><span class="p">)</span></div>

<div class="viewcode-block" id="DdbFile.guessed_ngqpt"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.guessed_ngqpt">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">guessed_ngqpt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Guess for the q-mesh divisions (ngqpt) inferred from the list of</span>
<span class="sd">        q-points found in the DDB file.</span>

<span class="sd">        .. warning::</span>

<span class="sd">            The mesh may not be correct if the DDB file contains points belonging</span>
<span class="sd">            to different meshes and/or the Q-mesh is shifted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_guess_ngqpt</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_guess_ngqpt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function tries to figure out the value of ngqpt from the list of</span>
<span class="sd">        points reported in the DDB file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># Build the union of the stars of the q-points.</span>
        <span class="n">all_qpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">abi_spacegroup</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">qpoint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">abi_spacegroup</span><span class="p">:</span>
                <span class="n">all_qpoints</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">rotate_k</span><span class="p">(</span><span class="n">qpoint</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">,</span> <span class="n">wrap_tows</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Replace zeros with np.inf</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">all_qpoints</span><span class="p">:</span>
            <span class="n">q</span><span class="p">[</span><span class="n">q</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

        <span class="c1"># Compute the minimum of the fractional coordinates along the 3 directions and invert</span>
        <span class="c1">#print(all_qpoints)</span>
        <span class="n">smalls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">all_qpoints</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">smalls</span><span class="p">[</span><span class="n">smalls</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">ngqpt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">smalls</span><span class="p">)</span>
        <span class="n">ngqpt</span><span class="p">[</span><span class="n">ngqpt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ngqpt</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>

<div class="viewcode-block" id="DdbFile.params"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.params">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;:class:`OrderedDict` with parameters that might be subject to convergence studies.&quot;&quot;&quot;</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;nkpt&quot;</span><span class="p">,</span> <span class="s2">&quot;nsppol&quot;</span><span class="p">,</span> <span class="s2">&quot;ecut&quot;</span><span class="p">,</span> <span class="s2">&quot;tsmear&quot;</span><span class="p">,</span> <span class="s2">&quot;occopt&quot;</span><span class="p">,</span> <span class="s2">&quot;ixc&quot;</span><span class="p">,</span> <span class="s2">&quot;nband&quot;</span><span class="p">,</span> <span class="s2">&quot;usepaw&quot;</span><span class="p">)</span>
        <span class="n">od</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">od</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">od</span></div>

    <span class="k">def</span> <span class="nf">_add_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add params (meta variable) to object ``obj``. Usually a phonon bands or phonon dos object.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;object </span><span class="si">%s</span><span class="s2"> does not have `params` attribute&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

<div class="viewcode-block" id="DdbFile.total_energy"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.total_energy">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">total_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Total energy in eV. None if not available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">block</span><span class="p">[</span><span class="s2">&quot;dord&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ene_ha</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">Energy</span><span class="p">(</span><span class="n">ene_ha</span><span class="p">,</span> <span class="s2">&quot;Ha&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;eV&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="DdbFile.cart_forces"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.cart_forces">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">cart_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cartesian forces in eV / Ang</span>
<span class="sd">        None if not available i.e. if the GS DDB has not been merged.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">block</span><span class="p">[</span><span class="s2">&quot;dord&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">natom</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>
            <span class="n">fred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">natom</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">block</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">idir</span><span class="p">,</span> <span class="n">ipert</span><span class="p">,</span> <span class="n">fval</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]</span>
                <span class="c1"># F --&gt; C</span>
                <span class="n">idir</span><span class="p">,</span> <span class="n">ipert</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idir</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">ipert</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">ipert</span> <span class="o">&lt;</span> <span class="n">natom</span><span class="p">:</span>
                    <span class="n">fred</span><span class="p">[</span><span class="n">ipert</span><span class="p">,</span> <span class="n">idir</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fval</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">))</span>

            <span class="c1"># Fred stores d(etotal)/d(xred)</span>
            <span class="c1"># this array has *not* been corrected by enforcing</span>
            <span class="c1"># the translational symmetry, namely that the sum of force</span>
            <span class="c1"># on all atoms is not necessarly zero.</span>
            <span class="c1"># Compute fcart using same code as in fred2fcart.</span>
            <span class="c1"># Note conversion to cartesian coordinates (bohr) AND</span>
            <span class="c1"># negation to make a force out of a gradient.</span>
            <span class="n">gprimd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="o">.</span><span class="n">matrix</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Bohr_Ang</span>
            <span class="c1">#fcart = - np.matmul(fred, gprimd)</span>
            <span class="n">fcart</span> <span class="o">=</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">fred</span><span class="p">,</span> <span class="n">gprimd</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="c1"># Subtract off average force from each force component</span>
            <span class="n">favg</span> <span class="o">=</span> <span class="n">fcart</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>
            <span class="n">fcart</span> <span class="o">-=</span> <span class="n">favg</span>

            <span class="k">return</span> <span class="n">fcart</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_eV</span> <span class="o">/</span> <span class="n">abu</span><span class="o">.</span><span class="n">Bohr_Ang</span>

        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="DdbFile.cart_stress_tensor"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.cart_stress_tensor">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">cart_stress_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        |Stress| tensor in cartesian coordinates (GPa units).</span>
<span class="sd">        None if not available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">block</span><span class="p">[</span><span class="s2">&quot;dord&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">svoigt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
            <span class="c1"># Abinit stress is in cart coords and Ha/Bohr**3</span>
            <span class="c1"># Map (idir, ipert) --&gt; voigt</span>
            <span class="n">uniax</span><span class="p">,</span> <span class="n">shear</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span>
            <span class="n">dirper2voigt</span> <span class="o">=</span> <span class="p">{</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">uniax</span><span class="p">):</span> <span class="mi">0</span><span class="p">,</span>
                <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">uniax</span><span class="p">):</span> <span class="mi">1</span><span class="p">,</span>
                <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">uniax</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">shear</span><span class="p">):</span> <span class="mi">3</span><span class="p">,</span>
                <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">shear</span><span class="p">):</span> <span class="mi">4</span><span class="p">,</span>
                <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">shear</span><span class="p">):</span> <span class="mi">5</span><span class="p">}</span>

            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">block</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">idir</span><span class="p">,</span> <span class="n">ipert</span><span class="p">,</span> <span class="n">fval</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">idp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idir</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">ipert</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">idp</span> <span class="ow">in</span> <span class="n">dirper2voigt</span><span class="p">:</span>
                    <span class="n">svoigt</span><span class="p">[</span><span class="n">dirper2voigt</span><span class="p">[</span><span class="n">idp</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fval</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">))</span>

            <span class="c1"># Convert from Ha/Bohr^3 to GPa</span>
            <span class="k">return</span> <span class="n">Stress</span><span class="o">.</span><span class="n">from_voigt</span><span class="p">(</span><span class="n">svoigt</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">HaBohr3_GPa</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="DdbFile.has_lo_to_data"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.has_lo_to_data">[docs]</a>    <span class="k">def</span> <span class="nf">has_lo_to_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="s2">&quot;at_least_one&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        True if the DDB file contains the data required to compute the LO-TO splitting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_epsinf_terms</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="n">select</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_bec_terms</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="n">select</span><span class="p">)</span></div>

<div class="viewcode-block" id="DdbFile.has_at_least_one_atomic_perturbation"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.has_at_least_one_atomic_perturbation">[docs]</a>    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">typed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">has_at_least_one_atomic_perturbation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qpt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        True if the DDB file contains info on (at least one) atomic perturbation.</span>
<span class="sd">        If the coordinates of a q point are provided only the specified qpt will be considered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">natom</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>
        <span class="n">ap_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">natom</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">qpt_dm</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">computed_dynmat</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">qpt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">qpt_dm</span> <span class="o">!=</span> <span class="n">qpt</span><span class="p">:</span> <span class="k">continue</span>

            <span class="n">index_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">ap_list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">p2</span> <span class="ow">in</span> <span class="n">ap_list</span><span class="p">:</span>
                    <span class="n">p12</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">+</span> <span class="n">p2</span>
                    <span class="k">if</span> <span class="n">p12</span> <span class="ow">in</span> <span class="n">index_set</span><span class="p">:</span> <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="DdbFile.has_epsinf_terms"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.has_epsinf_terms">[docs]</a>    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">typed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">has_epsinf_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="s2">&quot;at_least_one&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        True if the DDB file contains info on the electric-field perturbation.</span>

<span class="sd">        Args:</span>
<span class="sd">            select: Possible values in [&quot;at_least_one&quot;, &quot;at_least_one_diagoterm&quot;, &quot;all&quot;]</span>
<span class="sd">                If select == &quot;at_least_one&quot;, we check if there&#39;s at least one entry</span>
<span class="sd">                associated to the electric field and we assume that anaddb will be able</span>
<span class="sd">                to reconstruct the full tensor by symmetry.</span>
<span class="sd">                &quot;at_least_one_diagoterm&quot; is similar but it only checks for the presence of one diagonal term.</span>
<span class="sd">                If select == &quot;all&quot;, all tensor components must be present in the DDB file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">Kpoint</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gamma</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">computed_dynmat</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">index_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">computed_dynmat</span><span class="p">[</span><span class="n">gamma</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="n">natom</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>
        <span class="n">ep_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">[</span><span class="n">natom</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">ep_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p2</span> <span class="ow">in</span> <span class="n">ep_list</span><span class="p">:</span>
                <span class="n">p12</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">+</span> <span class="n">p2</span>
                <span class="n">p21</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">+</span> <span class="n">p1</span>
                <span class="k">if</span> <span class="n">select</span> <span class="o">==</span> <span class="s2">&quot;at_least_one&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">p12</span> <span class="ow">in</span> <span class="n">index_set</span><span class="p">:</span> <span class="k">return</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">select</span> <span class="o">==</span> <span class="s2">&quot;at_least_one_diagoterm&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">p12</span> <span class="o">==</span> <span class="n">p21</span> <span class="ow">and</span> <span class="n">p12</span> <span class="ow">in</span> <span class="n">index_set</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">select</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">p12</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">index_set</span> <span class="ow">and</span> <span class="n">p21</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">index_set</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wrong select </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">select</span><span class="p">))</span>

        <span class="k">return</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">select</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;at_least_one&quot;</span><span class="p">,</span> <span class="s2">&quot;at_least_one_diagoterm&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">True</span></div>

    <span class="nd">@deprecated</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;has_emacro_terms is deprecated and will be removed in abipy 0.8, use has_epsinf_terms&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">has_emacro_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_epsinf_terms</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="DdbFile.has_bec_terms"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.has_bec_terms">[docs]</a>    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">typed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">has_bec_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="s2">&quot;at_least_one&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        True if the DDB file contains info on the Born effective charges.</span>

<span class="sd">        Args:</span>
<span class="sd">            select: Possible values in [&quot;at_least_one&quot;, &quot;all&quot;]</span>
<span class="sd">                By default, we check if there&#39;s at least one entry associated to atomic displacement</span>
<span class="sd">                and electric field and we assume that anaddb will be able to reconstruct the full tensor by symmetry.</span>
<span class="sd">                If select == &quot;all&quot;, all bec components must be present in the DDB file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">Kpoint</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gamma</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">computed_dynmat</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">index_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">computed_dynmat</span><span class="p">[</span><span class="n">gamma</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">natom</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>
        <span class="n">ep_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">[</span><span class="n">natom</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]))</span>
        <span class="n">ap_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">natom</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">ap1</span> <span class="ow">in</span> <span class="n">ap_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ep2</span> <span class="ow">in</span> <span class="n">ep_list</span><span class="p">:</span>
                <span class="n">p12</span> <span class="o">=</span> <span class="n">ap1</span> <span class="o">+</span> <span class="n">ep2</span>
                <span class="n">p21</span> <span class="o">=</span> <span class="n">ep2</span> <span class="o">+</span> <span class="n">ap1</span>
                <span class="k">if</span> <span class="n">select</span> <span class="o">==</span> <span class="s2">&quot;at_least_one&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">p12</span> <span class="ow">in</span> <span class="n">index_set</span><span class="p">:</span> <span class="k">return</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">select</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">p12</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">index_set</span> <span class="ow">and</span> <span class="n">p21</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">index_set</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wrong select </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">select</span><span class="p">))</span>

        <span class="k">return</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">select</span> <span class="o">==</span> <span class="s2">&quot;at_least_one&quot;</span> <span class="k">else</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="DdbFile.has_strain_terms"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.has_strain_terms">[docs]</a>    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">typed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">has_strain_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        True if the DDB file contains info on the (clamped-ion) strain perturbation</span>
<span class="sd">        (i.e. 2nd order derivatives wrt strain)</span>

<span class="sd">        Args:</span>
<span class="sd">            select: Possible values in [&quot;at_least_one&quot;, &quot;all&quot;]</span>
<span class="sd">                If select == &quot;at_least_one&quot;, we check if there&#39;s at least one entry associated to the strain.</span>
<span class="sd">                and we assume that anaddb will be able to reconstruct the full tensor by symmetry.</span>
<span class="sd">                If select == &quot;all&quot;, all tensor components must be present in the DDB file.</span>

<span class="sd">        .. note::</span>

<span class="sd">            As anaddb is not yet able to reconstruct the strain terms by symmetry,</span>
<span class="sd">            the default value for select is &quot;all&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">Kpoint</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gamma</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">computed_dynmat</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">index_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">computed_dynmat</span><span class="p">[</span><span class="n">gamma</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="n">natom</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>
        <span class="n">sp_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">[</span><span class="n">natom</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">natom</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">sp_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p2</span> <span class="ow">in</span> <span class="n">sp_list</span><span class="p">:</span>
                <span class="n">p12</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">+</span> <span class="n">p2</span>
                <span class="n">p21</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">+</span> <span class="n">p1</span>
                <span class="k">if</span> <span class="n">select</span> <span class="o">==</span> <span class="s2">&quot;at_least_one&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">p12</span> <span class="ow">in</span> <span class="n">index_set</span><span class="p">:</span> <span class="k">return</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">select</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">p12</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">index_set</span> <span class="ow">and</span> <span class="n">p21</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">index_set</span><span class="p">:</span>
                        <span class="c1">#print(&quot;p12&quot;, p12, &quot;not in index_set&quot;)</span>
                        <span class="k">return</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wrong select </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">select</span><span class="p">))</span>

        <span class="k">return</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">select</span> <span class="o">==</span> <span class="s2">&quot;at_least_one&quot;</span> <span class="k">else</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="DdbFile.has_internalstrain_terms"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.has_internalstrain_terms">[docs]</a>    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">typed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">has_internalstrain_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        True if the DDB file contains internal strain terms</span>
<span class="sd">        i.e &quot;off-diagonal&quot; 2nd order derivatives wrt (strain, atomic displacement)</span>

<span class="sd">        Args:</span>
<span class="sd">            select: Possible values in [&quot;at_least_one&quot;, &quot;all&quot;]</span>
<span class="sd">                If select == &quot;at_least_one&quot;, we check if there&#39;s at least one entry associated to the strain.</span>
<span class="sd">                and we assume that anaddb will be able to reconstruct the full tensor by symmetry.</span>
<span class="sd">                If select == &quot;all&quot;, all tensor components must be present in the DDB file.</span>

<span class="sd">        .. note::</span>

<span class="sd">            As anaddb is not yet able to reconstruct the strain terms by symmetry,</span>
<span class="sd">            the default value for select is &quot;all&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">Kpoint</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gamma</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">computed_dynmat</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">index_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">computed_dynmat</span><span class="p">[</span><span class="n">gamma</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="n">natom</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>
        <span class="n">sp_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">[</span><span class="n">natom</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">natom</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]))</span>
        <span class="n">ap_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">natom</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">sp_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p2</span> <span class="ow">in</span> <span class="n">ap_list</span><span class="p">:</span>
                <span class="n">p12</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">+</span> <span class="n">p2</span>
                <span class="n">p21</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">+</span> <span class="n">p1</span>
                <span class="k">if</span> <span class="n">select</span> <span class="o">==</span> <span class="s2">&quot;at_least_one&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">p12</span> <span class="ow">in</span> <span class="n">index_set</span><span class="p">:</span> <span class="k">return</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">select</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">p12</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">index_set</span> <span class="ow">and</span> <span class="n">p21</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">index_set</span><span class="p">:</span>
                        <span class="c1">#print(&quot;p12&quot;, p12, &quot;non in index&quot;)</span>
                        <span class="k">return</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wrong select </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">select</span><span class="p">))</span>

        <span class="k">return</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">select</span> <span class="o">==</span> <span class="s2">&quot;at_least_one&quot;</span> <span class="k">else</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="DdbFile.has_piezoelectric_terms"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.has_piezoelectric_terms">[docs]</a>    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">typed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">has_piezoelectric_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        True if the DDB file contains piezoelectric terms</span>
<span class="sd">        i.e &quot;off-diagonal&quot; 2nd order derivatives wrt (electric_field, strain)</span>

<span class="sd">        Args:</span>
<span class="sd">            select: Possible values in [&quot;at_least_one&quot;, &quot;all&quot;]</span>
<span class="sd">                If select == &quot;at_least_one&quot;, we check if there&#39;s at least one entry associated to the strain.</span>
<span class="sd">                and we assume that anaddb will be able to reconstruct the full tensor by symmetry.</span>
<span class="sd">                If select == &quot;all&quot;, all tensor components must be present in the DDB file.</span>

<span class="sd">        .. note::</span>

<span class="sd">            As anaddb is not yet able to reconstruct the (strain, electric) terms by symmetry,</span>
<span class="sd">            the default value for select is &quot;all&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">Kpoint</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gamma</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">computed_dynmat</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">index_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">computed_dynmat</span><span class="p">[</span><span class="n">gamma</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="n">natom</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>
        <span class="n">sp_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">[</span><span class="n">natom</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">natom</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]))</span>
        <span class="n">ep_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">[</span><span class="n">natom</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">sp_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p2</span> <span class="ow">in</span> <span class="n">ep_list</span><span class="p">:</span>
                <span class="n">p12</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">+</span> <span class="n">p2</span>
                <span class="n">p21</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">+</span> <span class="n">p1</span>
                <span class="k">if</span> <span class="n">select</span> <span class="o">==</span> <span class="s2">&quot;at_least_one&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">p12</span> <span class="ow">in</span> <span class="n">index_set</span><span class="p">:</span> <span class="k">return</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">select</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">p12</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">index_set</span> <span class="ow">and</span> <span class="n">p21</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">index_set</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wrong select </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">select</span><span class="p">))</span>

        <span class="k">return</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">select</span> <span class="o">==</span> <span class="s2">&quot;at_least_one&quot;</span> <span class="k">else</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="DdbFile.view_phononwebsite"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.view_phononwebsite">[docs]</a>    <span class="k">def</span> <span class="nf">view_phononwebsite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">browser</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dryrun</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Invoke anaddb to compute phonon bands.</span>
<span class="sd">        Produce JSON_ file that can be parsed from the phononwebsite_ and open it in ``browser``.</span>

<span class="sd">        Args:</span>
<span class="sd">            browser: Open webpage in ``browser``. Use default $BROWSER if None.</span>
<span class="sd">            verbose: Verbosity level</span>
<span class="sd">            dryrun: Activate dryrun mode for unit testing purposes.</span>
<span class="sd">            kwargs: Passed to anaget_phbst_and_phdos_files</span>

<span class="sd">        Return: Exit status</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Call anaddb to get phonon bands.</span>
        <span class="k">if</span> <span class="s2">&quot;nqsmall&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;nqsmall&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">phbst_file</span><span class="p">,</span> <span class="n">phdos_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anaget_phbst_and_phdos_files</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">phbands</span> <span class="o">=</span> <span class="n">phbst_file</span><span class="o">.</span><span class="n">phbands</span>
        <span class="n">phbst_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">phbands</span><span class="o">.</span><span class="n">view_phononwebsite</span><span class="p">(</span><span class="n">browser</span><span class="o">=</span><span class="n">browser</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">dryrun</span><span class="o">=</span><span class="n">dryrun</span><span class="p">)</span></div>

<div class="viewcode-block" id="DdbFile.yield_figs"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.yield_figs">[docs]</a>    <span class="k">def</span> <span class="nf">yield_figs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function *generates* a predefined list of matplotlib figures with minimal input from the user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">plot_bz</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="DdbFile.anaget_phmodes_at_qpoint"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.anaget_phmodes_at_qpoint">[docs]</a>    <span class="k">def</span> <span class="nf">anaget_phmodes_at_qpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">asr</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">chneut</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dipdip</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mpi_procs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                 <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lo_to_splitting</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spell_check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="n">directions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">anaddb_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute anaddb to compute phonon modes at the given q-point (without LO-TO splitting)</span>

<span class="sd">        Args:</span>
<span class="sd">            qpoint: Reduced coordinates of the qpoint where phonon modes are computed.</span>
<span class="sd">            asr, chneut, dipdip: Anaddb input variable. See official documentation.</span>
<span class="sd">            workdir: Working directory. If None, a temporary directory is created.</span>
<span class="sd">            mpi_procs: Number of MPI processes to use.</span>
<span class="sd">            manager: |TaskManager| object. If None, the object is initialized from the configuration file</span>
<span class="sd">            verbose: verbosity level. Set it to a value &gt; 0 to get more information.</span>
<span class="sd">            lo_to_splitting: Allowed values are [True, False, &quot;automatic&quot;]. Defaults to False</span>
<span class="sd">                If True the LO-TO splitting will be calculated if qpoint == Gamma and the non_anal_directions</span>
<span class="sd">                non_anal_phfreqs attributes will be addeded to the phonon band structure.</span>
<span class="sd">                &quot;automatic&quot; activates LO-TO if the DDB file contains the dielectric tensor and Born effective charges.</span>
<span class="sd">            directions: list of 3D directions along which the LO-TO splitting will be calculated. If None the three</span>
<span class="sd">                cartesian direction will be used.</span>
<span class="sd">            anaddb_kwargs: additional kwargs for anaddb.</span>

<span class="sd">        Return: |PhononBands| object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">qpoint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">qpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> contains </span><span class="si">%s</span><span class="s2"> qpoints and the choice is ambiguous.</span><span class="se">\n</span><span class="s2">&quot;</span>
                                 <span class="s2">&quot;Please specify the qpoint.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">)))</span>

        <span class="c1"># Check if qpoint is in the DDB.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">iq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qindex</span><span class="p">(</span><span class="n">qpoint</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;input qpoint </span><span class="si">%s</span><span class="s2"> not in </span><span class="si">%s</span><span class="s2">.</span><span class="se">\n</span><span class="s2">ddb.qpoints:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">qpoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">))</span>

        <span class="n">qpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">[</span><span class="n">iq</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">lo_to_splitting</span> <span class="o">==</span> <span class="s2">&quot;automatic&quot;</span><span class="p">:</span>
            <span class="n">lo_to_splitting</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_lo_to_data</span><span class="p">()</span> <span class="ow">and</span> <span class="n">qpoint</span><span class="o">.</span><span class="n">is_gamma</span><span class="p">()</span> <span class="ow">and</span> <span class="n">dipdip</span> <span class="o">!=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">lo_to_splitting</span> <span class="ow">and</span> <span class="n">qpoint</span><span class="o">.</span><span class="n">is_gamma</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_lo_to_data</span><span class="p">():</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;lo_to_splitting set to True but Eps_inf and Becs are not available in DDB </span><span class="si">%s</span><span class="s2">:&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>

        <span class="n">inp</span> <span class="o">=</span> <span class="n">AnaddbInput</span><span class="o">.</span><span class="n">modes_at_qpoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">qpoint</span><span class="p">,</span> <span class="n">asr</span><span class="o">=</span><span class="n">asr</span><span class="p">,</span> <span class="n">chneut</span><span class="o">=</span><span class="n">chneut</span><span class="p">,</span> <span class="n">dipdip</span><span class="o">=</span><span class="n">dipdip</span><span class="p">,</span>
                                          <span class="n">lo_to_splitting</span><span class="o">=</span><span class="n">lo_to_splitting</span><span class="p">,</span> <span class="n">directions</span><span class="o">=</span><span class="n">directions</span><span class="p">,</span>
                                          <span class="n">anaddb_kwargs</span><span class="o">=</span><span class="n">anaddb_kwargs</span><span class="p">,</span> <span class="n">spell_check</span><span class="o">=</span><span class="n">spell_check</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_anaddb_task</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">mpi_procs</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">task</span><span class="o">.</span><span class="n">open_phbst</span><span class="p">()</span> <span class="k">as</span> <span class="n">ncfile</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lo_to_splitting</span> <span class="ow">and</span> <span class="n">qpoint</span><span class="o">.</span><span class="n">is_gamma</span><span class="p">():</span>
                <span class="n">ncfile</span><span class="o">.</span><span class="n">phbands</span><span class="o">.</span><span class="n">read_non_anal_from_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s2">&quot;anaddb.nc&quot;</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">phbands</span></div>

<div class="viewcode-block" id="DdbFile.anaget_phbst_and_phdos_files"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.anaget_phbst_and_phdos_files">[docs]</a>    <span class="k">def</span> <span class="nf">anaget_phbst_and_phdos_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nqsmall</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">qppa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ndivsm</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">line_density</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">asr</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">chneut</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dipdip</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                     <span class="n">dos_method</span><span class="o">=</span><span class="s2">&quot;tetra&quot;</span><span class="p">,</span> <span class="n">lo_to_splitting</span><span class="o">=</span><span class="s2">&quot;automatic&quot;</span><span class="p">,</span> <span class="n">ngqpt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">qptbounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                     <span class="n">anaddb_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">spell_check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                     <span class="n">mpi_procs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute anaddb to compute the phonon band structure and the phonon DOS</span>

<span class="sd">        Args:</span>
<span class="sd">            nqsmall: Defines the homogeneous q-mesh used for the DOS. Gives the number of divisions</span>
<span class="sd">                used to sample the smallest lattice vector. If 0, DOS is not computed and</span>
<span class="sd">                (phbst, None) is returned.</span>
<span class="sd">            qppa: Defines the homogeneous q-mesh used for the DOS in units of q-points per reciproval atom.</span>
<span class="sd">                Overrides nqsmall.</span>
<span class="sd">            ndivsm: Number of division used for the smallest segment of the q-path.</span>
<span class="sd">            line_density: Defines the a density of k-points per reciprocal atom to plot the phonon dispersion.</span>
<span class="sd">                Overrides ndivsm.</span>
<span class="sd">            asr, chneut, dipdip: Anaddb input variable. See official documentation.</span>
<span class="sd">            dos_method: Technique for DOS computation in  Possible choices: &quot;tetra&quot;, &quot;gaussian&quot; or &quot;gaussian:0.001 eV&quot;.</span>
<span class="sd">                In the later case, the value 0.001 eV is used as gaussian broadening.</span>
<span class="sd">            lo_to_splitting: Allowed values are [True, False, &quot;automatic&quot;]. Defaults to &quot;automatic&quot;</span>
<span class="sd">                If True the LO-TO splitting will be calculated and the non_anal_directions</span>
<span class="sd">                and the non_anal_phfreqs attributes will be addeded to the phonon band structure.</span>
<span class="sd">                &quot;automatic&quot; activates LO-TO if the DDB file contains the dielectric tensor and Born effective charges.</span>
<span class="sd">            ngqpt: Number of divisions for the q-mesh in the DDB file. Auto-detected if None (default).</span>
<span class="sd">            qptbounds: Boundaries of the path. If None, the path is generated from an internal database</span>
<span class="sd">                depending on the input structure.</span>
<span class="sd">            anaddb_kwargs: additional kwargs for anaddb.</span>
<span class="sd">            verbose: verbosity level. Set it to a value &gt; 0 to get more information.</span>
<span class="sd">            mpi_procs: Number of MPI processes to use.</span>
<span class="sd">            workdir: Working directory. If None, a temporary directory is created.</span>
<span class="sd">            manager: |TaskManager| object. If None, the object is initialized from the configuration file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            |PhbstFile| with the phonon band structure.</span>
<span class="sd">            |PhdosFile| with the the phonon DOS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ngqpt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ngqpt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">guessed_ngqpt</span>

        <span class="k">if</span> <span class="n">lo_to_splitting</span> <span class="o">==</span> <span class="s2">&quot;automatic&quot;</span><span class="p">:</span>
            <span class="n">lo_to_splitting</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_lo_to_data</span><span class="p">()</span> <span class="ow">and</span> <span class="n">dipdip</span> <span class="o">!=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">lo_to_splitting</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_lo_to_data</span><span class="p">():</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;lo_to_splitting is True but Eps_inf and Becs are not available in DDB: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">)</span>

        <span class="n">inp</span> <span class="o">=</span> <span class="n">AnaddbInput</span><span class="o">.</span><span class="n">phbands_and_dos</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">ngqpt</span><span class="o">=</span><span class="n">ngqpt</span><span class="p">,</span> <span class="n">ndivsm</span><span class="o">=</span><span class="n">ndivsm</span><span class="p">,</span> <span class="n">line_density</span><span class="o">=</span><span class="n">line_density</span><span class="p">,</span>
            <span class="n">nqsmall</span><span class="o">=</span><span class="n">nqsmall</span><span class="p">,</span> <span class="n">qppa</span><span class="o">=</span><span class="n">qppa</span><span class="p">,</span> <span class="n">q1shft</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">qptbounds</span><span class="o">=</span><span class="n">qptbounds</span><span class="p">,</span>
            <span class="n">asr</span><span class="o">=</span><span class="n">asr</span><span class="p">,</span> <span class="n">chneut</span><span class="o">=</span><span class="n">chneut</span><span class="p">,</span> <span class="n">dipdip</span><span class="o">=</span><span class="n">dipdip</span><span class="p">,</span> <span class="n">dos_method</span><span class="o">=</span><span class="n">dos_method</span><span class="p">,</span> <span class="n">lo_to_splitting</span><span class="o">=</span><span class="n">lo_to_splitting</span><span class="p">,</span>
            <span class="n">anaddb_kwargs</span><span class="o">=</span><span class="n">anaddb_kwargs</span><span class="p">,</span> <span class="n">spell_check</span><span class="o">=</span><span class="n">spell_check</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_anaddb_task</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">mpi_procs</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

        <span class="c1"># Open file and add metadata to phbands from DDB</span>
        <span class="c1"># TODO: in principle phbands.add_params?</span>
        <span class="n">phbst_file</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">open_phbst</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_params</span><span class="p">(</span><span class="n">phbst_file</span><span class="o">.</span><span class="n">phbands</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lo_to_splitting</span><span class="p">:</span>
            <span class="n">phbst_file</span><span class="o">.</span><span class="n">phbands</span><span class="o">.</span><span class="n">read_non_anal_from_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s2">&quot;anaddb.nc&quot;</span><span class="p">))</span>

        <span class="n">phdos_file</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">inp</span><span class="p">[</span><span class="s2">&quot;prtdos&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">task</span><span class="o">.</span><span class="n">open_phdos</span><span class="p">()</span>
        <span class="c1">#if phdos_file is not None: self._add_params(phdos_file.phdos)</span>

        <span class="k">return</span> <span class="n">phbst_file</span><span class="p">,</span> <span class="n">phdos_file</span></div>

<div class="viewcode-block" id="DdbFile.get_coarse"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.get_coarse">[docs]</a>    <span class="k">def</span> <span class="nf">get_coarse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ngqpt_coarse</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a version of this file on a coarse mesh</span>

<span class="sd">        Args:</span>
<span class="sd">            ngqpt_coarse: list of ngqpt indexes that must be a sub-mesh of the original ngqpt</span>
<span class="sd">            filepath: Filename for coarse DDB. If None, temporary filename is used.</span>

<span class="sd">        Return: DdbFile on coarse mesh.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if ngqpt is a sub-mesh of ngqpt</span>
        <span class="n">ngqpt_fine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">guessed_ngqpt</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">a</span> <span class="o">%</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ngqpt_fine</span><span class="p">,</span> <span class="n">ngqpt_coarse</span><span class="p">)]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Coarse q-mesh is not a sub-mesh of the current q-mesh&#39;</span><span class="p">)</span>

        <span class="c1"># Get the points in the fine mesh</span>
        <span class="n">fine_qpoints</span> <span class="o">=</span> <span class="p">[</span><span class="n">q</span><span class="o">.</span><span class="n">frac_coords</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">]</span>

        <span class="c1"># Generate the points of the coarse mesh</span>
        <span class="n">map_fine_to_coarse</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span> <span class="o">=</span> <span class="n">ngqpt_coarse</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">nx</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">nx</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                                       <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">ny</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">ny</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                                       <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">nz</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">nz</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="n">coarse_qpt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ngqpt_coarse</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">fine_qpt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fine_qpoints</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">coarse_qpt</span><span class="p">,</span> <span class="n">fine_qpt</span><span class="p">):</span>
                    <span class="n">map_fine_to_coarse</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="c1"># Write the file with a subset of q-points</span>
        <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">tempfile</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">filepath</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;_DDB&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">filter_blocks</span><span class="o">=</span><span class="n">map_fine_to_coarse</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span></div>

<div class="viewcode-block" id="DdbFile.anacompare_asr"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.anacompare_asr">[docs]</a>    <span class="k">def</span> <span class="nf">anacompare_asr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asr_list</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">chneut_list</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">dipdip</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">lo_to_splitting</span><span class="o">=</span><span class="s2">&quot;automatic&quot;</span><span class="p">,</span>
                       <span class="n">nqsmall</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">ndivsm</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">dos_method</span><span class="o">=</span><span class="s2">&quot;tetra&quot;</span><span class="p">,</span> <span class="n">ngqpt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mpi_procs</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Invoke anaddb to compute the phonon band structure and the phonon DOS with different</span>
<span class="sd">        values of the ``asr`` input variable (acoustic sum rule treatment).</span>
<span class="sd">        Build and return |PhononBandsPlotter| object.</span>

<span class="sd">        Args:</span>
<span class="sd">            asr_list: List of ``asr`` values to test.</span>
<span class="sd">            chneut_list: List of ``chneut`` values to test (used by anaddb only if dipdip == 1).</span>
<span class="sd">            dipdip: 1 to activate treatment of dipole-dipole interaction (requires BECS and dielectric tensor).</span>
<span class="sd">            lo_to_splitting: Allowed values are [True, False, &quot;automatic&quot;]. Defaults to &quot;automatic&quot;</span>
<span class="sd">                If True the LO-TO splitting will be calculated if qpoint == Gamma and the non_anal_directions</span>
<span class="sd">                non_anal_phfreqs attributes will be addeded to the phonon band structure.</span>
<span class="sd">                &quot;automatic&quot; activates LO-TO if the DDB file contains the dielectric tensor and Born effective charges.</span>
<span class="sd">            nqsmall: Defines the q-mesh for the phonon DOS in terms of</span>
<span class="sd">                the number of divisions to be used to sample the smallest reciprocal lattice vector.</span>
<span class="sd">                0 to disable DOS computation.</span>
<span class="sd">            ndivsm: Number of division used for the smallest segment of the q-path</span>
<span class="sd">            dos_method: Technique for DOS computation in  Possible choices: &quot;tetra&quot;, &quot;gaussian&quot; or &quot;gaussian:0.001 eV&quot;.</span>
<span class="sd">                In the later case, the value 0.001 eV is used as gaussian broadening</span>
<span class="sd">            ngqpt: Number of divisions for the ab-initio q-mesh in the DDB file. Auto-detected if None (default)</span>
<span class="sd">            verbose: Verbosity level.</span>
<span class="sd">            mpi_procs: Number of MPI processes used by anaddb.</span>

<span class="sd">        Return:</span>
<span class="sd">            |PhononBandsPlotter| object.</span>

<span class="sd">            Client code can use ``plotter.combiplot()`` or ``plotter.gridplot()``</span>
<span class="sd">            to visualize the results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">phbands_plotter</span> <span class="o">=</span> <span class="n">PhononBandsPlotter</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">asr</span><span class="p">,</span> <span class="n">chneut</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">asr_list</span><span class="p">,</span> <span class="n">chneut_list</span><span class="p">):</span>
            <span class="n">phbst_file</span><span class="p">,</span> <span class="n">phdos_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anaget_phbst_and_phdos_files</span><span class="p">(</span>
                <span class="n">nqsmall</span><span class="o">=</span><span class="n">nqsmall</span><span class="p">,</span> <span class="n">ndivsm</span><span class="o">=</span><span class="n">ndivsm</span><span class="p">,</span> <span class="n">asr</span><span class="o">=</span><span class="n">asr</span><span class="p">,</span> <span class="n">chneut</span><span class="o">=</span><span class="n">chneut</span><span class="p">,</span> <span class="n">dipdip</span><span class="o">=</span><span class="n">dipdip</span><span class="p">,</span> <span class="n">dos_method</span><span class="o">=</span><span class="n">dos_method</span><span class="p">,</span>
                <span class="n">lo_to_splitting</span><span class="o">=</span><span class="n">lo_to_splitting</span><span class="p">,</span> <span class="n">ngqpt</span><span class="o">=</span><span class="n">ngqpt</span><span class="p">,</span> <span class="n">qptbounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">anaddb_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">mpi_procs</span><span class="o">=</span><span class="n">mpi_procs</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

            <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;asr: </span><span class="si">%d</span><span class="s2">, dipdip: </span><span class="si">%d</span><span class="s2">, chneut: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">asr</span><span class="p">,</span> <span class="n">dipdip</span><span class="p">,</span> <span class="n">chneut</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">phdos_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">phbands_plotter</span><span class="o">.</span><span class="n">add_phbands</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">phbst_file</span><span class="o">.</span><span class="n">phbands</span><span class="p">,</span> <span class="n">phdos</span><span class="o">=</span><span class="n">phdos_file</span><span class="o">.</span><span class="n">phdos</span><span class="p">)</span>
                <span class="n">phdos_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">phbands_plotter</span><span class="o">.</span><span class="n">add_phbands</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">phbst_file</span><span class="o">.</span><span class="n">phbands</span><span class="p">)</span>
            <span class="n">phbst_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">phbands_plotter</span></div>

<div class="viewcode-block" id="DdbFile.anacompare_dipdip"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.anacompare_dipdip">[docs]</a>    <span class="k">def</span> <span class="nf">anacompare_dipdip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chneut_list</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">asr</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">lo_to_splitting</span><span class="o">=</span><span class="s2">&quot;automatic&quot;</span><span class="p">,</span>
                          <span class="n">nqsmall</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">ndivsm</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">dos_method</span><span class="o">=</span><span class="s2">&quot;tetra&quot;</span><span class="p">,</span> <span class="n">ngqpt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mpi_procs</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Invoke anaddb to compute the phonon band structure and the phonon DOS with different</span>
<span class="sd">        values of the ``asr`` input variable (acoustic sum rule treatment).</span>
<span class="sd">        Build and return |PhononDosPlotter| object.</span>

<span class="sd">        Args:</span>
<span class="sd">            chneut_list: List of ``chneut`` values to test (used for dipdip == 1).</span>
<span class="sd">            lo_to_splitting: Allowed values are [True, False, &quot;automatic&quot;]. Defaults to &quot;automatic&quot;</span>
<span class="sd">                If True the LO-TO splitting will be calculated if qpoint == Gamma and the non_anal_directions</span>
<span class="sd">                non_anal_phfreqs attributes will be addeded to the phonon band structure.</span>
<span class="sd">                &quot;automatic&quot; activates LO-TO if the DDB file contains the dielectric tensor and Born effective charges.</span>
<span class="sd">            nqsmall: Defines the q-mesh for the phonon DOS in terms of</span>
<span class="sd">                the number of divisions to be used to sample the smallest reciprocal lattice vector.</span>
<span class="sd">                0 to disable DOS computation.</span>
<span class="sd">            ndivsm: Number of division used for the smallest segment of the q-path</span>
<span class="sd">            dos_method: Technique for DOS computation in  Possible choices: &quot;tetra&quot;, &quot;gaussian&quot; or &quot;gaussian:0.001 eV&quot;.</span>
<span class="sd">                In the later case, the value 0.001 eV is used as gaussian broadening</span>
<span class="sd">            ngqpt: Number of divisions for the ab-initio q-mesh in the DDB file. Auto-detected if None (default)</span>
<span class="sd">            verbose: Verbosity level.</span>
<span class="sd">            mpi_procs: Number of MPI processes used by anaddb.</span>

<span class="sd">        Return:</span>
<span class="sd">            |PhononDosPlotter| object.</span>

<span class="sd">            Client code can use ``plotter.combiplot()`` or ``plotter.gridplot()``</span>
<span class="sd">            to visualize the results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">phbands_plotter</span> <span class="o">=</span> <span class="n">PhononBandsPlotter</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">dipdip</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">my_chneut_list</span> <span class="o">=</span> <span class="n">chneut_list</span> <span class="k">if</span> <span class="n">dipdip</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">chneut</span> <span class="ow">in</span> <span class="n">my_chneut_list</span><span class="p">:</span>
                <span class="n">phbst_file</span><span class="p">,</span> <span class="n">phdos_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anaget_phbst_and_phdos_files</span><span class="p">(</span>
                    <span class="n">nqsmall</span><span class="o">=</span><span class="n">nqsmall</span><span class="p">,</span> <span class="n">ndivsm</span><span class="o">=</span><span class="n">ndivsm</span><span class="p">,</span> <span class="n">asr</span><span class="o">=</span><span class="n">asr</span><span class="p">,</span> <span class="n">chneut</span><span class="o">=</span><span class="n">chneut</span><span class="p">,</span> <span class="n">dipdip</span><span class="o">=</span><span class="n">dipdip</span><span class="p">,</span> <span class="n">dos_method</span><span class="o">=</span><span class="n">dos_method</span><span class="p">,</span>
                    <span class="n">lo_to_splitting</span><span class="o">=</span><span class="n">lo_to_splitting</span><span class="p">,</span> <span class="n">ngqpt</span><span class="o">=</span><span class="n">ngqpt</span><span class="p">,</span> <span class="n">qptbounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">anaddb_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">mpi_procs</span><span class="o">=</span><span class="n">mpi_procs</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

                <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;asr: </span><span class="si">%d</span><span class="s2">, dipdip: </span><span class="si">%d</span><span class="s2">, chneut: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">asr</span><span class="p">,</span> <span class="n">dipdip</span><span class="p">,</span> <span class="n">chneut</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">phdos_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">phbands_plotter</span><span class="o">.</span><span class="n">add_phbands</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">phbst_file</span><span class="o">.</span><span class="n">phbands</span><span class="p">,</span> <span class="n">phdos</span><span class="o">=</span><span class="n">phdos_file</span><span class="o">.</span><span class="n">phdos</span><span class="p">)</span>
                    <span class="n">phdos_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">phbands_plotter</span><span class="o">.</span><span class="n">add_phbands</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">phbst_file</span><span class="o">.</span><span class="n">phbands</span><span class="p">)</span>
                <span class="n">phbst_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">phbands_plotter</span></div>

<div class="viewcode-block" id="DdbFile.anacompare_phdos"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.anacompare_phdos">[docs]</a>    <span class="k">def</span> <span class="nf">anacompare_phdos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nqsmalls</span><span class="p">,</span> <span class="n">asr</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">chneut</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dipdip</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dos_method</span><span class="o">=</span><span class="s2">&quot;tetra&quot;</span><span class="p">,</span> <span class="n">ngqpt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_cpus</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Invoke Anaddb to compute Phonon DOS with different q-meshes. The ab-initio dynamical matrix</span>
<span class="sd">        reported in the DDB_ file will be Fourier-interpolated on the list of q-meshes specified</span>
<span class="sd">        by ``nqsmalls``. Useful to perform convergence studies.</span>

<span class="sd">        Args:</span>
<span class="sd">            nqsmalls: List of integers defining the q-mesh for the DOS. Each integer gives</span>
<span class="sd">                the number of divisions to be used to sample the smallest reciprocal lattice vector.</span>
<span class="sd">            asr, chneut, dipdip: Anaddb input variable. See official documentation.</span>
<span class="sd">            dos_method: Technique for DOS computation in  Possible choices: &quot;tetra&quot;, &quot;gaussian&quot; or &quot;gaussian:0.001 eV&quot;.</span>
<span class="sd">                In the later case, the value 0.001 eV is used as gaussian broadening</span>
<span class="sd">            ngqpt: Number of divisions for the ab-initio q-mesh in the DDB file. Auto-detected if None (default)</span>
<span class="sd">            verbose: Verbosity level.</span>
<span class="sd">            num_cpus: Number of CPUs (threads) used to parallellize the calculation of the DOSes. Autodetected if None.</span>
<span class="sd">            stream: File-like object used for printing.</span>

<span class="sd">        Return:</span>
<span class="sd">            ``namedtuple`` with the following attributes::</span>

<span class="sd">                    phdoses: List of |PhononDos| objects</span>
<span class="sd">                    plotter: |PhononDosPlotter| object.</span>
<span class="sd">                        Client code can use ``plotter.gridplot()`` to visualize the results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#num_cpus = get_ncpus() // 2 if num_cpus is None else num_cpus</span>
        <span class="k">if</span> <span class="n">num_cpus</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">num_cpus</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">num_cpus</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">num_cpus</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nqsmalls</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">do_work</span><span class="p">(</span><span class="n">nqsmall</span><span class="p">):</span>
            <span class="n">phbst_file</span><span class="p">,</span> <span class="n">phdos_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anaget_phbst_and_phdos_files</span><span class="p">(</span>
                <span class="n">nqsmall</span><span class="o">=</span><span class="n">nqsmall</span><span class="p">,</span> <span class="n">ndivsm</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">asr</span><span class="o">=</span><span class="n">asr</span><span class="p">,</span> <span class="n">chneut</span><span class="o">=</span><span class="n">chneut</span><span class="p">,</span> <span class="n">dipdip</span><span class="o">=</span><span class="n">dipdip</span><span class="p">,</span> <span class="n">dos_method</span><span class="o">=</span><span class="n">dos_method</span><span class="p">,</span> <span class="n">ngqpt</span><span class="o">=</span><span class="n">ngqpt</span><span class="p">)</span>
            <span class="n">phdos</span> <span class="o">=</span> <span class="n">phdos_file</span><span class="o">.</span><span class="n">phdos</span>
            <span class="n">phbst_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">phdos_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">phdos</span>

        <span class="k">if</span> <span class="n">num_cpus</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Sequential version</span>
            <span class="n">phdoses</span> <span class="o">=</span> <span class="p">[</span><span class="n">do_work</span><span class="p">(</span><span class="n">nqs</span><span class="p">)</span> <span class="k">for</span> <span class="n">nqs</span> <span class="ow">in</span> <span class="n">nqsmalls</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Threads</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing </span><span class="si">%d</span><span class="s2"> phonon DOS with </span><span class="si">%d</span><span class="s2"> threads&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nqsmalls</span><span class="p">),</span> <span class="n">num_cpus</span><span class="p">))</span>
            <span class="n">phdoses</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">nqsmalls</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">worker</span><span class="p">():</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">nqsm</span><span class="p">,</span> <span class="n">phdos_index</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                    <span class="n">phdos</span> <span class="o">=</span> <span class="n">do_work</span><span class="p">(</span><span class="n">nqsm</span><span class="p">)</span>
                    <span class="n">phdoses</span><span class="p">[</span><span class="n">phdos_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">phdos</span>
                    <span class="n">q</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>

            <span class="kn">from</span> <span class="nn">threading</span> <span class="k">import</span> <span class="n">Thread</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">Queue</span> <span class="k">import</span> <span class="n">Queue</span> <span class="c1"># py2k</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">queue</span> <span class="k">import</span> <span class="n">Queue</span> <span class="c1"># py3k</span>

            <span class="n">q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_cpus</span><span class="p">):</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">worker</span><span class="p">)</span>
                <span class="n">t</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">nqsmall</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nqsmalls</span><span class="p">):</span>
                <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">nqsmall</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>

            <span class="c1"># block until all tasks are done</span>
            <span class="n">q</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="c1"># Compute relative difference wrt last phonon DOS. Be careful because the DOSes may be defined</span>
        <span class="c1"># on different frequency meshes ==&gt; spline on the mesh of the last DOS.</span>
        <span class="n">last_mesh</span><span class="p">,</span> <span class="n">converged</span> <span class="o">=</span> <span class="n">phdoses</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">phdos</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">phdoses</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">splined_dos</span> <span class="o">=</span> <span class="n">phdos</span><span class="o">.</span><span class="n">spline_on_mesh</span><span class="p">(</span><span class="n">last_mesh</span><span class="p">)</span>
            <span class="n">abs_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">splined_dos</span> <span class="o">-</span> <span class="n">phdoses</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Delta(Phdos[</span><span class="si">%d</span><span class="s2">] - Phdos[</span><span class="si">%d</span><span class="s2">]) / Phdos[</span><span class="si">%d</span><span class="s2">]: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">phdoses</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">phdoses</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">abs_diff</span><span class="o">.</span><span class="n">integral</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>

        <span class="c1"># Fill the plotter.</span>
        <span class="n">plotter</span> <span class="o">=</span> <span class="n">PhononDosPlotter</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">nqsmall</span><span class="p">,</span> <span class="n">phdos</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">nqsmalls</span><span class="p">,</span> <span class="n">phdoses</span><span class="p">):</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">add_phdos</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;nqsmall </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">nqsmall</span><span class="p">,</span> <span class="n">phdos</span><span class="o">=</span><span class="n">phdos</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dict2namedtuple</span><span class="p">(</span><span class="n">phdoses</span><span class="o">=</span><span class="n">phdoses</span><span class="p">,</span> <span class="n">plotter</span><span class="o">=</span><span class="n">plotter</span><span class="p">)</span></div>

<div class="viewcode-block" id="DdbFile.anacompare_rifcsph"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.anacompare_rifcsph">[docs]</a>    <span class="k">def</span> <span class="nf">anacompare_rifcsph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rifcsph_list</span><span class="p">,</span> <span class="n">asr</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">chneut</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dipdip</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">lo_to_splitting</span><span class="o">=</span><span class="s2">&quot;automatic&quot;</span><span class="p">,</span>
                           <span class="n">ndivsm</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">ngqpt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mpi_procs</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Invoke anaddb to compute the phonon band structure and the phonon DOS with different</span>
<span class="sd">        values of the ``asr`` input variable (acoustic sum rule treatment).</span>
<span class="sd">        Build and return |PhononBandsPlotter| object.</span>

<span class="sd">        Args:</span>
<span class="sd">            rifcsph_list: List of rifcsph to analyze.</span>
<span class="sd">            asr, chneut, dipdip: Anaddb input variable. See official documentation.</span>
<span class="sd">            dipdip: 1 to activate treatment of dipole-dipole interaction (requires BECS and dielectric tensor).</span>
<span class="sd">            lo_to_splitting: Allowed values are [True, False, &quot;automatic&quot;]. Defaults to &quot;automatic&quot;</span>
<span class="sd">                If True the LO-TO splitting will be calculated if qpoint == Gamma and the non_anal_directions</span>
<span class="sd">                non_anal_phfreqs attributes will be addeded to the phonon band structure.</span>
<span class="sd">                &quot;automatic&quot; activates LO-TO if the DDB file contains the dielectric tensor and Born effective charges.</span>
<span class="sd">            ndivsm: Number of division used for the smallest segment of the q-path</span>
<span class="sd">            ngqpt: Number of divisions for the ab-initio q-mesh in the DDB file. Auto-detected if None (default)</span>
<span class="sd">            verbose: Verbosity level.</span>
<span class="sd">            mpi_procs: Number of MPI processes used by anaddb.</span>

<span class="sd">        Return:</span>
<span class="sd">            |PhononBandsPlotter| object.</span>

<span class="sd">            Client code can use ``plotter.combiplot()`` or ``plotter.gridplot()``</span>
<span class="sd">            to visualize the results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">phbands_plotter</span> <span class="o">=</span> <span class="n">PhononBandsPlotter</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">rifcsph</span> <span class="ow">in</span> <span class="n">rifcsph_list</span><span class="p">:</span>
            <span class="n">phbst_file</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anaget_phbst_and_phdos_files</span><span class="p">(</span>
                <span class="n">nqsmall</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ndivsm</span><span class="o">=</span><span class="n">ndivsm</span><span class="p">,</span> <span class="n">asr</span><span class="o">=</span><span class="n">asr</span><span class="p">,</span> <span class="n">chneut</span><span class="o">=</span><span class="n">chneut</span><span class="p">,</span> <span class="n">dipdip</span><span class="o">=</span><span class="n">dipdip</span><span class="p">,</span> <span class="n">dos_method</span><span class="o">=</span><span class="s2">&quot;tetra&quot;</span><span class="p">,</span>
                <span class="n">lo_to_splitting</span><span class="o">=</span><span class="n">lo_to_splitting</span><span class="p">,</span> <span class="n">ngqpt</span><span class="o">=</span><span class="n">ngqpt</span><span class="p">,</span> <span class="n">qptbounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">anaddb_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rifcsph&quot;</span><span class="p">:</span> <span class="n">rifcsph</span><span class="p">},</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">mpi_procs</span><span class="o">=</span><span class="n">mpi_procs</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

            <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;rifcsph: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">rifcsph</span>
            <span class="n">phbands_plotter</span><span class="o">.</span><span class="n">add_phbands</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">phbst_file</span><span class="o">.</span><span class="n">phbands</span><span class="p">)</span>
            <span class="n">phbst_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">phbands_plotter</span></div>

<div class="viewcode-block" id="DdbFile.anaget_epsinf_and_becs"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.anaget_epsinf_and_becs">[docs]</a>    <span class="k">def</span> <span class="nf">anaget_epsinf_and_becs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chneut</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mpi_procs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call anaddb to compute the macroscopic electronic dielectric tensor (e_inf)</span>
<span class="sd">        in Cartesian coordinates and the Born effective charges.</span>

<span class="sd">        Args:</span>
<span class="sd">            chneut: Anaddb input variable. See official documentation.</span>
<span class="sd">            manager: |TaskManager| object. If None, the object is initialized from the configuration file</span>
<span class="sd">            mpi_procs: Number of MPI processes to use.</span>
<span class="sd">            verbose: verbosity level. Set it to a value &gt; 0 to get more information</span>

<span class="sd">        Return: ``namedtuple`` with the following attributes::</span>
<span class="sd">            epsinf: |DielectricTensor| object.</span>
<span class="sd">            becs: Becs objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_lo_to_data</span><span class="p">():</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Dielectric tensor and Becs are not available in DDB: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">)</span>

        <span class="n">inp</span> <span class="o">=</span> <span class="n">AnaddbInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">anaddb_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;chneut&quot;</span><span class="p">:</span> <span class="n">chneut</span><span class="p">})</span>

        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_anaddb_task</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">mpi_procs</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

        <span class="c1"># Read data from the netcdf output file produced by anaddb.</span>
        <span class="k">with</span> <span class="n">ETSF_Reader</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s2">&quot;anaddb.nc&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">epsinf</span> <span class="o">=</span> <span class="n">DielectricTensor</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;emacro_cart&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="n">structure</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_structure</span><span class="p">()</span>
            <span class="n">becs</span> <span class="o">=</span> <span class="n">Becs</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;becs_cart&quot;</span><span class="p">),</span> <span class="n">structure</span><span class="p">,</span> <span class="n">chneut</span><span class="o">=</span><span class="n">inp</span><span class="p">[</span><span class="s2">&quot;chneut&quot;</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;f&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dict2namedtuple</span><span class="p">(</span><span class="n">epsinf</span><span class="o">=</span><span class="n">epsinf</span><span class="p">,</span> <span class="n">becs</span><span class="o">=</span><span class="n">becs</span><span class="p">)</span></div>

    <span class="nd">@deprecated</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;anaget_emacro_and_becs is deprecated and will be removed in abipy 0.8, use anaget_epsinf_and_becs&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">anaget_emacro_and_becs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anaget_epsinf_and_becs</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">epsinf</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">becs</span>

<div class="viewcode-block" id="DdbFile.anaget_ifc"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.anaget_ifc">[docs]</a>    <span class="k">def</span> <span class="nf">anaget_ifc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ifcout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">asr</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">chneut</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dipdip</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ngqpt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">mpi_procs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">anaddb_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute anaddb to compute the interatomic forces.</span>

<span class="sd">        Args:</span>
<span class="sd">            ifcout: Number of neighbouring atoms for which the ifc&#39;s will be output. If None all the atoms in the big box.</span>
<span class="sd">            asr, chneut, dipdip: Anaddb input variable. See official documentation.</span>
<span class="sd">            ngqpt: Number of divisions for the q-mesh in the DDB file. Auto-detected if None (default)</span>
<span class="sd">            mpi_procs: Number of MPI processes to use.</span>
<span class="sd">            workdir: Working directory. If None, a temporary directory is created.</span>
<span class="sd">            manager: |TaskManager| object. If None, the object is initialized from the configuration file</span>
<span class="sd">            verbose: verbosity level. Set it to a value &gt; 0 to get more information</span>
<span class="sd">            anaddb_kwargs: additional kwargs for anaddb</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`InteratomicForceConstants` with the calculated ifc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ngqpt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ngqpt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">guessed_ngqpt</span>

        <span class="n">inp</span> <span class="o">=</span> <span class="n">AnaddbInput</span><span class="o">.</span><span class="n">ifc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">ngqpt</span><span class="o">=</span><span class="n">ngqpt</span><span class="p">,</span> <span class="n">ifcout</span><span class="o">=</span><span class="n">ifcout</span><span class="p">,</span> <span class="n">q1shft</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">asr</span><span class="o">=</span><span class="n">asr</span><span class="p">,</span> <span class="n">chneut</span><span class="o">=</span><span class="n">chneut</span><span class="p">,</span>
                              <span class="n">dipdip</span><span class="o">=</span><span class="n">dipdip</span><span class="p">,</span> <span class="n">anaddb_kwargs</span><span class="o">=</span><span class="n">anaddb_kwargs</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_anaddb_task</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">mpi_procs</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">InteratomicForceConstants</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s1">&#39;anaddb.nc&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="DdbFile.anaget_dielectric_tensor_generator"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.anaget_dielectric_tensor_generator">[docs]</a>    <span class="k">def</span> <span class="nf">anaget_dielectric_tensor_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asr</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">chneut</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dipdip</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mpi_procs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                           <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">anaddb_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute anaddb to extract the quantities necessary to create a |DielectricTensorGenerator|.</span>
<span class="sd">        Requires phonon perturbations at Gamma and static electric field perturbations.</span>

<span class="sd">        Args:</span>
<span class="sd">            asr, chneut, dipdip: Anaddb input variable. See official documentation.</span>
<span class="sd">            workdir: Working directory. If None, a temporary directory is created.</span>
<span class="sd">            mpi_procs: Number of MPI processes to use.</span>
<span class="sd">            manager: |TaskManager| object. If None, the object is initialized from the configuration file</span>
<span class="sd">            verbose: verbosity level. Set it to a value &gt; 0 to get more information</span>
<span class="sd">            anaddb_kwargs: additional kwargs for anaddb</span>

<span class="sd">        Return: |DielectricTensorGenerator| object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if gamma is in the DDB.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qindex</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Gamma point not in </span><span class="si">%s</span><span class="s2">.</span><span class="se">\n</span><span class="s2">ddb.qpoints:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">))</span>

        <span class="n">inp</span> <span class="o">=</span> <span class="n">AnaddbInput</span><span class="o">.</span><span class="n">modes_at_qpoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">asr</span><span class="o">=</span><span class="n">asr</span><span class="p">,</span> <span class="n">chneut</span><span class="o">=</span><span class="n">chneut</span><span class="p">,</span> <span class="n">dipdip</span><span class="o">=</span><span class="n">dipdip</span><span class="p">,</span>
                                          <span class="n">lo_to_splitting</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">anaddb_kwargs</span><span class="o">=</span><span class="n">anaddb_kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">anaddb_kwargs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="s1">&#39;dieflag&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">anaddb_kwargs</span><span class="p">:</span>
            <span class="n">inp</span><span class="p">[</span><span class="s1">&#39;dieflag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_anaddb_task</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">mpi_procs</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">DielectricTensorGenerator</span><span class="o">.</span><span class="n">from_files</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s2">&quot;run.abo_PHBST.nc&quot;</span><span class="p">),</span>
                                                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s2">&quot;anaddb.nc&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="DdbFile.anaget_elastic"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.anaget_elastic">[docs]</a>    <span class="k">def</span> <span class="nf">anaget_elastic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relaxed_ion</span><span class="o">=</span><span class="s2">&quot;automatic&quot;</span><span class="p">,</span> <span class="n">piezo</span><span class="o">=</span><span class="s2">&quot;automatic&quot;</span><span class="p">,</span>
                       <span class="n">dde</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stress_correction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">asr</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">chneut</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                       <span class="n">mpi_procs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">retpath</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call anaddb to compute elastic and piezoelectric tensors. Require DDB with strain terms.</span>

<span class="sd">        By default, this method sets the anaddb input variables automatically</span>
<span class="sd">        by looking at the 2nd-order derivatives available in the DDB file.</span>
<span class="sd">        This behaviour can be changed by setting explicitly the value of:</span>
<span class="sd">        `relaxed_ion` and `piezo`.</span>

<span class="sd">        Args:</span>
<span class="sd">            relaxed_ion: Activate computation of relaxed-ion tensors.</span>
<span class="sd">                Allowed values are [True, False, &quot;automatic&quot;]. Defaults to &quot;automatic&quot;.</span>
<span class="sd">                In &quot;automatic&quot; mode, relaxed-ion tensors are automatically computed if</span>
<span class="sd">                internal strain terms and phonons at Gamma are present in the DDB.</span>
<span class="sd">            piezo: Activate computation of piezoelectric tensors.</span>
<span class="sd">                Allowed values are [True, False, &quot;automatic&quot;]. Defaults to &quot;automatic&quot;.</span>
<span class="sd">                In &quot;automatic&quot; mode, piezoelectric tensors are automatically computed if</span>
<span class="sd">                piezoelectric terms are present in the DDB.</span>
<span class="sd">                NB: relaxed-ion piezoelectric requires the activation of `relaxed_ion`.</span>
<span class="sd">            dde: if True, dielectric tensors will be calculated.</span>
<span class="sd">            stress_correction: Calculate the relaxed ion elastic tensors, considering</span>
<span class="sd">                the stress left inside cell. The DDB must contain the stress tensor.</span>
<span class="sd">            asr: Anaddb input variable. See official documentation.</span>
<span class="sd">            chneut: Anaddb input variable. See official documentation.</span>
<span class="sd">            mpi_procs: Number of MPI processes to use.</span>
<span class="sd">            workdir: Working directory. If None, a temporary directory is created.</span>
<span class="sd">            manager: |TaskManager| object. If None, the object is initialized from the configuration file</span>
<span class="sd">            verbose: verbosity level. Set it to a value &gt; 0 to get more information</span>
<span class="sd">            retpath: True to return path to anaddb.nc file.</span>

<span class="sd">        Return:</span>
<span class="sd">            |ElasticData| object if `retpath` is None else absolute path to anaddb.nc file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_strain_terms</span><span class="p">():</span> <span class="c1"># DOH!</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Strain perturbations are not available in DDB: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">relaxed_ion</span> <span class="o">==</span> <span class="s2">&quot;automatic&quot;</span><span class="p">:</span>
            <span class="n">relaxed_ion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_internalstrain_terms</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_at_least_one_atomic_perturbation</span><span class="p">(</span><span class="n">qpt</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">relaxed_ion</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_at_least_one_atomic_perturbation</span><span class="p">(</span><span class="n">qpt</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Requiring `relaxed_ion` but no atomic term available in DDB: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_internalstrain_terms</span><span class="p">():</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Requiring `internal_strain` but no internal strain term in DDB: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">piezo</span> <span class="o">==</span> <span class="s2">&quot;automatic&quot;</span><span class="p">:</span>
            <span class="n">piezo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_piezoelectric_terms</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">piezo</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_piezoelectric_terms</span><span class="p">():</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Requiring `piezo` but no piezoelectric term available in DDB: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">)</span>

        <span class="c1"># FIXME This is problematic so don&#39;t use automatic as default</span>
        <span class="c1">#select = &quot;all&quot;</span>
        <span class="n">select</span> <span class="o">=</span> <span class="s2">&quot;at_least_one_diagoterm&quot;</span>
        <span class="k">if</span> <span class="n">dde</span> <span class="o">==</span> <span class="s2">&quot;automatic&quot;</span><span class="p">:</span>
            <span class="n">dde</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_epsinf_terms</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="n">select</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dde</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_epsinf_terms</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="n">select</span><span class="p">):</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Requiring `dde` but dielectric tensor not available in DDB: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stress_correction</span> <span class="o">==</span> <span class="s2">&quot;automatic&quot;</span><span class="p">:</span>
            <span class="n">stress_correction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart_stress_tensor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">stress_correction</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart_stress_tensor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Requiring `stress_correction` but stress not available in DDB: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">)</span>

        <span class="n">inp</span> <span class="o">=</span> <span class="n">AnaddbInput</span><span class="o">.</span><span class="n">dfpt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">strain</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">relaxed_ion</span><span class="o">=</span><span class="n">relaxed_ion</span><span class="p">,</span>
                               <span class="n">dde</span><span class="o">=</span><span class="n">dde</span><span class="p">,</span> <span class="n">piezo</span><span class="o">=</span><span class="n">piezo</span><span class="p">,</span> <span class="n">stress_correction</span><span class="o">=</span><span class="n">stress_correction</span><span class="p">,</span> <span class="n">dte</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">asr</span><span class="o">=</span><span class="n">asr</span><span class="p">,</span> <span class="n">chneut</span><span class="o">=</span><span class="n">chneut</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_anaddb_task</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">mpi_procs</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

        <span class="c1"># Read data from the netcdf output file produced by anaddb.</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s2">&quot;anaddb.nc&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ElasticData</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">retpath</span> <span class="k">else</span> <span class="n">path</span></div>

    <span class="k">def</span> <span class="nf">_run_anaddb_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">anaddb_input</span><span class="p">,</span> <span class="n">mpi_procs</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute an |AnaddbInput| via the shell. Return AnaddbTask.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">AnaddbTask</span><span class="o">.</span><span class="n">temp_shell_task</span><span class="p">(</span><span class="n">anaddb_input</span><span class="p">,</span> <span class="n">ddb_node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span>
                <span class="n">mpi_procs</span><span class="o">=</span><span class="n">mpi_procs</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ANADDB INPUT:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">anaddb_input</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;workdir:&quot;</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>

        <span class="c1"># Run the task here.</span>
        <span class="n">task</span><span class="o">.</span><span class="n">start_and_wait</span><span class="p">(</span><span class="n">autoparal</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">report</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get_event_report</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">report</span><span class="o">.</span><span class="n">run_completed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">AnaddbError</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="n">report</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">task</span>

<div class="viewcode-block" id="DdbFile.write"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">filter_blocks</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes the DDB file in filepath. Requires the blocks data.</span>
<span class="sd">        Only the information stored in self.header.lines and in self.blocks will be used to produce the file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filter_blocks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">blocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filter_blocks</span><span class="p">]</span>

        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; **** Database of total energy derivatives ****&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; Number of data blocks=</span><span class="si">{0:5}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">blocks</span><span class="p">)))</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">])</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>

        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; List of bloks and their characteristics&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][:</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></div>

<div class="viewcode-block" id="DdbFile.get_block_for_qpoint"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.get_block_for_qpoint">[docs]</a>    <span class="k">def</span> <span class="nf">get_block_for_qpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qpt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts the block data for the selected qpoint.</span>
<span class="sd">        Returns a list of lines containing the block information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">qpt</span><span class="p">,</span> <span class="s2">&quot;frac_coords&quot;</span><span class="p">):</span> <span class="n">qpt</span> <span class="o">=</span> <span class="n">qpt</span><span class="o">.</span><span class="n">frac_coords</span>

        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">b</span><span class="p">[</span><span class="s1">&#39;qpt&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;qpt&#39;</span><span class="p">],</span> <span class="n">qpt</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">b</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="DdbFile.replace_block_for_qpoint"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.replace_block_for_qpoint">[docs]</a>    <span class="k">def</span> <span class="nf">replace_block_for_qpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qpt</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change the block data for the selected qpoint. Object is modified in-place.</span>
<span class="sd">        Data should be a list of strings representing the whole data block.</span>
<span class="sd">        Note that the DDB file should be written and reopened in order to call methods that run anaddb.</span>

<span class="sd">        Return:</span>
<span class="sd">            True if qpt has been found and data has been replaced.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">qpt</span><span class="p">,</span> <span class="s2">&quot;frac_coords&quot;</span><span class="p">):</span> <span class="n">qpt</span> <span class="o">=</span> <span class="n">qpt</span><span class="o">.</span><span class="n">frac_coords</span>

        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">b</span><span class="p">[</span><span class="s1">&#39;qpt&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;qpt&#39;</span><span class="p">],</span> <span class="n">qpt</span><span class="p">):</span>
                <span class="n">b</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="DdbFile.write_notebook"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbFile.write_notebook">[docs]</a>    <span class="k">def</span> <span class="nf">write_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write an jupyter_ notebook to nbpath. If ``nbpath`` is None, a temporay file in the current</span>
<span class="sd">        working directory is created. Return path to the notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbformat</span><span class="p">,</span> <span class="n">nbv</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nbformat_nbv_nb</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;ddb = abilab.abiopen(&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;units = &#39;eV&#39;</span><span class="se">\n</span><span class="s2">print(ddb)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;# display(ddb.header)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_markdown_cell</span><span class="p">(</span><span class="s2">&quot;## Invoke `anaddb` to compute bands and dos&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">bstfile, phdosfile =  ddb.anaget_phbst_and_phdos_files(nqsmall=10, ndivsm=20,</span>
<span class="s2">    asr=2, chneut=1, dipdip=0, lo_to_splitting=&quot;automatic&quot;,</span>
<span class="s2">    dos_method=&quot;tetra&quot;, ngqpt=None, qptbounds=None, verbose=0, anaddb_kwargs=None)</span>

<span class="s2">phbands, phdos = bstfile.phbands, phdosfile.phdos&quot;&quot;&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_markdown_cell</span><span class="p">(</span><span class="s2">&quot;## q-point path&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;phbands.qpoints.plot();&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_markdown_cell</span><span class="p">(</span><span class="s2">&quot;## Phonon bands with DOS&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;phbands.plot_with_phdos(phdos, units=units);&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_markdown_cell</span><span class="p">(</span><span class="s2">&quot;## Phonon fatbands with DOS&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;phbands.plot_fatbands(phdos_file=phdosfile, units=units);&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_markdown_cell</span><span class="p">(</span><span class="s2">&quot;## Distribution of phonon frequencies wrt mode index&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;phbands.boxplot(units=units);&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_markdown_cell</span><span class="p">(</span><span class="s2">&quot;## Phonon band structure with different color for each line&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;phbands.plot_colored_matched(units=units);&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_markdown_cell</span><span class="p">(</span><span class="s2">&quot;## Type-projected phonon DOS.&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;phdosfile.plot_pjdos_type(units=units);&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_markdown_cell</span><span class="p">(</span><span class="s2">&quot;## Type-projected phonon DOS decomposed along the three reduced directions&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;phdosfile.plot_pjdos_redirs_type(units=units);&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;#phdosfile.plot_pjdos_redirs_site(units=units);&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_markdown_cell</span><span class="p">(</span><span class="s2">&quot;## Thermodinamic properties within the harmonic approximation&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;phdosfile.phdos.plot_harmonic_thermo(tstart=5, tstop=300);&quot;</span><span class="p">),</span>

            <span class="n">nbv</span><span class="o">.</span><span class="n">new_markdown_cell</span><span class="p">(</span><span class="s2">&quot;## Macroscopic dielectric tensor and Born effective charges&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">if False:</span>
<span class="s2">    einf, becs = ddb.anaget_epsinf_and_becs()</span>
<span class="s2">    print(einf)</span>
<span class="s2">    print(becs)&quot;&quot;&quot;</span><span class="p">),</span>

            <span class="n">nbv</span><span class="o">.</span><span class="n">new_markdown_cell</span><span class="p">(</span><span class="s2">&quot;## Call `anaddb` to compute phonons and DOS with/without ASR&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">#asr_plotter = ddb.anacompare_asr(asr_list=(0, 2), nqsmall=0, ndivsm=10)</span>
<span class="s2">#asr_plotter.gridplot();</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">),</span>

            <span class="n">nbv</span><span class="o">.</span><span class="n">new_markdown_cell</span><span class="p">(</span><span class="s2">&quot;## Call `anaddb` to compute phonon DOS with different BZ samplings&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">c = None</span>
<span class="s2">if False:</span>
<span class="s2">    c = ddb.anacompare_phdos(nqsmalls=[20, 30], asr=2, chneut=1, dipdip=1,</span>
<span class="s2">            dos_method=&quot;tetra&quot;, ngqpt=None, num_cpus=1)&quot;&quot;&quot;</span><span class="p">),</span>

            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">if c is not None:</span>
<span class="s2">    c.plotter.ipw_select_plot()</span>
<span class="s2">    #for phdos in c.phdoses&quot;&quot;&quot;</span><span class="p">),</span>

            <span class="n">nbv</span><span class="o">.</span><span class="n">new_markdown_cell</span><span class="p">(</span><span class="s2">&quot;## Analysis of the IFCs in real-space&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">ifc = None</span>
<span class="s2">if False:</span>
<span class="s2">    ifc = ddb.anaget_ifc(ifcout=None, asr=2, chneut=1, dipdip=1, ngqpt=None, verbose=0, anaddb_kwargs=None)&quot;&quot;&quot;</span><span class="p">),</span>

            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">if ifc is not None:</span>
<span class="s2">    ifc.plot_longitudinal_ifc(atom_indices=None, atom_element=None, neighbour_element=None, min_dist=None,</span>
<span class="s2">                                    max_dist=None, ax=None);&quot;&quot;&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">if ifc is not None:</span>
<span class="s2">    ifc.plot_longitudinal_ifc_short_range(atom_indices=None, atom_element=None, neighbour_element=None);&quot;&quot;&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">if ifc is not None:</span>
<span class="s2">    ifc.plot_longitudinal_ifc_ewald(atom_indices=None, atom_element=None, neighbour_element=None,</span>
<span class="s2">                                    min_dist=None, max_dist=None, ax=None);&quot;&quot;&quot;</span><span class="p">),</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_nb_nbpath</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nbpath</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Becs"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.Becs">[docs]</a><span class="k">class</span> <span class="nc">Becs</span><span class="p">(</span><span class="n">Has_Structure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object stores the Born effective charges and provides simple tools for data analysis.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">becs_arr</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">chneut</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            becs_arr: [3, 3, natom] array with the Born effective charges in Cartesian coordinates.</span>
<span class="sd">            structure: |Structure| object.</span>
<span class="sd">            chneut: Option used for the treatment of the Charge Neutrality requirement</span>
<span class="sd">                for the effective charges (anaddb input variable)</span>
<span class="sd">            order: &quot;f&quot; if becs_arr is in Fortran order.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">becs_arr</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span> <span class="o">=</span> <span class="n">structure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chneut</span> <span class="o">=</span> <span class="n">chneut</span>

        <span class="c1"># Values is a numpy array while zstars is a list of Tensor objects.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">structure</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">becs_arr</span><span class="p">):</span>
            <span class="n">mat</span> <span class="o">=</span> <span class="n">becs_arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;f&quot;</span><span class="p">:</span> <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">zstars</span> <span class="o">=</span> <span class="p">[</span><span class="n">ZstarTensor</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span> <span class="k">for</span> <span class="n">mat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;|Structure| object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

<div class="viewcode-block" id="Becs.to_string"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.Becs.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Born effective charges in Cartesian coordinates (Voigt notation)&quot;</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_voigt_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Born effective charges (full tensor)&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">site</span><span class="p">,</span> <span class="n">bec</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
                <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Z* at site: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">site</span><span class="p">))</span>
                <span class="n">app</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">bec</span><span class="p">))</span>
                <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Add info on the bec sum rule.</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Born effective charge neutrality sum-rule with chneut: </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">chneut</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sumrule</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sumrule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[3, 3] matrix with Born effective charge neutrality sum-rule.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_repr_html_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Integration with jupyter notebooks.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_voigt_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">_repr_html_</span><span class="p">()</span>

<div class="viewcode-block" id="Becs.get_voigt_dataframe"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.Becs.get_voigt_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">get_voigt_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="s2">&quot;inequivalent&quot;</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">select_symbols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return |pandas-DataFrame| with Voigt indices as columns and natom rows.</span>

<span class="sd">        Args:</span>
<span class="sd">            view: &quot;inequivalent&quot; to show only inequivalent atoms. &quot;all&quot; for all sites.</span>
<span class="sd">            tol: Entries are set to zero below this value</span>
<span class="sd">            select_symbols: String or list of strings with chemical symbols.</span>
<span class="sd">                Used to select only atoms of this type.</span>
<span class="sd">            decimals: Number of decimal places to round to.</span>
<span class="sd">                If decimals is negative, it specifies the number of positions to the left of the decimal point.</span>
<span class="sd">            verbose: Verbosity level.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">aview</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_atomview</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">select_symbols</span><span class="o">=</span><span class="n">select_symbols</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;xx&quot;</span><span class="p">,</span> <span class="s2">&quot;yy&quot;</span><span class="p">,</span> <span class="s2">&quot;zz&quot;</span><span class="p">,</span> <span class="s2">&quot;yz&quot;</span><span class="p">,</span> <span class="s2">&quot;xz&quot;</span><span class="p">,</span> <span class="s2">&quot;xy&quot;</span><span class="p">]</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">iatom</span><span class="p">,</span> <span class="n">wlabel</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aview</span><span class="o">.</span><span class="n">iatom_list</span><span class="p">,</span> <span class="n">aview</span><span class="o">.</span><span class="n">wyck_labels</span><span class="p">):</span>
            <span class="n">site</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">[</span><span class="n">iatom</span><span class="p">]</span>
            <span class="n">zstar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zstars</span><span class="p">[</span><span class="n">iatom</span><span class="p">]</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="n">d</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">site</span><span class="o">.</span><span class="n">specie</span><span class="o">.</span><span class="n">symbol</span>
            <span class="n">d</span><span class="p">[</span><span class="s2">&quot;site_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iatom</span>
            <span class="n">d</span><span class="p">[</span><span class="s2">&quot;frac_coords&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="n">decimals</span><span class="p">)</span>
            <span class="n">d</span><span class="p">[</span><span class="s2">&quot;cart_coords&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="n">decimals</span><span class="p">)</span>
            <span class="n">d</span><span class="p">[</span><span class="s2">&quot;wyckoff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wlabel</span>
            <span class="n">zstar</span> <span class="o">=</span> <span class="n">zstar</span><span class="o">.</span><span class="n">zeroed</span><span class="p">(</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">zstar</span><span class="o">.</span><span class="n">voigt</span><span class="p">):</span>
                <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="s2">&quot;determinant&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">zstar</span><span class="p">)</span>
                <span class="n">d</span><span class="p">[</span><span class="s2">&quot;iso&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zstar</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">rows</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="Becs.check_site_symmetries"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.Becs.check_site_symmetries">[docs]</a>    <span class="k">def</span> <span class="nf">check_site_symmetries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">abipy.core.wyckoff</span> <span class="k">import</span> <span class="n">SiteSymmetries</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="n">SiteSymmetries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ss</span><span class="o">.</span><span class="n">check_site_symmetries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DielectricTensorGenerator"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DielectricTensorGenerator">[docs]</a><span class="k">class</span> <span class="nc">DielectricTensorGenerator</span><span class="p">(</span><span class="n">Has_Structure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Object used to generate frequency dependent dielectric tensors as obtained</span>
<span class="sd">    from DFPT calculations. The values are calculated on the fly</span>
<span class="sd">    based on the phonon frequencies at gamma and oscillator strengths.</span>
<span class="sd">    The first three frequencies would be considered as acoustic modes and</span>
<span class="sd">    ignored in the calculation. No checks would be performed.</span>

<span class="sd">    See the definitions Eq.(53-54) in :cite:`Gonze1997` PRB55, 10355 (1997).</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="DielectricTensorGenerator.from_files"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DielectricTensorGenerator.from_files">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_files</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">phbst_filepath</span><span class="p">,</span> <span class="n">anaddbnc_filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates the object from the files that contain the phonon frequencies, oscillator strength and</span>
<span class="sd">        static dielectric tensor, i.e. the PHBST.nc and anaddb.nc netcdf files, respectively.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">ETSF_Reader</span><span class="p">(</span><span class="n">phbst_filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
            <span class="n">qpts</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;qpoints&quot;</span><span class="p">)</span>
            <span class="n">full_phfreqs</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;phfreqs&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">qpts</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]):</span>
                <span class="n">phfreqs</span> <span class="o">=</span> <span class="n">full_phfreqs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The PHBST does not contain frequencies at gamma&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">ETSF_Reader</span><span class="p">(</span><span class="n">anaddbnc_filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
            <span class="n">epsinf</span> <span class="o">=</span> <span class="n">DielectricTensor</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;emacro_cart&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="n">eps0</span> <span class="o">=</span> <span class="n">DielectricTensor</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;emacro_cart_rlx&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">oscillator_strength</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;oscillator_strength&quot;</span><span class="p">,</span> <span class="n">cmode</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>
                <span class="n">oscillator_strength</span> <span class="o">=</span> <span class="n">oscillator_strength</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">traceback</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;Error while trying to read from file.</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;Verify that dieflag == 1, 3 or 4 in anaddb</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="n">structure</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read_structure</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">phfreqs</span><span class="p">,</span> <span class="n">oscillator_strength</span><span class="p">,</span> <span class="n">eps0</span><span class="p">,</span> <span class="n">epsinf</span><span class="p">,</span> <span class="n">structure</span><span class="p">)</span></div>

<div class="viewcode-block" id="DielectricTensorGenerator.from_objects"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DielectricTensorGenerator.from_objects">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_objects</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">phbands</span><span class="p">,</span> <span class="n">anaddbnc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates the object from the objects |PhononBands| object and AnaddbNcFile</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gamma_index</span> <span class="o">=</span> <span class="n">phbands</span><span class="o">.</span><span class="n">qindex</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="n">phfreqs</span> <span class="o">=</span> <span class="n">phbands</span><span class="o">.</span><span class="n">phfreqs</span><span class="p">[</span><span class="n">gamma_index</span><span class="p">]</span>

        <span class="n">epsinf</span> <span class="o">=</span> <span class="n">anaddbnc</span><span class="o">.</span><span class="n">epsinf</span>
        <span class="n">eps0</span> <span class="o">=</span> <span class="n">anaddbnc</span><span class="o">.</span><span class="n">eps0</span>
        <span class="n">oscillator_strength</span> <span class="o">=</span> <span class="n">anaddbnc</span><span class="o">.</span><span class="n">oscillator_strength</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">phfreqs</span><span class="p">,</span> <span class="n">oscillator_strength</span><span class="p">,</span> <span class="n">eps0</span><span class="p">,</span> <span class="n">epsinf</span><span class="p">,</span> <span class="n">anaddbnc</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phfreqs</span><span class="p">,</span> <span class="n">oscillator_strength</span><span class="p">,</span> <span class="n">eps0</span><span class="p">,</span> <span class="n">epsinf</span><span class="p">,</span> <span class="n">structure</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">             phfreqs: numpy array containing the 3 * num_atoms phonon frequencies at gamma</span>
<span class="sd">             oscillator_strength: complex numpy array with shape [number of phonon modes, 3, 3] in atomic units</span>
<span class="sd">             eps0: numpy array containing the e0 dielectric tensor without frequency dependence</span>
<span class="sd">             epsinf: numpy array with the electronic dielectric tensor (einf) without frequency dependence</span>
<span class="sd">             structure: |Structure| object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phfreqs</span> <span class="o">=</span> <span class="n">phfreqs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oscillator_strength</span> <span class="o">=</span> <span class="n">oscillator_strength</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eps0</span> <span class="o">=</span> <span class="n">eps0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsinf</span> <span class="o">=</span> <span class="n">epsinf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span> <span class="o">=</span> <span class="n">structure</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;|Structure| object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

<div class="viewcode-block" id="DielectricTensorGenerator.to_string"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DielectricTensorGenerator.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation with verbosity level `verbose`.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Structure&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="s2">&quot;Oscillator strength&quot;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
        <span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-8</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Real part in Cartesian coordinates. a.u. units; 1 a.u. = 253.2638413 m3/s2. Set to zero below </span><span class="si">%.2e</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">tol</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_oscillator_dataframe</span><span class="p">(</span><span class="n">reim</span><span class="o">=</span><span class="s2">&quot;re&quot;</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Imaginary part in a.u.; 1 a.u. = 253.2638413 m3/s2. Set to zero below </span><span class="si">%.2e</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">tol</span><span class="p">)</span>
            <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_oscillator_dataframe</span><span class="p">(</span><span class="n">reim</span><span class="o">=</span><span class="s2">&quot;im&quot;</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Trace of oscillator strength, for each phonon mode:&quot;</span><span class="p">)</span>
            <span class="n">traces</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">oscillator_strength</span><span class="p">]</span>
            <span class="n">app</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">traces</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-3</span>
        <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="s2">&quot;Dielectric Tensors&quot;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Electronic dielectric tensor (eps_inf) in Cartesian coordinates. Set to zero below </span><span class="si">%.2e</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">tol</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epsinf</span><span class="o">.</span><span class="n">get_dataframe</span><span class="p">(</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Zero-frequency dielectric tensor (eps_zero) in Cartesian coordinates. Set to zero below </span><span class="si">%.2e</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">tol</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eps0</span><span class="o">.</span><span class="n">get_dataframe</span><span class="p">(</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="DielectricTensorGenerator.get_oscillator_dataframe"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DielectricTensorGenerator.get_oscillator_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">get_oscillator_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reim</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return |pandas-Dataframe| with oscillator matrix elements.</span>

<span class="sd">        Args:</span>
<span class="sd">            reim: &quot;re&quot; for real part, &quot;im&quot; for imaginary part, &quot;all&quot; for both.</span>
<span class="sd">            tol: Entries are set to zero below this value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dmap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">xx</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">yy</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">zz</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">yz</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">xz</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="c1">#decimals = int(abs(np.rint(np.log10(tol))))</span>
        <span class="c1"># 1 a.u. = 253.2638413 m3/s2.</span>
        <span class="c1"># TODO: Use SI?</span>
        <span class="c1">#fact = 253.2638413</span>

        <span class="n">rows</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">nu</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">data_from_cplx_mode</span><span class="p">(</span><span class="n">reim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oscillator_strength</span><span class="p">[</span><span class="n">nu</span><span class="p">][</span><span class="n">t</span><span class="p">],</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">dmap</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="c1">#d = {k: np.around(v * fact, decimals=decimals) for k, v in d.items()}</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="n">index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nu</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;mode&quot;</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="DielectricTensorGenerator.tensor_at_frequency"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DielectricTensorGenerator.tensor_at_frequency">[docs]</a>    <span class="k">def</span> <span class="nf">tensor_at_frequency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">gamma_ev</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;eV&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a |DielectricTensor| object representing the dielectric tensor</span>
<span class="sd">        in atomic units at the specified frequency w. Eq.(53-54) in PRB55, 10355 (1997).</span>

<span class="sd">        Args:</span>
<span class="sd">            w: Frequency in eV</span>
<span class="sd">            gamma_ev: Phonon damping factor in eV (full width). Poles are shifted by phfreq * gamma_ev.</span>
<span class="sd">                Accept scalar or [nfreq] array.</span>
<span class="sd">            units: string specifying the units used for ph frequencies.  Possible values in</span>
<span class="sd">            (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;). Case-insensitive.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">/</span> <span class="n">phfactor_ev2units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>

        <span class="c1"># Note that the acoustic modes are not included: their oscillator strength should be exactly zero</span>
        <span class="c1"># Also, only the real part of the oscillators is taken into account:</span>
        <span class="c1"># the possible imaginary parts of degenerate modes will cancel.</span>
        <span class="k">if</span> <span class="n">duck</span><span class="o">.</span><span class="n">is_listlike</span><span class="p">(</span><span class="n">gamma_ev</span><span class="p">):</span>
            <span class="n">gammas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">gamma_ev</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">gammas</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phfreqs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gammas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phfreqs</span><span class="p">))</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">gamma_ev</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phfreqs</span><span class="p">)):</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">gammas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">phfreqs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oscillator_strength</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">real</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phfreqs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">w</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">g</span><span class="p">)</span>

        <span class="n">vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">volume</span> <span class="o">/</span> <span class="n">bohr_to_angstrom</span> <span class="o">**</span> <span class="mi">3</span>
        <span class="n">t</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">t</span> <span class="o">/</span> <span class="n">vol</span> <span class="o">/</span> <span class="n">eV_to_Ha</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsinf</span>

        <span class="k">return</span> <span class="n">DielectricTensor</span><span class="p">(</span><span class="n">t</span><span class="p">)</span></div>

<div class="viewcode-block" id="DielectricTensorGenerator.plot"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DielectricTensorGenerator.plot">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">w_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gamma_ev</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="s1">&#39;diag&#39;</span><span class="p">,</span> <span class="n">reim</span><span class="o">=</span><span class="s2">&quot;reim&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;eV&#39;</span><span class="p">,</span>
             <span class="n">with_phfreqs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the selected components of the dielectric tensor as a function of frequency.</span>

<span class="sd">        Args:</span>
<span class="sd">            w_min: minimum frequency in units `units`.</span>
<span class="sd">            w_max: maximum frequency. If None it will be set to the value of the maximum frequency + 5*gamma_ev.</span>
<span class="sd">            gamma_ev: Phonon damping factor in eV (full width). Poles are shifted by phfreq * gamma_ev.</span>
<span class="sd">                Accept scalar or [nfreq] array.</span>
<span class="sd">            num: number of values of the frequencies between w_min and w_max.</span>
<span class="sd">            component: determine which components of the tensor will be displayed. Can be a list/tuple of two</span>
<span class="sd">                elements, indicating the indices [i, j] of the desired component or a string among:</span>

<span class="sd">                * &#39;diag_av&#39; to plot the average of the components on the diagonal</span>
<span class="sd">                * &#39;diag&#39; to plot the elements on diagonal</span>
<span class="sd">                * &#39;all&#39; to plot all the components in the upper triangle.</span>
<span class="sd">                * &#39;offdiag&#39; to plot the off-diagonal components in the upper triangle.</span>

<span class="sd">            reim: a string with &quot;re&quot; will plot the real part, with &quot;im&quot; selects the imaginary part.</span>
<span class="sd">            units: string specifying the units used for phonon frequencies. Possible values in</span>
<span class="sd">                (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;). Case-insensitive.</span>
<span class="sd">            with_phfreqs: True to show phonon frequencies with dots.</span>
<span class="sd">            ax: |matplotlib-Axes| or None if a new figure should be created.</span>
<span class="sd">            fontsize: Legend and label fontsize.</span>

<span class="sd">        Return: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">w_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">w_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phfreqs</span><span class="p">)</span> <span class="o">+</span> <span class="n">gamma_ev</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="n">phfactor_ev2units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>

        <span class="n">wmesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">w_min</span><span class="p">,</span> <span class="n">w_max</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wmesh</span><span class="p">):</span>
            <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_at_frequency</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">gamma_ev</span><span class="o">=</span><span class="n">gamma_ev</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;linewidth&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;linewidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">phunit_tag</span><span class="p">(</span><span class="n">units</span><span class="p">)))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\epsilon(\omega)$&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">reimfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;re&#39;</span> <span class="ow">in</span> <span class="n">reim</span><span class="p">:</span> <span class="n">reimfs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="s2">&quot;Re{</span><span class="si">%s</span><span class="s2">}&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;im&#39;</span> <span class="ow">in</span> <span class="n">reim</span><span class="p">:</span> <span class="n">reimfs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="s2">&quot;Im{</span><span class="si">%s</span><span class="s2">}&quot;</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">reimf</span><span class="p">,</span> <span class="n">reims</span> <span class="ow">in</span> <span class="n">reimfs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">component</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">reims</span> <span class="o">%</span> <span class="sa">r</span><span class="s1">&#39;$\epsilon_{</span><span class="si">%d%d</span><span class="s1">}$&#39;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wmesh</span><span class="p">,</span> <span class="n">reimf</span><span class="p">(</span><span class="n">t</span><span class="p">[:,</span><span class="n">component</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">component</span><span class="p">[</span><span class="mi">1</span><span class="p">]]),</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;diag&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">reims</span> <span class="o">%</span> <span class="sa">r</span><span class="s1">&#39;$\epsilon_{</span><span class="si">%d%d</span><span class="s1">}$&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wmesh</span><span class="p">,</span> <span class="n">reimf</span><span class="p">(</span><span class="n">t</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">component</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s2">&quot;offdiag&quot;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">component</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">j</span><span class="p">:</span> <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">component</span> <span class="o">==</span> <span class="s2">&quot;offdiag&quot;</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">j</span><span class="p">:</span> <span class="k">continue</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="n">reims</span> <span class="o">%</span> <span class="sa">r</span><span class="s1">&#39;$\epsilon_{</span><span class="si">%d%d</span><span class="s1">}$&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wmesh</span><span class="p">,</span> <span class="n">reimf</span><span class="p">(</span><span class="n">t</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;diag_av&#39;</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$Average\, </span><span class="si">%s</span><span class="s1">\epsilon_</span><span class="si">{ii}</span><span class="s1">$&#39;</span> <span class="o">%</span> <span class="n">reims</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wmesh</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">reimf</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">axis1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis2</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unkwnown component </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">component</span><span class="p">))</span>

        <span class="c1"># Add points showing phonon energies.</span>
        <span class="k">if</span> <span class="n">with_phfreqs</span><span class="p">:</span>
            <span class="n">wvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phfreqs</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="o">*</span> <span class="n">phfactor_ev2units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">wvals</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">wvals</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="c1"># To maintain backward compatibility.</span>
    <span class="n">plot_vs_w</span> <span class="o">=</span> <span class="n">plot</span>

<div class="viewcode-block" id="DielectricTensorGenerator.plot_all"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DielectricTensorGenerator.plot_all">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot diagonal and off-diagonal elements of the dielectric tensor as a function of frequency.</span>
<span class="sd">        Both real and imag part are show. Accepts all arguments of `plot` method with the exception of:</span>
<span class="sd">        `component` and `reim`.</span>

<span class="sd">        Returns: |matplotlib-Figure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">axmat</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_axarray_fig_plt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                              <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">fontsize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;fontsize&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">irow</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">component</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;diag&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;offdiag&quot;</span><span class="p">}[</span><span class="n">irow</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">icol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">reim</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;re&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;im&quot;</span><span class="p">}[</span><span class="n">icol</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="n">component</span><span class="p">,</span> <span class="n">reim</span><span class="o">=</span><span class="n">reim</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axmat</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="n">icol</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div></div>


<div class="viewcode-block" id="DdbRobot"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbRobot">[docs]</a><span class="k">class</span> <span class="nc">DdbRobot</span><span class="p">(</span><span class="n">Robot</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This robot analyzes the results contained in multiple DDB_ files.</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: DdbRobot</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">EXT</span> <span class="o">=</span> <span class="s2">&quot;DDB&quot;</span>

<div class="viewcode-block" id="DdbRobot.class_handles_filename"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbRobot.class_handles_filename">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">class_handles_filename</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Exclude DDB.nc files. Override base class.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">EXT</span><span class="p">)</span></div>

<div class="viewcode-block" id="DdbRobot.from_mpid_list"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbRobot.from_mpid_list">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_mpid_list</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">mpid_list</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a DdbRobot from list of materials-project ids.</span>

<span class="sd">        Args:</span>
<span class="sd">            mpid_list: List of Materials Project material_ids (e.g., [&quot;mp-1234&quot;, &quot;mp-1245&quot;]).</span>
<span class="sd">            api_key (str): A String API key for accessing the MaterialsProject REST interface.</span>
<span class="sd">                If None, the code will check if there is a `PMG_MAPI_KEY` in your .pmgrc.yaml.</span>
<span class="sd">            endpoint (str): Url of endpoint to access the MaterialsProject REST interface.</span>
<span class="sd">                Defaults to the standard Materials Project REST address</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">abipy.core</span> <span class="k">import</span> <span class="n">restapi</span>
        <span class="n">ddb_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="n">restapi</span><span class="o">.</span><span class="n">get_mprester</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">)</span> <span class="k">as</span> <span class="n">rest</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">mpid</span> <span class="ow">in</span> <span class="n">list_strings</span><span class="p">(</span><span class="n">mpid_list</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ddb_string</span> <span class="o">=</span> <span class="n">rest</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s2">&quot;/materials/</span><span class="si">%s</span><span class="s2">/abinit_ddb&quot;</span> <span class="o">%</span> <span class="n">mpid</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">rest</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
                    <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Cannot get DDB for mp-id: </span><span class="si">%s</span><span class="s2">, ignoring error&quot;</span> <span class="o">%</span> <span class="n">mpid</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">_</span><span class="p">,</span> <span class="n">tmpfile</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">mpid</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_DDB&#39;</span><span class="p">)</span>
                <span class="n">ddb_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ddb_string</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_files</span><span class="p">(</span><span class="n">ddb_files</span><span class="p">)</span></div>

    <span class="c1">#def get_qpoints_union(self):</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    Return numpy array with the q-points in reduced coordinates found in the DDB files.</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    qpoints = []</span>
    <span class="c1">#    for label, ddb in self.items():</span>
    <span class="c1">#        qpoints.extend(q.frac_coords for q in ddb.qpoints if q not in qpoints)</span>

    <span class="c1">#    return np.array(qpoints)</span>

    <span class="c1">#def get_qpoints_intersection(self):</span>
    <span class="c1">#    &quot;&quot;&quot;Return numpy array with the q-points in reduced coordinates found in the DDB files.&quot;&quot;&quot;</span>
    <span class="c1">#    qpoints = []</span>
    <span class="c1">#    for label, ddb in self.items():</span>
    <span class="c1">#        qpoints.extend(q.frac_coords for q in ddb.qpoints if q not in qpoints)</span>
    <span class="c1">#</span>
    <span class="c1">#    return np.array(qpoints)</span>

    <span class="c1"># DEBUGGING CODE (do not remove)</span>
    <span class="c1">#def find_duplicated_entries(self, std_tol=1e-5, verbose=1):</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    Check for duplicated entries in the list of ddb files</span>

    <span class="c1">#    Args:</span>
    <span class="c1">#        std_tol: Tolerance on standard deviation</span>
    <span class="c1">#        verbose: Verbosity level.</span>

    <span class="c1">#    Return: (retcode, results) where results maps qpt --&gt; DataFrame with perts as index.</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    from pprint import pprint</span>

    <span class="c1">#    # Build q --&gt; group of dataframes.</span>
    <span class="c1">#    from collections import defaultdict</span>
    <span class="c1">#    q2dfgroup = defaultdict(list)</span>
    <span class="c1">#    for ddb in self.abifiles:</span>
    <span class="c1">#        for qpt, df in ddb.computed_dynmat.items():</span>
    <span class="c1">#            q2dfgroup[qpt].append(df)</span>

    <span class="c1">#    retcode, results = 0, {}</span>
    <span class="c1">#    for qpt, dfgroup in q2dfgroup.items():</span>
    <span class="c1">#        all_indset = [set(df.index) for df in dfgroup]</span>
    <span class="c1">#        # Build union of all dynmat indices with this q</span>
    <span class="c1">#        allps = set(all_indset[0]).union(*all_indset)</span>
    <span class="c1">#        #allps = set(all_indset[0]).intersection(*all_indset)</span>

    <span class="c1">#        index, d_list = [], []</span>
    <span class="c1">#        for p in allps:</span>
    <span class="c1">#            # Find dataframes with this p</span>
    <span class="c1">#            found = [p in index for index in all_indset]</span>
    <span class="c1">#            count = found.count(True)</span>
    <span class="c1">#            if count == 1: continue</span>
    <span class="c1">#            if verbose:</span>
    <span class="c1">#                print(&quot;Found %s duplicated entries for p: %s&quot; % (count, str(p)))</span>

    <span class="c1">#            # Compute stats for this p (complex numbers)</span>
    <span class="c1">#            cvalues = []</span>
    <span class="c1">#            for f, df in zip(found, dfgroup):</span>
    <span class="c1">#                if not f: continue</span>
    <span class="c1">#                c = df[&quot;cvalue&quot;].loc[[p]]</span>
    <span class="c1">#                cvalues.append(c)</span>

    <span class="c1">#            cvalues = np.array(cvalues)</span>
    <span class="c1">#            norms = np.abs(cvalues)</span>
    <span class="c1">#            d = dict(mean=cvalues.mean(), std=cvalues.std(),</span>
    <span class="c1">#                     min_norm=norms.min(), max_norm=norms.max(), count=count)</span>

    <span class="c1">#            # Print warning if large deviation</span>
    <span class="c1">#            #if d[&quot;max_norm&quot;]  - d[&quot;min_norm&quot;] &gt; 1e-5:</span>
    <span class="c1">#            if d[&quot;std&quot;] &gt; std_tol:</span>
    <span class="c1">#                retcode += 1</span>
    <span class="c1">#                cprint(&quot;Found std &gt; %s&quot; % std_tol, &quot;red&quot;)</span>
    <span class="c1">#                pprint(cvalues)</span>
    <span class="c1">#            if verbose:</span>
    <span class="c1">#                pprint(d)</span>
    <span class="c1">#                print(2 * &quot;&quot;)</span>

    <span class="c1">#            d_list.append(d)</span>
    <span class="c1">#            index.append(p)</span>

    <span class="c1">#        results[qpt] = pd.DataFrame(d_list, index=index)</span>

    <span class="c1">#    return retcode, results</span>

<div class="viewcode-block" id="DdbRobot.get_dataframe_at_qpoint"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbRobot.get_dataframe_at_qpoint">[docs]</a>    <span class="k">def</span> <span class="nf">get_dataframe_at_qpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="n">asr</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">chneut</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dipdip</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">with_geo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_spglib</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">abspath</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">funcs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call anaddb to compute the phonon frequencies at a single q-point using the DDB files treated</span>
<span class="sd">        by the robot and the given anaddb input arguments. LO-TO splitting is not included.</span>
<span class="sd">        Build and return a |pandas-Dataframe| with results</span>

<span class="sd">        Args:</span>
<span class="sd">            qpoint: Reduced coordinates of the qpoint where phonon modes are computed</span>
<span class="sd">            units: string specifying the units used for ph frequencies.  Possible values in</span>
<span class="sd">                (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;). Case-insensitive.</span>
<span class="sd">            asr, chneut, dipdip: Anaddb input variable. See official documentation.</span>
<span class="sd">            with_geo: True if structure info should be added to the dataframe</span>
<span class="sd">            with_spglib: True to compute spglib space group and add it to the DataFrame.</span>
<span class="sd">            abspath: True if paths in index should be absolute. Default: Relative to getcwd().</span>
<span class="sd">            funcs: Function or list of functions to execute to add more data to the DataFrame.</span>
<span class="sd">                Each function receives a |DdbFile| object and returns a tuple (key, value)</span>
<span class="sd">                where key is a string with the name of column and value is the value to be inserted.</span>

<span class="sd">        Return: |pandas-DataFrame|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If qpoint is None, all the DDB must contain have the same q-point .</span>
        <span class="k">if</span> <span class="n">qpoint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ddb</span><span class="o">.</span><span class="n">qpoints</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">ddb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Found more than one q-point in the DDB file. qpoint must be specified&quot;</span><span class="p">)</span>

            <span class="n">qpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">qpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ddb</span><span class="o">.</span><span class="n">qpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">qpoint</span><span class="p">)</span> <span class="k">for</span> <span class="n">ddb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All the q-points in the DDB files must be equal&quot;</span><span class="p">)</span>

        <span class="n">rows</span><span class="p">,</span> <span class="n">row_names</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">ddb</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">row_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="c1">#d = {aname: getattr(ddb, aname) for aname in attrs}</span>
            <span class="c1">#d.update({&quot;qpgap&quot;: mdf.get_qpgap(spin, kpoint)})</span>

            <span class="c1"># Call anaddb to get the phonon frequencies. Note lo_to_splitting set to False.</span>
            <span class="n">phbands</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">anaget_phmodes_at_qpoint</span><span class="p">(</span><span class="n">qpoint</span><span class="o">=</span><span class="n">qpoint</span><span class="p">,</span> <span class="n">asr</span><span class="o">=</span><span class="n">asr</span><span class="p">,</span> <span class="n">chneut</span><span class="o">=</span><span class="n">chneut</span><span class="p">,</span>
               <span class="n">dipdip</span><span class="o">=</span><span class="n">dipdip</span><span class="p">,</span> <span class="n">lo_to_splitting</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># [nq, nmodes] array</span>
            <span class="n">freqs</span> <span class="o">=</span> <span class="n">phbands</span><span class="o">.</span><span class="n">phfreqs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">phfactor_ev2units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>

            <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;mode&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">):</span> <span class="n">freqs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">freqs</span><span class="p">))})</span>

            <span class="c1"># Add convergence parameters</span>
            <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ddb</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

            <span class="c1"># Add info on structure.</span>
            <span class="k">if</span> <span class="n">with_geo</span><span class="p">:</span>
                <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">phbands</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">get_dict4pandas</span><span class="p">(</span><span class="n">with_spglib</span><span class="o">=</span><span class="n">with_spglib</span><span class="p">))</span>

            <span class="c1"># Execute functions.</span>
            <span class="k">if</span> <span class="n">funcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exec_funcs</span><span class="p">(</span><span class="n">funcs</span><span class="p">,</span> <span class="n">ddb</span><span class="p">))</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="n">row_names</span> <span class="o">=</span> <span class="n">row_names</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">abspath</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_relpaths</span><span class="p">(</span><span class="n">row_names</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">row_names</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span></div>

<div class="viewcode-block" id="DdbRobot.anaget_phonon_plotters"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbRobot.anaget_phonon_plotters">[docs]</a>    <span class="k">def</span> <span class="nf">anaget_phonon_plotters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Invoke anaddb to compute phonon bands and DOS using the arguments passed via \*\*kwargs.</span>
<span class="sd">        Collect results and return `namedtuple` with the following attributes:</span>

<span class="sd">            phbands_plotter: |PhononBandsPlotter| object.</span>
<span class="sd">            phdos_plotter: |PhononDosPlotter| object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Multiprocessing?</span>
        <span class="k">if</span> <span class="s2">&quot;workdir&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot specify `workdir` when multiple DDB file are executed.&quot;</span><span class="p">)</span>

        <span class="n">phbands_plotter</span><span class="p">,</span> <span class="n">phdos_plotter</span> <span class="o">=</span> <span class="n">PhononBandsPlotter</span><span class="p">(),</span> <span class="n">PhononDosPlotter</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">ddb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Invoke anaddb to get phonon bands and DOS.</span>
            <span class="n">phbst_file</span><span class="p">,</span> <span class="n">phdos_file</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">anaget_phbst_and_phdos_files</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="c1"># Phonon frequencies with non analytical contributions, if calculated, are saved in anaddb.nc</span>
            <span class="c1"># Those results should be fetched from there and added to the phonon bands.</span>
            <span class="c1"># lo_to_splitting in [&quot;automatic&quot;, True, False] and defaults to automatic.</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lo_to_splitting&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">anaddb_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">phbst_file</span><span class="o">.</span><span class="n">filepath</span><span class="p">),</span> <span class="s2">&quot;anaddb.nc&quot;</span><span class="p">)</span>
                <span class="n">phbst_file</span><span class="o">.</span><span class="n">phbands</span><span class="o">.</span><span class="n">read_non_anal_from_file</span><span class="p">(</span><span class="n">anaddb_path</span><span class="p">)</span>

            <span class="n">phbands_plotter</span><span class="o">.</span><span class="n">add_phbands</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">phbst_file</span><span class="p">,</span> <span class="n">phdos</span><span class="o">=</span><span class="n">phdos_file</span><span class="p">)</span>
            <span class="n">phbst_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">phdos_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">phdos_plotter</span><span class="o">.</span><span class="n">add_phdos</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">phdos</span><span class="o">=</span><span class="n">phdos_file</span><span class="o">.</span><span class="n">phdos</span><span class="p">)</span>
                <span class="n">phdos_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">dict2namedtuple</span><span class="p">(</span><span class="n">phbands_plotter</span><span class="o">=</span><span class="n">phbands_plotter</span><span class="p">,</span> <span class="n">phdos_plotter</span><span class="o">=</span><span class="n">phdos_plotter</span><span class="p">)</span></div>

<div class="viewcode-block" id="DdbRobot.anacompare_elastic"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbRobot.anacompare_elastic">[docs]</a>    <span class="k">def</span> <span class="nf">anacompare_elastic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ddb_header_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_structure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_spglib</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">with_path</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute elastic and piezoelectric properties for all DDBs in the robot and build DataFrame.</span>

<span class="sd">        Args:</span>
<span class="sd">            ddb_header_keys: List of keywords in the header of the DDB file</span>
<span class="sd">                whose value will be added to the Dataframe.</span>
<span class="sd">            with_structure: True to add structure parameters to the DataFrame.</span>
<span class="sd">            with_spglib: True to compute spglib space group and add it to the DataFrame.</span>
<span class="sd">            with_path: True to add DDB path to dataframe</span>
<span class="sd">            manager: |TaskManager| object. If None, the object is initialized from the configuration file</span>
<span class="sd">            verbose: verbosity level. Set it to a value &gt; 0 to get more information</span>
<span class="sd">            kwargs: Keyword arguments passed to `ddb.anaget_elastic`.</span>

<span class="sd">        Return: DataFrame and list of ElastData objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ddb_header_keys</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">ddb_header_keys</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">list_strings</span><span class="p">(</span><span class="n">ddb_header_keys</span><span class="p">)</span>
        <span class="n">df_list</span><span class="p">,</span> <span class="n">elastdata_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">ddb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Invoke anaddb to compute elastic data.</span>
            <span class="n">edata</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">anaget_elastic</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">elastdata_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edata</span><span class="p">)</span>

            <span class="c1"># Build daframe with properties derived from the elastic tensor.</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">edata</span><span class="o">.</span><span class="n">get_elastic_properties_dataframe</span><span class="p">()</span>

            <span class="c1"># Add metadata to the dataframe.</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;formula&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">formula</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ddb_header_keys</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

            <span class="c1"># Add structural parameters to the dataframe.</span>
            <span class="k">if</span> <span class="n">with_structure</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">skey</span><span class="p">,</span> <span class="n">svalue</span> <span class="ow">in</span> <span class="n">ddb</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">get_dict4pandas</span><span class="p">(</span><span class="n">with_spglib</span><span class="o">=</span><span class="n">with_spglib</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">skey</span><span class="p">]</span> <span class="o">=</span> <span class="n">svalue</span>

            <span class="c1"># Add path to the DDB file.</span>
            <span class="k">if</span> <span class="n">with_path</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;ddb_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">filepath</span>

            <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># Concatenate dataframes.</span>
        <span class="k">return</span> <span class="n">dict2namedtuple</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                               <span class="n">elastdata_list</span><span class="o">=</span><span class="n">elastdata_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="DdbRobot.anacompare_becs"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbRobot.anacompare_becs">[docs]</a>    <span class="k">def</span> <span class="nf">anacompare_becs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ddb_header_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chneut</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">with_path</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Born effective charges for all DDBs in the robot and build DataFrame.</span>
<span class="sd">        with Voigt indices as columns + metadata. Useful for convergence studies.</span>

<span class="sd">        Args:</span>
<span class="sd">            ddb_header_keys: List of keywords in the header of the DDB file</span>
<span class="sd">                whose value will be added to the Dataframe.</span>
<span class="sd">            chneut: Anaddb input variable. See official documentation.</span>
<span class="sd">            tol: Elements below this value are set to zero.</span>
<span class="sd">            with_path: True to add DDB path to dataframe</span>
<span class="sd">            verbose: verbosity level. Set it to a value &gt; 0 to get more information</span>

<span class="sd">        Return: ``namedtuple`` with the following attributes::</span>

<span class="sd">            df: DataFrame with Voigt as columns.</span>
<span class="sd">            becs_list: list of Becs objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ddb_header_keys</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">ddb_header_keys</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">list_strings</span><span class="p">(</span><span class="n">ddb_header_keys</span><span class="p">)</span>
        <span class="n">df_list</span><span class="p">,</span> <span class="n">becs_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">ddb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Invoke anaddb to compute Becs</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">becs</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">anaget_epsinf_and_becs</span><span class="p">(</span><span class="n">chneut</span><span class="o">=</span><span class="n">chneut</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="n">becs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">becs</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">becs</span><span class="o">.</span><span class="n">get_voigt_dataframe</span><span class="p">(</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span>

            <span class="c1"># Add metadata to the dataframe.</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;formula&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">formula</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;chneut&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chneut</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ddb_header_keys</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

            <span class="c1"># Add path to the DDB file.</span>
            <span class="k">if</span> <span class="n">with_path</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;ddb_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">filepath</span>

            <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># Concatenate dataframes.</span>
        <span class="k">return</span> <span class="n">dict2namedtuple</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;site_index&quot;</span><span class="p">),</span>
                               <span class="n">becs_list</span><span class="o">=</span><span class="n">becs_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="DdbRobot.anacompare_epsinf"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbRobot.anacompare_epsinf">[docs]</a>    <span class="k">def</span> <span class="nf">anacompare_epsinf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ddb_header_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chneut</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">with_path</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute (eps^\inf) electronic dielectric tensor for all DDBs in the robot and build DataFrame.</span>
<span class="sd">        with Voigt indices as columns + metadata. Useful for convergence studies.</span>

<span class="sd">        Args:</span>
<span class="sd">            ddb_header_keys: List of keywords in the header of the DDB file</span>
<span class="sd">                whose value will be added to the Dataframe.</span>
<span class="sd">            chneut: Anaddb input variable. See official documentation.</span>
<span class="sd">            tol: Elements below this value are set to zero.</span>
<span class="sd">            with_path: True to add DDB path to dataframe</span>
<span class="sd">            verbose: verbosity level. Set it to a value &gt; 0 to get more information</span>

<span class="sd">        Return: ``namedtuple`` with the following attributes::</span>

<span class="sd">            df: DataFrame with Voigt indices as columns.</span>
<span class="sd">            epsinf_list: List of |DielectricTensor| objects with eps^{inf}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ddb_header_keys</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">ddb_header_keys</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">list_strings</span><span class="p">(</span><span class="n">ddb_header_keys</span><span class="p">)</span>
        <span class="n">df_list</span><span class="p">,</span> <span class="n">epsinf_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">ddb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Invoke anaddb to compute e_inf</span>
            <span class="n">einf</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">anaget_epsinf_and_becs</span><span class="p">(</span><span class="n">chneut</span><span class="o">=</span><span class="n">chneut</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="n">epsinf_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">einf</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">einf</span><span class="o">.</span><span class="n">get_voigt_dataframe</span><span class="p">(</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span>

            <span class="c1"># Add metadata to the dataframe.</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;formula&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">formula</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;chneut&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chneut</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ddb_header_keys</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

            <span class="c1"># Add path to the DDB file.</span>
            <span class="k">if</span> <span class="n">with_path</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;ddb_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">filepath</span>
            <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># Concatenate dataframes.</span>
        <span class="k">return</span> <span class="n">dict2namedtuple</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">epsinf_list</span><span class="o">=</span><span class="n">epsinf_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="DdbRobot.anacompare_eps0"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbRobot.anacompare_eps0">[docs]</a>    <span class="k">def</span> <span class="nf">anacompare_eps0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ddb_header_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">asr</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">chneut</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">with_path</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute (eps^0) dielectric tensor for all DDBs in the robot and build DataFrame.</span>
<span class="sd">        with Voigt indices as columns + metadata. Useful for convergence studies.</span>

<span class="sd">        Args:</span>
<span class="sd">            ddb_header_keys: List of keywords in the header of the DDB file</span>
<span class="sd">                whose value will be added to the Dataframe.</span>
<span class="sd">            asr, chneut, dipdip: Anaddb input variable. See official documentation.</span>
<span class="sd">            tol: Elements below this value are set to zero.</span>
<span class="sd">            with_path: True to add DDB path to dataframe</span>
<span class="sd">            verbose: verbosity level. Set it to a value &gt; 0 to get more information</span>

<span class="sd">        Return: ``namedtuple`` with the following attributes::</span>

<span class="sd">            df: DataFrame with Voigt as columns.</span>
<span class="sd">            eps0_list: List of |DielectricTensor| objects with eps^0.</span>
<span class="sd">            dgen_list: List of DielectricTensorGenerator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ddb_header_keys</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">ddb_header_keys</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">list_strings</span><span class="p">(</span><span class="n">ddb_header_keys</span><span class="p">)</span>
        <span class="n">df_list</span><span class="p">,</span> <span class="n">eps0_list</span><span class="p">,</span> <span class="n">dgen_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">ddb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Invoke anaddb to compute e_0</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">anaget_dielectric_tensor_generator</span><span class="p">(</span><span class="n">asr</span><span class="o">=</span><span class="n">asr</span><span class="p">,</span> <span class="n">chneut</span><span class="o">=</span><span class="n">chneut</span><span class="p">,</span> <span class="n">dipdip</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="n">dgen_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
            <span class="n">eps0_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gen</span><span class="o">.</span><span class="n">eps0</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">eps0</span><span class="o">.</span><span class="n">get_voigt_dataframe</span><span class="p">(</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span>

            <span class="c1"># Add metadata to the dataframe.</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;formula&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">formula</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;asr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">asr</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;chneut&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chneut</span>
            <span class="c1">#df[&quot;dipdip&quot;] = dipdip</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ddb_header_keys</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

            <span class="c1"># Add path to the DDB file.</span>
            <span class="k">if</span> <span class="n">with_path</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;ddb_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">filepath</span>

            <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># Concatenate dataframes.</span>
        <span class="k">return</span> <span class="n">dict2namedtuple</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                               <span class="n">eps0_list</span><span class="o">=</span><span class="n">eps0_list</span><span class="p">,</span> <span class="n">dgen_list</span><span class="o">=</span><span class="n">dgen_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="DdbRobot.yield_figs"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbRobot.yield_figs">[docs]</a>    <span class="k">def</span> <span class="nf">yield_figs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function *generates* a predefined list of matplotlib figures with minimal input from the user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">ddb</span><span class="o">.</span><span class="n">has_at_least_one_atomic_perturbation</span><span class="p">()</span> <span class="k">for</span> <span class="n">ddb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abifiles</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invoking anaddb through anaget_phonon_plotters...&quot;</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anaget_phonon_plotters</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">fig</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">phbands_plotter</span><span class="o">.</span><span class="n">yield_figs</span><span class="p">():</span> <span class="k">yield</span> <span class="n">fig</span>
            <span class="k">for</span> <span class="n">fig</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">phdos_plotter</span><span class="o">.</span><span class="n">yield_figs</span><span class="p">():</span> <span class="k">yield</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="DdbRobot.write_notebook"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.ddb.DdbRobot.write_notebook">[docs]</a>    <span class="k">def</span> <span class="nf">write_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a jupyter_ notebook to nbpath. If ``nbpath`` is None, a temporary file in the current</span>
<span class="sd">        working directory is created. Return path to the notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbformat</span><span class="p">,</span> <span class="n">nbv</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nbformat_nbv_nb</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">anaget_phonon_plotters_kwargs</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">nqsmall=10, ndivsm=20, asr=2, chneut=1, dipdip=1, dos_method=&quot;tetra&quot;,</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">lo_to_splitting=False, ngqpt=None, qptbounds=None,</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">anaddb_kwargs=None, verbose=0&#39;</span><span class="p">)</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">[(</span><span class="n">l</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="c1">#nbv.new_markdown_cell(&quot;# This is a markdown cell&quot;),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;robot = abilab.DdbRobot(*</span><span class="si">%s</span><span class="s2">)</span><span class="se">\n</span><span class="s2">robot.trim_paths()</span><span class="se">\n</span><span class="s2">robot&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">)),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;#dfq = robot.get_dataframe_at_qpoint(qpoint=None, units=&quot;meV&quot;)&quot;&quot;&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;r = robot.anaget_phonon_plotters(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">anaget_phonon_plotters_kwargs</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;r.phbands_plotter.get_phbands_frame()&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;r.phbands_plotter.ipw_select_plot()&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;r.phdos_plotter.ipw_select_plot()&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;r.phdos_plotter.ipw_harmonic_thermo()&quot;</span><span class="p">),</span>
        <span class="p">])</span>

        <span class="c1"># Mixins</span>
        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_baserobot_code_cells</span><span class="p">())</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_nb_nbpath</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nbpath</span><span class="p">)</span></div></div>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2018, M. Giantomassi and the AbiPy group.<br/>
      Last updated on Oct 18, 2019.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.0.<br/>
    </p>
  </div>
</footer>
  </body>
</html>