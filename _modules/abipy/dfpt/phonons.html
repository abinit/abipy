<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>abipy.dfpt.phonons &#8212; abipy 0.2.0 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/abipy_logo.png" alt="Logo"/>
            </a></p><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for abipy.dfpt.phonons</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: utf-8</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">unicode_literals</span><span class="p">,</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">abipy.core.abinit_units</span> <span class="k">as</span> <span class="nn">abu</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">monty.string</span> <span class="k">import</span> <span class="n">is_string</span><span class="p">,</span> <span class="n">list_strings</span><span class="p">,</span> <span class="n">marquee</span>
<span class="kn">from</span> <span class="nn">monty.collections</span> <span class="k">import</span> <span class="n">AttrDict</span>
<span class="kn">from</span> <span class="nn">monty.functools</span> <span class="k">import</span> <span class="n">lazy_property</span>
<span class="kn">from</span> <span class="nn">monty.termcolor</span> <span class="k">import</span> <span class="n">cprint</span>
<span class="kn">from</span> <span class="nn">monty.dev</span> <span class="k">import</span> <span class="n">deprecated</span>
<span class="kn">from</span> <span class="nn">pymatgen.core.units</span> <span class="k">import</span> <span class="n">eV_to_Ha</span><span class="p">,</span> <span class="n">Energy</span>
<span class="kn">from</span> <span class="nn">abipy.core.func1d</span> <span class="k">import</span> <span class="n">Function1D</span>
<span class="kn">from</span> <span class="nn">abipy.core.mixins</span> <span class="k">import</span> <span class="n">AbinitNcFile</span><span class="p">,</span> <span class="n">Has_Structure</span><span class="p">,</span> <span class="n">Has_PhononBands</span><span class="p">,</span> <span class="n">NotebookWriter</span>
<span class="kn">from</span> <span class="nn">abipy.core.kpoints</span> <span class="k">import</span> <span class="n">Kpoint</span><span class="p">,</span> <span class="n">KpointList</span>
<span class="kn">from</span> <span class="nn">abipy.iotools</span> <span class="k">import</span> <span class="n">ETSF_Reader</span>
<span class="kn">from</span> <span class="nn">abipy.tools</span> <span class="k">import</span> <span class="n">gaussian</span><span class="p">,</span> <span class="n">duck</span>
<span class="kn">from</span> <span class="nn">abipy.tools.plotting</span> <span class="k">import</span> <span class="n">add_fig_kwargs</span><span class="p">,</span> <span class="n">get_ax_fig_plt</span><span class="p">,</span> <span class="n">set_axlims</span>



<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;frame_from_phbands&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PhononBands&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PhononBandsPlotter&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PhbstFile&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PhononDos&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PhononDosPlotter&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PhdosReader&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PhdosFile&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">_factor_ev2units</span><span class="p">(</span><span class="n">units</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return conversion factor eV --&gt; units (case-insensitive)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">eV_to_cm1</span> <span class="o">=</span> <span class="mf">8065.5440044136285</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ev&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;mev&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s2">&quot;ha&quot;</span><span class="p">:</span> <span class="n">eV_to_Ha</span><span class="p">,</span>
         <span class="s2">&quot;cm-1&quot;</span><span class="p">:</span> <span class="n">eV_to_cm1</span><span class="p">,</span> <span class="s1">&#39;cm^-1&#39;</span><span class="p">:</span> <span class="n">eV_to_cm1</span><span class="p">,</span> <span class="s2">&quot;thz&quot;</span><span class="p">:</span> <span class="n">abu</span><span class="o">.</span><span class="n">eV_to_THz</span><span class="p">,</span>
         <span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">d</span><span class="p">[</span><span class="n">units</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Value for units `</span><span class="si">{}</span><span class="s1">` unknown</span><span class="se">\n</span><span class="s1">Possible values are:</span><span class="se">\n</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>


<span class="k">def</span> <span class="nf">_unit_tag</span><span class="p">(</span><span class="n">units</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ev&quot;</span><span class="p">:</span> <span class="s2">&quot;[eV]&quot;</span><span class="p">,</span> <span class="s2">&quot;mev&quot;</span><span class="p">:</span> <span class="s2">&quot;[meV]&quot;</span><span class="p">,</span> <span class="s2">&quot;ha&quot;</span><span class="p">:</span> <span class="s1">&#39;[Ha]&#39;</span><span class="p">,</span>
         <span class="s2">&quot;cm-1&quot;</span><span class="p">:</span> <span class="s2">&quot;[cm$^{-1}$]&quot;</span><span class="p">,</span> <span class="s1">&#39;cm^-1&#39;</span><span class="p">:</span> <span class="s2">&quot;[cm$^{-1}$]&quot;</span><span class="p">,</span> <span class="s2">&quot;thz&quot;</span><span class="p">:</span> <span class="s1">&#39;[Thz]&#39;</span><span class="p">,</span>
         <span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">d</span><span class="p">[</span><span class="n">units</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Value for units `</span><span class="si">{}</span><span class="s1">` unknown</span><span class="se">\n</span><span class="s1">Possible values are:</span><span class="se">\n</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>


<span class="k">def</span> <span class="nf">_dos_label_from_units</span><span class="p">(</span><span class="n">units</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ev&quot;</span><span class="p">:</span> <span class="s2">&quot;[states/eV]&quot;</span><span class="p">,</span> <span class="s2">&quot;mev&quot;</span><span class="p">:</span> <span class="s2">&quot;[states/meV]&quot;</span><span class="p">,</span> <span class="s2">&quot;ha&quot;</span><span class="p">:</span> <span class="s1">&#39;[states/Ha]&#39;</span><span class="p">,</span>
         <span class="s2">&quot;cm-1&quot;</span><span class="p">:</span> <span class="s2">&quot;[states/cm$^{-1}$]&quot;</span><span class="p">,</span> <span class="s1">&#39;cm^-1&#39;</span><span class="p">:</span> <span class="s2">&quot;[states/cm$^{-1}$]&quot;</span><span class="p">,</span>
         <span class="s2">&quot;thz&quot;</span><span class="p">:</span> <span class="s1">&#39;[states/Thz]&#39;</span><span class="p">,</span>
         <span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">d</span><span class="p">[</span><span class="n">units</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Value for units `</span><span class="si">{}</span><span class="s1">` unknown</span><span class="se">\n</span><span class="s1">Possible values are:</span><span class="se">\n</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>


<span class="nd">@functools</span><span class="o">.</span><span class="n">total_ordering</span>
<span class="k">class</span> <span class="nc">PhononMode</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A phonon mode has a q-point, a frequency, a cartesian displacement and a structure.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;qpoint&quot;</span><span class="p">,</span>
        <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
        <span class="s2">&quot;displ_cart&quot;</span><span class="p">,</span> <span class="c1"># Cartesian displacement.</span>
        <span class="s2">&quot;structure&quot;</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qpoint</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">displ_cart</span><span class="p">,</span> <span class="n">structure</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            qpoint: qpoint in reduced coordinates.</span>
<span class="sd">            freq: Phonon frequency in eV.</span>
<span class="sd">            displ: Displacement (Cartesian coordinates, Angstrom)</span>
<span class="sd">            structure: :class:`Structure` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qpoint</span> <span class="o">=</span> <span class="n">Kpoint</span><span class="o">.</span><span class="n">as_kpoint</span><span class="p">(</span><span class="n">qpoint</span><span class="p">,</span> <span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">=</span> <span class="n">freq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displ_cart</span> <span class="o">=</span> <span class="n">displ_cart</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">structure</span>

    <span class="c1"># Rich comparison support (ordered is based on the frequency).</span>
    <span class="c1"># Missing operators are automatically filled by total_ordering.</span>
    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">freq</span>

    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">freq</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">with_displ</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_displ</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        String representation</span>

<span class="sd">        Args:</span>
<span class="sd">           with_displ: True to print phonon displacement.</span>
<span class="sd">	&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: q-point </span><span class="si">%s</span><span class="s2">, frequency </span><span class="si">%.5f</span><span class="s2"> [eV]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">)]</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>

        <span class="k">if</span> <span class="n">with_displ</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Phonon displacement in cartesian coordinates [Angstrom]&quot;</span><span class="p">)</span>
            <span class="n">app</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">displ_cart</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="c1">#@property</span>
    <span class="c1">#def displ_red(self)</span>
    <span class="c1">#    return np.dot(self.xred, self.rprimd)</span>

    <span class="c1">#def export(self, path):</span>
    <span class="c1">#def visualize(self, visualizer):</span>
    <span class="c1">#def build_supercell(self):</span>


<div class="viewcode-block" id="PhononBands"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBands">[docs]</a><span class="k">class</span> <span class="nc">PhononBands</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Container object storing the phonon band structure.</span>

<span class="sd">    .. note::</span>

<span class="sd">        Frequencies are in eV. Cartesian displacements are in Angstrom.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="PhononBands.from_file"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBands.from_file">[docs]</a>    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the object from a netCDF file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">PHBST_Reader</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">structure</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_structure</span><span class="p">()</span>

            <span class="c1"># Build the list of q-points</span>
            <span class="n">qpoints</span> <span class="o">=</span> <span class="n">KpointList</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">,</span>
                                 <span class="n">frac_coords</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">read_qredcoords</span><span class="p">(),</span>
                                 <span class="n">weights</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">read_qweights</span><span class="p">(),</span>
                                 <span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

            <span class="c1"># Read amu</span>
            <span class="n">amu_list</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_amu</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">amu_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">atom_species</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;atomic_numbers&quot;</span><span class="p">)</span>
                <span class="n">amu</span> <span class="o">=</span> <span class="p">{</span><span class="n">at</span><span class="p">:</span> <span class="n">a</span> <span class="k">for</span> <span class="n">at</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">atom_species</span><span class="p">,</span> <span class="n">amu_list</span><span class="p">)}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Warning: file </span><span class="si">%s</span><span class="s2"> does not contain atomic_numbers.</span><span class="se">\n</span><span class="s2">Particular methods need them!&quot;</span> <span class="o">%</span>
                        <span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
                <span class="n">amu</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span>
                       <span class="n">qpoints</span><span class="o">=</span><span class="n">qpoints</span><span class="p">,</span>
                       <span class="n">phfreqs</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">read_phfreqs</span><span class="p">(),</span>
                       <span class="n">phdispl_cart</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">read_phdispl_cart</span><span class="p">(),</span>
                       <span class="n">amu</span><span class="o">=</span><span class="n">amu</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="PhononBands.as_phbands"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBands.as_phbands">[docs]</a>    <span class="k">def</span> <span class="nf">as_phbands</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an instance of :class:`PhononBands` from a generic obj.</span>
<span class="sd">        Supports:</span>

<span class="sd">            - instances of cls</span>
<span class="sd">            - files (string) that can be open with abiopen and that provide a `phbands` attribute.</span>
<span class="sd">            - objects providing a `phbands` attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obj</span>

        <span class="k">elif</span> <span class="n">is_string</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="c1"># path?</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pickle&quot;</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">as_phbands</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">))</span>

            <span class="kn">from</span> <span class="nn">abipy.abilab</span> <span class="k">import</span> <span class="n">abiopen</span>
            <span class="k">with</span> <span class="n">abiopen</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="k">as</span> <span class="n">abifile</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">abifile</span><span class="o">.</span><span class="n">phbands</span>

        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;phbands&quot;</span><span class="p">):</span>
            <span class="c1"># object with phbands</span>
            <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">phbands</span>

        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know how to extract a PhononBands from type </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="PhononBands.factor_ev2units"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBands.factor_ev2units">[docs]</a>    <span class="k">def</span> <span class="nf">factor_ev2units</span><span class="p">(</span><span class="n">units</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return conversion factor eV --&gt; units (case-insensitive)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_factor_ev2units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhononBands.read_non_anal_from_file"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBands.read_non_anal_from_file">[docs]</a>    <span class="k">def</span> <span class="nf">read_non_anal_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads the non analytical directions, frequencies and eigendisplacements from the anaddb.nc file specified and</span>
<span class="sd">        adds them to the object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">non_anal_ph</span> <span class="o">=</span> <span class="n">NonAnalyticalPh</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">qpoints</span><span class="p">,</span> <span class="n">phfreqs</span><span class="p">,</span> <span class="n">phdispl_cart</span><span class="p">,</span> <span class="n">non_anal_ph</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">amu</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            structure: :class:`Structure` object.</span>
<span class="sd">            qpoints: :class:`KpointList` instance.</span>
<span class="sd">            phfreqs: Phonon frequencies in eV.</span>
<span class="sd">            phdispl_cart: [nqpt, 3*natom, 3*natom] array with displacement in Cartesian coordinates in Angstrom.</span>
<span class="sd">                The last dimension stores the cartesian components.</span>
<span class="sd">            non_anal_ph: :class:`NonAnalyticalPh` with information of the non analytical contribution</span>
<span class="sd">                None if contribution is not present</span>
<span class="sd">            amu: dictionary that associates the atomic species present in the structure to the values of the atomic</span>
<span class="sd">                mass units used for the calculation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">structure</span>

        <span class="c1"># `KpointList` with the q-points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span> <span class="o">=</span> <span class="n">qpoints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_qpoints</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">)</span>

        <span class="c1"># numpy array with phonon frequencies. Shape=(nqpt, 3*natom)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phfreqs</span> <span class="o">=</span> <span class="n">phfreqs</span>

        <span class="c1"># phonon displacements in Cartesian coordinates.</span>
        <span class="c1"># `ndarray` of shape (nqpt, 3*natom, 3*natom).</span>
        <span class="c1"># The last dimension stores the cartesian components.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phdispl_cart</span> <span class="o">=</span> <span class="n">phdispl_cart</span>

        <span class="c1"># Handy variables used to loop.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_atoms</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">num_sites</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_branches</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_atoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">branches</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_branches</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">non_anal_ph</span> <span class="o">=</span> <span class="n">non_anal_ph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amu</span> <span class="o">=</span> <span class="n">amu</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation (short version)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">%s</span><span class="s2">, nk=</span><span class="si">%d</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, id=</span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_qpoints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

<div class="viewcode-block" id="PhononBands.to_string"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBands.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_structure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_qpoints</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Human-readable string with useful information such as structure, q-points, ...</span>

<span class="sd">        Args:</span>
<span class="sd">            with_structure: False if structural info shoud not be displayed.</span>
<span class="sd">            with_qpoints: False if q-point info shoud not be displayed.</span>
<span class="sd">            verbose: Verbosity level.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">with_structure</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="s2">&quot;Structure&quot;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
            <span class="n">app</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">))</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="s2">&quot;Phonon Bands&quot;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Number of q-points: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_qpoints</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Atomic mass units: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amu</span><span class="p">))</span>
        <span class="n">has_dipdip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_anal_ph</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Has non-analytical contribution for q --&gt; 0: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">has_dipdip</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">has_dipdip</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">non_anal_ph</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">with_qpoints</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="s2">&quot;Q-points&quot;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
            <span class="n">app</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">))</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;self + other returns a :class:`PhononBandsPlotter`.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="n">PhononBands</span><span class="p">,</span> <span class="n">PhononBandsPlotter</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Cannot add </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)))</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">PhononBandsPlotter</span><span class="p">):</span>
            <span class="n">self_key</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">other</span><span class="o">.</span><span class="n">add_phbands</span><span class="p">(</span><span class="n">self_key</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">other</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plotter</span> <span class="o">=</span> <span class="n">PhononBandsPlotter</span><span class="p">()</span>
            <span class="n">self_key</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">add_phbands</span><span class="p">(</span><span class="n">self_key</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="n">self_key</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">other_key</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">add_phbands</span><span class="p">(</span><span class="n">other_key</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">plotter</span>

    <span class="fm">__radd__</span> <span class="o">=</span> <span class="fm">__add__</span>

    <span class="c1">#def displ_of_specie(self, specie):</span>
    <span class="c1">#    &quot;&quot;&quot;Returns the displacement vectors for the given specie.&quot;&quot;&quot;</span>
    <span class="c1">#    # TODO recheck the ordering</span>
    <span class="c1">#    # (nqpt, 3*natom, natom, 2) the last dimension stores the cartesian components.</span>
    <span class="c1">#    #raise NotImplementedError(&quot;&quot;)</span>
    <span class="c1">#    displ_specie = []</span>
    <span class="c1">#    for i, site in enumerate(self.structure):</span>
    <span class="c1">#        if site.specie == specie:</span>
    <span class="c1">#            displ_specie.append(self.phdispl_cart[:, :, i, :])</span>

    <span class="c1">#    return displ_specie</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">_auto_qlabels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Find the q-point names in the pymatgen database.</span>
        <span class="c1"># We&#39;ll use _auto_qlabels to label the point in the matplotlib plot</span>
        <span class="c1"># if qlabels are not specified by the user.</span>
        <span class="n">_auto_qlabels</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">qpoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">findname_in_hsym_stars</span><span class="p">(</span><span class="n">qpoint</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_auto_qlabels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
                <span class="k">if</span> <span class="n">qpoint</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">qpoint</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># If the first or the last q-point are not recognized in findname_in_hsym_stars</span>
        <span class="c1"># matplotlib won&#39;t show the full band structure along the k-path</span>
        <span class="c1"># because the labels are not defined. Here we make sure that</span>
        <span class="c1"># the labels for the extrema of the path are always defined.</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_auto_qlabels</span><span class="p">:</span> <span class="n">_auto_qlabels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
        <span class="n">last</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">last</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_auto_qlabels</span><span class="p">:</span> <span class="n">_auto_qlabels</span><span class="p">[</span><span class="n">last</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

        <span class="k">return</span> <span class="n">_auto_qlabels</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">displ_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The shape of phdispl_cart.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">phdispl_cart</span><span class="o">.</span><span class="n">shape</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">minfreq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Minimum phonon frequency.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_minfreq_mode</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">maxfreq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maximum phonon frequency.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_maxfreq_mode</span><span class="p">()</span>

<div class="viewcode-block" id="PhononBands.get_minfreq_mode"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBands.get_minfreq_mode">[docs]</a>    <span class="k">def</span> <span class="nf">get_minfreq_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the minimum of the frequencies.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phfreqs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phfreqs</span><span class="p">[:,</span> <span class="n">mode</span><span class="p">])</span></div>

<div class="viewcode-block" id="PhononBands.get_maxfreq_mode"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBands.get_maxfreq_mode">[docs]</a>    <span class="k">def</span> <span class="nf">get_maxfreq_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the minimum of the frequencies.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phfreqs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phfreqs</span><span class="p">[:,</span> <span class="n">mode</span><span class="p">])</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Shape of the array with the eigenvalues.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_qpoints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_branches</span>

    <span class="nd">@lazy_property</span>
<div class="viewcode-block" id="PhononBands.dyn_mat_eigenvect"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBands.dyn_mat_eigenvect">[docs]</a>    <span class="k">def</span> <span class="nf">dyn_mat_eigenvect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Eigenvalues of the dynamical matrix.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">get_dyn_mat_eigenvec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phdispl_cart</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">amu</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">non_anal_directions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Cartesian directions along which the non analytical frequencies and displacements are available&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_anal_ph</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_anal_ph</span><span class="o">.</span><span class="n">directions</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">non_anal_phfreqs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Phonon frequencies with non analytical contribution in eV along non_anal_directions&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_anal_ph</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_anal_ph</span><span class="o">.</span><span class="n">phfreqs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">non_anal_phdispl_cart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Displacement in Cartesian coordinates with non analytical contribution along non_anal_directions&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_anal_ph</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_anal_ph</span><span class="o">.</span><span class="n">phdispl_cart</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">non_anal_dyn_mat_eigenvect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Eigenvalues of the dynamical matrix with non analytical contribution along non_anal_directions.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_anal_ph</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_anal_ph</span><span class="o">.</span><span class="n">dyn_mat_eigenvect</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="PhononBands.to_xmgrace"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBands.to_xmgrace">[docs]</a>    <span class="k">def</span> <span class="nf">to_xmgrace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;meV&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write xmgrace file with phonon band structure energies and labels for high-symmetry q-points.</span>

<span class="sd">        Args:</span>
<span class="sd">            filepath: Filename</span>
<span class="sd">            units: Units for phonon plots. Possible values in (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;). Case-insensitive.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">w</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">factor</span> <span class="o">=</span> <span class="n">_factor_ev2units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
        <span class="n">wqnu_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phfreqs</span> <span class="o">*</span> <span class="n">factor</span>

        <span class="kn">import</span> <span class="nn">datetime</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;# Grace project file with phonon band energies.&quot;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;# Generated by AbiPy on: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()))</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;# Crystalline structure:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="n">w</span><span class="p">(</span><span class="s2">&quot;# </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;# Energies are in </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">units</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;# List of q-points and their index (C notation i.e. count from 0)&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">iq</span><span class="p">,</span> <span class="n">qpt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">):</span>
            <span class="n">w</span><span class="p">(</span><span class="s2">&quot;# </span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iq</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">qpt</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">)))</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;@page size 792, 612&quot;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;@page scroll 5%&quot;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;@page inout 5%&quot;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;@link page off&quot;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;@with g0&quot;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s2">&quot;@world xmin 0.00&quot;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@world xmax </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_qpoints</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@world ymin </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">wqnu_units</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@world ymax </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">wqnu_units</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@default linewidth 1.5&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  tick on&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  tick major 1&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  tick major color 1&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  tick major linestyle 3&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  tick major grid on&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  tick spec type both&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  tick major 0, 0&#39;</span><span class="p">)</span>

        <span class="n">qticks</span><span class="p">,</span> <span class="n">qlabels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_ticks_and_labels</span><span class="p">(</span><span class="n">qlabels</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  tick spec </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">qticks</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">iq</span><span class="p">,</span> <span class="p">(</span><span class="n">qtick</span><span class="p">,</span> <span class="n">qlabel</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">qticks</span><span class="p">,</span> <span class="n">qlabels</span><span class="p">)):</span>
            <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  tick major </span><span class="si">%d</span><span class="s1">, </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iq</span><span class="p">,</span> <span class="n">qtick</span><span class="p">))</span>
            <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  ticklabel </span><span class="si">%d</span><span class="s1">, &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iq</span><span class="p">,</span> <span class="n">qlabel</span><span class="p">))</span>

        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@xaxis  ticklabel char size 1.500000&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@yaxis  tick major 10&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@yaxis  label &quot;Phonon </span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">_unit_tag</span><span class="p">(</span><span class="n">units</span><span class="p">))</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@yaxis  label char size 1.500000&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@yaxis  ticklabel char size 1.500000&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nu</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">:</span>
            <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@    s</span><span class="si">%d</span><span class="s1"> line color </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># TODO: LO-TO splitting</span>
        <span class="k">for</span> <span class="n">nu</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">:</span>
            <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@target G0.S</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">nu</span><span class="p">)</span>
            <span class="n">w</span><span class="p">(</span><span class="s1">&#39;@type xy&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_qpoints</span><span class="p">):</span>
                <span class="n">w</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> </span><span class="si">%.8E</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iq</span><span class="p">,</span> <span class="n">wqnu_units</span><span class="p">[</span><span class="n">iq</span><span class="p">,</span> <span class="n">nu</span><span class="p">]))</span>
            <span class="n">w</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="c1">#def to_bxsf(self, filepath):</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    Export the full band structure to `filepath` in BXSF format</span>
    <span class="c1">#    suitable for the visualization of isosurfaces with Xcrysden (xcrysden --bxsf FILE).</span>
    <span class="c1">#    Require q-points in IBZ and gamma-centered q-mesh.</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    self.get_phbands3d().to_bxsf(filepath)</span>

    <span class="c1">#def get_phbands3d(self):</span>
    <span class="c1">#    has_timrev, fermie = True, 0.0</span>
    <span class="c1">#    return PhononBands3D(self.structure, self.qpoints, has_timrev, self.phfreqs, fermie)</span>

<div class="viewcode-block" id="PhononBands.qindex"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBands.qindex">[docs]</a>    <span class="k">def</span> <span class="nf">qindex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qpoint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Returns the index of the qpoint. Accepts integer or reduced coordinates.</span>
<span class="sd">	&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">duck</span><span class="o">.</span><span class="n">is_intlike</span><span class="p">(</span><span class="n">qpoint</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">qpoint</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">qpoint</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhononBands.qindex_qpoint"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBands.qindex_qpoint">[docs]</a>    <span class="k">def</span> <span class="nf">qindex_qpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qpoint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns (qindex, qpoint) from an integer or a qpoint.&quot;&quot;&quot;</span>
        <span class="n">qindex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qindex</span><span class="p">(</span><span class="n">qpoint</span><span class="p">)</span>
        <span class="n">qpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">(</span><span class="n">qindex</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">qindex</span><span class="p">,</span> <span class="n">qpoint</span></div>

<div class="viewcode-block" id="PhononBands.get_unstable_modes"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBands.get_unstable_modes">[docs]</a>    <span class="k">def</span> <span class="nf">get_unstable_modes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">below_mev</span><span class="o">=-</span><span class="mf">5.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list of :class:`PhononMode` objects with the unstable modes.</span>
<span class="sd">        A mode is unstable if its frequency is &lt; below_mev. Output list is sorted</span>
<span class="sd">        and modes with lowest frequency come first.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">umodes</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">iq</span><span class="p">,</span> <span class="n">qpoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">nu</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">:</span>
                <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phfreqs</span><span class="p">[</span><span class="n">iq</span><span class="p">,</span> <span class="n">nu</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="n">below_mev</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">:</span>
                    <span class="n">displ_cart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phdispl_cart</span><span class="p">[</span><span class="n">iq</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="n">umodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PhononMode</span><span class="p">(</span><span class="n">qpoint</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">displ_cart</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">))</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">umodes</span><span class="p">)</span></div>

    <span class="c1"># TODO</span>
    <span class="c1">#def find_irreps(self, qpoint, tolerance):</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    Find the irreducible representation at this q-point</span>
    <span class="c1">#    Raise: QIrrepsError if algorithm fails</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    qindex, qpoint = self.qindex_qpoint(qpoint)</span>

<div class="viewcode-block" id="PhononBands.get_dict4frame"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBands.get_dict4frame">[docs]</a>    <span class="k">def</span> <span class="nf">get_dict4frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_spglib</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a :class:`OrderedDict` with the most important parameters:</span>

<span class="sd">            - Chemical formula and number of atoms.</span>
<span class="sd">            - Lattice lengths, angles and volume.</span>
<span class="sd">            - The spacegroup number computed by Abinit (set to None if not available).</span>
<span class="sd">            - The spacegroup number and symbol computed by spglib (set to None not `with_spglib`).</span>

<span class="sd">        Useful to construct pandas DataFrames</span>

<span class="sd">        Args:</span>
<span class="sd">            with_spglib: If True, spglib is invoked to get the spacegroup symbol and number</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">odict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([</span>
            <span class="p">(</span><span class="s2">&quot;nqpt&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_qpoints</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;nmodes&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_branches</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;min_freq&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minfreq</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;max_freq&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxfreq</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;mean_freq&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phfreqs</span><span class="o">.</span><span class="n">mean</span><span class="p">()),</span> <span class="p">(</span><span class="s2">&quot;std_freq&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phfreqs</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>

        <span class="p">])</span>
        <span class="n">odict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">get_dict4frame</span><span class="p">(</span><span class="n">with_spglib</span><span class="o">=</span><span class="n">with_spglib</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">odict</span></div>

<div class="viewcode-block" id="PhononBands.get_phdos"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBands.get_phdos">[docs]</a>    <span class="k">def</span> <span class="nf">get_phdos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">1.e-4</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">4.e-4</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the phonon DOS on a linear mesh.</span>

<span class="sd">        Args:</span>
<span class="sd">            method: String defining the method</span>
<span class="sd">            step: Energy step (eV) of the linear mesh.</span>
<span class="sd">            width: Standard deviation (eV) of the gaussian.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`PhononDos` object.</span>

<span class="sd">        .. warning::</span>

<span class="sd">            Requires a homogeneous sampling of the Brillouin zone.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="o">.</span><span class="n">sum_weights</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.e-6</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Qpoint weights should sum up to one&quot;</span><span class="p">)</span>

        <span class="c1"># Compute the linear mesh for the DOS</span>
        <span class="n">w_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minfreq</span>
        <span class="n">w_min</span> <span class="o">-=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">w_min</span><span class="p">)</span>
        <span class="n">w_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxfreq</span>
        <span class="n">w_max</span> <span class="o">+=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">w_max</span><span class="p">)</span>
        <span class="n">nw</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">w_max</span> <span class="o">-</span> <span class="n">w_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">step</span>

        <span class="n">mesh</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">w_min</span><span class="p">,</span> <span class="n">w_max</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">nw</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">retstep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nw</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">qpoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">):</span>
                <span class="n">weight</span> <span class="o">=</span> <span class="n">qpoint</span><span class="o">.</span><span class="n">weight</span>
                <span class="k">for</span> <span class="n">nu</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">:</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phfreqs</span><span class="p">[</span><span class="n">q</span><span class="p">,</span> <span class="n">nu</span><span class="p">]</span>
                    <span class="n">values</span> <span class="o">+=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">gaussian</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Method </span><span class="si">%s</span><span class="s2"> is not supported&quot;</span> <span class="o">%</span> <span class="n">method</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">PhononDos</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhononBands.create_xyz_vib"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBands.create_xyz_vib">[docs]</a>    <span class="k">def</span> <span class="nf">create_xyz_vib</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iqpt</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">pre_factor</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">do_real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale_matrix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_supercell</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create vibration XYZ file for visualization of phonons.</span>

<span class="sd">        Args:</span>
<span class="sd">            iqpt: index of qpoint in self</span>
<span class="sd">            filename: name of the XYZ file that will be created</span>
<span class="sd">            pre_factor: Multiplication factor of the eigendisplacements</span>
<span class="sd">            do_real: True if we want only real part of the displacement, False means imaginary part</span>
<span class="sd">            scale_matrix: Scaling matrix of the supercell</span>
<span class="sd">            max_supercell: Maximum size of the supercell with respect to primitive cell</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">scale_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">max_supercell</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If scale_matrix is not provided, please provide max_supercell !&quot;</span><span class="p">)</span>

            <span class="n">scale_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">get_smallest_supercell</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">[</span><span class="n">iqpt</span><span class="p">]</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">,</span> <span class="n">max_supercell</span><span class="o">=</span><span class="n">max_supercell</span><span class="p">)</span>

        <span class="n">natoms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">scale_matrix</span><span class="p">)))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">xyz_file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">imode</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_branches</span><span class="p">):</span>
                <span class="n">xyz_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">natoms</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">xyz_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Mode &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">imode</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phfreqs</span><span class="p">[</span><span class="n">iqpt</span><span class="p">,</span> <span class="n">imode</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">write_vib_file</span><span class="p">(</span>
                    <span class="n">xyz_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">[</span><span class="n">iqpt</span><span class="p">]</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">,</span> <span class="n">pre_factor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phdispl_cart</span><span class="p">[</span><span class="n">iqpt</span><span class="p">,</span> <span class="n">imode</span><span class="p">,:],(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span>
                    <span class="n">do_real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">frac_coords</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_supercell</span><span class="o">=</span><span class="n">max_supercell</span><span class="p">,</span> <span class="n">scale_matrix</span><span class="o">=</span><span class="n">scale_matrix</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhononBands.create_ascii_vib"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBands.create_ascii_vib">[docs]</a>    <span class="k">def</span> <span class="nf">create_ascii_vib</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iqpts</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">pre_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create vibration ascii file for visualization of phonons.</span>
<span class="sd">        This format can be read with V_sim or ascii-phonons.</span>

<span class="sd">        Args:</span>
<span class="sd">            iqpts: an index or a list of indices of the qpoints in self. Note that at present only V_sim supports</span>
<span class="sd">                an ascii file with multiple qpoints.</span>
<span class="sd">            filename: name of the ascii file that will be created.</span>
<span class="sd">            pre_factor: Multiplication factor of the eigendisplacements.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iqpts</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">iqpts</span> <span class="o">=</span> <span class="p">[</span><span class="n">iqpts</span><span class="p">]</span>

        <span class="n">structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">abc</span>
        <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">a</span><span class="o">/</span><span class="mi">180</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">structure</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">angles</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">matrix</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

        <span class="n">dxx</span> <span class="o">=</span> <span class="n">a</span>
        <span class="n">dyx</span> <span class="o">=</span> <span class="n">b</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
        <span class="n">dyy</span> <span class="o">=</span> <span class="n">b</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
        <span class="n">dzx</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
        <span class="n">dzy</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beta</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
        <span class="c1"># keep the same orientation</span>
        <span class="n">dzz</span> <span class="o">=</span> <span class="n">sign</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">dzx</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">dzy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;# ascii file generated with abipy&quot;</span><span class="p">]</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">{: 3.10f}</span><span class="s2">  </span><span class="si">{: 3.10f}</span><span class="s2">  </span><span class="si">{: 3.10f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dxx</span><span class="p">,</span> <span class="n">dyx</span><span class="p">,</span> <span class="n">dyy</span><span class="p">))</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">{: 3.10f}</span><span class="s2">  </span><span class="si">{: 3.10f}</span><span class="s2">  </span><span class="si">{: 3.10f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dzx</span><span class="p">,</span> <span class="n">dzy</span><span class="p">,</span> <span class="n">dzz</span><span class="p">))</span>

        <span class="c1"># use reduced coordinates</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#keyword: reduced&quot;</span><span class="p">)</span>

        <span class="c1"># coordinates</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">structure</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">{: 3.10f}</span><span class="s2">  </span><span class="si">{: 3.10f}</span><span class="s2">  </span><span class="si">{: 3.10f}</span><span class="s2"> </span><span class="si">{:&gt;2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">specie</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="n">ascii_basis</span> <span class="o">=</span> <span class="p">[[</span><span class="n">dxx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                       <span class="p">[</span><span class="n">dyx</span><span class="p">,</span> <span class="n">dyy</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                       <span class="p">[</span><span class="n">dzx</span><span class="p">,</span> <span class="n">dzy</span><span class="p">,</span> <span class="n">dzz</span><span class="p">]]</span>

        <span class="k">for</span> <span class="n">iqpt</span> <span class="ow">in</span> <span class="n">iqpts</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">[</span><span class="n">iqpt</span><span class="p">]</span><span class="o">.</span><span class="n">frac_coords</span>

            <span class="n">displ_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_branches</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_atoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_atoms</span><span class="p">):</span>
                <span class="n">displ_list</span><span class="p">[:,</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phdispl_cart</span><span class="p">[</span><span class="n">iqpt</span><span class="p">,:,</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">*</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">structure</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">[</span><span class="n">iqpt</span><span class="p">]</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">))</span>

            <span class="n">displ_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">displ_list</span><span class="p">,</span> <span class="n">structure</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">inv_matrix</span><span class="p">),</span> <span class="n">ascii_basis</span><span class="p">)</span> <span class="o">*</span> <span class="n">pre_factor</span>

            <span class="k">for</span> <span class="n">imode</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_branches</span><span class="p">):</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#metaData: qpt=[</span><span class="si">{:.6f}</span><span class="s2">;</span><span class="si">{:.6f}</span><span class="s2">;</span><span class="si">{:.6f}</span><span class="s2">;</span><span class="si">{:.6f}</span><span class="s2"> </span><span class="se">\\</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">phfreqs</span><span class="p">[</span><span class="n">iqpt</span><span class="p">,</span> <span class="n">imode</span><span class="p">]))</span>

                <span class="k">for</span> <span class="n">displ</span> <span class="ow">in</span> <span class="n">displ_list</span><span class="p">[</span><span class="n">imode</span><span class="p">]:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;#; &quot;</span><span class="o">+</span> <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.6f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">displ</span><span class="o">.</span><span class="n">real</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;; &quot;</span> \
                           <span class="o">+</span> <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.6f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">displ</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;# ]&quot;</span><span class="p">))</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></div>

<div class="viewcode-block" id="PhononBands.create_phononwebsite_json"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBands.create_phononwebsite_json">[docs]</a>    <span class="k">def</span> <span class="nf">create_phononwebsite_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">repetitions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">highsym_qpts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">match_bands</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                  <span class="n">highsym_qpts_mode</span><span class="o">=</span><span class="s2">&quot;split&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes a json file that can be parsed from phononwebsite https://github.com/henriquemiranda/phononwebsite</span>

<span class="sd">        Args:</span>
<span class="sd">            filename: name of the json file that will be created</span>
<span class="sd">            name: name associated with the data.</span>
<span class="sd">            repetitions: number of repetitions of the cell. List of three integers. Defaults to [3,3,3].</span>
<span class="sd">            highsym_qpts: list of tuples. The first element of each tuple should be a list with the coordinates</span>
<span class="sd">                of a high symmetry point, the second element of the tuple should be its label.</span>
<span class="sd">            match_bands: if True tries to follow the band along the path based on the scalar product of the eigenvectors.</span>
<span class="sd">            highsym_qpts_mode: if highsym_qpts is None high symmetry q-points can be automatically determined.</span>
<span class="sd">                Accepts the following values:</span>
<span class="sd">                    &#39;split&#39; will split the path based on points where the path changes direction in the Brillouin zone.</span>
<span class="sd">                        Similar to the what is done in phononwebsite. Only Gamma will be labeled.</span>
<span class="sd">                    &#39;std&#39; uses the standard generation procedure for points and labels used in PhononBands.</span>
<span class="sd">                    None does not set any point.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">split_non_collinear</span><span class="p">(</span><span class="n">qpts</span><span class="p">):</span>
            <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            function that splits the list of qpoints at repetitions (only the first point will be considered as</span>
<span class="sd">            high symm) and where the direction changes. Also sets $\Gamma$ for [0,0,0].</span>
<span class="sd">            Similar to what is done in phononwebsite.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">h</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">qpts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]):</span>
                <span class="n">h</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">Gamma&quot;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">qpts</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">qpts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">h</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">Gamma&quot;</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">qpts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">qpts</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">h</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">v1</span> <span class="o">=</span> <span class="p">[</span><span class="n">a_i</span> <span class="o">-</span> <span class="n">b_i</span> <span class="k">for</span> <span class="n">a_i</span><span class="p">,</span> <span class="n">b_i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">qpts</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">qpts</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>
                    <span class="n">v2</span> <span class="o">=</span> <span class="p">[</span><span class="n">a_i</span> <span class="o">-</span> <span class="n">b_i</span> <span class="k">for</span> <span class="n">a_i</span><span class="p">,</span> <span class="n">b_i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">qpts</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">qpts</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">([</span><span class="n">v1</span><span class="p">,</span><span class="n">v2</span><span class="p">,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]]),</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="n">h</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">qpts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]):</span>
                <span class="n">h</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">qpts</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">Gamma&quot;</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">h</span>

        <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">reduced_formula</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;natoms&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_atoms</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;lattice&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;atom_types&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">species</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;atom_numbers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">atomic_numbers</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;chemical_symbols&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">symbol_set</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;atomic_numbers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">atomic_numbers</span><span class="p">))</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;formula&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">formula</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;repetitions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repetitions</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;atom_pos_car&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">cart_coords</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;atom_pos_red&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">frac_coords</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">qpoints</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">q_sublist</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_qpoints</span><span class="p">:</span>
            <span class="n">qpoints</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">q_sublist</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">highsym_qpts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">highsym_qpts_mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;highsym_qpts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">elif</span> <span class="n">highsym_qpts_mode</span> <span class="o">==</span> <span class="s1">&#39;split&#39;</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;highsym_qpts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">split_non_collinear</span><span class="p">(</span><span class="n">qpoints</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">highsym_qpts_mode</span> <span class="o">==</span> <span class="s1">&#39;std&#39;</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;highsym_qpts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_make_ticks_and_labels</span><span class="p">(</span><span class="kc">None</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;highsym_qpts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">highsym_qpts</span>

        <span class="n">distances</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">qpoints</span><span class="p">)):</span>
            <span class="n">q_coord_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="o">.</span><span class="n">get_cartesian_coords</span><span class="p">(</span><span class="n">qpoints</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">q_coord_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="o">.</span><span class="n">get_cartesian_coords</span><span class="p">(</span><span class="n">qpoints</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">distances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">distances</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">q_coord_1</span><span class="o">-</span><span class="n">q_coord_2</span><span class="p">))</span>

        <span class="n">eigenvalues</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">phfreqs_sublist</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">split_phfreqs</span><span class="p">):</span>
            <span class="n">phfreqs_sublist</span> <span class="o">=</span> <span class="n">phfreqs_sublist</span> <span class="o">*</span> <span class="n">eV_to_Ha</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Ha_cmm1</span>
            <span class="k">if</span> <span class="n">match_bands</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_matched_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">phfreqs_sublist</span> <span class="o">=</span> <span class="n">phfreqs_sublist</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">phfreqs_sublist</span><span class="p">))[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">ind</span><span class="p">]</span>
            <span class="n">eigenvalues</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">phfreqs_sublist</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="n">vectors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">qpts</span><span class="p">,</span> <span class="n">phdispl_sublist</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">split_qpoints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_phdispl_cart</span><span class="p">)):</span>
            <span class="c1"># the eigenvectors are needed (the mass factor is removed)</span>
            <span class="n">vect</span> <span class="o">=</span> <span class="n">get_dyn_mat_eigenvec</span><span class="p">(</span><span class="n">phdispl_sublist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">amu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">amu</span><span class="p">)</span>
            <span class="c1"># since phononwebsite will multiply again by exp(2*pi*q.r) this factor should be removed,</span>
            <span class="c1"># because in abinit convention it is included in the eigenvectors.</span>
            <span class="k">for</span> <span class="n">iqpt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qpts</span><span class="p">)):</span>
                <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">[</span><span class="n">iqpt</span><span class="p">]</span><span class="o">.</span><span class="n">frac_coords</span>
                <span class="k">for</span> <span class="n">ai</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_atoms</span><span class="p">):</span>
                    <span class="n">vect</span><span class="p">[</span><span class="n">iqpt</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">3</span><span class="o">*</span><span class="n">ai</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">ai</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">vect</span><span class="p">[</span><span class="n">iqpt</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">3</span><span class="o">*</span><span class="n">ai</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">ai</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">*</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">[</span><span class="n">ai</span><span class="p">]</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">,</span> <span class="n">q</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">match_bands</span><span class="p">:</span>
                <span class="n">vect</span> <span class="o">=</span> <span class="n">vect</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">vect</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">split_matched_indices</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">vect</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,:]]</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">vect</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">vect</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_branches</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">num_atoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">imag</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">vectors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;qpoints&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qpoints</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;distances&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distances</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;eigenvalues&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eigenvalues</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;vectors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vectors</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">json_file</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhononBands.decorate_ax"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBands.decorate_ax">[docs]</a>    <span class="k">def</span> <span class="nf">decorate_ax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;eV&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Handle conversion factor.</span>
        <span class="c1"># TODO: Encapsulate this part.</span>
        <span class="n">units</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;ev&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Energy [eV]&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;mev&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Energy [meV]&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;ha&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Energy [Ha]&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">units</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;cm-1&#39;</span><span class="p">,</span> <span class="s1">&#39;cm^-1&#39;</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Frequency [cm$^{-1}$]&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;thz&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Frequency [Thz]&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Value for units `</span><span class="si">{}</span><span class="s1">` unknown&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">units</span><span class="p">))</span>

        <span class="c1"># Set ticks and labels.</span>
        <span class="n">ticks</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_ticks_and_labels</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;qlabels&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ticks</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="PhononBands.plot"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBands.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="n">qlabels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">branch_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">match_bands</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the phonon band structure.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>
<span class="sd">            units: Units for phonon plots. Possible values in (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;). Case-insensitive.</span>
<span class="sd">            qlabels: dictionary whose keys are tuples with the reduced coordinates of the q-points.</span>
<span class="sd">                The values are the labels. e.g. qlabels = {(0.0,0.0,0.0): &quot;$\Gamma$&quot;, (0.5,0,0): &quot;L&quot;}.</span>
<span class="sd">            branch_range: Tuple specifying the minimum and maximum branch index to plot (default: all branches are plotted).</span>
<span class="sd">            match_bands: if True the bands will be matched based on the scalar product between the eigenvectors.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Select the band range.</span>
        <span class="k">if</span> <span class="n">branch_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">branch_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_branches</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">branch_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">branch_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">branch_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

        <span class="c1"># Decorate the axis (e.g add ticks and labels).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decorate_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">qlabels</span><span class="o">=</span><span class="n">qlabels</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;color&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">match_bands</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;linewidth&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;linewidth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.0</span>

        <span class="c1"># Plot the phonon branches.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">branch_range</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">match_bands</span><span class="o">=</span><span class="n">match_bands</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="PhononBands.plot_ax"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBands.plot_ax">[docs]</a>    <span class="k">def</span> <span class="nf">plot_ax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;eV&#39;</span><span class="p">,</span> <span class="n">match_bands</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the frequencies for the given branches indices as a function of the q index on axis ax.</span>
<span class="sd">        If branch is None, all phonon branches are plotted.</span>

<span class="sd">        Return:</span>
<span class="sd">            The list of &#39;matplotlib&#39; lines added.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">branch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">branch_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_branches</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="n">branch_range</span> <span class="o">=</span> <span class="n">branch</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">branch_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">branch</span><span class="p">]</span>

        <span class="n">first_xx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">factor</span> <span class="o">=</span> <span class="n">_factor_ev2units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">split_phfreqs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">match_bands</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_matched_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">pf</span> <span class="o">=</span> <span class="n">pf</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pf</span><span class="p">))[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">ind</span><span class="p">]</span>
            <span class="n">pf</span> <span class="o">=</span> <span class="n">pf</span> <span class="o">*</span> <span class="n">factor</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">first_xx</span><span class="p">,</span> <span class="n">first_xx</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">pf</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">branch_range</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">pf</span><span class="p">[:,</span> <span class="n">branch</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
            <span class="n">first_xx</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">lines</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="PhononBands.plot_colored_matched"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBands.plot_colored_matched">[docs]</a>    <span class="k">def</span> <span class="nf">plot_colored_matched</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="n">qlabels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">branch_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;rainbow&quot;</span><span class="p">,</span> <span class="n">max_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the phonon band structure with different color for each line.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>
<span class="sd">            units: Units for phonon plots. Possible values in (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;). Case-insensitive.</span>
<span class="sd">            qlabels: dictionary whose keys are tuples with the reduced coordinates of the q-points.</span>
<span class="sd">                The values are the labels. e.g. qlabels = {(0.0,0.0,0.0): &quot;$\Gamma$&quot;, (0.5,0,0): &quot;L&quot;}</span>
<span class="sd">            branch_range: Tuple specifying the minimum and maximum branch_i index to plot (default: all branches are plotted).</span>
<span class="sd">            colormap: matplotlib colormap to determine the colors available. The colors will be chosen not in a</span>
<span class="sd">                sequential order to avoid difficulties in distinguishing the lines.</span>
<span class="sd">                http://matplotlib.sourceforge.net/examples/pylab_examples/show_colormaps.html</span>
<span class="sd">            max_colors: maximum number of colors to be used. If max_colors &lt; num_braches the colors will be reapeated.</span>
<span class="sd">                It useful to better distinguish close bands when the number of branch is large.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Select the band range.</span>
        <span class="k">if</span> <span class="n">branch_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">branch_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_branches</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">branch_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">branch_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">branch_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

        <span class="c1"># Decorate the axis (e.g add ticks and labels).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decorate_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">qlabels</span><span class="o">=</span><span class="n">qlabels</span><span class="p">)</span>

        <span class="n">first_xx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">_factor_ev2units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">max_colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">max_colors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">branch_range</span><span class="p">)</span>

        <span class="n">colormap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">split_phfreqs</span><span class="p">):</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_matched_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">pf</span> <span class="o">=</span> <span class="n">pf</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pf</span><span class="p">))[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">ind</span><span class="p">]</span>
            <span class="n">pf</span> <span class="o">=</span> <span class="n">pf</span> <span class="o">*</span> <span class="n">factor</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">first_xx</span><span class="p">,</span> <span class="n">first_xx</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">pf</span><span class="p">))</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span><span class="n">colormap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_colors</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">branch_i</span> <span class="ow">in</span> <span class="n">branch_range</span><span class="p">:</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">pf</span><span class="p">[:,</span> <span class="n">branch_i</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
            <span class="n">first_xx</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">split_qpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_qpoints</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_split_intervals</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_qpoints</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">split_phfreqs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_phfreqs</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_split_intervals</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_phfreqs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">split_phdispl_cart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># prepare the splitted phdispl_cart as a separate internal variable only when explicitely requested and</span>
        <span class="c1"># not at the same time as split_qpoints and split_phfreqs as it requires a larger array and not used</span>
        <span class="c1"># most of the times.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_phdispl_cart</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">split_phfreqs</span>
            <span class="n">split_phdispl_cart</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phdispl_cart</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_split_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="bp">self</span><span class="o">.</span><span class="n">_split_indices</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                                  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_split_indices</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_anal_ph</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">split_qpoints</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_anal_ph</span><span class="o">.</span><span class="n">has_direction</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                            <span class="n">split_phdispl_cart</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_non_anal_phdispl</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_anal_ph</span><span class="o">.</span><span class="n">has_direction</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]):</span>
                            <span class="n">split_phdispl_cart</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_non_anal_phdispl</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_split_phdispl_cart</span> <span class="o">=</span> <span class="n">split_phdispl_cart</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_phdispl_cart</span>

    <span class="k">def</span> <span class="nf">_set_split_intervals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Calculations available for LO-TO splitting</span>
        <span class="c1"># Split the lines at each Gamma to handle possible discontinuities</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_anal_phfreqs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_anal_directions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">end_points_indices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">end_points_indices</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_qpoints</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])])</span>
            <span class="n">end_points_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_qpoints</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># split the list of qpoints and frequencies at each end point. The end points are in both the segments.</span>
            <span class="c1"># Lists since the array contained have different shapes</span>
            <span class="n">split_qpoints</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">[</span><span class="n">end_points_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">end_points_indices</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">end_points_indices</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="n">split_phfreqs</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phfreqs</span><span class="p">[</span><span class="n">end_points_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">end_points_indices</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">end_points_indices</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">split_qpoints</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
                    <span class="n">split_phfreqs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_non_anal_freqs</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
                    <span class="n">split_phfreqs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_non_anal_freqs</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">split_qpoints</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">]</span>
            <span class="n">split_phfreqs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">phfreqs</span><span class="p">]</span>
            <span class="n">end_points_indices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_qpoints</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_split_qpoints</span> <span class="o">=</span> <span class="n">split_qpoints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_split_phfreqs</span> <span class="o">=</span> <span class="n">split_phfreqs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_split_indices</span> <span class="o">=</span> <span class="n">end_points_indices</span>
        <span class="k">return</span> <span class="n">split_phfreqs</span><span class="p">,</span> <span class="n">split_qpoints</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">split_matched_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A list of numpy arrays containing the indices in which each band should be sorted in order to match the</span>
<span class="sd">        scalar product of the eigenvectors. The shape is the same as that of split_phfreqs.</span>
<span class="sd">        Lazy property.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_matched_indices</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>

            <span class="n">split_matched_indices</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">last_eigenvectors</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># simpler method based just on the matching with the previous point</span>
            <span class="c1">#TODO remove after verifying the other method currently in use</span>
            <span class="c1"># for i, displ in enumerate(self.split_phdispl_cart):</span>
            <span class="c1">#     eigenvectors = get_dyn_mat_eigenvec(displ, self.structure, self.amu)</span>
            <span class="c1">#     ind_block = np.zeros((len(displ), self.num_branches), dtype=np.int)</span>
            <span class="c1">#     # if it&#39;s not the first block, match with the last of the previous block. Should give a match in case</span>
            <span class="c1">#     # of LO-TO splitting</span>
            <span class="c1">#     if i == 0:</span>
            <span class="c1">#         ind_block[0] = range(self.num_branches)</span>
            <span class="c1">#     else:</span>
            <span class="c1">#         match = match_eigenvectors(last_eigenvectors, eigenvectors[0])</span>
            <span class="c1">#         ind_block[0] = [match[m] for m in split_matched_indices[-1][-1]]</span>
            <span class="c1">#     for j in range(1, len(displ)):</span>
            <span class="c1">#         match = match_eigenvectors(eigenvectors[j-1], eigenvectors[j])</span>
            <span class="c1">#         ind_block[j] = [match[m] for m in ind_block[j-1]]</span>
            <span class="c1">#</span>
            <span class="c1">#     split_matched_indices.append(ind_block)</span>
            <span class="c1">#     last_eigenvectors = eigenvectors[-1]</span>

            <span class="c1"># The match is applied between subsequent qpoints, except that right after a high symmetry point.</span>
            <span class="c1"># In that case the first point after the high symmetry point will be matched with the one immediately</span>
            <span class="c1"># before. This should avoid exchange of lines due to degeneracies.</span>
            <span class="c1"># The code will assume that there is a high symmetry point if the points are not collinear (change in the</span>
            <span class="c1"># direction in the path).</span>
            <span class="k">def</span> <span class="nf">collinear</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
                <span class="n">v1</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
                <span class="n">v2</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
                <span class="n">d</span> <span class="o">=</span> <span class="p">[</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">displ</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">split_phdispl_cart</span><span class="p">):</span>
                <span class="n">eigenvectors</span> <span class="o">=</span> <span class="n">get_dyn_mat_eigenvec</span><span class="p">(</span><span class="n">displ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">amu</span><span class="p">)</span>
                <span class="n">ind_block</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">displ</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_branches</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
                <span class="c1"># if it&#39;s not the first block, match the first two points with the last of the previous block.</span>
                <span class="c1"># Should give a match in case of LO-TO splitting</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ind_block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_branches</span><span class="p">)</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="n">match_eigenvectors</span><span class="p">(</span><span class="n">eigenvectors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">eigenvectors</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">ind_block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">match</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">ind_block</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="n">match_eigenvectors</span><span class="p">(</span><span class="n">last_eigenvectors</span><span class="p">,</span> <span class="n">eigenvectors</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">ind_block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">match</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">split_matched_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]]</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="n">match_eigenvectors</span><span class="p">(</span><span class="n">last_eigenvectors</span><span class="p">,</span> <span class="n">eigenvectors</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">ind_block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">match</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">split_matched_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">displ</span><span class="p">)):</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">collinear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">split_qpoints</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_qpoints</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_qpoints</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]):</span>
                        <span class="n">k</span> <span class="o">=</span> <span class="n">j</span><span class="o">-</span><span class="mi">2</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="n">match_eigenvectors</span><span class="p">(</span><span class="n">eigenvectors</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">eigenvectors</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                    <span class="n">ind_block</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">match</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">ind_block</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>

                <span class="n">split_matched_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ind_block</span><span class="p">)</span>
                <span class="n">last_eigenvectors</span> <span class="o">=</span> <span class="n">eigenvectors</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_split_matched_indices</span> <span class="o">=</span> <span class="n">split_matched_indices</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_matched_indices</span>

    <span class="k">def</span> <span class="nf">_get_non_anal_freqs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
        <span class="c1"># directions for the qph2l in anaddb are given in cartesian coordinates</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">reciprocal_lattice_crystallographic</span><span class="o">.</span><span class="n">get_cartesian_coords</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">non_anal_directions</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">d</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_anal_phfreqs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Non analytical contribution has not been calcolated for direction </span><span class="si">{0}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">direction</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_get_non_anal_phdispl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
        <span class="c1"># directions for the qph2l in anaddb are given in cartesian coordinates</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">reciprocal_lattice_crystallographic</span><span class="o">.</span><span class="n">get_cartesian_coords</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">non_anal_directions</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">d</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_anal_phdispl_cart</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Non analytical contribution has not been calcolated for direction </span><span class="si">{0}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">direction</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_make_ticks_and_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qlabels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return ticks and labels from the mapping {qred: qstring} given in qlabels.&quot;&quot;&quot;</span>
        <span class="c1">#TODO should be modified in order to handle the &quot;split&quot; list of qpoints</span>
        <span class="k">if</span> <span class="n">qlabels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">qcoord</span><span class="p">,</span> <span class="n">qname</span> <span class="ow">in</span> <span class="n">qlabels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Build Kpoint instancee</span>
                <span class="n">qtick</span> <span class="o">=</span> <span class="n">Kpoint</span><span class="p">(</span><span class="n">qcoord</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">qpoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">qtick</span> <span class="o">==</span> <span class="n">qpoint</span><span class="p">:</span>
                        <span class="n">d</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">qname</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_qlabels</span>

        <span class="c1"># Return ticks, labels</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="PhononBands.plot_fatbands"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBands.plot_fatbands">[docs]</a>    <span class="k">def</span> <span class="nf">plot_fatbands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">,</span> <span class="n">phdos_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">max_stripe_width_mev</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                      <span class="n">qlabels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                      <span class="c1">#cart_dir=None</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot phonon fatbands and, optionally, atom-projected DOS.</span>

<span class="sd">        Args:</span>
<span class="sd">            units: Units for phonon plots. Possible values in (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;). Case-insensitive.</span>
<span class="sd">            colormap: Have a look at the colormaps here and decide which one you like:</span>
<span class="sd">                http://matplotlib.sourceforge.net/examples/pylab_examples/show_colormaps.html</span>
<span class="sd">            phdos_file: Used to activate fatbands + PJDOS plot.</span>
<span class="sd">                Accept string with path of PHDOS.nc file or :class:`PhdosFile` object.</span>
<span class="sd">            alpha: The alpha blending value, between 0 (transparent) and 1 (opaque)</span>
<span class="sd">            max_stripe_width_mev: The maximum width of the stripe in meV. Will be rescaled according to `units`.</span>
<span class="sd">            width_ratios: Ratios between the width of the fatbands plots and the DOS plots.</span>
<span class="sd">                Used if `phdos_file` is not None</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used</span>
<span class="sd">            qlabels: dictionary whose keys are tuples with the reduced coordinates of the q-points.</span>
<span class="sd">                The values are the labels. e.g. qlabels = {(0.0,0.0,0.0): &quot;$\Gamma$&quot;, (0.5,0,0): &quot;L&quot;}.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lw</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;lw&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">_factor_ev2units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
        <span class="n">ntypat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">ntypesp</span>

        <span class="c1"># Prepare PJDOS.</span>
        <span class="n">close_phdos_file</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">phdos_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_string</span><span class="p">(</span><span class="n">phdos_file</span><span class="p">):</span>
                <span class="n">phdos_file</span> <span class="o">=</span> <span class="n">PhdosFile</span><span class="p">(</span><span class="n">phdos_file</span><span class="p">)</span>
                <span class="n">close_phdos_file</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phdos_file</span><span class="p">,</span> <span class="n">PhdosFile</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expecting string or PhdosFile, got </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">phdos_file</span><span class="p">))</span>

        <span class="c1"># Grid with [ntypat] plots if fatbands only or [ntypat, 2] if fatbands + PJDOS</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="k">import</span> <span class="n">GridSpec</span> <span class="c1">#, GridSpecFromSubplotSpec</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="p">(</span><span class="n">ntypat</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">phdos_file</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="n">ntypat</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">gspec</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="n">width_ratios</span> <span class="k">if</span> <span class="n">ncols</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>
        <span class="n">qq</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_qpoints</span><span class="p">))</span>

        <span class="c1"># phonon_displacements are in cartesian coordinates and stored in an array with shape</span>
        <span class="c1"># (nqpt, 3*natom, 3*natom) where the last dimension stores the cartesian components.</span>
        <span class="c1"># Precompute normalization factor:</span>
        <span class="c1">#   d2[q, nu] = \sum_{i=0}^{3*Nat-1) |d^{q\nu}_i|**2</span>

        <span class="c1"># FIXME there&#39;s a bug in anaddb since we should orthogonalize</span>
        <span class="c1"># wrt the phonon displacement as done (correctly) here</span>
        <span class="n">d2_qnu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_qpoints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_branches</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_qpoints</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">nu</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">:</span>
                <span class="n">cvect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phdispl_cart</span><span class="p">[</span><span class="n">iq</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">d2_qnu</span><span class="p">[</span><span class="n">iq</span><span class="p">,</span> <span class="n">nu</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">cvect</span><span class="p">,</span> <span class="n">cvect</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>

        <span class="c1"># Plot fatbands: one plot per atom type.</span>
        <span class="n">ax00</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">ax_row</span><span class="p">,</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">symbol_set</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="n">ax_row</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax00</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax00</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ax_row</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ax00</span> <span class="o">=</span> <span class="n">ax</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">decorate_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">qlabels</span><span class="o">=</span><span class="n">qlabels</span><span class="p">)</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ax_row</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ntypat</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

            <span class="c1"># dir_indices lists the coordinate indices for the atoms of the same type.</span>
            <span class="n">atom_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">indices_from_symbol</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
            <span class="n">dir_indices</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">aindx</span> <span class="ow">in</span> <span class="n">atom_indices</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">aindx</span>
                <span class="n">dir_indices</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">start</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span>
            <span class="n">dir_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dir_indices</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">nu</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">:</span>
                <span class="n">yy_qq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phfreqs</span><span class="p">[:,</span> <span class="n">nu</span><span class="p">]</span> <span class="o">*</span> <span class="n">factor</span>

                <span class="c1"># Exctract the sub-vector associated to this atom type.</span>
                <span class="n">displ_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phdispl_cart</span><span class="p">[:,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">dir_indices</span><span class="p">]</span>
                <span class="n">d2_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_qpoints</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_qpoints</span><span class="p">):</span>
                    <span class="n">d2_type</span><span class="p">[</span><span class="n">iq</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">displ_type</span><span class="p">[</span><span class="n">iq</span><span class="p">],</span> <span class="n">displ_type</span><span class="p">[</span><span class="n">iq</span><span class="p">])</span><span class="o">.</span><span class="n">real</span>

                <span class="c1"># Normalize and scale by max_stripe_width_mev taking into account units.</span>
                <span class="c1"># The stripe is centered on the phonon branch hence the factor 2</span>
                <span class="n">d2_type</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">max_stripe_width_mev</span> <span class="o">*</span> <span class="mf">1.e-3</span> <span class="o">*</span> <span class="n">d2_type</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">d2_qnu</span><span class="p">[:,</span> <span class="n">nu</span><span class="p">])</span>

                <span class="c1"># Plot the phonon branch and the stripe.</span>
                <span class="k">if</span> <span class="n">nu</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">qq</span><span class="p">,</span> <span class="n">yy_qq</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">qq</span><span class="p">,</span> <span class="n">yy_qq</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">qq</span><span class="p">,</span> <span class="n">yy_qq</span> <span class="o">+</span> <span class="n">d2_type</span><span class="p">,</span> <span class="n">yy_qq</span> <span class="o">-</span> <span class="n">d2_type</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>

        <span class="c1"># Type projected DOSes.</span>
        <span class="k">if</span> <span class="n">phdos_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax01</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">ax_row</span><span class="p">,</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">symbol_set</span><span class="p">):</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ax_row</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ntypat</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="n">ax_row</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax01</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax00</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ax_row</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ax01</span> <span class="o">=</span> <span class="n">ax</span>

                <span class="c1"># Get PJDOS</span>
                <span class="c1"># Dictionary symbol --&gt; partial PhononDos</span>
                <span class="n">pjdos</span> <span class="o">=</span> <span class="n">phdos_file</span><span class="o">.</span><span class="n">pjdos_symbol</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">pjdos</span><span class="o">.</span><span class="n">mesh</span> <span class="o">*</span> <span class="n">factor</span><span class="p">,</span> <span class="n">pjdos</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="n">factor</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
                <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">close_phdos_file</span><span class="p">:</span>
                <span class="n">phdos_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="PhononBands.plot_with_phdos"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBands.plot_with_phdos">[docs]</a>    <span class="k">def</span> <span class="nf">plot_with_phdos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phdos</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="n">qlabels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axlist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the phonon band structure with the phonon DOS.</span>

<span class="sd">        Args:</span>
<span class="sd">            phdos: An instance of :class:`PhononDos` or netcdf file providing a PhononDos object.</span>
<span class="sd">            units: Units for phonon plots. Possible values in (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;). Case-insensitive.</span>
<span class="sd">            qlabels: dictionary whose keys are tuples with the reduced coordinates of the q-points.</span>
<span class="sd">                The values are the labels e.g. qlabels = {(0.0,0.0,0.0):&quot;$\Gamma$&quot;, (0.5,0,0):&quot;L&quot;}.</span>
<span class="sd">            axlist: The axes for the bandstructure plot and the DOS plot. If axlist is None, a new figure</span>
<span class="sd">                is created and the two axes are automatically generated.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">phdos</span> <span class="o">=</span> <span class="n">PhononDos</span><span class="o">.</span><span class="n">as_phdos</span><span class="p">(</span><span class="n">phdos</span><span class="p">,</span> <span class="n">phdos_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="k">import</span> <span class="n">GridSpec</span>

        <span class="k">if</span> <span class="n">axlist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Build axes and align bands and DOS.</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">gspec</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">gspec</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Take them from axlist.</span>
            <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="n">axlist</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">}</span>

        <span class="c1"># Plot the phonon band structure.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decorate_ax</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">qlabels</span><span class="o">=</span><span class="n">qlabels</span><span class="p">)</span>

        <span class="n">factor</span> <span class="o">=</span> <span class="n">_factor_ev2units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
        <span class="n">emin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minfreq</span><span class="p">)</span>
        <span class="n">emin</span> <span class="o">-=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">emin</span><span class="p">)</span>
        <span class="n">emin</span> <span class="o">*=</span> <span class="n">factor</span>
        <span class="n">emax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxfreq</span><span class="p">)</span>
        <span class="n">emax</span> <span class="o">+=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">emax</span><span class="p">)</span>
        <span class="n">emax</span> <span class="o">*=</span> <span class="n">factor</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_view_interval</span><span class="p">(</span><span class="n">emin</span><span class="p">,</span> <span class="n">emax</span><span class="p">)</span>

        <span class="c1"># Plot Phonon DOS</span>
        <span class="n">phdos</span><span class="o">.</span><span class="n">plot_dos_idos</span><span class="p">(</span><span class="n">ax2</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
        <span class="c1">#ax2.yaxis.set_label_position(&quot;right&quot;)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="PhononBands.to_dataframe"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBands.to_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">to_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a pandas DataFrame with the following columns:</span>

<span class="sd">            [&#39;qidx&#39;, &#39;mode&#39;, &#39;freq&#39;, &#39;qpoint&#39;]</span>

<span class="sd">        where:</span>

<span class="sd">        ==============  ==========================</span>
<span class="sd">        Column          Meaning</span>
<span class="sd">        ==============  ==========================</span>
<span class="sd">        qidx            q-point index.</span>
<span class="sd">        mode            phonon branch index.</span>
<span class="sd">        freq            Phonon frequency in eV.</span>
<span class="sd">        qpoint          :class:`Kpoint` object</span>
<span class="sd">        ==============  ==========================</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">iq</span><span class="p">,</span> <span class="n">qpoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">nu</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">:</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">([</span>
                           <span class="p">(</span><span class="s2">&quot;qidx&quot;</span><span class="p">,</span> <span class="n">iq</span><span class="p">),</span>
                           <span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">,</span> <span class="n">nu</span><span class="p">),</span>
                           <span class="p">(</span><span class="s2">&quot;freq&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phfreqs</span><span class="p">[</span><span class="n">iq</span><span class="p">,</span> <span class="n">nu</span><span class="p">]),</span>
                           <span class="p">(</span><span class="s2">&quot;qpoint&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">[</span><span class="n">iq</span><span class="p">]),</span>
                        <span class="p">]))</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="PhononBands.boxplot"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBands.boxplot">[docs]</a>    <span class="k">def</span> <span class="nf">boxplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="n">mode_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">swarm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use seaborn to draw a box plot to show distributions of eigenvalues with respect to the mode index.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>
<span class="sd">            units: Units for phonon plots. Possible values in (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;). Case-insensitive.</span>
<span class="sd">            mode_range: Only modes such as `mode_range[0] &lt;= mode_index &lt; mode_range[1]` are included in the plot.</span>
<span class="sd">            swarm: True to show the datapoints on top of the boxes</span>
<span class="sd">            kwargs: Keyword arguments passed to seaborn boxplot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the dataframe and select bands</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mode_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[(</span><span class="n">frame</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">mode_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">frame</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mode_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">factor</span> <span class="o">=</span> <span class="n">_factor_ev2units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
        <span class="n">yname</span> <span class="o">=</span> <span class="s2">&quot;freq </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">_unit_tag</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
        <span class="n">frame</span><span class="p">[</span><span class="n">yname</span><span class="p">]</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">frame</span><span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">]</span>

        <span class="kn">import</span> <span class="nn">seaborn.apionly</span> <span class="k">as</span> <span class="nn">sns</span>
        <span class="n">hue</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;mode&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">yname</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">frame</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="n">hue</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">swarm</span><span class="p">:</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">swarmplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;mode&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">yname</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">frame</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="n">hue</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;.25&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="PhononBands.to_pymatgen"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBands.to_pymatgen">[docs]</a>    <span class="k">def</span> <span class="nf">to_pymatgen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qlabels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a pymatgen PhononBandStructureSymmLine object.</span>

<span class="sd">        Args:</span>
<span class="sd">            qlabels: dictionary whose keys are tuples with the reduced coordinates of the q-points.</span>
<span class="sd">                The values are the labels e.g. qlabels = {(0.0,0.0,0.0):&quot;$\Gamma$&quot;, (0.5,0,0):&quot;L&quot;}.</span>
<span class="sd">                If None labels will be determined automatically.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pymatgen labels dict is inverted</span>
        <span class="k">if</span> <span class="n">qlabels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">qlabels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_qlabels</span>
            <span class="c1"># the indices in qlabels are without the split</span>
            <span class="n">labels_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">frac_coords</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">qlabels</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">labels_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">qlabels</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="n">labelled_q_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">labels_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="n">ph_freqs</span><span class="p">,</span> <span class="n">qpts</span><span class="p">,</span> <span class="n">displ</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">split_q</span><span class="p">,</span> <span class="n">split_phf</span><span class="p">,</span> <span class="n">split_phdispl</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">split_qpoints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_phfreqs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_phdispl_cart</span><span class="p">):</span>
            <span class="c1"># for q, phf in zip(split_q, split_phf)[1:-1]:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">phf</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">split_q</span><span class="p">,</span> <span class="n">split_phf</span><span class="p">,</span> <span class="n">split_phdispl</span><span class="p">)):</span>
                <span class="n">ph_freqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phf</span><span class="p">)</span>
                <span class="n">qpts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_branches</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_atoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">displ</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                <span class="c1"># if the qpoint has a label it nees to be repeated. If it is one of the extrama either it should</span>
                <span class="c1"># not be repeated (if they are the real first or last point) or they will be already reapeated due</span>
                <span class="c1"># to the split.</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">labelled_q</span><span class="p">)</span> <span class="k">for</span> <span class="n">labelled_q</span> <span class="ow">in</span> <span class="n">labelled_q_list</span><span class="p">):</span>
                    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">split_q</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">ph_freqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phf</span><span class="p">)</span>
                        <span class="n">qpts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
                        <span class="n">displ</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="n">ph_freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">ph_freqs</span><span class="p">)</span>
        <span class="n">qpts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">qpts</span><span class="p">)</span>
        <span class="n">displ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">displ</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

        <span class="kn">from</span> <span class="nn">pymatgen.phonon.bandstructure</span> <span class="k">import</span> <span class="n">PhononBandStructureSymmLine</span>
        <span class="k">return</span> <span class="n">PhononBandStructureSymmLine</span><span class="p">(</span><span class="n">qpoints</span><span class="o">=</span><span class="n">qpts</span><span class="p">,</span> <span class="n">frequencies</span><span class="o">=</span><span class="n">ph_freqs</span><span class="p">,</span>
                                           <span class="n">lattice</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="p">,</span>
                                           <span class="n">has_nac</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">non_anal_ph</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">eigendisplacements</span><span class="o">=</span><span class="n">displ</span><span class="p">,</span>
                                           <span class="n">labels_dict</span><span class="o">=</span><span class="n">labels_dict</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">PHBST_Reader</span><span class="p">(</span><span class="n">ETSF_Reader</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This object reads data from PHBST.nc file produced by anaddb.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">read_qredcoords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Array with the reduced coordinates of the q-points.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;qpoints&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_qweights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The weights of the q-points&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;qweights&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_phfreqs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Array with the phonon frequencies in eV.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;phfreqs&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_phdispl_cart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Complex array with the Cartesian displacements in **Angstrom**</span>
<span class="sd">        shape is (num_qpoints,  mu_mode,  cart_direction).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;phdispl_cart&quot;</span><span class="p">,</span> <span class="n">cmode</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_amu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The atomic mass units&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;atomic_mass_units&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>


<div class="viewcode-block" id="PhbstFile"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhbstFile">[docs]</a><span class="k">class</span> <span class="nc">PhbstFile</span><span class="p">(</span><span class="n">AbinitNcFile</span><span class="p">,</span> <span class="n">Has_Structure</span><span class="p">,</span> <span class="n">Has_PhononBands</span><span class="p">,</span> <span class="n">NotebookWriter</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Object used to access data stored in the PHBST file produced by ABINIT.</span>

<span class="sd">        Args:</span>
<span class="sd">            path: path to the file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PhbstFile</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="n">PHBST_Reader</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

        <span class="c1"># Initialize Phonon bands</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phbands</span> <span class="o">=</span> <span class="n">PhononBands</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

<div class="viewcode-block" id="PhbstFile.to_string"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhbstFile.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        String representation</span>

<span class="sd">        Args:</span>
<span class="sd">            verbose: verbosity level.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>

        <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="s2">&quot;File Info&quot;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filestat</span><span class="p">(</span><span class="n">as_string</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phbands</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_structure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_qpoints</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;:class:`Structure` object&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">phbands</span><span class="o">.</span><span class="n">structure</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">qpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of q-point objects.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">phbands</span><span class="o">.</span><span class="n">qpoints</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">phbands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;:class:`PhononBands` object&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phbands</span>

<div class="viewcode-block" id="PhbstFile.close"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhbstFile.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close the file.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="PhbstFile.qindex"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhbstFile.qindex">[docs]</a>    <span class="k">def</span> <span class="nf">qindex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qpoint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the index of the qpoint. Accepts integer or reduced coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">duck</span><span class="o">.</span><span class="n">is_intlike</span><span class="p">(</span><span class="n">qpoint</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">qpoint</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">qpoint</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhbstFile.qindex_qpoint"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhbstFile.qindex_qpoint">[docs]</a>    <span class="k">def</span> <span class="nf">qindex_qpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qpoint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns (qindex, qpoint) from an integer or a qpoint.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qindex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qindex</span><span class="p">(</span><span class="n">qpoint</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">qindex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qpoints</span><span class="p">[</span><span class="n">qindex</span><span class="p">]</span></div>

<div class="viewcode-block" id="PhbstFile.get_phframe"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhbstFile.get_phframe">[docs]</a>    <span class="k">def</span> <span class="nf">get_phframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qpoint</span><span class="p">,</span> <span class="n">with_structure</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a pandas :class:`DataFrame` with the phonon frequencies at the given q-point and</span>
<span class="sd">        information on the crystal structure (used for convergence studies).</span>

<span class="sd">        Args:</span>
<span class="sd">            qpoint: integer, vector of reduced coordinates or :class:`Kpoint` object.</span>
<span class="sd">	    with_structure: True to add structural parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qindex</span><span class="p">,</span> <span class="n">qpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qindex_qpoint</span><span class="p">(</span><span class="n">qpoint</span><span class="p">)</span>
        <span class="n">phfreqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phbands</span><span class="o">.</span><span class="n">phfreqs</span>

        <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">omega</span><span class="o">=</span><span class="n">phfreqs</span><span class="p">[</span><span class="n">qindex</span><span class="p">,</span> <span class="p">:],</span>
            <span class="n">branch</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">))),</span>
        <span class="p">)</span>

        <span class="c1"># Add geometrical information</span>
        <span class="k">if</span> <span class="n">with_structure</span><span class="p">:</span>
            <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">get_dict4frame</span><span class="p">(</span><span class="n">with_spglib</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="c1"># Build the pandas Frame and add the q-point as attribute.</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">qpoint</span> <span class="o">=</span> <span class="n">qpoint</span>

        <span class="k">return</span> <span class="n">frame</span></div>

<div class="viewcode-block" id="PhbstFile.get_phmode"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhbstFile.get_phmode">[docs]</a>    <span class="k">def</span> <span class="nf">get_phmode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qpoint</span><span class="p">,</span> <span class="n">branch</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the :class:`PhononMode` with the given qpoint and branch nu.</span>

<span class="sd">        Args:</span>
<span class="sd">            qpoint: Either a vector with the reduced components of the q-point</span>
<span class="sd">                or an integer giving the sequential index (C-convention).</span>
<span class="sd">            branch: branch index (C-convention)</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`PhononMode` instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qindex</span><span class="p">,</span> <span class="n">qpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qindex_qpoint</span><span class="p">(</span><span class="n">qpoint</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">PhononMode</span><span class="p">(</span><span class="n">qpoint</span><span class="o">=</span><span class="n">qpoint</span><span class="p">,</span>
                          <span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">phbands</span><span class="o">.</span><span class="n">phfreqs</span><span class="p">[</span><span class="n">qindex</span><span class="p">,</span> <span class="n">branch</span><span class="p">],</span>
                          <span class="n">displ_cart</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">phbands</span><span class="o">.</span><span class="n">phdispl_cart</span><span class="p">[</span><span class="n">qindex</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="p">:],</span>
                          <span class="n">structure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhbstFile.write_notebook"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhbstFile.write_notebook">[docs]</a>    <span class="k">def</span> <span class="nf">write_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write an jupyter notebook to nbpath. If nbpath is None, a temporay file in the current</span>
<span class="sd">        working directory is created. Return path to the notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbformat</span><span class="p">,</span> <span class="n">nbv</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nbformat_nbv_nb</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;ncfile = abilab.abiopen(&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;print(ncfile)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;fig = ncfile.phbands.plot()&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;fig = ncfile.phbands.qpoints.plot()&quot;</span><span class="p">),</span>
            <span class="c1">#nbv.new_code_cell(&quot;fig = ncfile.phbands.get_phdos().plot()&quot;),</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_nb_nbpath</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nbpath</span><span class="p">)</span></div></div>


<span class="n">_THERMO_YLABELS</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1"># [name][units] --&gt; latex string</span>
    <span class="s2">&quot;internal_energy&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;eV&quot;</span><span class="p">:</span> <span class="s2">&quot;$U(T)$ [eV/cell]&quot;</span><span class="p">,</span> <span class="s2">&quot;Jmol&quot;</span><span class="p">:</span> <span class="s2">&quot;$U(T)$ [J/mole]&quot;</span><span class="p">},</span>
    <span class="s2">&quot;free_energy&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;eV&quot;</span><span class="p">:</span> <span class="s2">&quot;$F(T) + ZPE$ [eV/cell]&quot;</span><span class="p">,</span> <span class="s2">&quot;Jmol&quot;</span><span class="p">:</span> <span class="s2">&quot;$F(T) + ZPE$ [J/mole]&quot;</span><span class="p">},</span>
    <span class="s2">&quot;entropy&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;eV&quot;</span><span class="p">:</span> <span class="s2">&quot;$S(T)$ [eV/cell]&quot;</span><span class="p">,</span> <span class="s2">&quot;Jmol&quot;</span><span class="p">:</span> <span class="s2">&quot;$S(T)$ [J/mole]&quot;</span><span class="p">},</span>
    <span class="s2">&quot;cv&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;eV&quot;</span><span class="p">:</span> <span class="s2">&quot;$C_V(T)$ [eV/cell]&quot;</span><span class="p">,</span> <span class="s2">&quot;Jmol&quot;</span><span class="p">:</span> <span class="s2">&quot;$C_V(T)$ [J/mole]&quot;</span><span class="p">},</span>
<span class="p">}</span>

<div class="viewcode-block" id="PhononDos"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononDos">[docs]</a><span class="k">class</span> <span class="nc">PhononDos</span><span class="p">(</span><span class="n">Function1D</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object stores the phonon density of states.</span>
<span class="sd">    An instance of `PhononDos` has a `mesh` (numpy array with the points of the mesh)</span>
<span class="sd">    and another numpy array, `values`, with the DOS on the mesh..</span>

<span class="sd">    .. note::</span>

<span class="sd">        mesh is given in eV, values are in states/eV.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#def __init__(self, mesh, values, qmesh):</span>
    <span class="c1">#    super(PhononDos, self).__init__(mesh, values)</span>
    <span class="c1">#    self.qmesh = qmesh</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="PhononDos.as_phdos"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononDos.as_phdos">[docs]</a>    <span class="k">def</span> <span class="nf">as_phdos</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">phdos_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an instance of :class:`PhononDOS` from a generic obj.</span>
<span class="sd">        Supports:</span>

<span class="sd">            - instances of cls</span>
<span class="sd">            - files (string) that can be open with abiopen and that provide one of the following attributes:</span>
<span class="sd">                [`phdos`, `phbands`]</span>
<span class="sd">            - instances of `PhononBands`</span>
<span class="sd">            - objects providing a `phbands`attribute.</span>

<span class="sd">        Args:</span>
<span class="sd">            phdos_kwargs: optional dictionary with the options passed to `get_phdos` to compute the phonon DOS.</span>
<span class="sd">            Used when obj is not already an instance of `cls` or when we have to compute the DOS from obj.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">phdos_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">phdos_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obj</span>

        <span class="k">elif</span> <span class="n">is_string</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="c1"># path? (pickle or file supported by abiopen)</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pickle&quot;</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">as_phdos</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">),</span> <span class="n">phdos_kwargs</span><span class="p">)</span>

            <span class="kn">from</span> <span class="nn">abipy.abilab</span> <span class="k">import</span> <span class="n">abiopen</span>
            <span class="k">with</span> <span class="n">abiopen</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="k">as</span> <span class="n">abifile</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">abifile</span><span class="p">,</span> <span class="s2">&quot;phdos&quot;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">abifile</span><span class="o">.</span><span class="n">phdos</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">abifile</span><span class="p">,</span> <span class="s2">&quot;phbands&quot;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">abifile</span><span class="o">.</span><span class="n">phbands</span><span class="o">.</span><span class="n">get_phdos</span><span class="p">(</span><span class="o">**</span><span class="n">phdos_kwargs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know how to create `PhononDos` from type: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">abifile</span><span class="p">))</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">PhononBands</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_phdos</span><span class="p">(</span><span class="o">**</span><span class="n">phdos_kwargs</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;phbands&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">phbands</span><span class="o">.</span><span class="n">get_phdos</span><span class="p">(</span><span class="o">**</span><span class="n">phdos_kwargs</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;phdos&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">phdos</span>

        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know how to create `PhononDos` from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span></div>

    <span class="nd">@lazy_property</span>
<div class="viewcode-block" id="PhononDos.iw0"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononDos.iw0">[docs]</a>    <span class="k">def</span> <span class="nf">iw0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        index of the first point in the mesh whose value is &gt;= 0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">iw0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_mesh_index</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">iw0</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot find zero in energy mesh&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">iw0</span></div>

    <span class="nd">@lazy_property</span>
<div class="viewcode-block" id="PhononDos.idos"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononDos.idos">[docs]</a>    <span class="k">def</span> <span class="nf">idos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Integrated DOS.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">integral</span><span class="p">()</span></div>

    <span class="nd">@lazy_property</span>
<div class="viewcode-block" id="PhononDos.zero_point_energy"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononDos.zero_point_energy">[docs]</a>    <span class="k">def</span> <span class="nf">zero_point_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Zero point energy in eV per unit cell.&quot;&quot;&quot;</span>
        <span class="n">iw0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iw0</span>
        <span class="k">return</span> <span class="n">Energy</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">[</span><span class="n">iw0</span><span class="p">:]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">iw0</span><span class="p">:],</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">[</span><span class="n">iw0</span><span class="p">:]),</span> <span class="s2">&quot;eV&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhononDos.plot_dos_idos"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononDos.plot_dos_idos">[docs]</a>    <span class="k">def</span> <span class="nf">plot_dos_idos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to plot DOS/IDOS on the axis ax.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: matplotlib axis</span>
<span class="sd">            what: string selecting the quantity to plot:</span>
<span class="sd">                &quot;d&quot; for DOS, &quot;i&quot; for IDOS. chars can be concatenated</span>
<span class="sd">                hence what=&quot;id&quot; plots both IDOS and DOS. (default &quot;d&quot;).</span>
<span class="sd">            exchange_xy: True to exchange axis</span>
<span class="sd">            units: Units for phonon plots. Possible values in (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;). Case-insensitive.</span>
<span class="sd">            kwargs: Options passed to matplotlib plot method.</span>

<span class="sd">        Return:</span>
<span class="sd">            list of lines added to the plot</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">what</span><span class="p">]</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">idos</span><span class="p">}[</span><span class="n">c</span><span class="p">]</span>
            <span class="n">xfactor</span> <span class="o">=</span> <span class="n">_factor_ev2units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
            <span class="c1"># Don&#39;t rescale IDOS</span>
            <span class="n">yfactor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">xfactor</span> <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;d&quot;</span> <span class="k">else</span> <span class="mi">1</span>

            <span class="n">ls</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="n">exchange_xy</span><span class="p">,</span> <span class="n">xfactor</span><span class="o">=</span><span class="n">xfactor</span><span class="p">,</span> <span class="n">yfactor</span><span class="o">=</span><span class="n">yfactor</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lines</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="PhononDos.plot"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononDos.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot Phonon DOS and IDOS on two distict plots.</span>

<span class="sd">        Args:</span>
<span class="sd">            units: Units for phonon plots. Possible values in (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;). Case-insensitive.</span>
<span class="sd">            kwargs: Keyword arguments passed to :mod:`matplotlib`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="k">import</span> <span class="n">GridSpec</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">gspec</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Energy </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">_unit_tag</span><span class="p">(</span><span class="n">units</span><span class="p">))</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;IDOS [states]&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;DOS </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">_dos_label_from_units</span><span class="p">(</span><span class="n">units</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plot_dos_idos</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_dos_idos</span><span class="p">(</span><span class="n">ax2</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="PhononDos.get_internal_energy"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononDos.get_internal_energy">[docs]</a>    <span class="k">def</span> <span class="nf">get_internal_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tstart</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">tstop</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the internal energy, in eV, in the harmonic approximation for different temperatures</span>
<span class="sd">        Zero point energy is included.</span>

<span class="sd">        tstart: The starting value (in Kelvin) of the temperature mesh.</span>
<span class="sd">        tstop: The end value (in Kelvin) of the mesh.</span>
<span class="sd">        num: int, optional Number of samples to generate. Default is 50.</span>

<span class="sd">        Return:</span>
<span class="sd">            :class:`Function1D` with U(T) + ZPE</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tmesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="p">)</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">gw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iw0</span><span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iw0</span><span class="p">:]</span>
        <span class="n">coth</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tmesh</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">temp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tmesh</span><span class="p">):</span>
            <span class="n">wd2kt</span> <span class="o">=</span> <span class="n">w</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">kb_eVK</span> <span class="o">*</span> <span class="n">temp</span><span class="p">)</span>
            <span class="n">vals</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">coth</span><span class="p">(</span><span class="n">wd2kt</span><span class="p">)</span> <span class="o">*</span> <span class="n">gw</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Function1D</span><span class="p">(</span><span class="n">tmesh</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">vals</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_point_energy</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhononDos.get_entropy"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononDos.get_entropy">[docs]</a>    <span class="k">def</span> <span class="nf">get_entropy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tstart</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">tstop</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the entropy, in eV/K, in the harmonic approximation for different temperatures</span>

<span class="sd">        tstart: The starting value (in Kelvin) of the temperature mesh.</span>
<span class="sd">        tstop: The end value (in Kelvin) of the mesh.</span>
<span class="sd">        num: int, optional Number of samples to generate. Default is 50.</span>

<span class="sd">        Return:</span>
<span class="sd">            :class:`Function1D` with S(T).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tmesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="p">)</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">gw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iw0</span><span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iw0</span><span class="p">:]</span>
        <span class="n">coth</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tmesh</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">temp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tmesh</span><span class="p">):</span>
            <span class="n">wd2kt</span> <span class="o">=</span> <span class="n">w</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">kb_eVK</span> <span class="o">*</span> <span class="n">temp</span><span class="p">)</span>
            <span class="n">vals</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">((</span><span class="n">wd2kt</span> <span class="o">*</span> <span class="n">coth</span><span class="p">(</span><span class="n">wd2kt</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sinh</span><span class="p">(</span><span class="n">wd2kt</span><span class="p">)))</span> <span class="o">*</span> <span class="n">gw</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Function1D</span><span class="p">(</span><span class="n">tmesh</span><span class="p">,</span> <span class="n">abu</span><span class="o">.</span><span class="n">kb_eVK</span> <span class="o">*</span> <span class="n">vals</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhononDos.get_free_energy"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononDos.get_free_energy">[docs]</a>    <span class="k">def</span> <span class="nf">get_free_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tstart</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">tstop</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the free energy, in eV, in the harmonic approximation for different temperatures</span>
<span class="sd">        Zero point energy is included.</span>

<span class="sd">        tstart: The starting value (in Kelvin) of the temperature mesh.</span>
<span class="sd">        tstop: The end value (in Kelvin) of the mesh.</span>
<span class="sd">        num: int, optional Number of samples to generate. Default is 50.</span>

<span class="sd">        Return:</span>
<span class="sd">            :class:`Function1D` with F(T) = U(T) + ZPE - T x S(T)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_internal_energy</span><span class="p">(</span><span class="n">tstart</span><span class="o">=</span><span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span><span class="o">=</span><span class="n">tstop</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_entropy</span><span class="p">(</span><span class="n">tstart</span><span class="o">=</span><span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span><span class="o">=</span><span class="n">tstop</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Function1D</span><span class="p">(</span><span class="n">uz</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">uz</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">mesh</span> <span class="o">*</span> <span class="n">s</span><span class="o">.</span><span class="n">values</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhononDos.get_cv"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononDos.get_cv">[docs]</a>    <span class="k">def</span> <span class="nf">get_cv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tstart</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">tstop</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the constant-volume specific heat, in eV/K, in the harmonic approximation for different temperatures</span>

<span class="sd">        tstart: The starting value (in Kelvin) of the temperature mesh.</span>
<span class="sd">        tstop: The end value (in Kelvin) of the mesh.</span>
<span class="sd">        num: int, optional Number of samples to generate. Default is 50.</span>

<span class="sd">        Return:</span>
<span class="sd">            :class:`Function1D` with C_v(T).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tmesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="p">)</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">gw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iw0</span><span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iw0</span><span class="p">:]</span>
        <span class="n">csch2</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sinh</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tmesh</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">temp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tmesh</span><span class="p">):</span>
            <span class="n">wd2kt</span> <span class="o">=</span> <span class="n">w</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">kb_eVK</span> <span class="o">*</span> <span class="n">temp</span><span class="p">)</span>
            <span class="n">vals</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">wd2kt</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">csch2</span><span class="p">(</span><span class="n">wd2kt</span><span class="p">)</span> <span class="o">*</span> <span class="n">gw</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Function1D</span><span class="p">(</span><span class="n">tmesh</span><span class="p">,</span> <span class="n">abu</span><span class="o">.</span><span class="n">kb_eVK</span> <span class="o">*</span> <span class="n">vals</span><span class="p">)</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="PhononDos.plot_harmonic_thermo"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononDos.plot_harmonic_thermo">[docs]</a>    <span class="k">def</span> <span class="nf">plot_harmonic_thermo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tstart</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">tstop</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="n">formula_units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">quantities</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot thermodinamic properties from the phonon DOSes within the harmonic approximation.</span>

<span class="sd">        Args:</span>
<span class="sd">            tstart: The starting value (in Kelvin) of the temperature mesh.</span>
<span class="sd">            tstop: The end value (in Kelvin) of the mesh.</span>
<span class="sd">            num: int, optional Number of samples to generate. Default is 50.</span>
<span class="sd">            quantities: List of strings specifying the thermodinamic quantities to plot.</span>
<span class="sd">                Possible values: [&quot;internal_energy&quot;, &quot;free_energy&quot;, &quot;entropy&quot;, &quot;c_v&quot;].</span>
<span class="sd">                None means all.</span>
<span class="sd">            units: eV for energies in ev/unit_cell, Jmol for results in J/mole.</span>
<span class="sd">            formula_units:</span>
<span class="sd">                the number of formula units per unit cell. If unspecified, the</span>
<span class="sd">                thermodynamic quantities will be given on a per-unit-cell basis.</span>

<span class="sd">        Returns:</span>
<span class="sd">            matplotlib figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">quantities</span> <span class="o">=</span> <span class="n">list_strings</span><span class="p">(</span><span class="n">quantities</span><span class="p">)</span> <span class="k">if</span> <span class="n">quantities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> \
            <span class="p">[</span><span class="s2">&quot;internal_energy&quot;</span><span class="p">,</span> <span class="s2">&quot;free_energy&quot;</span><span class="p">,</span> <span class="s2">&quot;entropy&quot;</span><span class="p">,</span> <span class="s2">&quot;cv&quot;</span><span class="p">]</span>

        <span class="c1"># Build grid of plots.</span>
        <span class="n">ncols</span><span class="p">,</span> <span class="n">nrows</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
        <span class="n">num_plots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">quantities</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_plots</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="n">num_plots</span> <span class="o">//</span> <span class="n">ncols</span> <span class="o">+</span> <span class="n">num_plots</span> <span class="o">%</span> <span class="n">ncols</span>

        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axmat</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># don&#39;t show the last ax if num_plots is odd.</span>
        <span class="k">if</span> <span class="n">num_plots</span> <span class="o">%</span> <span class="n">ncols</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">axmat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">iax</span><span class="p">,</span> <span class="p">(</span><span class="n">qname</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">quantities</span><span class="p">,</span> <span class="n">axmat</span><span class="o">.</span><span class="n">flat</span><span class="p">)):</span>
            <span class="c1"># Compute thermodinamic quantity associated to qname.</span>
            <span class="n">f1d</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;get_&quot;</span> <span class="o">+</span> <span class="n">qname</span><span class="p">)(</span><span class="n">tstart</span><span class="o">=</span><span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span><span class="o">=</span><span class="n">tstop</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="p">)</span>
            <span class="n">ys</span> <span class="o">=</span> <span class="n">f1d</span><span class="o">.</span><span class="n">values</span>
            <span class="k">if</span> <span class="n">formula_units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ys</span> <span class="o">/=</span> <span class="n">formula_units</span>
            <span class="k">if</span> <span class="n">units</span> <span class="o">==</span> <span class="s2">&quot;Jmol&quot;</span><span class="p">:</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">ys</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">e_Cb</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Avogadro</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">f1d</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">ys</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">qname</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Temperature [K]&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">_THERMO_YLABELS</span><span class="p">[</span><span class="n">qname</span><span class="p">][</span><span class="n">units</span><span class="p">])</span>
            <span class="c1">#ax.legend(loc=&quot;best&quot;)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span></div></div>


<div class="viewcode-block" id="PhdosReader"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhdosReader">[docs]</a><span class="k">class</span> <span class="nc">PhdosReader</span><span class="p">(</span><span class="n">ETSF_Reader</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object reads data from the PHDOS.nc file produced by anaddb.</span>

<span class="sd">    .. note::</span>

<span class="sd">            Frequencies are in eV, DOSes are in states/eV.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@lazy_property</span>
<div class="viewcode-block" id="PhdosReader.structure"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhdosReader.structure">[docs]</a>    <span class="k">def</span> <span class="nf">structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The crystalline structure.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_structure</span><span class="p">()</span></div>

    <span class="nd">@lazy_property</span>
<div class="viewcode-block" id="PhdosReader.wmesh"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhdosReader.wmesh">[docs]</a>    <span class="k">def</span> <span class="nf">wmesh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The frequency mesh for the PH-DOS in eV.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;wmesh&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhdosReader.read_pjdos_type"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhdosReader.read_pjdos_type">[docs]</a>    <span class="k">def</span> <span class="nf">read_pjdos_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[ntypat, nomega] array with PH-DOS projected over atom types.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;pjdos_type&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhdosReader.read_pjdos_atdir"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhdosReader.read_pjdos_atdir">[docs]</a>    <span class="k">def</span> <span class="nf">read_pjdos_atdir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return [natom, three, nomega] array with Phonon DOS projected over atoms and reduced directions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;pjdos&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhdosReader.read_phdos"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhdosReader.read_phdos">[docs]</a>    <span class="k">def</span> <span class="nf">read_phdos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the :class:`PhononDOS`. with the total phonon DOS&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">PhononDos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wmesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;phdos&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="PhdosReader.read_pjdos_symbol_rc_dict"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhdosReader.read_pjdos_symbol_rc_dict">[docs]</a>    <span class="k">def</span> <span class="nf">read_pjdos_symbol_rc_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return `OrderedDict` mapping element symbol --&gt; [3, nomega] array</span>
<span class="sd">        with the the phonon DOSes summed over atom-types and decomposed along</span>
<span class="sd">        the three reduced directions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># phdos_rc_type[ntypat, 3, nomega]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;pjdos_rc_type&quot;</span><span class="p">)</span>

        <span class="n">od</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chemical_symbols</span><span class="p">:</span>
           <span class="n">type_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeidx_from_symbol</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
           <span class="n">od</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">type_idx</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">od</span></div>

<div class="viewcode-block" id="PhdosReader.read_pjdos_symbol_dict"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhdosReader.read_pjdos_symbol_dict">[docs]</a>    <span class="k">def</span> <span class="nf">read_pjdos_symbol_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ordered dictionary mapping element symbol --&gt; `PhononDos`</span>
<span class="sd">        where PhononDos is the contribution to the total DOS summed over atoms</span>
<span class="sd">        with chemical symbol `symbol`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># [ntypat, nomega] array with PH-DOS projected over atom types.&quot;&quot;&quot;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_pjdos_type</span><span class="p">()</span>

        <span class="n">od</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chemical_symbols</span><span class="p">:</span>
            <span class="n">type_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeidx_from_symbol</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
            <span class="n">od</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">PhononDos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wmesh</span><span class="p">,</span> <span class="n">values</span><span class="p">[</span><span class="n">type_idx</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">od</span></div></div>

    <span class="c1"># TODO</span>
    <span class="c1">#double msqd_dos_atom(number_of_atoms, three, three, number_of_frequencies)</span>


<div class="viewcode-block" id="PhdosFile"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhdosFile">[docs]</a><span class="k">class</span> <span class="nc">PhdosFile</span><span class="p">(</span><span class="n">AbinitNcFile</span><span class="p">,</span> <span class="n">Has_Structure</span><span class="p">,</span> <span class="n">NotebookWriter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Container object storing the different DOSes stored in the</span>
<span class="sd">    PHDOS.nc file produced by anaddb. Provides helper function</span>
<span class="sd">    to visualize/extract data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="c1"># Open the file, read data and create objects.</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PhdosFile</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="n">r</span> <span class="o">=</span> <span class="n">PhdosReader</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wmesh</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">wmesh</span>

<div class="viewcode-block" id="PhdosFile.close"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhdosFile.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close the file.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Invoked by str&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

<div class="viewcode-block" id="PhdosFile.to_string"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhdosFile.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Human-readable string with useful information such as structure...</span>

<span class="sd">            verbose: Verbosity level.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>

        <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="s2">&quot;File Info&quot;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filestat</span><span class="p">(</span><span class="n">as_string</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">app</span><span class="p">(</span><span class="n">marquee</span><span class="p">(</span><span class="s2">&quot;Structure&quot;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

    <span class="nd">@lazy_property</span>
<div class="viewcode-block" id="PhdosFile.structure"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhdosFile.structure">[docs]</a>    <span class="k">def</span> <span class="nf">structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the :class:`Structure` object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">structure</span></div>

    <span class="nd">@lazy_property</span>
<div class="viewcode-block" id="PhdosFile.phdos"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhdosFile.phdos">[docs]</a>    <span class="k">def</span> <span class="nf">phdos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;:class:`PhononDos` object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_phdos</span><span class="p">()</span></div>

    <span class="nd">@lazy_property</span>
<div class="viewcode-block" id="PhdosFile.pjdos_symbol"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhdosFile.pjdos_symbol">[docs]</a>    <span class="k">def</span> <span class="nf">pjdos_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ordered dictionary mapping element symbol --&gt; `PhononDos`</span>
<span class="sd">        where PhononDos is the contribution to the total DOS summed over atoms</span>
<span class="sd">        with chemical symbol `symbol`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_pjdos_symbol_dict</span><span class="p">()</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="PhdosFile.plot_pjdos_type"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhdosFile.plot_pjdos_type">[docs]</a>    <span class="k">def</span> <span class="nf">plot_pjdos_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                        <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot type-projected phonon DOS.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>
<span class="sd">            stacked: True if DOS partial contributions should be stacked on top of each other.</span>
<span class="sd">            units: Units for phonon plots. Possible values in (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;). Case-insensitive.</span>
<span class="sd">            colormap: Have a look at the colormaps</span>
<span class="sd">                `here &lt;http://matplotlib.sourceforge.net/examples/pylab_examples/show_colormaps.html&gt;`_</span>
<span class="sd">                and decide which one you&#39;d like:</span>
<span class="sd">            alpha: The alpha blending value, between 0 (transparent) and 1 (opaque)</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used</span>
<span class="sd">            ylims: y-axis limits.</span>

<span class="sd">        Returns:</span>
<span class="sd">            matplotlib figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lw</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;lw&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">_factor_ev2units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">_unit_tag</span><span class="p">(</span><span class="n">units</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;PJDOS </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">_dos_label_from_units</span><span class="p">(</span><span class="n">units</span><span class="p">))</span>

        <span class="c1"># Type projected DOSes.</span>
        <span class="n">num_plots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pjdos_symbol</span><span class="p">)</span>
        <span class="n">cumulative</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wmesh</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">pjdos</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pjdos_symbol</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">pjdos</span><span class="o">.</span><span class="n">mesh</span> <span class="o">*</span> <span class="n">factor</span><span class="p">,</span> <span class="n">pjdos</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="n">factor</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">num_plots</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">stacked</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cumulative</span> <span class="o">+</span> <span class="n">y</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cumulative</span><span class="p">,</span> <span class="n">cumulative</span> <span class="o">+</span> <span class="n">y</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
                <span class="n">cumulative</span> <span class="o">+=</span> <span class="n">y</span>

        <span class="c1"># Total PHDOS</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phdos</span><span class="o">.</span><span class="n">mesh</span> <span class="o">*</span> <span class="n">factor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phdos</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="n">factor</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Total PHDOS&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="PhdosFile.plot_pjdos_redirs_type"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhdosFile.plot_pjdos_redirs_type">[docs]</a>    <span class="k">def</span> <span class="nf">plot_pjdos_redirs_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                               <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axlist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot type-projected phonon DOS decomposed along the three reduced directions.</span>
<span class="sd">        Three rows for each reduced direction. Each row shows the contribution of each atomic type + Total PH DOS.</span>

<span class="sd">        Args:</span>
<span class="sd">            units: Units for phonon plots. Possible values in (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;). Case-insensitive.</span>
<span class="sd">            stacked: True if DOS partial contributions should be stacked on top of each other.</span>
<span class="sd">            colormap: Have a look at the colormaps</span>
<span class="sd">                `here &lt;http://matplotlib.sourceforge.net/examples/pylab_examples/show_colormaps.html&gt;`_</span>
<span class="sd">                and decide which one you&#39;d like:</span>
<span class="sd">            alpha: The alpha blending value, between 0 (transparent) and 1 (opaque)</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used</span>
<span class="sd">            ylims: y-axis limits.</span>
<span class="sd">            axlist: List of matplotlib :class:`Axes` or None if a new figure should be created.</span>

<span class="sd">        Returns:</span>
<span class="sd">            matplotlib figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lw</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;lw&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">ntypat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">ntypesp</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">_factor_ev2units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>

        <span class="c1"># Three rows for each reduced direction.</span>
        <span class="c1"># Each row shows the contribution of each atomic type + Total PH DOS.</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">axlist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axlist</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">axlist</span><span class="p">,</span> <span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>

        <span class="c1"># symbol --&gt; [three, number_of_frequencies]</span>
        <span class="n">pjdos_symbol_rc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_pjdos_symbol_rc_dict</span><span class="p">()</span>

        <span class="n">xx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phdos</span><span class="o">.</span><span class="n">mesh</span> <span class="o">*</span> <span class="n">factor</span>
        <span class="k">for</span> <span class="n">idir</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axlist</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
            <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">idir</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;PJDOS along $L_{</span><span class="si">%d</span><span class="s1">}$&#39;</span> <span class="o">%</span> <span class="n">idir</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">idir</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">_unit_tag</span><span class="p">(</span><span class="n">units</span><span class="p">))</span>

            <span class="c1"># Plot Type projected DOSes along reduced direction idir</span>
            <span class="n">cumulative</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wmesh</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">itype</span><span class="p">,</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">chemical_symbols</span><span class="p">):</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">itype</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ntypat</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">yy</span> <span class="o">=</span> <span class="n">pjdos_symbol_rc</span><span class="p">[</span><span class="n">symbol</span><span class="p">][</span><span class="n">idir</span><span class="p">]</span> <span class="o">/</span> <span class="n">factor</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">stacked</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">cumulative</span> <span class="o">+</span> <span class="n">yy</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">cumulative</span><span class="p">,</span> <span class="n">cumulative</span> <span class="o">+</span> <span class="n">yy</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
                    <span class="n">cumulative</span> <span class="o">+=</span> <span class="n">yy</span>

            <span class="c1"># Add Total PHDOS</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phdos</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="n">factor</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Total PHDOS&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="PhdosFile.plot_pjdos_redirs_site"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhdosFile.plot_pjdos_redirs_site">[docs]</a>    <span class="k">def</span> <span class="nf">plot_pjdos_redirs_site</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="s2">&quot;inequivalent&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                               <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axlist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot phonon PJDOS for each atom in the unit cell. By default, only &quot;inequivalent&quot; atoms are shown.</span>

<span class="sd">        Args:</span>
<span class="sd">            view: &quot;inequivalent&quot;, &quot;all&quot;</span>
<span class="sd">            units: Units for phonon plots. Possible values in (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;). Case-insensitive.</span>
<span class="sd">            stacked: True if DOS partial contributions should be stacked on top of each other.</span>
<span class="sd">            colormap: matplotlib colormap.</span>
<span class="sd">            alpha: The alpha blending value, between 0 (transparent) and 1 (opaque)</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used</span>
<span class="sd">            axlist: List of matplotlib :class:`Axes` or None if a new figure should be created.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Define num_plots and ax2atom depending on view.</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">_factor_ev2units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
        <span class="n">natom</span><span class="p">,</span> <span class="n">ntypat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">ntypesp</span>
        <span class="n">lw</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;lw&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">view</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span> <span class="ow">or</span> <span class="n">natom</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">iatom_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">natom</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="s2">&quot;inequivalent&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calling spglib to find inequivalent sites.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Note that `symafm` magnetic symmetries (if any) are not taken into account.&quot;</span><span class="p">)</span>
            <span class="n">ea</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">spget_equivalent_atoms</span><span class="p">(</span><span class="n">printout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">iatom_list</span> <span class="o">=</span> <span class="n">ea</span><span class="o">.</span><span class="n">irred_pos</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wrong value for view: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">view</span><span class="p">))</span>

        <span class="c1"># Three rows for each reduced direction.</span>
        <span class="c1"># Each row shows the contribution of each site + Total PH DOS.</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">axlist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axlist</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">axlist</span><span class="p">,</span> <span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="c1"># [natom, three, nomega] array with PH-DOS projected over atoms and reduced directions&quot;&quot;&quot;</span>
        <span class="n">pjdos_atdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read_pjdos_atdir</span><span class="p">()</span>

        <span class="n">xx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phdos</span><span class="o">.</span><span class="n">mesh</span> <span class="o">*</span> <span class="n">factor</span>
        <span class="k">for</span> <span class="n">idir</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axlist</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
            <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">idir</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;PJDOS along $L_{</span><span class="si">%d</span><span class="s1">}$&#39;</span> <span class="o">%</span> <span class="n">idir</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">idir</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">_unit_tag</span><span class="p">(</span><span class="n">units</span><span class="p">))</span>

            <span class="c1"># Plot Type projected DOSes along reduced direction idir</span>
            <span class="n">cumulative</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wmesh</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">iatom</span> <span class="ow">in</span> <span class="n">iatom_list</span><span class="p">:</span>
                <span class="n">site</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">[</span><span class="n">iatom</span><span class="p">]</span>
                <span class="n">symbol</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">iatom</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iatom_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">yy</span> <span class="o">=</span> <span class="n">pjdos_atdir</span><span class="p">[</span><span class="n">iatom</span><span class="p">,</span> <span class="n">idir</span><span class="p">]</span> <span class="o">/</span> <span class="n">factor</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">stacked</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">cumulative</span> <span class="o">+</span> <span class="n">yy</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">cumulative</span><span class="p">,</span> <span class="n">cumulative</span> <span class="o">+</span> <span class="n">yy</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
                    <span class="n">cumulative</span> <span class="o">+=</span> <span class="n">yy</span>

            <span class="c1"># Add Total PHDOS</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phdos</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="n">factor</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Total PHDOS&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="PhdosFile.write_notebook"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhdosFile.write_notebook">[docs]</a>    <span class="k">def</span> <span class="nf">write_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a jupyter notebook to nbpath. If nbpath is None, a temporay file in the current</span>
<span class="sd">        working directory is created. Return path to the notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbformat</span><span class="p">,</span> <span class="n">nbv</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nbformat_nbv_nb</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;ncfile = abilab.abiopen(&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;print(ncfile)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;fig = ncfile.phdos.plot()&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;fig = ncfile.plot_pjdos_type()&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;fig = ncfile.plot_pjdos_redirs_type()&quot;</span><span class="p">),</span>
            <span class="c1">#nbv.new_code_cell(&quot;fig = ncfile.plot_pjdos_redirs_site()&quot;),</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_nb_nbpath</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nbpath</span><span class="p">)</span></div></div>


<span class="c1"># FIXME: Remove. Use PhononBandsPlotter API.</span>
<span class="nd">@add_fig_kwargs</span>
<span class="k">def</span> <span class="nf">phbands_gridplot</span><span class="p">(</span><span class="n">phb_objects</span><span class="p">,</span> <span class="n">titles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phdos_objects</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phdos_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot multiple phonon bandstructures and optionally DOSes on a grid.</span>

<span class="sd">    Args:</span>
<span class="sd">        phb_objects: List of objects from which the phonon band structures are extracted.</span>
<span class="sd">            Each item in phb_objects is either a string with the path of the netcdf file,</span>
<span class="sd">            or one of the abipy object with an `phbands` attribute or a :class:`PhononBands` object.</span>
<span class="sd">        phdos_objects:</span>
<span class="sd">            List of objects from which the phonon DOSes are extracted.</span>
<span class="sd">            Accept filepaths or :class:`PhononDos` objects. If phdos_objects is not None,</span>
<span class="sd">            each subplot in the grid contains a band structure with DOS else a simple bandstructure plot.</span>
<span class="sd">        titles:</span>
<span class="sd">            List of strings with the titles to be added to the subplots.</span>
<span class="sd">        phdos_kwargs: optional dictionary with the options passed to `get_phdos` to compute the phonon DOS.</span>
<span class="sd">            Used only if `phdos_objects` is not None.</span>
<span class="sd">        units: Units for phonon plots. Possible values in (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;). Case-insensitive.</span>

<span class="sd">    Returns:</span>
<span class="sd">        matplotlib figure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Build list of PhononBands objects.</span>
    <span class="n">phbands_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">PhononBands</span><span class="o">.</span><span class="n">as_phbands</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">phb_objects</span><span class="p">]</span>

    <span class="c1"># Build list of PhononDos objects.</span>
    <span class="n">phdos_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">phdos_objects</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">phdos_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">phdos_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">phdos_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">PhononDos</span><span class="o">.</span><span class="n">as_phdos</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">phdos_kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">phdos_objects</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">phdos_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">phbands_list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The number of objects for DOS must equal be to the number of bands&quot;</span><span class="p">)</span>

    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
    <span class="n">numeb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">phbands_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">numeb</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="n">numeb</span> <span class="o">//</span> <span class="n">ncols</span> <span class="o">+</span> <span class="n">numeb</span> <span class="o">%</span> <span class="n">ncols</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">phdos_list</span><span class="p">:</span>
        <span class="c1"># Plot grid with bands only.</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="c1"># don&#39;t show the last ax if numeb is odd.</span>
        <span class="k">if</span> <span class="n">numeb</span> <span class="o">%</span> <span class="n">ncols</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">phbands</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">phbands_list</span><span class="p">,</span> <span class="n">axes</span><span class="p">)):</span>
            <span class="n">phbands</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">titles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">ncols</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Plot grid with bands + DOS</span>
        <span class="c1"># see http://matplotlib.org/users/gridspec.html</span>
        <span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="k">import</span> <span class="n">GridSpec</span><span class="p">,</span> <span class="n">GridSpecFromSubplotSpec</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">gspec</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">phbands</span><span class="p">,</span> <span class="n">phdos</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">phbands_list</span><span class="p">,</span> <span class="n">phdos_list</span><span class="p">)):</span>
            <span class="n">subgrid</span> <span class="o">=</span> <span class="n">GridSpecFromSubplotSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">subplot_spec</span><span class="o">=</span><span class="n">gspec</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
            <span class="c1"># Get axes and align bands and DOS.</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">subgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">subgrid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
            <span class="n">phbands</span><span class="o">.</span><span class="n">plot_with_phdos</span><span class="p">(</span><span class="n">phdos</span><span class="p">,</span> <span class="n">axlist</span><span class="o">=</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">titles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">ncols</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span>


<div class="viewcode-block" id="frame_from_phbands"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.frame_from_phbands">[docs]</a><span class="k">def</span> <span class="nf">frame_from_phbands</span><span class="p">(</span><span class="n">phbands_objects</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_spglib</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a pandas dataframe with the most important results available in a list of band structures.</span>

<span class="sd">    Args:</span>
<span class="sd">        phbands_objects: List of objects that can be converted to structure.</span>
<span class="sd">            Support netcdf filenames or :class:`PhononBands` objects</span>
<span class="sd">            See `PhononBands.as_ebands` for the complete list.</span>
<span class="sd">        index: Index of the dataframe.</span>
<span class="sd">        with_spglib: If True, spglib is invoked to get the spacegroup symbol and number.</span>

<span class="sd">    Return:</span>
<span class="sd">        pandas :class:`DataFrame`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">phbands_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">PhononBands</span><span class="o">.</span><span class="n">as_phbands</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">phbands_objects</span><span class="p">]</span>
    <span class="c1"># Use OrderedDict to have columns ordered nicely.</span>
    <span class="n">odict_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">phbands</span><span class="o">.</span><span class="n">get_dict4frame</span><span class="p">(</span><span class="n">with_spglib</span><span class="o">=</span><span class="n">with_spglib</span><span class="p">))</span> <span class="k">for</span> <span class="n">phbands</span> <span class="ow">in</span> <span class="n">phbands_list</span><span class="p">]</span>

    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">odict_list</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
                        <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">odict_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">odict_list</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="PhononBandsPlotter"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBandsPlotter">[docs]</a><span class="k">class</span> <span class="nc">PhononBandsPlotter</span><span class="p">(</span><span class="n">NotebookWriter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for plotting phonon band structure and DOSes.</span>
<span class="sd">    Supports plots on the same graph or separated plots.</span>

<span class="sd">    Usage example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        plotter = PhononBandsPlotter()</span>
<span class="sd">        plotter.add_phbands(&quot;foo bands&quot;, &quot;foo_PHBST.nc&quot;)</span>
<span class="sd">        plotter.add_phbands(&quot;bar bands&quot;, &quot;bar_PHBST.nc&quot;)</span>
<span class="sd">        plotter.gridplot()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_LINE_COLORS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">]</span>
    <span class="n">_LINE_STYLES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="s2">&quot;-.&quot;</span><span class="p">,]</span>
    <span class="n">_LINE_WIDTHS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_phbands</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">key_phdos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phdos_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            key_phbands: List of (label, phbands) tuples.</span>
<span class="sd">                phbands is any object that can be converted into :class:`PhononBands` e.g. ncfile, path.</span>
<span class="sd">            key_phdos: List of (label, phdos) tuples.</span>
<span class="sd">                phdos is any object that can be converted into :class:`PhononDos`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key_phbands</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">key_phbands</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">key_phbands</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">PhononBands</span><span class="o">.</span><span class="n">as_phbands</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">key_phbands</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bands_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">key_phbands</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">key_phdos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">key_phdos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">key_phdos</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">PhononDos</span><span class="o">.</span><span class="n">as_phdos</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">phdos_kwargs</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">key_phdos</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phdoses_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">key_phdos</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key_phdos</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">key_phbands</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;key_phbands must be specifed when key_dos is not None&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_phbands</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_phdos</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;key_phbands and key_phdos must have the same number of elements.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Invoked by repr&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="nb">repr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Invoked by str&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

<div class="viewcode-block" id="PhononBandsPlotter.to_string"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBandsPlotter.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">phbands</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phbands_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">%d</span><span class="s2">] </span><span class="si">%s</span><span class="s2"> --&gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">func</span><span class="p">(</span><span class="n">phbands</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phdoses_dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">phdos</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phdoses_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">app</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">%d</span><span class="s2">] </span><span class="si">%s</span><span class="s2"> --&gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">func</span><span class="p">(</span><span class="n">phdos</span><span class="p">)))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhononBandsPlotter.get_phbands_frame"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBandsPlotter.get_phbands_frame">[docs]</a>    <span class="k">def</span> <span class="nf">get_phbands_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_spglib</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a pandas dataframe with the most important results available in the band structures.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">frame_from_phbands</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phbands_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                                 <span class="n">index</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phbands_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">with_spglib</span><span class="o">=</span><span class="n">with_spglib</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">phbands_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dictionary with the mapping label --&gt; phbands.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bands_dict</span>

    <span class="c1"># TODO: Just an alias. To be removed in 0.4</span>
    <span class="n">bands_dict</span> <span class="o">=</span> <span class="n">phbands_dict</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">phdoses_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dictionary with the mapping label --&gt; phdos.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phdoses_dict</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">phbands_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;List of `:class:PhononBands`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bands_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">phdoses_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;List of :class:`PhononDos`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_phdoses_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

<div class="viewcode-block" id="PhononBandsPlotter.iter_lineopt"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBandsPlotter.iter_lineopt">[docs]</a>    <span class="k">def</span> <span class="nf">iter_lineopt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generates style options for lines.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LINE_WIDTHS</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_LINE_STYLES</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LINE_COLORS</span><span class="p">):</span>
            <span class="k">yield</span> <span class="p">{</span><span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;linestyle&quot;</span><span class="p">:</span> <span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">o</span><span class="p">[</span><span class="mi">2</span><span class="p">]}</span></div>

    <span class="nd">@deprecated</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;add_phbands_from_file method of PhononBandsPlotter has been replaced by add_phbands. It will be removed in 0.4&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add_phbands_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a band structure for plotting. Reads data from a Netcdfile</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">abipy.abilab</span> <span class="k">import</span> <span class="n">abiopen</span>
        <span class="k">with</span> <span class="n">abiopen</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">ncfile</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">label</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">filepath</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_phbands</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">phbands</span><span class="p">)</span>

<div class="viewcode-block" id="PhononBandsPlotter.add_phbands"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBandsPlotter.add_phbands">[docs]</a>    <span class="k">def</span> <span class="nf">add_phbands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">phdos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phdos_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a band structure for plotting.</span>

<span class="sd">        Args:</span>
<span class="sd">            label: label for the bands. Must be unique.</span>
<span class="sd">            bands: :class:`PhononBands` object.</span>
<span class="sd">            phdos: :class:`PhononDos` object.</span>
<span class="sd">            phdos_kwargs: optional dictionary with the options passed to `get_phdos` to compute the phonon DOS.</span>
<span class="sd">              Used only if `phdos` is not None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">warnings</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;dos has been renamed phdos. The argument will removed in abipy 0.4&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">phdos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;phdos and dos are mutually exclusive&quot;</span><span class="p">)</span>
            <span class="n">phdos</span> <span class="o">=</span> <span class="n">dos</span>

        <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bands_dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;label </span><span class="si">%s</span><span class="s2"> is already in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bands_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_bands_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">PhononBands</span><span class="o">.</span><span class="n">as_phbands</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">phdos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phdoses_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">PhononDos</span><span class="o">.</span><span class="n">as_phdos</span><span class="p">(</span><span class="n">phdos</span><span class="p">,</span> <span class="n">phdos_kwargs</span><span class="p">)</span></div>

    <span class="c1">#def bands_statdiff(self, ref=0):</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    Compare the reference bands with index ref with the other bands stored in the plotter.</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    for i, label in enumerate(self._bands_dict.keys()):</span>
    <span class="c1">#        if i == ref:</span>
    <span class="c1">#            ref_label = label</span>
    <span class="c1">#            break</span>
    <span class="c1">#    else:</span>
    <span class="c1">#        raise ValueError(&quot;ref index %s is &gt; number of bands&quot; % ref)</span>

    <span class="c1">#    ref_bands = self._bands_dict[ref_label]</span>

    <span class="c1">#    text = []</span>
    <span class="c1">#    for label, bands in self._bands_dict.items():</span>
    <span class="c1">#        if label == ref_label: continue</span>
    <span class="c1">#        stat = ref_bands.statdiff(bands)</span>
    <span class="c1">#        text.append(str(stat))</span>

    <span class="c1">#    return &quot;\n\n&quot;.join(text)</span>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="PhononBandsPlotter.combiplot"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBandsPlotter.combiplot">[docs]</a>    <span class="k">def</span> <span class="nf">combiplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qlabels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;eV&#39;</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the band structure and the DOS on the same figure.</span>
<span class="sd">        Use `gridplot` to plot band structures on different figures.</span>

<span class="sd">        Args:</span>
<span class="sd">            units: Units for phonon plots. Possible values in (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;). Case-insensitive.</span>
<span class="sd">            qlabels: dictionary whose keys are tuples with the reduced coordinates of the k-points.</span>
<span class="sd">                The values are the labels e.g. klabels = {(0.0,0.0,0.0): &quot;$\Gamma$&quot;, (0.5,0,0): &quot;L&quot;}.</span>
<span class="sd">            ylims: Set the data limits for the y-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used</span>

<span class="sd">        Returns:</span>
<span class="sd">            matplotlib figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="k">import</span> <span class="n">GridSpec</span>

        <span class="c1"># Build grid of plots.</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phdoses_dict</span><span class="p">:</span>
            <span class="n">gspec</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">gspec</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># Align bands and DOS.</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
            <span class="n">ax_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
            <span class="n">ax_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax1</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">ax_list</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ylims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">ax_list</span><span class="p">:</span>
                <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="c1"># Plot bands.</span>
        <span class="n">lines</span><span class="p">,</span> <span class="n">legends</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">my_kwargs</span><span class="p">,</span> <span class="n">opts_label</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="p">{}</span>
        <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">bands</span><span class="p">),</span> <span class="n">lineopt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bands_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_lineopt</span><span class="p">()):</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">my_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">lineopt</span><span class="p">)</span>
            <span class="n">opts_label</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">my_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="n">l</span> <span class="o">=</span> <span class="n">bands</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="o">**</span><span class="n">my_kwargs</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># Use relative paths if label is a file.</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">label</span><span class="p">):</span>
                <span class="n">legends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">legends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">label</span><span class="p">)</span>

            <span class="c1"># Set ticks and labels, legends.</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bands</span><span class="o">.</span><span class="n">decorate_ax</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">qlabels</span><span class="o">=</span><span class="n">qlabels</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">)</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">legends</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Add DOSes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phdoses_dict</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">ax_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">dos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phdoses_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">dos</span><span class="o">.</span><span class="n">plot_dos_idos</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="o">**</span><span class="n">opts_label</span><span class="p">[</span><span class="n">label</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="nd">@deprecated</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;plot method of PhononBandsPlotter has been replaced by combiplot. It will be removed in 0.4&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">combiplot</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="PhononBandsPlotter.gridplot"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBandsPlotter.gridplot">[docs]</a>    <span class="k">def</span> <span class="nf">gridplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_dos</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot multiple electron bandstructures and optionally DOSes on a grid.</span>

<span class="sd">        Args:</span>
<span class="sd">            units: Units for phonon plots. Possible values in (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;). Case-insensitive.</span>
<span class="sd">            with_dos: True if DOS should be printed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            matplotlib figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">titles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bands_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">phb_objects</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bands_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">phdos_objects</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phdoses_dict</span> <span class="ow">and</span> <span class="n">with_dos</span><span class="p">:</span>
            <span class="n">phdos_objects</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phdoses_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">phbands_gridplot</span><span class="p">(</span><span class="n">phb_objects</span><span class="p">,</span> <span class="n">titles</span><span class="o">=</span><span class="n">titles</span><span class="p">,</span> <span class="n">phdos_objects</span><span class="o">=</span><span class="n">phdos_objects</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="PhononBandsPlotter.boxplot"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBandsPlotter.boxplot">[docs]</a>    <span class="k">def</span> <span class="nf">boxplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="n">swarm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use seaborn to draw a box plot to show distributions of eigenvalues with respect to the band index.</span>
<span class="sd">        Band structures are drawn on different subplots.</span>

<span class="sd">        Args:</span>
<span class="sd">            mode_range: Only bands such as `mode_range[0] &lt;= nu_index &lt; mode_range[1]` are included in the plot.</span>
<span class="sd">            units: Units for phonon plots. Possible values in (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;). Case-insensitive.</span>
<span class="sd">            swarm: True to show the datapoints on top of the boxes</span>
<span class="sd">            kwargs: Keywork arguments passed to seaborn boxplot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Build grid of plots.</span>
        <span class="n">num_plots</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">nrows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phbands_dict</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">num_plots</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_plots</span><span class="o">//</span><span class="n">ncols</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_plots</span> <span class="o">%</span> <span class="n">ncols</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax_list</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax_list</span> <span class="o">=</span> <span class="n">ax_list</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="c1"># don&#39;t show the last ax if numeb is odd.</span>
        <span class="k">if</span> <span class="n">num_plots</span> <span class="o">%</span> <span class="n">ncols</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ax_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">phbands</span><span class="p">),</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phbands_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">ax_list</span><span class="p">):</span>
            <span class="n">phbands</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">mode_range</span><span class="o">=</span><span class="n">mode_range</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="PhononBandsPlotter.combiboxplot"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBandsPlotter.combiboxplot">[docs]</a>    <span class="k">def</span> <span class="nf">combiboxplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="n">swarm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use seaborn to draw a box plot comparing the distributions of the frequencies.</span>
<span class="sd">        Phonon Band structures are drawn on the same plot.</span>

<span class="sd">        Args:</span>
<span class="sd">            mode_range: Only bands such as `mode_range[0] &lt;= nu_index &lt; mode_range[1]` are included in the plot.</span>
<span class="sd">            units: Units for phonon plots. Possible values in (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;). Case-insensitive.</span>
<span class="sd">            swarm: True to show the datapoints on top of the boxes</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>
<span class="sd">            kwargs: Keyword arguments passed to seaborn boxplot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">frames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">phbands</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phbands_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Get the dataframe, select bands and add column with label</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">phbands</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">mode_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[(</span><span class="n">frame</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">mode_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">frame</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mode_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="n">frame</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>
            <span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="c1"># Merge frames ignoring index (not meaningful here)</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">frames</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">seaborn.apionly</span> <span class="k">as</span> <span class="nn">sns</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Create column with frequencies in `units`.</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">_factor_ev2units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
        <span class="n">yname</span> <span class="o">=</span> <span class="s2">&quot;freq </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">_unit_tag</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="n">yname</span><span class="p">]</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">]</span>

        <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;mode&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">yname</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">swarm</span><span class="p">:</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">swarmplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;mode&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">yname</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;.25&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="PhononBandsPlotter.animate"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBandsPlotter.animate">[docs]</a>    <span class="k">def</span> <span class="nf">animate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">savefile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use matplotlib to animate a list of band structure plots (with or without DOS).</span>

<span class="sd">        Args:</span>
<span class="sd">            interval: draws a new frame every interval milliseconds.</span>
<span class="sd">            savefile: Use e.g. &#39;myanimation.mp4&#39; to save the animation in mp4 format.</span>
<span class="sd">            units: Units for phonon plots. Possible values in (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;). Case-insensitive.</span>
<span class="sd">            width_ratios: Defines the ratio between the band structure plot and the dos plot.</span>
<span class="sd">                Used when there are DOS stored in the plotter.</span>
<span class="sd">            show: True if the animation should be shown immediately</span>

<span class="sd">        Returns:</span>
<span class="sd">            Animation object.</span>

<span class="sd">        See also:</span>
<span class="sd">            http://matplotlib.org/api/animation_api.html</span>
<span class="sd">            http://jakevdp.github.io/blog/2012/08/18/matplotlib-animation-tutorial/</span>

<span class="sd">        Note:</span>
<span class="sd">            It would be nice to animate the title of the plot, unfortunately</span>
<span class="sd">            this feature is not available in the present version of matplotlib.</span>
<span class="sd">            See: http://stackoverflow.com/questions/17558096/animated-title-in-matplotlib</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">phbands_list</span><span class="p">,</span> <span class="n">phdos_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phbands_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phdoses_list</span>
        <span class="k">if</span> <span class="n">phdos_list</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">phdos_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">phbands_list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The number of objects for DOS must be equal to the number of bands&quot;</span><span class="p">)</span>
        <span class="c1">#titles = list(self.phbands_dict.keys())</span>

        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plotax_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">}</span>

        <span class="n">artists</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">phdos_list</span><span class="p">:</span>
            <span class="c1"># Animation with band structures</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">phbands_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decorate_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">phbands</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">phbands_list</span><span class="p">):</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">phbands</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="o">**</span><span class="n">plotax_kwargs</span><span class="p">)</span>
                <span class="c1">#if titles is not None: lines += [ax.set_title(titles[i])]</span>
                <span class="n">artists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Animation with band structures + DOS.</span>
            <span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="k">import</span> <span class="n">GridSpec</span>
            <span class="n">gspec</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="n">width_ratios</span><span class="p">)</span>
            <span class="n">gspec</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gspec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
            <span class="n">phbands_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decorate_ax</span><span class="p">(</span><span class="n">ax1</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">phbands</span><span class="p">,</span> <span class="n">phdos</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">phbands_list</span><span class="p">,</span> <span class="n">phdos_list</span><span class="p">)):</span>
                <span class="n">phbands_lines</span> <span class="o">=</span> <span class="n">phbands</span><span class="o">.</span><span class="n">plot_ax</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="o">**</span><span class="n">plotax_kwargs</span><span class="p">)</span>
                <span class="n">phdos_lines</span> <span class="o">=</span> <span class="n">phdos</span><span class="o">.</span><span class="n">plot_dos_idos</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">exchange_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">plotax_kwargs</span><span class="p">)</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">phbands_lines</span> <span class="o">+</span> <span class="n">phdos_lines</span>
                <span class="c1">#if titles is not None: lines += [ax.set_title(titles[i])]</span>
                <span class="n">artists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">matplotlib.animation</span> <span class="k">as</span> <span class="nn">animation</span>
        <span class="n">anim</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">ArtistAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">artists</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span>
                                         <span class="n">blit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># True is faster but then the movie starts with an empty frame!</span>
                                         <span class="c1">#repeat_delay=1000</span>
                                         <span class="p">)</span>

        <span class="k">if</span> <span class="n">savefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">anim</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">savefile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">anim</span></div>

<div class="viewcode-block" id="PhononBandsPlotter.ipw_select_plot"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBandsPlotter.ipw_select_plot">[docs]</a>    <span class="k">def</span> <span class="nf">ipw_select_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an ipython widget with controllers to select the plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">plot_callback</span><span class="p">(</span><span class="n">plot_type</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_type</span><span class="p">)(</span><span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;animate&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="n">r</span>

        <span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">ipw</span>
        <span class="k">return</span> <span class="n">ipw</span><span class="o">.</span><span class="n">interact_manual</span><span class="p">(</span>
                <span class="n">plot_callback</span><span class="p">,</span>
                <span class="n">plot_type</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;combiplot&quot;</span><span class="p">,</span> <span class="s2">&quot;gridplot&quot;</span><span class="p">,</span> <span class="s2">&quot;boxplot&quot;</span><span class="p">,</span> <span class="s2">&quot;combiboxplot&quot;</span><span class="p">,</span> <span class="s2">&quot;animate&quot;</span><span class="p">],</span>
                <span class="n">units</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="s2">&quot;cm-1&quot;</span><span class="p">,</span> <span class="s2">&quot;Ha&quot;</span><span class="p">],</span>
            <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_repr_html_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Integration with jupyter notebooks.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ipw_select_plot</span><span class="p">()</span>

<div class="viewcode-block" id="PhononBandsPlotter.write_notebook"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononBandsPlotter.write_notebook">[docs]</a>    <span class="k">def</span> <span class="nf">write_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write an jupyter notebook to nbpath. If nbpath is None, a temporay file in the current</span>
<span class="sd">        working directory is created. Return path to the notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbformat</span><span class="p">,</span> <span class="n">nbv</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nbformat_nbv_nb</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Use pickle files for data persistence.</span>
        <span class="n">tmpfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickle_dump</span><span class="p">()</span>

        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="c1">#nbv.new_markdown_cell(&quot;# This is a markdown cell&quot;),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;plotter = abilab.PhononBandsPlotter.pickle_load(&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="n">tmpfile</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;print(plotter)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;frame = plotter.get_phbands_frame()</span><span class="se">\n</span><span class="s2">display(frame)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;plotter.ipw_select_plot()&quot;</span><span class="p">),</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_nb_nbpath</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nbpath</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="PhononDosPlotter"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononDosPlotter">[docs]</a><span class="k">class</span> <span class="nc">PhononDosPlotter</span><span class="p">(</span><span class="n">NotebookWriter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for plotting multiple phonon DOSes.</span>

<span class="sd">    Usage example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        plotter = PhononDosPlotter()</span>
<span class="sd">        plotter.add_phdos(&quot;foo dos&quot;, &quot;foo.nc&quot;)</span>
<span class="sd">        plotter.add_phdos(&quot;bar dos&quot;, &quot;bar.nc&quot;)</span>
<span class="sd">        fig = plotter.gridplot()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_phdos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phdos_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phdoses_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">key_phdos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">key_phdos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">phdos</span> <span class="ow">in</span> <span class="n">key_phdos</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_phdos</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">phdos</span><span class="p">,</span> <span class="n">phdos_kwargs</span><span class="o">=</span><span class="n">phdos_kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">phdos_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of phonon DOSes&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_phdoses_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

<div class="viewcode-block" id="PhononDosPlotter.add_phdos"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononDosPlotter.add_phdos">[docs]</a>    <span class="k">def</span> <span class="nf">add_phdos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">phdos</span><span class="p">,</span> <span class="n">phdos_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a DOS for plotting.</span>

<span class="sd">        Args:</span>
<span class="sd">            label: label for the phonon DOS. Must be unique.</span>
<span class="sd">            phdos: :class:`PhononDos` object.</span>
<span class="sd">            phdos_kwargs: optional dictionary with the options passed to `get_phdos` to compute the phonon DOS.</span>
<span class="sd">                Used when phdos is not already an instance of `cls` or when we have to compute the DOS from obj.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phdoses_dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;label </span><span class="si">%s</span><span class="s2"> is already in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_phdoses_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_phdoses_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">PhononDos</span><span class="o">.</span><span class="n">as_phdos</span><span class="p">(</span><span class="n">phdos</span><span class="p">,</span> <span class="n">phdos_kwargs</span><span class="p">)</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="PhononDosPlotter.combiplot"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononDosPlotter.combiplot">[docs]</a>    <span class="k">def</span> <span class="nf">combiplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot DOSes on the same figure. Use `gridplot` to plot DOSes on different figures.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>
<span class="sd">            units: Units for phonon plots. Possible values in (&quot;eV&quot;, &quot;meV&quot;, &quot;Ha&quot;, &quot;cm-1&quot;, &quot;Thz&quot;). Case-insensitive.</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used</span>
<span class="sd">            ylims: y-axis limits.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Energy </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">_unit_tag</span><span class="p">(</span><span class="n">units</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;DOS </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">_dos_label_from_units</span><span class="p">(</span><span class="n">units</span><span class="p">))</span>

        <span class="n">lines</span><span class="p">,</span> <span class="n">legends</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">dos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phdoses_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">dos</span><span class="o">.</span><span class="n">plot_dos_idos</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
            <span class="n">legends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;DOS: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">label</span><span class="p">)</span>

        <span class="c1"># Set legends.</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">legends</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="nd">@deprecated</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;plot method of PhononDos has been replaced by combiplot. It will be removed in 0.4&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">combiplot</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="PhononDosPlotter.gridplot"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononDosPlotter.gridplot">[docs]</a>    <span class="k">def</span> <span class="nf">gridplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot multiple DOSes on a grid.</span>

<span class="sd">        Args:</span>
<span class="sd">            units: eV for energies in ev/unit_cell, Jmol for results in J/mole.</span>
<span class="sd">            xlims: Set the data limits for the x-axis. Accept tuple e.g. `(left, right)`</span>
<span class="sd">                   or scalar e.g. `left`. If left (right) is None, default values are used</span>

<span class="sd">        Returns:</span>
<span class="sd">            matplotlib figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">titles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_phdoses_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">phdos_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_phdoses_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
        <span class="n">numeb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">phdos_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">numeb</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="n">numeb</span> <span class="o">//</span> <span class="n">ncols</span> <span class="o">+</span> <span class="n">numeb</span> <span class="o">%</span> <span class="n">ncols</span>

        <span class="c1"># Build Grid</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="c1"># don&#39;t show the last ax if numeb is odd.</span>
        <span class="k">if</span> <span class="n">numeb</span> <span class="o">%</span> <span class="n">ncols</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">phdos</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_phdoses_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">phdos</span><span class="o">.</span><span class="n">plot_dos_idos</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Energy </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">_unit_tag</span><span class="p">(</span><span class="n">units</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;DOS </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">_dos_label_from_units</span><span class="p">(</span><span class="n">units</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlims</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
            <span class="n">set_axlims</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylims</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">ncols</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="nd">@add_fig_kwargs</span>
<div class="viewcode-block" id="PhononDosPlotter.plot_harmonic_thermo"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononDosPlotter.plot_harmonic_thermo">[docs]</a>    <span class="k">def</span> <span class="nf">plot_harmonic_thermo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tstart</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">tstop</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="n">formula_units</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">quantities</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot thermodinamic properties from the phonon DOS within the harmonic approximation.</span>

<span class="sd">        Args:</span>
<span class="sd">            tstart: The starting value (in Kelvin) of the temperature mesh.</span>
<span class="sd">            tstop: The end value (in Kelvin) of the mesh.</span>
<span class="sd">            num: int, optional Number of samples to generate. Default is 50.</span>
<span class="sd">            units: eV for energies in ev/unit_cell, Jmol for results in J/mole.</span>
<span class="sd">            formula_units:</span>
<span class="sd">                the number of formula units per unit cell. If unspecified, the</span>
<span class="sd">                thermodynamic quantities will be given on a per-unit-cell basis.</span>
<span class="sd">            quantities: List of strings specifying the thermodinamic quantities to plot.</span>
<span class="sd">                Possible values: [&quot;internal_energy&quot;, &quot;free_energy&quot;, &quot;entropy&quot;, &quot;c_v&quot;].</span>

<span class="sd">        Returns:</span>
<span class="sd">            matplotlib figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">quantities</span> <span class="o">=</span> <span class="n">list_strings</span><span class="p">(</span><span class="n">quantities</span><span class="p">)</span> <span class="k">if</span> <span class="n">quantities</span> <span class="o">!=</span> <span class="s2">&quot;all&quot;</span> <span class="k">else</span> \
            <span class="p">[</span><span class="s2">&quot;internal_energy&quot;</span><span class="p">,</span> <span class="s2">&quot;free_energy&quot;</span><span class="p">,</span> <span class="s2">&quot;entropy&quot;</span><span class="p">,</span> <span class="s2">&quot;cv&quot;</span><span class="p">]</span>

        <span class="c1"># Build grid of plots.</span>
        <span class="n">ncols</span><span class="p">,</span> <span class="n">nrows</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
        <span class="n">num_plots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">quantities</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_plots</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="n">num_plots</span> <span class="o">//</span> <span class="n">ncols</span> <span class="o">+</span> <span class="n">num_plots</span> <span class="o">%</span> <span class="n">ncols</span>

        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axmat</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># don&#39;t show the last ax if num_plots is odd.</span>
        <span class="k">if</span> <span class="n">num_plots</span> <span class="o">%</span> <span class="n">ncols</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">axmat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">iax</span><span class="p">,</span> <span class="p">(</span><span class="n">qname</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">quantities</span><span class="p">,</span> <span class="n">axmat</span><span class="o">.</span><span class="n">flat</span><span class="p">)):</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">phdos</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_phdoses_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="c1"># Compute thermodinamic quantity associated to qname.</span>
                <span class="n">f1d</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">phdos</span><span class="p">,</span> <span class="s2">&quot;get_&quot;</span> <span class="o">+</span> <span class="n">qname</span><span class="p">)(</span><span class="n">tstart</span><span class="o">=</span><span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span><span class="o">=</span><span class="n">tstop</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="p">)</span>
                <span class="n">ys</span> <span class="o">=</span> <span class="n">f1d</span><span class="o">.</span><span class="n">values</span>
                <span class="k">if</span> <span class="n">formula_units</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="n">ys</span> <span class="o">/=</span> <span class="n">formula_units</span>
                <span class="k">if</span> <span class="n">units</span> <span class="o">==</span> <span class="s2">&quot;Jmol&quot;</span><span class="p">:</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">ys</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">e_Cb</span> <span class="o">*</span> <span class="n">abu</span><span class="o">.</span><span class="n">Avogadro</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">f1d</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">qname</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Temperature [K]&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">_THERMO_YLABELS</span><span class="p">[</span><span class="n">qname</span><span class="p">][</span><span class="n">units</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="PhononDosPlotter.ipw_select_plot"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononDosPlotter.ipw_select_plot">[docs]</a>    <span class="k">def</span> <span class="nf">ipw_select_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an ipython widget with controllers to select the plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">plot_callback</span><span class="p">(</span><span class="n">plot_type</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_type</span><span class="p">)(</span><span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">ipw</span>
        <span class="k">return</span> <span class="n">ipw</span><span class="o">.</span><span class="n">interact_manual</span><span class="p">(</span>
                <span class="n">plot_callback</span><span class="p">,</span>
                <span class="n">plot_type</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;combiplot&quot;</span><span class="p">,</span> <span class="s2">&quot;gridplot&quot;</span><span class="p">],</span>
                <span class="n">units</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="s2">&quot;meV&quot;</span><span class="p">,</span> <span class="s2">&quot;cm-1&quot;</span><span class="p">,</span> <span class="s2">&quot;Thz&quot;</span><span class="p">,</span> <span class="s2">&quot;Ha&quot;</span><span class="p">],</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="PhononDosPlotter.ipw_harmonic_thermo"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononDosPlotter.ipw_harmonic_thermo">[docs]</a>    <span class="k">def</span> <span class="nf">ipw_harmonic_thermo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an ipython widget with controllers to plot thermodinamic properties</span>
<span class="sd">        from the phonon DOS within the harmonic approximation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">plot_callback</span><span class="p">(</span><span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">formula_units</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_harmonic_thermo</span><span class="p">(</span><span class="n">tstart</span><span class="o">=</span><span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span><span class="o">=</span><span class="n">tstop</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="p">,</span>
                                      <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">formula_units</span><span class="o">=</span><span class="n">formula_units</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">ipw</span>
        <span class="k">return</span> <span class="n">ipw</span><span class="o">.</span><span class="n">interact_manual</span><span class="p">(</span>
                <span class="n">plot_callback</span><span class="p">,</span>
                <span class="n">tstart</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">tstop</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="s2">&quot;Jmol&quot;</span><span class="p">],</span> <span class="n">formula_units</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhononDosPlotter.write_notebook"><a class="viewcode-back" href="../../../api/dfpt_api.html#abipy.dfpt.phonons.PhononDosPlotter.write_notebook">[docs]</a>    <span class="k">def</span> <span class="nf">write_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write an jupyter notebook to nbpath. If nbpath is None, a temporay file in the current</span>
<span class="sd">        working directory is created. Return path to the notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbformat</span><span class="p">,</span> <span class="n">nbv</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nbformat_nbv_nb</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Use pickle files for data persistence.</span>
        <span class="n">tmpfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickle_dump</span><span class="p">()</span>

        <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="c1">#nbv.new_markdown_cell(&quot;# This is a markdown cell&quot;),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;plotter = abilab.ElectronDosPlotter.pickle_load(&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="n">tmpfile</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;print(plotter)&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;plotter.ipw_select_plot()&quot;</span><span class="p">),</span>
            <span class="n">nbv</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="s2">&quot;plotter.ipw_harmonic_thermo()&quot;</span><span class="p">),</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_nb_nbpath</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nbpath</span><span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">NonAnalyticalPh</span><span class="p">(</span><span class="n">Has_Structure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Phonon data at gamma including non analytical contributions</span>
<span class="sd">    Read from anaddb.nc</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">directions</span><span class="p">,</span> <span class="n">phfreqs</span><span class="p">,</span> <span class="n">phdispl_cart</span><span class="p">,</span> <span class="n">amu</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            structure: :class:`Structure` object.</span>
<span class="sd">            directions: Cartesian directions along which the non analytical frequencies have been calculated</span>
<span class="sd">            phfreqs: Phonon frequencies with non analytical contribution in eV along directions</span>
<span class="sd">            phdispl_cart: Displacement in Angstromg in Cartesian coordinates with non analytical contribution</span>
<span class="sd">                along directions</span>
<span class="sd">            amu: dictionary that associates the atomic species present in the structure to the values of the atomic</span>
<span class="sd">                mass units used for the calculation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span> <span class="o">=</span> <span class="n">structure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directions</span> <span class="o">=</span> <span class="n">directions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phfreqs</span> <span class="o">=</span> <span class="n">phfreqs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phdispl_cart</span> <span class="o">=</span> <span class="n">phdispl_cart</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amu</span> <span class="o">=</span> <span class="n">amu</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads the non analytical directions, frequencies and eigendisplacements from the anaddb.nc file specified.</span>
<span class="sd">        Non existence of eigendisplacements is accepted for compatibility with abinit 8.0.6</span>
<span class="sd">        Raises an error if the other values are not present in anaddb.nc.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="n">ETSF_Reader</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">directions</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;non_analytical_directions&quot;</span><span class="p">)</span>
            <span class="n">phfreq</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;non_analytical_phonon_modes&quot;</span><span class="p">)</span>

            <span class="c1">#needs a default as the first abinit version including IFCs in the netcdf doesn&#39;t have this attribute</span>
            <span class="n">phdispl_cart</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;non_analytical_phdispl_cart&quot;</span><span class="p">,</span> <span class="n">cmode</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

            <span class="n">structure</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_structure</span><span class="p">()</span>

            <span class="n">amu_list</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;atomic_mass_units&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">amu_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">atom_species</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;atomic_numbers&quot;</span><span class="p">)</span>
                <span class="n">amu</span> <span class="o">=</span> <span class="p">{</span><span class="n">at</span><span class="p">:</span> <span class="n">a</span> <span class="k">for</span> <span class="n">at</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">atom_species</span><span class="p">,</span> <span class="n">amu_list</span><span class="p">)}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">amu</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span> <span class="n">directions</span><span class="o">=</span><span class="n">directions</span><span class="p">,</span> <span class="n">phfreqs</span><span class="o">=</span><span class="n">phfreq</span><span class="p">,</span> <span class="n">phdispl_cart</span><span class="o">=</span><span class="n">phdispl_cart</span><span class="p">,</span> <span class="n">amu</span><span class="o">=</span><span class="n">amu</span><span class="p">)</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">dyn_mat_eigenvect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">get_dyn_mat_eigenvec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phdispl_cart</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">amu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">amu</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;:class:`Structure` object&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span>

    <span class="k">def</span> <span class="nf">has_direction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">cartesian</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if the input direction is among those available.</span>

<span class="sd">        Args:</span>
<span class="sd">            direction: a 3 element list indicating the direction. Can be a generic vector</span>
<span class="sd">            cartesian: if True the direction are already in cartesian coordinates, if False it</span>
<span class="sd">                will be converted to match the internal description of the directions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cartesian</span><span class="p">:</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">reciprocal_lattice_crystallographic</span><span class="o">.</span><span class="n">get_cartesian_coords</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">d</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>


<span class="k">class</span> <span class="nc">InteratomicForceConstants</span><span class="p">(</span><span class="n">Has_Structure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The interatomic force constants calculated by anaddb.</span>
<span class="sd">    Read from anaddb.nc</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">atoms_indices</span><span class="p">,</span> <span class="n">neighbours_indices</span><span class="p">,</span> <span class="n">ifc_cart_coord</span><span class="p">,</span>
                 <span class="n">ifc_cart_coord_short_range</span><span class="p">,</span> <span class="n">local_vectors</span><span class="p">,</span> <span class="n">distances</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            structure: :class:`Structure` object.</span>
<span class="sd">            atoms_index: List of integers representing the indices in the structure of the analyzed atoms.</span>
<span class="sd">            neighbours_index: List of integers representing the indices in the structure of the neighbour atoms.</span>
<span class="sd">            ifc_cart_coord: ifc in Cartesian coordinates</span>
<span class="sd">            ifc_cart_coord_short_range: short range part of the ifc in Cartesian coordinates</span>
<span class="sd">            local_vectors: local basis used to determine the ifc_local_coord</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span> <span class="o">=</span> <span class="n">structure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms_indices</span> <span class="o">=</span> <span class="n">atoms_indices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neighbours_indices</span> <span class="o">=</span> <span class="n">neighbours_indices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ifc_cart_coord</span> <span class="o">=</span> <span class="n">ifc_cart_coord</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ifc_cart_coord_short_range</span> <span class="o">=</span> <span class="n">ifc_cart_coord_short_range</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_vectors</span> <span class="o">=</span> <span class="n">local_vectors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distances</span> <span class="o">=</span> <span class="n">distances</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">number_of_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the object from a netCDF file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">ETSF_Reader</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">structure</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_structure</span><span class="p">()</span>
                <span class="n">atoms_indices</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;ifc_atoms_indices&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">neighbours_indices</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;ifc_neighbours_indices&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">distances</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;ifc_distances&quot;</span><span class="p">)</span>
                <span class="n">ifc_cart_coord</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;ifc_matrix_cart_coord&quot;</span><span class="p">)</span>
                <span class="n">ifc_cart_coord_short_range</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;ifc_matrix_cart_coord_short_range&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">local_vectors</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s2">&quot;ifc_local_vectors&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">traceback</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;Error while trying to read IFCs from file.</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="s2">&quot;Verify that the required variables are used in anaddb: ifcflag, natifc, atifc, ifcout</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span> <span class="n">atoms_indices</span><span class="o">=</span><span class="n">atoms_indices</span><span class="p">,</span> <span class="n">neighbours_indices</span><span class="o">=</span><span class="n">neighbours_indices</span><span class="p">,</span>
                       <span class="n">ifc_cart_coord</span><span class="o">=</span><span class="n">ifc_cart_coord</span><span class="p">,</span>
                       <span class="n">ifc_cart_coord_short_range</span><span class="o">=</span><span class="n">ifc_cart_coord_short_range</span><span class="p">,</span> <span class="n">local_vectors</span><span class="o">=</span><span class="n">local_vectors</span><span class="p">,</span>
                       <span class="n">distances</span><span class="o">=</span><span class="n">distances</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;:class:`Structure` object&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">number_of_neighbours</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of neighbouring atoms for which the ifc are present. ifcout in anaddb.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbours_indices</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">ifc_cart_coord_ewald</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ewald part of the ifcs in cartesian coordinates&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifc_cart_coord_short_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifc_cart_coord</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ifc_cart_coord_short_range</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">ifc_local_coord</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ifcs in local coordinates&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_vectors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ktli,ktij,ktuj-&gt;ktlu&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">local_vectors</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ifc_cart_coord</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">local_vectors</span><span class="p">)</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">ifc_local_coord_short_range</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Short range part of the ifcs in cartesian coordinates&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_vectors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ktli,ktij,ktuj-&gt;ktlu&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">local_vectors</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ifc_cart_coord_short_range</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">local_vectors</span><span class="p">)</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">ifc_local_coord_ewald</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ewald part of the ifcs in local coordinates&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ktli,ktij,ktuj-&gt;ktlu&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">local_vectors</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ifc_cart_coord_ewald</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">local_vectors</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_filter_ifc_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">atom_element</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">neighbour_element</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_dist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_dist</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal method that provides the indices of the neighouring atoms in self.neighbours_indices that satisfy</span>
<span class="sd">        the required conditions. All the arguments are optional. If None the filter will not be applied.</span>

<span class="sd">        Args:</span>
<span class="sd">            atom_indices: a list of atom indices in the structure. Only neighbours of these atoms will be considered.</span>
<span class="sd">            atom_element: symbol of an element in the structure. Only neighbours of these atoms will be considered.</span>
<span class="sd">            neighbour_element: symbol of an element in the structure. Only neighbours of this specie will be considered.</span>
<span class="sd">            min_dist: minimum distance between atoms and neighbours.</span>
<span class="sd">            max_dist: maximum distance between atoms and neighbours.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">atom_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">atom_element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;atom_index and atom_element cannot be specified simultaneously&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">atom_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atom_indices</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">atom_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom_indices</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">atom_element</span><span class="p">:</span>
            <span class="n">atom_indices</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">indices_from_symbol</span><span class="p">(</span><span class="n">atom_element</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">atom_indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">atom_indices</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">))</span>

        <span class="c1"># apply the filter: construct matrices of num_atoms*num_neighbours size, all conditions should be satisfied.</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_indices</span><span class="p">,</span> <span class="n">atom_indices</span><span class="p">),</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_neighbours</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">distances</span> <span class="o">&gt;</span> <span class="n">min_dist</span> <span class="k">if</span> <span class="n">min_dist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">distances</span> <span class="o">&lt;</span> <span class="n">max_dist</span> <span class="k">if</span> <span class="n">max_dist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbours_indices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">indices_from_symbol</span><span class="p">(</span><span class="n">neighbour_element</span><span class="p">))</span>
             <span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_neighbours</span><span class="p">)</span> <span class="k">if</span> <span class="n">neighbour_element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">ind</span>

    <span class="k">def</span> <span class="nf">get_ifc_cartesian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">atom_element</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">neighbour_element</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_dist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_dist</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filters the IFCs in cartesian coordinates</span>
<span class="sd">        All the arguments are optional. If None the filter will not be applied.</span>
<span class="sd">        Returns two arrays containing the distances and the corresponding filtered ifcs.</span>

<span class="sd">        Args:</span>
<span class="sd">            atom_indices: a list of atom indices in the structure. Only neighbours of these atoms will be considered.</span>
<span class="sd">            atom_element: symbol of an element in the structure. Only neighbours of these atoms will be considered.</span>
<span class="sd">            neighbour_element: symbol of an element in the structure. Only neighbours of this specie will be considered.</span>
<span class="sd">            min_dist: minimum distance between atoms and neighbours.</span>
<span class="sd">            max_dist: maximum distance between atoms and neighbours.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_ifc_indices</span><span class="p">(</span><span class="n">atom_indices</span><span class="o">=</span><span class="n">atom_indices</span><span class="p">,</span> <span class="n">atom_element</span><span class="o">=</span><span class="n">atom_element</span><span class="p">,</span>
                                       <span class="n">neighbour_element</span><span class="o">=</span><span class="n">neighbour_element</span><span class="p">,</span> <span class="n">min_dist</span><span class="o">=</span><span class="n">min_dist</span><span class="p">,</span> <span class="n">max_dist</span><span class="o">=</span><span class="n">max_dist</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifc_cart_coord</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_ifc_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">atom_element</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">neighbour_element</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_dist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_dist</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filters the IFCs in local coordinates</span>
<span class="sd">        All the arguments are optional. If None the filter will not be applied.</span>
<span class="sd">        Returns two arrays containing the distances and the corresponding filtered ifcs.</span>

<span class="sd">        Args:</span>
<span class="sd">            atom_indices: a list of atom indices in the structure. Only neighbours of these atoms will be considered.</span>
<span class="sd">            atom_element: symbol of an element in the structure. Only neighbours of these atoms will be considered.</span>
<span class="sd">            neighbour_element: symbol of an element in the structure. Only neighbours of this specie will be considered.</span>
<span class="sd">            min_dist: minimum distance between atoms and neighbours.</span>
<span class="sd">            max_dist: maximum distance between atoms and neighbours.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_vectors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Local coordinates are missing. Run anaddb with ifcana=1&quot;</span><span class="p">)</span>

        <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_ifc_indices</span><span class="p">(</span><span class="n">atom_indices</span><span class="o">=</span><span class="n">atom_indices</span><span class="p">,</span> <span class="n">atom_element</span><span class="o">=</span><span class="n">atom_element</span><span class="p">,</span>
                                       <span class="n">neighbour_element</span><span class="o">=</span><span class="n">neighbour_element</span><span class="p">,</span> <span class="n">min_dist</span><span class="o">=</span><span class="n">min_dist</span><span class="p">,</span> <span class="n">max_dist</span><span class="o">=</span><span class="n">max_dist</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifc_local_coord</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_plot_ifc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ifc</span><span class="p">,</span> <span class="n">atom_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">atom_element</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">neighbour_element</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_dist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">max_dist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the specified ifcs, filtered according to the optional arguments.</span>
<span class="sd">        An array with shape number_of_atoms*number_of_neighbours, so only one of the components of the ifc matrix can</span>
<span class="sd">        be plot at a time.</span>

<span class="sd">        Args:</span>
<span class="sd">            ifc: an array with shape number_of_atoms*number_of_neighbours of the ifc that should be plotted</span>
<span class="sd">            atom_indices: a list of atom indices in the structure. Only neighbours of these atoms will be considered.</span>
<span class="sd">            atom_element: symbol of an element in the structure. Only neighbours of these atoms will be considered.</span>
<span class="sd">            neighbour_element: symbol of an element in the structure. Only neighbours of this specie will be considered.</span>
<span class="sd">            min_dist: minimum distance between atoms and neighbours.</span>
<span class="sd">            max_dist: maximum distance between atoms and neighbours.</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>
<span class="sd">            kwargs: kwargs passed to the matplotlib function &#39;plot&#39;. Color defaults to blue, symbol to &#39;o&#39; and lw to 0</span>

<span class="sd">        Returns:</span>
<span class="sd">            matplotlib figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

        <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_ifc_indices</span><span class="p">(</span><span class="n">atom_indices</span><span class="o">=</span><span class="n">atom_indices</span><span class="p">,</span> <span class="n">atom_element</span><span class="o">=</span><span class="n">atom_element</span><span class="p">,</span>
                                       <span class="n">neighbour_element</span><span class="o">=</span><span class="n">neighbour_element</span><span class="p">,</span> <span class="n">min_dist</span><span class="o">=</span><span class="n">min_dist</span><span class="p">,</span> <span class="n">max_dist</span><span class="o">=</span><span class="n">max_dist</span><span class="p">)</span>

        <span class="n">dist</span><span class="p">,</span> <span class="n">filtered_ifc</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">ifc</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;color&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;marker&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;marker&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;linewidth&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="s1">&#39;lw&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;lw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Distance [Bohr]&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;IFC [Ha/Bohr$^2$]&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">filtered_ifc</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>

    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_longitudinal_ifc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">atom_element</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">neighbour_element</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_dist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">max_dist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the total longitudinal ifcs in local coordinates, filtered according to the optional arguments.</span>

<span class="sd">        Args:</span>
<span class="sd">            atom_indices: a list of atom indices in the structure. Only neighbours of these atoms will be considered.</span>
<span class="sd">            atom_element: symbol of an element in the structure. Only neighbours of these atoms will be considered.</span>
<span class="sd">            neighbour_element: symbol of an element in the structure. Only neighbours of this specie will be considered.</span>
<span class="sd">            min_dist: minimum distance between atoms and neighbours.</span>
<span class="sd">            max_dist: maximum distance between atoms and neighbours.</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>
<span class="sd">            kwargs: kwargs passed to the matplotlib function &#39;plot&#39;. Color defaults to blue, symbol to &#39;o&#39; and lw to 0</span>

<span class="sd">        Returns:</span>
<span class="sd">            matplotlib figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_vectors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Local coordinates are missing. Run anaddb with ifcana=1&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_plot_ifc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ifc_local_coord</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">atom_indices</span><span class="o">=</span><span class="n">atom_indices</span><span class="p">,</span> <span class="n">atom_element</span><span class="o">=</span><span class="n">atom_element</span><span class="p">,</span>
                                 <span class="n">neighbour_element</span><span class="o">=</span><span class="n">neighbour_element</span><span class="p">,</span> <span class="n">min_dist</span><span class="o">=</span><span class="n">min_dist</span><span class="p">,</span> <span class="n">max_dist</span><span class="o">=</span><span class="n">max_dist</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_longitudinal_ifc_short_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">atom_element</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">neighbour_element</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                          <span class="n">min_dist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_dist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the short range longitudinal ifcs in local coordinates, filtered according to the optional arguments.</span>

<span class="sd">        Args:</span>
<span class="sd">            atom_indices: a list of atom indices in the structure. Only neighbours of these atoms will be considered.</span>
<span class="sd">            atom_element: symbol of an element in the structure. Only neighbours of these atoms will be considered.</span>
<span class="sd">            neighbour_element: symbol of an element in the structure. Only neighbours of this specie will be considered.</span>
<span class="sd">            min_dist: minimum distance between atoms and neighbours.</span>
<span class="sd">            max_dist: maximum distance between atoms and neighbours.</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>
<span class="sd">            kwargs: kwargs passed to the matplotlib function &#39;plot&#39;. Color defaults to blue, symbol to &#39;o&#39; and lw to 0</span>

<span class="sd">        Returns:</span>
<span class="sd">            matplotlib figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_vectors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Local coordinates are missing. Run anaddb with ifcana=1&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifc_local_coord_short_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Ewald contribution is missing, Run anaddb with dipdip=1&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_plot_ifc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ifc_local_coord_short_range</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">atom_indices</span><span class="o">=</span><span class="n">atom_indices</span><span class="p">,</span>
                                 <span class="n">atom_element</span><span class="o">=</span><span class="n">atom_element</span><span class="p">,</span> <span class="n">neighbour_element</span><span class="o">=</span><span class="n">neighbour_element</span><span class="p">,</span> <span class="n">min_dist</span><span class="o">=</span><span class="n">min_dist</span><span class="p">,</span>
                                 <span class="n">max_dist</span><span class="o">=</span><span class="n">max_dist</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_longitudinal_ifc_ewald</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">atom_element</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">neighbour_element</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                          <span class="n">min_dist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_dist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the Ewald part of the ifcs in local coordinates, filtered according to the optional arguments.</span>

<span class="sd">        Args:</span>
<span class="sd">            atom_indices: a list of atom indices in the structure. Only neighbours of these atoms will be considered.</span>
<span class="sd">            atom_element: symbol of an element in the structure. Only neighbours of these atoms will be considered.</span>
<span class="sd">            neighbour_element: symbol of an element in the structure. Only neighbours of this specie will be considered.</span>
<span class="sd">            min_dist: minimum distance between atoms and neighbours.</span>
<span class="sd">            max_dist: maximum distance between atoms and neighbours.</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>
<span class="sd">            kwargs: kwargs passed to the matplotlib function &#39;plot&#39;. Color defaults to blue, symbol to &#39;o&#39; and lw to 0</span>

<span class="sd">        Returns:</span>
<span class="sd">            matplotlib figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_vectors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Local coordinates are missing. Run anaddb with ifcana=1&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifc_local_coord_ewald</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Ewald contribution is missing, Run anaddb with dipdip=1&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_plot_ifc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ifc_local_coord_ewald</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">atom_indices</span><span class="o">=</span><span class="n">atom_indices</span><span class="p">,</span>
                                 <span class="n">atom_element</span><span class="o">=</span><span class="n">atom_element</span><span class="p">,</span> <span class="n">neighbour_element</span><span class="o">=</span><span class="n">neighbour_element</span><span class="p">,</span> <span class="n">min_dist</span><span class="o">=</span><span class="n">min_dist</span><span class="p">,</span>
                                 <span class="n">max_dist</span><span class="o">=</span><span class="n">max_dist</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_dyn_mat_eigenvec</span><span class="p">(</span><span class="n">phdispl</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">amu</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts the phonon eigendisplacements to the orthonormal eigenvectors of the dynamical matrix.</span>
<span class="sd">    Small discrepancies with the original values may be expected due to the different values of the atomic masses in</span>
<span class="sd">    abinit and pymatgen.</span>

<span class="sd">    Args:</span>
<span class="sd">        phdispl: a numpy array containing the eigendisplacements in cartesian coordinates. The last index should have</span>
<span class="sd">            size 3*(num atoms), but the rest of the shape is arbitrary. If qpts is not None the first dimension</span>
<span class="sd">            should match the q points.</span>
<span class="sd">        structure: :class:`Structure` object.</span>
<span class="sd">        amu: dictionary that associates the atomic species present in the structure to the values of the atomic</span>
<span class="sd">            mass units used for the calculation. If None, values from pymatgen will be used. Note that this will</span>
<span class="sd">            almost always lead to inaccuracies in the conversion.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A numpy array of the same shape as phdispl containing the eigenvectors of the dynamical matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">eigvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">phdispl</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">amu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">amu</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="o">.</span><span class="n">number</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">atomic_mass</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">structure</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">elements</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">structure</span><span class="p">):</span>
        <span class="n">eigvec</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">phdispl</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">amu</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">specie</span><span class="o">.</span><span class="n">number</span><span class="p">]</span><span class="o">*</span><span class="n">abu</span><span class="o">.</span><span class="n">amu_emass</span><span class="p">)</span><span class="o">/</span><span class="n">abu</span><span class="o">.</span><span class="n">Bohr_Ang</span>

    <span class="k">return</span> <span class="n">eigvec</span>


<span class="k">def</span> <span class="nf">match_eigenvectors</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given two list of vectors, returns the pair matching based on the complex scalar product.</span>
<span class="sd">    Returns the indices of the second list that match the vectors of the first list in ascending order.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">prod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">conjugate</span><span class="p">()))</span>

    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
    <span class="n">missing_v1</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
    <span class="n">missing_v2</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">prod</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)):</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">prod</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">missing_v1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">missing_v2</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
            <span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
            <span class="n">missing_v1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">missing_v2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">missing_v1</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">missing_v2</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Something went wrong in matching vectors: </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">))</span>
                <span class="k">break</span>

    <span class="k">return</span> <span class="n">indices</span>
</pre></div>

          </div>
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2017, The AbiPy group.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    
    <a href="https://github.com/abinit/abipy" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>