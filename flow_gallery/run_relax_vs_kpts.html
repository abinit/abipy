<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Relaxation of GaN with different K-meshes &#8212; abipy 0.2.0 documentation</title>
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/gallery.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Flow for convergence studies of e-DOS wrt ngkpt" href="run_mgb2_edoses.html" />
    <link rel="prev" title="Band structure w/wo magnetization" href="run_fe_ebands.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          abipy</a>
        <span class="navbar-text navbar-version pull-left"><b>0.2.0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../features.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Getting AbiPy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../whats_new.html">What’s new in abipy</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../scripts/index.html">Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gallery/index.html">AbiPy Gallery</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../workflows/taskmanager.html">TaskManager</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">AbiPy Flow Gallery</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devel/index.html">Developers’ Guide</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Relaxation of GaN with different K-meshes</a></li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="run_fe_ebands.html" title="Previous Chapter: Band structure w/wo magnetization"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Band structur...</span>
    </a>
  </li>
  <li>
    <a href="run_mgb2_edoses.html" title="Next Chapter: Flow for convergence studies of e-DOS wrt ngkpt"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Flow for conv... &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="../_sources/flow_gallery/run_relax_vs_kpts.rst.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="section" id="relaxation-of-gan-with-different-k-meshes">
<span id="sphx-glr-flow-gallery-run-relax-vs-kpts-py"></span><h1>Relaxation of GaN with different K-meshes<a class="headerlink" href="#relaxation-of-gan-with-different-k-meshes" title="Permalink to this headline">¶</a></h1>
<p>In this example, we employ the relaxation algorithms implemented in Abinit (<code class="docutils literal"><span class="pre">ionmov</span></code> and <code class="docutils literal"><span class="pre">optcell</span></code>)
to find the equilibrium configuration of GaN (atomic positions and lattice vectors).
The relaxation is done with different k-meshes to monitor the convergence of the results.
You will observe a change of the equilibrium parameters with respect to the k-point mesh.</p>
<p>Note the we are using pseudopotentials generated with the GGA which tends to
overestimate the lattice parameters and ecut is way too low.
If you replace GGA with LDA, you will observe that LDA tends to underestimate the parameters.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span><span class="p">,</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">abipy.abilab</span> <span class="kn">as</span> <span class="nn">abilab</span>
<span class="kn">import</span> <span class="nn">abipy.flowtk</span> <span class="kn">as</span> <span class="nn">flowtk</span>
<span class="kn">import</span> <span class="nn">abipy.data</span> <span class="kn">as</span> <span class="nn">abidata</span>


<span class="k">def</span> <span class="nf">build_flow</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build and return a flow performing structural relaxations with different k-point samplings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set working directory (default is the name of the script with &#39;.py&#39; removed and &quot;run_&quot; replaced by &quot;flow_&quot;)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">workdir</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;run_&quot;</span><span class="p">,</span> <span class="s2">&quot;flow_&quot;</span><span class="p">)</span>

    <span class="c1"># List of k-meshes.</span>
    <span class="n">ngkpt_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
    <span class="p">]</span>

    <span class="n">structure</span> <span class="o">=</span> <span class="n">abilab</span><span class="o">.</span><span class="n">Structure</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">abidata</span><span class="o">.</span><span class="n">cif_file</span><span class="p">(</span><span class="s2">&quot;gan2.cif&quot;</span><span class="p">))</span>
    <span class="n">pseudos</span> <span class="o">=</span> <span class="n">abidata</span><span class="o">.</span><span class="n">pseudos</span><span class="p">(</span><span class="s2">&quot;Ga.oncvpsp&quot;</span><span class="p">,</span> <span class="s2">&quot;N.oncvpsp&quot;</span><span class="p">)</span>

    <span class="c1"># Build multidataset.</span>
    <span class="n">multi</span> <span class="o">=</span> <span class="n">abilab</span><span class="o">.</span><span class="n">MultiDataset</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="o">=</span><span class="n">pseudos</span><span class="p">,</span> <span class="n">ndtset</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ngkpt_list</span><span class="p">))</span>

    <span class="c1"># Set global variables for structural relaxation. Note dilatmx and ecutsm</span>
    <span class="c1"># Ecut should depend on pseudos.</span>
    <span class="n">multi</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span>
        <span class="n">ecut</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>       <span class="c1"># Too low</span>
        <span class="n">optcell</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">ionmov</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">tolrff</span><span class="o">=</span><span class="mf">5.0e-2</span><span class="p">,</span>
        <span class="n">tolmxf</span><span class="o">=</span><span class="mf">5.0e-5</span><span class="p">,</span>
        <span class="n">ntime</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
        <span class="n">dilatmx</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span>  <span class="c1"># Important!</span>
        <span class="n">ecutsm</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>    <span class="c1"># Important!</span>
    <span class="p">)</span>

    <span class="c1"># Here we set the k-meshes (Gamma-centered for simplicity)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ngkpt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ngkpt_list</span><span class="p">):</span>
        <span class="n">multi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_kmesh</span><span class="p">(</span><span class="n">ngkpt</span><span class="o">=</span><span class="n">ngkpt</span><span class="p">,</span> <span class="n">shiftk</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

    <span class="c1"># As the calculations are independent, we can use Flow.from_inputs</span>
    <span class="c1"># and call split_datasets to create len(ngkpt_list) inputs.</span>
    <span class="c1"># Note that it&#39;s a good idea to specify the task_class so that AbiPy knows how to restart the calculation.</span>
    <span class="k">return</span> <span class="n">flowtk</span><span class="o">.</span><span class="n">Flow</span><span class="o">.</span><span class="n">from_inputs</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">multi</span><span class="o">.</span><span class="n">split_datasets</span><span class="p">(),</span>
                                   <span class="n">task_class</span><span class="o">=</span><span class="n">flowtk</span><span class="o">.</span><span class="n">RelaxTask</span><span class="p">)</span>

<span class="c1"># This block generates the thumbnails in the Abipy gallery.</span>
<span class="c1"># You can safely REMOVE this part if you are using this script for production runs.</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;GENERATE_SPHINX_GALLERY&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
    <span class="vm">__name__</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="kn">import</span> <span class="nn">tempfile</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">flowtk</span><span class="o">.</span><span class="n">build_flow_main_parser</span><span class="p">()</span><span class="o">.</span><span class="n">parse_args</span><span class="p">([</span><span class="s2">&quot;-w&quot;</span><span class="p">,</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()])</span>
    <span class="n">build_flow</span><span class="p">(</span><span class="n">options</span><span class="p">)</span><span class="o">.</span><span class="n">plot_networkx</span><span class="p">(</span><span class="n">tight_layout</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


<span class="nd">@flowtk.flow_main</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is our main function that will be invoked by the script.</span>
<span class="sd">    flow_main is a decorator implementing the command line interface.</span>
<span class="sd">    Command line args are stored in `options`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">build_flow</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>
</div>
<img alt="../_images/sphx_glr_run_relax_vs_kpts_001.png" class="align-center" src="../_images/sphx_glr_run_relax_vs_kpts_001.png" />
<p>Run the script with:</p>
<blockquote>
<div>run_relax_vs_kpts.py -s</div></blockquote>
<p>then use:</p>
<blockquote>
<div>abirun.py flow_relax_vs_kpts hist -p</div></blockquote>
<p>to print (and plot) the relaxed parameters at the end of the run.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>Table with final structures, pressures in GPa and force stats in eV/Ang:

      formula  natom  angle0  angle1  angle2      a      b      c  volume  <span class="se">\</span>
w0_t0  Ga2 N2      <span class="m">4</span>    <span class="m">90</span>.0    <span class="m">90</span>.0   <span class="m">120</span>.0  <span class="m">3</span>.224  <span class="m">3</span>.224  <span class="m">5</span>.343  <span class="m">48</span>.080
w0_t1  Ga2 N2      <span class="m">4</span>    <span class="m">90</span>.0    <span class="m">90</span>.0   <span class="m">120</span>.0  <span class="m">3</span>.249  <span class="m">3</span>.249  <span class="m">5</span>.321  <span class="m">48</span>.635
w0_t2  Ga2 N2      <span class="m">4</span>    <span class="m">90</span>.0    <span class="m">90</span>.0   <span class="m">120</span>.0  <span class="m">3</span>.254  <span class="m">3</span>.254  <span class="m">5</span>.335  <span class="m">48</span>.909

      abispg_num  num_steps  final_energy  final_pressure task_class  <span class="se">\</span>
w0_t0       None          <span class="m">9</span>      -755.344      -1.088e-04  RelaxTask
w0_t1       None          <span class="m">9</span>      -755.632      -5.088e-03  RelaxTask
w0_t2       None         <span class="m">11</span>      -755.645      -4.314e-03  RelaxTask

                                             ncfile              status
w0_t0  flow_relax_vs_kpts/w0/t0/outdata/out_HIST.nc  Completed
w0_t1  flow_relax_vs_kpts/w0/t1/outdata/out_HIST.nc  Completed
w0_t2  flow_relax_vs_kpts/w0/t2/outdata/out_HIST.nc  Completed
</pre></div>
</div>
<p>The experimental results are:</p>
<blockquote>
<div><ul class="simple">
<li>Volume of the unit cell of GaN: 45.73 A^3</li>
<li>Lattice parameters of GaN: a = 3.190 A, c = 5.189 A</li>
<li>Vertical distance between Ga and N : about 0.377 * c [ Schulz &amp; Thiemann, 1977]</li>
</ul>
</div></blockquote>
<img alt="Evolution of the volume during the relaxation algorithm." src="https://github.com/abinit/abipy_assets/blob/master/run_relax_vs_kpts.png?raw=true" />
<p><strong>Total running time of the script:</strong> ( 0 minutes  0.115 seconds)</p>
<div class="sphx-glr-footer docutils container">
<div class="sphx-glr-download docutils container">
<a class="reference download internal" href="../_downloads/run_relax_vs_kpts.py" download=""><code class="xref download docutils literal"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">run_relax_vs_kpts.py</span></code></a></div>
<div class="sphx-glr-download docutils container">
<a class="reference download internal" href="../_downloads/run_relax_vs_kpts.ipynb" download=""><code class="xref download docutils literal"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">run_relax_vs_kpts.ipynb</span></code></a></div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.readthedocs.io">Gallery generated by Sphinx-Gallery</a></p>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2017, The AbiPy group.<br/>
      Last updated on Dec 08, 2017.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.5.<br/>
    </p>
  </div>
</footer>
  </body>
</html>